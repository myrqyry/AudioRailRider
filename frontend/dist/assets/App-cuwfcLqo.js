const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/ThreeCanvas-D13cZOo7.js","assets/index-BzHxtUH_.js","assets/index-CybVBpYt.css","assets/ToastProvider-nF4Lwaba.js"])))=>i.map(i=>d[i]);
var Mp=Object.defineProperty;var Cp=(n,t,e)=>t in n?Mp(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e;var $c=(n,t,e)=>Cp(n,typeof t!="symbol"?t+"":t,e);import{R as Hn,r as te,j as U,g as Ip,_ as Rp}from"./index-BzHxtUH_.js";import{useToast as Op}from"./ToastProvider-nF4Lwaba.js";var ue=(n=>(n.Idle="idle",n.Analyzing="analyzing",n.Generating="generating",n.Ready="ready",n.Riding="riding",n.Finished="finished",n.Error="error",n))(ue||{});const Yu=n=>n,eg=n=>n,Jc=n=>{let t;const e=new Set,r=(h,u)=>{const d=typeof h=="function"?h(t):h;if(!Object.is(d,t)){const x=t;t=u??(typeof d!="object"||d===null)?d:Object.assign({},t,d),e.forEach(g=>g(t,x))}},i=()=>t,o={setState:r,getState:i,getInitialState:()=>c,subscribe:h=>(e.add(h),()=>e.delete(h))},c=t=n(r,i,o);return o},Np=(n=>n?Jc(n):Jc),Lp=n=>n;function Dp(n,t=Lp){const e=Hn.useSyncExternalStore(n.subscribe,Hn.useCallback(()=>t(n.getState()),[n,t]),Hn.useCallback(()=>t(n.getInitialState()),[n,t]));return Hn.useDebugValue(e),e}const qc=n=>{const t=Np(n),e=r=>Dp(t,r);return Object.assign(e,t),e},Fp=(n=>n?qc(n):qc),Se=Fp((n,t)=>({status:ue.Idle,error:null,statusMessage:"",audioFile:null,blueprint:null,audioFeatures:null,trackData:null,workflowProgress:0,skyboxUrl:null,generationOptions:null,actions:{setGenerationOptions:e=>n({generationOptions:e}),setStatus:(e,r)=>n({status:e,statusMessage:r||"",error:null}),setBlueprint:e=>n({blueprint:e}),setAudioFeatures:e=>n({audioFeatures:e}),setTrackData:e=>{const r=t().status;e===null&&(r===ue.Riding||r===ue.Ready)?n({trackData:null,status:ue.Idle,statusMessage:"Track data was cleared, returning to start."}):n({trackData:e})},setError:e=>n({error:e,status:e?ue.Error:t().status}),setAudioFile:e=>{n({audioFile:e,status:ue.Idle,error:null,workflowProgress:0,skyboxUrl:null})},setWorkflowProgress:e=>n({workflowProgress:e}),setSkyboxUrl:e=>n({skyboxUrl:e}),startRide:()=>{const e=t();console.log("[Store] startRide called",{status:e.status,hasTrackData:!!e.trackData,hasAudioFile:!!e.audioFile}),e.status===ue.Ready&&e.trackData&&e.audioFile?(console.log("[Store] Transitioning to Riding state"),n({status:ue.Riding})):console.warn("[Store] Cannot start ride - conditions not met")},resetApp:()=>{n({status:ue.Idle,error:null,statusMessage:"",audioFile:null,blueprint:null,audioFeatures:null,trackData:null,workflowProgress:0,skyboxUrl:null})},handleRideFinish:()=>{t().status===ue.Riding&&n({status:ue.Finished,statusMessage:"Your journey is complete."})},startRideAgain:()=>{t().status===ue.Finished&&t().trackData&&t().audioFile&&n({status:ue.Riding})}}}));/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 *//**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */var Zc;(function(n){n.OUTCOME_UNSPECIFIED="OUTCOME_UNSPECIFIED",n.OUTCOME_OK="OUTCOME_OK",n.OUTCOME_FAILED="OUTCOME_FAILED",n.OUTCOME_DEADLINE_EXCEEDED="OUTCOME_DEADLINE_EXCEEDED"})(Zc||(Zc={}));var Kc;(function(n){n.LANGUAGE_UNSPECIFIED="LANGUAGE_UNSPECIFIED",n.PYTHON="PYTHON"})(Kc||(Kc={}));var Qc;(function(n){n.TYPE_UNSPECIFIED="TYPE_UNSPECIFIED",n.STRING="STRING",n.NUMBER="NUMBER",n.INTEGER="INTEGER",n.BOOLEAN="BOOLEAN",n.ARRAY="ARRAY",n.OBJECT="OBJECT",n.NULL="NULL"})(Qc||(Qc={}));var un;(function(n){n.HARM_CATEGORY_UNSPECIFIED="HARM_CATEGORY_UNSPECIFIED",n.HARM_CATEGORY_HATE_SPEECH="HARM_CATEGORY_HATE_SPEECH",n.HARM_CATEGORY_DANGEROUS_CONTENT="HARM_CATEGORY_DANGEROUS_CONTENT",n.HARM_CATEGORY_HARASSMENT="HARM_CATEGORY_HARASSMENT",n.HARM_CATEGORY_SEXUALLY_EXPLICIT="HARM_CATEGORY_SEXUALLY_EXPLICIT",n.HARM_CATEGORY_CIVIC_INTEGRITY="HARM_CATEGORY_CIVIC_INTEGRITY",n.HARM_CATEGORY_IMAGE_HATE="HARM_CATEGORY_IMAGE_HATE",n.HARM_CATEGORY_IMAGE_DANGEROUS_CONTENT="HARM_CATEGORY_IMAGE_DANGEROUS_CONTENT",n.HARM_CATEGORY_IMAGE_HARASSMENT="HARM_CATEGORY_IMAGE_HARASSMENT",n.HARM_CATEGORY_IMAGE_SEXUALLY_EXPLICIT="HARM_CATEGORY_IMAGE_SEXUALLY_EXPLICIT"})(un||(un={}));var th;(function(n){n.HARM_BLOCK_METHOD_UNSPECIFIED="HARM_BLOCK_METHOD_UNSPECIFIED",n.SEVERITY="SEVERITY",n.PROBABILITY="PROBABILITY"})(th||(th={}));var fn;(function(n){n.HARM_BLOCK_THRESHOLD_UNSPECIFIED="HARM_BLOCK_THRESHOLD_UNSPECIFIED",n.BLOCK_LOW_AND_ABOVE="BLOCK_LOW_AND_ABOVE",n.BLOCK_MEDIUM_AND_ABOVE="BLOCK_MEDIUM_AND_ABOVE",n.BLOCK_ONLY_HIGH="BLOCK_ONLY_HIGH",n.BLOCK_NONE="BLOCK_NONE",n.OFF="OFF"})(fn||(fn={}));var eh;(function(n){n.MODE_UNSPECIFIED="MODE_UNSPECIFIED",n.MODE_DYNAMIC="MODE_DYNAMIC"})(eh||(eh={}));var rh;(function(n){n.AUTH_TYPE_UNSPECIFIED="AUTH_TYPE_UNSPECIFIED",n.NO_AUTH="NO_AUTH",n.API_KEY_AUTH="API_KEY_AUTH",n.HTTP_BASIC_AUTH="HTTP_BASIC_AUTH",n.GOOGLE_SERVICE_ACCOUNT_AUTH="GOOGLE_SERVICE_ACCOUNT_AUTH",n.OAUTH="OAUTH",n.OIDC_AUTH="OIDC_AUTH"})(rh||(rh={}));var ih;(function(n){n.API_SPEC_UNSPECIFIED="API_SPEC_UNSPECIFIED",n.SIMPLE_SEARCH="SIMPLE_SEARCH",n.ELASTIC_SEARCH="ELASTIC_SEARCH"})(ih||(ih={}));var nh;(function(n){n.URL_RETRIEVAL_STATUS_UNSPECIFIED="URL_RETRIEVAL_STATUS_UNSPECIFIED",n.URL_RETRIEVAL_STATUS_SUCCESS="URL_RETRIEVAL_STATUS_SUCCESS",n.URL_RETRIEVAL_STATUS_ERROR="URL_RETRIEVAL_STATUS_ERROR",n.URL_RETRIEVAL_STATUS_PAYWALL="URL_RETRIEVAL_STATUS_PAYWALL",n.URL_RETRIEVAL_STATUS_UNSAFE="URL_RETRIEVAL_STATUS_UNSAFE"})(nh||(nh={}));var sh;(function(n){n.FINISH_REASON_UNSPECIFIED="FINISH_REASON_UNSPECIFIED",n.STOP="STOP",n.MAX_TOKENS="MAX_TOKENS",n.SAFETY="SAFETY",n.RECITATION="RECITATION",n.LANGUAGE="LANGUAGE",n.OTHER="OTHER",n.BLOCKLIST="BLOCKLIST",n.PROHIBITED_CONTENT="PROHIBITED_CONTENT",n.SPII="SPII",n.MALFORMED_FUNCTION_CALL="MALFORMED_FUNCTION_CALL",n.IMAGE_SAFETY="IMAGE_SAFETY",n.UNEXPECTED_TOOL_CALL="UNEXPECTED_TOOL_CALL"})(sh||(sh={}));var ah;(function(n){n.HARM_PROBABILITY_UNSPECIFIED="HARM_PROBABILITY_UNSPECIFIED",n.NEGLIGIBLE="NEGLIGIBLE",n.LOW="LOW",n.MEDIUM="MEDIUM",n.HIGH="HIGH"})(ah||(ah={}));var oh;(function(n){n.HARM_SEVERITY_UNSPECIFIED="HARM_SEVERITY_UNSPECIFIED",n.HARM_SEVERITY_NEGLIGIBLE="HARM_SEVERITY_NEGLIGIBLE",n.HARM_SEVERITY_LOW="HARM_SEVERITY_LOW",n.HARM_SEVERITY_MEDIUM="HARM_SEVERITY_MEDIUM",n.HARM_SEVERITY_HIGH="HARM_SEVERITY_HIGH"})(oh||(oh={}));var lh;(function(n){n.BLOCKED_REASON_UNSPECIFIED="BLOCKED_REASON_UNSPECIFIED",n.SAFETY="SAFETY",n.OTHER="OTHER",n.BLOCKLIST="BLOCKLIST",n.PROHIBITED_CONTENT="PROHIBITED_CONTENT",n.IMAGE_SAFETY="IMAGE_SAFETY"})(lh||(lh={}));var ch;(function(n){n.TRAFFIC_TYPE_UNSPECIFIED="TRAFFIC_TYPE_UNSPECIFIED",n.ON_DEMAND="ON_DEMAND",n.PROVISIONED_THROUGHPUT="PROVISIONED_THROUGHPUT"})(ch||(ch={}));var hh;(function(n){n.MODALITY_UNSPECIFIED="MODALITY_UNSPECIFIED",n.TEXT="TEXT",n.IMAGE="IMAGE",n.AUDIO="AUDIO"})(hh||(hh={}));var uh;(function(n){n.MEDIA_RESOLUTION_UNSPECIFIED="MEDIA_RESOLUTION_UNSPECIFIED",n.MEDIA_RESOLUTION_LOW="MEDIA_RESOLUTION_LOW",n.MEDIA_RESOLUTION_MEDIUM="MEDIA_RESOLUTION_MEDIUM",n.MEDIA_RESOLUTION_HIGH="MEDIA_RESOLUTION_HIGH"})(uh||(uh={}));var fh;(function(n){n.JOB_STATE_UNSPECIFIED="JOB_STATE_UNSPECIFIED",n.JOB_STATE_QUEUED="JOB_STATE_QUEUED",n.JOB_STATE_PENDING="JOB_STATE_PENDING",n.JOB_STATE_RUNNING="JOB_STATE_RUNNING",n.JOB_STATE_SUCCEEDED="JOB_STATE_SUCCEEDED",n.JOB_STATE_FAILED="JOB_STATE_FAILED",n.JOB_STATE_CANCELLING="JOB_STATE_CANCELLING",n.JOB_STATE_CANCELLED="JOB_STATE_CANCELLED",n.JOB_STATE_PAUSED="JOB_STATE_PAUSED",n.JOB_STATE_EXPIRED="JOB_STATE_EXPIRED",n.JOB_STATE_UPDATING="JOB_STATE_UPDATING",n.JOB_STATE_PARTIALLY_SUCCEEDED="JOB_STATE_PARTIALLY_SUCCEEDED"})(fh||(fh={}));var dh;(function(n){n.TUNING_MODE_UNSPECIFIED="TUNING_MODE_UNSPECIFIED",n.TUNING_MODE_FULL="TUNING_MODE_FULL",n.TUNING_MODE_PEFT_ADAPTER="TUNING_MODE_PEFT_ADAPTER"})(dh||(dh={}));var mh;(function(n){n.ADAPTER_SIZE_UNSPECIFIED="ADAPTER_SIZE_UNSPECIFIED",n.ADAPTER_SIZE_ONE="ADAPTER_SIZE_ONE",n.ADAPTER_SIZE_TWO="ADAPTER_SIZE_TWO",n.ADAPTER_SIZE_FOUR="ADAPTER_SIZE_FOUR",n.ADAPTER_SIZE_EIGHT="ADAPTER_SIZE_EIGHT",n.ADAPTER_SIZE_SIXTEEN="ADAPTER_SIZE_SIXTEEN",n.ADAPTER_SIZE_THIRTY_TWO="ADAPTER_SIZE_THIRTY_TWO"})(mh||(mh={}));var ph;(function(n){n.FEATURE_SELECTION_PREFERENCE_UNSPECIFIED="FEATURE_SELECTION_PREFERENCE_UNSPECIFIED",n.PRIORITIZE_QUALITY="PRIORITIZE_QUALITY",n.BALANCED="BALANCED",n.PRIORITIZE_COST="PRIORITIZE_COST"})(ph||(ph={}));var yh;(function(n){n.UNSPECIFIED="UNSPECIFIED",n.BLOCKING="BLOCKING",n.NON_BLOCKING="NON_BLOCKING"})(yh||(yh={}));var xh;(function(n){n.MODE_UNSPECIFIED="MODE_UNSPECIFIED",n.MODE_DYNAMIC="MODE_DYNAMIC"})(xh||(xh={}));var gh;(function(n){n.ENVIRONMENT_UNSPECIFIED="ENVIRONMENT_UNSPECIFIED",n.ENVIRONMENT_BROWSER="ENVIRONMENT_BROWSER"})(gh||(gh={}));var _h;(function(n){n.MODE_UNSPECIFIED="MODE_UNSPECIFIED",n.AUTO="AUTO",n.ANY="ANY",n.NONE="NONE",n.VALIDATED="VALIDATED"})(_h||(_h={}));var bh;(function(n){n.BLOCK_LOW_AND_ABOVE="BLOCK_LOW_AND_ABOVE",n.BLOCK_MEDIUM_AND_ABOVE="BLOCK_MEDIUM_AND_ABOVE",n.BLOCK_ONLY_HIGH="BLOCK_ONLY_HIGH",n.BLOCK_NONE="BLOCK_NONE"})(bh||(bh={}));var vh;(function(n){n.DONT_ALLOW="DONT_ALLOW",n.ALLOW_ADULT="ALLOW_ADULT",n.ALLOW_ALL="ALLOW_ALL"})(vh||(vh={}));var Eh;(function(n){n.auto="auto",n.en="en",n.ja="ja",n.ko="ko",n.hi="hi",n.zh="zh",n.pt="pt",n.es="es"})(Eh||(Eh={}));var Ah;(function(n){n.MASK_MODE_DEFAULT="MASK_MODE_DEFAULT",n.MASK_MODE_USER_PROVIDED="MASK_MODE_USER_PROVIDED",n.MASK_MODE_BACKGROUND="MASK_MODE_BACKGROUND",n.MASK_MODE_FOREGROUND="MASK_MODE_FOREGROUND",n.MASK_MODE_SEMANTIC="MASK_MODE_SEMANTIC"})(Ah||(Ah={}));var Th;(function(n){n.CONTROL_TYPE_DEFAULT="CONTROL_TYPE_DEFAULT",n.CONTROL_TYPE_CANNY="CONTROL_TYPE_CANNY",n.CONTROL_TYPE_SCRIBBLE="CONTROL_TYPE_SCRIBBLE",n.CONTROL_TYPE_FACE_MESH="CONTROL_TYPE_FACE_MESH"})(Th||(Th={}));var Sh;(function(n){n.SUBJECT_TYPE_DEFAULT="SUBJECT_TYPE_DEFAULT",n.SUBJECT_TYPE_PERSON="SUBJECT_TYPE_PERSON",n.SUBJECT_TYPE_ANIMAL="SUBJECT_TYPE_ANIMAL",n.SUBJECT_TYPE_PRODUCT="SUBJECT_TYPE_PRODUCT"})(Sh||(Sh={}));var wh;(function(n){n.EDIT_MODE_DEFAULT="EDIT_MODE_DEFAULT",n.EDIT_MODE_INPAINT_REMOVAL="EDIT_MODE_INPAINT_REMOVAL",n.EDIT_MODE_INPAINT_INSERTION="EDIT_MODE_INPAINT_INSERTION",n.EDIT_MODE_OUTPAINT="EDIT_MODE_OUTPAINT",n.EDIT_MODE_CONTROLLED_EDITING="EDIT_MODE_CONTROLLED_EDITING",n.EDIT_MODE_STYLE="EDIT_MODE_STYLE",n.EDIT_MODE_BGSWAP="EDIT_MODE_BGSWAP",n.EDIT_MODE_PRODUCT_IMAGE="EDIT_MODE_PRODUCT_IMAGE"})(wh||(wh={}));var Mh;(function(n){n.FOREGROUND="FOREGROUND",n.BACKGROUND="BACKGROUND",n.PROMPT="PROMPT",n.SEMANTIC="SEMANTIC",n.INTERACTIVE="INTERACTIVE"})(Mh||(Mh={}));var Ch;(function(n){n.ASSET="ASSET",n.STYLE="STYLE"})(Ch||(Ch={}));var Ih;(function(n){n.OPTIMIZED="OPTIMIZED",n.LOSSLESS="LOSSLESS"})(Ih||(Ih={}));var Rh;(function(n){n.STATE_UNSPECIFIED="STATE_UNSPECIFIED",n.PROCESSING="PROCESSING",n.ACTIVE="ACTIVE",n.FAILED="FAILED"})(Rh||(Rh={}));var Oh;(function(n){n.SOURCE_UNSPECIFIED="SOURCE_UNSPECIFIED",n.UPLOADED="UPLOADED",n.GENERATED="GENERATED"})(Oh||(Oh={}));var Nh;(function(n){n.MODALITY_UNSPECIFIED="MODALITY_UNSPECIFIED",n.TEXT="TEXT",n.IMAGE="IMAGE",n.VIDEO="VIDEO",n.AUDIO="AUDIO",n.DOCUMENT="DOCUMENT"})(Nh||(Nh={}));var Lh;(function(n){n.START_SENSITIVITY_UNSPECIFIED="START_SENSITIVITY_UNSPECIFIED",n.START_SENSITIVITY_HIGH="START_SENSITIVITY_HIGH",n.START_SENSITIVITY_LOW="START_SENSITIVITY_LOW"})(Lh||(Lh={}));var Dh;(function(n){n.END_SENSITIVITY_UNSPECIFIED="END_SENSITIVITY_UNSPECIFIED",n.END_SENSITIVITY_HIGH="END_SENSITIVITY_HIGH",n.END_SENSITIVITY_LOW="END_SENSITIVITY_LOW"})(Dh||(Dh={}));var Fh;(function(n){n.ACTIVITY_HANDLING_UNSPECIFIED="ACTIVITY_HANDLING_UNSPECIFIED",n.START_OF_ACTIVITY_INTERRUPTS="START_OF_ACTIVITY_INTERRUPTS",n.NO_INTERRUPTION="NO_INTERRUPTION"})(Fh||(Fh={}));var Ph;(function(n){n.TURN_COVERAGE_UNSPECIFIED="TURN_COVERAGE_UNSPECIFIED",n.TURN_INCLUDES_ONLY_ACTIVITY="TURN_INCLUDES_ONLY_ACTIVITY",n.TURN_INCLUDES_ALL_INPUT="TURN_INCLUDES_ALL_INPUT"})(Ph||(Ph={}));var Bh;(function(n){n.SCHEDULING_UNSPECIFIED="SCHEDULING_UNSPECIFIED",n.SILENT="SILENT",n.WHEN_IDLE="WHEN_IDLE",n.INTERRUPT="INTERRUPT"})(Bh||(Bh={}));var kh;(function(n){n.SCALE_UNSPECIFIED="SCALE_UNSPECIFIED",n.C_MAJOR_A_MINOR="C_MAJOR_A_MINOR",n.D_FLAT_MAJOR_B_FLAT_MINOR="D_FLAT_MAJOR_B_FLAT_MINOR",n.D_MAJOR_B_MINOR="D_MAJOR_B_MINOR",n.E_FLAT_MAJOR_C_MINOR="E_FLAT_MAJOR_C_MINOR",n.E_MAJOR_D_FLAT_MINOR="E_MAJOR_D_FLAT_MINOR",n.F_MAJOR_D_MINOR="F_MAJOR_D_MINOR",n.G_FLAT_MAJOR_E_FLAT_MINOR="G_FLAT_MAJOR_E_FLAT_MINOR",n.G_MAJOR_E_MINOR="G_MAJOR_E_MINOR",n.A_FLAT_MAJOR_F_MINOR="A_FLAT_MAJOR_F_MINOR",n.A_MAJOR_G_FLAT_MINOR="A_MAJOR_G_FLAT_MINOR",n.B_FLAT_MAJOR_G_MINOR="B_FLAT_MAJOR_G_MINOR",n.B_MAJOR_A_FLAT_MINOR="B_MAJOR_A_FLAT_MINOR"})(kh||(kh={}));var zh;(function(n){n.MUSIC_GENERATION_MODE_UNSPECIFIED="MUSIC_GENERATION_MODE_UNSPECIFIED",n.QUALITY="QUALITY",n.DIVERSITY="DIVERSITY",n.VOCALIZATION="VOCALIZATION"})(zh||(zh={}));var Uh;(function(n){n.PLAYBACK_CONTROL_UNSPECIFIED="PLAYBACK_CONTROL_UNSPECIFIED",n.PLAY="PLAY",n.PAUSE="PAUSE",n.STOP="STOP",n.RESET_CONTEXT="RESET_CONTEXT"})(Uh||(Uh={}));/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */var Gh;(function(n){n.PAGED_ITEM_BATCH_JOBS="batchJobs",n.PAGED_ITEM_MODELS="models",n.PAGED_ITEM_TUNING_JOBS="tuningJobs",n.PAGED_ITEM_FILES="files",n.PAGED_ITEM_CACHED_CONTENTS="cachedContents"})(Gh||(Gh={}));function Pp(){const n="AIzaSyC0W595gQfd_V-pDmy2e2wRqoGOFJbhYKI";if(n.trim()==="")throw new Error("VITE_GEMINI_API_KEY is not configured in the .env file.");return n}const ta=Object.freeze({get apiKey(){return Pp()},gemini:{modelName:"gemini-2.5-pro",generationConfig:{temperature:.9,topK:1,topP:1,maxOutputTokens:2048},safetySettings:[{category:un.HARM_CATEGORY_HARASSMENT,threshold:fn.BLOCK_MEDIUM_AND_ABOVE},{category:un.HARM_CATEGORY_HATE_SPEECH,threshold:fn.BLOCK_MEDIUM_AND_ABOVE},{category:un.HARM_CATEGORY_SEXUALLY_EXPLICIT,threshold:fn.BLOCK_MEDIUM_AND_ABOVE},{category:un.HARM_CATEGORY_DANGEROUS_CONTENT,threshold:fn.BLOCK_MEDIUM_AND_ABOVE}]},api:{baseUrl:"/api",endpoints:{processAudio:"/generate-blueprint",generateSkybox:"/generate-skybox"}}}),Bp=async(n,t,e)=>{const r=`${ta.api.baseUrl}${ta.api.endpoints.processAudio}`,i=new FormData;if(i.append("audio_file",n),e&&typeof e=="object")try{i.append("options",JSON.stringify(e))}catch{}try{console.debug("[GeminiService] Posting audio to backend",{url:r,fileName:n.name,fileSize:n.size});const s=await fetch(r,{method:"POST",body:i,signal:t});if(!s.ok){let o="Unknown server error";try{const c=await s.json();o=c.detail||c.error||JSON.stringify(c)}catch{}throw new Error(`Backend error: ${s.status} ${s.statusText} - ${o}`)}const a=await s.json();if(!a||!a.blueprint)throw new Error("Backend returned invalid payload");return{blueprint:a.blueprint,features:a.features}}catch(s){console.error("[GeminiService] generateRideBlueprint failed:",s);const a=s instanceof Error?s.message:String(s);throw a.includes("Failed to fetch")||a.includes("NetworkError")||a.includes("TypeError")?new Error(`Failed to contact backend at ${r}. This may indicate the backend is not running, CORS is blocking the request, or a network problem. Original error: ${a}`):s}},kp=async(n,t)=>{try{const e=`${ta.api.baseUrl}${ta.api.endpoints.generateSkybox}`,r=t&&t.generationOptions?t.generationOptions:null,i=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({prompt:n,blueprint:t,options:r})});if(!i.ok){const a=await i.json();throw i.status===501?(console.info("[GeminiService] Skybox generation not supported:",a.detail),new Error("Skybox generation not supported by Gemini API")):new Error(a.detail||"Failed to generate skybox image")}return(await i.json()).imageUrl}catch(e){console.warn("[GeminiService] Skybox generation failed, continuing without custom skybox:",e);const r=e instanceof Error?e.message:String(e);throw new Error(`Skybox generation unavailable: ${r}`)}},Bo=n=>{const t=n.component??n.type;return typeof t=="string"?t:void 0},Vh=n=>{switch((Bo(n)||"").toLowerCase()){case"drop":case"loop":case"barrelRoll":return!0;case"turn":{const e=n;return e.radius!==void 0&&e.radius<100}default:return!1}},zp=()=>({component:"climb",angle:0,length:30,intensity:10,lightingEffect:"none",environmentChange:"none",audioSyncPoint:Yu(0)}),Up=n=>{var r;console.log("Starting blueprint validation and refinement..."),console.log("[Validator] Blueprint structure:",{hasTrack:!!n.track,trackType:typeof n.track,trackLength:(r=n.track)==null?void 0:r.length,rideName:n.rideName,blueprintKeys:Object.keys(n)});const t=n.track;if(!t||!Array.isArray(t))throw console.error("[Validator] Invalid blueprint.track:",t),new Error("Blueprint is missing a valid track array");if(t.length<2)return n;const e=[t[0]];for(let i=1;i<t.length;i++){const s=t[i-1],a=t[i];Vh(s)&&Vh(a)&&(console.log(`[Validator] Intense transition found between segment ${i-1} (${Bo(s)}) and ${i} (${Bo(a)}). Inserting easing segment.`),e.push(zp())),e.push(a)}return console.log(`Blueprint refined. Original segments: ${t.length}, Refined segments: ${e.length}`),{...n,track:e}};/**
 * @license
 * Copyright 2010-2025 Three.js Authors
 * SPDX-License-Identifier: MIT
 */const Xu="178",rg=0,ig=1,ng=2,sg=1,ag=2,og=3,ko=0,$u=1,lg=2,Gp=0,jh=1,cg=2,hg=3,ug=4,fg=5,Hh=100,dg=101,mg=102,pg=103,yg=104,xg=200,gg=201,_g=202,bg=203,Wh=204,Yh=205,vg=206,Eg=207,Ag=208,Tg=209,Sg=210,wg=211,Mg=212,Cg=213,Ig=214,Rg=0,Og=1,Ng=2,Xh=3,Lg=4,Dg=5,Fg=6,Pg=7,Vp=0,Bg=1,kg=2,zg=0,Ug=1,Gg=2,Vg=3,jg=4,Hg=5,Wg=6,Yg=7,Ju=300,jp=301,Xg=302,$g=303,Jg=304,qg=306,$h=1e3,dn=1001,Jh=1002,oi=1003,Zg=1004,Kg=1005,ea=1006,Qg=1007,qu=1008,Uo=1009,Hp=1010,Wp=1011,Yp=1012,Xp=1013,Zu=1014,Go=1015,$p=1016,Jp=1017,qp=1018,t_=1020,Zp=35902,Kp=1021,Qp=1022,Ku=1023,qh=1026,t0=1027,Qu=1028,e0=1029,r0=1030,i0=1031,n0=1033,s0=33776,a0=33777,o0=33778,l0=33779,c0=35840,h0=35841,u0=35842,f0=35843,d0=36196,m0=37492,p0=37496,y0=37808,x0=37809,g0=37810,_0=37811,b0=37812,v0=37813,E0=37814,A0=37815,T0=37816,S0=37817,w0=37818,M0=37819,C0=37820,I0=37821,R0=36492,O0=36494,N0=36495,L0=36283,D0=36284,F0=36285,P0=36286,B0=3200,e_=3201,k0=0,r_=1,tf="",_r="srgb",Zh="srgb-linear",Kh="linear",so="srgb",Xi=7680,Qh=519,i_=512,n_=513,s_=514,a_=515,o_=516,l_=517,c_=518,h_=519,tu=35044,u_=35048,f_="300 es",si=2e3,ra=2001;class Jn{addEventListener(t,e){this._listeners===void 0&&(this._listeners={});const r=this._listeners;r[t]===void 0&&(r[t]=[]),r[t].indexOf(e)===-1&&r[t].push(e)}hasEventListener(t,e){const r=this._listeners;return r===void 0?!1:r[t]!==void 0&&r[t].indexOf(e)!==-1}removeEventListener(t,e){const r=this._listeners;if(r===void 0)return;const i=r[t];if(i!==void 0){const s=i.indexOf(e);s!==-1&&i.splice(s,1)}}dispatchEvent(t){const e=this._listeners;if(e===void 0)return;const r=e[t.type];if(r!==void 0){t.target=this;const i=r.slice(0);for(let s=0,a=i.length;s<a;s++)i[s].call(this,t);t.target=null}}}const $e=["00","01","02","03","04","05","06","07","08","09","0a","0b","0c","0d","0e","0f","10","11","12","13","14","15","16","17","18","19","1a","1b","1c","1d","1e","1f","20","21","22","23","24","25","26","27","28","29","2a","2b","2c","2d","2e","2f","30","31","32","33","34","35","36","37","38","39","3a","3b","3c","3d","3e","3f","40","41","42","43","44","45","46","47","48","49","4a","4b","4c","4d","4e","4f","50","51","52","53","54","55","56","57","58","59","5a","5b","5c","5d","5e","5f","60","61","62","63","64","65","66","67","68","69","6a","6b","6c","6d","6e","6f","70","71","72","73","74","75","76","77","78","79","7a","7b","7c","7d","7e","7f","80","81","82","83","84","85","86","87","88","89","8a","8b","8c","8d","8e","8f","90","91","92","93","94","95","96","97","98","99","9a","9b","9c","9d","9e","9f","a0","a1","a2","a3","a4","a5","a6","a7","a8","a9","aa","ab","ac","ad","ae","af","b0","b1","b2","b3","b4","b5","b6","b7","b8","b9","ba","bb","bc","bd","be","bf","c0","c1","c2","c3","c4","c5","c6","c7","c8","c9","ca","cb","cc","cd","ce","cf","d0","d1","d2","d3","d4","d5","d6","d7","d8","d9","da","db","dc","dd","de","df","e0","e1","e2","e3","e4","e5","e6","e7","e8","e9","ea","eb","ec","ed","ee","ef","f0","f1","f2","f3","f4","f5","f6","f7","f8","f9","fa","fb","fc","fd","fe","ff"];let eu=1234567;const Wn=Math.PI/180,ia=180/Math.PI;function pn(){const n=Math.random()*4294967295|0,t=Math.random()*4294967295|0,e=Math.random()*4294967295|0,r=Math.random()*4294967295|0;return($e[n&255]+$e[n>>8&255]+$e[n>>16&255]+$e[n>>24&255]+"-"+$e[t&255]+$e[t>>8&255]+"-"+$e[t>>16&15|64]+$e[t>>24&255]+"-"+$e[e&63|128]+$e[e>>8&255]+"-"+$e[e>>16&255]+$e[e>>24&255]+$e[r&255]+$e[r>>8&255]+$e[r>>16&255]+$e[r>>24&255]).toLowerCase()}function ae(n,t,e){return Math.max(t,Math.min(e,n))}function Vo(n,t){return(n%t+t)%t}function z0(n,t,e,r,i){return r+(n-t)*(i-r)/(e-t)}function U0(n,t,e){return n!==t?(e-n)/(t-n):0}function Yn(n,t,e){return(1-e)*n+e*t}function G0(n,t,e,r){return Yn(n,t,1-Math.exp(-e*r))}function V0(n,t=1){return t-Math.abs(Vo(n,t*2)-t)}function j0(n,t,e){return n<=t?0:n>=e?1:(n=(n-t)/(e-t),n*n*(3-2*n))}function H0(n,t,e){return n<=t?0:n>=e?1:(n=(n-t)/(e-t),n*n*n*(n*(n*6-15)+10))}function W0(n,t){return n+Math.floor(Math.random()*(t-n+1))}function Y0(n,t){return n+Math.random()*(t-n)}function X0(n){return n*(.5-Math.random())}function $0(n){n!==void 0&&(eu=n);let t=eu+=1831565813;return t=Math.imul(t^t>>>15,t|1),t^=t+Math.imul(t^t>>>7,t|61),((t^t>>>14)>>>0)/4294967296}function J0(n){return n*Wn}function q0(n){return n*ia}function Z0(n){return(n&n-1)===0&&n!==0}function K0(n){return Math.pow(2,Math.ceil(Math.log(n)/Math.LN2))}function Q0(n){return Math.pow(2,Math.floor(Math.log(n)/Math.LN2))}function ty(n,t,e,r,i){const s=Math.cos,a=Math.sin,o=s(e/2),c=a(e/2),h=s((t+r)/2),u=a((t+r)/2),d=s((t-r)/2),x=a((t-r)/2),g=s((r-t)/2),A=a((r-t)/2);switch(i){case"XYX":n.set(o*u,c*d,c*x,o*h);break;case"YZY":n.set(c*x,o*u,c*d,o*h);break;case"ZXZ":n.set(c*d,c*x,o*u,o*h);break;case"XZX":n.set(o*u,c*A,c*g,o*h);break;case"YXY":n.set(c*g,o*u,c*A,o*h);break;case"ZYZ":n.set(c*A,c*g,o*u,o*h);break;default:console.warn("THREE.MathUtils: .setQuaternionFromProperEuler() encountered an unknown order: "+i)}}function hn(n,t){switch(t.constructor){case Float32Array:return n;case Uint32Array:return n/4294967295;case Uint16Array:return n/65535;case Uint8Array:return n/255;case Int32Array:return Math.max(n/2147483647,-1);case Int16Array:return Math.max(n/32767,-1);case Int8Array:return Math.max(n/127,-1);default:throw new Error("Invalid component type.")}}function Ze(n,t){switch(t.constructor){case Float32Array:return n;case Uint32Array:return Math.round(n*4294967295);case Uint16Array:return Math.round(n*65535);case Uint8Array:return Math.round(n*255);case Int32Array:return Math.round(n*2147483647);case Int16Array:return Math.round(n*32767);case Int8Array:return Math.round(n*127);default:throw new Error("Invalid component type.")}}const Te={DEG2RAD:Wn,RAD2DEG:ia,generateUUID:pn,clamp:ae,euclideanModulo:Vo,mapLinear:z0,inverseLerp:U0,lerp:Yn,damp:G0,pingpong:V0,smoothstep:j0,smootherstep:H0,randInt:W0,randFloat:Y0,randFloatSpread:X0,seededRandom:$0,degToRad:J0,radToDeg:q0,isPowerOfTwo:Z0,ceilPowerOfTwo:K0,floorPowerOfTwo:Q0,setQuaternionFromProperEuler:ty,normalize:Ze,denormalize:hn};class le{constructor(t=0,e=0){le.prototype.isVector2=!0,this.x=t,this.y=e}get width(){return this.x}set width(t){this.x=t}get height(){return this.y}set height(t){this.y=t}set(t,e){return this.x=t,this.y=e,this}setScalar(t){return this.x=t,this.y=t,this}setX(t){return this.x=t,this}setY(t){return this.y=t,this}setComponent(t,e){switch(t){case 0:this.x=e;break;case 1:this.y=e;break;default:throw new Error("index is out of range: "+t)}return this}getComponent(t){switch(t){case 0:return this.x;case 1:return this.y;default:throw new Error("index is out of range: "+t)}}clone(){return new this.constructor(this.x,this.y)}copy(t){return this.x=t.x,this.y=t.y,this}add(t){return this.x+=t.x,this.y+=t.y,this}addScalar(t){return this.x+=t,this.y+=t,this}addVectors(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this}addScaledVector(t,e){return this.x+=t.x*e,this.y+=t.y*e,this}sub(t){return this.x-=t.x,this.y-=t.y,this}subScalar(t){return this.x-=t,this.y-=t,this}subVectors(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this}multiply(t){return this.x*=t.x,this.y*=t.y,this}multiplyScalar(t){return this.x*=t,this.y*=t,this}divide(t){return this.x/=t.x,this.y/=t.y,this}divideScalar(t){return this.multiplyScalar(1/t)}applyMatrix3(t){const e=this.x,r=this.y,i=t.elements;return this.x=i[0]*e+i[3]*r+i[6],this.y=i[1]*e+i[4]*r+i[7],this}min(t){return this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this}max(t){return this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this}clamp(t,e){return this.x=ae(this.x,t.x,e.x),this.y=ae(this.y,t.y,e.y),this}clampScalar(t,e){return this.x=ae(this.x,t,e),this.y=ae(this.y,t,e),this}clampLength(t,e){const r=this.length();return this.divideScalar(r||1).multiplyScalar(ae(r,t,e))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}roundToZero(){return this.x=Math.trunc(this.x),this.y=Math.trunc(this.y),this}negate(){return this.x=-this.x,this.y=-this.y,this}dot(t){return this.x*t.x+this.y*t.y}cross(t){return this.x*t.y-this.y*t.x}lengthSq(){return this.x*this.x+this.y*this.y}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)}normalize(){return this.divideScalar(this.length()||1)}angle(){return Math.atan2(-this.y,-this.x)+Math.PI}angleTo(t){const e=Math.sqrt(this.lengthSq()*t.lengthSq());if(e===0)return Math.PI/2;const r=this.dot(t)/e;return Math.acos(ae(r,-1,1))}distanceTo(t){return Math.sqrt(this.distanceToSquared(t))}distanceToSquared(t){const e=this.x-t.x,r=this.y-t.y;return e*e+r*r}manhattanDistanceTo(t){return Math.abs(this.x-t.x)+Math.abs(this.y-t.y)}setLength(t){return this.normalize().multiplyScalar(t)}lerp(t,e){return this.x+=(t.x-this.x)*e,this.y+=(t.y-this.y)*e,this}lerpVectors(t,e,r){return this.x=t.x+(e.x-t.x)*r,this.y=t.y+(e.y-t.y)*r,this}equals(t){return t.x===this.x&&t.y===this.y}fromArray(t,e=0){return this.x=t[e],this.y=t[e+1],this}toArray(t=[],e=0){return t[e]=this.x,t[e+1]=this.y,t}fromBufferAttribute(t,e){return this.x=t.getX(e),this.y=t.getY(e),this}rotateAround(t,e){const r=Math.cos(e),i=Math.sin(e),s=this.x-t.x,a=this.y-t.y;return this.x=s*r-a*i+t.x,this.y=s*i+a*r+t.y,this}random(){return this.x=Math.random(),this.y=Math.random(),this}*[Symbol.iterator](){yield this.x,yield this.y}}class qn{constructor(t=0,e=0,r=0,i=1){this.isQuaternion=!0,this._x=t,this._y=e,this._z=r,this._w=i}static slerpFlat(t,e,r,i,s,a,o){let c=r[i+0],h=r[i+1],u=r[i+2],d=r[i+3];const x=s[a+0],g=s[a+1],A=s[a+2],P=s[a+3];if(o===0){t[e+0]=c,t[e+1]=h,t[e+2]=u,t[e+3]=d;return}if(o===1){t[e+0]=x,t[e+1]=g,t[e+2]=A,t[e+3]=P;return}if(d!==P||c!==x||h!==g||u!==A){let H=1-o;const V=c*x+h*g+u*A+d*P,At=V>=0?1:-1,tt=1-V*V;if(tt>Number.EPSILON){const wt=Math.sqrt(tt),Et=Math.atan2(wt,V*At);H=Math.sin(H*Et)/wt,o=Math.sin(o*Et)/wt}const lt=o*At;if(c=c*H+x*lt,h=h*H+g*lt,u=u*H+A*lt,d=d*H+P*lt,H===1-o){const wt=1/Math.sqrt(c*c+h*h+u*u+d*d);c*=wt,h*=wt,u*=wt,d*=wt}}t[e]=c,t[e+1]=h,t[e+2]=u,t[e+3]=d}static multiplyQuaternionsFlat(t,e,r,i,s,a){const o=r[i],c=r[i+1],h=r[i+2],u=r[i+3],d=s[a],x=s[a+1],g=s[a+2],A=s[a+3];return t[e]=o*A+u*d+c*g-h*x,t[e+1]=c*A+u*x+h*d-o*g,t[e+2]=h*A+u*g+o*x-c*d,t[e+3]=u*A-o*d-c*x-h*g,t}get x(){return this._x}set x(t){this._x=t,this._onChangeCallback()}get y(){return this._y}set y(t){this._y=t,this._onChangeCallback()}get z(){return this._z}set z(t){this._z=t,this._onChangeCallback()}get w(){return this._w}set w(t){this._w=t,this._onChangeCallback()}set(t,e,r,i){return this._x=t,this._y=e,this._z=r,this._w=i,this._onChangeCallback(),this}clone(){return new this.constructor(this._x,this._y,this._z,this._w)}copy(t){return this._x=t.x,this._y=t.y,this._z=t.z,this._w=t.w,this._onChangeCallback(),this}setFromEuler(t,e=!0){const r=t._x,i=t._y,s=t._z,a=t._order,o=Math.cos,c=Math.sin,h=o(r/2),u=o(i/2),d=o(s/2),x=c(r/2),g=c(i/2),A=c(s/2);switch(a){case"XYZ":this._x=x*u*d+h*g*A,this._y=h*g*d-x*u*A,this._z=h*u*A+x*g*d,this._w=h*u*d-x*g*A;break;case"YXZ":this._x=x*u*d+h*g*A,this._y=h*g*d-x*u*A,this._z=h*u*A-x*g*d,this._w=h*u*d+x*g*A;break;case"ZXY":this._x=x*u*d-h*g*A,this._y=h*g*d+x*u*A,this._z=h*u*A+x*g*d,this._w=h*u*d-x*g*A;break;case"ZYX":this._x=x*u*d-h*g*A,this._y=h*g*d+x*u*A,this._z=h*u*A-x*g*d,this._w=h*u*d+x*g*A;break;case"YZX":this._x=x*u*d+h*g*A,this._y=h*g*d+x*u*A,this._z=h*u*A-x*g*d,this._w=h*u*d-x*g*A;break;case"XZY":this._x=x*u*d-h*g*A,this._y=h*g*d-x*u*A,this._z=h*u*A+x*g*d,this._w=h*u*d+x*g*A;break;default:console.warn("THREE.Quaternion: .setFromEuler() encountered an unknown order: "+a)}return e===!0&&this._onChangeCallback(),this}setFromAxisAngle(t,e){const r=e/2,i=Math.sin(r);return this._x=t.x*i,this._y=t.y*i,this._z=t.z*i,this._w=Math.cos(r),this._onChangeCallback(),this}setFromRotationMatrix(t){const e=t.elements,r=e[0],i=e[4],s=e[8],a=e[1],o=e[5],c=e[9],h=e[2],u=e[6],d=e[10],x=r+o+d;if(x>0){const g=.5/Math.sqrt(x+1);this._w=.25/g,this._x=(u-c)*g,this._y=(s-h)*g,this._z=(a-i)*g}else if(r>o&&r>d){const g=2*Math.sqrt(1+r-o-d);this._w=(u-c)/g,this._x=.25*g,this._y=(i+a)/g,this._z=(s+h)/g}else if(o>d){const g=2*Math.sqrt(1+o-r-d);this._w=(s-h)/g,this._x=(i+a)/g,this._y=.25*g,this._z=(c+u)/g}else{const g=2*Math.sqrt(1+d-r-o);this._w=(a-i)/g,this._x=(s+h)/g,this._y=(c+u)/g,this._z=.25*g}return this._onChangeCallback(),this}setFromUnitVectors(t,e){let r=t.dot(e)+1;return r<1e-8?(r=0,Math.abs(t.x)>Math.abs(t.z)?(this._x=-t.y,this._y=t.x,this._z=0,this._w=r):(this._x=0,this._y=-t.z,this._z=t.y,this._w=r)):(this._x=t.y*e.z-t.z*e.y,this._y=t.z*e.x-t.x*e.z,this._z=t.x*e.y-t.y*e.x,this._w=r),this.normalize()}angleTo(t){return 2*Math.acos(Math.abs(ae(this.dot(t),-1,1)))}rotateTowards(t,e){const r=this.angleTo(t);if(r===0)return this;const i=Math.min(1,e/r);return this.slerp(t,i),this}identity(){return this.set(0,0,0,1)}invert(){return this.conjugate()}conjugate(){return this._x*=-1,this._y*=-1,this._z*=-1,this._onChangeCallback(),this}dot(t){return this._x*t._x+this._y*t._y+this._z*t._z+this._w*t._w}lengthSq(){return this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w}length(){return Math.sqrt(this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w)}normalize(){let t=this.length();return t===0?(this._x=0,this._y=0,this._z=0,this._w=1):(t=1/t,this._x=this._x*t,this._y=this._y*t,this._z=this._z*t,this._w=this._w*t),this._onChangeCallback(),this}multiply(t){return this.multiplyQuaternions(this,t)}premultiply(t){return this.multiplyQuaternions(t,this)}multiplyQuaternions(t,e){const r=t._x,i=t._y,s=t._z,a=t._w,o=e._x,c=e._y,h=e._z,u=e._w;return this._x=r*u+a*o+i*h-s*c,this._y=i*u+a*c+s*o-r*h,this._z=s*u+a*h+r*c-i*o,this._w=a*u-r*o-i*c-s*h,this._onChangeCallback(),this}slerp(t,e){if(e===0)return this;if(e===1)return this.copy(t);const r=this._x,i=this._y,s=this._z,a=this._w;let o=a*t._w+r*t._x+i*t._y+s*t._z;if(o<0?(this._w=-t._w,this._x=-t._x,this._y=-t._y,this._z=-t._z,o=-o):this.copy(t),o>=1)return this._w=a,this._x=r,this._y=i,this._z=s,this;const c=1-o*o;if(c<=Number.EPSILON){const g=1-e;return this._w=g*a+e*this._w,this._x=g*r+e*this._x,this._y=g*i+e*this._y,this._z=g*s+e*this._z,this.normalize(),this}const h=Math.sqrt(c),u=Math.atan2(h,o),d=Math.sin((1-e)*u)/h,x=Math.sin(e*u)/h;return this._w=a*d+this._w*x,this._x=r*d+this._x*x,this._y=i*d+this._y*x,this._z=s*d+this._z*x,this._onChangeCallback(),this}slerpQuaternions(t,e,r){return this.copy(t).slerp(e,r)}random(){const t=2*Math.PI*Math.random(),e=2*Math.PI*Math.random(),r=Math.random(),i=Math.sqrt(1-r),s=Math.sqrt(r);return this.set(i*Math.sin(t),i*Math.cos(t),s*Math.sin(e),s*Math.cos(e))}equals(t){return t._x===this._x&&t._y===this._y&&t._z===this._z&&t._w===this._w}fromArray(t,e=0){return this._x=t[e],this._y=t[e+1],this._z=t[e+2],this._w=t[e+3],this._onChangeCallback(),this}toArray(t=[],e=0){return t[e]=this._x,t[e+1]=this._y,t[e+2]=this._z,t[e+3]=this._w,t}fromBufferAttribute(t,e){return this._x=t.getX(e),this._y=t.getY(e),this._z=t.getZ(e),this._w=t.getW(e),this._onChangeCallback(),this}toJSON(){return this.toArray()}_onChange(t){return this._onChangeCallback=t,this}_onChangeCallback(){}*[Symbol.iterator](){yield this._x,yield this._y,yield this._z,yield this._w}}class L{constructor(t=0,e=0,r=0){L.prototype.isVector3=!0,this.x=t,this.y=e,this.z=r}set(t,e,r){return r===void 0&&(r=this.z),this.x=t,this.y=e,this.z=r,this}setScalar(t){return this.x=t,this.y=t,this.z=t,this}setX(t){return this.x=t,this}setY(t){return this.y=t,this}setZ(t){return this.z=t,this}setComponent(t,e){switch(t){case 0:this.x=e;break;case 1:this.y=e;break;case 2:this.z=e;break;default:throw new Error("index is out of range: "+t)}return this}getComponent(t){switch(t){case 0:return this.x;case 1:return this.y;case 2:return this.z;default:throw new Error("index is out of range: "+t)}}clone(){return new this.constructor(this.x,this.y,this.z)}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this}add(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this}addScalar(t){return this.x+=t,this.y+=t,this.z+=t,this}addVectors(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this.z=t.z+e.z,this}addScaledVector(t,e){return this.x+=t.x*e,this.y+=t.y*e,this.z+=t.z*e,this}sub(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this}subScalar(t){return this.x-=t,this.y-=t,this.z-=t,this}subVectors(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this.z=t.z-e.z,this}multiply(t){return this.x*=t.x,this.y*=t.y,this.z*=t.z,this}multiplyScalar(t){return this.x*=t,this.y*=t,this.z*=t,this}multiplyVectors(t,e){return this.x=t.x*e.x,this.y=t.y*e.y,this.z=t.z*e.z,this}applyEuler(t){return this.applyQuaternion(ru.setFromEuler(t))}applyAxisAngle(t,e){return this.applyQuaternion(ru.setFromAxisAngle(t,e))}applyMatrix3(t){const e=this.x,r=this.y,i=this.z,s=t.elements;return this.x=s[0]*e+s[3]*r+s[6]*i,this.y=s[1]*e+s[4]*r+s[7]*i,this.z=s[2]*e+s[5]*r+s[8]*i,this}applyNormalMatrix(t){return this.applyMatrix3(t).normalize()}applyMatrix4(t){const e=this.x,r=this.y,i=this.z,s=t.elements,a=1/(s[3]*e+s[7]*r+s[11]*i+s[15]);return this.x=(s[0]*e+s[4]*r+s[8]*i+s[12])*a,this.y=(s[1]*e+s[5]*r+s[9]*i+s[13])*a,this.z=(s[2]*e+s[6]*r+s[10]*i+s[14])*a,this}applyQuaternion(t){const e=this.x,r=this.y,i=this.z,s=t.x,a=t.y,o=t.z,c=t.w,h=2*(a*i-o*r),u=2*(o*e-s*i),d=2*(s*r-a*e);return this.x=e+c*h+a*d-o*u,this.y=r+c*u+o*h-s*d,this.z=i+c*d+s*u-a*h,this}project(t){return this.applyMatrix4(t.matrixWorldInverse).applyMatrix4(t.projectionMatrix)}unproject(t){return this.applyMatrix4(t.projectionMatrixInverse).applyMatrix4(t.matrixWorld)}transformDirection(t){const e=this.x,r=this.y,i=this.z,s=t.elements;return this.x=s[0]*e+s[4]*r+s[8]*i,this.y=s[1]*e+s[5]*r+s[9]*i,this.z=s[2]*e+s[6]*r+s[10]*i,this.normalize()}divide(t){return this.x/=t.x,this.y/=t.y,this.z/=t.z,this}divideScalar(t){return this.multiplyScalar(1/t)}min(t){return this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this.z=Math.min(this.z,t.z),this}max(t){return this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this.z=Math.max(this.z,t.z),this}clamp(t,e){return this.x=ae(this.x,t.x,e.x),this.y=ae(this.y,t.y,e.y),this.z=ae(this.z,t.z,e.z),this}clampScalar(t,e){return this.x=ae(this.x,t,e),this.y=ae(this.y,t,e),this.z=ae(this.z,t,e),this}clampLength(t,e){const r=this.length();return this.divideScalar(r||1).multiplyScalar(ae(r,t,e))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this}roundToZero(){return this.x=Math.trunc(this.x),this.y=Math.trunc(this.y),this.z=Math.trunc(this.z),this}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)}normalize(){return this.divideScalar(this.length()||1)}setLength(t){return this.normalize().multiplyScalar(t)}lerp(t,e){return this.x+=(t.x-this.x)*e,this.y+=(t.y-this.y)*e,this.z+=(t.z-this.z)*e,this}lerpVectors(t,e,r){return this.x=t.x+(e.x-t.x)*r,this.y=t.y+(e.y-t.y)*r,this.z=t.z+(e.z-t.z)*r,this}cross(t){return this.crossVectors(this,t)}crossVectors(t,e){const r=t.x,i=t.y,s=t.z,a=e.x,o=e.y,c=e.z;return this.x=i*c-s*o,this.y=s*a-r*c,this.z=r*o-i*a,this}projectOnVector(t){const e=t.lengthSq();if(e===0)return this.set(0,0,0);const r=t.dot(this)/e;return this.copy(t).multiplyScalar(r)}projectOnPlane(t){return ao.copy(this).projectOnVector(t),this.sub(ao)}reflect(t){return this.sub(ao.copy(t).multiplyScalar(2*this.dot(t)))}angleTo(t){const e=Math.sqrt(this.lengthSq()*t.lengthSq());if(e===0)return Math.PI/2;const r=this.dot(t)/e;return Math.acos(ae(r,-1,1))}distanceTo(t){return Math.sqrt(this.distanceToSquared(t))}distanceToSquared(t){const e=this.x-t.x,r=this.y-t.y,i=this.z-t.z;return e*e+r*r+i*i}manhattanDistanceTo(t){return Math.abs(this.x-t.x)+Math.abs(this.y-t.y)+Math.abs(this.z-t.z)}setFromSpherical(t){return this.setFromSphericalCoords(t.radius,t.phi,t.theta)}setFromSphericalCoords(t,e,r){const i=Math.sin(e)*t;return this.x=i*Math.sin(r),this.y=Math.cos(e)*t,this.z=i*Math.cos(r),this}setFromCylindrical(t){return this.setFromCylindricalCoords(t.radius,t.theta,t.y)}setFromCylindricalCoords(t,e,r){return this.x=t*Math.sin(e),this.y=r,this.z=t*Math.cos(e),this}setFromMatrixPosition(t){const e=t.elements;return this.x=e[12],this.y=e[13],this.z=e[14],this}setFromMatrixScale(t){const e=this.setFromMatrixColumn(t,0).length(),r=this.setFromMatrixColumn(t,1).length(),i=this.setFromMatrixColumn(t,2).length();return this.x=e,this.y=r,this.z=i,this}setFromMatrixColumn(t,e){return this.fromArray(t.elements,e*4)}setFromMatrix3Column(t,e){return this.fromArray(t.elements,e*3)}setFromEuler(t){return this.x=t._x,this.y=t._y,this.z=t._z,this}setFromColor(t){return this.x=t.r,this.y=t.g,this.z=t.b,this}equals(t){return t.x===this.x&&t.y===this.y&&t.z===this.z}fromArray(t,e=0){return this.x=t[e],this.y=t[e+1],this.z=t[e+2],this}toArray(t=[],e=0){return t[e]=this.x,t[e+1]=this.y,t[e+2]=this.z,t}fromBufferAttribute(t,e){return this.x=t.getX(e),this.y=t.getY(e),this.z=t.getZ(e),this}random(){return this.x=Math.random(),this.y=Math.random(),this.z=Math.random(),this}randomDirection(){const t=Math.random()*Math.PI*2,e=Math.random()*2-1,r=Math.sqrt(1-e*e);return this.x=r*Math.cos(t),this.y=e,this.z=r*Math.sin(t),this}*[Symbol.iterator](){yield this.x,yield this.y,yield this.z}}const ao=new L,ru=new qn;class Gr{constructor(t,e,r,i,s,a,o,c,h){Gr.prototype.isMatrix3=!0,this.elements=[1,0,0,0,1,0,0,0,1],t!==void 0&&this.set(t,e,r,i,s,a,o,c,h)}set(t,e,r,i,s,a,o,c,h){const u=this.elements;return u[0]=t,u[1]=i,u[2]=o,u[3]=e,u[4]=s,u[5]=c,u[6]=r,u[7]=a,u[8]=h,this}identity(){return this.set(1,0,0,0,1,0,0,0,1),this}copy(t){const e=this.elements,r=t.elements;return e[0]=r[0],e[1]=r[1],e[2]=r[2],e[3]=r[3],e[4]=r[4],e[5]=r[5],e[6]=r[6],e[7]=r[7],e[8]=r[8],this}extractBasis(t,e,r){return t.setFromMatrix3Column(this,0),e.setFromMatrix3Column(this,1),r.setFromMatrix3Column(this,2),this}setFromMatrix4(t){const e=t.elements;return this.set(e[0],e[4],e[8],e[1],e[5],e[9],e[2],e[6],e[10]),this}multiply(t){return this.multiplyMatrices(this,t)}premultiply(t){return this.multiplyMatrices(t,this)}multiplyMatrices(t,e){const r=t.elements,i=e.elements,s=this.elements,a=r[0],o=r[3],c=r[6],h=r[1],u=r[4],d=r[7],x=r[2],g=r[5],A=r[8],P=i[0],H=i[3],V=i[6],At=i[1],tt=i[4],lt=i[7],wt=i[2],Et=i[5],Lt=i[8];return s[0]=a*P+o*At+c*wt,s[3]=a*H+o*tt+c*Et,s[6]=a*V+o*lt+c*Lt,s[1]=h*P+u*At+d*wt,s[4]=h*H+u*tt+d*Et,s[7]=h*V+u*lt+d*Lt,s[2]=x*P+g*At+A*wt,s[5]=x*H+g*tt+A*Et,s[8]=x*V+g*lt+A*Lt,this}multiplyScalar(t){const e=this.elements;return e[0]*=t,e[3]*=t,e[6]*=t,e[1]*=t,e[4]*=t,e[7]*=t,e[2]*=t,e[5]*=t,e[8]*=t,this}determinant(){const t=this.elements,e=t[0],r=t[1],i=t[2],s=t[3],a=t[4],o=t[5],c=t[6],h=t[7],u=t[8];return e*a*u-e*o*h-r*s*u+r*o*c+i*s*h-i*a*c}invert(){const t=this.elements,e=t[0],r=t[1],i=t[2],s=t[3],a=t[4],o=t[5],c=t[6],h=t[7],u=t[8],d=u*a-o*h,x=o*c-u*s,g=h*s-a*c,A=e*d+r*x+i*g;if(A===0)return this.set(0,0,0,0,0,0,0,0,0);const P=1/A;return t[0]=d*P,t[1]=(i*h-u*r)*P,t[2]=(o*r-i*a)*P,t[3]=x*P,t[4]=(u*e-i*c)*P,t[5]=(i*s-o*e)*P,t[6]=g*P,t[7]=(r*c-h*e)*P,t[8]=(a*e-r*s)*P,this}transpose(){let t;const e=this.elements;return t=e[1],e[1]=e[3],e[3]=t,t=e[2],e[2]=e[6],e[6]=t,t=e[5],e[5]=e[7],e[7]=t,this}getNormalMatrix(t){return this.setFromMatrix4(t).invert().transpose()}transposeIntoArray(t){const e=this.elements;return t[0]=e[0],t[1]=e[3],t[2]=e[6],t[3]=e[1],t[4]=e[4],t[5]=e[7],t[6]=e[2],t[7]=e[5],t[8]=e[8],this}setUvTransform(t,e,r,i,s,a,o){const c=Math.cos(s),h=Math.sin(s);return this.set(r*c,r*h,-r*(c*a+h*o)+a+t,-i*h,i*c,-i*(-h*a+c*o)+o+e,0,0,1),this}scale(t,e){return this.premultiply(oo.makeScale(t,e)),this}rotate(t){return this.premultiply(oo.makeRotation(-t)),this}translate(t,e){return this.premultiply(oo.makeTranslation(t,e)),this}makeTranslation(t,e){return t.isVector2?this.set(1,0,t.x,0,1,t.y,0,0,1):this.set(1,0,t,0,1,e,0,0,1),this}makeRotation(t){const e=Math.cos(t),r=Math.sin(t);return this.set(e,-r,0,r,e,0,0,0,1),this}makeScale(t,e){return this.set(t,0,0,0,e,0,0,0,1),this}equals(t){const e=this.elements,r=t.elements;for(let i=0;i<9;i++)if(e[i]!==r[i])return!1;return!0}fromArray(t,e=0){for(let r=0;r<9;r++)this.elements[r]=t[r+e];return this}toArray(t=[],e=0){const r=this.elements;return t[e]=r[0],t[e+1]=r[1],t[e+2]=r[2],t[e+3]=r[3],t[e+4]=r[4],t[e+5]=r[5],t[e+6]=r[6],t[e+7]=r[7],t[e+8]=r[8],t}clone(){return new this.constructor().fromArray(this.elements)}}const oo=new Gr;function ey(n){for(let t=n.length-1;t>=0;--t)if(n[t]>=65535)return!0;return!1}function na(n){return document.createElementNS("http://www.w3.org/1999/xhtml",n)}function d_(){const n=na("canvas");return n.style.display="block",n}const iu={};function nu(n){n in iu||(iu[n]=!0,console.warn(n))}function m_(n,t,e){return new Promise(function(r,i){function s(){switch(n.clientWaitSync(t,n.SYNC_FLUSH_COMMANDS_BIT,0)){case n.WAIT_FAILED:i();break;case n.TIMEOUT_EXPIRED:setTimeout(s,e);break;default:r()}}setTimeout(s,e)})}function p_(n){const t=n.elements;t[2]=.5*t[2]+.5*t[3],t[6]=.5*t[6]+.5*t[7],t[10]=.5*t[10]+.5*t[11],t[14]=.5*t[14]+.5*t[15]}function y_(n){const t=n.elements;t[11]===-1?(t[10]=-t[10]-1,t[14]=-t[14]):(t[10]=-t[10],t[14]=-t[14]+1)}const su=new Gr().set(.4123908,.3575843,.1804808,.212639,.7151687,.0721923,.0193308,.1191948,.9505322),au=new Gr().set(3.2409699,-1.5373832,-.4986108,-.9692436,1.8759675,.0415551,.0556301,-.203977,1.0569715);function ry(){const n={enabled:!0,workingColorSpace:Zh,spaces:{},convert:function(i,s,a){return this.enabled===!1||s===a||!s||!a||(this.spaces[s].transfer===so&&(i.r=Ur(i.r),i.g=Ur(i.g),i.b=Ur(i.b)),this.spaces[s].primaries!==this.spaces[a].primaries&&(i.applyMatrix3(this.spaces[s].toXYZ),i.applyMatrix3(this.spaces[a].fromXYZ)),this.spaces[a].transfer===so&&(i.r=mn(i.r),i.g=mn(i.g),i.b=mn(i.b))),i},workingToColorSpace:function(i,s){return this.convert(i,this.workingColorSpace,s)},colorSpaceToWorking:function(i,s){return this.convert(i,s,this.workingColorSpace)},getPrimaries:function(i){return this.spaces[i].primaries},getTransfer:function(i){return i===tf?Kh:this.spaces[i].transfer},getLuminanceCoefficients:function(i,s=this.workingColorSpace){return i.fromArray(this.spaces[s].luminanceCoefficients)},define:function(i){Object.assign(this.spaces,i)},_getMatrix:function(i,s,a){return i.copy(this.spaces[s].toXYZ).multiply(this.spaces[a].fromXYZ)},_getDrawingBufferColorSpace:function(i){return this.spaces[i].outputColorSpaceConfig.drawingBufferColorSpace},_getUnpackColorSpace:function(i=this.workingColorSpace){return this.spaces[i].workingColorSpaceConfig.unpackColorSpace},fromWorkingColorSpace:function(i,s){return nu("THREE.ColorManagement: .fromWorkingColorSpace() has been renamed to .workingToColorSpace()."),n.workingToColorSpace(i,s)},toWorkingColorSpace:function(i,s){return nu("THREE.ColorManagement: .toWorkingColorSpace() has been renamed to .colorSpaceToWorking()."),n.colorSpaceToWorking(i,s)}},t=[.64,.33,.3,.6,.15,.06],e=[.2126,.7152,.0722],r=[.3127,.329];return n.define({[Zh]:{primaries:t,whitePoint:r,transfer:Kh,toXYZ:su,fromXYZ:au,luminanceCoefficients:e,workingColorSpaceConfig:{unpackColorSpace:_r},outputColorSpaceConfig:{drawingBufferColorSpace:_r}},[_r]:{primaries:t,whitePoint:r,transfer:so,toXYZ:su,fromXYZ:au,luminanceCoefficients:e,outputColorSpaceConfig:{drawingBufferColorSpace:_r}}}),n}const fr=ry();function Ur(n){return n<.04045?n*.0773993808:Math.pow(n*.9478672986+.0521327014,2.4)}function mn(n){return n<.0031308?n*12.92:1.055*Math.pow(n,.41666)-.055}let $i;class iy{static getDataURL(t,e="image/png"){if(/^data:/i.test(t.src)||typeof HTMLCanvasElement>"u")return t.src;let r;if(t instanceof HTMLCanvasElement)r=t;else{$i===void 0&&($i=na("canvas")),$i.width=t.width,$i.height=t.height;const i=$i.getContext("2d");t instanceof ImageData?i.putImageData(t,0,0):i.drawImage(t,0,0,t.width,t.height),r=$i}return r.toDataURL(e)}static sRGBToLinear(t){if(typeof HTMLImageElement<"u"&&t instanceof HTMLImageElement||typeof HTMLCanvasElement<"u"&&t instanceof HTMLCanvasElement||typeof ImageBitmap<"u"&&t instanceof ImageBitmap){const e=na("canvas");e.width=t.width,e.height=t.height;const r=e.getContext("2d");r.drawImage(t,0,0,t.width,t.height);const i=r.getImageData(0,0,t.width,t.height),s=i.data;for(let a=0;a<s.length;a++)s[a]=Ur(s[a]/255)*255;return r.putImageData(i,0,0),e}else if(t.data){const e=t.data.slice(0);for(let r=0;r<e.length;r++)e instanceof Uint8Array||e instanceof Uint8ClampedArray?e[r]=Math.floor(Ur(e[r]/255)*255):e[r]=Ur(e[r]);return{data:e,width:t.width,height:t.height}}else return console.warn("THREE.ImageUtils.sRGBToLinear(): Unsupported image type. No color space conversion applied."),t}}let ny=0;class jo{constructor(t=null){this.isSource=!0,Object.defineProperty(this,"id",{value:ny++}),this.uuid=pn(),this.data=t,this.dataReady=!0,this.version=0}getSize(t){const e=this.data;return e instanceof HTMLVideoElement?t.set(e.videoWidth,e.videoHeight):e!==null?t.set(e.width,e.height,e.depth||0):t.set(0,0,0),t}set needsUpdate(t){t===!0&&this.version++}toJSON(t){const e=t===void 0||typeof t=="string";if(!e&&t.images[this.uuid]!==void 0)return t.images[this.uuid];const r={uuid:this.uuid,url:""},i=this.data;if(i!==null){let s;if(Array.isArray(i)){s=[];for(let a=0,o=i.length;a<o;a++)i[a].isDataTexture?s.push(lo(i[a].image)):s.push(lo(i[a]))}else s=lo(i);r.url=s}return e||(t.images[this.uuid]=r),r}}function lo(n){return typeof HTMLImageElement<"u"&&n instanceof HTMLImageElement||typeof HTMLCanvasElement<"u"&&n instanceof HTMLCanvasElement||typeof ImageBitmap<"u"&&n instanceof ImageBitmap?iy.getDataURL(n):n.data?{data:Array.from(n.data),width:n.width,height:n.height,type:n.data.constructor.name}:(console.warn("THREE.Texture: Unable to serialize Texture."),{})}let sy=0;const co=new L;class er extends Jn{constructor(t=er.DEFAULT_IMAGE,e=er.DEFAULT_MAPPING,r=dn,i=dn,s=ea,a=qu,o=Ku,c=Uo,h=er.DEFAULT_ANISOTROPY,u=tf){super(),this.isTexture=!0,Object.defineProperty(this,"id",{value:sy++}),this.uuid=pn(),this.name="",this.source=new jo(t),this.mipmaps=[],this.mapping=e,this.channel=0,this.wrapS=r,this.wrapT=i,this.magFilter=s,this.minFilter=a,this.anisotropy=h,this.format=o,this.internalFormat=null,this.type=c,this.offset=new le(0,0),this.repeat=new le(1,1),this.center=new le(0,0),this.rotation=0,this.matrixAutoUpdate=!0,this.matrix=new Gr,this.generateMipmaps=!0,this.premultiplyAlpha=!1,this.flipY=!0,this.unpackAlignment=4,this.colorSpace=u,this.userData={},this.updateRanges=[],this.version=0,this.onUpdate=null,this.renderTarget=null,this.isRenderTargetTexture=!1,this.isArrayTexture=!!(t&&t.depth&&t.depth>1),this.pmremVersion=0}get width(){return this.source.getSize(co).x}get height(){return this.source.getSize(co).y}get depth(){return this.source.getSize(co).z}get image(){return this.source.data}set image(t=null){this.source.data=t}updateMatrix(){this.matrix.setUvTransform(this.offset.x,this.offset.y,this.repeat.x,this.repeat.y,this.rotation,this.center.x,this.center.y)}addUpdateRange(t,e){this.updateRanges.push({start:t,count:e})}clearUpdateRanges(){this.updateRanges.length=0}clone(){return new this.constructor().copy(this)}copy(t){return this.name=t.name,this.source=t.source,this.mipmaps=t.mipmaps.slice(0),this.mapping=t.mapping,this.channel=t.channel,this.wrapS=t.wrapS,this.wrapT=t.wrapT,this.magFilter=t.magFilter,this.minFilter=t.minFilter,this.anisotropy=t.anisotropy,this.format=t.format,this.internalFormat=t.internalFormat,this.type=t.type,this.offset.copy(t.offset),this.repeat.copy(t.repeat),this.center.copy(t.center),this.rotation=t.rotation,this.matrixAutoUpdate=t.matrixAutoUpdate,this.matrix.copy(t.matrix),this.generateMipmaps=t.generateMipmaps,this.premultiplyAlpha=t.premultiplyAlpha,this.flipY=t.flipY,this.unpackAlignment=t.unpackAlignment,this.colorSpace=t.colorSpace,this.renderTarget=t.renderTarget,this.isRenderTargetTexture=t.isRenderTargetTexture,this.isArrayTexture=t.isArrayTexture,this.userData=JSON.parse(JSON.stringify(t.userData)),this.needsUpdate=!0,this}setValues(t){for(const e in t){const r=t[e];if(r===void 0){console.warn(`THREE.Texture.setValues(): parameter '${e}' has value of undefined.`);continue}const i=this[e];if(i===void 0){console.warn(`THREE.Texture.setValues(): property '${e}' does not exist.`);continue}i&&r&&i.isVector2&&r.isVector2||i&&r&&i.isVector3&&r.isVector3||i&&r&&i.isMatrix3&&r.isMatrix3?i.copy(r):this[e]=r}}toJSON(t){const e=t===void 0||typeof t=="string";if(!e&&t.textures[this.uuid]!==void 0)return t.textures[this.uuid];const r={metadata:{version:4.7,type:"Texture",generator:"Texture.toJSON"},uuid:this.uuid,name:this.name,image:this.source.toJSON(t).uuid,mapping:this.mapping,channel:this.channel,repeat:[this.repeat.x,this.repeat.y],offset:[this.offset.x,this.offset.y],center:[this.center.x,this.center.y],rotation:this.rotation,wrap:[this.wrapS,this.wrapT],format:this.format,internalFormat:this.internalFormat,type:this.type,colorSpace:this.colorSpace,minFilter:this.minFilter,magFilter:this.magFilter,anisotropy:this.anisotropy,flipY:this.flipY,generateMipmaps:this.generateMipmaps,premultiplyAlpha:this.premultiplyAlpha,unpackAlignment:this.unpackAlignment};return Object.keys(this.userData).length>0&&(r.userData=this.userData),e||(t.textures[this.uuid]=r),r}dispose(){this.dispatchEvent({type:"dispose"})}transformUv(t){if(this.mapping!==Ju)return t;if(t.applyMatrix3(this.matrix),t.x<0||t.x>1)switch(this.wrapS){case $h:t.x=t.x-Math.floor(t.x);break;case dn:t.x=t.x<0?0:1;break;case Jh:Math.abs(Math.floor(t.x)%2)===1?t.x=Math.ceil(t.x)-t.x:t.x=t.x-Math.floor(t.x);break}if(t.y<0||t.y>1)switch(this.wrapT){case $h:t.y=t.y-Math.floor(t.y);break;case dn:t.y=t.y<0?0:1;break;case Jh:Math.abs(Math.floor(t.y)%2)===1?t.y=Math.ceil(t.y)-t.y:t.y=t.y-Math.floor(t.y);break}return this.flipY&&(t.y=1-t.y),t}set needsUpdate(t){t===!0&&(this.version++,this.source.needsUpdate=!0)}set needsPMREMUpdate(t){t===!0&&this.pmremVersion++}}er.DEFAULT_IMAGE=null;er.DEFAULT_MAPPING=Ju;er.DEFAULT_ANISOTROPY=1;class tr{constructor(t=0,e=0,r=0,i=1){tr.prototype.isVector4=!0,this.x=t,this.y=e,this.z=r,this.w=i}get width(){return this.z}set width(t){this.z=t}get height(){return this.w}set height(t){this.w=t}set(t,e,r,i){return this.x=t,this.y=e,this.z=r,this.w=i,this}setScalar(t){return this.x=t,this.y=t,this.z=t,this.w=t,this}setX(t){return this.x=t,this}setY(t){return this.y=t,this}setZ(t){return this.z=t,this}setW(t){return this.w=t,this}setComponent(t,e){switch(t){case 0:this.x=e;break;case 1:this.y=e;break;case 2:this.z=e;break;case 3:this.w=e;break;default:throw new Error("index is out of range: "+t)}return this}getComponent(t){switch(t){case 0:return this.x;case 1:return this.y;case 2:return this.z;case 3:return this.w;default:throw new Error("index is out of range: "+t)}}clone(){return new this.constructor(this.x,this.y,this.z,this.w)}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w!==void 0?t.w:1,this}add(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this.w+=t.w,this}addScalar(t){return this.x+=t,this.y+=t,this.z+=t,this.w+=t,this}addVectors(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this.z=t.z+e.z,this.w=t.w+e.w,this}addScaledVector(t,e){return this.x+=t.x*e,this.y+=t.y*e,this.z+=t.z*e,this.w+=t.w*e,this}sub(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this.w-=t.w,this}subScalar(t){return this.x-=t,this.y-=t,this.z-=t,this.w-=t,this}subVectors(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this.z=t.z-e.z,this.w=t.w-e.w,this}multiply(t){return this.x*=t.x,this.y*=t.y,this.z*=t.z,this.w*=t.w,this}multiplyScalar(t){return this.x*=t,this.y*=t,this.z*=t,this.w*=t,this}applyMatrix4(t){const e=this.x,r=this.y,i=this.z,s=this.w,a=t.elements;return this.x=a[0]*e+a[4]*r+a[8]*i+a[12]*s,this.y=a[1]*e+a[5]*r+a[9]*i+a[13]*s,this.z=a[2]*e+a[6]*r+a[10]*i+a[14]*s,this.w=a[3]*e+a[7]*r+a[11]*i+a[15]*s,this}divide(t){return this.x/=t.x,this.y/=t.y,this.z/=t.z,this.w/=t.w,this}divideScalar(t){return this.multiplyScalar(1/t)}setAxisAngleFromQuaternion(t){this.w=2*Math.acos(t.w);const e=Math.sqrt(1-t.w*t.w);return e<1e-4?(this.x=1,this.y=0,this.z=0):(this.x=t.x/e,this.y=t.y/e,this.z=t.z/e),this}setAxisAngleFromRotationMatrix(t){let e,r,i,s;const c=t.elements,h=c[0],u=c[4],d=c[8],x=c[1],g=c[5],A=c[9],P=c[2],H=c[6],V=c[10];if(Math.abs(u-x)<.01&&Math.abs(d-P)<.01&&Math.abs(A-H)<.01){if(Math.abs(u+x)<.1&&Math.abs(d+P)<.1&&Math.abs(A+H)<.1&&Math.abs(h+g+V-3)<.1)return this.set(1,0,0,0),this;e=Math.PI;const tt=(h+1)/2,lt=(g+1)/2,wt=(V+1)/2,Et=(u+x)/4,Lt=(d+P)/4,Dt=(A+H)/4;return tt>lt&&tt>wt?tt<.01?(r=0,i=.707106781,s=.707106781):(r=Math.sqrt(tt),i=Et/r,s=Lt/r):lt>wt?lt<.01?(r=.707106781,i=0,s=.707106781):(i=Math.sqrt(lt),r=Et/i,s=Dt/i):wt<.01?(r=.707106781,i=.707106781,s=0):(s=Math.sqrt(wt),r=Lt/s,i=Dt/s),this.set(r,i,s,e),this}let At=Math.sqrt((H-A)*(H-A)+(d-P)*(d-P)+(x-u)*(x-u));return Math.abs(At)<.001&&(At=1),this.x=(H-A)/At,this.y=(d-P)/At,this.z=(x-u)/At,this.w=Math.acos((h+g+V-1)/2),this}setFromMatrixPosition(t){const e=t.elements;return this.x=e[12],this.y=e[13],this.z=e[14],this.w=e[15],this}min(t){return this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this.z=Math.min(this.z,t.z),this.w=Math.min(this.w,t.w),this}max(t){return this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this.z=Math.max(this.z,t.z),this.w=Math.max(this.w,t.w),this}clamp(t,e){return this.x=ae(this.x,t.x,e.x),this.y=ae(this.y,t.y,e.y),this.z=ae(this.z,t.z,e.z),this.w=ae(this.w,t.w,e.w),this}clampScalar(t,e){return this.x=ae(this.x,t,e),this.y=ae(this.y,t,e),this.z=ae(this.z,t,e),this.w=ae(this.w,t,e),this}clampLength(t,e){const r=this.length();return this.divideScalar(r||1).multiplyScalar(ae(r,t,e))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this.w=Math.floor(this.w),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this.w=Math.ceil(this.w),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this.w=Math.round(this.w),this}roundToZero(){return this.x=Math.trunc(this.x),this.y=Math.trunc(this.y),this.z=Math.trunc(this.z),this.w=Math.trunc(this.w),this}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this.w=-this.w,this}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z+this.w*t.w}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)+Math.abs(this.w)}normalize(){return this.divideScalar(this.length()||1)}setLength(t){return this.normalize().multiplyScalar(t)}lerp(t,e){return this.x+=(t.x-this.x)*e,this.y+=(t.y-this.y)*e,this.z+=(t.z-this.z)*e,this.w+=(t.w-this.w)*e,this}lerpVectors(t,e,r){return this.x=t.x+(e.x-t.x)*r,this.y=t.y+(e.y-t.y)*r,this.z=t.z+(e.z-t.z)*r,this.w=t.w+(e.w-t.w)*r,this}equals(t){return t.x===this.x&&t.y===this.y&&t.z===this.z&&t.w===this.w}fromArray(t,e=0){return this.x=t[e],this.y=t[e+1],this.z=t[e+2],this.w=t[e+3],this}toArray(t=[],e=0){return t[e]=this.x,t[e+1]=this.y,t[e+2]=this.z,t[e+3]=this.w,t}fromBufferAttribute(t,e){return this.x=t.getX(e),this.y=t.getY(e),this.z=t.getZ(e),this.w=t.getW(e),this}random(){return this.x=Math.random(),this.y=Math.random(),this.z=Math.random(),this.w=Math.random(),this}*[Symbol.iterator](){yield this.x,yield this.y,yield this.z,yield this.w}}class ay extends Jn{constructor(t=1,e=1,r={}){super(),r=Object.assign({generateMipmaps:!1,internalFormat:null,minFilter:ea,depthBuffer:!0,stencilBuffer:!1,resolveDepthBuffer:!0,resolveStencilBuffer:!0,depthTexture:null,samples:0,count:1,depth:1,multiview:!1},r),this.isRenderTarget=!0,this.width=t,this.height=e,this.depth=r.depth,this.scissor=new tr(0,0,t,e),this.scissorTest=!1,this.viewport=new tr(0,0,t,e);const i={width:t,height:e,depth:r.depth},s=new er(i);this.textures=[];const a=r.count;for(let o=0;o<a;o++)this.textures[o]=s.clone(),this.textures[o].isRenderTargetTexture=!0,this.textures[o].renderTarget=this;this._setTextureOptions(r),this.depthBuffer=r.depthBuffer,this.stencilBuffer=r.stencilBuffer,this.resolveDepthBuffer=r.resolveDepthBuffer,this.resolveStencilBuffer=r.resolveStencilBuffer,this._depthTexture=null,this.depthTexture=r.depthTexture,this.samples=r.samples,this.multiview=r.multiview}_setTextureOptions(t={}){const e={minFilter:ea,generateMipmaps:!1,flipY:!1,internalFormat:null};t.mapping!==void 0&&(e.mapping=t.mapping),t.wrapS!==void 0&&(e.wrapS=t.wrapS),t.wrapT!==void 0&&(e.wrapT=t.wrapT),t.wrapR!==void 0&&(e.wrapR=t.wrapR),t.magFilter!==void 0&&(e.magFilter=t.magFilter),t.minFilter!==void 0&&(e.minFilter=t.minFilter),t.format!==void 0&&(e.format=t.format),t.type!==void 0&&(e.type=t.type),t.anisotropy!==void 0&&(e.anisotropy=t.anisotropy),t.colorSpace!==void 0&&(e.colorSpace=t.colorSpace),t.flipY!==void 0&&(e.flipY=t.flipY),t.generateMipmaps!==void 0&&(e.generateMipmaps=t.generateMipmaps),t.internalFormat!==void 0&&(e.internalFormat=t.internalFormat);for(let r=0;r<this.textures.length;r++)this.textures[r].setValues(e)}get texture(){return this.textures[0]}set texture(t){this.textures[0]=t}set depthTexture(t){this._depthTexture!==null&&(this._depthTexture.renderTarget=null),t!==null&&(t.renderTarget=this),this._depthTexture=t}get depthTexture(){return this._depthTexture}setSize(t,e,r=1){if(this.width!==t||this.height!==e||this.depth!==r){this.width=t,this.height=e,this.depth=r;for(let i=0,s=this.textures.length;i<s;i++)this.textures[i].image.width=t,this.textures[i].image.height=e,this.textures[i].image.depth=r,this.textures[i].isArrayTexture=this.textures[i].image.depth>1;this.dispose()}this.viewport.set(0,0,t,e),this.scissor.set(0,0,t,e)}clone(){return new this.constructor().copy(this)}copy(t){this.width=t.width,this.height=t.height,this.depth=t.depth,this.scissor.copy(t.scissor),this.scissorTest=t.scissorTest,this.viewport.copy(t.viewport),this.textures.length=0;for(let e=0,r=t.textures.length;e<r;e++){this.textures[e]=t.textures[e].clone(),this.textures[e].isRenderTargetTexture=!0,this.textures[e].renderTarget=this;const i=Object.assign({},t.textures[e].image);this.textures[e].source=new jo(i)}return this.depthBuffer=t.depthBuffer,this.stencilBuffer=t.stencilBuffer,this.resolveDepthBuffer=t.resolveDepthBuffer,this.resolveStencilBuffer=t.resolveStencilBuffer,t.depthTexture!==null&&(this.depthTexture=t.depthTexture.clone()),this.samples=t.samples,this}dispose(){this.dispatchEvent({type:"dispose"})}}class oy extends ay{constructor(t=1,e=1,r={}){super(t,e,r),this.isWebGLRenderTarget=!0}}class x_ extends er{constructor(t=null,e=1,r=1,i=1){super(null),this.isDataArrayTexture=!0,this.image={data:t,width:e,height:r,depth:i},this.magFilter=oi,this.minFilter=oi,this.wrapR=dn,this.generateMipmaps=!1,this.flipY=!1,this.unpackAlignment=1,this.layerUpdates=new Set}addLayerUpdate(t){this.layerUpdates.add(t)}clearLayerUpdates(){this.layerUpdates.clear()}}class g_ extends er{constructor(t=null,e=1,r=1,i=1){super(null),this.isData3DTexture=!0,this.image={data:t,width:e,height:r,depth:i},this.magFilter=oi,this.minFilter=oi,this.wrapR=dn,this.generateMipmaps=!1,this.flipY=!1,this.unpackAlignment=1}}class Ci{constructor(t=new L(1/0,1/0,1/0),e=new L(-1/0,-1/0,-1/0)){this.isBox3=!0,this.min=t,this.max=e}set(t,e){return this.min.copy(t),this.max.copy(e),this}setFromArray(t){this.makeEmpty();for(let e=0,r=t.length;e<r;e+=3)this.expandByPoint(yr.fromArray(t,e));return this}setFromBufferAttribute(t){this.makeEmpty();for(let e=0,r=t.count;e<r;e++)this.expandByPoint(yr.fromBufferAttribute(t,e));return this}setFromPoints(t){this.makeEmpty();for(let e=0,r=t.length;e<r;e++)this.expandByPoint(t[e]);return this}setFromCenterAndSize(t,e){const r=yr.copy(e).multiplyScalar(.5);return this.min.copy(t).sub(r),this.max.copy(t).add(r),this}setFromObject(t,e=!1){return this.makeEmpty(),this.expandByObject(t,e)}clone(){return new this.constructor().copy(this)}copy(t){return this.min.copy(t.min),this.max.copy(t.max),this}makeEmpty(){return this.min.x=this.min.y=this.min.z=1/0,this.max.x=this.max.y=this.max.z=-1/0,this}isEmpty(){return this.max.x<this.min.x||this.max.y<this.min.y||this.max.z<this.min.z}getCenter(t){return this.isEmpty()?t.set(0,0,0):t.addVectors(this.min,this.max).multiplyScalar(.5)}getSize(t){return this.isEmpty()?t.set(0,0,0):t.subVectors(this.max,this.min)}expandByPoint(t){return this.min.min(t),this.max.max(t),this}expandByVector(t){return this.min.sub(t),this.max.add(t),this}expandByScalar(t){return this.min.addScalar(-t),this.max.addScalar(t),this}expandByObject(t,e=!1){t.updateWorldMatrix(!1,!1);const r=t.geometry;if(r!==void 0){const s=r.getAttribute("position");if(e===!0&&s!==void 0&&t.isInstancedMesh!==!0)for(let a=0,o=s.count;a<o;a++)t.isMesh===!0?t.getVertexPosition(a,yr):yr.fromBufferAttribute(s,a),yr.applyMatrix4(t.matrixWorld),this.expandByPoint(yr);else t.boundingBox!==void 0?(t.boundingBox===null&&t.computeBoundingBox(),Ms.copy(t.boundingBox)):(r.boundingBox===null&&r.computeBoundingBox(),Ms.copy(r.boundingBox)),Ms.applyMatrix4(t.matrixWorld),this.union(Ms)}const i=t.children;for(let s=0,a=i.length;s<a;s++)this.expandByObject(i[s],e);return this}containsPoint(t){return t.x>=this.min.x&&t.x<=this.max.x&&t.y>=this.min.y&&t.y<=this.max.y&&t.z>=this.min.z&&t.z<=this.max.z}containsBox(t){return this.min.x<=t.min.x&&t.max.x<=this.max.x&&this.min.y<=t.min.y&&t.max.y<=this.max.y&&this.min.z<=t.min.z&&t.max.z<=this.max.z}getParameter(t,e){return e.set((t.x-this.min.x)/(this.max.x-this.min.x),(t.y-this.min.y)/(this.max.y-this.min.y),(t.z-this.min.z)/(this.max.z-this.min.z))}intersectsBox(t){return t.max.x>=this.min.x&&t.min.x<=this.max.x&&t.max.y>=this.min.y&&t.min.y<=this.max.y&&t.max.z>=this.min.z&&t.min.z<=this.max.z}intersectsSphere(t){return this.clampPoint(t.center,yr),yr.distanceToSquared(t.center)<=t.radius*t.radius}intersectsPlane(t){let e,r;return t.normal.x>0?(e=t.normal.x*this.min.x,r=t.normal.x*this.max.x):(e=t.normal.x*this.max.x,r=t.normal.x*this.min.x),t.normal.y>0?(e+=t.normal.y*this.min.y,r+=t.normal.y*this.max.y):(e+=t.normal.y*this.max.y,r+=t.normal.y*this.min.y),t.normal.z>0?(e+=t.normal.z*this.min.z,r+=t.normal.z*this.max.z):(e+=t.normal.z*this.max.z,r+=t.normal.z*this.min.z),e<=-t.constant&&r>=-t.constant}intersectsTriangle(t){if(this.isEmpty())return!1;this.getCenter(Fn),Cs.subVectors(this.max,Fn),Ji.subVectors(t.a,Fn),qi.subVectors(t.b,Fn),Zi.subVectors(t.c,Fn),Kr.subVectors(qi,Ji),Qr.subVectors(Zi,qi),Ei.subVectors(Ji,Zi);let e=[0,-Kr.z,Kr.y,0,-Qr.z,Qr.y,0,-Ei.z,Ei.y,Kr.z,0,-Kr.x,Qr.z,0,-Qr.x,Ei.z,0,-Ei.x,-Kr.y,Kr.x,0,-Qr.y,Qr.x,0,-Ei.y,Ei.x,0];return!ho(e,Ji,qi,Zi,Cs)||(e=[1,0,0,0,1,0,0,0,1],!ho(e,Ji,qi,Zi,Cs))?!1:(Is.crossVectors(Kr,Qr),e=[Is.x,Is.y,Is.z],ho(e,Ji,qi,Zi,Cs))}clampPoint(t,e){return e.copy(t).clamp(this.min,this.max)}distanceToPoint(t){return this.clampPoint(t,yr).distanceTo(t)}getBoundingSphere(t){return this.isEmpty()?t.makeEmpty():(this.getCenter(t.center),t.radius=this.getSize(yr).length()*.5),t}intersect(t){return this.min.max(t.min),this.max.min(t.max),this.isEmpty()&&this.makeEmpty(),this}union(t){return this.min.min(t.min),this.max.max(t.max),this}applyMatrix4(t){return this.isEmpty()?this:(Dr[0].set(this.min.x,this.min.y,this.min.z).applyMatrix4(t),Dr[1].set(this.min.x,this.min.y,this.max.z).applyMatrix4(t),Dr[2].set(this.min.x,this.max.y,this.min.z).applyMatrix4(t),Dr[3].set(this.min.x,this.max.y,this.max.z).applyMatrix4(t),Dr[4].set(this.max.x,this.min.y,this.min.z).applyMatrix4(t),Dr[5].set(this.max.x,this.min.y,this.max.z).applyMatrix4(t),Dr[6].set(this.max.x,this.max.y,this.min.z).applyMatrix4(t),Dr[7].set(this.max.x,this.max.y,this.max.z).applyMatrix4(t),this.setFromPoints(Dr),this)}translate(t){return this.min.add(t),this.max.add(t),this}equals(t){return t.min.equals(this.min)&&t.max.equals(this.max)}toJSON(){return{min:this.min.toArray(),max:this.max.toArray()}}fromJSON(t){return this.min.fromArray(t.min),this.max.fromArray(t.max),this}}const Dr=[new L,new L,new L,new L,new L,new L,new L,new L],yr=new L,Ms=new Ci,Ji=new L,qi=new L,Zi=new L,Kr=new L,Qr=new L,Ei=new L,Fn=new L,Cs=new L,Is=new L,Ai=new L;function ho(n,t,e,r,i){for(let s=0,a=n.length-3;s<=a;s+=3){Ai.fromArray(n,s);const o=i.x*Math.abs(Ai.x)+i.y*Math.abs(Ai.y)+i.z*Math.abs(Ai.z),c=t.dot(Ai),h=e.dot(Ai),u=r.dot(Ai);if(Math.max(-Math.max(c,h,u),Math.min(c,h,u))>o)return!1}return!0}const ly=new Ci,Pn=new L,uo=new L;class Ii{constructor(t=new L,e=-1){this.isSphere=!0,this.center=t,this.radius=e}set(t,e){return this.center.copy(t),this.radius=e,this}setFromPoints(t,e){const r=this.center;e!==void 0?r.copy(e):ly.setFromPoints(t).getCenter(r);let i=0;for(let s=0,a=t.length;s<a;s++)i=Math.max(i,r.distanceToSquared(t[s]));return this.radius=Math.sqrt(i),this}copy(t){return this.center.copy(t.center),this.radius=t.radius,this}isEmpty(){return this.radius<0}makeEmpty(){return this.center.set(0,0,0),this.radius=-1,this}containsPoint(t){return t.distanceToSquared(this.center)<=this.radius*this.radius}distanceToPoint(t){return t.distanceTo(this.center)-this.radius}intersectsSphere(t){const e=this.radius+t.radius;return t.center.distanceToSquared(this.center)<=e*e}intersectsBox(t){return t.intersectsSphere(this)}intersectsPlane(t){return Math.abs(t.distanceToPoint(this.center))<=this.radius}clampPoint(t,e){const r=this.center.distanceToSquared(t);return e.copy(t),r>this.radius*this.radius&&(e.sub(this.center).normalize(),e.multiplyScalar(this.radius).add(this.center)),e}getBoundingBox(t){return this.isEmpty()?(t.makeEmpty(),t):(t.set(this.center,this.center),t.expandByScalar(this.radius),t)}applyMatrix4(t){return this.center.applyMatrix4(t),this.radius=this.radius*t.getMaxScaleOnAxis(),this}translate(t){return this.center.add(t),this}expandByPoint(t){if(this.isEmpty())return this.center.copy(t),this.radius=0,this;Pn.subVectors(t,this.center);const e=Pn.lengthSq();if(e>this.radius*this.radius){const r=Math.sqrt(e),i=(r-this.radius)*.5;this.center.addScaledVector(Pn,i/r),this.radius+=i}return this}union(t){return t.isEmpty()?this:this.isEmpty()?(this.copy(t),this):(this.center.equals(t.center)===!0?this.radius=Math.max(this.radius,t.radius):(uo.subVectors(t.center,this.center).setLength(t.radius),this.expandByPoint(Pn.copy(t.center).add(uo)),this.expandByPoint(Pn.copy(t.center).sub(uo))),this)}equals(t){return t.center.equals(this.center)&&t.radius===this.radius}clone(){return new this.constructor().copy(this)}toJSON(){return{radius:this.radius,center:this.center.toArray()}}fromJSON(t){return this.radius=t.radius,this.center.fromArray(t.center),this}}const Fr=new L,fo=new L,Rs=new L,ti=new L,mo=new L,Os=new L,po=new L;class Ho{constructor(t=new L,e=new L(0,0,-1)){this.origin=t,this.direction=e}set(t,e){return this.origin.copy(t),this.direction.copy(e),this}copy(t){return this.origin.copy(t.origin),this.direction.copy(t.direction),this}at(t,e){return e.copy(this.origin).addScaledVector(this.direction,t)}lookAt(t){return this.direction.copy(t).sub(this.origin).normalize(),this}recast(t){return this.origin.copy(this.at(t,Fr)),this}closestPointToPoint(t,e){e.subVectors(t,this.origin);const r=e.dot(this.direction);return r<0?e.copy(this.origin):e.copy(this.origin).addScaledVector(this.direction,r)}distanceToPoint(t){return Math.sqrt(this.distanceSqToPoint(t))}distanceSqToPoint(t){const e=Fr.subVectors(t,this.origin).dot(this.direction);return e<0?this.origin.distanceToSquared(t):(Fr.copy(this.origin).addScaledVector(this.direction,e),Fr.distanceToSquared(t))}distanceSqToSegment(t,e,r,i){fo.copy(t).add(e).multiplyScalar(.5),Rs.copy(e).sub(t).normalize(),ti.copy(this.origin).sub(fo);const s=t.distanceTo(e)*.5,a=-this.direction.dot(Rs),o=ti.dot(this.direction),c=-ti.dot(Rs),h=ti.lengthSq(),u=Math.abs(1-a*a);let d,x,g,A;if(u>0)if(d=a*c-o,x=a*o-c,A=s*u,d>=0)if(x>=-A)if(x<=A){const P=1/u;d*=P,x*=P,g=d*(d+a*x+2*o)+x*(a*d+x+2*c)+h}else x=s,d=Math.max(0,-(a*x+o)),g=-d*d+x*(x+2*c)+h;else x=-s,d=Math.max(0,-(a*x+o)),g=-d*d+x*(x+2*c)+h;else x<=-A?(d=Math.max(0,-(-a*s+o)),x=d>0?-s:Math.min(Math.max(-s,-c),s),g=-d*d+x*(x+2*c)+h):x<=A?(d=0,x=Math.min(Math.max(-s,-c),s),g=x*(x+2*c)+h):(d=Math.max(0,-(a*s+o)),x=d>0?s:Math.min(Math.max(-s,-c),s),g=-d*d+x*(x+2*c)+h);else x=a>0?-s:s,d=Math.max(0,-(a*x+o)),g=-d*d+x*(x+2*c)+h;return r&&r.copy(this.origin).addScaledVector(this.direction,d),i&&i.copy(fo).addScaledVector(Rs,x),g}intersectSphere(t,e){Fr.subVectors(t.center,this.origin);const r=Fr.dot(this.direction),i=Fr.dot(Fr)-r*r,s=t.radius*t.radius;if(i>s)return null;const a=Math.sqrt(s-i),o=r-a,c=r+a;return c<0?null:o<0?this.at(c,e):this.at(o,e)}intersectsSphere(t){return t.radius<0?!1:this.distanceSqToPoint(t.center)<=t.radius*t.radius}distanceToPlane(t){const e=t.normal.dot(this.direction);if(e===0)return t.distanceToPoint(this.origin)===0?0:null;const r=-(this.origin.dot(t.normal)+t.constant)/e;return r>=0?r:null}intersectPlane(t,e){const r=this.distanceToPlane(t);return r===null?null:this.at(r,e)}intersectsPlane(t){const e=t.distanceToPoint(this.origin);return e===0||t.normal.dot(this.direction)*e<0}intersectBox(t,e){let r,i,s,a,o,c;const h=1/this.direction.x,u=1/this.direction.y,d=1/this.direction.z,x=this.origin;return h>=0?(r=(t.min.x-x.x)*h,i=(t.max.x-x.x)*h):(r=(t.max.x-x.x)*h,i=(t.min.x-x.x)*h),u>=0?(s=(t.min.y-x.y)*u,a=(t.max.y-x.y)*u):(s=(t.max.y-x.y)*u,a=(t.min.y-x.y)*u),r>a||s>i||((s>r||isNaN(r))&&(r=s),(a<i||isNaN(i))&&(i=a),d>=0?(o=(t.min.z-x.z)*d,c=(t.max.z-x.z)*d):(o=(t.max.z-x.z)*d,c=(t.min.z-x.z)*d),r>c||o>i)||((o>r||r!==r)&&(r=o),(c<i||i!==i)&&(i=c),i<0)?null:this.at(r>=0?r:i,e)}intersectsBox(t){return this.intersectBox(t,Fr)!==null}intersectTriangle(t,e,r,i,s){mo.subVectors(e,t),Os.subVectors(r,t),po.crossVectors(mo,Os);let a=this.direction.dot(po),o;if(a>0){if(i)return null;o=1}else if(a<0)o=-1,a=-a;else return null;ti.subVectors(this.origin,t);const c=o*this.direction.dot(Os.crossVectors(ti,Os));if(c<0)return null;const h=o*this.direction.dot(mo.cross(ti));if(h<0||c+h>a)return null;const u=-o*ti.dot(po);return u<0?null:this.at(u/a,s)}applyMatrix4(t){return this.origin.applyMatrix4(t),this.direction.transformDirection(t),this}equals(t){return t.origin.equals(this.origin)&&t.direction.equals(this.direction)}clone(){return new this.constructor().copy(this)}}class we{constructor(t,e,r,i,s,a,o,c,h,u,d,x,g,A,P,H){we.prototype.isMatrix4=!0,this.elements=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],t!==void 0&&this.set(t,e,r,i,s,a,o,c,h,u,d,x,g,A,P,H)}set(t,e,r,i,s,a,o,c,h,u,d,x,g,A,P,H){const V=this.elements;return V[0]=t,V[4]=e,V[8]=r,V[12]=i,V[1]=s,V[5]=a,V[9]=o,V[13]=c,V[2]=h,V[6]=u,V[10]=d,V[14]=x,V[3]=g,V[7]=A,V[11]=P,V[15]=H,this}identity(){return this.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this}clone(){return new we().fromArray(this.elements)}copy(t){const e=this.elements,r=t.elements;return e[0]=r[0],e[1]=r[1],e[2]=r[2],e[3]=r[3],e[4]=r[4],e[5]=r[5],e[6]=r[6],e[7]=r[7],e[8]=r[8],e[9]=r[9],e[10]=r[10],e[11]=r[11],e[12]=r[12],e[13]=r[13],e[14]=r[14],e[15]=r[15],this}copyPosition(t){const e=this.elements,r=t.elements;return e[12]=r[12],e[13]=r[13],e[14]=r[14],this}setFromMatrix3(t){const e=t.elements;return this.set(e[0],e[3],e[6],0,e[1],e[4],e[7],0,e[2],e[5],e[8],0,0,0,0,1),this}extractBasis(t,e,r){return t.setFromMatrixColumn(this,0),e.setFromMatrixColumn(this,1),r.setFromMatrixColumn(this,2),this}makeBasis(t,e,r){return this.set(t.x,e.x,r.x,0,t.y,e.y,r.y,0,t.z,e.z,r.z,0,0,0,0,1),this}extractRotation(t){const e=this.elements,r=t.elements,i=1/Ki.setFromMatrixColumn(t,0).length(),s=1/Ki.setFromMatrixColumn(t,1).length(),a=1/Ki.setFromMatrixColumn(t,2).length();return e[0]=r[0]*i,e[1]=r[1]*i,e[2]=r[2]*i,e[3]=0,e[4]=r[4]*s,e[5]=r[5]*s,e[6]=r[6]*s,e[7]=0,e[8]=r[8]*a,e[9]=r[9]*a,e[10]=r[10]*a,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,this}makeRotationFromEuler(t){const e=this.elements,r=t.x,i=t.y,s=t.z,a=Math.cos(r),o=Math.sin(r),c=Math.cos(i),h=Math.sin(i),u=Math.cos(s),d=Math.sin(s);if(t.order==="XYZ"){const x=a*u,g=a*d,A=o*u,P=o*d;e[0]=c*u,e[4]=-c*d,e[8]=h,e[1]=g+A*h,e[5]=x-P*h,e[9]=-o*c,e[2]=P-x*h,e[6]=A+g*h,e[10]=a*c}else if(t.order==="YXZ"){const x=c*u,g=c*d,A=h*u,P=h*d;e[0]=x+P*o,e[4]=A*o-g,e[8]=a*h,e[1]=a*d,e[5]=a*u,e[9]=-o,e[2]=g*o-A,e[6]=P+x*o,e[10]=a*c}else if(t.order==="ZXY"){const x=c*u,g=c*d,A=h*u,P=h*d;e[0]=x-P*o,e[4]=-a*d,e[8]=A+g*o,e[1]=g+A*o,e[5]=a*u,e[9]=P-x*o,e[2]=-a*h,e[6]=o,e[10]=a*c}else if(t.order==="ZYX"){const x=a*u,g=a*d,A=o*u,P=o*d;e[0]=c*u,e[4]=A*h-g,e[8]=x*h+P,e[1]=c*d,e[5]=P*h+x,e[9]=g*h-A,e[2]=-h,e[6]=o*c,e[10]=a*c}else if(t.order==="YZX"){const x=a*c,g=a*h,A=o*c,P=o*h;e[0]=c*u,e[4]=P-x*d,e[8]=A*d+g,e[1]=d,e[5]=a*u,e[9]=-o*u,e[2]=-h*u,e[6]=g*d+A,e[10]=x-P*d}else if(t.order==="XZY"){const x=a*c,g=a*h,A=o*c,P=o*h;e[0]=c*u,e[4]=-d,e[8]=h*u,e[1]=x*d+P,e[5]=a*u,e[9]=g*d-A,e[2]=A*d-g,e[6]=o*u,e[10]=P*d+x}return e[3]=0,e[7]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,this}makeRotationFromQuaternion(t){return this.compose(cy,t,hy)}lookAt(t,e,r){const i=this.elements;return sr.subVectors(t,e),sr.lengthSq()===0&&(sr.z=1),sr.normalize(),ei.crossVectors(r,sr),ei.lengthSq()===0&&(Math.abs(r.z)===1?sr.x+=1e-4:sr.z+=1e-4,sr.normalize(),ei.crossVectors(r,sr)),ei.normalize(),Ns.crossVectors(sr,ei),i[0]=ei.x,i[4]=Ns.x,i[8]=sr.x,i[1]=ei.y,i[5]=Ns.y,i[9]=sr.y,i[2]=ei.z,i[6]=Ns.z,i[10]=sr.z,this}multiply(t){return this.multiplyMatrices(this,t)}premultiply(t){return this.multiplyMatrices(t,this)}multiplyMatrices(t,e){const r=t.elements,i=e.elements,s=this.elements,a=r[0],o=r[4],c=r[8],h=r[12],u=r[1],d=r[5],x=r[9],g=r[13],A=r[2],P=r[6],H=r[10],V=r[14],At=r[3],tt=r[7],lt=r[11],wt=r[15],Et=i[0],Lt=i[4],Dt=i[8],Wt=i[12],se=i[1],ce=i[5],kt=i[9],jt=i[13],ee=i[2],Xt=i[6],$t=i[10],de=i[14],me=i[3],Kt=i[7],re=i[11],ye=i[15];return s[0]=a*Et+o*se+c*ee+h*me,s[4]=a*Lt+o*ce+c*Xt+h*Kt,s[8]=a*Dt+o*kt+c*$t+h*re,s[12]=a*Wt+o*jt+c*de+h*ye,s[1]=u*Et+d*se+x*ee+g*me,s[5]=u*Lt+d*ce+x*Xt+g*Kt,s[9]=u*Dt+d*kt+x*$t+g*re,s[13]=u*Wt+d*jt+x*de+g*ye,s[2]=A*Et+P*se+H*ee+V*me,s[6]=A*Lt+P*ce+H*Xt+V*Kt,s[10]=A*Dt+P*kt+H*$t+V*re,s[14]=A*Wt+P*jt+H*de+V*ye,s[3]=At*Et+tt*se+lt*ee+wt*me,s[7]=At*Lt+tt*ce+lt*Xt+wt*Kt,s[11]=At*Dt+tt*kt+lt*$t+wt*re,s[15]=At*Wt+tt*jt+lt*de+wt*ye,this}multiplyScalar(t){const e=this.elements;return e[0]*=t,e[4]*=t,e[8]*=t,e[12]*=t,e[1]*=t,e[5]*=t,e[9]*=t,e[13]*=t,e[2]*=t,e[6]*=t,e[10]*=t,e[14]*=t,e[3]*=t,e[7]*=t,e[11]*=t,e[15]*=t,this}determinant(){const t=this.elements,e=t[0],r=t[4],i=t[8],s=t[12],a=t[1],o=t[5],c=t[9],h=t[13],u=t[2],d=t[6],x=t[10],g=t[14],A=t[3],P=t[7],H=t[11],V=t[15];return A*(+s*c*d-i*h*d-s*o*x+r*h*x+i*o*g-r*c*g)+P*(+e*c*g-e*h*x+s*a*x-i*a*g+i*h*u-s*c*u)+H*(+e*h*d-e*o*g-s*a*d+r*a*g+s*o*u-r*h*u)+V*(-i*o*u-e*c*d+e*o*x+i*a*d-r*a*x+r*c*u)}transpose(){const t=this.elements;let e;return e=t[1],t[1]=t[4],t[4]=e,e=t[2],t[2]=t[8],t[8]=e,e=t[6],t[6]=t[9],t[9]=e,e=t[3],t[3]=t[12],t[12]=e,e=t[7],t[7]=t[13],t[13]=e,e=t[11],t[11]=t[14],t[14]=e,this}setPosition(t,e,r){const i=this.elements;return t.isVector3?(i[12]=t.x,i[13]=t.y,i[14]=t.z):(i[12]=t,i[13]=e,i[14]=r),this}invert(){const t=this.elements,e=t[0],r=t[1],i=t[2],s=t[3],a=t[4],o=t[5],c=t[6],h=t[7],u=t[8],d=t[9],x=t[10],g=t[11],A=t[12],P=t[13],H=t[14],V=t[15],At=d*H*h-P*x*h+P*c*g-o*H*g-d*c*V+o*x*V,tt=A*x*h-u*H*h-A*c*g+a*H*g+u*c*V-a*x*V,lt=u*P*h-A*d*h+A*o*g-a*P*g-u*o*V+a*d*V,wt=A*d*c-u*P*c-A*o*x+a*P*x+u*o*H-a*d*H,Et=e*At+r*tt+i*lt+s*wt;if(Et===0)return this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);const Lt=1/Et;return t[0]=At*Lt,t[1]=(P*x*s-d*H*s-P*i*g+r*H*g+d*i*V-r*x*V)*Lt,t[2]=(o*H*s-P*c*s+P*i*h-r*H*h-o*i*V+r*c*V)*Lt,t[3]=(d*c*s-o*x*s-d*i*h+r*x*h+o*i*g-r*c*g)*Lt,t[4]=tt*Lt,t[5]=(u*H*s-A*x*s+A*i*g-e*H*g-u*i*V+e*x*V)*Lt,t[6]=(A*c*s-a*H*s-A*i*h+e*H*h+a*i*V-e*c*V)*Lt,t[7]=(a*x*s-u*c*s+u*i*h-e*x*h-a*i*g+e*c*g)*Lt,t[8]=lt*Lt,t[9]=(A*d*s-u*P*s-A*r*g+e*P*g+u*r*V-e*d*V)*Lt,t[10]=(a*P*s-A*o*s+A*r*h-e*P*h-a*r*V+e*o*V)*Lt,t[11]=(u*o*s-a*d*s-u*r*h+e*d*h+a*r*g-e*o*g)*Lt,t[12]=wt*Lt,t[13]=(u*P*i-A*d*i+A*r*x-e*P*x-u*r*H+e*d*H)*Lt,t[14]=(A*o*i-a*P*i-A*r*c+e*P*c+a*r*H-e*o*H)*Lt,t[15]=(a*d*i-u*o*i+u*r*c-e*d*c-a*r*x+e*o*x)*Lt,this}scale(t){const e=this.elements,r=t.x,i=t.y,s=t.z;return e[0]*=r,e[4]*=i,e[8]*=s,e[1]*=r,e[5]*=i,e[9]*=s,e[2]*=r,e[6]*=i,e[10]*=s,e[3]*=r,e[7]*=i,e[11]*=s,this}getMaxScaleOnAxis(){const t=this.elements,e=t[0]*t[0]+t[1]*t[1]+t[2]*t[2],r=t[4]*t[4]+t[5]*t[5]+t[6]*t[6],i=t[8]*t[8]+t[9]*t[9]+t[10]*t[10];return Math.sqrt(Math.max(e,r,i))}makeTranslation(t,e,r){return t.isVector3?this.set(1,0,0,t.x,0,1,0,t.y,0,0,1,t.z,0,0,0,1):this.set(1,0,0,t,0,1,0,e,0,0,1,r,0,0,0,1),this}makeRotationX(t){const e=Math.cos(t),r=Math.sin(t);return this.set(1,0,0,0,0,e,-r,0,0,r,e,0,0,0,0,1),this}makeRotationY(t){const e=Math.cos(t),r=Math.sin(t);return this.set(e,0,r,0,0,1,0,0,-r,0,e,0,0,0,0,1),this}makeRotationZ(t){const e=Math.cos(t),r=Math.sin(t);return this.set(e,-r,0,0,r,e,0,0,0,0,1,0,0,0,0,1),this}makeRotationAxis(t,e){const r=Math.cos(e),i=Math.sin(e),s=1-r,a=t.x,o=t.y,c=t.z,h=s*a,u=s*o;return this.set(h*a+r,h*o-i*c,h*c+i*o,0,h*o+i*c,u*o+r,u*c-i*a,0,h*c-i*o,u*c+i*a,s*c*c+r,0,0,0,0,1),this}makeScale(t,e,r){return this.set(t,0,0,0,0,e,0,0,0,0,r,0,0,0,0,1),this}makeShear(t,e,r,i,s,a){return this.set(1,r,s,0,t,1,a,0,e,i,1,0,0,0,0,1),this}compose(t,e,r){const i=this.elements,s=e._x,a=e._y,o=e._z,c=e._w,h=s+s,u=a+a,d=o+o,x=s*h,g=s*u,A=s*d,P=a*u,H=a*d,V=o*d,At=c*h,tt=c*u,lt=c*d,wt=r.x,Et=r.y,Lt=r.z;return i[0]=(1-(P+V))*wt,i[1]=(g+lt)*wt,i[2]=(A-tt)*wt,i[3]=0,i[4]=(g-lt)*Et,i[5]=(1-(x+V))*Et,i[6]=(H+At)*Et,i[7]=0,i[8]=(A+tt)*Lt,i[9]=(H-At)*Lt,i[10]=(1-(x+P))*Lt,i[11]=0,i[12]=t.x,i[13]=t.y,i[14]=t.z,i[15]=1,this}decompose(t,e,r){const i=this.elements;let s=Ki.set(i[0],i[1],i[2]).length();const a=Ki.set(i[4],i[5],i[6]).length(),o=Ki.set(i[8],i[9],i[10]).length();this.determinant()<0&&(s=-s),t.x=i[12],t.y=i[13],t.z=i[14],xr.copy(this);const h=1/s,u=1/a,d=1/o;return xr.elements[0]*=h,xr.elements[1]*=h,xr.elements[2]*=h,xr.elements[4]*=u,xr.elements[5]*=u,xr.elements[6]*=u,xr.elements[8]*=d,xr.elements[9]*=d,xr.elements[10]*=d,e.setFromRotationMatrix(xr),r.x=s,r.y=a,r.z=o,this}makePerspective(t,e,r,i,s,a,o=si){const c=this.elements,h=2*s/(e-t),u=2*s/(r-i),d=(e+t)/(e-t),x=(r+i)/(r-i);let g,A;if(o===si)g=-(a+s)/(a-s),A=-2*a*s/(a-s);else if(o===ra)g=-a/(a-s),A=-a*s/(a-s);else throw new Error("THREE.Matrix4.makePerspective(): Invalid coordinate system: "+o);return c[0]=h,c[4]=0,c[8]=d,c[12]=0,c[1]=0,c[5]=u,c[9]=x,c[13]=0,c[2]=0,c[6]=0,c[10]=g,c[14]=A,c[3]=0,c[7]=0,c[11]=-1,c[15]=0,this}makeOrthographic(t,e,r,i,s,a,o=si){const c=this.elements,h=1/(e-t),u=1/(r-i),d=1/(a-s),x=(e+t)*h,g=(r+i)*u;let A,P;if(o===si)A=(a+s)*d,P=-2*d;else if(o===ra)A=s*d,P=-1*d;else throw new Error("THREE.Matrix4.makeOrthographic(): Invalid coordinate system: "+o);return c[0]=2*h,c[4]=0,c[8]=0,c[12]=-x,c[1]=0,c[5]=2*u,c[9]=0,c[13]=-g,c[2]=0,c[6]=0,c[10]=P,c[14]=-A,c[3]=0,c[7]=0,c[11]=0,c[15]=1,this}equals(t){const e=this.elements,r=t.elements;for(let i=0;i<16;i++)if(e[i]!==r[i])return!1;return!0}fromArray(t,e=0){for(let r=0;r<16;r++)this.elements[r]=t[r+e];return this}toArray(t=[],e=0){const r=this.elements;return t[e]=r[0],t[e+1]=r[1],t[e+2]=r[2],t[e+3]=r[3],t[e+4]=r[4],t[e+5]=r[5],t[e+6]=r[6],t[e+7]=r[7],t[e+8]=r[8],t[e+9]=r[9],t[e+10]=r[10],t[e+11]=r[11],t[e+12]=r[12],t[e+13]=r[13],t[e+14]=r[14],t[e+15]=r[15],t}}const Ki=new L,xr=new we,cy=new L(0,0,0),hy=new L(1,1,1),ei=new L,Ns=new L,sr=new L,ou=new we,lu=new qn;class li{constructor(t=0,e=0,r=0,i=li.DEFAULT_ORDER){this.isEuler=!0,this._x=t,this._y=e,this._z=r,this._order=i}get x(){return this._x}set x(t){this._x=t,this._onChangeCallback()}get y(){return this._y}set y(t){this._y=t,this._onChangeCallback()}get z(){return this._z}set z(t){this._z=t,this._onChangeCallback()}get order(){return this._order}set order(t){this._order=t,this._onChangeCallback()}set(t,e,r,i=this._order){return this._x=t,this._y=e,this._z=r,this._order=i,this._onChangeCallback(),this}clone(){return new this.constructor(this._x,this._y,this._z,this._order)}copy(t){return this._x=t._x,this._y=t._y,this._z=t._z,this._order=t._order,this._onChangeCallback(),this}setFromRotationMatrix(t,e=this._order,r=!0){const i=t.elements,s=i[0],a=i[4],o=i[8],c=i[1],h=i[5],u=i[9],d=i[2],x=i[6],g=i[10];switch(e){case"XYZ":this._y=Math.asin(ae(o,-1,1)),Math.abs(o)<.9999999?(this._x=Math.atan2(-u,g),this._z=Math.atan2(-a,s)):(this._x=Math.atan2(x,h),this._z=0);break;case"YXZ":this._x=Math.asin(-ae(u,-1,1)),Math.abs(u)<.9999999?(this._y=Math.atan2(o,g),this._z=Math.atan2(c,h)):(this._y=Math.atan2(-d,s),this._z=0);break;case"ZXY":this._x=Math.asin(ae(x,-1,1)),Math.abs(x)<.9999999?(this._y=Math.atan2(-d,g),this._z=Math.atan2(-a,h)):(this._y=0,this._z=Math.atan2(c,s));break;case"ZYX":this._y=Math.asin(-ae(d,-1,1)),Math.abs(d)<.9999999?(this._x=Math.atan2(x,g),this._z=Math.atan2(c,s)):(this._x=0,this._z=Math.atan2(-a,h));break;case"YZX":this._z=Math.asin(ae(c,-1,1)),Math.abs(c)<.9999999?(this._x=Math.atan2(-u,h),this._y=Math.atan2(-d,s)):(this._x=0,this._y=Math.atan2(o,g));break;case"XZY":this._z=Math.asin(-ae(a,-1,1)),Math.abs(a)<.9999999?(this._x=Math.atan2(x,h),this._y=Math.atan2(o,s)):(this._x=Math.atan2(-u,g),this._y=0);break;default:console.warn("THREE.Euler: .setFromRotationMatrix() encountered an unknown order: "+e)}return this._order=e,r===!0&&this._onChangeCallback(),this}setFromQuaternion(t,e,r){return ou.makeRotationFromQuaternion(t),this.setFromRotationMatrix(ou,e,r)}setFromVector3(t,e=this._order){return this.set(t.x,t.y,t.z,e)}reorder(t){return lu.setFromEuler(this),this.setFromQuaternion(lu,t)}equals(t){return t._x===this._x&&t._y===this._y&&t._z===this._z&&t._order===this._order}fromArray(t){return this._x=t[0],this._y=t[1],this._z=t[2],t[3]!==void 0&&(this._order=t[3]),this._onChangeCallback(),this}toArray(t=[],e=0){return t[e]=this._x,t[e+1]=this._y,t[e+2]=this._z,t[e+3]=this._order,t}_onChange(t){return this._onChangeCallback=t,this}_onChangeCallback(){}*[Symbol.iterator](){yield this._x,yield this._y,yield this._z,yield this._order}}li.DEFAULT_ORDER="XYZ";class uy{constructor(){this.mask=1}set(t){this.mask=(1<<t|0)>>>0}enable(t){this.mask|=1<<t|0}enableAll(){this.mask=-1}toggle(t){this.mask^=1<<t|0}disable(t){this.mask&=~(1<<t|0)}disableAll(){this.mask=0}test(t){return(this.mask&t.mask)!==0}isEnabled(t){return(this.mask&(1<<t|0))!==0}}let fy=0;const cu=new L,Qi=new qn,Pr=new we,Ls=new L,Bn=new L,dy=new L,my=new qn,hu=new L(1,0,0),uu=new L(0,1,0),fu=new L(0,0,1),du={type:"added"},py={type:"removed"},tn={type:"childadded",child:null},yo={type:"childremoved",child:null};class We extends Jn{constructor(){super(),this.isObject3D=!0,Object.defineProperty(this,"id",{value:fy++}),this.uuid=pn(),this.name="",this.type="Object3D",this.parent=null,this.children=[],this.up=We.DEFAULT_UP.clone();const t=new L,e=new li,r=new qn,i=new L(1,1,1);function s(){r.setFromEuler(e,!1)}function a(){e.setFromQuaternion(r,void 0,!1)}e._onChange(s),r._onChange(a),Object.defineProperties(this,{position:{configurable:!0,enumerable:!0,value:t},rotation:{configurable:!0,enumerable:!0,value:e},quaternion:{configurable:!0,enumerable:!0,value:r},scale:{configurable:!0,enumerable:!0,value:i},modelViewMatrix:{value:new we},normalMatrix:{value:new Gr}}),this.matrix=new we,this.matrixWorld=new we,this.matrixAutoUpdate=We.DEFAULT_MATRIX_AUTO_UPDATE,this.matrixWorldAutoUpdate=We.DEFAULT_MATRIX_WORLD_AUTO_UPDATE,this.matrixWorldNeedsUpdate=!1,this.layers=new uy,this.visible=!0,this.castShadow=!1,this.receiveShadow=!1,this.frustumCulled=!0,this.renderOrder=0,this.animations=[],this.customDepthMaterial=void 0,this.customDistanceMaterial=void 0,this.userData={}}onBeforeShadow(){}onAfterShadow(){}onBeforeRender(){}onAfterRender(){}applyMatrix4(t){this.matrixAutoUpdate&&this.updateMatrix(),this.matrix.premultiply(t),this.matrix.decompose(this.position,this.quaternion,this.scale)}applyQuaternion(t){return this.quaternion.premultiply(t),this}setRotationFromAxisAngle(t,e){this.quaternion.setFromAxisAngle(t,e)}setRotationFromEuler(t){this.quaternion.setFromEuler(t,!0)}setRotationFromMatrix(t){this.quaternion.setFromRotationMatrix(t)}setRotationFromQuaternion(t){this.quaternion.copy(t)}rotateOnAxis(t,e){return Qi.setFromAxisAngle(t,e),this.quaternion.multiply(Qi),this}rotateOnWorldAxis(t,e){return Qi.setFromAxisAngle(t,e),this.quaternion.premultiply(Qi),this}rotateX(t){return this.rotateOnAxis(hu,t)}rotateY(t){return this.rotateOnAxis(uu,t)}rotateZ(t){return this.rotateOnAxis(fu,t)}translateOnAxis(t,e){return cu.copy(t).applyQuaternion(this.quaternion),this.position.add(cu.multiplyScalar(e)),this}translateX(t){return this.translateOnAxis(hu,t)}translateY(t){return this.translateOnAxis(uu,t)}translateZ(t){return this.translateOnAxis(fu,t)}localToWorld(t){return this.updateWorldMatrix(!0,!1),t.applyMatrix4(this.matrixWorld)}worldToLocal(t){return this.updateWorldMatrix(!0,!1),t.applyMatrix4(Pr.copy(this.matrixWorld).invert())}lookAt(t,e,r){t.isVector3?Ls.copy(t):Ls.set(t,e,r);const i=this.parent;this.updateWorldMatrix(!0,!1),Bn.setFromMatrixPosition(this.matrixWorld),this.isCamera||this.isLight?Pr.lookAt(Bn,Ls,this.up):Pr.lookAt(Ls,Bn,this.up),this.quaternion.setFromRotationMatrix(Pr),i&&(Pr.extractRotation(i.matrixWorld),Qi.setFromRotationMatrix(Pr),this.quaternion.premultiply(Qi.invert()))}add(t){if(arguments.length>1){for(let e=0;e<arguments.length;e++)this.add(arguments[e]);return this}return t===this?(console.error("THREE.Object3D.add: object can't be added as a child of itself.",t),this):(t&&t.isObject3D?(t.removeFromParent(),t.parent=this,this.children.push(t),t.dispatchEvent(du),tn.child=t,this.dispatchEvent(tn),tn.child=null):console.error("THREE.Object3D.add: object not an instance of THREE.Object3D.",t),this)}remove(t){if(arguments.length>1){for(let r=0;r<arguments.length;r++)this.remove(arguments[r]);return this}const e=this.children.indexOf(t);return e!==-1&&(t.parent=null,this.children.splice(e,1),t.dispatchEvent(py),yo.child=t,this.dispatchEvent(yo),yo.child=null),this}removeFromParent(){const t=this.parent;return t!==null&&t.remove(this),this}clear(){return this.remove(...this.children)}attach(t){return this.updateWorldMatrix(!0,!1),Pr.copy(this.matrixWorld).invert(),t.parent!==null&&(t.parent.updateWorldMatrix(!0,!1),Pr.multiply(t.parent.matrixWorld)),t.applyMatrix4(Pr),t.removeFromParent(),t.parent=this,this.children.push(t),t.updateWorldMatrix(!1,!0),t.dispatchEvent(du),tn.child=t,this.dispatchEvent(tn),tn.child=null,this}getObjectById(t){return this.getObjectByProperty("id",t)}getObjectByName(t){return this.getObjectByProperty("name",t)}getObjectByProperty(t,e){if(this[t]===e)return this;for(let r=0,i=this.children.length;r<i;r++){const a=this.children[r].getObjectByProperty(t,e);if(a!==void 0)return a}}getObjectsByProperty(t,e,r=[]){this[t]===e&&r.push(this);const i=this.children;for(let s=0,a=i.length;s<a;s++)i[s].getObjectsByProperty(t,e,r);return r}getWorldPosition(t){return this.updateWorldMatrix(!0,!1),t.setFromMatrixPosition(this.matrixWorld)}getWorldQuaternion(t){return this.updateWorldMatrix(!0,!1),this.matrixWorld.decompose(Bn,t,dy),t}getWorldScale(t){return this.updateWorldMatrix(!0,!1),this.matrixWorld.decompose(Bn,my,t),t}getWorldDirection(t){this.updateWorldMatrix(!0,!1);const e=this.matrixWorld.elements;return t.set(e[8],e[9],e[10]).normalize()}raycast(){}traverse(t){t(this);const e=this.children;for(let r=0,i=e.length;r<i;r++)e[r].traverse(t)}traverseVisible(t){if(this.visible===!1)return;t(this);const e=this.children;for(let r=0,i=e.length;r<i;r++)e[r].traverseVisible(t)}traverseAncestors(t){const e=this.parent;e!==null&&(t(e),e.traverseAncestors(t))}updateMatrix(){this.matrix.compose(this.position,this.quaternion,this.scale),this.matrixWorldNeedsUpdate=!0}updateMatrixWorld(t){this.matrixAutoUpdate&&this.updateMatrix(),(this.matrixWorldNeedsUpdate||t)&&(this.matrixWorldAutoUpdate===!0&&(this.parent===null?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix)),this.matrixWorldNeedsUpdate=!1,t=!0);const e=this.children;for(let r=0,i=e.length;r<i;r++)e[r].updateMatrixWorld(t)}updateWorldMatrix(t,e){const r=this.parent;if(t===!0&&r!==null&&r.updateWorldMatrix(!0,!1),this.matrixAutoUpdate&&this.updateMatrix(),this.matrixWorldAutoUpdate===!0&&(this.parent===null?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix)),e===!0){const i=this.children;for(let s=0,a=i.length;s<a;s++)i[s].updateWorldMatrix(!1,!0)}}toJSON(t){const e=t===void 0||typeof t=="string",r={};e&&(t={geometries:{},materials:{},textures:{},images:{},shapes:{},skeletons:{},animations:{},nodes:{}},r.metadata={version:4.7,type:"Object",generator:"Object3D.toJSON"});const i={};i.uuid=this.uuid,i.type=this.type,this.name!==""&&(i.name=this.name),this.castShadow===!0&&(i.castShadow=!0),this.receiveShadow===!0&&(i.receiveShadow=!0),this.visible===!1&&(i.visible=!1),this.frustumCulled===!1&&(i.frustumCulled=!1),this.renderOrder!==0&&(i.renderOrder=this.renderOrder),Object.keys(this.userData).length>0&&(i.userData=this.userData),i.layers=this.layers.mask,i.matrix=this.matrix.toArray(),i.up=this.up.toArray(),this.matrixAutoUpdate===!1&&(i.matrixAutoUpdate=!1),this.isInstancedMesh&&(i.type="InstancedMesh",i.count=this.count,i.instanceMatrix=this.instanceMatrix.toJSON(),this.instanceColor!==null&&(i.instanceColor=this.instanceColor.toJSON())),this.isBatchedMesh&&(i.type="BatchedMesh",i.perObjectFrustumCulled=this.perObjectFrustumCulled,i.sortObjects=this.sortObjects,i.drawRanges=this._drawRanges,i.reservedRanges=this._reservedRanges,i.geometryInfo=this._geometryInfo.map(o=>({...o,boundingBox:o.boundingBox?o.boundingBox.toJSON():void 0,boundingSphere:o.boundingSphere?o.boundingSphere.toJSON():void 0})),i.instanceInfo=this._instanceInfo.map(o=>({...o})),i.availableInstanceIds=this._availableInstanceIds.slice(),i.availableGeometryIds=this._availableGeometryIds.slice(),i.nextIndexStart=this._nextIndexStart,i.nextVertexStart=this._nextVertexStart,i.geometryCount=this._geometryCount,i.maxInstanceCount=this._maxInstanceCount,i.maxVertexCount=this._maxVertexCount,i.maxIndexCount=this._maxIndexCount,i.geometryInitialized=this._geometryInitialized,i.matricesTexture=this._matricesTexture.toJSON(t),i.indirectTexture=this._indirectTexture.toJSON(t),this._colorsTexture!==null&&(i.colorsTexture=this._colorsTexture.toJSON(t)),this.boundingSphere!==null&&(i.boundingSphere=this.boundingSphere.toJSON()),this.boundingBox!==null&&(i.boundingBox=this.boundingBox.toJSON()));function s(o,c){return o[c.uuid]===void 0&&(o[c.uuid]=c.toJSON(t)),c.uuid}if(this.isScene)this.background&&(this.background.isColor?i.background=this.background.toJSON():this.background.isTexture&&(i.background=this.background.toJSON(t).uuid)),this.environment&&this.environment.isTexture&&this.environment.isRenderTargetTexture!==!0&&(i.environment=this.environment.toJSON(t).uuid);else if(this.isMesh||this.isLine||this.isPoints){i.geometry=s(t.geometries,this.geometry);const o=this.geometry.parameters;if(o!==void 0&&o.shapes!==void 0){const c=o.shapes;if(Array.isArray(c))for(let h=0,u=c.length;h<u;h++){const d=c[h];s(t.shapes,d)}else s(t.shapes,c)}}if(this.isSkinnedMesh&&(i.bindMode=this.bindMode,i.bindMatrix=this.bindMatrix.toArray(),this.skeleton!==void 0&&(s(t.skeletons,this.skeleton),i.skeleton=this.skeleton.uuid)),this.material!==void 0)if(Array.isArray(this.material)){const o=[];for(let c=0,h=this.material.length;c<h;c++)o.push(s(t.materials,this.material[c]));i.material=o}else i.material=s(t.materials,this.material);if(this.children.length>0){i.children=[];for(let o=0;o<this.children.length;o++)i.children.push(this.children[o].toJSON(t).object)}if(this.animations.length>0){i.animations=[];for(let o=0;o<this.animations.length;o++){const c=this.animations[o];i.animations.push(s(t.animations,c))}}if(e){const o=a(t.geometries),c=a(t.materials),h=a(t.textures),u=a(t.images),d=a(t.shapes),x=a(t.skeletons),g=a(t.animations),A=a(t.nodes);o.length>0&&(r.geometries=o),c.length>0&&(r.materials=c),h.length>0&&(r.textures=h),u.length>0&&(r.images=u),d.length>0&&(r.shapes=d),x.length>0&&(r.skeletons=x),g.length>0&&(r.animations=g),A.length>0&&(r.nodes=A)}return r.object=i,r;function a(o){const c=[];for(const h in o){const u=o[h];delete u.metadata,c.push(u)}return c}}clone(t){return new this.constructor().copy(this,t)}copy(t,e=!0){if(this.name=t.name,this.up.copy(t.up),this.position.copy(t.position),this.rotation.order=t.rotation.order,this.quaternion.copy(t.quaternion),this.scale.copy(t.scale),this.matrix.copy(t.matrix),this.matrixWorld.copy(t.matrixWorld),this.matrixAutoUpdate=t.matrixAutoUpdate,this.matrixWorldAutoUpdate=t.matrixWorldAutoUpdate,this.matrixWorldNeedsUpdate=t.matrixWorldNeedsUpdate,this.layers.mask=t.layers.mask,this.visible=t.visible,this.castShadow=t.castShadow,this.receiveShadow=t.receiveShadow,this.frustumCulled=t.frustumCulled,this.renderOrder=t.renderOrder,this.animations=t.animations.slice(),this.userData=JSON.parse(JSON.stringify(t.userData)),e===!0)for(let r=0;r<t.children.length;r++){const i=t.children[r];this.add(i.clone())}return this}}We.DEFAULT_UP=new L(0,1,0);We.DEFAULT_MATRIX_AUTO_UPDATE=!0;We.DEFAULT_MATRIX_WORLD_AUTO_UPDATE=!0;const gr=new L,Br=new L,xo=new L,kr=new L,en=new L,rn=new L,mu=new L,go=new L,_o=new L,bo=new L,vo=new tr,Eo=new tr,Ao=new tr;class br{constructor(t=new L,e=new L,r=new L){this.a=t,this.b=e,this.c=r}static getNormal(t,e,r,i){i.subVectors(r,e),gr.subVectors(t,e),i.cross(gr);const s=i.lengthSq();return s>0?i.multiplyScalar(1/Math.sqrt(s)):i.set(0,0,0)}static getBarycoord(t,e,r,i,s){gr.subVectors(i,e),Br.subVectors(r,e),xo.subVectors(t,e);const a=gr.dot(gr),o=gr.dot(Br),c=gr.dot(xo),h=Br.dot(Br),u=Br.dot(xo),d=a*h-o*o;if(d===0)return s.set(0,0,0),null;const x=1/d,g=(h*c-o*u)*x,A=(a*u-o*c)*x;return s.set(1-g-A,A,g)}static containsPoint(t,e,r,i){return this.getBarycoord(t,e,r,i,kr)===null?!1:kr.x>=0&&kr.y>=0&&kr.x+kr.y<=1}static getInterpolation(t,e,r,i,s,a,o,c){return this.getBarycoord(t,e,r,i,kr)===null?(c.x=0,c.y=0,"z"in c&&(c.z=0),"w"in c&&(c.w=0),null):(c.setScalar(0),c.addScaledVector(s,kr.x),c.addScaledVector(a,kr.y),c.addScaledVector(o,kr.z),c)}static getInterpolatedAttribute(t,e,r,i,s,a){return vo.setScalar(0),Eo.setScalar(0),Ao.setScalar(0),vo.fromBufferAttribute(t,e),Eo.fromBufferAttribute(t,r),Ao.fromBufferAttribute(t,i),a.setScalar(0),a.addScaledVector(vo,s.x),a.addScaledVector(Eo,s.y),a.addScaledVector(Ao,s.z),a}static isFrontFacing(t,e,r,i){return gr.subVectors(r,e),Br.subVectors(t,e),gr.cross(Br).dot(i)<0}set(t,e,r){return this.a.copy(t),this.b.copy(e),this.c.copy(r),this}setFromPointsAndIndices(t,e,r,i){return this.a.copy(t[e]),this.b.copy(t[r]),this.c.copy(t[i]),this}setFromAttributeAndIndices(t,e,r,i){return this.a.fromBufferAttribute(t,e),this.b.fromBufferAttribute(t,r),this.c.fromBufferAttribute(t,i),this}clone(){return new this.constructor().copy(this)}copy(t){return this.a.copy(t.a),this.b.copy(t.b),this.c.copy(t.c),this}getArea(){return gr.subVectors(this.c,this.b),Br.subVectors(this.a,this.b),gr.cross(Br).length()*.5}getMidpoint(t){return t.addVectors(this.a,this.b).add(this.c).multiplyScalar(1/3)}getNormal(t){return br.getNormal(this.a,this.b,this.c,t)}getPlane(t){return t.setFromCoplanarPoints(this.a,this.b,this.c)}getBarycoord(t,e){return br.getBarycoord(t,this.a,this.b,this.c,e)}getInterpolation(t,e,r,i,s){return br.getInterpolation(t,this.a,this.b,this.c,e,r,i,s)}containsPoint(t){return br.containsPoint(t,this.a,this.b,this.c)}isFrontFacing(t){return br.isFrontFacing(this.a,this.b,this.c,t)}intersectsBox(t){return t.intersectsTriangle(this)}closestPointToPoint(t,e){const r=this.a,i=this.b,s=this.c;let a,o;en.subVectors(i,r),rn.subVectors(s,r),go.subVectors(t,r);const c=en.dot(go),h=rn.dot(go);if(c<=0&&h<=0)return e.copy(r);_o.subVectors(t,i);const u=en.dot(_o),d=rn.dot(_o);if(u>=0&&d<=u)return e.copy(i);const x=c*d-u*h;if(x<=0&&c>=0&&u<=0)return a=c/(c-u),e.copy(r).addScaledVector(en,a);bo.subVectors(t,s);const g=en.dot(bo),A=rn.dot(bo);if(A>=0&&g<=A)return e.copy(s);const P=g*h-c*A;if(P<=0&&h>=0&&A<=0)return o=h/(h-A),e.copy(r).addScaledVector(rn,o);const H=u*A-g*d;if(H<=0&&d-u>=0&&g-A>=0)return mu.subVectors(s,i),o=(d-u)/(d-u+(g-A)),e.copy(i).addScaledVector(mu,o);const V=1/(H+P+x);return a=P*V,o=x*V,e.copy(r).addScaledVector(en,a).addScaledVector(rn,o)}equals(t){return t.a.equals(this.a)&&t.b.equals(this.b)&&t.c.equals(this.c)}}const ef={aliceblue:15792383,antiquewhite:16444375,aqua:65535,aquamarine:8388564,azure:15794175,beige:16119260,bisque:16770244,black:0,blanchedalmond:16772045,blue:255,blueviolet:9055202,brown:10824234,burlywood:14596231,cadetblue:6266528,chartreuse:8388352,chocolate:13789470,coral:16744272,cornflowerblue:6591981,cornsilk:16775388,crimson:14423100,cyan:65535,darkblue:139,darkcyan:35723,darkgoldenrod:12092939,darkgray:11119017,darkgreen:25600,darkgrey:11119017,darkkhaki:12433259,darkmagenta:9109643,darkolivegreen:5597999,darkorange:16747520,darkorchid:10040012,darkred:9109504,darksalmon:15308410,darkseagreen:9419919,darkslateblue:4734347,darkslategray:3100495,darkslategrey:3100495,darkturquoise:52945,darkviolet:9699539,deeppink:16716947,deepskyblue:49151,dimgray:6908265,dimgrey:6908265,dodgerblue:2003199,firebrick:11674146,floralwhite:16775920,forestgreen:2263842,fuchsia:16711935,gainsboro:14474460,ghostwhite:16316671,gold:16766720,goldenrod:14329120,gray:8421504,green:32768,greenyellow:11403055,grey:8421504,honeydew:15794160,hotpink:16738740,indianred:13458524,indigo:4915330,ivory:16777200,khaki:15787660,lavender:15132410,lavenderblush:16773365,lawngreen:8190976,lemonchiffon:16775885,lightblue:11393254,lightcoral:15761536,lightcyan:14745599,lightgoldenrodyellow:16448210,lightgray:13882323,lightgreen:9498256,lightgrey:13882323,lightpink:16758465,lightsalmon:16752762,lightseagreen:2142890,lightskyblue:8900346,lightslategray:7833753,lightslategrey:7833753,lightsteelblue:11584734,lightyellow:16777184,lime:65280,limegreen:3329330,linen:16445670,magenta:16711935,maroon:8388608,mediumaquamarine:6737322,mediumblue:205,mediumorchid:12211667,mediumpurple:9662683,mediumseagreen:3978097,mediumslateblue:8087790,mediumspringgreen:64154,mediumturquoise:4772300,mediumvioletred:13047173,midnightblue:1644912,mintcream:16121850,mistyrose:16770273,moccasin:16770229,navajowhite:16768685,navy:128,oldlace:16643558,olive:8421376,olivedrab:7048739,orange:16753920,orangered:16729344,orchid:14315734,palegoldenrod:15657130,palegreen:10025880,paleturquoise:11529966,palevioletred:14381203,papayawhip:16773077,peachpuff:16767673,peru:13468991,pink:16761035,plum:14524637,powderblue:11591910,purple:8388736,rebeccapurple:6697881,red:16711680,rosybrown:12357519,royalblue:4286945,saddlebrown:9127187,salmon:16416882,sandybrown:16032864,seagreen:3050327,seashell:16774638,sienna:10506797,silver:12632256,skyblue:8900331,slateblue:6970061,slategray:7372944,slategrey:7372944,snow:16775930,springgreen:65407,steelblue:4620980,tan:13808780,teal:32896,thistle:14204888,tomato:16737095,turquoise:4251856,violet:15631086,wheat:16113331,white:16777215,whitesmoke:16119285,yellow:16776960,yellowgreen:10145074},ri={h:0,s:0,l:0},Ds={h:0,s:0,l:0};function To(n,t,e){return e<0&&(e+=1),e>1&&(e-=1),e<1/6?n+(t-n)*6*e:e<1/2?t:e<2/3?n+(t-n)*6*(2/3-e):n}class vr{constructor(t,e,r){return this.isColor=!0,this.r=1,this.g=1,this.b=1,this.set(t,e,r)}set(t,e,r){if(e===void 0&&r===void 0){const i=t;i&&i.isColor?this.copy(i):typeof i=="number"?this.setHex(i):typeof i=="string"&&this.setStyle(i)}else this.setRGB(t,e,r);return this}setScalar(t){return this.r=t,this.g=t,this.b=t,this}setHex(t,e=_r){return t=Math.floor(t),this.r=(t>>16&255)/255,this.g=(t>>8&255)/255,this.b=(t&255)/255,fr.colorSpaceToWorking(this,e),this}setRGB(t,e,r,i=fr.workingColorSpace){return this.r=t,this.g=e,this.b=r,fr.colorSpaceToWorking(this,i),this}setHSL(t,e,r,i=fr.workingColorSpace){if(t=Vo(t,1),e=ae(e,0,1),r=ae(r,0,1),e===0)this.r=this.g=this.b=r;else{const s=r<=.5?r*(1+e):r+e-r*e,a=2*r-s;this.r=To(a,s,t+1/3),this.g=To(a,s,t),this.b=To(a,s,t-1/3)}return fr.colorSpaceToWorking(this,i),this}setStyle(t,e=_r){function r(s){s!==void 0&&parseFloat(s)<1&&console.warn("THREE.Color: Alpha component of "+t+" will be ignored.")}let i;if(i=/^(\w+)\(([^\)]*)\)/.exec(t)){let s;const a=i[1],o=i[2];switch(a){case"rgb":case"rgba":if(s=/^\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(o))return r(s[4]),this.setRGB(Math.min(255,parseInt(s[1],10))/255,Math.min(255,parseInt(s[2],10))/255,Math.min(255,parseInt(s[3],10))/255,e);if(s=/^\s*(\d+)\%\s*,\s*(\d+)\%\s*,\s*(\d+)\%\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(o))return r(s[4]),this.setRGB(Math.min(100,parseInt(s[1],10))/100,Math.min(100,parseInt(s[2],10))/100,Math.min(100,parseInt(s[3],10))/100,e);break;case"hsl":case"hsla":if(s=/^\s*(\d*\.?\d+)\s*,\s*(\d*\.?\d+)\%\s*,\s*(\d*\.?\d+)\%\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(o))return r(s[4]),this.setHSL(parseFloat(s[1])/360,parseFloat(s[2])/100,parseFloat(s[3])/100,e);break;default:console.warn("THREE.Color: Unknown color model "+t)}}else if(i=/^\#([A-Fa-f\d]+)$/.exec(t)){const s=i[1],a=s.length;if(a===3)return this.setRGB(parseInt(s.charAt(0),16)/15,parseInt(s.charAt(1),16)/15,parseInt(s.charAt(2),16)/15,e);if(a===6)return this.setHex(parseInt(s,16),e);console.warn("THREE.Color: Invalid hex color "+t)}else if(t&&t.length>0)return this.setColorName(t,e);return this}setColorName(t,e=_r){const r=ef[t.toLowerCase()];return r!==void 0?this.setHex(r,e):console.warn("THREE.Color: Unknown color "+t),this}clone(){return new this.constructor(this.r,this.g,this.b)}copy(t){return this.r=t.r,this.g=t.g,this.b=t.b,this}copySRGBToLinear(t){return this.r=Ur(t.r),this.g=Ur(t.g),this.b=Ur(t.b),this}copyLinearToSRGB(t){return this.r=mn(t.r),this.g=mn(t.g),this.b=mn(t.b),this}convertSRGBToLinear(){return this.copySRGBToLinear(this),this}convertLinearToSRGB(){return this.copyLinearToSRGB(this),this}getHex(t=_r){return fr.workingToColorSpace(Je.copy(this),t),Math.round(ae(Je.r*255,0,255))*65536+Math.round(ae(Je.g*255,0,255))*256+Math.round(ae(Je.b*255,0,255))}getHexString(t=_r){return("000000"+this.getHex(t).toString(16)).slice(-6)}getHSL(t,e=fr.workingColorSpace){fr.workingToColorSpace(Je.copy(this),e);const r=Je.r,i=Je.g,s=Je.b,a=Math.max(r,i,s),o=Math.min(r,i,s);let c,h;const u=(o+a)/2;if(o===a)c=0,h=0;else{const d=a-o;switch(h=u<=.5?d/(a+o):d/(2-a-o),a){case r:c=(i-s)/d+(i<s?6:0);break;case i:c=(s-r)/d+2;break;case s:c=(r-i)/d+4;break}c/=6}return t.h=c,t.s=h,t.l=u,t}getRGB(t,e=fr.workingColorSpace){return fr.workingToColorSpace(Je.copy(this),e),t.r=Je.r,t.g=Je.g,t.b=Je.b,t}getStyle(t=_r){fr.workingToColorSpace(Je.copy(this),t);const e=Je.r,r=Je.g,i=Je.b;return t!==_r?`color(${t} ${e.toFixed(3)} ${r.toFixed(3)} ${i.toFixed(3)})`:`rgb(${Math.round(e*255)},${Math.round(r*255)},${Math.round(i*255)})`}offsetHSL(t,e,r){return this.getHSL(ri),this.setHSL(ri.h+t,ri.s+e,ri.l+r)}add(t){return this.r+=t.r,this.g+=t.g,this.b+=t.b,this}addColors(t,e){return this.r=t.r+e.r,this.g=t.g+e.g,this.b=t.b+e.b,this}addScalar(t){return this.r+=t,this.g+=t,this.b+=t,this}sub(t){return this.r=Math.max(0,this.r-t.r),this.g=Math.max(0,this.g-t.g),this.b=Math.max(0,this.b-t.b),this}multiply(t){return this.r*=t.r,this.g*=t.g,this.b*=t.b,this}multiplyScalar(t){return this.r*=t,this.g*=t,this.b*=t,this}lerp(t,e){return this.r+=(t.r-this.r)*e,this.g+=(t.g-this.g)*e,this.b+=(t.b-this.b)*e,this}lerpColors(t,e,r){return this.r=t.r+(e.r-t.r)*r,this.g=t.g+(e.g-t.g)*r,this.b=t.b+(e.b-t.b)*r,this}lerpHSL(t,e){this.getHSL(ri),t.getHSL(Ds);const r=Yn(ri.h,Ds.h,e),i=Yn(ri.s,Ds.s,e),s=Yn(ri.l,Ds.l,e);return this.setHSL(r,i,s),this}setFromVector3(t){return this.r=t.x,this.g=t.y,this.b=t.z,this}applyMatrix3(t){const e=this.r,r=this.g,i=this.b,s=t.elements;return this.r=s[0]*e+s[3]*r+s[6]*i,this.g=s[1]*e+s[4]*r+s[7]*i,this.b=s[2]*e+s[5]*r+s[8]*i,this}equals(t){return t.r===this.r&&t.g===this.g&&t.b===this.b}fromArray(t,e=0){return this.r=t[e],this.g=t[e+1],this.b=t[e+2],this}toArray(t=[],e=0){return t[e]=this.r,t[e+1]=this.g,t[e+2]=this.b,t}fromBufferAttribute(t,e){return this.r=t.getX(e),this.g=t.getY(e),this.b=t.getZ(e),this}toJSON(){return this.getHex()}*[Symbol.iterator](){yield this.r,yield this.g,yield this.b}}const Je=new vr;vr.NAMES=ef;let yy=0;class Ri extends Jn{constructor(){super(),this.isMaterial=!0,Object.defineProperty(this,"id",{value:yy++}),this.uuid=pn(),this.name="",this.type="Material",this.blending=jh,this.side=ko,this.vertexColors=!1,this.opacity=1,this.transparent=!1,this.alphaHash=!1,this.blendSrc=Wh,this.blendDst=Yh,this.blendEquation=Hh,this.blendSrcAlpha=null,this.blendDstAlpha=null,this.blendEquationAlpha=null,this.blendColor=new vr(0,0,0),this.blendAlpha=0,this.depthFunc=Xh,this.depthTest=!0,this.depthWrite=!0,this.stencilWriteMask=255,this.stencilFunc=Qh,this.stencilRef=0,this.stencilFuncMask=255,this.stencilFail=Xi,this.stencilZFail=Xi,this.stencilZPass=Xi,this.stencilWrite=!1,this.clippingPlanes=null,this.clipIntersection=!1,this.clipShadows=!1,this.shadowSide=null,this.colorWrite=!0,this.precision=null,this.polygonOffset=!1,this.polygonOffsetFactor=0,this.polygonOffsetUnits=0,this.dithering=!1,this.alphaToCoverage=!1,this.premultipliedAlpha=!1,this.forceSinglePass=!1,this.allowOverride=!0,this.visible=!0,this.toneMapped=!0,this.userData={},this.version=0,this._alphaTest=0}get alphaTest(){return this._alphaTest}set alphaTest(t){this._alphaTest>0!=t>0&&this.version++,this._alphaTest=t}onBeforeRender(){}onBeforeCompile(){}customProgramCacheKey(){return this.onBeforeCompile.toString()}setValues(t){if(t!==void 0)for(const e in t){const r=t[e];if(r===void 0){console.warn(`THREE.Material: parameter '${e}' has value of undefined.`);continue}const i=this[e];if(i===void 0){console.warn(`THREE.Material: '${e}' is not a property of THREE.${this.type}.`);continue}i&&i.isColor?i.set(r):i&&i.isVector3&&r&&r.isVector3?i.copy(r):this[e]=r}}toJSON(t){const e=t===void 0||typeof t=="string";e&&(t={textures:{},images:{}});const r={metadata:{version:4.7,type:"Material",generator:"Material.toJSON"}};r.uuid=this.uuid,r.type=this.type,this.name!==""&&(r.name=this.name),this.color&&this.color.isColor&&(r.color=this.color.getHex()),this.roughness!==void 0&&(r.roughness=this.roughness),this.metalness!==void 0&&(r.metalness=this.metalness),this.sheen!==void 0&&(r.sheen=this.sheen),this.sheenColor&&this.sheenColor.isColor&&(r.sheenColor=this.sheenColor.getHex()),this.sheenRoughness!==void 0&&(r.sheenRoughness=this.sheenRoughness),this.emissive&&this.emissive.isColor&&(r.emissive=this.emissive.getHex()),this.emissiveIntensity!==void 0&&this.emissiveIntensity!==1&&(r.emissiveIntensity=this.emissiveIntensity),this.specular&&this.specular.isColor&&(r.specular=this.specular.getHex()),this.specularIntensity!==void 0&&(r.specularIntensity=this.specularIntensity),this.specularColor&&this.specularColor.isColor&&(r.specularColor=this.specularColor.getHex()),this.shininess!==void 0&&(r.shininess=this.shininess),this.clearcoat!==void 0&&(r.clearcoat=this.clearcoat),this.clearcoatRoughness!==void 0&&(r.clearcoatRoughness=this.clearcoatRoughness),this.clearcoatMap&&this.clearcoatMap.isTexture&&(r.clearcoatMap=this.clearcoatMap.toJSON(t).uuid),this.clearcoatRoughnessMap&&this.clearcoatRoughnessMap.isTexture&&(r.clearcoatRoughnessMap=this.clearcoatRoughnessMap.toJSON(t).uuid),this.clearcoatNormalMap&&this.clearcoatNormalMap.isTexture&&(r.clearcoatNormalMap=this.clearcoatNormalMap.toJSON(t).uuid,r.clearcoatNormalScale=this.clearcoatNormalScale.toArray()),this.dispersion!==void 0&&(r.dispersion=this.dispersion),this.iridescence!==void 0&&(r.iridescence=this.iridescence),this.iridescenceIOR!==void 0&&(r.iridescenceIOR=this.iridescenceIOR),this.iridescenceThicknessRange!==void 0&&(r.iridescenceThicknessRange=this.iridescenceThicknessRange),this.iridescenceMap&&this.iridescenceMap.isTexture&&(r.iridescenceMap=this.iridescenceMap.toJSON(t).uuid),this.iridescenceThicknessMap&&this.iridescenceThicknessMap.isTexture&&(r.iridescenceThicknessMap=this.iridescenceThicknessMap.toJSON(t).uuid),this.anisotropy!==void 0&&(r.anisotropy=this.anisotropy),this.anisotropyRotation!==void 0&&(r.anisotropyRotation=this.anisotropyRotation),this.anisotropyMap&&this.anisotropyMap.isTexture&&(r.anisotropyMap=this.anisotropyMap.toJSON(t).uuid),this.map&&this.map.isTexture&&(r.map=this.map.toJSON(t).uuid),this.matcap&&this.matcap.isTexture&&(r.matcap=this.matcap.toJSON(t).uuid),this.alphaMap&&this.alphaMap.isTexture&&(r.alphaMap=this.alphaMap.toJSON(t).uuid),this.lightMap&&this.lightMap.isTexture&&(r.lightMap=this.lightMap.toJSON(t).uuid,r.lightMapIntensity=this.lightMapIntensity),this.aoMap&&this.aoMap.isTexture&&(r.aoMap=this.aoMap.toJSON(t).uuid,r.aoMapIntensity=this.aoMapIntensity),this.bumpMap&&this.bumpMap.isTexture&&(r.bumpMap=this.bumpMap.toJSON(t).uuid,r.bumpScale=this.bumpScale),this.normalMap&&this.normalMap.isTexture&&(r.normalMap=this.normalMap.toJSON(t).uuid,r.normalMapType=this.normalMapType,r.normalScale=this.normalScale.toArray()),this.displacementMap&&this.displacementMap.isTexture&&(r.displacementMap=this.displacementMap.toJSON(t).uuid,r.displacementScale=this.displacementScale,r.displacementBias=this.displacementBias),this.roughnessMap&&this.roughnessMap.isTexture&&(r.roughnessMap=this.roughnessMap.toJSON(t).uuid),this.metalnessMap&&this.metalnessMap.isTexture&&(r.metalnessMap=this.metalnessMap.toJSON(t).uuid),this.emissiveMap&&this.emissiveMap.isTexture&&(r.emissiveMap=this.emissiveMap.toJSON(t).uuid),this.specularMap&&this.specularMap.isTexture&&(r.specularMap=this.specularMap.toJSON(t).uuid),this.specularIntensityMap&&this.specularIntensityMap.isTexture&&(r.specularIntensityMap=this.specularIntensityMap.toJSON(t).uuid),this.specularColorMap&&this.specularColorMap.isTexture&&(r.specularColorMap=this.specularColorMap.toJSON(t).uuid),this.envMap&&this.envMap.isTexture&&(r.envMap=this.envMap.toJSON(t).uuid,this.combine!==void 0&&(r.combine=this.combine)),this.envMapRotation!==void 0&&(r.envMapRotation=this.envMapRotation.toArray()),this.envMapIntensity!==void 0&&(r.envMapIntensity=this.envMapIntensity),this.reflectivity!==void 0&&(r.reflectivity=this.reflectivity),this.refractionRatio!==void 0&&(r.refractionRatio=this.refractionRatio),this.gradientMap&&this.gradientMap.isTexture&&(r.gradientMap=this.gradientMap.toJSON(t).uuid),this.transmission!==void 0&&(r.transmission=this.transmission),this.transmissionMap&&this.transmissionMap.isTexture&&(r.transmissionMap=this.transmissionMap.toJSON(t).uuid),this.thickness!==void 0&&(r.thickness=this.thickness),this.thicknessMap&&this.thicknessMap.isTexture&&(r.thicknessMap=this.thicknessMap.toJSON(t).uuid),this.attenuationDistance!==void 0&&this.attenuationDistance!==1/0&&(r.attenuationDistance=this.attenuationDistance),this.attenuationColor!==void 0&&(r.attenuationColor=this.attenuationColor.getHex()),this.size!==void 0&&(r.size=this.size),this.shadowSide!==null&&(r.shadowSide=this.shadowSide),this.sizeAttenuation!==void 0&&(r.sizeAttenuation=this.sizeAttenuation),this.blending!==jh&&(r.blending=this.blending),this.side!==ko&&(r.side=this.side),this.vertexColors===!0&&(r.vertexColors=!0),this.opacity<1&&(r.opacity=this.opacity),this.transparent===!0&&(r.transparent=!0),this.blendSrc!==Wh&&(r.blendSrc=this.blendSrc),this.blendDst!==Yh&&(r.blendDst=this.blendDst),this.blendEquation!==Hh&&(r.blendEquation=this.blendEquation),this.blendSrcAlpha!==null&&(r.blendSrcAlpha=this.blendSrcAlpha),this.blendDstAlpha!==null&&(r.blendDstAlpha=this.blendDstAlpha),this.blendEquationAlpha!==null&&(r.blendEquationAlpha=this.blendEquationAlpha),this.blendColor&&this.blendColor.isColor&&(r.blendColor=this.blendColor.getHex()),this.blendAlpha!==0&&(r.blendAlpha=this.blendAlpha),this.depthFunc!==Xh&&(r.depthFunc=this.depthFunc),this.depthTest===!1&&(r.depthTest=this.depthTest),this.depthWrite===!1&&(r.depthWrite=this.depthWrite),this.colorWrite===!1&&(r.colorWrite=this.colorWrite),this.stencilWriteMask!==255&&(r.stencilWriteMask=this.stencilWriteMask),this.stencilFunc!==Qh&&(r.stencilFunc=this.stencilFunc),this.stencilRef!==0&&(r.stencilRef=this.stencilRef),this.stencilFuncMask!==255&&(r.stencilFuncMask=this.stencilFuncMask),this.stencilFail!==Xi&&(r.stencilFail=this.stencilFail),this.stencilZFail!==Xi&&(r.stencilZFail=this.stencilZFail),this.stencilZPass!==Xi&&(r.stencilZPass=this.stencilZPass),this.stencilWrite===!0&&(r.stencilWrite=this.stencilWrite),this.rotation!==void 0&&this.rotation!==0&&(r.rotation=this.rotation),this.polygonOffset===!0&&(r.polygonOffset=!0),this.polygonOffsetFactor!==0&&(r.polygonOffsetFactor=this.polygonOffsetFactor),this.polygonOffsetUnits!==0&&(r.polygonOffsetUnits=this.polygonOffsetUnits),this.linewidth!==void 0&&this.linewidth!==1&&(r.linewidth=this.linewidth),this.dashSize!==void 0&&(r.dashSize=this.dashSize),this.gapSize!==void 0&&(r.gapSize=this.gapSize),this.scale!==void 0&&(r.scale=this.scale),this.dithering===!0&&(r.dithering=!0),this.alphaTest>0&&(r.alphaTest=this.alphaTest),this.alphaHash===!0&&(r.alphaHash=!0),this.alphaToCoverage===!0&&(r.alphaToCoverage=!0),this.premultipliedAlpha===!0&&(r.premultipliedAlpha=!0),this.forceSinglePass===!0&&(r.forceSinglePass=!0),this.wireframe===!0&&(r.wireframe=!0),this.wireframeLinewidth>1&&(r.wireframeLinewidth=this.wireframeLinewidth),this.wireframeLinecap!=="round"&&(r.wireframeLinecap=this.wireframeLinecap),this.wireframeLinejoin!=="round"&&(r.wireframeLinejoin=this.wireframeLinejoin),this.flatShading===!0&&(r.flatShading=!0),this.visible===!1&&(r.visible=!1),this.toneMapped===!1&&(r.toneMapped=!1),this.fog===!1&&(r.fog=!1),Object.keys(this.userData).length>0&&(r.userData=this.userData);function i(s){const a=[];for(const o in s){const c=s[o];delete c.metadata,a.push(c)}return a}if(e){const s=i(t.textures),a=i(t.images);s.length>0&&(r.textures=s),a.length>0&&(r.images=a)}return r}clone(){return new this.constructor().copy(this)}copy(t){this.name=t.name,this.blending=t.blending,this.side=t.side,this.vertexColors=t.vertexColors,this.opacity=t.opacity,this.transparent=t.transparent,this.blendSrc=t.blendSrc,this.blendDst=t.blendDst,this.blendEquation=t.blendEquation,this.blendSrcAlpha=t.blendSrcAlpha,this.blendDstAlpha=t.blendDstAlpha,this.blendEquationAlpha=t.blendEquationAlpha,this.blendColor.copy(t.blendColor),this.blendAlpha=t.blendAlpha,this.depthFunc=t.depthFunc,this.depthTest=t.depthTest,this.depthWrite=t.depthWrite,this.stencilWriteMask=t.stencilWriteMask,this.stencilFunc=t.stencilFunc,this.stencilRef=t.stencilRef,this.stencilFuncMask=t.stencilFuncMask,this.stencilFail=t.stencilFail,this.stencilZFail=t.stencilZFail,this.stencilZPass=t.stencilZPass,this.stencilWrite=t.stencilWrite;const e=t.clippingPlanes;let r=null;if(e!==null){const i=e.length;r=new Array(i);for(let s=0;s!==i;++s)r[s]=e[s].clone()}return this.clippingPlanes=r,this.clipIntersection=t.clipIntersection,this.clipShadows=t.clipShadows,this.shadowSide=t.shadowSide,this.colorWrite=t.colorWrite,this.precision=t.precision,this.polygonOffset=t.polygonOffset,this.polygonOffsetFactor=t.polygonOffsetFactor,this.polygonOffsetUnits=t.polygonOffsetUnits,this.dithering=t.dithering,this.alphaTest=t.alphaTest,this.alphaHash=t.alphaHash,this.alphaToCoverage=t.alphaToCoverage,this.premultipliedAlpha=t.premultipliedAlpha,this.forceSinglePass=t.forceSinglePass,this.visible=t.visible,this.toneMapped=t.toneMapped,this.userData=JSON.parse(JSON.stringify(t.userData)),this}dispose(){this.dispatchEvent({type:"dispose"})}set needsUpdate(t){t===!0&&this.version++}}class xy extends Ri{constructor(t){super(),this.isMeshBasicMaterial=!0,this.type="MeshBasicMaterial",this.color=new vr(16777215),this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.envMapRotation=new li,this.combine=Vp,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.fog=!0,this.setValues(t)}copy(t){return super.copy(t),this.color.copy(t.color),this.map=t.map,this.lightMap=t.lightMap,this.lightMapIntensity=t.lightMapIntensity,this.aoMap=t.aoMap,this.aoMapIntensity=t.aoMapIntensity,this.specularMap=t.specularMap,this.alphaMap=t.alphaMap,this.envMap=t.envMap,this.envMapRotation.copy(t.envMapRotation),this.combine=t.combine,this.reflectivity=t.reflectivity,this.refractionRatio=t.refractionRatio,this.wireframe=t.wireframe,this.wireframeLinewidth=t.wireframeLinewidth,this.wireframeLinecap=t.wireframeLinecap,this.wireframeLinejoin=t.wireframeLinejoin,this.fog=t.fog,this}}const Pe=new L,Fs=new le;let gy=0;class Mi{constructor(t,e,r=!1){if(Array.isArray(t))throw new TypeError("THREE.BufferAttribute: array should be a Typed Array.");this.isBufferAttribute=!0,Object.defineProperty(this,"id",{value:gy++}),this.name="",this.array=t,this.itemSize=e,this.count=t!==void 0?t.length/e:0,this.normalized=r,this.usage=tu,this.updateRanges=[],this.gpuType=Go,this.version=0}onUploadCallback(){}set needsUpdate(t){t===!0&&this.version++}setUsage(t){return this.usage=t,this}addUpdateRange(t,e){this.updateRanges.push({start:t,count:e})}clearUpdateRanges(){this.updateRanges.length=0}copy(t){return this.name=t.name,this.array=new t.array.constructor(t.array),this.itemSize=t.itemSize,this.count=t.count,this.normalized=t.normalized,this.usage=t.usage,this.gpuType=t.gpuType,this}copyAt(t,e,r){t*=this.itemSize,r*=e.itemSize;for(let i=0,s=this.itemSize;i<s;i++)this.array[t+i]=e.array[r+i];return this}copyArray(t){return this.array.set(t),this}applyMatrix3(t){if(this.itemSize===2)for(let e=0,r=this.count;e<r;e++)Fs.fromBufferAttribute(this,e),Fs.applyMatrix3(t),this.setXY(e,Fs.x,Fs.y);else if(this.itemSize===3)for(let e=0,r=this.count;e<r;e++)Pe.fromBufferAttribute(this,e),Pe.applyMatrix3(t),this.setXYZ(e,Pe.x,Pe.y,Pe.z);return this}applyMatrix4(t){for(let e=0,r=this.count;e<r;e++)Pe.fromBufferAttribute(this,e),Pe.applyMatrix4(t),this.setXYZ(e,Pe.x,Pe.y,Pe.z);return this}applyNormalMatrix(t){for(let e=0,r=this.count;e<r;e++)Pe.fromBufferAttribute(this,e),Pe.applyNormalMatrix(t),this.setXYZ(e,Pe.x,Pe.y,Pe.z);return this}transformDirection(t){for(let e=0,r=this.count;e<r;e++)Pe.fromBufferAttribute(this,e),Pe.transformDirection(t),this.setXYZ(e,Pe.x,Pe.y,Pe.z);return this}set(t,e=0){return this.array.set(t,e),this}getComponent(t,e){let r=this.array[t*this.itemSize+e];return this.normalized&&(r=hn(r,this.array)),r}setComponent(t,e,r){return this.normalized&&(r=Ze(r,this.array)),this.array[t*this.itemSize+e]=r,this}getX(t){let e=this.array[t*this.itemSize];return this.normalized&&(e=hn(e,this.array)),e}setX(t,e){return this.normalized&&(e=Ze(e,this.array)),this.array[t*this.itemSize]=e,this}getY(t){let e=this.array[t*this.itemSize+1];return this.normalized&&(e=hn(e,this.array)),e}setY(t,e){return this.normalized&&(e=Ze(e,this.array)),this.array[t*this.itemSize+1]=e,this}getZ(t){let e=this.array[t*this.itemSize+2];return this.normalized&&(e=hn(e,this.array)),e}setZ(t,e){return this.normalized&&(e=Ze(e,this.array)),this.array[t*this.itemSize+2]=e,this}getW(t){let e=this.array[t*this.itemSize+3];return this.normalized&&(e=hn(e,this.array)),e}setW(t,e){return this.normalized&&(e=Ze(e,this.array)),this.array[t*this.itemSize+3]=e,this}setXY(t,e,r){return t*=this.itemSize,this.normalized&&(e=Ze(e,this.array),r=Ze(r,this.array)),this.array[t+0]=e,this.array[t+1]=r,this}setXYZ(t,e,r,i){return t*=this.itemSize,this.normalized&&(e=Ze(e,this.array),r=Ze(r,this.array),i=Ze(i,this.array)),this.array[t+0]=e,this.array[t+1]=r,this.array[t+2]=i,this}setXYZW(t,e,r,i,s){return t*=this.itemSize,this.normalized&&(e=Ze(e,this.array),r=Ze(r,this.array),i=Ze(i,this.array),s=Ze(s,this.array)),this.array[t+0]=e,this.array[t+1]=r,this.array[t+2]=i,this.array[t+3]=s,this}onUpload(t){return this.onUploadCallback=t,this}clone(){return new this.constructor(this.array,this.itemSize).copy(this)}toJSON(){const t={itemSize:this.itemSize,type:this.array.constructor.name,array:Array.from(this.array),normalized:this.normalized};return this.name!==""&&(t.name=this.name),this.usage!==tu&&(t.usage=this.usage),t}}class _y extends Mi{constructor(t,e,r){super(new Uint16Array(t),e,r)}}class by extends Mi{constructor(t,e,r){super(new Uint32Array(t),e,r)}}class Ke extends Mi{constructor(t,e,r){super(new Float32Array(t),e,r)}}let vy=0;const ur=new we,So=new We,nn=new L,ar=new Ci,kn=new Ci,He=new L;class Vr extends Jn{constructor(){super(),this.isBufferGeometry=!0,Object.defineProperty(this,"id",{value:vy++}),this.uuid=pn(),this.name="",this.type="BufferGeometry",this.index=null,this.indirect=null,this.attributes={},this.morphAttributes={},this.morphTargetsRelative=!1,this.groups=[],this.boundingBox=null,this.boundingSphere=null,this.drawRange={start:0,count:1/0},this.userData={}}getIndex(){return this.index}setIndex(t){return Array.isArray(t)?this.index=new(ey(t)?by:_y)(t,1):this.index=t,this}setIndirect(t){return this.indirect=t,this}getIndirect(){return this.indirect}getAttribute(t){return this.attributes[t]}setAttribute(t,e){return this.attributes[t]=e,this}deleteAttribute(t){return delete this.attributes[t],this}hasAttribute(t){return this.attributes[t]!==void 0}addGroup(t,e,r=0){this.groups.push({start:t,count:e,materialIndex:r})}clearGroups(){this.groups=[]}setDrawRange(t,e){this.drawRange.start=t,this.drawRange.count=e}applyMatrix4(t){const e=this.attributes.position;e!==void 0&&(e.applyMatrix4(t),e.needsUpdate=!0);const r=this.attributes.normal;if(r!==void 0){const s=new Gr().getNormalMatrix(t);r.applyNormalMatrix(s),r.needsUpdate=!0}const i=this.attributes.tangent;return i!==void 0&&(i.transformDirection(t),i.needsUpdate=!0),this.boundingBox!==null&&this.computeBoundingBox(),this.boundingSphere!==null&&this.computeBoundingSphere(),this}applyQuaternion(t){return ur.makeRotationFromQuaternion(t),this.applyMatrix4(ur),this}rotateX(t){return ur.makeRotationX(t),this.applyMatrix4(ur),this}rotateY(t){return ur.makeRotationY(t),this.applyMatrix4(ur),this}rotateZ(t){return ur.makeRotationZ(t),this.applyMatrix4(ur),this}translate(t,e,r){return ur.makeTranslation(t,e,r),this.applyMatrix4(ur),this}scale(t,e,r){return ur.makeScale(t,e,r),this.applyMatrix4(ur),this}lookAt(t){return So.lookAt(t),So.updateMatrix(),this.applyMatrix4(So.matrix),this}center(){return this.computeBoundingBox(),this.boundingBox.getCenter(nn).negate(),this.translate(nn.x,nn.y,nn.z),this}setFromPoints(t){const e=this.getAttribute("position");if(e===void 0){const r=[];for(let i=0,s=t.length;i<s;i++){const a=t[i];r.push(a.x,a.y,a.z||0)}this.setAttribute("position",new Ke(r,3))}else{const r=Math.min(t.length,e.count);for(let i=0;i<r;i++){const s=t[i];e.setXYZ(i,s.x,s.y,s.z||0)}t.length>e.count&&console.warn("THREE.BufferGeometry: Buffer size too small for points data. Use .dispose() and create a new geometry."),e.needsUpdate=!0}return this}computeBoundingBox(){this.boundingBox===null&&(this.boundingBox=new Ci);const t=this.attributes.position,e=this.morphAttributes.position;if(t&&t.isGLBufferAttribute){console.error("THREE.BufferGeometry.computeBoundingBox(): GLBufferAttribute requires a manual bounding box.",this),this.boundingBox.set(new L(-1/0,-1/0,-1/0),new L(1/0,1/0,1/0));return}if(t!==void 0){if(this.boundingBox.setFromBufferAttribute(t),e)for(let r=0,i=e.length;r<i;r++){const s=e[r];ar.setFromBufferAttribute(s),this.morphTargetsRelative?(He.addVectors(this.boundingBox.min,ar.min),this.boundingBox.expandByPoint(He),He.addVectors(this.boundingBox.max,ar.max),this.boundingBox.expandByPoint(He)):(this.boundingBox.expandByPoint(ar.min),this.boundingBox.expandByPoint(ar.max))}}else this.boundingBox.makeEmpty();(isNaN(this.boundingBox.min.x)||isNaN(this.boundingBox.min.y)||isNaN(this.boundingBox.min.z))&&console.error('THREE.BufferGeometry.computeBoundingBox(): Computed min/max have NaN values. The "position" attribute is likely to have NaN values.',this)}computeBoundingSphere(){this.boundingSphere===null&&(this.boundingSphere=new Ii);const t=this.attributes.position,e=this.morphAttributes.position;if(t&&t.isGLBufferAttribute){console.error("THREE.BufferGeometry.computeBoundingSphere(): GLBufferAttribute requires a manual bounding sphere.",this),this.boundingSphere.set(new L,1/0);return}if(t){const r=this.boundingSphere.center;if(ar.setFromBufferAttribute(t),e)for(let s=0,a=e.length;s<a;s++){const o=e[s];kn.setFromBufferAttribute(o),this.morphTargetsRelative?(He.addVectors(ar.min,kn.min),ar.expandByPoint(He),He.addVectors(ar.max,kn.max),ar.expandByPoint(He)):(ar.expandByPoint(kn.min),ar.expandByPoint(kn.max))}ar.getCenter(r);let i=0;for(let s=0,a=t.count;s<a;s++)He.fromBufferAttribute(t,s),i=Math.max(i,r.distanceToSquared(He));if(e)for(let s=0,a=e.length;s<a;s++){const o=e[s],c=this.morphTargetsRelative;for(let h=0,u=o.count;h<u;h++)He.fromBufferAttribute(o,h),c&&(nn.fromBufferAttribute(t,h),He.add(nn)),i=Math.max(i,r.distanceToSquared(He))}this.boundingSphere.radius=Math.sqrt(i),isNaN(this.boundingSphere.radius)&&console.error('THREE.BufferGeometry.computeBoundingSphere(): Computed radius is NaN. The "position" attribute is likely to have NaN values.',this)}}computeTangents(){const t=this.index,e=this.attributes;if(t===null||e.position===void 0||e.normal===void 0||e.uv===void 0){console.error("THREE.BufferGeometry: .computeTangents() failed. Missing required attributes (index, position, normal or uv)");return}const r=e.position,i=e.normal,s=e.uv;this.hasAttribute("tangent")===!1&&this.setAttribute("tangent",new Mi(new Float32Array(4*r.count),4));const a=this.getAttribute("tangent"),o=[],c=[];for(let Dt=0;Dt<r.count;Dt++)o[Dt]=new L,c[Dt]=new L;const h=new L,u=new L,d=new L,x=new le,g=new le,A=new le,P=new L,H=new L;function V(Dt,Wt,se){h.fromBufferAttribute(r,Dt),u.fromBufferAttribute(r,Wt),d.fromBufferAttribute(r,se),x.fromBufferAttribute(s,Dt),g.fromBufferAttribute(s,Wt),A.fromBufferAttribute(s,se),u.sub(h),d.sub(h),g.sub(x),A.sub(x);const ce=1/(g.x*A.y-A.x*g.y);isFinite(ce)&&(P.copy(u).multiplyScalar(A.y).addScaledVector(d,-g.y).multiplyScalar(ce),H.copy(d).multiplyScalar(g.x).addScaledVector(u,-A.x).multiplyScalar(ce),o[Dt].add(P),o[Wt].add(P),o[se].add(P),c[Dt].add(H),c[Wt].add(H),c[se].add(H))}let At=this.groups;At.length===0&&(At=[{start:0,count:t.count}]);for(let Dt=0,Wt=At.length;Dt<Wt;++Dt){const se=At[Dt],ce=se.start,kt=se.count;for(let jt=ce,ee=ce+kt;jt<ee;jt+=3)V(t.getX(jt+0),t.getX(jt+1),t.getX(jt+2))}const tt=new L,lt=new L,wt=new L,Et=new L;function Lt(Dt){wt.fromBufferAttribute(i,Dt),Et.copy(wt);const Wt=o[Dt];tt.copy(Wt),tt.sub(wt.multiplyScalar(wt.dot(Wt))).normalize(),lt.crossVectors(Et,Wt);const ce=lt.dot(c[Dt])<0?-1:1;a.setXYZW(Dt,tt.x,tt.y,tt.z,ce)}for(let Dt=0,Wt=At.length;Dt<Wt;++Dt){const se=At[Dt],ce=se.start,kt=se.count;for(let jt=ce,ee=ce+kt;jt<ee;jt+=3)Lt(t.getX(jt+0)),Lt(t.getX(jt+1)),Lt(t.getX(jt+2))}}computeVertexNormals(){const t=this.index,e=this.getAttribute("position");if(e!==void 0){let r=this.getAttribute("normal");if(r===void 0)r=new Mi(new Float32Array(e.count*3),3),this.setAttribute("normal",r);else for(let x=0,g=r.count;x<g;x++)r.setXYZ(x,0,0,0);const i=new L,s=new L,a=new L,o=new L,c=new L,h=new L,u=new L,d=new L;if(t)for(let x=0,g=t.count;x<g;x+=3){const A=t.getX(x+0),P=t.getX(x+1),H=t.getX(x+2);i.fromBufferAttribute(e,A),s.fromBufferAttribute(e,P),a.fromBufferAttribute(e,H),u.subVectors(a,s),d.subVectors(i,s),u.cross(d),o.fromBufferAttribute(r,A),c.fromBufferAttribute(r,P),h.fromBufferAttribute(r,H),o.add(u),c.add(u),h.add(u),r.setXYZ(A,o.x,o.y,o.z),r.setXYZ(P,c.x,c.y,c.z),r.setXYZ(H,h.x,h.y,h.z)}else for(let x=0,g=e.count;x<g;x+=3)i.fromBufferAttribute(e,x+0),s.fromBufferAttribute(e,x+1),a.fromBufferAttribute(e,x+2),u.subVectors(a,s),d.subVectors(i,s),u.cross(d),r.setXYZ(x+0,u.x,u.y,u.z),r.setXYZ(x+1,u.x,u.y,u.z),r.setXYZ(x+2,u.x,u.y,u.z);this.normalizeNormals(),r.needsUpdate=!0}}normalizeNormals(){const t=this.attributes.normal;for(let e=0,r=t.count;e<r;e++)He.fromBufferAttribute(t,e),He.normalize(),t.setXYZ(e,He.x,He.y,He.z)}toNonIndexed(){function t(o,c){const h=o.array,u=o.itemSize,d=o.normalized,x=new h.constructor(c.length*u);let g=0,A=0;for(let P=0,H=c.length;P<H;P++){o.isInterleavedBufferAttribute?g=c[P]*o.data.stride+o.offset:g=c[P]*u;for(let V=0;V<u;V++)x[A++]=h[g++]}return new Mi(x,u,d)}if(this.index===null)return console.warn("THREE.BufferGeometry.toNonIndexed(): BufferGeometry is already non-indexed."),this;const e=new Vr,r=this.index.array,i=this.attributes;for(const o in i){const c=i[o],h=t(c,r);e.setAttribute(o,h)}const s=this.morphAttributes;for(const o in s){const c=[],h=s[o];for(let u=0,d=h.length;u<d;u++){const x=h[u],g=t(x,r);c.push(g)}e.morphAttributes[o]=c}e.morphTargetsRelative=this.morphTargetsRelative;const a=this.groups;for(let o=0,c=a.length;o<c;o++){const h=a[o];e.addGroup(h.start,h.count,h.materialIndex)}return e}toJSON(){const t={metadata:{version:4.7,type:"BufferGeometry",generator:"BufferGeometry.toJSON"}};if(t.uuid=this.uuid,t.type=this.type,this.name!==""&&(t.name=this.name),Object.keys(this.userData).length>0&&(t.userData=this.userData),this.parameters!==void 0){const c=this.parameters;for(const h in c)c[h]!==void 0&&(t[h]=c[h]);return t}t.data={attributes:{}};const e=this.index;e!==null&&(t.data.index={type:e.array.constructor.name,array:Array.prototype.slice.call(e.array)});const r=this.attributes;for(const c in r){const h=r[c];t.data.attributes[c]=h.toJSON(t.data)}const i={};let s=!1;for(const c in this.morphAttributes){const h=this.morphAttributes[c],u=[];for(let d=0,x=h.length;d<x;d++){const g=h[d];u.push(g.toJSON(t.data))}u.length>0&&(i[c]=u,s=!0)}s&&(t.data.morphAttributes=i,t.data.morphTargetsRelative=this.morphTargetsRelative);const a=this.groups;a.length>0&&(t.data.groups=JSON.parse(JSON.stringify(a)));const o=this.boundingSphere;return o!==null&&(t.data.boundingSphere=o.toJSON()),t}clone(){return new this.constructor().copy(this)}copy(t){this.index=null,this.attributes={},this.morphAttributes={},this.groups=[],this.boundingBox=null,this.boundingSphere=null;const e={};this.name=t.name;const r=t.index;r!==null&&this.setIndex(r.clone());const i=t.attributes;for(const h in i){const u=i[h];this.setAttribute(h,u.clone(e))}const s=t.morphAttributes;for(const h in s){const u=[],d=s[h];for(let x=0,g=d.length;x<g;x++)u.push(d[x].clone(e));this.morphAttributes[h]=u}this.morphTargetsRelative=t.morphTargetsRelative;const a=t.groups;for(let h=0,u=a.length;h<u;h++){const d=a[h];this.addGroup(d.start,d.count,d.materialIndex)}const o=t.boundingBox;o!==null&&(this.boundingBox=o.clone());const c=t.boundingSphere;return c!==null&&(this.boundingSphere=c.clone()),this.drawRange.start=t.drawRange.start,this.drawRange.count=t.drawRange.count,this.userData=t.userData,this}dispose(){this.dispatchEvent({type:"dispose"})}}const pu=new we,Ti=new Ho,Ps=new Ii,yu=new L,Bs=new L,ks=new L,zs=new L,wo=new L,Us=new L,xu=new L,Gs=new L;class Wo extends We{constructor(t=new Vr,e=new xy){super(),this.isMesh=!0,this.type="Mesh",this.geometry=t,this.material=e,this.morphTargetDictionary=void 0,this.morphTargetInfluences=void 0,this.count=1,this.updateMorphTargets()}copy(t,e){return super.copy(t,e),t.morphTargetInfluences!==void 0&&(this.morphTargetInfluences=t.morphTargetInfluences.slice()),t.morphTargetDictionary!==void 0&&(this.morphTargetDictionary=Object.assign({},t.morphTargetDictionary)),this.material=Array.isArray(t.material)?t.material.slice():t.material,this.geometry=t.geometry,this}updateMorphTargets(){const e=this.geometry.morphAttributes,r=Object.keys(e);if(r.length>0){const i=e[r[0]];if(i!==void 0){this.morphTargetInfluences=[],this.morphTargetDictionary={};for(let s=0,a=i.length;s<a;s++){const o=i[s].name||String(s);this.morphTargetInfluences.push(0),this.morphTargetDictionary[o]=s}}}}getVertexPosition(t,e){const r=this.geometry,i=r.attributes.position,s=r.morphAttributes.position,a=r.morphTargetsRelative;e.fromBufferAttribute(i,t);const o=this.morphTargetInfluences;if(s&&o){Us.set(0,0,0);for(let c=0,h=s.length;c<h;c++){const u=o[c],d=s[c];u!==0&&(wo.fromBufferAttribute(d,t),a?Us.addScaledVector(wo,u):Us.addScaledVector(wo.sub(e),u))}e.add(Us)}return e}raycast(t,e){const r=this.geometry,i=this.material,s=this.matrixWorld;i!==void 0&&(r.boundingSphere===null&&r.computeBoundingSphere(),Ps.copy(r.boundingSphere),Ps.applyMatrix4(s),Ti.copy(t.ray).recast(t.near),!(Ps.containsPoint(Ti.origin)===!1&&(Ti.intersectSphere(Ps,yu)===null||Ti.origin.distanceToSquared(yu)>(t.far-t.near)**2))&&(pu.copy(s).invert(),Ti.copy(t.ray).applyMatrix4(pu),!(r.boundingBox!==null&&Ti.intersectsBox(r.boundingBox)===!1)&&this._computeIntersections(t,e,Ti)))}_computeIntersections(t,e,r){let i;const s=this.geometry,a=this.material,o=s.index,c=s.attributes.position,h=s.attributes.uv,u=s.attributes.uv1,d=s.attributes.normal,x=s.groups,g=s.drawRange;if(o!==null)if(Array.isArray(a))for(let A=0,P=x.length;A<P;A++){const H=x[A],V=a[H.materialIndex],At=Math.max(H.start,g.start),tt=Math.min(o.count,Math.min(H.start+H.count,g.start+g.count));for(let lt=At,wt=tt;lt<wt;lt+=3){const Et=o.getX(lt),Lt=o.getX(lt+1),Dt=o.getX(lt+2);i=Vs(this,V,t,r,h,u,d,Et,Lt,Dt),i&&(i.faceIndex=Math.floor(lt/3),i.face.materialIndex=H.materialIndex,e.push(i))}}else{const A=Math.max(0,g.start),P=Math.min(o.count,g.start+g.count);for(let H=A,V=P;H<V;H+=3){const At=o.getX(H),tt=o.getX(H+1),lt=o.getX(H+2);i=Vs(this,a,t,r,h,u,d,At,tt,lt),i&&(i.faceIndex=Math.floor(H/3),e.push(i))}}else if(c!==void 0)if(Array.isArray(a))for(let A=0,P=x.length;A<P;A++){const H=x[A],V=a[H.materialIndex],At=Math.max(H.start,g.start),tt=Math.min(c.count,Math.min(H.start+H.count,g.start+g.count));for(let lt=At,wt=tt;lt<wt;lt+=3){const Et=lt,Lt=lt+1,Dt=lt+2;i=Vs(this,V,t,r,h,u,d,Et,Lt,Dt),i&&(i.faceIndex=Math.floor(lt/3),i.face.materialIndex=H.materialIndex,e.push(i))}}else{const A=Math.max(0,g.start),P=Math.min(c.count,g.start+g.count);for(let H=A,V=P;H<V;H+=3){const At=H,tt=H+1,lt=H+2;i=Vs(this,a,t,r,h,u,d,At,tt,lt),i&&(i.faceIndex=Math.floor(H/3),e.push(i))}}}}function Ey(n,t,e,r,i,s,a,o){let c;if(t.side===$u?c=r.intersectTriangle(a,s,i,!0,o):c=r.intersectTriangle(i,s,a,t.side===ko,o),c===null)return null;Gs.copy(o),Gs.applyMatrix4(n.matrixWorld);const h=e.ray.origin.distanceTo(Gs);return h<e.near||h>e.far?null:{distance:h,point:Gs.clone(),object:n}}function Vs(n,t,e,r,i,s,a,o,c,h){n.getVertexPosition(o,Bs),n.getVertexPosition(c,ks),n.getVertexPosition(h,zs);const u=Ey(n,t,e,r,Bs,ks,zs,xu);if(u){const d=new L;br.getBarycoord(xu,Bs,ks,zs,d),i&&(u.uv=br.getInterpolatedAttribute(i,o,c,h,d,new le)),s&&(u.uv1=br.getInterpolatedAttribute(s,o,c,h,d,new le)),a&&(u.normal=br.getInterpolatedAttribute(a,o,c,h,d,new L),u.normal.dot(r.direction)>0&&u.normal.multiplyScalar(-1));const x={a:o,b:c,c:h,normal:new L,materialIndex:0};br.getNormal(Bs,ks,zs,x.normal),u.face=x,u.barycoord=d}return u}class Yo extends Vr{constructor(t=1,e=1,r=1,i=1,s=1,a=1){super(),this.type="BoxGeometry",this.parameters={width:t,height:e,depth:r,widthSegments:i,heightSegments:s,depthSegments:a};const o=this;i=Math.floor(i),s=Math.floor(s),a=Math.floor(a);const c=[],h=[],u=[],d=[];let x=0,g=0;A("z","y","x",-1,-1,r,e,t,a,s,0),A("z","y","x",1,-1,r,e,-t,a,s,1),A("x","z","y",1,1,t,r,e,i,a,2),A("x","z","y",1,-1,t,r,-e,i,a,3),A("x","y","z",1,-1,t,e,r,i,s,4),A("x","y","z",-1,-1,t,e,-r,i,s,5),this.setIndex(c),this.setAttribute("position",new Ke(h,3)),this.setAttribute("normal",new Ke(u,3)),this.setAttribute("uv",new Ke(d,2));function A(P,H,V,At,tt,lt,wt,Et,Lt,Dt,Wt){const se=lt/Lt,ce=wt/Dt,kt=lt/2,jt=wt/2,ee=Et/2,Xt=Lt+1,$t=Dt+1;let de=0,me=0;const Kt=new L;for(let re=0;re<$t;re++){const ye=re*ce-jt;for(let ie=0;ie<Xt;ie++){const xe=ie*se-kt;Kt[P]=xe*At,Kt[H]=ye*tt,Kt[V]=ee,h.push(Kt.x,Kt.y,Kt.z),Kt[P]=0,Kt[H]=0,Kt[V]=Et>0?1:-1,u.push(Kt.x,Kt.y,Kt.z),d.push(ie/Lt),d.push(1-re/Dt),de+=1}}for(let re=0;re<Dt;re++)for(let ye=0;ye<Lt;ye++){const ie=x+ye+Xt*re,xe=x+ye+Xt*(re+1),_e=x+(ye+1)+Xt*(re+1),Ye=x+(ye+1)+Xt*re;c.push(ie,xe,Ye),c.push(xe,_e,Ye),me+=6}o.addGroup(g,me,Wt),g+=me,x+=de}}copy(t){return super.copy(t),this.parameters=Object.assign({},t.parameters),this}static fromJSON(t){return new Yo(t.width,t.height,t.depth,t.widthSegments,t.heightSegments,t.depthSegments)}}function oa(n){const t={};for(const e in n){t[e]={};for(const r in n[e]){const i=n[e][r];i&&(i.isColor||i.isMatrix3||i.isMatrix4||i.isVector2||i.isVector3||i.isVector4||i.isTexture||i.isQuaternion)?i.isRenderTargetTexture?(console.warn("UniformsUtils: Textures of render targets cannot be cloned via cloneUniforms() or mergeUniforms()."),t[e][r]=null):t[e][r]=i.clone():Array.isArray(i)?t[e][r]=i.slice():t[e][r]=i}}return t}function Ay(n){const t={};for(let e=0;e<n.length;e++){const r=oa(n[e]);for(const i in r)t[i]=r[i]}return t}function Ty(n){const t=[];for(let e=0;e<n.length;e++)t.push(n[e].clone());return t}function __(n){const t=n.getRenderTarget();return t===null?n.outputColorSpace:t.isXRRenderTarget===!0?t.texture.colorSpace:fr.workingColorSpace}const b_={clone:oa,merge:Ay};var Sy=`void main() {
	gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
}`,wy=`void main() {
	gl_FragColor = vec4( 1.0, 0.0, 0.0, 1.0 );
}`;class My extends Ri{constructor(t){super(),this.isShaderMaterial=!0,this.type="ShaderMaterial",this.defines={},this.uniforms={},this.uniformsGroups=[],this.vertexShader=Sy,this.fragmentShader=wy,this.linewidth=1,this.wireframe=!1,this.wireframeLinewidth=1,this.fog=!1,this.lights=!1,this.clipping=!1,this.forceSinglePass=!0,this.extensions={clipCullDistance:!1,multiDraw:!1},this.defaultAttributeValues={color:[1,1,1],uv:[0,0],uv1:[0,0]},this.index0AttributeName=void 0,this.uniformsNeedUpdate=!1,this.glslVersion=null,t!==void 0&&this.setValues(t)}copy(t){return super.copy(t),this.fragmentShader=t.fragmentShader,this.vertexShader=t.vertexShader,this.uniforms=oa(t.uniforms),this.uniformsGroups=Ty(t.uniformsGroups),this.defines=Object.assign({},t.defines),this.wireframe=t.wireframe,this.wireframeLinewidth=t.wireframeLinewidth,this.fog=t.fog,this.lights=t.lights,this.clipping=t.clipping,this.extensions=Object.assign({},t.extensions),this.glslVersion=t.glslVersion,this}toJSON(t){const e=super.toJSON(t);e.glslVersion=this.glslVersion,e.uniforms={};for(const i in this.uniforms){const a=this.uniforms[i].value;a&&a.isTexture?e.uniforms[i]={type:"t",value:a.toJSON(t).uuid}:a&&a.isColor?e.uniforms[i]={type:"c",value:a.getHex()}:a&&a.isVector2?e.uniforms[i]={type:"v2",value:a.toArray()}:a&&a.isVector3?e.uniforms[i]={type:"v3",value:a.toArray()}:a&&a.isVector4?e.uniforms[i]={type:"v4",value:a.toArray()}:a&&a.isMatrix3?e.uniforms[i]={type:"m3",value:a.toArray()}:a&&a.isMatrix4?e.uniforms[i]={type:"m4",value:a.toArray()}:e.uniforms[i]={value:a}}Object.keys(this.defines).length>0&&(e.defines=this.defines),e.vertexShader=this.vertexShader,e.fragmentShader=this.fragmentShader,e.lights=this.lights,e.clipping=this.clipping;const r={};for(const i in this.extensions)this.extensions[i]===!0&&(r[i]=!0);return Object.keys(r).length>0&&(e.extensions=r),e}}class rf extends We{constructor(){super(),this.isCamera=!0,this.type="Camera",this.matrixWorldInverse=new we,this.projectionMatrix=new we,this.projectionMatrixInverse=new we,this.coordinateSystem=si}copy(t,e){return super.copy(t,e),this.matrixWorldInverse.copy(t.matrixWorldInverse),this.projectionMatrix.copy(t.projectionMatrix),this.projectionMatrixInverse.copy(t.projectionMatrixInverse),this.coordinateSystem=t.coordinateSystem,this}getWorldDirection(t){return super.getWorldDirection(t).negate()}updateMatrixWorld(t){super.updateMatrixWorld(t),this.matrixWorldInverse.copy(this.matrixWorld).invert()}updateWorldMatrix(t,e){super.updateWorldMatrix(t,e),this.matrixWorldInverse.copy(this.matrixWorld).invert()}clone(){return new this.constructor().copy(this)}}const ii=new L,gu=new le,_u=new le;class ni extends rf{constructor(t=50,e=1,r=.1,i=2e3){super(),this.isPerspectiveCamera=!0,this.type="PerspectiveCamera",this.fov=t,this.zoom=1,this.near=r,this.far=i,this.focus=10,this.aspect=e,this.view=null,this.filmGauge=35,this.filmOffset=0,this.updateProjectionMatrix()}copy(t,e){return super.copy(t,e),this.fov=t.fov,this.zoom=t.zoom,this.near=t.near,this.far=t.far,this.focus=t.focus,this.aspect=t.aspect,this.view=t.view===null?null:Object.assign({},t.view),this.filmGauge=t.filmGauge,this.filmOffset=t.filmOffset,this}setFocalLength(t){const e=.5*this.getFilmHeight()/t;this.fov=ia*2*Math.atan(e),this.updateProjectionMatrix()}getFocalLength(){const t=Math.tan(Wn*.5*this.fov);return .5*this.getFilmHeight()/t}getEffectiveFOV(){return ia*2*Math.atan(Math.tan(Wn*.5*this.fov)/this.zoom)}getFilmWidth(){return this.filmGauge*Math.min(this.aspect,1)}getFilmHeight(){return this.filmGauge/Math.max(this.aspect,1)}getViewBounds(t,e,r){ii.set(-1,-1,.5).applyMatrix4(this.projectionMatrixInverse),e.set(ii.x,ii.y).multiplyScalar(-t/ii.z),ii.set(1,1,.5).applyMatrix4(this.projectionMatrixInverse),r.set(ii.x,ii.y).multiplyScalar(-t/ii.z)}getViewSize(t,e){return this.getViewBounds(t,gu,_u),e.subVectors(_u,gu)}setViewOffset(t,e,r,i,s,a){this.aspect=t/e,this.view===null&&(this.view={enabled:!0,fullWidth:1,fullHeight:1,offsetX:0,offsetY:0,width:1,height:1}),this.view.enabled=!0,this.view.fullWidth=t,this.view.fullHeight=e,this.view.offsetX=r,this.view.offsetY=i,this.view.width=s,this.view.height=a,this.updateProjectionMatrix()}clearViewOffset(){this.view!==null&&(this.view.enabled=!1),this.updateProjectionMatrix()}updateProjectionMatrix(){const t=this.near;let e=t*Math.tan(Wn*.5*this.fov)/this.zoom,r=2*e,i=this.aspect*r,s=-.5*i;const a=this.view;if(this.view!==null&&this.view.enabled){const c=a.fullWidth,h=a.fullHeight;s+=a.offsetX*i/c,e-=a.offsetY*r/h,i*=a.width/c,r*=a.height/h}const o=this.filmOffset;o!==0&&(s+=t*o/this.getFilmWidth()),this.projectionMatrix.makePerspective(s,s+i,e,e-r,t,this.far,this.coordinateSystem),this.projectionMatrixInverse.copy(this.projectionMatrix).invert()}toJSON(t){const e=super.toJSON(t);return e.object.fov=this.fov,e.object.zoom=this.zoom,e.object.near=this.near,e.object.far=this.far,e.object.focus=this.focus,e.object.aspect=this.aspect,this.view!==null&&(e.object.view=Object.assign({},this.view)),e.object.filmGauge=this.filmGauge,e.object.filmOffset=this.filmOffset,e}}const sn=-90,an=1;class Cy extends We{constructor(t,e,r){super(),this.type="CubeCamera",this.renderTarget=r,this.coordinateSystem=null,this.activeMipmapLevel=0;const i=new ni(sn,an,t,e);i.layers=this.layers,this.add(i);const s=new ni(sn,an,t,e);s.layers=this.layers,this.add(s);const a=new ni(sn,an,t,e);a.layers=this.layers,this.add(a);const o=new ni(sn,an,t,e);o.layers=this.layers,this.add(o);const c=new ni(sn,an,t,e);c.layers=this.layers,this.add(c);const h=new ni(sn,an,t,e);h.layers=this.layers,this.add(h)}updateCoordinateSystem(){const t=this.coordinateSystem,e=this.children.concat(),[r,i,s,a,o,c]=e;for(const h of e)this.remove(h);if(t===si)r.up.set(0,1,0),r.lookAt(1,0,0),i.up.set(0,1,0),i.lookAt(-1,0,0),s.up.set(0,0,-1),s.lookAt(0,1,0),a.up.set(0,0,1),a.lookAt(0,-1,0),o.up.set(0,1,0),o.lookAt(0,0,1),c.up.set(0,1,0),c.lookAt(0,0,-1);else if(t===ra)r.up.set(0,-1,0),r.lookAt(-1,0,0),i.up.set(0,-1,0),i.lookAt(1,0,0),s.up.set(0,0,1),s.lookAt(0,1,0),a.up.set(0,0,-1),a.lookAt(0,-1,0),o.up.set(0,-1,0),o.lookAt(0,0,1),c.up.set(0,-1,0),c.lookAt(0,0,-1);else throw new Error("THREE.CubeCamera.updateCoordinateSystem(): Invalid coordinate system: "+t);for(const h of e)this.add(h),h.updateMatrixWorld()}update(t,e){this.parent===null&&this.updateMatrixWorld();const{renderTarget:r,activeMipmapLevel:i}=this;this.coordinateSystem!==t.coordinateSystem&&(this.coordinateSystem=t.coordinateSystem,this.updateCoordinateSystem());const[s,a,o,c,h,u]=this.children,d=t.getRenderTarget(),x=t.getActiveCubeFace(),g=t.getActiveMipmapLevel(),A=t.xr.enabled;t.xr.enabled=!1;const P=r.texture.generateMipmaps;r.texture.generateMipmaps=!1,t.setRenderTarget(r,0,i),t.render(e,s),t.setRenderTarget(r,1,i),t.render(e,a),t.setRenderTarget(r,2,i),t.render(e,o),t.setRenderTarget(r,3,i),t.render(e,c),t.setRenderTarget(r,4,i),t.render(e,h),r.texture.generateMipmaps=P,t.setRenderTarget(r,5,i),t.render(e,u),t.setRenderTarget(d,x,g),t.xr.enabled=A,r.texture.needsPMREMUpdate=!0}}class Iy extends er{constructor(t=[],e=jp,r,i,s,a,o,c,h,u){super(t,e,r,i,s,a,o,c,h,u),this.isCubeTexture=!0,this.flipY=!1}get images(){return this.image}set images(t){this.image=t}}class v_ extends oy{constructor(t=1,e={}){super(t,t,e),this.isWebGLCubeRenderTarget=!0;const r={width:t,height:t,depth:1},i=[r,r,r,r,r,r];this.texture=new Iy(i),this._setTextureOptions(e),this.texture.isRenderTargetTexture=!0}fromEquirectangularTexture(t,e){this.texture.type=e.type,this.texture.colorSpace=e.colorSpace,this.texture.generateMipmaps=e.generateMipmaps,this.texture.minFilter=e.minFilter,this.texture.magFilter=e.magFilter;const r={uniforms:{tEquirect:{value:null}},vertexShader:`

				varying vec3 vWorldDirection;

				vec3 transformDirection( in vec3 dir, in mat4 matrix ) {

					return normalize( ( matrix * vec4( dir, 0.0 ) ).xyz );

				}

				void main() {

					vWorldDirection = transformDirection( position, modelMatrix );

					#include <begin_vertex>
					#include <project_vertex>

				}
			`,fragmentShader:`

				uniform sampler2D tEquirect;

				varying vec3 vWorldDirection;

				#include <common>

				void main() {

					vec3 direction = normalize( vWorldDirection );

					vec2 sampleUV = equirectUv( direction );

					gl_FragColor = texture2D( tEquirect, sampleUV );

				}
			`},i=new Yo(5,5,5),s=new My({name:"CubemapFromEquirect",uniforms:oa(r.uniforms),vertexShader:r.vertexShader,fragmentShader:r.fragmentShader,side:$u,blending:Gp});s.uniforms.tEquirect.value=e;const a=new Wo(i,s),o=e.minFilter;return e.minFilter===qu&&(e.minFilter=ea),new Cy(1,10,this).update(t,a),e.minFilter=o,a.geometry.dispose(),a.material.dispose(),this}clear(t,e=!0,r=!0,i=!0){const s=t.getRenderTarget();for(let a=0;a<6;a++)t.setRenderTarget(this,a),t.clear(e,r,i);t.setRenderTarget(s)}}class js extends We{constructor(){super(),this.isGroup=!0,this.type="Group"}}const Ry={type:"move"};class E_{constructor(){this._targetRay=null,this._grip=null,this._hand=null}getHandSpace(){return this._hand===null&&(this._hand=new js,this._hand.matrixAutoUpdate=!1,this._hand.visible=!1,this._hand.joints={},this._hand.inputState={pinching:!1}),this._hand}getTargetRaySpace(){return this._targetRay===null&&(this._targetRay=new js,this._targetRay.matrixAutoUpdate=!1,this._targetRay.visible=!1,this._targetRay.hasLinearVelocity=!1,this._targetRay.linearVelocity=new L,this._targetRay.hasAngularVelocity=!1,this._targetRay.angularVelocity=new L),this._targetRay}getGripSpace(){return this._grip===null&&(this._grip=new js,this._grip.matrixAutoUpdate=!1,this._grip.visible=!1,this._grip.hasLinearVelocity=!1,this._grip.linearVelocity=new L,this._grip.hasAngularVelocity=!1,this._grip.angularVelocity=new L),this._grip}dispatchEvent(t){return this._targetRay!==null&&this._targetRay.dispatchEvent(t),this._grip!==null&&this._grip.dispatchEvent(t),this._hand!==null&&this._hand.dispatchEvent(t),this}connect(t){if(t&&t.hand){const e=this._hand;if(e)for(const r of t.hand.values())this._getHandJoint(e,r)}return this.dispatchEvent({type:"connected",data:t}),this}disconnect(t){return this.dispatchEvent({type:"disconnected",data:t}),this._targetRay!==null&&(this._targetRay.visible=!1),this._grip!==null&&(this._grip.visible=!1),this._hand!==null&&(this._hand.visible=!1),this}update(t,e,r){let i=null,s=null,a=null;const o=this._targetRay,c=this._grip,h=this._hand;if(t&&e.session.visibilityState!=="visible-blurred"){if(h&&t.hand){a=!0;for(const P of t.hand.values()){const H=e.getJointPose(P,r),V=this._getHandJoint(h,P);H!==null&&(V.matrix.fromArray(H.transform.matrix),V.matrix.decompose(V.position,V.rotation,V.scale),V.matrixWorldNeedsUpdate=!0,V.jointRadius=H.radius),V.visible=H!==null}const u=h.joints["index-finger-tip"],d=h.joints["thumb-tip"],x=u.position.distanceTo(d.position),g=.02,A=.005;h.inputState.pinching&&x>g+A?(h.inputState.pinching=!1,this.dispatchEvent({type:"pinchend",handedness:t.handedness,target:this})):!h.inputState.pinching&&x<=g-A&&(h.inputState.pinching=!0,this.dispatchEvent({type:"pinchstart",handedness:t.handedness,target:this}))}else c!==null&&t.gripSpace&&(s=e.getPose(t.gripSpace,r),s!==null&&(c.matrix.fromArray(s.transform.matrix),c.matrix.decompose(c.position,c.rotation,c.scale),c.matrixWorldNeedsUpdate=!0,s.linearVelocity?(c.hasLinearVelocity=!0,c.linearVelocity.copy(s.linearVelocity)):c.hasLinearVelocity=!1,s.angularVelocity?(c.hasAngularVelocity=!0,c.angularVelocity.copy(s.angularVelocity)):c.hasAngularVelocity=!1));o!==null&&(i=e.getPose(t.targetRaySpace,r),i===null&&s!==null&&(i=s),i!==null&&(o.matrix.fromArray(i.transform.matrix),o.matrix.decompose(o.position,o.rotation,o.scale),o.matrixWorldNeedsUpdate=!0,i.linearVelocity?(o.hasLinearVelocity=!0,o.linearVelocity.copy(i.linearVelocity)):o.hasLinearVelocity=!1,i.angularVelocity?(o.hasAngularVelocity=!0,o.angularVelocity.copy(i.angularVelocity)):o.hasAngularVelocity=!1,this.dispatchEvent(Ry)))}return o!==null&&(o.visible=i!==null),c!==null&&(c.visible=s!==null),h!==null&&(h.visible=a!==null),this}_getHandJoint(t,e){if(t.joints[e.jointName]===void 0){const r=new js;r.matrixAutoUpdate=!1,r.visible=!1,t.joints[e.jointName]=r,t.add(r)}return t.joints[e.jointName]}}class nf{constructor(t,e=25e-5){this.isFogExp2=!0,this.name="",this.color=new vr(t),this.density=e}clone(){return new nf(this.color,this.density)}toJSON(){return{type:"FogExp2",name:this.name,color:this.color.getHex(),density:this.density}}}class sf{constructor(t,e=1,r=1e3){this.isFog=!0,this.name="",this.color=new vr(t),this.near=e,this.far=r}clone(){return new sf(this.color,this.near,this.far)}toJSON(){return{type:"Fog",name:this.name,color:this.color.getHex(),near:this.near,far:this.far}}}class A_ extends We{constructor(){super(),this.isScene=!0,this.type="Scene",this.background=null,this.environment=null,this.fog=null,this.backgroundBlurriness=0,this.backgroundIntensity=1,this.backgroundRotation=new li,this.environmentIntensity=1,this.environmentRotation=new li,this.overrideMaterial=null,typeof __THREE_DEVTOOLS__<"u"&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("observe",{detail:this}))}copy(t,e){return super.copy(t,e),t.background!==null&&(this.background=t.background.clone()),t.environment!==null&&(this.environment=t.environment.clone()),t.fog!==null&&(this.fog=t.fog.clone()),this.backgroundBlurriness=t.backgroundBlurriness,this.backgroundIntensity=t.backgroundIntensity,this.backgroundRotation.copy(t.backgroundRotation),this.environmentIntensity=t.environmentIntensity,this.environmentRotation.copy(t.environmentRotation),t.overrideMaterial!==null&&(this.overrideMaterial=t.overrideMaterial.clone()),this.matrixAutoUpdate=t.matrixAutoUpdate,this}toJSON(t){const e=super.toJSON(t);return this.fog!==null&&(e.object.fog=this.fog.toJSON()),this.backgroundBlurriness>0&&(e.object.backgroundBlurriness=this.backgroundBlurriness),this.backgroundIntensity!==1&&(e.object.backgroundIntensity=this.backgroundIntensity),e.object.backgroundRotation=this.backgroundRotation.toArray(),this.environmentIntensity!==1&&(e.object.environmentIntensity=this.environmentIntensity),e.object.environmentRotation=this.environmentRotation.toArray(),e}}class Oy extends er{constructor(t=null,e=1,r=1,i,s,a,o,c,h=oi,u=oi,d,x){super(null,a,o,c,h,u,i,s,d,x),this.isDataTexture=!0,this.image={data:t,width:e,height:r},this.generateMipmaps=!1,this.flipY=!1,this.unpackAlignment=1}}class bu extends Mi{constructor(t,e,r,i=1){super(t,e,r),this.isInstancedBufferAttribute=!0,this.meshPerAttribute=i}copy(t){return super.copy(t),this.meshPerAttribute=t.meshPerAttribute,this}toJSON(){const t=super.toJSON();return t.meshPerAttribute=this.meshPerAttribute,t.isInstancedBufferAttribute=!0,t}}const on=new we,vu=new we,Hs=[],Eu=new Ci,Ny=new we,zn=new Wo,Un=new Ii;class T_ extends Wo{constructor(t,e,r){super(t,e),this.isInstancedMesh=!0,this.instanceMatrix=new bu(new Float32Array(r*16),16),this.instanceColor=null,this.morphTexture=null,this.count=r,this.boundingBox=null,this.boundingSphere=null;for(let i=0;i<r;i++)this.setMatrixAt(i,Ny)}computeBoundingBox(){const t=this.geometry,e=this.count;this.boundingBox===null&&(this.boundingBox=new Ci),t.boundingBox===null&&t.computeBoundingBox(),this.boundingBox.makeEmpty();for(let r=0;r<e;r++)this.getMatrixAt(r,on),Eu.copy(t.boundingBox).applyMatrix4(on),this.boundingBox.union(Eu)}computeBoundingSphere(){const t=this.geometry,e=this.count;this.boundingSphere===null&&(this.boundingSphere=new Ii),t.boundingSphere===null&&t.computeBoundingSphere(),this.boundingSphere.makeEmpty();for(let r=0;r<e;r++)this.getMatrixAt(r,on),Un.copy(t.boundingSphere).applyMatrix4(on),this.boundingSphere.union(Un)}copy(t,e){return super.copy(t,e),this.instanceMatrix.copy(t.instanceMatrix),t.morphTexture!==null&&(this.morphTexture=t.morphTexture.clone()),t.instanceColor!==null&&(this.instanceColor=t.instanceColor.clone()),this.count=t.count,t.boundingBox!==null&&(this.boundingBox=t.boundingBox.clone()),t.boundingSphere!==null&&(this.boundingSphere=t.boundingSphere.clone()),this}getColorAt(t,e){e.fromArray(this.instanceColor.array,t*3)}getMatrixAt(t,e){e.fromArray(this.instanceMatrix.array,t*16)}getMorphAt(t,e){const r=e.morphTargetInfluences,i=this.morphTexture.source.data.data,s=r.length+1,a=t*s+1;for(let o=0;o<r.length;o++)r[o]=i[a+o]}raycast(t,e){const r=this.matrixWorld,i=this.count;if(zn.geometry=this.geometry,zn.material=this.material,zn.material!==void 0&&(this.boundingSphere===null&&this.computeBoundingSphere(),Un.copy(this.boundingSphere),Un.applyMatrix4(r),t.ray.intersectsSphere(Un)!==!1))for(let s=0;s<i;s++){this.getMatrixAt(s,on),vu.multiplyMatrices(r,on),zn.matrixWorld=vu,zn.raycast(t,Hs);for(let a=0,o=Hs.length;a<o;a++){const c=Hs[a];c.instanceId=s,c.object=this,e.push(c)}Hs.length=0}}setColorAt(t,e){this.instanceColor===null&&(this.instanceColor=new bu(new Float32Array(this.instanceMatrix.count*3).fill(1),3)),e.toArray(this.instanceColor.array,t*3)}setMatrixAt(t,e){e.toArray(this.instanceMatrix.array,t*16)}setMorphAt(t,e){const r=e.morphTargetInfluences,i=r.length+1;this.morphTexture===null&&(this.morphTexture=new Oy(new Float32Array(i*this.count),i,this.count,Qu,Go));const s=this.morphTexture.source.data.data;let a=0;for(let h=0;h<r.length;h++)a+=r[h];const o=this.geometry.morphTargetsRelative?1:1-a,c=i*t;s[c]=o,s.set(r,c+1)}updateMorphTargets(){}dispose(){this.dispatchEvent({type:"dispose"}),this.morphTexture!==null&&(this.morphTexture.dispose(),this.morphTexture=null)}}const Mo=new L,Ly=new L,Dy=new Gr;class ln{constructor(t=new L(1,0,0),e=0){this.isPlane=!0,this.normal=t,this.constant=e}set(t,e){return this.normal.copy(t),this.constant=e,this}setComponents(t,e,r,i){return this.normal.set(t,e,r),this.constant=i,this}setFromNormalAndCoplanarPoint(t,e){return this.normal.copy(t),this.constant=-e.dot(this.normal),this}setFromCoplanarPoints(t,e,r){const i=Mo.subVectors(r,e).cross(Ly.subVectors(t,e)).normalize();return this.setFromNormalAndCoplanarPoint(i,t),this}copy(t){return this.normal.copy(t.normal),this.constant=t.constant,this}normalize(){const t=1/this.normal.length();return this.normal.multiplyScalar(t),this.constant*=t,this}negate(){return this.constant*=-1,this.normal.negate(),this}distanceToPoint(t){return this.normal.dot(t)+this.constant}distanceToSphere(t){return this.distanceToPoint(t.center)-t.radius}projectPoint(t,e){return e.copy(t).addScaledVector(this.normal,-this.distanceToPoint(t))}intersectLine(t,e){const r=t.delta(Mo),i=this.normal.dot(r);if(i===0)return this.distanceToPoint(t.start)===0?e.copy(t.start):null;const s=-(t.start.dot(this.normal)+this.constant)/i;return s<0||s>1?null:e.copy(t.start).addScaledVector(r,s)}intersectsLine(t){const e=this.distanceToPoint(t.start),r=this.distanceToPoint(t.end);return e<0&&r>0||r<0&&e>0}intersectsBox(t){return t.intersectsPlane(this)}intersectsSphere(t){return t.intersectsPlane(this)}coplanarPoint(t){return t.copy(this.normal).multiplyScalar(-this.constant)}applyMatrix4(t,e){const r=e||Dy.getNormalMatrix(t),i=this.coplanarPoint(Mo).applyMatrix4(t),s=this.normal.applyMatrix3(r).normalize();return this.constant=-i.dot(s),this}translate(t){return this.constant-=t.dot(this.normal),this}equals(t){return t.normal.equals(this.normal)&&t.constant===this.constant}clone(){return new this.constructor().copy(this)}}const Si=new Ii,Fy=new le(.5,.5),Ws=new L;class Py{constructor(t=new ln,e=new ln,r=new ln,i=new ln,s=new ln,a=new ln){this.planes=[t,e,r,i,s,a]}set(t,e,r,i,s,a){const o=this.planes;return o[0].copy(t),o[1].copy(e),o[2].copy(r),o[3].copy(i),o[4].copy(s),o[5].copy(a),this}copy(t){const e=this.planes;for(let r=0;r<6;r++)e[r].copy(t.planes[r]);return this}setFromProjectionMatrix(t,e=si){const r=this.planes,i=t.elements,s=i[0],a=i[1],o=i[2],c=i[3],h=i[4],u=i[5],d=i[6],x=i[7],g=i[8],A=i[9],P=i[10],H=i[11],V=i[12],At=i[13],tt=i[14],lt=i[15];if(r[0].setComponents(c-s,x-h,H-g,lt-V).normalize(),r[1].setComponents(c+s,x+h,H+g,lt+V).normalize(),r[2].setComponents(c+a,x+u,H+A,lt+At).normalize(),r[3].setComponents(c-a,x-u,H-A,lt-At).normalize(),r[4].setComponents(c-o,x-d,H-P,lt-tt).normalize(),e===si)r[5].setComponents(c+o,x+d,H+P,lt+tt).normalize();else if(e===ra)r[5].setComponents(o,d,P,tt).normalize();else throw new Error("THREE.Frustum.setFromProjectionMatrix(): Invalid coordinate system: "+e);return this}intersectsObject(t){if(t.boundingSphere!==void 0)t.boundingSphere===null&&t.computeBoundingSphere(),Si.copy(t.boundingSphere).applyMatrix4(t.matrixWorld);else{const e=t.geometry;e.boundingSphere===null&&e.computeBoundingSphere(),Si.copy(e.boundingSphere).applyMatrix4(t.matrixWorld)}return this.intersectsSphere(Si)}intersectsSprite(t){Si.center.set(0,0,0);const e=Fy.distanceTo(t.center);return Si.radius=.7071067811865476+e,Si.applyMatrix4(t.matrixWorld),this.intersectsSphere(Si)}intersectsSphere(t){const e=this.planes,r=t.center,i=-t.radius;for(let s=0;s<6;s++)if(e[s].distanceToPoint(r)<i)return!1;return!0}intersectsBox(t){const e=this.planes;for(let r=0;r<6;r++){const i=e[r];if(Ws.x=i.normal.x>0?t.max.x:t.min.x,Ws.y=i.normal.y>0?t.max.y:t.min.y,Ws.z=i.normal.z>0?t.max.z:t.min.z,i.distanceToPoint(Ws)<0)return!1}return!0}containsPoint(t){const e=this.planes;for(let r=0;r<6;r++)if(e[r].distanceToPoint(t)<0)return!1;return!0}clone(){return new this.constructor().copy(this)}}class By extends Ri{constructor(t){super(),this.isLineBasicMaterial=!0,this.type="LineBasicMaterial",this.color=new vr(16777215),this.map=null,this.linewidth=1,this.linecap="round",this.linejoin="round",this.fog=!0,this.setValues(t)}copy(t){return super.copy(t),this.color.copy(t.color),this.map=t.map,this.linewidth=t.linewidth,this.linecap=t.linecap,this.linejoin=t.linejoin,this.fog=t.fog,this}}const sa=new L,aa=new L,Au=new we,Gn=new Ho,Ys=new Ii,Co=new L,Tu=new L;class ky extends We{constructor(t=new Vr,e=new By){super(),this.isLine=!0,this.type="Line",this.geometry=t,this.material=e,this.morphTargetDictionary=void 0,this.morphTargetInfluences=void 0,this.updateMorphTargets()}copy(t,e){return super.copy(t,e),this.material=Array.isArray(t.material)?t.material.slice():t.material,this.geometry=t.geometry,this}computeLineDistances(){const t=this.geometry;if(t.index===null){const e=t.attributes.position,r=[0];for(let i=1,s=e.count;i<s;i++)sa.fromBufferAttribute(e,i-1),aa.fromBufferAttribute(e,i),r[i]=r[i-1],r[i]+=sa.distanceTo(aa);t.setAttribute("lineDistance",new Ke(r,1))}else console.warn("THREE.Line.computeLineDistances(): Computation only possible with non-indexed BufferGeometry.");return this}raycast(t,e){const r=this.geometry,i=this.matrixWorld,s=t.params.Line.threshold,a=r.drawRange;if(r.boundingSphere===null&&r.computeBoundingSphere(),Ys.copy(r.boundingSphere),Ys.applyMatrix4(i),Ys.radius+=s,t.ray.intersectsSphere(Ys)===!1)return;Au.copy(i).invert(),Gn.copy(t.ray).applyMatrix4(Au);const o=s/((this.scale.x+this.scale.y+this.scale.z)/3),c=o*o,h=this.isLineSegments?2:1,u=r.index,x=r.attributes.position;if(u!==null){const g=Math.max(0,a.start),A=Math.min(u.count,a.start+a.count);for(let P=g,H=A-1;P<H;P+=h){const V=u.getX(P),At=u.getX(P+1),tt=Xs(this,t,Gn,c,V,At,P);tt&&e.push(tt)}if(this.isLineLoop){const P=u.getX(A-1),H=u.getX(g),V=Xs(this,t,Gn,c,P,H,A-1);V&&e.push(V)}}else{const g=Math.max(0,a.start),A=Math.min(x.count,a.start+a.count);for(let P=g,H=A-1;P<H;P+=h){const V=Xs(this,t,Gn,c,P,P+1,P);V&&e.push(V)}if(this.isLineLoop){const P=Xs(this,t,Gn,c,A-1,g,A-1);P&&e.push(P)}}}updateMorphTargets(){const e=this.geometry.morphAttributes,r=Object.keys(e);if(r.length>0){const i=e[r[0]];if(i!==void 0){this.morphTargetInfluences=[],this.morphTargetDictionary={};for(let s=0,a=i.length;s<a;s++){const o=i[s].name||String(s);this.morphTargetInfluences.push(0),this.morphTargetDictionary[o]=s}}}}}function Xs(n,t,e,r,i,s,a){const o=n.geometry.attributes.position;if(sa.fromBufferAttribute(o,i),aa.fromBufferAttribute(o,s),e.distanceSqToSegment(sa,aa,Co,Tu)>r)return;Co.applyMatrix4(n.matrixWorld);const h=t.ray.origin.distanceTo(Co);if(!(h<t.near||h>t.far))return{distance:h,point:Tu.clone().applyMatrix4(n.matrixWorld),index:a,face:null,faceIndex:null,barycoord:null,object:n}}const Su=new L,wu=new L;class S_ extends ky{constructor(t,e){super(t,e),this.isLineSegments=!0,this.type="LineSegments"}computeLineDistances(){const t=this.geometry;if(t.index===null){const e=t.attributes.position,r=[];for(let i=0,s=e.count;i<s;i+=2)Su.fromBufferAttribute(e,i),wu.fromBufferAttribute(e,i+1),r[i]=i===0?0:r[i-1],r[i+1]=r[i]+Su.distanceTo(wu);t.setAttribute("lineDistance",new Ke(r,1))}else console.warn("THREE.LineSegments.computeLineDistances(): Computation only possible with non-indexed BufferGeometry.");return this}}class zy extends Ri{constructor(t){super(),this.isPointsMaterial=!0,this.type="PointsMaterial",this.color=new vr(16777215),this.map=null,this.alphaMap=null,this.size=1,this.sizeAttenuation=!0,this.fog=!0,this.setValues(t)}copy(t){return super.copy(t),this.color.copy(t.color),this.map=t.map,this.alphaMap=t.alphaMap,this.size=t.size,this.sizeAttenuation=t.sizeAttenuation,this.fog=t.fog,this}}const Mu=new we,zo=new Ho,$s=new Ii,Js=new L;class w_ extends We{constructor(t=new Vr,e=new zy){super(),this.isPoints=!0,this.type="Points",this.geometry=t,this.material=e,this.morphTargetDictionary=void 0,this.morphTargetInfluences=void 0,this.updateMorphTargets()}copy(t,e){return super.copy(t,e),this.material=Array.isArray(t.material)?t.material.slice():t.material,this.geometry=t.geometry,this}raycast(t,e){const r=this.geometry,i=this.matrixWorld,s=t.params.Points.threshold,a=r.drawRange;if(r.boundingSphere===null&&r.computeBoundingSphere(),$s.copy(r.boundingSphere),$s.applyMatrix4(i),$s.radius+=s,t.ray.intersectsSphere($s)===!1)return;Mu.copy(i).invert(),zo.copy(t.ray).applyMatrix4(Mu);const o=s/((this.scale.x+this.scale.y+this.scale.z)/3),c=o*o,h=r.index,d=r.attributes.position;if(h!==null){const x=Math.max(0,a.start),g=Math.min(h.count,a.start+a.count);for(let A=x,P=g;A<P;A++){const H=h.getX(A);Js.fromBufferAttribute(d,H),Cu(Js,H,c,i,t,e,this)}}else{const x=Math.max(0,a.start),g=Math.min(d.count,a.start+a.count);for(let A=x,P=g;A<P;A++)Js.fromBufferAttribute(d,A),Cu(Js,A,c,i,t,e,this)}}updateMorphTargets(){const e=this.geometry.morphAttributes,r=Object.keys(e);if(r.length>0){const i=e[r[0]];if(i!==void 0){this.morphTargetInfluences=[],this.morphTargetDictionary={};for(let s=0,a=i.length;s<a;s++){const o=i[s].name||String(s);this.morphTargetInfluences.push(0),this.morphTargetDictionary[o]=s}}}}}function Cu(n,t,e,r,i,s,a){const o=zo.distanceSqToPoint(n);if(o<e){const c=new L;zo.closestPointToPoint(n,c),c.applyMatrix4(r);const h=i.ray.origin.distanceTo(c);if(h<i.near||h>i.far)return;s.push({distance:h,distanceToRay:Math.sqrt(o),point:c,index:t,face:null,faceIndex:null,barycoord:null,object:a})}}class M_ extends er{constructor(t,e,r=Zu,i,s,a,o=oi,c=oi,h,u=qh,d=1){if(u!==qh&&u!==t0)throw new Error("DepthTexture format must be either THREE.DepthFormat or THREE.DepthStencilFormat");const x={width:t,height:e,depth:d};super(x,i,s,a,o,c,u,r,h),this.isDepthTexture=!0,this.flipY=!1,this.generateMipmaps=!1,this.compareFunction=null}copy(t){return super.copy(t),this.source=new jo(Object.assign({},t.image)),this.compareFunction=t.compareFunction,this}toJSON(t){const e=super.toJSON(t);return this.compareFunction!==null&&(e.compareFunction=this.compareFunction),e}}class jr{constructor(){this.type="Curve",this.arcLengthDivisions=200,this.needsUpdate=!1,this.cacheArcLengths=null}getPoint(){console.warn("THREE.Curve: .getPoint() not implemented.")}getPointAt(t,e){const r=this.getUtoTmapping(t);return this.getPoint(r,e)}getPoints(t=5){const e=[];for(let r=0;r<=t;r++)e.push(this.getPoint(r/t));return e}getSpacedPoints(t=5){const e=[];for(let r=0;r<=t;r++)e.push(this.getPointAt(r/t));return e}getLength(){const t=this.getLengths();return t[t.length-1]}getLengths(t=this.arcLengthDivisions){if(this.cacheArcLengths&&this.cacheArcLengths.length===t+1&&!this.needsUpdate)return this.cacheArcLengths;this.needsUpdate=!1;const e=[];let r,i=this.getPoint(0),s=0;e.push(0);for(let a=1;a<=t;a++)r=this.getPoint(a/t),s+=r.distanceTo(i),e.push(s),i=r;return this.cacheArcLengths=e,e}updateArcLengths(){this.needsUpdate=!0,this.getLengths()}getUtoTmapping(t,e=null){const r=this.getLengths();let i=0;const s=r.length;let a;e?a=e:a=t*r[s-1];let o=0,c=s-1,h;for(;o<=c;)if(i=Math.floor(o+(c-o)/2),h=r[i]-a,h<0)o=i+1;else if(h>0)c=i-1;else{c=i;break}if(i=c,r[i]===a)return i/(s-1);const u=r[i],x=r[i+1]-u,g=(a-u)/x;return(i+g)/(s-1)}getTangent(t,e){let i=t-1e-4,s=t+1e-4;i<0&&(i=0),s>1&&(s=1);const a=this.getPoint(i),o=this.getPoint(s),c=e||(a.isVector2?new le:new L);return c.copy(o).sub(a).normalize(),c}getTangentAt(t,e){const r=this.getUtoTmapping(t);return this.getTangent(r,e)}computeFrenetFrames(t,e=!1){const r=new L,i=[],s=[],a=[],o=new L,c=new we;for(let g=0;g<=t;g++){const A=g/t;i[g]=this.getTangentAt(A,new L)}s[0]=new L,a[0]=new L;let h=Number.MAX_VALUE;const u=Math.abs(i[0].x),d=Math.abs(i[0].y),x=Math.abs(i[0].z);u<=h&&(h=u,r.set(1,0,0)),d<=h&&(h=d,r.set(0,1,0)),x<=h&&r.set(0,0,1),o.crossVectors(i[0],r).normalize(),s[0].crossVectors(i[0],o),a[0].crossVectors(i[0],s[0]);for(let g=1;g<=t;g++){if(s[g]=s[g-1].clone(),a[g]=a[g-1].clone(),o.crossVectors(i[g-1],i[g]),o.length()>Number.EPSILON){o.normalize();const A=Math.acos(ae(i[g-1].dot(i[g]),-1,1));s[g].applyMatrix4(c.makeRotationAxis(o,A))}a[g].crossVectors(i[g],s[g])}if(e===!0){let g=Math.acos(ae(s[0].dot(s[t]),-1,1));g/=t,i[0].dot(o.crossVectors(s[0],s[t]))>0&&(g=-g);for(let A=1;A<=t;A++)s[A].applyMatrix4(c.makeRotationAxis(i[A],g*A)),a[A].crossVectors(i[A],s[A])}return{tangents:i,normals:s,binormals:a}}clone(){return new this.constructor().copy(this)}copy(t){return this.arcLengthDivisions=t.arcLengthDivisions,this}toJSON(){const t={metadata:{version:4.7,type:"Curve",generator:"Curve.toJSON"}};return t.arcLengthDivisions=this.arcLengthDivisions,t.type=this.type,t}fromJSON(t){return this.arcLengthDivisions=t.arcLengthDivisions,this}}class af extends jr{constructor(t=0,e=0,r=1,i=1,s=0,a=Math.PI*2,o=!1,c=0){super(),this.isEllipseCurve=!0,this.type="EllipseCurve",this.aX=t,this.aY=e,this.xRadius=r,this.yRadius=i,this.aStartAngle=s,this.aEndAngle=a,this.aClockwise=o,this.aRotation=c}getPoint(t,e=new le){const r=e,i=Math.PI*2;let s=this.aEndAngle-this.aStartAngle;const a=Math.abs(s)<Number.EPSILON;for(;s<0;)s+=i;for(;s>i;)s-=i;s<Number.EPSILON&&(a?s=0:s=i),this.aClockwise===!0&&!a&&(s===i?s=-i:s=s-i);const o=this.aStartAngle+t*s;let c=this.aX+this.xRadius*Math.cos(o),h=this.aY+this.yRadius*Math.sin(o);if(this.aRotation!==0){const u=Math.cos(this.aRotation),d=Math.sin(this.aRotation),x=c-this.aX,g=h-this.aY;c=x*u-g*d+this.aX,h=x*d+g*u+this.aY}return r.set(c,h)}copy(t){return super.copy(t),this.aX=t.aX,this.aY=t.aY,this.xRadius=t.xRadius,this.yRadius=t.yRadius,this.aStartAngle=t.aStartAngle,this.aEndAngle=t.aEndAngle,this.aClockwise=t.aClockwise,this.aRotation=t.aRotation,this}toJSON(){const t=super.toJSON();return t.aX=this.aX,t.aY=this.aY,t.xRadius=this.xRadius,t.yRadius=this.yRadius,t.aStartAngle=this.aStartAngle,t.aEndAngle=this.aEndAngle,t.aClockwise=this.aClockwise,t.aRotation=this.aRotation,t}fromJSON(t){return super.fromJSON(t),this.aX=t.aX,this.aY=t.aY,this.xRadius=t.xRadius,this.yRadius=t.yRadius,this.aStartAngle=t.aStartAngle,this.aEndAngle=t.aEndAngle,this.aClockwise=t.aClockwise,this.aRotation=t.aRotation,this}}class Uy extends af{constructor(t,e,r,i,s,a){super(t,e,r,r,i,s,a),this.isArcCurve=!0,this.type="ArcCurve"}}function Xo(){let n=0,t=0,e=0,r=0;function i(s,a,o,c){n=s,t=o,e=-3*s+3*a-2*o-c,r=2*s-2*a+o+c}return{initCatmullRom:function(s,a,o,c,h){i(a,o,h*(o-s),h*(c-a))},initNonuniformCatmullRom:function(s,a,o,c,h,u,d){let x=(a-s)/h-(o-s)/(h+u)+(o-a)/u,g=(o-a)/u-(c-a)/(u+d)+(c-o)/d;x*=u,g*=u,i(a,o,x,g)},calc:function(s){const a=s*s,o=a*s;return n+t*s+e*a+r*o}}}const qs=new L,Io=new Xo,Ro=new Xo,Oo=new Xo;class Gy extends jr{constructor(t=[],e=!1,r="centripetal",i=.5){super(),this.isCatmullRomCurve3=!0,this.type="CatmullRomCurve3",this.points=t,this.closed=e,this.curveType=r,this.tension=i}getPoint(t,e=new L){const r=e,i=this.points,s=i.length,a=(s-(this.closed?0:1))*t;let o=Math.floor(a),c=a-o;this.closed?o+=o>0?0:(Math.floor(Math.abs(o)/s)+1)*s:c===0&&o===s-1&&(o=s-2,c=1);let h,u;this.closed||o>0?h=i[(o-1)%s]:(qs.subVectors(i[0],i[1]).add(i[0]),h=qs);const d=i[o%s],x=i[(o+1)%s];if(this.closed||o+2<s?u=i[(o+2)%s]:(qs.subVectors(i[s-1],i[s-2]).add(i[s-1]),u=qs),this.curveType==="centripetal"||this.curveType==="chordal"){const g=this.curveType==="chordal"?.5:.25;let A=Math.pow(h.distanceToSquared(d),g),P=Math.pow(d.distanceToSquared(x),g),H=Math.pow(x.distanceToSquared(u),g);P<1e-4&&(P=1),A<1e-4&&(A=P),H<1e-4&&(H=P),Io.initNonuniformCatmullRom(h.x,d.x,x.x,u.x,A,P,H),Ro.initNonuniformCatmullRom(h.y,d.y,x.y,u.y,A,P,H),Oo.initNonuniformCatmullRom(h.z,d.z,x.z,u.z,A,P,H)}else this.curveType==="catmullrom"&&(Io.initCatmullRom(h.x,d.x,x.x,u.x,this.tension),Ro.initCatmullRom(h.y,d.y,x.y,u.y,this.tension),Oo.initCatmullRom(h.z,d.z,x.z,u.z,this.tension));return r.set(Io.calc(c),Ro.calc(c),Oo.calc(c)),r}copy(t){super.copy(t),this.points=[];for(let e=0,r=t.points.length;e<r;e++){const i=t.points[e];this.points.push(i.clone())}return this.closed=t.closed,this.curveType=t.curveType,this.tension=t.tension,this}toJSON(){const t=super.toJSON();t.points=[];for(let e=0,r=this.points.length;e<r;e++){const i=this.points[e];t.points.push(i.toArray())}return t.closed=this.closed,t.curveType=this.curveType,t.tension=this.tension,t}fromJSON(t){super.fromJSON(t),this.points=[];for(let e=0,r=t.points.length;e<r;e++){const i=t.points[e];this.points.push(new L().fromArray(i))}return this.closed=t.closed,this.curveType=t.curveType,this.tension=t.tension,this}}function Iu(n,t,e,r,i){const s=(r-t)*.5,a=(i-e)*.5,o=n*n,c=n*o;return(2*e-2*r+s+a)*c+(-3*e+3*r-2*s-a)*o+s*n+e}function Vy(n,t){const e=1-n;return e*e*t}function jy(n,t){return 2*(1-n)*n*t}function Hy(n,t){return n*n*t}function Xn(n,t,e,r){return Vy(n,t)+jy(n,e)+Hy(n,r)}function Wy(n,t){const e=1-n;return e*e*e*t}function Yy(n,t){const e=1-n;return 3*e*e*n*t}function Xy(n,t){return 3*(1-n)*n*n*t}function $y(n,t){return n*n*n*t}function $n(n,t,e,r,i){return Wy(n,t)+Yy(n,e)+Xy(n,r)+$y(n,i)}class Jy extends jr{constructor(t=new le,e=new le,r=new le,i=new le){super(),this.isCubicBezierCurve=!0,this.type="CubicBezierCurve",this.v0=t,this.v1=e,this.v2=r,this.v3=i}getPoint(t,e=new le){const r=e,i=this.v0,s=this.v1,a=this.v2,o=this.v3;return r.set($n(t,i.x,s.x,a.x,o.x),$n(t,i.y,s.y,a.y,o.y)),r}copy(t){return super.copy(t),this.v0.copy(t.v0),this.v1.copy(t.v1),this.v2.copy(t.v2),this.v3.copy(t.v3),this}toJSON(){const t=super.toJSON();return t.v0=this.v0.toArray(),t.v1=this.v1.toArray(),t.v2=this.v2.toArray(),t.v3=this.v3.toArray(),t}fromJSON(t){return super.fromJSON(t),this.v0.fromArray(t.v0),this.v1.fromArray(t.v1),this.v2.fromArray(t.v2),this.v3.fromArray(t.v3),this}}class qy extends jr{constructor(t=new L,e=new L,r=new L,i=new L){super(),this.isCubicBezierCurve3=!0,this.type="CubicBezierCurve3",this.v0=t,this.v1=e,this.v2=r,this.v3=i}getPoint(t,e=new L){const r=e,i=this.v0,s=this.v1,a=this.v2,o=this.v3;return r.set($n(t,i.x,s.x,a.x,o.x),$n(t,i.y,s.y,a.y,o.y),$n(t,i.z,s.z,a.z,o.z)),r}copy(t){return super.copy(t),this.v0.copy(t.v0),this.v1.copy(t.v1),this.v2.copy(t.v2),this.v3.copy(t.v3),this}toJSON(){const t=super.toJSON();return t.v0=this.v0.toArray(),t.v1=this.v1.toArray(),t.v2=this.v2.toArray(),t.v3=this.v3.toArray(),t}fromJSON(t){return super.fromJSON(t),this.v0.fromArray(t.v0),this.v1.fromArray(t.v1),this.v2.fromArray(t.v2),this.v3.fromArray(t.v3),this}}class Zy extends jr{constructor(t=new le,e=new le){super(),this.isLineCurve=!0,this.type="LineCurve",this.v1=t,this.v2=e}getPoint(t,e=new le){const r=e;return t===1?r.copy(this.v2):(r.copy(this.v2).sub(this.v1),r.multiplyScalar(t).add(this.v1)),r}getPointAt(t,e){return this.getPoint(t,e)}getTangent(t,e=new le){return e.subVectors(this.v2,this.v1).normalize()}getTangentAt(t,e){return this.getTangent(t,e)}copy(t){return super.copy(t),this.v1.copy(t.v1),this.v2.copy(t.v2),this}toJSON(){const t=super.toJSON();return t.v1=this.v1.toArray(),t.v2=this.v2.toArray(),t}fromJSON(t){return super.fromJSON(t),this.v1.fromArray(t.v1),this.v2.fromArray(t.v2),this}}class Ky extends jr{constructor(t=new L,e=new L){super(),this.isLineCurve3=!0,this.type="LineCurve3",this.v1=t,this.v2=e}getPoint(t,e=new L){const r=e;return t===1?r.copy(this.v2):(r.copy(this.v2).sub(this.v1),r.multiplyScalar(t).add(this.v1)),r}getPointAt(t,e){return this.getPoint(t,e)}getTangent(t,e=new L){return e.subVectors(this.v2,this.v1).normalize()}getTangentAt(t,e){return this.getTangent(t,e)}copy(t){return super.copy(t),this.v1.copy(t.v1),this.v2.copy(t.v2),this}toJSON(){const t=super.toJSON();return t.v1=this.v1.toArray(),t.v2=this.v2.toArray(),t}fromJSON(t){return super.fromJSON(t),this.v1.fromArray(t.v1),this.v2.fromArray(t.v2),this}}class Qy extends jr{constructor(t=new le,e=new le,r=new le){super(),this.isQuadraticBezierCurve=!0,this.type="QuadraticBezierCurve",this.v0=t,this.v1=e,this.v2=r}getPoint(t,e=new le){const r=e,i=this.v0,s=this.v1,a=this.v2;return r.set(Xn(t,i.x,s.x,a.x),Xn(t,i.y,s.y,a.y)),r}copy(t){return super.copy(t),this.v0.copy(t.v0),this.v1.copy(t.v1),this.v2.copy(t.v2),this}toJSON(){const t=super.toJSON();return t.v0=this.v0.toArray(),t.v1=this.v1.toArray(),t.v2=this.v2.toArray(),t}fromJSON(t){return super.fromJSON(t),this.v0.fromArray(t.v0),this.v1.fromArray(t.v1),this.v2.fromArray(t.v2),this}}class of extends jr{constructor(t=new L,e=new L,r=new L){super(),this.isQuadraticBezierCurve3=!0,this.type="QuadraticBezierCurve3",this.v0=t,this.v1=e,this.v2=r}getPoint(t,e=new L){const r=e,i=this.v0,s=this.v1,a=this.v2;return r.set(Xn(t,i.x,s.x,a.x),Xn(t,i.y,s.y,a.y),Xn(t,i.z,s.z,a.z)),r}copy(t){return super.copy(t),this.v0.copy(t.v0),this.v1.copy(t.v1),this.v2.copy(t.v2),this}toJSON(){const t=super.toJSON();return t.v0=this.v0.toArray(),t.v1=this.v1.toArray(),t.v2=this.v2.toArray(),t}fromJSON(t){return super.fromJSON(t),this.v0.fromArray(t.v0),this.v1.fromArray(t.v1),this.v2.fromArray(t.v2),this}}class tx extends jr{constructor(t=[]){super(),this.isSplineCurve=!0,this.type="SplineCurve",this.points=t}getPoint(t,e=new le){const r=e,i=this.points,s=(i.length-1)*t,a=Math.floor(s),o=s-a,c=i[a===0?a:a-1],h=i[a],u=i[a>i.length-2?i.length-1:a+1],d=i[a>i.length-3?i.length-1:a+2];return r.set(Iu(o,c.x,h.x,u.x,d.x),Iu(o,c.y,h.y,u.y,d.y)),r}copy(t){super.copy(t),this.points=[];for(let e=0,r=t.points.length;e<r;e++){const i=t.points[e];this.points.push(i.clone())}return this}toJSON(){const t=super.toJSON();t.points=[];for(let e=0,r=this.points.length;e<r;e++){const i=this.points[e];t.points.push(i.toArray())}return t}fromJSON(t){super.fromJSON(t),this.points=[];for(let e=0,r=t.points.length;e<r;e++){const i=t.points[e];this.points.push(new le().fromArray(i))}return this}}var ex=Object.freeze({__proto__:null,ArcCurve:Uy,CatmullRomCurve3:Gy,CubicBezierCurve:Jy,CubicBezierCurve3:qy,EllipseCurve:af,LineCurve:Zy,LineCurve3:Ky,QuadraticBezierCurve:Qy,QuadraticBezierCurve3:of,SplineCurve:tx});class lf extends Vr{constructor(t=1,e=1,r=1,i=1){super(),this.type="PlaneGeometry",this.parameters={width:t,height:e,widthSegments:r,heightSegments:i};const s=t/2,a=e/2,o=Math.floor(r),c=Math.floor(i),h=o+1,u=c+1,d=t/o,x=e/c,g=[],A=[],P=[],H=[];for(let V=0;V<u;V++){const At=V*x-a;for(let tt=0;tt<h;tt++){const lt=tt*d-s;A.push(lt,-At,0),P.push(0,0,1),H.push(tt/o),H.push(1-V/c)}}for(let V=0;V<c;V++)for(let At=0;At<o;At++){const tt=At+h*V,lt=At+h*(V+1),wt=At+1+h*(V+1),Et=At+1+h*V;g.push(tt,lt,Et),g.push(lt,wt,Et)}this.setIndex(g),this.setAttribute("position",new Ke(A,3)),this.setAttribute("normal",new Ke(P,3)),this.setAttribute("uv",new Ke(H,2))}copy(t){return super.copy(t),this.parameters=Object.assign({},t.parameters),this}static fromJSON(t){return new lf(t.width,t.height,t.widthSegments,t.heightSegments)}}class cf extends Vr{constructor(t=1,e=32,r=16,i=0,s=Math.PI*2,a=0,o=Math.PI){super(),this.type="SphereGeometry",this.parameters={radius:t,widthSegments:e,heightSegments:r,phiStart:i,phiLength:s,thetaStart:a,thetaLength:o},e=Math.max(3,Math.floor(e)),r=Math.max(2,Math.floor(r));const c=Math.min(a+o,Math.PI);let h=0;const u=[],d=new L,x=new L,g=[],A=[],P=[],H=[];for(let V=0;V<=r;V++){const At=[],tt=V/r;let lt=0;V===0&&a===0?lt=.5/e:V===r&&c===Math.PI&&(lt=-.5/e);for(let wt=0;wt<=e;wt++){const Et=wt/e;d.x=-t*Math.cos(i+Et*s)*Math.sin(a+tt*o),d.y=t*Math.cos(a+tt*o),d.z=t*Math.sin(i+Et*s)*Math.sin(a+tt*o),A.push(d.x,d.y,d.z),x.copy(d).normalize(),P.push(x.x,x.y,x.z),H.push(Et+lt,1-tt),At.push(h++)}u.push(At)}for(let V=0;V<r;V++)for(let At=0;At<e;At++){const tt=u[V][At+1],lt=u[V][At],wt=u[V+1][At],Et=u[V+1][At+1];(V!==0||a>0)&&g.push(tt,lt,Et),(V!==r-1||c<Math.PI)&&g.push(lt,wt,Et)}this.setIndex(g),this.setAttribute("position",new Ke(A,3)),this.setAttribute("normal",new Ke(P,3)),this.setAttribute("uv",new Ke(H,2))}copy(t){return super.copy(t),this.parameters=Object.assign({},t.parameters),this}static fromJSON(t){return new cf(t.radius,t.widthSegments,t.heightSegments,t.phiStart,t.phiLength,t.thetaStart,t.thetaLength)}}class hf extends Vr{constructor(t=new of(new L(-1,-1,0),new L(-1,1,0),new L(1,1,0)),e=64,r=1,i=8,s=!1){super(),this.type="TubeGeometry",this.parameters={path:t,tubularSegments:e,radius:r,radialSegments:i,closed:s};const a=t.computeFrenetFrames(e,s);this.tangents=a.tangents,this.normals=a.normals,this.binormals=a.binormals;const o=new L,c=new L,h=new le;let u=new L;const d=[],x=[],g=[],A=[];P(),this.setIndex(A),this.setAttribute("position",new Ke(d,3)),this.setAttribute("normal",new Ke(x,3)),this.setAttribute("uv",new Ke(g,2));function P(){for(let tt=0;tt<e;tt++)H(tt);H(s===!1?e:0),At(),V()}function H(tt){u=t.getPointAt(tt/e,u);const lt=a.normals[tt],wt=a.binormals[tt];for(let Et=0;Et<=i;Et++){const Lt=Et/i*Math.PI*2,Dt=Math.sin(Lt),Wt=-Math.cos(Lt);c.x=Wt*lt.x+Dt*wt.x,c.y=Wt*lt.y+Dt*wt.y,c.z=Wt*lt.z+Dt*wt.z,c.normalize(),x.push(c.x,c.y,c.z),o.x=u.x+r*c.x,o.y=u.y+r*c.y,o.z=u.z+r*c.z,d.push(o.x,o.y,o.z)}}function V(){for(let tt=1;tt<=e;tt++)for(let lt=1;lt<=i;lt++){const wt=(i+1)*(tt-1)+(lt-1),Et=(i+1)*tt+(lt-1),Lt=(i+1)*tt+lt,Dt=(i+1)*(tt-1)+lt;A.push(wt,Et,Dt),A.push(Et,Lt,Dt)}}function At(){for(let tt=0;tt<=e;tt++)for(let lt=0;lt<=i;lt++)h.x=tt/e,h.y=lt/i,g.push(h.x,h.y)}}copy(t){return super.copy(t),this.parameters=Object.assign({},t.parameters),this}toJSON(){const t=super.toJSON();return t.path=this.parameters.path.toJSON(),t}static fromJSON(t){return new hf(new ex[t.path.type]().fromJSON(t.path),t.tubularSegments,t.radius,t.radialSegments,t.closed)}}class C_ extends Ri{constructor(t){super(),this.isMeshStandardMaterial=!0,this.type="MeshStandardMaterial",this.defines={STANDARD:""},this.color=new vr(16777215),this.roughness=1,this.metalness=0,this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new vr(0),this.emissiveIntensity=1,this.emissiveMap=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=k0,this.normalScale=new le(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.roughnessMap=null,this.metalnessMap=null,this.alphaMap=null,this.envMap=null,this.envMapRotation=new li,this.envMapIntensity=1,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.flatShading=!1,this.fog=!0,this.setValues(t)}copy(t){return super.copy(t),this.defines={STANDARD:""},this.color.copy(t.color),this.roughness=t.roughness,this.metalness=t.metalness,this.map=t.map,this.lightMap=t.lightMap,this.lightMapIntensity=t.lightMapIntensity,this.aoMap=t.aoMap,this.aoMapIntensity=t.aoMapIntensity,this.emissive.copy(t.emissive),this.emissiveMap=t.emissiveMap,this.emissiveIntensity=t.emissiveIntensity,this.bumpMap=t.bumpMap,this.bumpScale=t.bumpScale,this.normalMap=t.normalMap,this.normalMapType=t.normalMapType,this.normalScale.copy(t.normalScale),this.displacementMap=t.displacementMap,this.displacementScale=t.displacementScale,this.displacementBias=t.displacementBias,this.roughnessMap=t.roughnessMap,this.metalnessMap=t.metalnessMap,this.alphaMap=t.alphaMap,this.envMap=t.envMap,this.envMapRotation.copy(t.envMapRotation),this.envMapIntensity=t.envMapIntensity,this.wireframe=t.wireframe,this.wireframeLinewidth=t.wireframeLinewidth,this.wireframeLinecap=t.wireframeLinecap,this.wireframeLinejoin=t.wireframeLinejoin,this.flatShading=t.flatShading,this.fog=t.fog,this}}class I_ extends Ri{constructor(t){super(),this.isMeshDepthMaterial=!0,this.type="MeshDepthMaterial",this.depthPacking=B0,this.map=null,this.alphaMap=null,this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.wireframe=!1,this.wireframeLinewidth=1,this.setValues(t)}copy(t){return super.copy(t),this.depthPacking=t.depthPacking,this.map=t.map,this.alphaMap=t.alphaMap,this.displacementMap=t.displacementMap,this.displacementScale=t.displacementScale,this.displacementBias=t.displacementBias,this.wireframe=t.wireframe,this.wireframeLinewidth=t.wireframeLinewidth,this}}class R_ extends Ri{constructor(t){super(),this.isMeshDistanceMaterial=!0,this.type="MeshDistanceMaterial",this.map=null,this.alphaMap=null,this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.setValues(t)}copy(t){return super.copy(t),this.map=t.map,this.alphaMap=t.alphaMap,this.displacementMap=t.displacementMap,this.displacementScale=t.displacementScale,this.displacementBias=t.displacementBias,this}}const No={enabled:!1,files:{},add:function(n,t){this.enabled!==!1&&(this.files[n]=t)},get:function(n){if(this.enabled!==!1)return this.files[n]},remove:function(n){delete this.files[n]},clear:function(){this.files={}}};class rx{constructor(t,e,r){const i=this;let s=!1,a=0,o=0,c;const h=[];this.onStart=void 0,this.onLoad=t,this.onProgress=e,this.onError=r,this.itemStart=function(u){o++,s===!1&&i.onStart!==void 0&&i.onStart(u,a,o),s=!0},this.itemEnd=function(u){a++,i.onProgress!==void 0&&i.onProgress(u,a,o),a===o&&(s=!1,i.onLoad!==void 0&&i.onLoad())},this.itemError=function(u){i.onError!==void 0&&i.onError(u)},this.resolveURL=function(u){return c?c(u):u},this.setURLModifier=function(u){return c=u,this},this.addHandler=function(u,d){return h.push(u,d),this},this.removeHandler=function(u){const d=h.indexOf(u);return d!==-1&&h.splice(d,2),this},this.getHandler=function(u){for(let d=0,x=h.length;d<x;d+=2){const g=h[d],A=h[d+1];if(g.global&&(g.lastIndex=0),g.test(u))return A}return null}}}const ix=new rx;class $o{constructor(t){this.manager=t!==void 0?t:ix,this.crossOrigin="anonymous",this.withCredentials=!1,this.path="",this.resourcePath="",this.requestHeader={}}load(){}loadAsync(t,e){const r=this;return new Promise(function(i,s){r.load(t,i,e,s)})}parse(){}setCrossOrigin(t){return this.crossOrigin=t,this}setWithCredentials(t){return this.withCredentials=t,this}setPath(t){return this.path=t,this}setResourcePath(t){return this.resourcePath=t,this}setRequestHeader(t){return this.requestHeader=t,this}}$o.DEFAULT_MATERIAL_NAME="__DEFAULT";const cn=new WeakMap;class nx extends $o{constructor(t){super(t)}load(t,e,r,i){this.path!==void 0&&(t=this.path+t),t=this.manager.resolveURL(t);const s=this,a=No.get(`image:${t}`);if(a!==void 0){if(a.complete===!0)s.manager.itemStart(t),setTimeout(function(){e&&e(a),s.manager.itemEnd(t)},0);else{let d=cn.get(a);d===void 0&&(d=[],cn.set(a,d)),d.push({onLoad:e,onError:i})}return a}const o=na("img");function c(){u(),e&&e(this);const d=cn.get(this)||[];for(let x=0;x<d.length;x++){const g=d[x];g.onLoad&&g.onLoad(this)}cn.delete(this),s.manager.itemEnd(t)}function h(d){u(),i&&i(d),No.remove(`image:${t}`);const x=cn.get(this)||[];for(let g=0;g<x.length;g++){const A=x[g];A.onError&&A.onError(d)}cn.delete(this),s.manager.itemError(t),s.manager.itemEnd(t)}function u(){o.removeEventListener("load",c,!1),o.removeEventListener("error",h,!1)}return o.addEventListener("load",c,!1),o.addEventListener("error",h,!1),t.slice(0,5)!=="data:"&&this.crossOrigin!==void 0&&(o.crossOrigin=this.crossOrigin),No.add(`image:${t}`,o),s.manager.itemStart(t),o.src=t,o}}class O_ extends $o{constructor(t){super(t)}load(t,e,r,i){const s=new er,a=new nx(this.manager);return a.setCrossOrigin(this.crossOrigin),a.setPath(this.path),a.load(t,function(o){s.image=o,s.needsUpdate=!0,e!==void 0&&e(s)},r,i),s}}class Jo extends We{constructor(t,e=1){super(),this.isLight=!0,this.type="Light",this.color=new vr(t),this.intensity=e}dispose(){}copy(t,e){return super.copy(t,e),this.color.copy(t.color),this.intensity=t.intensity,this}toJSON(t){const e=super.toJSON(t);return e.object.color=this.color.getHex(),e.object.intensity=this.intensity,this.groundColor!==void 0&&(e.object.groundColor=this.groundColor.getHex()),this.distance!==void 0&&(e.object.distance=this.distance),this.angle!==void 0&&(e.object.angle=this.angle),this.decay!==void 0&&(e.object.decay=this.decay),this.penumbra!==void 0&&(e.object.penumbra=this.penumbra),this.shadow!==void 0&&(e.object.shadow=this.shadow.toJSON()),this.target!==void 0&&(e.object.target=this.target.uuid),e}}const Lo=new we,Ru=new L,Ou=new L;class uf{constructor(t){this.camera=t,this.intensity=1,this.bias=0,this.normalBias=0,this.radius=1,this.blurSamples=8,this.mapSize=new le(512,512),this.mapType=Uo,this.map=null,this.mapPass=null,this.matrix=new we,this.autoUpdate=!0,this.needsUpdate=!1,this._frustum=new Py,this._frameExtents=new le(1,1),this._viewportCount=1,this._viewports=[new tr(0,0,1,1)]}getViewportCount(){return this._viewportCount}getFrustum(){return this._frustum}updateMatrices(t){const e=this.camera,r=this.matrix;Ru.setFromMatrixPosition(t.matrixWorld),e.position.copy(Ru),Ou.setFromMatrixPosition(t.target.matrixWorld),e.lookAt(Ou),e.updateMatrixWorld(),Lo.multiplyMatrices(e.projectionMatrix,e.matrixWorldInverse),this._frustum.setFromProjectionMatrix(Lo),r.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),r.multiply(Lo)}getViewport(t){return this._viewports[t]}getFrameExtents(){return this._frameExtents}dispose(){this.map&&this.map.dispose(),this.mapPass&&this.mapPass.dispose()}copy(t){return this.camera=t.camera.clone(),this.intensity=t.intensity,this.bias=t.bias,this.radius=t.radius,this.autoUpdate=t.autoUpdate,this.needsUpdate=t.needsUpdate,this.normalBias=t.normalBias,this.blurSamples=t.blurSamples,this.mapSize.copy(t.mapSize),this}clone(){return new this.constructor().copy(this)}toJSON(){const t={};return this.intensity!==1&&(t.intensity=this.intensity),this.bias!==0&&(t.bias=this.bias),this.normalBias!==0&&(t.normalBias=this.normalBias),this.radius!==1&&(t.radius=this.radius),(this.mapSize.x!==512||this.mapSize.y!==512)&&(t.mapSize=this.mapSize.toArray()),t.camera=this.camera.toJSON(!1).object,delete t.camera.matrix,t}}const Nu=new we,Vn=new L,Do=new L;class sx extends uf{constructor(){super(new ni(90,1,.5,500)),this.isPointLightShadow=!0,this._frameExtents=new le(4,2),this._viewportCount=6,this._viewports=[new tr(2,1,1,1),new tr(0,1,1,1),new tr(3,1,1,1),new tr(1,1,1,1),new tr(3,0,1,1),new tr(1,0,1,1)],this._cubeDirections=[new L(1,0,0),new L(-1,0,0),new L(0,0,1),new L(0,0,-1),new L(0,1,0),new L(0,-1,0)],this._cubeUps=[new L(0,1,0),new L(0,1,0),new L(0,1,0),new L(0,1,0),new L(0,0,1),new L(0,0,-1)]}updateMatrices(t,e=0){const r=this.camera,i=this.matrix,s=t.distance||r.far;s!==r.far&&(r.far=s,r.updateProjectionMatrix()),Vn.setFromMatrixPosition(t.matrixWorld),r.position.copy(Vn),Do.copy(r.position),Do.add(this._cubeDirections[e]),r.up.copy(this._cubeUps[e]),r.lookAt(Do),r.updateMatrixWorld(),i.makeTranslation(-Vn.x,-Vn.y,-Vn.z),Nu.multiplyMatrices(r.projectionMatrix,r.matrixWorldInverse),this._frustum.setFromProjectionMatrix(Nu)}}class N_ extends Jo{constructor(t,e,r=0,i=2){super(t,e),this.isPointLight=!0,this.type="PointLight",this.distance=r,this.decay=i,this.shadow=new sx}get power(){return this.intensity*4*Math.PI}set power(t){this.intensity=t/(4*Math.PI)}dispose(){this.shadow.dispose()}copy(t,e){return super.copy(t,e),this.distance=t.distance,this.decay=t.decay,this.shadow=t.shadow.clone(),this}}class ax extends rf{constructor(t=-1,e=1,r=1,i=-1,s=.1,a=2e3){super(),this.isOrthographicCamera=!0,this.type="OrthographicCamera",this.zoom=1,this.view=null,this.left=t,this.right=e,this.top=r,this.bottom=i,this.near=s,this.far=a,this.updateProjectionMatrix()}copy(t,e){return super.copy(t,e),this.left=t.left,this.right=t.right,this.top=t.top,this.bottom=t.bottom,this.near=t.near,this.far=t.far,this.zoom=t.zoom,this.view=t.view===null?null:Object.assign({},t.view),this}setViewOffset(t,e,r,i,s,a){this.view===null&&(this.view={enabled:!0,fullWidth:1,fullHeight:1,offsetX:0,offsetY:0,width:1,height:1}),this.view.enabled=!0,this.view.fullWidth=t,this.view.fullHeight=e,this.view.offsetX=r,this.view.offsetY=i,this.view.width=s,this.view.height=a,this.updateProjectionMatrix()}clearViewOffset(){this.view!==null&&(this.view.enabled=!1),this.updateProjectionMatrix()}updateProjectionMatrix(){const t=(this.right-this.left)/(2*this.zoom),e=(this.top-this.bottom)/(2*this.zoom),r=(this.right+this.left)/2,i=(this.top+this.bottom)/2;let s=r-t,a=r+t,o=i+e,c=i-e;if(this.view!==null&&this.view.enabled){const h=(this.right-this.left)/this.view.fullWidth/this.zoom,u=(this.top-this.bottom)/this.view.fullHeight/this.zoom;s+=h*this.view.offsetX,a=s+h*this.view.width,o-=u*this.view.offsetY,c=o-u*this.view.height}this.projectionMatrix.makeOrthographic(s,a,o,c,this.near,this.far,this.coordinateSystem),this.projectionMatrixInverse.copy(this.projectionMatrix).invert()}toJSON(t){const e=super.toJSON(t);return e.object.zoom=this.zoom,e.object.left=this.left,e.object.right=this.right,e.object.top=this.top,e.object.bottom=this.bottom,e.object.near=this.near,e.object.far=this.far,this.view!==null&&(e.object.view=Object.assign({},this.view)),e}}class ox extends uf{constructor(){super(new ax(-5,5,5,-5,.5,500)),this.isDirectionalLightShadow=!0}}class L_ extends Jo{constructor(t,e){super(t,e),this.isDirectionalLight=!0,this.type="DirectionalLight",this.position.copy(We.DEFAULT_UP),this.updateMatrix(),this.target=new We,this.shadow=new ox}dispose(){this.shadow.dispose()}copy(t){return super.copy(t),this.target=t.target.clone(),this.shadow=t.shadow.clone(),this}}class D_ extends Jo{constructor(t,e){super(t,e),this.isAmbientLight=!0,this.type="AmbientLight"}}class F_ extends ni{constructor(t=[]){super(),this.isArrayCamera=!0,this.isMultiViewCamera=!1,this.cameras=t}}class P_{constructor(t=!0){this.autoStart=t,this.startTime=0,this.oldTime=0,this.elapsedTime=0,this.running=!1}start(){this.startTime=performance.now(),this.oldTime=this.startTime,this.elapsedTime=0,this.running=!0}stop(){this.getElapsedTime(),this.running=!1,this.autoStart=!1}getElapsedTime(){return this.getDelta(),this.elapsedTime}getDelta(){let t=0;if(this.autoStart&&!this.running)return this.start(),0;if(this.running){const e=performance.now();t=(e-this.oldTime)/1e3,this.oldTime=e,this.elapsedTime+=t}return t}}const Lu=new L,Zs=new L;class B_{constructor(t=new L,e=new L){this.start=t,this.end=e}set(t,e){return this.start.copy(t),this.end.copy(e),this}copy(t){return this.start.copy(t.start),this.end.copy(t.end),this}getCenter(t){return t.addVectors(this.start,this.end).multiplyScalar(.5)}delta(t){return t.subVectors(this.end,this.start)}distanceSq(){return this.start.distanceToSquared(this.end)}distance(){return this.start.distanceTo(this.end)}at(t,e){return this.delta(e).multiplyScalar(t).add(this.start)}closestPointToPointParameter(t,e){Lu.subVectors(t,this.start),Zs.subVectors(this.end,this.start);const r=Zs.dot(Zs);let s=Zs.dot(Lu)/r;return e&&(s=ae(s,0,1)),s}closestPointToPoint(t,e,r){const i=this.closestPointToPointParameter(t,e);return this.delta(r).multiplyScalar(i).add(this.start)}applyMatrix4(t){return this.start.applyMatrix4(t),this.end.applyMatrix4(t),this}equals(t){return t.start.equals(this.start)&&t.end.equals(this.end)}clone(){return new this.constructor().copy(this)}}function k_(n,t,e,r){const i=lx(r);switch(e){case Kp:return n*t;case Qu:return n*t/i.components*i.byteLength;case e0:return n*t/i.components*i.byteLength;case r0:return n*t*2/i.components*i.byteLength;case i0:return n*t*2/i.components*i.byteLength;case Qp:return n*t*3/i.components*i.byteLength;case Ku:return n*t*4/i.components*i.byteLength;case n0:return n*t*4/i.components*i.byteLength;case s0:case a0:return Math.floor((n+3)/4)*Math.floor((t+3)/4)*8;case o0:case l0:return Math.floor((n+3)/4)*Math.floor((t+3)/4)*16;case h0:case f0:return Math.max(n,16)*Math.max(t,8)/4;case c0:case u0:return Math.max(n,8)*Math.max(t,8)/2;case d0:case m0:return Math.floor((n+3)/4)*Math.floor((t+3)/4)*8;case p0:return Math.floor((n+3)/4)*Math.floor((t+3)/4)*16;case y0:return Math.floor((n+3)/4)*Math.floor((t+3)/4)*16;case x0:return Math.floor((n+4)/5)*Math.floor((t+3)/4)*16;case g0:return Math.floor((n+4)/5)*Math.floor((t+4)/5)*16;case _0:return Math.floor((n+5)/6)*Math.floor((t+4)/5)*16;case b0:return Math.floor((n+5)/6)*Math.floor((t+5)/6)*16;case v0:return Math.floor((n+7)/8)*Math.floor((t+4)/5)*16;case E0:return Math.floor((n+7)/8)*Math.floor((t+5)/6)*16;case A0:return Math.floor((n+7)/8)*Math.floor((t+7)/8)*16;case T0:return Math.floor((n+9)/10)*Math.floor((t+4)/5)*16;case S0:return Math.floor((n+9)/10)*Math.floor((t+5)/6)*16;case w0:return Math.floor((n+9)/10)*Math.floor((t+7)/8)*16;case M0:return Math.floor((n+9)/10)*Math.floor((t+9)/10)*16;case C0:return Math.floor((n+11)/12)*Math.floor((t+9)/10)*16;case I0:return Math.floor((n+11)/12)*Math.floor((t+11)/12)*16;case R0:case O0:case N0:return Math.ceil(n/4)*Math.ceil(t/4)*16;case L0:case D0:return Math.ceil(n/4)*Math.ceil(t/4)*8;case F0:case P0:return Math.ceil(n/4)*Math.ceil(t/4)*16}throw new Error(`Unable to determine texture byte length for ${e} format.`)}function lx(n){switch(n){case Uo:case Hp:return{byteLength:1,components:1};case Yp:case Wp:case $p:return{byteLength:2,components:1};case Jp:case qp:return{byteLength:2,components:4};case Zu:case Xp:case Go:return{byteLength:4,components:1};case Zp:return{byteLength:4,components:3}}throw new Error(`Unknown texture type ${n}.`)}typeof __THREE_DEVTOOLS__<"u"&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("register",{detail:{revision:Xu}}));typeof window<"u"&&(window.__THREE__?console.warn("WARNING: Multiple instances of Three.js being imported."):window.__THREE__=Xu);const Ks={CAMERA_BASE_FOV:75,CAMERA_SPEED_FOV_FACTOR:.05,CAMERA_MAX_FOV_BOOST:20,STARS_COUNT:1e4,PARTICLE_COUNT:14e3,PARTICLE_SPAWN_COUNT:110,PARTICLE_BASE_SIZE:9,PARTICLE_LIFETIME:2,PARTICLE_GRAVITY:-9.8,BASS_KICK_THRESHOLD:15,MID_KICK_THRESHOLD:10,HIGH_KICK_THRESHOLD:8,TRACK_SEGMENT_RESOLUTION:100,INITIAL_TRACK_SEGMENT_LENGTH:10,INITIAL_TRACK_SEGMENT_SPACING:2,DEFAULT_SKY_COLOR_2:"#000000"},cx=1,hx=n=>{if(typeof n!="string")return"unknown";const t=n.trim().toLowerCase();return t==="climb"||t.startsWith("climb")?"climb":t==="drop"||t.startsWith("drop")?"drop":t==="turn"||t.startsWith("turn")?"turn":t==="loop"||t.includes("loop")?"loop":t==="barrelroll"||t==="barrel_roll"||t==="barrel roll"||t==="roll"||t.includes("roll")?"barrelRoll":"unknown"},zr=(n,t)=>Number.isFinite(n)?Te.clamp(n,0,1):Te.clamp(t,0,1),ux=n=>{if(!n||typeof n!="object")return null;const t=n;let e=null;if(t.geometry&&typeof t.geometry=="object"){const s=t.geometry,a=typeof s.breathingDriver=="string"?s.breathingDriver.toString().toLowerCase():void 0;e={wireframeDensity:Number.isFinite(s.wireframeDensity)?zr(s.wireframeDensity,.55):void 0,impossiblePhysics:typeof s.impossiblePhysics=="boolean"?s.impossiblePhysics:void 0,organicBreathing:Number.isFinite(s.organicBreathing)?zr(s.organicBreathing,.4):void 0,breathingDriver:a==="energy"||a==="spectralflux"||a==="spectralcentroid"?a==="spectralflux"?"spectralFlux":a==="spectralcentroid"?"spectralCentroid":"energy":void 0}}let r=null;if(t.particles&&typeof t.particles=="object"){const s=t.particles;r={connectionDensity:Number.isFinite(s.connectionDensity)?zr(s.connectionDensity,.45):void 0,resonanceThreshold:Number.isFinite(s.resonanceThreshold)?zr(s.resonanceThreshold,.4):void 0,lifespanSeconds:Number.isFinite(s.lifespanSeconds)?Math.max(0,s.lifespanSeconds):void 0,persistence:Number.isFinite(s.persistence)?zr(s.persistence,.5):void 0}}let i=null;if(t.atmosphere&&typeof t.atmosphere=="object"){const s=t.atmosphere;i={skyMood:typeof s.skyMood=="string"?s.skyMood:void 0,turbulenceBias:Number.isFinite(s.turbulenceBias)?s.turbulenceBias:void 0,passionIntensity:Number.isFinite(s.passionIntensity)?Math.max(0,s.passionIntensity):void 0,tint:typeof s.tint=="string"?s.tint:void 0}}return!e&&!r&&!i?null:{geometry:e,particles:r,atmosphere:i}},Du=n=>{if(n.length<2)return 0;let t=0;for(let e=1;e<n.length;e++)t+=n[e].distanceTo(n[e-1]);return t},Fu=18,Pu=24,Bu=12,ku=16,fx=.55,dx=.4,zu=Math.PI/4,mx=(n,t)=>{const r=[],i=[],s=[],a=[],o=[],c=ux(n.synesthetic),h=(c==null?void 0:c.geometry)??null;let u=new L(0,5,0),d=new L(0,0,-1),x=new L(0,1,0);const g=(kt,jt)=>{if(!kt||kt.length===0)return null;const ee=r.length;return r.push(...kt),i.push(...jt),u=kt[kt.length-1],kt.length>1&&d.subVectors(kt[kt.length-1],kt[kt.length-2]).normalize(),x=jt[jt.length-1],{start:ee,end:r.length-1}},A=[],P=[],H=Math.max(1,Math.floor(Number(Ks.INITIAL_TRACK_SEGMENT_LENGTH)||0));let V=Number(Ks.INITIAL_TRACK_SEGMENT_SPACING)*1.25;(!isFinite(V)||V<0)&&(V=cx);for(let kt=0;kt<H;kt++)A.push(u.clone().add(d.clone().multiplyScalar(kt*V))),P.push(x.clone());const At=g(A,P);At&&a.push(At),o.push({index:-1,component:"initial",computedLength:Du(A),sampleCount:A.length,source:{spacing:V,samples:H}}),s.push({intensity:0,lightingEffect:"none",environmentChange:"none",audioSyncPoint:Yu(0)}),n.track.forEach((kt,jt)=>{const ee=[],Xt=[],$t=Math.max(1,Math.floor(Ks.TRACK_SEGMENT_RESOLUTION)),de=kt.component??kt.type,me=hx(de),Kt={};switch(me){case"climb":case"drop":{const ie=kt,xe=ie.angle??(me==="climb"?15:-40),_e=Te.degToRad(Te.clamp(xe,-90,90));Kt.length=ie.length,Kt.angle=xe;const Ye=ie.length??150,Be=Math.max(10,Ye)*1.25,Ue=d.clone();Ue.y=0,Ue.normalize();const Me=u.clone().add(Ue.multiplyScalar(Math.cos(_e)*Be)).add(new L(0,Math.sin(_e)*Be,0));for(let be=1;be<=$t;be++){const qe=be/$t;ee.push(new L().lerpVectors(u,Me,qe)),Xt.push(x.clone())}break}case"turn":{const ie=kt,xe=ie.radius??80,_e=Math.max(10,xe)*1.25,Ye=ie.angle??90,Be=Te.degToRad(Te.clamp(Ye,-360,360));Kt.radius=ie.radius,Kt.angle=Ye,Kt.direction=ie.direction,Kt.length=kt.length;const Ue=ie.direction==="left"?1:-1,Me=new L(0,1,0),be=d.clone().cross(Me).multiplyScalar(_e*Ue),qe=u.clone().add(be),Cr=u.clone().sub(qe);for(let or=1;or<=$t;or++){const Hr=or/$t,lr=Cr.clone().applyAxisAngle(Me,Be*Hr*-Ue);ee.push(qe.clone().add(lr)),Xt.push(x.clone())}break}case"loop":{const ie=kt,xe=ie.radius??50,_e=Math.max(10,xe)*1.25,Ye=Math.max(_e*1.5,ie.length?Math.max(20,Number(ie.length))*1.25:_e*Math.PI*.75);Kt.radius=ie.radius,Kt.length=ie.length;const Be=u.clone().add(d.clone().multiplyScalar(_e));for(let Ue=1;Ue<=$t;Ue++){const Me=Ue/$t,be=Me*Math.PI*2,qe=x.clone().multiplyScalar(Math.sin(be)*_e),Cr=d.clone().multiplyScalar(-Math.cos(be)*_e+Me*Ye),or=Be.clone().add(qe).add(Cr);ee.push(or),Xt.push(x.clone())}break}case"barrelRoll":{const ie=kt,xe=ie.rotations??1,_e=Math.max(1,Math.round(xe));Kt.length=ie.length,Kt.rotations=xe;const Ye=ie.length??150,Be=Math.max(10,Ye)*1.25,Ue=u.clone().add(d.clone().multiplyScalar(Be));for(let Me=1;Me<=$t;Me++){const be=Me/$t,qe=be*Math.PI*2*_e;ee.push(new L().lerpVectors(u,Ue,be)),Xt.push(x.clone().applyAxisAngle(d,qe))}break}case"unknown":{console.warn("[TrackBuilder] Unsupported segment component, using straight fallback",{index:jt,component:de});const ie=Math.max(10,kt.length??80)*1.25;Kt.length=kt.length;for(let xe=1;xe<=$t;xe++){const _e=xe/$t;ee.push(u.clone().add(d.clone().multiplyScalar(_e*ie))),Xt.push(x.clone())}break}}const re=Du(ee),ye=g(ee,Xt);ye?a.push(ye):a.length>0?a.push(a[a.length-1]):a.push({start:0,end:r.length>0?r.length-1:0}),o.push({index:jt,component:me,computedLength:re,sampleCount:ee.length,source:Kt}),s.push({intensity:kt.intensity??0,lightingEffect:kt.lightingEffect,environmentChange:kt.environmentChange,audioSyncPoint:kt.audioSyncPoint})}),r.length>2&&px(r,i,t,h);const tt=Math.max(r.length-1,1),lt=a.map(kt=>{const jt=kt.end/tt;return Number.isFinite(jt)?Te.clamp(jt,0,1):0});let wt=0,Et=Number.POSITIVE_INFINITY,Lt=Number.POSITIVE_INFINITY,Dt=Number.POSITIVE_INFINITY,Wt=Number.NEGATIVE_INFINITY,se=Number.NEGATIVE_INFINITY,ce=Number.NEGATIVE_INFINITY;for(let kt=0;kt<r.length;kt++){const jt=r[kt];kt>0&&(wt+=jt.distanceTo(r[kt-1])),jt.x<Et&&(Et=jt.x),jt.y<Lt&&(Lt=jt.y),jt.z<Dt&&(Dt=jt.z),jt.x>Wt&&(Wt=jt.x),jt.y>se&&(se=jt.y),jt.z>ce&&(ce=jt.z)}return console.log("[TrackBuilder] Generated track geometry",{pointCount:r.length,segmentCount:n.track.length,segmentProgress:lt,metrics:{totalApproxLength:Number(wt.toFixed(1)),bounds:{x:[Number(Et.toFixed(2)),Number(Wt.toFixed(2))],y:[Number(Lt.toFixed(2)),Number(se.toFixed(2))],z:[Number(Dt.toFixed(2)),Number(ce.toFixed(2))],span:{x:Number((Wt-Et).toFixed(2)),y:Number((se-Lt).toFixed(2)),z:Number((ce-Dt).toFixed(2))}},perSegment:o}}),{path:r,upVectors:i,railColor:n.palette[0]||"#ffffff",glowColor:n.palette[1]||"#00ffff",skyColor1:n.palette[2]||"#0d0a1f",skyColor2:Ks.DEFAULT_SKY_COLOR_2,segmentDetails:s,segmentProgress:lt,rideName:n.rideName,moodDescription:n.moodDescription,frameAnalyses:t&&t.frameAnalyses||[],audioFeatures:t||{duration:0,bpm:120,energy:0,spectralCentroid:0,spectralFlux:0,frameAnalyses:[]},events:Array.isArray(n.events)?n.events:[],synesthetic:c}},px=(n,t,e,r)=>{if(!e){Uu(n,t,r);return}const i=e.frameAnalyses||[];if(!i.length){Uu(n,t,r);return}const s=n.map(Xt=>Xt.clone()),a=t.map(Xt=>Xt.clone()),o=zr(r==null?void 0:r.wireframeDensity,.55),c=zr(r==null?void 0:r.organicBreathing,.4),h=!!(r!=null&&r.impossiblePhysics),u=(r==null?void 0:r.breathingDriver)??"energy",x=(Number.isFinite(e.bpm)?Math.max(30,e.bpm||120):120)/60*.5,g=28+o*45,A=24+c*36,P=new L(0,1,0),H=new L,V=new L,At=new L,tt=new L,lt=new L,wt=new L;new L;let Et=0,Lt=0,Dt=0;const Wt=i.length,se=i.reduce((Xt,$t)=>Math.max(Xt,$t.energy),0)||1,ce=i.reduce((Xt,$t)=>Math.max(Xt,$t.spectralFlux),0)||1,kt=i.reduce((Xt,$t)=>Math.max(Xt,$t.spectralCentroid),0)||1,jt=(Xt,$t)=>{if(Wt===1)return i[0][$t];const de=Te.clamp(Xt,0,1)*(Wt-1),me=Math.floor(de),Kt=Math.min(Wt-1,me+1),re=de-me,ye=i[me][$t],ie=i[Kt][$t];return Te.lerp(ye,ie,re)},ee=Te.clamp(fx+c*.15,.35,.72);for(let Xt=1;Xt<n.length-1;Xt++){const $t=Xt/(n.length-1),de=Te.smoothstep($t,.05,.95),me=jt($t,"energy")/se*de,Kt=jt($t,"spectralFlux")/ce*de,re=jt($t,"spectralCentroid")/kt*de,ye=u==="spectralFlux"?Kt:u==="spectralCentroid"?re:me,ie=s[Xt-1],xe=s[Xt],_e=s[Xt+1];if(H.copy(ie),V.copy(_e),At.copy(_e).sub(ie),At.lengthSq()<1e-6)continue;At.normalize(),tt.crossVectors(At,P),tt.lengthSq()<1e-6?tt.set(1,0,0):tt.normalize();const Ye=2.6+o*3.2,Be=Math.sin($t*Math.PI*Ye+Kt*(5+o*3.2)),Ue=Math.cos($t*Math.PI*(2.4+o*.8)+re*(3.5+o*2.4));let Me=Be*Kt*(8+o*6),be=Ue*me*(10+c*6.5);const qe=Be*.22*Kt+re*.14,Cr=Math.sin($t*Math.PI*1.1)*g*de,or=Math.cos($t*Math.PI*.7+Kt*1.8)*A*de;if(Me+=Cr,be+=or*.75,c>.001){const lr=$t*Math.PI*2*x,Oi=Math.sin(lr+ye*Math.PI*1.5)*c*(7.5+o*4)*de,ci=Math.cos(lr*.65+Kt*2)*c*re*(5+o*3.2)*de;be+=Oi,Me+=ci}if(h){const lr=Math.sin($t*Math.PI*(3.6+o*3)+me*5)*Kt,Wr=Math.cos($t*Math.PI*2.6+re*3.6)*me;be+=lr*2.4,Me+=Wr*2.1}Me=Te.clamp(Me,-Fu,Fu),be=Te.clamp(be,-Pu,Pu),Et=Te.lerp(Et,Me,.08),Lt=Te.lerp(Lt,be,.09),Dt=Te.lerp(Dt,qe,.14),wt.copy(xe).addScaledVector(tt,Et).addScaledVector(P,Lt),n[Xt].lerpVectors(xe,wt,ee);const Hr=Te.clamp(Dt,-zu,zu);lt.copy(P).applyAxisAngle(At,Hr).normalize(),t[Xt].copy(a[Xt]).lerp(lt,ee*.6).normalize()}},Uu=(n,t,e)=>{if(n.length<3)return;const r=n.map(tt=>tt.clone()),i=t.map(tt=>tt.clone()),s=new L(0,1,0),a=new L,o=new L,c=new L,h=new L,u=new L;let d=0,x=0;const g=zr(e==null?void 0:e.wireframeDensity,.45),A=zr(e==null?void 0:e.organicBreathing,.35),P=!!(e!=null&&e.impossiblePhysics),H=22+g*34,V=18+A*28,At=Te.clamp(dx+A*.2,.25,.55);for(let tt=1;tt<n.length-1;tt++){const lt=tt/(n.length-1),wt=Te.smoothstep(lt,.05,.95),Et=Math.sin(lt*Math.PI*(1.8+g*1.4))*wt,Lt=Math.cos(lt*Math.PI*1.4)*A*wt,Dt=Math.sin(lt*Math.PI*.85)*H*wt,Wt=Math.cos(lt*Math.PI*.7)*V*wt,se=Et+Lt*.55,ce=r[tt-1],kt=r[tt],jt=r[tt+1];if(a.copy(ce),o.copy(jt),c.copy(jt).sub(ce),c.lengthSq()<1e-6)continue;c.normalize(),h.crossVectors(c,s),h.lengthSq()<1e-6?h.set(1,0,0):h.normalize();let ee=se*(5.5+g*3.4)+Dt,Xt=se*(7.5+A*3.6)+Wt*.7;P&&(ee+=Math.cos(lt*Math.PI*3.4)*2*wt,Xt+=Math.sin(lt*Math.PI*3.8)*2.2*wt),ee=Te.clamp(ee,-Bu,Bu),Xt=Te.clamp(Xt,-ku,ku),d=Te.lerp(d,ee,.12),x=Te.lerp(x,Xt,.12),u.copy(kt).addScaledVector(h,d).addScaledVector(s,x),n[tt].lerpVectors(kt,u,At),t[tt].copy(i[tt]).lerp(s,At*.5).normalize()}},yx=async(n,t)=>{var d,x;const{setStatus:e,setTrackData:r,setError:i}=Se.getState().actions,s=t==null?void 0:t.signal;console.log("[Workflow] Starting audio processing workflow",{fileName:n.name,fileSize:n.size,fileType:n.type,hasExternalSignal:!!s,externalSignalAborted:s==null?void 0:s.aborted});const a=()=>{if(s!=null&&s.aborted)throw console.log("[Workflow] External signal aborted, throwing AbortError"),new DOMException("Aborted","AbortError")},o=new AbortController,c=setTimeout(()=>{console.log("[Workflow] Timeout fired, aborting controller"),o.abort(),i({title:"Processing Timeout",message:"The audio analysis is taking longer than expected. Please try a different file or check the server status."})},6e4),h=()=>{console.log("[Workflow] External signal aborted, cleaning up"),clearTimeout(c),o.signal.aborted||o.abort()},u=()=>{console.log("[Workflow] Internal controller aborted, cleaning up"),clearTimeout(c)};s==null||s.addEventListener("abort",h),o.signal.addEventListener("abort",u);try{a();const{setWorkflowProgress:g}=Se.getState().actions;g(10),e(ue.Generating,"Translating sound into structure..."),a(),console.log("[Workflow] Calling generateRideBlueprint with file:",n.name);try{const Et=(globalThis==null?void 0:globalThis.BACKEND_URL)||((d=require("../config/environment").env)==null?void 0:d.VITE_BACKEND_URL)||"unknown";console.debug("[Workflow] Backend URL (effective):",Et)}catch{}const{blueprint:A,features:P}=await Bp(n,o.signal,t==null?void 0:t.generationOptions);console.log("[Workflow] Successfully received blueprint and audio features"),console.log("[Workflow] Blueprint data:",{hasBlueprintProp:!!A,blueprintType:typeof A,hasTrack:!!(A!=null&&A.track),trackLength:(x=A==null?void 0:A.track)==null?void 0:x.length,blueprintKeys:A?Object.keys(A):[]}),clearTimeout(c),console.log("[Workflow] Timeout cleared successfully"),a(),g(60),e(ue.Generating,"Refining for physical plausibility..."),a(),console.log("[Workflow] Refining blueprint...");const H=Up(A);let V=null;const At=2500,tt=8e3;try{const{setSkyboxUrl:Et}=Se.getState().actions;try{Et(null)}catch{}const Lt=H.moodDescription||H.rideName||"A surreal and cinematic sky",Dt={...H,generationOptions:(t==null?void 0:t.generationOptions)??Se.getState().generationOptions};try{V=kp(Lt,Dt).then(Wt=>{try{Et(Wt)}catch{}return Wt}).catch(Wt=>(console.info("[Workflow] Early skybox generation failed, continuing without custom skybox:",Wt instanceof Error?Wt.message:String(Wt)),null))}catch(Wt){console.info("[Workflow] Failed to start early skybox generation",Wt),V=null}if(V)try{await Promise.race([V,new Promise(se=>setTimeout(()=>se(null),At))])&&console.log("[Workflow] Skybox finished during build fast-path")}catch{}}catch(Et){console.info("[Workflow] Skybox pre-generation step encountered an error, continuing",Et),V=null}try{console.log("[Workflow] Refined segment components",H.track.map((Et,Lt)=>({index:Lt,component:Et.component})))}catch{}a(),g(85),e(ue.Generating,"Constructing ephemeral cathedral..."),a(),console.log("[Workflow] Building track data...");const{setBlueprint:lt,setAudioFeatures:wt}=Se.getState().actions;lt(H),wt(P),a(),g(100),console.log("[Workflow] Building track data object and storing in app state");try{const Et=mx(H,P);a();const{setTrackData:Lt}=Se.getState().actions;Lt(Et),console.log("[Workflow] Track data set in store (points:",Et.path.length,"segments:",Et.segmentDetails.length,")")}catch(Et){console.warn("[Workflow] Failed to build track data, aborting Ready transition",Et),i({title:"Track Build Failed",message:"Could not construct track geometry from blueprint."});return}try{if(V){console.log("[Workflow] Waiting up to",tt,"ms for skybox to finish before Ready");const{setSkyboxUrl:Et}=Se.getState().actions;try{const Lt=await Promise.race([V,new Promise(Dt=>setTimeout(()=>Dt(null),tt))]);if(Lt){console.log("[Workflow] Skybox generation completed before Ready");try{Et(Lt)}catch{}}else console.log("[Workflow] Skybox did not finish within max wait, continuing without it")}catch(Lt){console.info("[Workflow] Error while awaiting skybox result, continuing",Lt)}}}catch(Et){console.info("[Workflow] Skybox wait logic failed, continuing",Et)}console.log("[Workflow] Setting status to Ready"),e(ue.Ready)}catch(g){if(g instanceof DOMException&&g.name==="AbortError"){console.log("Audio processing was aborted.");return}const A=g instanceof Error?g.message:typeof g=="string"?g:"An unknown error occurred during processing.";console.error("Error in audio processing workflow:",A),i({title:"Could Not Process Audio",message:`An error occurred while processing '${n.name}'. ${A}`})}},xx=()=>{const n=Se(e=>e.audioFile),t=Se(e=>e.generationOptions);te.useEffect(()=>{if(!n)return;const e=new AbortController;return yx(n,{generationOptions:t,signal:e.signal}),()=>{console.log("Cancelling previous audio processing workflow."),e.abort()}},[n,t])},Mr={shaders:new Map,lygiaResolver:null,webglContext:null,audioContext:null};let Gu=!1;const Vu=[];async function gx(){const t=["/shaders/velFrag.resolved.glsl","/shaders/posFrag.resolved.glsl","/shaders/baseVelFrag.glsl","/shaders/basePosFrag.glsl"].map(async e=>{try{const r=await fetch(e);if(r.ok){const i=await r.text();Mr.shaders.set(e,i),console.log(`[Preloader] Cached shader: ${e}`)}}catch(r){console.debug(`[Preloader] Could not preload ${e}`,r)}});await Promise.allSettled(t)}async function _x(){try{try{const r=await import(window.location.origin+"/lygia/resolve.esm.js");if(Mr.lygiaResolver=r&&(r.default||r.resolveLygia||r.resolve)?r.default||r.resolveLygia||r.resolve:null,Mr.lygiaResolver){console.log("[Preloader] Cached LYGIA resolver (local)");return}}catch{}const t=await import("https://lygia.xyz/resolve.esm.js");Mr.lygiaResolver=t&&(t.default||t.resolveLygia||t.resolve)?t.default||t.resolveLygia||t.resolve:null,Mr.lygiaResolver&&console.log("[Preloader] Cached LYGIA resolver (CDN)")}catch(n){console.debug("[Preloader] Could not preload LYGIA resolver",n)}}function bx(){try{const n=document.createElement("canvas");n.width=1,n.height=1;const t=n.getContext("webgl2",{alpha:!0,antialias:!0,premultipliedAlpha:!1})||n.getContext("webgl",{alpha:!0,antialias:!0,premultipliedAlpha:!1});t&&(Mr.webglContext=t,t.clearColor(0,0,0,0),t.clear(t.COLOR_BUFFER_BIT),t.getExtension&&(t.getExtension("EXT_color_buffer_float"),t.getExtension("OES_texture_float_linear")),console.log("[Preloader] WebGL context initialized"))}catch(n){console.debug("[Preloader] Could not preload WebGL context",n)}}function vx(){try{const n=window.AudioContext||window.webkitAudioContext;n&&(Mr.audioContext=new n,Mr.audioContext.suspend(),console.log("[Preloader] AudioContext initialized (suspended)"))}catch(n){console.debug("[Preloader] Could not preload AudioContext",n)}}function Ex(){Gu||(Gu=!0,console.log("[Preloader] Starting resource preload..."),Vu.push(gx(),_x()),bx(),vx(),Promise.allSettled(Vu).then(()=>{console.log("[Preloader] All preload operations completed")}))}function z_(n){return Mr.shaders.get(n)||null}function U_(){return Mr.lygiaResolver}const jn=({stage:n,progress:t})=>{const e={analyzing:{title:"Analyzing Audio",description:"Extracting musical features from your track...",icon:""},generating:{title:"Generating Blueprint",description:"AI is designing your roller coaster...",icon:""},building:{title:"Building Track",description:"Creating the 3D visualization...",icon:""},loading:{title:"Loading Scene",description:"Preparing your ride...",icon:""}},{title:r,description:i,icon:s}=e[n];return U.jsx("div",{className:"fixed inset-0 flex items-center justify-center bg-black/90 z-50",children:U.jsxs("div",{className:"text-center max-w-md px-8",children:[U.jsx("div",{className:"text-6xl mb-6 animate-bounce",children:s}),U.jsx("h2",{className:"text-3xl font-bold mb-3 text-white",children:r}),U.jsx("p",{className:"text-gray-400 mb-8",children:i}),t!==void 0&&U.jsx("div",{className:"w-full bg-gray-800 rounded-full h-3 overflow-hidden mb-4",children:U.jsx("div",{className:"h-full bg-gradient-to-r from-purple-600 to-pink-600 transition-all duration-300 ease-out",style:{width:`${t}%`}})}),U.jsxs("div",{className:"flex justify-center space-x-2",children:[U.jsx("div",{className:"w-3 h-3 bg-purple-600 rounded-full animate-pulse",style:{animationDelay:"0ms"}}),U.jsx("div",{className:"w-3 h-3 bg-purple-600 rounded-full animate-pulse",style:{animationDelay:"150ms"}}),U.jsx("div",{className:"w-3 h-3 bg-purple-600 rounded-full animate-pulse",style:{animationDelay:"300ms"}})]})]})})};class Ax extends te.Component{constructor(){super(...arguments);$c(this,"state",{hasError:!1})}static getDerivedStateFromError(e){return{hasError:!0}}componentDidCatch(e,r){console.error("ErrorBoundary caught an error:",e,r);const{setError:i}=Se.getState().actions;i({title:"Rendering Error",message:e.message||"A critical error occurred in the 3D visualization."})}render(){return this.state.hasError?this.props.fallback??null:this.props.children}}var Qs={exports:{}},Tx=Qs.exports,ju;function Sx(){return ju||(ju=1,(function(n,t){(function(e,r){n.exports=r()})(Tx,(function(){var e=function(l){return l instanceof Uint8Array||l instanceof Uint16Array||l instanceof Uint32Array||l instanceof Int8Array||l instanceof Int16Array||l instanceof Int32Array||l instanceof Float32Array||l instanceof Float64Array||l instanceof Uint8ClampedArray},r=function(l,p){for(var E=Object.keys(p),k=0;k<E.length;++k)l[E[k]]=p[E[k]];return l},i=`
`;function s(l){return typeof atob<"u"?atob(l):"base64:"+l}function a(l){var p=new Error("(regl) "+l);throw console.error(p),p}function o(l,p){l||a(p)}function c(l){return l?": "+l:""}function h(l,p,E){l in p||a("unknown parameter ("+l+")"+c(E)+". possible values: "+Object.keys(p).join())}function u(l,p){e(l)||a("invalid parameter type"+c(p)+". must be a typed array")}function d(l,p){switch(p){case"number":return typeof l=="number";case"object":return typeof l=="object";case"string":return typeof l=="string";case"boolean":return typeof l=="boolean";case"function":return typeof l=="function";case"undefined":return typeof l>"u";case"symbol":return typeof l=="symbol"}}function x(l,p,E){d(l,p)||a("invalid parameter type"+c(E)+". expected "+p+", got "+typeof l)}function g(l,p){l>=0&&(l|0)===l||a("invalid parameter type, ("+l+")"+c(p)+". must be a nonnegative integer")}function A(l,p,E){p.indexOf(l)<0&&a("invalid value"+c(E)+". must be one of: "+p)}var P=["gl","canvas","container","attributes","pixelRatio","extensions","optionalExtensions","profile","onDone"];function H(l){Object.keys(l).forEach(function(p){P.indexOf(p)<0&&a('invalid regl constructor argument "'+p+'". must be one of '+P)})}function V(l,p){for(l=l+"";l.length<p;)l=" "+l;return l}function At(){this.name="unknown",this.lines=[],this.index={},this.hasErrors=!1}function tt(l,p){this.number=l,this.line=p,this.errors=[]}function lt(l,p,E){this.file=l,this.line=p,this.message=E}function wt(){var l=new Error,p=(l.stack||l).toString(),E=/compileProcedure.*\n\s*at.*\((.*)\)/.exec(p);if(E)return E[1];var k=/compileProcedure.*\n\s*at\s+(.*)(\n|$)/.exec(p);return k?k[1]:"unknown"}function Et(){var l=new Error,p=(l.stack||l).toString(),E=/at REGLCommand.*\n\s+at.*\((.*)\)/.exec(p);if(E)return E[1];var k=/at REGLCommand.*\n\s+at\s+(.*)\n/.exec(p);return k?k[1]:"unknown"}function Lt(l,p){var E=l.split(`
`),k=1,Y=0,B={unknown:new At,0:new At};B.unknown.name=B[0].name=p||wt(),B.unknown.lines.push(new tt(0,""));for(var j=0;j<E.length;++j){var Z=E[j],q=/^\s*#\s*(\w+)\s+(.+)\s*$/.exec(Z);if(q)switch(q[1]){case"line":var nt=/(\d+)(\s+\d+)?/.exec(q[2]);nt&&(k=nt[1]|0,nt[2]&&(Y=nt[2]|0,Y in B||(B[Y]=new At)));break;case"define":var at=/SHADER_NAME(_B64)?\s+(.*)$/.exec(q[2]);at&&(B[Y].name=at[1]?s(at[2]):at[2]);break}B[Y].lines.push(new tt(k++,Z))}return Object.keys(B).forEach(function(st){var ut=B[st];ut.lines.forEach(function(K){ut.index[K.number]=K})}),B}function Dt(l){var p=[];return l.split(`
`).forEach(function(E){if(!(E.length<5)){var k=/^ERROR:\s+(\d+):(\d+):\s*(.*)$/.exec(E);k?p.push(new lt(k[1]|0,k[2]|0,k[3].trim())):E.length>0&&p.push(new lt("unknown",0,E))}}),p}function Wt(l,p){p.forEach(function(E){var k=l[E.file];if(k){var Y=k.index[E.line];if(Y){Y.errors.push(E),k.hasErrors=!0;return}}l.unknown.hasErrors=!0,l.unknown.lines[0].errors.push(E)})}function se(l,p,E,k,Y){if(!l.getShaderParameter(p,l.COMPILE_STATUS)){var B=l.getShaderInfoLog(p),j=k===l.FRAGMENT_SHADER?"fragment":"vertex";de(E,"string",j+" shader source must be a string",Y);var Z=Lt(E,Y),q=Dt(B);Wt(Z,q),Object.keys(Z).forEach(function(nt){var at=Z[nt];if(!at.hasErrors)return;var st=[""],ut=[""];function K(it,R){st.push(it),ut.push(R||"")}K("file number "+nt+": "+at.name+`
`,"color:red;text-decoration:underline;font-weight:bold"),at.lines.forEach(function(it){if(it.errors.length>0){K(V(it.number,4)+"|  ","background-color:yellow; font-weight:bold"),K(it.line+i,"color:red; background-color:yellow; font-weight:bold");var R=0;it.errors.forEach(function(G){var rt=G.message,vt=/^\s*'(.*)'\s*:\s*(.*)$/.exec(rt);if(vt){var J=vt[1];switch(rt=vt[2],J){case"assign":J="=";break}R=Math.max(it.line.indexOf(J,R),0)}else R=0;K(V("| ",6)),K(V("^^^",R+3)+i,"font-weight:bold"),K(V("| ",6)),K(rt+i,"font-weight:bold")}),K(V("| ",6)+i)}else K(V(it.number,4)+"|  "),K(it.line+i,"color:red")}),typeof document<"u"&&!window.chrome?(ut[0]=st.join("%c"),console.log.apply(console,ut)):console.log(st.join(""))}),o.raise("Error compiling "+j+" shader, "+Z[0].name)}}function ce(l,p,E,k,Y){if(!l.getProgramParameter(p,l.LINK_STATUS)){var B=l.getProgramInfoLog(p),j=Lt(E,Y),Z=Lt(k,Y),q='Error linking program with vertex shader, "'+Z[0].name+'", and fragment shader "'+j[0].name+'"';typeof document<"u"?console.log("%c"+q+i+"%c"+B,"color:red;text-decoration:underline;font-weight:bold","color:red"):console.log(q+i+B),o.raise(q)}}function kt(l){l._commandRef=wt()}function jt(l,p,E,k){kt(l);function Y(q){return q?k.id(q):0}l._fragId=Y(l.static.frag),l._vertId=Y(l.static.vert);function B(q,nt){Object.keys(nt).forEach(function(at){q[k.id(at)]=!0})}var j=l._uniformSet={};B(j,p.static),B(j,p.dynamic);var Z=l._attributeSet={};B(Z,E.static),B(Z,E.dynamic),l._hasCount="count"in l.static||"count"in l.dynamic||"elements"in l.static||"elements"in l.dynamic}function ee(l,p){var E=Et();a(l+" in command "+(p||wt())+(E==="unknown"?"":" called from "+E))}function Xt(l,p,E){l||ee(p,E||wt())}function $t(l,p,E,k){l in p||ee("unknown parameter ("+l+")"+c(E)+". possible values: "+Object.keys(p).join(),k||wt())}function de(l,p,E,k){d(l,p)||ee("invalid parameter type"+c(E)+". expected "+p+", got "+typeof l,k||wt())}function me(l){l()}function Kt(l,p,E){l.texture?A(l.texture._texture.internalformat,p,"unsupported texture format for attachment"):A(l.renderbuffer._renderbuffer.format,E,"unsupported renderbuffer format for attachment")}var re=33071,ye=9728,ie=9984,xe=9985,_e=9986,Ye=9987,Be=5120,Ue=5121,Me=5122,be=5123,qe=5124,Cr=5125,or=5126,Hr=32819,lr=32820,Wr=33635,Oi=34042,ci=36193,Q={};Q[Be]=Q[Ue]=1,Q[Me]=Q[be]=Q[ci]=Q[Wr]=Q[Hr]=Q[lr]=2,Q[qe]=Q[Cr]=Q[or]=Q[Oi]=4;function St(l,p){return l===lr||l===Hr||l===Wr?2:l===Oi?4:Q[l]*p}function pt(l){return!(l&l-1)&&!!l}function Pt(l,p,E){var k,Y=p.width,B=p.height,j=p.channels;o(Y>0&&Y<=E.maxTextureSize&&B>0&&B<=E.maxTextureSize,"invalid texture shape"),(l.wrapS!==re||l.wrapT!==re)&&o(pt(Y)&&pt(B),"incompatible wrap mode for texture, both width and height must be power of 2"),p.mipmask===1?Y!==1&&B!==1&&o(l.minFilter!==ie&&l.minFilter!==_e&&l.minFilter!==xe&&l.minFilter!==Ye,"min filter requires mipmap"):(o(pt(Y)&&pt(B),"texture must be a square power of 2 to support mipmapping"),o(p.mipmask===(Y<<1)-1,"missing or incomplete mipmap data")),p.type===or&&(E.extensions.indexOf("oes_texture_float_linear")<0&&o(l.minFilter===ye&&l.magFilter===ye,"filter not supported, must enable oes_texture_float_linear"),o(!l.genMipmaps,"mipmap generation not supported with float textures"));var Z=p.images;for(k=0;k<16;++k)if(Z[k]){var q=Y>>k,nt=B>>k;o(p.mipmask&1<<k,"missing mipmap data");var at=Z[k];if(o(at.width===q&&at.height===nt,"invalid shape for mip images"),o(at.format===p.format&&at.internalformat===p.internalformat&&at.type===p.type,"incompatible type for mip image"),!at.compressed)if(at.data){var st=Math.ceil(St(at.type,j)*q/at.unpackAlignment)*at.unpackAlignment;o(at.data.byteLength===st*nt,"invalid data for image, buffer size is inconsistent with image format")}else at.element||at.copy}else l.genMipmaps||o((p.mipmask&1<<k)===0,"extra mipmap data");p.compressed&&o(!l.genMipmaps,"mipmap generation for compressed images not supported")}function Ce(l,p,E,k){var Y=l.width,B=l.height,j=l.channels;o(Y>0&&Y<=k.maxTextureSize&&B>0&&B<=k.maxTextureSize,"invalid texture shape"),o(Y===B,"cube map must be square"),o(p.wrapS===re&&p.wrapT===re,"wrap mode not supported by cube map");for(var Z=0;Z<E.length;++Z){var q=E[Z];o(q.width===Y&&q.height===B,"inconsistent cube map face shape"),p.genMipmaps&&(o(!q.compressed,"can not generate mipmap for compressed textures"),o(q.mipmask===1,"can not specify mipmaps and generate mipmaps"));for(var nt=q.images,at=0;at<16;++at){var st=nt[at];if(st){var ut=Y>>at,K=B>>at;o(q.mipmask&1<<at,"missing mipmap data"),o(st.width===ut&&st.height===K,"invalid shape for mip images"),o(st.format===l.format&&st.internalformat===l.internalformat&&st.type===l.type,"incompatible type for mip image"),st.compressed||(st.data?o(st.data.byteLength===ut*K*Math.max(St(st.type,j),st.unpackAlignment),"invalid data for image, buffer size is inconsistent with image format"):st.element||st.copy)}}}}var m=r(o,{optional:me,raise:a,commandRaise:ee,command:Xt,parameter:h,commandParameter:$t,constructor:H,type:x,commandType:de,isTypedArray:u,nni:g,oneOf:A,shaderError:se,linkError:ce,callSite:Et,saveCommandRef:kt,saveDrawInfo:jt,framebufferFormat:Kt,guessCommand:wt,texture2D:Pt,textureCube:Ce}),yn=0,mf=0,pf=5,yf=6;function hi(l,p){this.id=yn++,this.type=l,this.data=p}function qo(l){return l.replace(/\\/g,"\\\\").replace(/"/g,'\\"')}function xn(l){if(l.length===0)return[];var p=l.charAt(0),E=l.charAt(l.length-1);if(l.length>1&&p===E&&(p==='"'||p==="'"))return['"'+qo(l.substr(1,l.length-2))+'"'];var k=/\[(false|true|null|\d+|'[^']*'|"[^"]*")\]/.exec(l);if(k)return xn(l.substr(0,k.index)).concat(xn(k[1])).concat(xn(l.substr(k.index+k[0].length)));var Y=l.split(".");if(Y.length===1)return['"'+qo(l)+'"'];for(var B=[],j=0;j<Y.length;++j)B=B.concat(xn(Y[j]));return B}function Zo(l){return"["+xn(l).join("][")+"]"}function xf(l,p){return new hi(l,Zo(p+""))}function gf(l){return typeof l=="function"&&!l._reglType||l instanceof hi}function Ko(l,p){if(typeof l=="function")return new hi(mf,l);if(typeof l=="number"||typeof l=="boolean")return new hi(pf,l);if(Array.isArray(l))return new hi(yf,l.map(function(E,k){return Ko(E,p+"["+k+"]")}));if(l instanceof hi)return l;m(!1,"invalid option type in uniform "+p)}var rr={DynamicVariable:hi,define:xf,isDynamic:gf,unbox:Ko,accessor:Zo},la={next:typeof requestAnimationFrame=="function"?function(l){return requestAnimationFrame(l)}:function(l){return setTimeout(l,16)},cancel:typeof cancelAnimationFrame=="function"?function(l){return cancelAnimationFrame(l)}:clearTimeout},Qo=typeof performance<"u"&&performance.now?function(){return performance.now()}:function(){return+new Date};function _f(){var l={"":0},p=[""];return{id:function(E){var k=l[E];return k||(k=l[E]=p.length,p.push(E),k)},str:function(E){return p[E]}}}function bf(l,p,E){var k=document.createElement("canvas");r(k.style,{border:0,margin:0,padding:0,top:0,left:0,width:"100%",height:"100%"}),l.appendChild(k),l===document.body&&(k.style.position="absolute",r(l.style,{margin:0,padding:0}));function Y(){var Z=window.innerWidth,q=window.innerHeight;if(l!==document.body){var nt=k.getBoundingClientRect();Z=nt.right-nt.left,q=nt.bottom-nt.top}k.width=E*Z,k.height=E*q}var B;l!==document.body&&typeof ResizeObserver=="function"?(B=new ResizeObserver(function(){setTimeout(Y)}),B.observe(l)):window.addEventListener("resize",Y,!1);function j(){B?B.disconnect():window.removeEventListener("resize",Y),l.removeChild(k)}return Y(),{canvas:k,onDestroy:j}}function vf(l,p){function E(k){try{return l.getContext(k,p)}catch{return null}}return E("webgl")||E("experimental-webgl")||E("webgl-experimental")}function Ef(l){return typeof l.nodeName=="string"&&typeof l.appendChild=="function"&&typeof l.getBoundingClientRect=="function"}function Af(l){return typeof l.drawArrays=="function"||typeof l.drawElements=="function"}function tl(l){return typeof l=="string"?l.split():(m(Array.isArray(l),"invalid extension array"),l)}function el(l){return typeof l=="string"?(m(typeof document<"u","not supported outside of DOM"),document.querySelector(l)):l}function Tf(l){var p=l||{},E,k,Y,B,j={},Z=[],q=[],nt=typeof window>"u"?1:window.devicePixelRatio,at=!1,st=function(it){it&&m.raise(it)},ut=function(){};if(typeof p=="string"?(m(typeof document<"u","selector queries only supported in DOM environments"),E=document.querySelector(p),m(E,"invalid query string for element")):typeof p=="object"?Ef(p)?E=p:Af(p)?(B=p,Y=B.canvas):(m.constructor(p),"gl"in p?B=p.gl:"canvas"in p?Y=el(p.canvas):"container"in p&&(k=el(p.container)),"attributes"in p&&(j=p.attributes,m.type(j,"object","invalid context attributes")),"extensions"in p&&(Z=tl(p.extensions)),"optionalExtensions"in p&&(q=tl(p.optionalExtensions)),"onDone"in p&&(m.type(p.onDone,"function","invalid or missing onDone callback"),st=p.onDone),"profile"in p&&(at=!!p.profile),"pixelRatio"in p&&(nt=+p.pixelRatio,m(nt>0,"invalid pixel ratio"))):m.raise("invalid arguments to regl"),E&&(E.nodeName.toLowerCase()==="canvas"?Y=E:k=E),!B){if(!Y){m(typeof document<"u","must manually specify webgl context outside of DOM environments");var K=bf(k||document.body,st,nt);if(!K)return null;Y=K.canvas,ut=K.onDestroy}j.premultipliedAlpha===void 0&&(j.premultipliedAlpha=!0),B=vf(Y,j)}return B?{gl:B,canvas:Y,container:k,extensions:Z,optionalExtensions:q,pixelRatio:nt,profile:at,onDone:st,onDestroy:ut}:(ut(),st("webgl not supported, try upgrading your browser or graphics drivers http://get.webgl.org"),null)}function Sf(l,p){var E={};function k(j){m.type(j,"string","extension name must be string");var Z=j.toLowerCase(),q;try{q=E[Z]=l.getExtension(Z)}catch{}return!!q}for(var Y=0;Y<p.extensions.length;++Y){var B=p.extensions[Y];if(!k(B))return p.onDestroy(),p.onDone('"'+B+'" extension is not supported by the current WebGL context, try upgrading your system or a different browser'),null}return p.optionalExtensions.forEach(k),{extensions:E,restore:function(){Object.keys(E).forEach(function(j){if(E[j]&&!k(j))throw new Error("(regl): error restoring extension "+j)})}}}function ir(l,p){for(var E=Array(l),k=0;k<l;++k)E[k]=p(k);return E}var wf=5120,Mf=5121,Cf=5122,If=5123,Rf=5124,Of=5125,Nf=5126;function Lf(l){for(var p=16;p<=1<<28;p*=16)if(l<=p)return p;return 0}function rl(l){var p,E;return p=(l>65535)<<4,l>>>=p,E=(l>255)<<3,l>>>=E,p|=E,E=(l>15)<<2,l>>>=E,p|=E,E=(l>3)<<1,l>>>=E,p|=E,p|l>>1}function il(){var l=ir(8,function(){return[]});function p(B){var j=Lf(B),Z=l[rl(j)>>2];return Z.length>0?Z.pop():new ArrayBuffer(j)}function E(B){l[rl(B.byteLength)>>2].push(B)}function k(B,j){var Z=null;switch(B){case wf:Z=new Int8Array(p(j),0,j);break;case Mf:Z=new Uint8Array(p(j),0,j);break;case Cf:Z=new Int16Array(p(2*j),0,j);break;case If:Z=new Uint16Array(p(2*j),0,j);break;case Rf:Z=new Int32Array(p(4*j),0,j);break;case Of:Z=new Uint32Array(p(4*j),0,j);break;case Nf:Z=new Float32Array(p(4*j),0,j);break;default:return null}return Z.length!==j?Z.subarray(0,j):Z}function Y(B){E(B.buffer)}return{alloc:p,free:E,allocType:k,freeType:Y}}var Ie=il();Ie.zero=il();var Df=3408,Ff=3410,Pf=3411,Bf=3412,kf=3413,zf=3414,Uf=3415,Gf=33901,Vf=33902,jf=3379,Hf=3386,Wf=34921,Yf=36347,Xf=36348,$f=35661,Jf=35660,qf=34930,Zf=36349,Kf=34076,Qf=34024,td=7936,ed=7937,rd=7938,id=35724,nd=34047,sd=36063,ad=34852,Zn=3553,nl=34067,od=34069,ld=33984,gn=6408,ca=5126,sl=5121,ha=36160,cd=36053,hd=36064,ud=16384,fd=function(l,p){var E=1;p.ext_texture_filter_anisotropic&&(E=l.getParameter(nd));var k=1,Y=1;p.webgl_draw_buffers&&(k=l.getParameter(ad),Y=l.getParameter(sd));var B=!!p.oes_texture_float;if(B){var j=l.createTexture();l.bindTexture(Zn,j),l.texImage2D(Zn,0,gn,1,1,0,gn,ca,null);var Z=l.createFramebuffer();if(l.bindFramebuffer(ha,Z),l.framebufferTexture2D(ha,hd,Zn,j,0),l.bindTexture(Zn,null),l.checkFramebufferStatus(ha)!==cd)B=!1;else{l.viewport(0,0,1,1),l.clearColor(1,0,0,1),l.clear(ud);var q=Ie.allocType(ca,4);l.readPixels(0,0,1,1,gn,ca,q),l.getError()?B=!1:(l.deleteFramebuffer(Z),l.deleteTexture(j),B=q[0]===1),Ie.freeType(q)}}var nt=typeof navigator<"u"&&(/MSIE/.test(navigator.userAgent)||/Trident\//.test(navigator.appVersion)||/Edge/.test(navigator.userAgent)),at=!0;if(!nt){var st=l.createTexture(),ut=Ie.allocType(sl,36);l.activeTexture(ld),l.bindTexture(nl,st),l.texImage2D(od,0,gn,3,3,0,gn,sl,ut),Ie.freeType(ut),l.bindTexture(nl,null),l.deleteTexture(st),at=!l.getError()}return{colorBits:[l.getParameter(Ff),l.getParameter(Pf),l.getParameter(Bf),l.getParameter(kf)],depthBits:l.getParameter(zf),stencilBits:l.getParameter(Uf),subpixelBits:l.getParameter(Df),extensions:Object.keys(p).filter(function(K){return!!p[K]}),maxAnisotropic:E,maxDrawbuffers:k,maxColorAttachments:Y,pointSizeDims:l.getParameter(Gf),lineWidthDims:l.getParameter(Vf),maxViewportDims:l.getParameter(Hf),maxCombinedTextureUnits:l.getParameter($f),maxCubeMapSize:l.getParameter(Kf),maxRenderbufferSize:l.getParameter(Qf),maxTextureUnits:l.getParameter(qf),maxTextureSize:l.getParameter(jf),maxAttributes:l.getParameter(Wf),maxVertexUniforms:l.getParameter(Yf),maxVertexTextureUnits:l.getParameter(Jf),maxVaryingVectors:l.getParameter(Xf),maxFragmentUniforms:l.getParameter(Zf),glsl:l.getParameter(id),renderer:l.getParameter(ed),vendor:l.getParameter(td),version:l.getParameter(rd),readFloat:B,npotTextureCube:at}};function dr(l){return!!l&&typeof l=="object"&&Array.isArray(l.shape)&&Array.isArray(l.stride)&&typeof l.offset=="number"&&l.shape.length===l.stride.length&&(Array.isArray(l.data)||e(l.data))}var nr=function(l){return Object.keys(l).map(function(p){return l[p]})},Kn={shape:yd,flatten:pd};function dd(l,p,E){for(var k=0;k<p;++k)E[k]=l[k]}function md(l,p,E,k){for(var Y=0,B=0;B<p;++B)for(var j=l[B],Z=0;Z<E;++Z)k[Y++]=j[Z]}function al(l,p,E,k,Y,B){for(var j=B,Z=0;Z<p;++Z)for(var q=l[Z],nt=0;nt<E;++nt)for(var at=q[nt],st=0;st<k;++st)Y[j++]=at[st]}function ol(l,p,E,k,Y){for(var B=1,j=E+1;j<p.length;++j)B*=p[j];var Z=p[E];if(p.length-E===4){var q=p[E+1],nt=p[E+2],at=p[E+3];for(j=0;j<Z;++j)al(l[j],q,nt,at,k,Y),Y+=B}else for(j=0;j<Z;++j)ol(l[j],p,E+1,k,Y),Y+=B}function pd(l,p,E,k){var Y=1;if(p.length)for(var B=0;B<p.length;++B)Y*=p[B];else Y=0;var j=k||Ie.allocType(E,Y);switch(p.length){case 0:break;case 1:dd(l,p[0],j);break;case 2:md(l,p[0],p[1],j);break;case 3:al(l,p[0],p[1],p[2],j,0);break;default:ol(l,p,0,j,0)}return j}function yd(l){for(var p=[],E=l;E.length;E=E[0])p.push(E.length);return p}var ua={"[object Int8Array]":5120,"[object Int16Array]":5122,"[object Int32Array]":5124,"[object Uint8Array]":5121,"[object Uint8ClampedArray]":5121,"[object Uint16Array]":5123,"[object Uint32Array]":5125,"[object Float32Array]":5126,"[object Float64Array]":5121,"[object ArrayBuffer]":5121},xd=5120,gd=5122,_d=5124,bd=5121,vd=5123,Ed=5125,Ad=5126,Td=5126,ui={int8:xd,int16:gd,int32:_d,uint8:bd,uint16:vd,uint32:Ed,float:Ad,float32:Td},Sd=35048,wd=35040,Qn={dynamic:Sd,stream:wd,static:35044},fa=Kn.flatten,ll=Kn.shape,cl=35044,Md=35040,da=5121,ma=5126,Yr=[];Yr[5120]=1,Yr[5122]=2,Yr[5124]=4,Yr[5121]=1,Yr[5123]=2,Yr[5125]=4,Yr[5126]=4;function ts(l){return ua[Object.prototype.toString.call(l)]|0}function hl(l,p){for(var E=0;E<p.length;++E)l[E]=p[E]}function ul(l,p,E,k,Y,B,j){for(var Z=0,q=0;q<E;++q)for(var nt=0;nt<k;++nt)l[Z++]=p[Y*q+B*nt+j]}function Cd(l,p,E,k){var Y=0,B={};function j(R){this.id=Y++,this.buffer=l.createBuffer(),this.type=R,this.usage=cl,this.byteLength=0,this.dimension=1,this.dtype=da,this.persistentData=null,E.profile&&(this.stats={size:0})}j.prototype.bind=function(){l.bindBuffer(this.type,this.buffer)},j.prototype.destroy=function(){ut(this)};var Z=[];function q(R,G){var rt=Z.pop();return rt||(rt=new j(R)),rt.bind(),st(rt,G,Md,0,1,!1),rt}function nt(R){Z.push(R)}function at(R,G,rt){R.byteLength=G.byteLength,l.bufferData(R.type,G,rt)}function st(R,G,rt,vt,J,_t){var yt;if(R.usage=rt,Array.isArray(G)){if(R.dtype=vt||ma,G.length>0){var Ft;if(Array.isArray(G[0])){yt=ll(G);for(var X=1,W=1;W<yt.length;++W)X*=yt[W];R.dimension=X,Ft=fa(G,yt,R.dtype),at(R,Ft,rt),_t?R.persistentData=Ft:Ie.freeType(Ft)}else if(typeof G[0]=="number"){R.dimension=J;var Ct=Ie.allocType(R.dtype,G.length);hl(Ct,G),at(R,Ct,rt),_t?R.persistentData=Ct:Ie.freeType(Ct)}else e(G[0])?(R.dimension=G[0].length,R.dtype=vt||ts(G[0])||ma,Ft=fa(G,[G.length,G[0].length],R.dtype),at(R,Ft,rt),_t?R.persistentData=Ft:Ie.freeType(Ft)):m.raise("invalid buffer data")}}else if(e(G))R.dtype=vt||ts(G),R.dimension=J,at(R,G,rt),_t&&(R.persistentData=new Uint8Array(new Uint8Array(G.buffer)));else if(dr(G)){yt=G.shape;var ft=G.stride,et=G.offset,dt=0,mt=0,Ht=0,Gt=0;yt.length===1?(dt=yt[0],mt=1,Ht=ft[0],Gt=0):yt.length===2?(dt=yt[0],mt=yt[1],Ht=ft[0],Gt=ft[1]):m.raise("invalid shape"),R.dtype=vt||ts(G.data)||ma,R.dimension=mt;var xt=Ie.allocType(R.dtype,dt*mt);ul(xt,G.data,dt,mt,Ht,Gt,et),at(R,xt,rt),_t?R.persistentData=xt:Ie.freeType(xt)}else G instanceof ArrayBuffer?(R.dtype=da,R.dimension=J,at(R,G,rt),_t&&(R.persistentData=new Uint8Array(new Uint8Array(G)))):m.raise("invalid buffer data")}function ut(R){p.bufferCount--,k(R);var G=R.buffer;m(G,"buffer must not be deleted already"),l.deleteBuffer(G),R.buffer=null,delete B[R.id]}function K(R,G,rt,vt){p.bufferCount++;var J=new j(G);B[J.id]=J;function _t(X){var W=cl,Ct=null,ft=0,et=0,dt=1;return Array.isArray(X)||e(X)||dr(X)||X instanceof ArrayBuffer?Ct=X:typeof X=="number"?ft=X|0:X&&(m.type(X,"object","buffer arguments must be an object, a number or an array"),"data"in X&&(m(Ct===null||Array.isArray(Ct)||e(Ct)||dr(Ct),"invalid data for buffer"),Ct=X.data),"usage"in X&&(m.parameter(X.usage,Qn,"invalid buffer usage"),W=Qn[X.usage]),"type"in X&&(m.parameter(X.type,ui,"invalid buffer type"),et=ui[X.type]),"dimension"in X&&(m.type(X.dimension,"number","invalid dimension"),dt=X.dimension|0),"length"in X&&(m.nni(ft,"buffer length must be a nonnegative integer"),ft=X.length|0)),J.bind(),Ct?st(J,Ct,W,et,dt,vt):(ft&&l.bufferData(J.type,ft,W),J.dtype=et||da,J.usage=W,J.dimension=dt,J.byteLength=ft),E.profile&&(J.stats.size=J.byteLength*Yr[J.dtype]),_t}function yt(X,W){m(W+X.byteLength<=J.byteLength,"invalid buffer subdata call, buffer is too small.  Can't write data of size "+X.byteLength+" starting from offset "+W+" to a buffer of size "+J.byteLength),l.bufferSubData(J.type,W,X)}function Ft(X,W){var Ct=(W||0)|0,ft;if(J.bind(),e(X)||X instanceof ArrayBuffer)yt(X,Ct);else if(Array.isArray(X)){if(X.length>0)if(typeof X[0]=="number"){var et=Ie.allocType(J.dtype,X.length);hl(et,X),yt(et,Ct),Ie.freeType(et)}else if(Array.isArray(X[0])||e(X[0])){ft=ll(X);var dt=fa(X,ft,J.dtype);yt(dt,Ct),Ie.freeType(dt)}else m.raise("invalid buffer data")}else if(dr(X)){ft=X.shape;var mt=X.stride,Ht=0,Gt=0,xt=0,bt=0;ft.length===1?(Ht=ft[0],Gt=1,xt=mt[0],bt=0):ft.length===2?(Ht=ft[0],Gt=ft[1],xt=mt[0],bt=mt[1]):m.raise("invalid shape");var zt=Array.isArray(X.data)?J.dtype:ts(X.data),Vt=Ie.allocType(zt,Ht*Gt);ul(Vt,X.data,Ht,Gt,xt,bt,X.offset),yt(Vt,Ct),Ie.freeType(Vt)}else m.raise("invalid data for buffer subdata");return _t}return rt||_t(R),_t._reglType="buffer",_t._buffer=J,_t.subdata=Ft,E.profile&&(_t.stats=J.stats),_t.destroy=function(){ut(J)},_t}function it(){nr(B).forEach(function(R){R.buffer=l.createBuffer(),l.bindBuffer(R.type,R.buffer),l.bufferData(R.type,R.persistentData||R.byteLength,R.usage)})}return E.profile&&(p.getTotalBufferSize=function(){var R=0;return Object.keys(B).forEach(function(G){R+=B[G].stats.size}),R}),{create:K,createStream:q,destroyStream:nt,clear:function(){nr(B).forEach(ut),Z.forEach(ut)},getBuffer:function(R){return R&&R._buffer instanceof j?R._buffer:null},restore:it,_initBuffer:st}}var Id=0,Rd=0,Od=1,Nd=1,Ld=4,Dd=4,Xr={points:Id,point:Rd,lines:Od,line:Nd,triangles:Ld,triangle:Dd,"line loop":2,"line strip":3,"triangle strip":5,"triangle fan":6},Fd=0,Pd=1,_n=4,Bd=5120,Ni=5121,fl=5122,Li=5123,dl=5124,fi=5125,pa=34963,kd=35040,zd=35044;function Ud(l,p,E,k){var Y={},B=0,j={uint8:Ni,uint16:Li};p.oes_element_index_uint&&(j.uint32=fi);function Z(it){this.id=B++,Y[this.id]=this,this.buffer=it,this.primType=_n,this.vertCount=0,this.type=0}Z.prototype.bind=function(){this.buffer.bind()};var q=[];function nt(it){var R=q.pop();return R||(R=new Z(E.create(null,pa,!0,!1)._buffer)),st(R,it,kd,-1,-1,0,0),R}function at(it){q.push(it)}function st(it,R,G,rt,vt,J,_t){it.buffer.bind();var yt;if(R){var Ft=_t;!_t&&(!e(R)||dr(R)&&!e(R.data))&&(Ft=p.oes_element_index_uint?fi:Li),E._initBuffer(it.buffer,R,G,Ft,3)}else l.bufferData(pa,J,G),it.buffer.dtype=yt||Ni,it.buffer.usage=G,it.buffer.dimension=3,it.buffer.byteLength=J;if(yt=_t,!_t){switch(it.buffer.dtype){case Ni:case Bd:yt=Ni;break;case Li:case fl:yt=Li;break;case fi:case dl:yt=fi;break;default:m.raise("unsupported type for element array")}it.buffer.dtype=yt}it.type=yt,m(yt!==fi||!!p.oes_element_index_uint,"32 bit element buffers not supported, enable oes_element_index_uint first");var X=vt;X<0&&(X=it.buffer.byteLength,yt===Li?X>>=1:yt===fi&&(X>>=2)),it.vertCount=X;var W=rt;if(rt<0){W=_n;var Ct=it.buffer.dimension;Ct===1&&(W=Fd),Ct===2&&(W=Pd),Ct===3&&(W=_n)}it.primType=W}function ut(it){k.elementsCount--,m(it.buffer!==null,"must not double destroy elements"),delete Y[it.id],it.buffer.destroy(),it.buffer=null}function K(it,R){var G=E.create(null,pa,!0),rt=new Z(G._buffer);k.elementsCount++;function vt(J){if(!J)G(),rt.primType=_n,rt.vertCount=0,rt.type=Ni;else if(typeof J=="number")G(J),rt.primType=_n,rt.vertCount=J|0,rt.type=Ni;else{var _t=null,yt=zd,Ft=-1,X=-1,W=0,Ct=0;Array.isArray(J)||e(J)||dr(J)?_t=J:(m.type(J,"object","invalid arguments for elements"),"data"in J&&(_t=J.data,m(Array.isArray(_t)||e(_t)||dr(_t),"invalid data for element buffer")),"usage"in J&&(m.parameter(J.usage,Qn,"invalid element buffer usage"),yt=Qn[J.usage]),"primitive"in J&&(m.parameter(J.primitive,Xr,"invalid element buffer primitive"),Ft=Xr[J.primitive]),"count"in J&&(m(typeof J.count=="number"&&J.count>=0,"invalid vertex count for elements"),X=J.count|0),"type"in J&&(m.parameter(J.type,j,"invalid buffer type"),Ct=j[J.type]),"length"in J?W=J.length|0:(W=X,Ct===Li||Ct===fl?W*=2:(Ct===fi||Ct===dl)&&(W*=4))),st(rt,_t,yt,Ft,X,W,Ct)}return vt}return vt(it),vt._reglType="elements",vt._elements=rt,vt.subdata=function(J,_t){return G.subdata(J,_t),vt},vt.destroy=function(){ut(rt)},vt}return{create:K,createStream:nt,destroyStream:at,getElements:function(it){return typeof it=="function"&&it._elements instanceof Z?it._elements:null},clear:function(){nr(Y).forEach(ut)}}}var ml=new Float32Array(1),Gd=new Uint32Array(ml.buffer),Vd=5123;function pl(l){for(var p=Ie.allocType(Vd,l.length),E=0;E<l.length;++E)if(isNaN(l[E]))p[E]=65535;else if(l[E]===1/0)p[E]=31744;else if(l[E]===-1/0)p[E]=64512;else{ml[0]=l[E];var k=Gd[0],Y=k>>>31<<15,B=(k<<1>>>24)-127,j=k>>13&1023;if(B<-24)p[E]=Y;else if(B<-14){var Z=-14-B;p[E]=Y+(j+1024>>Z)}else B>15?p[E]=Y+31744:p[E]=Y+(B+15<<10)+j}return p}function ve(l){return Array.isArray(l)||e(l)}var yl=function(l){return!(l&l-1)&&!!l},jd=34467,Er=3553,ya=34067,es=34069,di=6408,xa=6406,rs=6407,bn=6409,is=6410,xl=32854,ga=32855,gl=36194,Hd=32819,Wd=32820,Yd=33635,Xd=34042,_a=6402,ns=34041,ba=35904,va=35906,Di=36193,Ea=33776,Aa=33777,Ta=33778,Sa=33779,_l=35986,bl=35987,vl=34798,El=35840,Al=35841,Tl=35842,Sl=35843,wl=36196,Fi=5121,wa=5123,Ma=5125,vn=5126,$d=10242,Jd=10243,qd=10497,Ca=33071,Zd=33648,Kd=10240,Qd=10241,Ia=9728,tm=9729,Ra=9984,Ml=9985,Cl=9986,Oa=9987,em=33170,ss=4352,rm=4353,im=4354,nm=34046,sm=3317,am=37440,om=37441,lm=37443,Il=37444,En=33984,cm=[Ra,Cl,Ml,Oa],as=[0,bn,is,rs,di],cr={};cr[bn]=cr[xa]=cr[_a]=1,cr[ns]=cr[is]=2,cr[rs]=cr[ba]=3,cr[di]=cr[va]=4;function Pi(l){return"[object "+l+"]"}var Rl=Pi("HTMLCanvasElement"),Ol=Pi("OffscreenCanvas"),Nl=Pi("CanvasRenderingContext2D"),Ll=Pi("ImageBitmap"),Dl=Pi("HTMLImageElement"),Fl=Pi("HTMLVideoElement"),hm=Object.keys(ua).concat([Rl,Ol,Nl,Ll,Dl,Fl]),Bi=[];Bi[Fi]=1,Bi[vn]=4,Bi[Di]=2,Bi[wa]=2,Bi[Ma]=4;var Ge=[];Ge[xl]=2,Ge[ga]=2,Ge[gl]=2,Ge[ns]=4,Ge[Ea]=.5,Ge[Aa]=.5,Ge[Ta]=1,Ge[Sa]=1,Ge[_l]=.5,Ge[bl]=1,Ge[vl]=1,Ge[El]=.5,Ge[Al]=.25,Ge[Tl]=.5,Ge[Sl]=.25,Ge[wl]=.5;function Pl(l){return Array.isArray(l)&&(l.length===0||typeof l[0]=="number")}function Bl(l){if(!Array.isArray(l))return!1;var p=l.length;return!(p===0||!ve(l[0]))}function mi(l){return Object.prototype.toString.call(l)}function kl(l){return mi(l)===Rl}function zl(l){return mi(l)===Ol}function um(l){return mi(l)===Nl}function fm(l){return mi(l)===Ll}function dm(l){return mi(l)===Dl}function mm(l){return mi(l)===Fl}function Na(l){if(!l)return!1;var p=mi(l);return hm.indexOf(p)>=0?!0:Pl(l)||Bl(l)||dr(l)}function Ul(l){return ua[Object.prototype.toString.call(l)]|0}function pm(l,p){var E=p.length;switch(l.type){case Fi:case wa:case Ma:case vn:var k=Ie.allocType(l.type,E);k.set(p),l.data=k;break;case Di:l.data=pl(p);break;default:m.raise("unsupported texture type, must specify a typed array")}}function Gl(l,p){return Ie.allocType(l.type===Di?vn:l.type,p)}function Vl(l,p){l.type===Di?(l.data=pl(p),Ie.freeType(p)):l.data=p}function ym(l,p,E,k,Y,B){for(var j=l.width,Z=l.height,q=l.channels,nt=j*Z*q,at=Gl(l,nt),st=0,ut=0;ut<Z;++ut)for(var K=0;K<j;++K)for(var it=0;it<q;++it)at[st++]=p[E*K+k*ut+Y*it+B];Vl(l,at)}function os(l,p,E,k,Y,B){var j;if(typeof Ge[l]<"u"?j=Ge[l]:j=cr[l]*Bi[p],B&&(j*=6),Y){for(var Z=0,q=E;q>=1;)Z+=j*q*q,q/=2;return Z}else return j*E*k}function xm(l,p,E,k,Y,B,j){var Z={"don't care":ss,"dont care":ss,nice:im,fast:rm},q={repeat:qd,clamp:Ca,mirror:Zd},nt={nearest:Ia,linear:tm},at=r({mipmap:Oa,"nearest mipmap nearest":Ra,"linear mipmap nearest":Ml,"nearest mipmap linear":Cl,"linear mipmap linear":Oa},nt),st={none:0,browser:Il},ut={uint8:Fi,rgba4:Hd,rgb565:Yd,"rgb5 a1":Wd},K={alpha:xa,luminance:bn,"luminance alpha":is,rgb:rs,rgba:di,rgba4:xl,"rgb5 a1":ga,rgb565:gl},it={};p.ext_srgb&&(K.srgb=ba,K.srgba=va),p.oes_texture_float&&(ut.float32=ut.float=vn),p.oes_texture_half_float&&(ut.float16=ut["half float"]=Di),p.webgl_depth_texture&&(r(K,{depth:_a,"depth stencil":ns}),r(ut,{uint16:wa,uint32:Ma,"depth stencil":Xd})),p.webgl_compressed_texture_s3tc&&r(it,{"rgb s3tc dxt1":Ea,"rgba s3tc dxt1":Aa,"rgba s3tc dxt3":Ta,"rgba s3tc dxt5":Sa}),p.webgl_compressed_texture_atc&&r(it,{"rgb atc":_l,"rgba atc explicit alpha":bl,"rgba atc interpolated alpha":vl}),p.webgl_compressed_texture_pvrtc&&r(it,{"rgb pvrtc 4bppv1":El,"rgb pvrtc 2bppv1":Al,"rgba pvrtc 4bppv1":Tl,"rgba pvrtc 2bppv1":Sl}),p.webgl_compressed_texture_etc1&&(it["rgb etc1"]=wl);var R=Array.prototype.slice.call(l.getParameter(jd));Object.keys(it).forEach(function(v){var z=it[v];R.indexOf(z)>=0&&(K[v]=z)});var G=Object.keys(K);E.textureFormats=G;var rt=[];Object.keys(K).forEach(function(v){var z=K[v];rt[z]=v});var vt=[];Object.keys(ut).forEach(function(v){var z=ut[v];vt[z]=v});var J=[];Object.keys(nt).forEach(function(v){var z=nt[v];J[z]=v});var _t=[];Object.keys(at).forEach(function(v){var z=at[v];_t[z]=v});var yt=[];Object.keys(q).forEach(function(v){var z=q[v];yt[z]=v});var Ft=G.reduce(function(v,z){var F=K[z];return F===bn||F===xa||F===bn||F===is||F===_a||F===ns||p.ext_srgb&&(F===ba||F===va)?v[F]=F:F===ga||z.indexOf("rgba")>=0?v[F]=di:v[F]=rs,v},{});function X(){this.internalformat=di,this.format=di,this.type=Fi,this.compressed=!1,this.premultiplyAlpha=!1,this.flipY=!1,this.unpackAlignment=1,this.colorSpace=Il,this.width=0,this.height=0,this.channels=0}function W(v,z){v.internalformat=z.internalformat,v.format=z.format,v.type=z.type,v.compressed=z.compressed,v.premultiplyAlpha=z.premultiplyAlpha,v.flipY=z.flipY,v.unpackAlignment=z.unpackAlignment,v.colorSpace=z.colorSpace,v.width=z.width,v.height=z.height,v.channels=z.channels}function Ct(v,z){if(!(typeof z!="object"||!z)){if("premultiplyAlpha"in z&&(m.type(z.premultiplyAlpha,"boolean","invalid premultiplyAlpha"),v.premultiplyAlpha=z.premultiplyAlpha),"flipY"in z&&(m.type(z.flipY,"boolean","invalid texture flip"),v.flipY=z.flipY),"alignment"in z&&(m.oneOf(z.alignment,[1,2,4,8],"invalid texture unpack alignment"),v.unpackAlignment=z.alignment),"colorSpace"in z&&(m.parameter(z.colorSpace,st,"invalid colorSpace"),v.colorSpace=st[z.colorSpace]),"type"in z){var F=z.type;m(p.oes_texture_float||!(F==="float"||F==="float32"),"you must enable the OES_texture_float extension in order to use floating point textures."),m(p.oes_texture_half_float||!(F==="half float"||F==="float16"),"you must enable the OES_texture_half_float extension in order to use 16-bit floating point textures."),m(p.webgl_depth_texture||!(F==="uint16"||F==="uint32"||F==="depth stencil"),"you must enable the WEBGL_depth_texture extension in order to use depth/stencil textures."),m.parameter(F,ut,"invalid texture type"),v.type=ut[F]}var Mt=v.width,Jt=v.height,_=v.channels,f=!1;"shape"in z?(m(Array.isArray(z.shape)&&z.shape.length>=2,"shape must be an array"),Mt=z.shape[0],Jt=z.shape[1],z.shape.length===3&&(_=z.shape[2],m(_>0&&_<=4,"invalid number of channels"),f=!0),m(Mt>=0&&Mt<=E.maxTextureSize,"invalid width"),m(Jt>=0&&Jt<=E.maxTextureSize,"invalid height")):("radius"in z&&(Mt=Jt=z.radius,m(Mt>=0&&Mt<=E.maxTextureSize,"invalid radius")),"width"in z&&(Mt=z.width,m(Mt>=0&&Mt<=E.maxTextureSize,"invalid width")),"height"in z&&(Jt=z.height,m(Jt>=0&&Jt<=E.maxTextureSize,"invalid height")),"channels"in z&&(_=z.channels,m(_>0&&_<=4,"invalid number of channels"),f=!0)),v.width=Mt|0,v.height=Jt|0,v.channels=_|0;var S=!1;if("format"in z){var I=z.format;m(p.webgl_depth_texture||!(I==="depth"||I==="depth stencil"),"you must enable the WEBGL_depth_texture extension in order to use depth/stencil textures."),m.parameter(I,K,"invalid texture format");var N=v.internalformat=K[I];v.format=Ft[N],I in ut&&("type"in z||(v.type=ut[I])),I in it&&(v.compressed=!0),S=!0}!f&&S?v.channels=cr[v.format]:f&&!S?v.channels!==as[v.format]&&(v.format=v.internalformat=as[v.channels]):S&&f&&m(v.channels===cr[v.format],"number of channels inconsistent with specified format")}}function ft(v){l.pixelStorei(am,v.flipY),l.pixelStorei(om,v.premultiplyAlpha),l.pixelStorei(lm,v.colorSpace),l.pixelStorei(sm,v.unpackAlignment)}function et(){X.call(this),this.xOffset=0,this.yOffset=0,this.data=null,this.needsFree=!1,this.element=null,this.needsCopy=!1}function dt(v,z){var F=null;if(Na(z)?F=z:z&&(m.type(z,"object","invalid pixel data type"),Ct(v,z),"x"in z&&(v.xOffset=z.x|0),"y"in z&&(v.yOffset=z.y|0),Na(z.data)&&(F=z.data)),m(!v.compressed||F instanceof Uint8Array,"compressed texture data must be stored in a uint8array"),z.copy){m(!F,"can not specify copy and data field for the same texture");var Mt=Y.viewportWidth,Jt=Y.viewportHeight;v.width=v.width||Mt-v.xOffset,v.height=v.height||Jt-v.yOffset,v.needsCopy=!0,m(v.xOffset>=0&&v.xOffset<Mt&&v.yOffset>=0&&v.yOffset<Jt&&v.width>0&&v.width<=Mt&&v.height>0&&v.height<=Jt,"copy texture read out of bounds")}else if(!F)v.width=v.width||1,v.height=v.height||1,v.channels=v.channels||4;else if(e(F))v.channels=v.channels||4,v.data=F,!("type"in z)&&v.type===Fi&&(v.type=Ul(F));else if(Pl(F))v.channels=v.channels||4,pm(v,F),v.alignment=1,v.needsFree=!0;else if(dr(F)){var _=F.data;!Array.isArray(_)&&v.type===Fi&&(v.type=Ul(_));var f=F.shape,S=F.stride,I,N,M,w,C,y;f.length===3?(M=f[2],y=S[2]):(m(f.length===2,"invalid ndarray pixel data, must be 2 or 3D"),M=1,y=1),I=f[0],N=f[1],w=S[0],C=S[1],v.alignment=1,v.width=I,v.height=N,v.channels=M,v.format=v.internalformat=as[M],v.needsFree=!0,ym(v,_,w,C,y,F.offset)}else if(kl(F)||zl(F)||um(F))kl(F)||zl(F)?v.element=F:v.element=F.canvas,v.width=v.element.width,v.height=v.element.height,v.channels=4;else if(fm(F))v.element=F,v.width=F.width,v.height=F.height,v.channels=4;else if(dm(F))v.element=F,v.width=F.naturalWidth,v.height=F.naturalHeight,v.channels=4;else if(mm(F))v.element=F,v.width=F.videoWidth,v.height=F.videoHeight,v.channels=4;else if(Bl(F)){var T=v.width||F[0].length,b=v.height||F.length,O=v.channels;ve(F[0][0])?O=O||F[0][0].length:O=O||1;for(var D=Kn.shape(F),$=1,ct=0;ct<D.length;++ct)$*=D[ct];var ht=Gl(v,$);Kn.flatten(F,D,"",ht),Vl(v,ht),v.alignment=1,v.width=T,v.height=b,v.channels=O,v.format=v.internalformat=as[O],v.needsFree=!0}v.type===vn?m(E.extensions.indexOf("oes_texture_float")>=0,"oes_texture_float extension not enabled"):v.type===Di&&m(E.extensions.indexOf("oes_texture_half_float")>=0,"oes_texture_half_float extension not enabled")}function mt(v,z,F){var Mt=v.element,Jt=v.data,_=v.internalformat,f=v.format,S=v.type,I=v.width,N=v.height;ft(v),Mt?l.texImage2D(z,F,f,f,S,Mt):v.compressed?l.compressedTexImage2D(z,F,_,I,N,0,Jt):v.needsCopy?(k(),l.copyTexImage2D(z,F,f,v.xOffset,v.yOffset,I,N,0)):l.texImage2D(z,F,f,I,N,0,f,S,Jt||null)}function Ht(v,z,F,Mt,Jt){var _=v.element,f=v.data,S=v.internalformat,I=v.format,N=v.type,M=v.width,w=v.height;ft(v),_?l.texSubImage2D(z,Jt,F,Mt,I,N,_):v.compressed?l.compressedTexSubImage2D(z,Jt,F,Mt,S,M,w,f):v.needsCopy?(k(),l.copyTexSubImage2D(z,Jt,F,Mt,v.xOffset,v.yOffset,M,w)):l.texSubImage2D(z,Jt,F,Mt,M,w,I,N,f)}var Gt=[];function xt(){return Gt.pop()||new et}function bt(v){v.needsFree&&Ie.freeType(v.data),et.call(v),Gt.push(v)}function zt(){X.call(this),this.genMipmaps=!1,this.mipmapHint=ss,this.mipmask=0,this.images=Array(16)}function Vt(v,z,F){var Mt=v.images[0]=xt();v.mipmask=1,Mt.width=v.width=z,Mt.height=v.height=F,Mt.channels=v.channels=4}function qt(v,z){var F=null;if(Na(z))F=v.images[0]=xt(),W(F,v),dt(F,z),v.mipmask=1;else if(Ct(v,z),Array.isArray(z.mipmap))for(var Mt=z.mipmap,Jt=0;Jt<Mt.length;++Jt)F=v.images[Jt]=xt(),W(F,v),F.width>>=Jt,F.height>>=Jt,dt(F,Mt[Jt]),v.mipmask|=1<<Jt;else F=v.images[0]=xt(),W(F,v),dt(F,z),v.mipmask=1;W(v,v.images[0]),v.compressed&&(v.internalformat===Ea||v.internalformat===Aa||v.internalformat===Ta||v.internalformat===Sa)&&m(v.width%4===0&&v.height%4===0,"for compressed texture formats, mipmap level 0 must have width and height that are a multiple of 4")}function pe(v,z){for(var F=v.images,Mt=0;Mt<F.length;++Mt){if(!F[Mt])return;mt(F[Mt],z,Mt)}}var ge=[];function Qt(){var v=ge.pop()||new zt;X.call(v),v.mipmask=0;for(var z=0;z<16;++z)v.images[z]=null;return v}function Ne(v){for(var z=v.images,F=0;F<z.length;++F)z[F]&&bt(z[F]),z[F]=null;ge.push(v)}function fe(){this.minFilter=Ia,this.magFilter=Ia,this.wrapS=Ca,this.wrapT=Ca,this.anisotropic=1,this.genMipmaps=!1,this.mipmapHint=ss}function Oe(v,z){if("min"in z){var F=z.min;m.parameter(F,at),v.minFilter=at[F],cm.indexOf(v.minFilter)>=0&&!("faces"in z)&&(v.genMipmaps=!0)}if("mag"in z){var Mt=z.mag;m.parameter(Mt,nt),v.magFilter=nt[Mt]}var Jt=v.wrapS,_=v.wrapT;if("wrap"in z){var f=z.wrap;typeof f=="string"?(m.parameter(f,q),Jt=_=q[f]):Array.isArray(f)&&(m.parameter(f[0],q),m.parameter(f[1],q),Jt=q[f[0]],_=q[f[1]])}else{if("wrapS"in z){var S=z.wrapS;m.parameter(S,q),Jt=q[S]}if("wrapT"in z){var I=z.wrapT;m.parameter(I,q),_=q[I]}}if(v.wrapS=Jt,v.wrapT=_,"anisotropic"in z){var N=z.anisotropic;m(typeof N=="number"&&N>=1&&N<=E.maxAnisotropic,"aniso samples must be between 1 and "),v.anisotropic=z.anisotropic}if("mipmap"in z){var M=!1;switch(typeof z.mipmap){case"string":m.parameter(z.mipmap,Z,"invalid mipmap hint"),v.mipmapHint=Z[z.mipmap],v.genMipmaps=!0,M=!0;break;case"boolean":M=v.genMipmaps=z.mipmap;break;case"object":m(Array.isArray(z.mipmap),"invalid mipmap type"),v.genMipmaps=!1,M=!0;break;default:m.raise("invalid mipmap type")}M&&!("min"in z)&&(v.minFilter=Ra)}}function Le(v,z){l.texParameteri(z,Qd,v.minFilter),l.texParameteri(z,Kd,v.magFilter),l.texParameteri(z,$d,v.wrapS),l.texParameteri(z,Jd,v.wrapT),p.ext_texture_filter_anisotropic&&l.texParameteri(z,nm,v.anisotropic),v.genMipmaps&&(l.hint(em,v.mipmapHint),l.generateMipmap(z))}var De=0,ke={},Ve=E.maxTextureUnits,Ee=Array(Ve).map(function(){return null});function Yt(v){X.call(this),this.mipmask=0,this.internalformat=di,this.id=De++,this.refCount=1,this.target=v,this.texture=l.createTexture(),this.unit=-1,this.bindCount=0,this.texInfo=new fe,j.profile&&(this.stats={size:0})}function je(v){l.activeTexture(En),l.bindTexture(v.target,v.texture)}function oe(){var v=Ee[0];v?l.bindTexture(v.target,v.texture):l.bindTexture(Er,null)}function Bt(v){var z=v.texture;m(z,"must not double destroy texture");var F=v.unit,Mt=v.target;F>=0&&(l.activeTexture(En+F),l.bindTexture(Mt,null),Ee[F]=null),l.deleteTexture(z),v.texture=null,v.params=null,v.pixels=null,v.refCount=0,delete ke[v.id],B.textureCount--}r(Yt.prototype,{bind:function(){var v=this;v.bindCount+=1;var z=v.unit;if(z<0){for(var F=0;F<Ve;++F){var Mt=Ee[F];if(Mt){if(Mt.bindCount>0)continue;Mt.unit=-1}Ee[F]=v,z=F;break}z>=Ve&&m.raise("insufficient number of texture units"),j.profile&&B.maxTextureUnits<z+1&&(B.maxTextureUnits=z+1),v.unit=z,l.activeTexture(En+z),l.bindTexture(v.target,v.texture)}return z},unbind:function(){this.bindCount-=1},decRef:function(){--this.refCount<=0&&Bt(this)}});function Zt(v,z){var F=new Yt(Er);ke[F.id]=F,B.textureCount++;function Mt(f,S){var I=F.texInfo;fe.call(I);var N=Qt();return typeof f=="number"?typeof S=="number"?Vt(N,f|0,S|0):Vt(N,f|0,f|0):f?(m.type(f,"object","invalid arguments to regl.texture"),Oe(I,f),qt(N,f)):Vt(N,1,1),I.genMipmaps&&(N.mipmask=(N.width<<1)-1),F.mipmask=N.mipmask,W(F,N),m.texture2D(I,N,E),F.internalformat=N.internalformat,Mt.width=N.width,Mt.height=N.height,je(F),pe(N,Er),Le(I,Er),oe(),Ne(N),j.profile&&(F.stats.size=os(F.internalformat,F.type,N.width,N.height,I.genMipmaps,!1)),Mt.format=rt[F.internalformat],Mt.type=vt[F.type],Mt.mag=J[I.magFilter],Mt.min=_t[I.minFilter],Mt.wrapS=yt[I.wrapS],Mt.wrapT=yt[I.wrapT],Mt}function Jt(f,S,I,N){m(!!f,"must specify image data");var M=S|0,w=I|0,C=N|0,y=xt();return W(y,F),y.width=0,y.height=0,dt(y,f),y.width=y.width||(F.width>>C)-M,y.height=y.height||(F.height>>C)-w,m(F.type===y.type&&F.format===y.format&&F.internalformat===y.internalformat,"incompatible format for texture.subimage"),m(M>=0&&w>=0&&M+y.width<=F.width&&w+y.height<=F.height,"texture.subimage write out of bounds"),m(F.mipmask&1<<C,"missing mipmap data"),m(y.data||y.element||y.needsCopy,"missing image data"),je(F),Ht(y,Er,M,w,C),oe(),bt(y),Mt}function _(f,S){var I=f|0,N=S|0||I;if(I===F.width&&N===F.height)return Mt;Mt.width=F.width=I,Mt.height=F.height=N,je(F);for(var M=0;F.mipmask>>M;++M){var w=I>>M,C=N>>M;if(!w||!C)break;l.texImage2D(Er,M,F.format,w,C,0,F.format,F.type,null)}return oe(),j.profile&&(F.stats.size=os(F.internalformat,F.type,I,N,!1,!1)),Mt}return Mt(v,z),Mt.subimage=Jt,Mt.resize=_,Mt._reglType="texture2d",Mt._texture=F,j.profile&&(Mt.stats=F.stats),Mt.destroy=function(){F.decRef()},Mt}function ne(v,z,F,Mt,Jt,_){var f=new Yt(ya);ke[f.id]=f,B.cubeCount++;var S=new Array(6);function I(w,C,y,T,b,O){var D,$=f.texInfo;for(fe.call($),D=0;D<6;++D)S[D]=Qt();if(typeof w=="number"||!w){var ct=w|0||1;for(D=0;D<6;++D)Vt(S[D],ct,ct)}else if(typeof w=="object")if(C)qt(S[0],w),qt(S[1],C),qt(S[2],y),qt(S[3],T),qt(S[4],b),qt(S[5],O);else if(Oe($,w),Ct(f,w),"faces"in w){var ht=w.faces;for(m(Array.isArray(ht)&&ht.length===6,"cube faces must be a length 6 array"),D=0;D<6;++D)m(typeof ht[D]=="object"&&!!ht[D],"invalid input for cube map face"),W(S[D],f),qt(S[D],ht[D])}else for(D=0;D<6;++D)qt(S[D],w);else m.raise("invalid arguments to cube map");for(W(f,S[0]),m.optional(function(){E.npotTextureCube||m(yl(f.width)&&yl(f.height),"your browser does not support non power or two texture dimensions")}),$.genMipmaps?f.mipmask=(S[0].width<<1)-1:f.mipmask=S[0].mipmask,m.textureCube(f,$,S,E),f.internalformat=S[0].internalformat,I.width=S[0].width,I.height=S[0].height,je(f),D=0;D<6;++D)pe(S[D],es+D);for(Le($,ya),oe(),j.profile&&(f.stats.size=os(f.internalformat,f.type,I.width,I.height,$.genMipmaps,!0)),I.format=rt[f.internalformat],I.type=vt[f.type],I.mag=J[$.magFilter],I.min=_t[$.minFilter],I.wrapS=yt[$.wrapS],I.wrapT=yt[$.wrapT],D=0;D<6;++D)Ne(S[D]);return I}function N(w,C,y,T,b){m(!!C,"must specify image data"),m(typeof w=="number"&&w===(w|0)&&w>=0&&w<6,"invalid face");var O=y|0,D=T|0,$=b|0,ct=xt();return W(ct,f),ct.width=0,ct.height=0,dt(ct,C),ct.width=ct.width||(f.width>>$)-O,ct.height=ct.height||(f.height>>$)-D,m(f.type===ct.type&&f.format===ct.format&&f.internalformat===ct.internalformat,"incompatible format for texture.subimage"),m(O>=0&&D>=0&&O+ct.width<=f.width&&D+ct.height<=f.height,"texture.subimage write out of bounds"),m(f.mipmask&1<<$,"missing mipmap data"),m(ct.data||ct.element||ct.needsCopy,"missing image data"),je(f),Ht(ct,es+w,O,D,$),oe(),bt(ct),I}function M(w){var C=w|0;if(C!==f.width){I.width=f.width=C,I.height=f.height=C,je(f);for(var y=0;y<6;++y)for(var T=0;f.mipmask>>T;++T)l.texImage2D(es+y,T,f.format,C>>T,C>>T,0,f.format,f.type,null);return oe(),j.profile&&(f.stats.size=os(f.internalformat,f.type,I.width,I.height,!1,!0)),I}}return I(v,z,F,Mt,Jt,_),I.subimage=N,I.resize=M,I._reglType="textureCube",I._texture=f,j.profile&&(I.stats=f.stats),I.destroy=function(){f.decRef()},I}function Ae(){for(var v=0;v<Ve;++v)l.activeTexture(En+v),l.bindTexture(Er,null),Ee[v]=null;nr(ke).forEach(Bt),B.cubeCount=0,B.textureCount=0}j.profile&&(B.getTotalTextureSize=function(){var v=0;return Object.keys(ke).forEach(function(z){v+=ke[z].stats.size}),v});function Tr(){for(var v=0;v<Ve;++v){var z=Ee[v];z&&(z.bindCount=0,z.unit=-1,Ee[v]=null)}nr(ke).forEach(function(F){F.texture=l.createTexture(),l.bindTexture(F.target,F.texture);for(var Mt=0;Mt<32;++Mt)if((F.mipmask&1<<Mt)!==0)if(F.target===Er)l.texImage2D(Er,Mt,F.internalformat,F.width>>Mt,F.height>>Mt,0,F.internalformat,F.type,null);else for(var Jt=0;Jt<6;++Jt)l.texImage2D(es+Jt,Mt,F.internalformat,F.width>>Mt,F.height>>Mt,0,F.internalformat,F.type,null);Le(F.texInfo,F.target)})}function vi(){for(var v=0;v<Ve;++v){var z=Ee[v];z&&(z.bindCount=0,z.unit=-1,Ee[v]=null),l.activeTexture(En+v),l.bindTexture(Er,null),l.bindTexture(ya,null)}}return{create2D:Zt,createCube:ne,clear:Ae,getTexture:function(v){return null},restore:Tr,refresh:vi}}var $r=36161,ls=32854,jl=32855,Hl=36194,Wl=33189,Yl=36168,Xl=34041,$l=35907,Jl=34836,ql=34842,Zl=34843,mr=[];mr[ls]=2,mr[jl]=2,mr[Hl]=2,mr[Wl]=2,mr[Yl]=1,mr[Xl]=4,mr[$l]=4,mr[Jl]=16,mr[ql]=8,mr[Zl]=6;function Kl(l,p,E){return mr[l]*p*E}var gm=function(l,p,E,k,Y){var B={rgba4:ls,rgb565:Hl,"rgb5 a1":jl,depth:Wl,stencil:Yl,"depth stencil":Xl};p.ext_srgb&&(B.srgba=$l),p.ext_color_buffer_half_float&&(B.rgba16f=ql,B.rgb16f=Zl),p.webgl_color_buffer_float&&(B.rgba32f=Jl);var j=[];Object.keys(B).forEach(function(K){var it=B[K];j[it]=K});var Z=0,q={};function nt(K){this.id=Z++,this.refCount=1,this.renderbuffer=K,this.format=ls,this.width=0,this.height=0,Y.profile&&(this.stats={size:0})}nt.prototype.decRef=function(){--this.refCount<=0&&at(this)};function at(K){var it=K.renderbuffer;m(it,"must not double destroy renderbuffer"),l.bindRenderbuffer($r,null),l.deleteRenderbuffer(it),K.renderbuffer=null,K.refCount=0,delete q[K.id],k.renderbufferCount--}function st(K,it){var R=new nt(l.createRenderbuffer());q[R.id]=R,k.renderbufferCount++;function G(vt,J){var _t=0,yt=0,Ft=ls;if(typeof vt=="object"&&vt){var X=vt;if("shape"in X){var W=X.shape;m(Array.isArray(W)&&W.length>=2,"invalid renderbuffer shape"),_t=W[0]|0,yt=W[1]|0}else"radius"in X&&(_t=yt=X.radius|0),"width"in X&&(_t=X.width|0),"height"in X&&(yt=X.height|0);"format"in X&&(m.parameter(X.format,B,"invalid renderbuffer format"),Ft=B[X.format])}else typeof vt=="number"?(_t=vt|0,typeof J=="number"?yt=J|0:yt=_t):vt?m.raise("invalid arguments to renderbuffer constructor"):_t=yt=1;if(m(_t>0&&yt>0&&_t<=E.maxRenderbufferSize&&yt<=E.maxRenderbufferSize,"invalid renderbuffer size"),!(_t===R.width&&yt===R.height&&Ft===R.format))return G.width=R.width=_t,G.height=R.height=yt,R.format=Ft,l.bindRenderbuffer($r,R.renderbuffer),l.renderbufferStorage($r,Ft,_t,yt),m(l.getError()===0,"invalid render buffer format"),Y.profile&&(R.stats.size=Kl(R.format,R.width,R.height)),G.format=j[R.format],G}function rt(vt,J){var _t=vt|0,yt=J|0||_t;return _t===R.width&&yt===R.height||(m(_t>0&&yt>0&&_t<=E.maxRenderbufferSize&&yt<=E.maxRenderbufferSize,"invalid renderbuffer size"),G.width=R.width=_t,G.height=R.height=yt,l.bindRenderbuffer($r,R.renderbuffer),l.renderbufferStorage($r,R.format,_t,yt),m(l.getError()===0,"invalid render buffer format"),Y.profile&&(R.stats.size=Kl(R.format,R.width,R.height))),G}return G(K,it),G.resize=rt,G._reglType="renderbuffer",G._renderbuffer=R,Y.profile&&(G.stats=R.stats),G.destroy=function(){R.decRef()},G}Y.profile&&(k.getTotalRenderbufferSize=function(){var K=0;return Object.keys(q).forEach(function(it){K+=q[it].stats.size}),K});function ut(){nr(q).forEach(function(K){K.renderbuffer=l.createRenderbuffer(),l.bindRenderbuffer($r,K.renderbuffer),l.renderbufferStorage($r,K.format,K.width,K.height)}),l.bindRenderbuffer($r,null)}return{create:st,clear:function(){nr(q).forEach(at)},restore:ut}},Ir=36160,La=36161,pi=3553,cs=34069,Ql=36064,tc=36096,ec=36128,rc=33306,ic=36053,_m=36054,bm=36055,vm=36057,Em=36061,Am=36193,Tm=5121,Sm=5126,nc=6407,sc=6408,wm=6402,Mm=[nc,sc],Da=[];Da[sc]=4,Da[nc]=3;var hs=[];hs[Tm]=1,hs[Sm]=4,hs[Am]=2;var Cm=32854,Im=32855,Rm=36194,Om=33189,Nm=36168,ac=34041,Lm=35907,Dm=34836,Fm=34842,Pm=34843,Bm=[Cm,Im,Rm,Lm,Fm,Pm,Dm],ki={};ki[ic]="complete",ki[_m]="incomplete attachment",ki[vm]="incomplete dimensions",ki[bm]="incomplete, missing attachment",ki[Em]="unsupported";function km(l,p,E,k,Y,B){var j={cur:null,next:null,dirty:!1,setFBO:null},Z=["rgba"],q=["rgba4","rgb565","rgb5 a1"];p.ext_srgb&&q.push("srgba"),p.ext_color_buffer_half_float&&q.push("rgba16f","rgb16f"),p.webgl_color_buffer_float&&q.push("rgba32f");var nt=["uint8"];p.oes_texture_half_float&&nt.push("half float","float16"),p.oes_texture_float&&nt.push("float","float32");function at(et,dt,mt){this.target=et,this.texture=dt,this.renderbuffer=mt;var Ht=0,Gt=0;dt?(Ht=dt.width,Gt=dt.height):mt&&(Ht=mt.width,Gt=mt.height),this.width=Ht,this.height=Gt}function st(et){et&&(et.texture&&et.texture._texture.decRef(),et.renderbuffer&&et.renderbuffer._renderbuffer.decRef())}function ut(et,dt,mt){if(et)if(et.texture){var Ht=et.texture._texture,Gt=Math.max(1,Ht.width),xt=Math.max(1,Ht.height);m(Gt===dt&&xt===mt,"inconsistent width/height for supplied texture"),Ht.refCount+=1}else{var bt=et.renderbuffer._renderbuffer;m(bt.width===dt&&bt.height===mt,"inconsistent width/height for renderbuffer"),bt.refCount+=1}}function K(et,dt){dt&&(dt.texture?l.framebufferTexture2D(Ir,et,dt.target,dt.texture._texture.texture,0):l.framebufferRenderbuffer(Ir,et,La,dt.renderbuffer._renderbuffer.renderbuffer))}function it(et){var dt=pi,mt=null,Ht=null,Gt=et;typeof et=="object"&&(Gt=et.data,"target"in et&&(dt=et.target|0)),m.type(Gt,"function","invalid attachment data");var xt=Gt._reglType;return xt==="texture2d"?(mt=Gt,m(dt===pi)):xt==="textureCube"?(mt=Gt,m(dt>=cs&&dt<cs+6,"invalid cube map target")):xt==="renderbuffer"?(Ht=Gt,dt=La):m.raise("invalid regl object for attachment"),new at(dt,mt,Ht)}function R(et,dt,mt,Ht,Gt){if(mt){var xt=k.create2D({width:et,height:dt,format:Ht,type:Gt});return xt._texture.refCount=0,new at(pi,xt,null)}else{var bt=Y.create({width:et,height:dt,format:Ht});return bt._renderbuffer.refCount=0,new at(La,null,bt)}}function G(et){return et&&(et.texture||et.renderbuffer)}function rt(et,dt,mt){et&&(et.texture?et.texture.resize(dt,mt):et.renderbuffer&&et.renderbuffer.resize(dt,mt),et.width=dt,et.height=mt)}var vt=0,J={};function _t(){this.id=vt++,J[this.id]=this,this.framebuffer=l.createFramebuffer(),this.width=0,this.height=0,this.colorAttachments=[],this.depthAttachment=null,this.stencilAttachment=null,this.depthStencilAttachment=null}function yt(et){et.colorAttachments.forEach(st),st(et.depthAttachment),st(et.stencilAttachment),st(et.depthStencilAttachment)}function Ft(et){var dt=et.framebuffer;m(dt,"must not double destroy framebuffer"),l.deleteFramebuffer(dt),et.framebuffer=null,B.framebufferCount--,delete J[et.id]}function X(et){var dt;l.bindFramebuffer(Ir,et.framebuffer);var mt=et.colorAttachments;for(dt=0;dt<mt.length;++dt)K(Ql+dt,mt[dt]);for(dt=mt.length;dt<E.maxColorAttachments;++dt)l.framebufferTexture2D(Ir,Ql+dt,pi,null,0);l.framebufferTexture2D(Ir,rc,pi,null,0),l.framebufferTexture2D(Ir,tc,pi,null,0),l.framebufferTexture2D(Ir,ec,pi,null,0),K(tc,et.depthAttachment),K(ec,et.stencilAttachment),K(rc,et.depthStencilAttachment);var Ht=l.checkFramebufferStatus(Ir);!l.isContextLost()&&Ht!==ic&&m.raise("framebuffer configuration not supported, status = "+ki[Ht]),l.bindFramebuffer(Ir,j.next?j.next.framebuffer:null),j.cur=j.next,l.getError()}function W(et,dt){var mt=new _t;B.framebufferCount++;function Ht(xt,bt){var zt;m(j.next!==mt,"can not update framebuffer which is currently in use");var Vt=0,qt=0,pe=!0,ge=!0,Qt=null,Ne=!0,fe="rgba",Oe="uint8",Le=1,De=null,ke=null,Ve=null,Ee=!1;if(typeof xt=="number")Vt=xt|0,qt=bt|0||Vt;else if(!xt)Vt=qt=1;else{m.type(xt,"object","invalid arguments for framebuffer");var Yt=xt;if("shape"in Yt){var je=Yt.shape;m(Array.isArray(je)&&je.length>=2,"invalid shape for framebuffer"),Vt=je[0],qt=je[1]}else"radius"in Yt&&(Vt=qt=Yt.radius),"width"in Yt&&(Vt=Yt.width),"height"in Yt&&(qt=Yt.height);("color"in Yt||"colors"in Yt)&&(Qt=Yt.color||Yt.colors,Array.isArray(Qt)&&m(Qt.length===1||p.webgl_draw_buffers,"multiple render targets not supported")),Qt||("colorCount"in Yt&&(Le=Yt.colorCount|0,m(Le>0,"invalid color buffer count")),"colorTexture"in Yt&&(Ne=!!Yt.colorTexture,fe="rgba4"),"colorType"in Yt&&(Oe=Yt.colorType,Ne?(m(p.oes_texture_float||!(Oe==="float"||Oe==="float32"),"you must enable OES_texture_float in order to use floating point framebuffer objects"),m(p.oes_texture_half_float||!(Oe==="half float"||Oe==="float16"),"you must enable OES_texture_half_float in order to use 16-bit floating point framebuffer objects")):Oe==="half float"||Oe==="float16"?(m(p.ext_color_buffer_half_float,"you must enable EXT_color_buffer_half_float to use 16-bit render buffers"),fe="rgba16f"):(Oe==="float"||Oe==="float32")&&(m(p.webgl_color_buffer_float,"you must enable WEBGL_color_buffer_float in order to use 32-bit floating point renderbuffers"),fe="rgba32f"),m.oneOf(Oe,nt,"invalid color type")),"colorFormat"in Yt&&(fe=Yt.colorFormat,Z.indexOf(fe)>=0?Ne=!0:q.indexOf(fe)>=0?Ne=!1:m.optional(function(){Ne?m.oneOf(Yt.colorFormat,Z,"invalid color format for texture"):m.oneOf(Yt.colorFormat,q,"invalid color format for renderbuffer")}))),("depthTexture"in Yt||"depthStencilTexture"in Yt)&&(Ee=!!(Yt.depthTexture||Yt.depthStencilTexture),m(!Ee||p.webgl_depth_texture,"webgl_depth_texture extension not supported")),"depth"in Yt&&(typeof Yt.depth=="boolean"?pe=Yt.depth:(De=Yt.depth,ge=!1)),"stencil"in Yt&&(typeof Yt.stencil=="boolean"?ge=Yt.stencil:(ke=Yt.stencil,pe=!1)),"depthStencil"in Yt&&(typeof Yt.depthStencil=="boolean"?pe=ge=Yt.depthStencil:(Ve=Yt.depthStencil,pe=!1,ge=!1))}var oe=null,Bt=null,Zt=null,ne=null;if(Array.isArray(Qt))oe=Qt.map(it);else if(Qt)oe=[it(Qt)];else for(oe=new Array(Le),zt=0;zt<Le;++zt)oe[zt]=R(Vt,qt,Ne,fe,Oe);m(p.webgl_draw_buffers||oe.length<=1,"you must enable the WEBGL_draw_buffers extension in order to use multiple color buffers."),m(oe.length<=E.maxColorAttachments,"too many color attachments, not supported"),Vt=Vt||oe[0].width,qt=qt||oe[0].height,De?Bt=it(De):pe&&!ge&&(Bt=R(Vt,qt,Ee,"depth","uint32")),ke?Zt=it(ke):ge&&!pe&&(Zt=R(Vt,qt,!1,"stencil","uint8")),Ve?ne=it(Ve):!De&&!ke&&ge&&pe&&(ne=R(Vt,qt,Ee,"depth stencil","depth stencil")),m(!!De+!!ke+!!Ve<=1,"invalid framebuffer configuration, can specify exactly one depth/stencil attachment");var Ae=null;for(zt=0;zt<oe.length;++zt)if(ut(oe[zt],Vt,qt),m(!oe[zt]||oe[zt].texture&&Mm.indexOf(oe[zt].texture._texture.format)>=0||oe[zt].renderbuffer&&Bm.indexOf(oe[zt].renderbuffer._renderbuffer.format)>=0,"framebuffer color attachment "+zt+" is invalid"),oe[zt]&&oe[zt].texture){var Tr=Da[oe[zt].texture._texture.format]*hs[oe[zt].texture._texture.type];Ae===null?Ae=Tr:m(Ae===Tr,"all color attachments much have the same number of bits per pixel.")}return ut(Bt,Vt,qt),m(!Bt||Bt.texture&&Bt.texture._texture.format===wm||Bt.renderbuffer&&Bt.renderbuffer._renderbuffer.format===Om,"invalid depth attachment for framebuffer object"),ut(Zt,Vt,qt),m(!Zt||Zt.renderbuffer&&Zt.renderbuffer._renderbuffer.format===Nm,"invalid stencil attachment for framebuffer object"),ut(ne,Vt,qt),m(!ne||ne.texture&&ne.texture._texture.format===ac||ne.renderbuffer&&ne.renderbuffer._renderbuffer.format===ac,"invalid depth-stencil attachment for framebuffer object"),yt(mt),mt.width=Vt,mt.height=qt,mt.colorAttachments=oe,mt.depthAttachment=Bt,mt.stencilAttachment=Zt,mt.depthStencilAttachment=ne,Ht.color=oe.map(G),Ht.depth=G(Bt),Ht.stencil=G(Zt),Ht.depthStencil=G(ne),Ht.width=mt.width,Ht.height=mt.height,X(mt),Ht}function Gt(xt,bt){m(j.next!==mt,"can not resize a framebuffer which is currently in use");var zt=Math.max(xt|0,1),Vt=Math.max(bt|0||zt,1);if(zt===mt.width&&Vt===mt.height)return Ht;for(var qt=mt.colorAttachments,pe=0;pe<qt.length;++pe)rt(qt[pe],zt,Vt);return rt(mt.depthAttachment,zt,Vt),rt(mt.stencilAttachment,zt,Vt),rt(mt.depthStencilAttachment,zt,Vt),mt.width=Ht.width=zt,mt.height=Ht.height=Vt,X(mt),Ht}return Ht(et,dt),r(Ht,{resize:Gt,_reglType:"framebuffer",_framebuffer:mt,destroy:function(){Ft(mt),yt(mt)},use:function(xt){j.setFBO({framebuffer:Ht},xt)}})}function Ct(et){var dt=Array(6);function mt(Gt){var xt;m(dt.indexOf(j.next)<0,"can not update framebuffer which is currently in use");var bt={color:null},zt=0,Vt=null,qt="rgba",pe="uint8",ge=1;if(typeof Gt=="number")zt=Gt|0;else if(!Gt)zt=1;else{m.type(Gt,"object","invalid arguments for framebuffer");var Qt=Gt;if("shape"in Qt){var Ne=Qt.shape;m(Array.isArray(Ne)&&Ne.length>=2,"invalid shape for framebuffer"),m(Ne[0]===Ne[1],"cube framebuffer must be square"),zt=Ne[0]}else"radius"in Qt&&(zt=Qt.radius|0),"width"in Qt?(zt=Qt.width|0,"height"in Qt&&m(Qt.height===zt,"must be square")):"height"in Qt&&(zt=Qt.height|0);("color"in Qt||"colors"in Qt)&&(Vt=Qt.color||Qt.colors,Array.isArray(Vt)&&m(Vt.length===1||p.webgl_draw_buffers,"multiple render targets not supported")),Vt||("colorCount"in Qt&&(ge=Qt.colorCount|0,m(ge>0,"invalid color buffer count")),"colorType"in Qt&&(m.oneOf(Qt.colorType,nt,"invalid color type"),pe=Qt.colorType),"colorFormat"in Qt&&(qt=Qt.colorFormat,m.oneOf(Qt.colorFormat,Z,"invalid color format for texture"))),"depth"in Qt&&(bt.depth=Qt.depth),"stencil"in Qt&&(bt.stencil=Qt.stencil),"depthStencil"in Qt&&(bt.depthStencil=Qt.depthStencil)}var fe;if(Vt)if(Array.isArray(Vt))for(fe=[],xt=0;xt<Vt.length;++xt)fe[xt]=Vt[xt];else fe=[Vt];else{fe=Array(ge);var Oe={radius:zt,format:qt,type:pe};for(xt=0;xt<ge;++xt)fe[xt]=k.createCube(Oe)}for(bt.color=Array(fe.length),xt=0;xt<fe.length;++xt){var Le=fe[xt];m(typeof Le=="function"&&Le._reglType==="textureCube","invalid cube map"),zt=zt||Le.width,m(Le.width===zt&&Le.height===zt,"invalid cube map shape"),bt.color[xt]={target:cs,data:fe[xt]}}for(xt=0;xt<6;++xt){for(var De=0;De<fe.length;++De)bt.color[De].target=cs+xt;xt>0&&(bt.depth=dt[0].depth,bt.stencil=dt[0].stencil,bt.depthStencil=dt[0].depthStencil),dt[xt]?dt[xt](bt):dt[xt]=W(bt)}return r(mt,{width:zt,height:zt,color:fe})}function Ht(Gt){var xt,bt=Gt|0;if(m(bt>0&&bt<=E.maxCubeMapSize,"invalid radius for cube fbo"),bt===mt.width)return mt;var zt=mt.color;for(xt=0;xt<zt.length;++xt)zt[xt].resize(bt);for(xt=0;xt<6;++xt)dt[xt].resize(bt);return mt.width=mt.height=bt,mt}return mt(et),r(mt,{faces:dt,resize:Ht,_reglType:"framebufferCube",destroy:function(){dt.forEach(function(Gt){Gt.destroy()})}})}function ft(){j.cur=null,j.next=null,j.dirty=!0,nr(J).forEach(function(et){et.framebuffer=l.createFramebuffer(),X(et)})}return r(j,{getFramebuffer:function(et){if(typeof et=="function"&&et._reglType==="framebuffer"){var dt=et._framebuffer;if(dt instanceof _t)return dt}return null},create:W,createCube:Ct,clear:function(){nr(J).forEach(Ft)},restore:ft})}var zm=5126,oc=34962,us=34963,lc=["attributes","elements","offset","count","primitive","instances"];function Fa(){this.state=0,this.x=0,this.y=0,this.z=0,this.w=0,this.buffer=null,this.size=0,this.normalized=!1,this.type=zm,this.offset=0,this.stride=0,this.divisor=0}function Um(l,p,E,k,Y,B,j){for(var Z=E.maxAttributes,q=new Array(Z),nt=0;nt<Z;++nt)q[nt]=new Fa;var at=0,st={},ut={Record:Fa,scope:{},state:q,currentVAO:null,targetVAO:null,restore:it()?yt:function(){},createVAO:Ft,getVAO:G,destroyBuffer:K,setVAO:it()?rt:vt,clear:it()?J:function(){}};function K(X){for(var W=0;W<q.length;++W){var Ct=q[W];Ct.buffer===X&&(l.disableVertexAttribArray(W),Ct.buffer=null)}}function it(){return p.oes_vertex_array_object}function R(){return p.angle_instanced_arrays}function G(X){return typeof X=="function"&&X._vao?X._vao:null}function rt(X){if(X!==ut.currentVAO){var W=it();X?W.bindVertexArrayOES(X.vao):W.bindVertexArrayOES(null),ut.currentVAO=X}}function vt(X){if(X!==ut.currentVAO){if(X)X.bindAttrs();else{for(var W=R(),Ct=0;Ct<q.length;++Ct){var ft=q[Ct];ft.buffer?(l.enableVertexAttribArray(Ct),ft.buffer.bind(),l.vertexAttribPointer(Ct,ft.size,ft.type,ft.normalized,ft.stride,ft.offfset),W&&ft.divisor&&W.vertexAttribDivisorANGLE(Ct,ft.divisor)):(l.disableVertexAttribArray(Ct),l.vertexAttrib4f(Ct,ft.x,ft.y,ft.z,ft.w))}j.elements?l.bindBuffer(us,j.elements.buffer.buffer):l.bindBuffer(us,null)}ut.currentVAO=X}}function J(){nr(st).forEach(function(X){X.destroy()})}function _t(){this.id=++at,this.attributes=[],this.elements=null,this.ownsElements=!1,this.count=0,this.offset=0,this.instances=-1,this.primitive=4;var X=it();X?this.vao=X.createVertexArrayOES():this.vao=null,st[this.id]=this,this.buffers=[]}_t.prototype.bindAttrs=function(){for(var X=R(),W=this.attributes,Ct=0;Ct<W.length;++Ct){var ft=W[Ct];ft.buffer?(l.enableVertexAttribArray(Ct),l.bindBuffer(oc,ft.buffer.buffer),l.vertexAttribPointer(Ct,ft.size,ft.type,ft.normalized,ft.stride,ft.offset),X&&ft.divisor&&X.vertexAttribDivisorANGLE(Ct,ft.divisor)):(l.disableVertexAttribArray(Ct),l.vertexAttrib4f(Ct,ft.x,ft.y,ft.z,ft.w))}for(var et=W.length;et<Z;++et)l.disableVertexAttribArray(et);var dt=B.getElements(this.elements);dt?l.bindBuffer(us,dt.buffer.buffer):l.bindBuffer(us,null)},_t.prototype.refresh=function(){var X=it();X&&(X.bindVertexArrayOES(this.vao),this.bindAttrs(),ut.currentVAO=null,X.bindVertexArrayOES(null))},_t.prototype.destroy=function(){if(this.vao){var X=it();this===ut.currentVAO&&(ut.currentVAO=null,X.bindVertexArrayOES(null)),X.deleteVertexArrayOES(this.vao),this.vao=null}this.ownsElements&&(this.elements.destroy(),this.elements=null,this.ownsElements=!1),st[this.id]&&(delete st[this.id],k.vaoCount-=1)};function yt(){var X=it();X&&nr(st).forEach(function(W){W.refresh()})}function Ft(X){var W=new _t;k.vaoCount+=1;function Ct(ft){var et;if(Array.isArray(ft))et=ft,W.elements&&W.ownsElements&&W.elements.destroy(),W.elements=null,W.ownsElements=!1,W.offset=0,W.count=0,W.instances=-1,W.primitive=4;else{if(m(typeof ft=="object","invalid arguments for create vao"),m("attributes"in ft,"must specify attributes for vao"),ft.elements){var dt=ft.elements;W.ownsElements?typeof dt=="function"&&dt._reglType==="elements"?(W.elements.destroy(),W.ownsElements=!1):(W.elements(dt),W.ownsElements=!1):B.getElements(ft.elements)?(W.elements=ft.elements,W.ownsElements=!1):(W.elements=B.create(ft.elements),W.ownsElements=!0)}else W.elements=null,W.ownsElements=!1;et=ft.attributes,W.offset=0,W.count=-1,W.instances=-1,W.primitive=4,W.elements&&(W.count=W.elements._elements.vertCount,W.primitive=W.elements._elements.primType),"offset"in ft&&(W.offset=ft.offset|0),"count"in ft&&(W.count=ft.count|0),"instances"in ft&&(W.instances=ft.instances|0),"primitive"in ft&&(m(ft.primitive in Xr,"bad primitive type: "+ft.primitive),W.primitive=Xr[ft.primitive]),m.optional(()=>{for(var pe=Object.keys(ft),ge=0;ge<pe.length;++ge)m(lc.indexOf(pe[ge])>=0,'invalid option for vao: "'+pe[ge]+'" valid options are '+lc)}),m(Array.isArray(et),"attributes must be an array")}m(et.length<Z,"too many attributes"),m(et.length>0,"must specify at least one attribute");var mt={},Ht=W.attributes;Ht.length=et.length;for(var Gt=0;Gt<et.length;++Gt){var xt=et[Gt],bt=Ht[Gt]=new Fa,zt=xt.data||xt;if(Array.isArray(zt)||e(zt)||dr(zt)){var Vt;W.buffers[Gt]&&(Vt=W.buffers[Gt],e(zt)&&Vt._buffer.byteLength>=zt.byteLength?Vt.subdata(zt):(Vt.destroy(),W.buffers[Gt]=null)),W.buffers[Gt]||(Vt=W.buffers[Gt]=Y.create(xt,oc,!1,!0)),bt.buffer=Y.getBuffer(Vt),bt.size=bt.buffer.dimension|0,bt.normalized=!1,bt.type=bt.buffer.dtype,bt.offset=0,bt.stride=0,bt.divisor=0,bt.state=1,mt[Gt]=1}else Y.getBuffer(xt)?(bt.buffer=Y.getBuffer(xt),bt.size=bt.buffer.dimension|0,bt.normalized=!1,bt.type=bt.buffer.dtype,bt.offset=0,bt.stride=0,bt.divisor=0,bt.state=1):Y.getBuffer(xt.buffer)?(bt.buffer=Y.getBuffer(xt.buffer),bt.size=(+xt.size||bt.buffer.dimension)|0,bt.normalized=!!xt.normalized||!1,"type"in xt?(m.parameter(xt.type,ui,"invalid buffer type"),bt.type=ui[xt.type]):bt.type=bt.buffer.dtype,bt.offset=(xt.offset||0)|0,bt.stride=(xt.stride||0)|0,bt.divisor=(xt.divisor||0)|0,bt.state=1,m(bt.size>=1&&bt.size<=4,"size must be between 1 and 4"),m(bt.offset>=0,"invalid offset"),m(bt.stride>=0&&bt.stride<=255,"stride must be between 0 and 255"),m(bt.divisor>=0,"divisor must be positive"),m(!bt.divisor||!!p.angle_instanced_arrays,"ANGLE_instanced_arrays must be enabled to use divisor")):"x"in xt?(m(Gt>0,"first attribute must not be a constant"),bt.x=+xt.x||0,bt.y=+xt.y||0,bt.z=+xt.z||0,bt.w=+xt.w||0,bt.state=2):m(!1,"invalid attribute spec for location "+Gt)}for(var qt=0;qt<W.buffers.length;++qt)!mt[qt]&&W.buffers[qt]&&(W.buffers[qt].destroy(),W.buffers[qt]=null);return W.refresh(),Ct}return Ct.destroy=function(){for(var ft=0;ft<W.buffers.length;++ft)W.buffers[ft]&&W.buffers[ft].destroy();W.buffers.length=0,W.ownsElements&&(W.elements.destroy(),W.elements=null,W.ownsElements=!1),W.destroy()},Ct._vao=W,Ct._reglType="vao",Ct(X)}return ut}var cc=35632,Gm=35633,Vm=35718,jm=35721;function Hm(l,p,E,k){var Y={},B={};function j(R,G,rt,vt){this.name=R,this.id=G,this.location=rt,this.info=vt}function Z(R,G){for(var rt=0;rt<R.length;++rt)if(R[rt].id===G.id){R[rt].location=G.location;return}R.push(G)}function q(R,G,rt){var vt=R===cc?Y:B,J=vt[G];if(!J){var _t=p.str(G);J=l.createShader(R),l.shaderSource(J,_t),l.compileShader(J),m.shaderError(l,J,_t,R,rt),vt[G]=J}return J}var nt={},at=[],st=0;function ut(R,G){this.id=st++,this.fragId=R,this.vertId=G,this.program=null,this.uniforms=[],this.attributes=[],this.refCount=1,k.profile&&(this.stats={uniformsCount:0,attributesCount:0})}function K(R,G,rt){var vt,J,_t=q(cc,R.fragId),yt=q(Gm,R.vertId),Ft=R.program=l.createProgram();if(l.attachShader(Ft,_t),l.attachShader(Ft,yt),rt)for(vt=0;vt<rt.length;++vt){var X=rt[vt];l.bindAttribLocation(Ft,X[0],X[1])}l.linkProgram(Ft),m.linkError(l,Ft,p.str(R.fragId),p.str(R.vertId),G);var W=l.getProgramParameter(Ft,Vm);k.profile&&(R.stats.uniformsCount=W);var Ct=R.uniforms;for(vt=0;vt<W;++vt)if(J=l.getActiveUniform(Ft,vt),J)if(J.size>1)for(var ft=0;ft<J.size;++ft){var et=J.name.replace("[0]","["+ft+"]");Z(Ct,new j(et,p.id(et),l.getUniformLocation(Ft,et),J))}else Z(Ct,new j(J.name,p.id(J.name),l.getUniformLocation(Ft,J.name),J));var dt=l.getProgramParameter(Ft,jm);k.profile&&(R.stats.attributesCount=dt);var mt=R.attributes;for(vt=0;vt<dt;++vt)J=l.getActiveAttrib(Ft,vt),J&&Z(mt,new j(J.name,p.id(J.name),l.getAttribLocation(Ft,J.name),J))}k.profile&&(E.getMaxUniformsCount=function(){var R=0;return at.forEach(function(G){G.stats.uniformsCount>R&&(R=G.stats.uniformsCount)}),R},E.getMaxAttributesCount=function(){var R=0;return at.forEach(function(G){G.stats.attributesCount>R&&(R=G.stats.attributesCount)}),R});function it(){Y={},B={};for(var R=0;R<at.length;++R)K(at[R],null,at[R].attributes.map(function(G){return[G.location,G.name]}))}return{clear:function(){var R=l.deleteShader.bind(l);nr(Y).forEach(R),Y={},nr(B).forEach(R),B={},at.forEach(function(G){l.deleteProgram(G.program)}),at.length=0,nt={},E.shaderCount=0},program:function(R,G,rt,vt){m.command(R>=0,"missing vertex shader",rt),m.command(G>=0,"missing fragment shader",rt);var J=nt[G];J||(J=nt[G]={});var _t=J[R];if(_t&&(_t.refCount++,!vt))return _t;var yt=new ut(G,R);return E.shaderCount++,K(yt,rt,vt),_t||(J[R]=yt),at.push(yt),r(yt,{destroy:function(){if(yt.refCount--,yt.refCount<=0){l.deleteProgram(yt.program);var Ft=at.indexOf(yt);at.splice(Ft,1),E.shaderCount--}J[yt.vertId].refCount<=0&&(l.deleteShader(B[yt.vertId]),delete B[yt.vertId],delete nt[yt.fragId][yt.vertId]),Object.keys(nt[yt.fragId]).length||(l.deleteShader(Y[yt.fragId]),delete Y[yt.fragId],delete nt[yt.fragId])}})},restore:it,shader:q,frag:-1,vert:-1}}var Wm=6408,An=5121,Ym=3333,fs=5126;function Xm(l,p,E,k,Y,B,j){function Z(at){var st;p.next===null?(m(Y.preserveDrawingBuffer,'you must create a webgl context with "preserveDrawingBuffer":true in order to read pixels from the drawing buffer'),st=An):(m(p.next.colorAttachments[0].texture!==null,"You cannot read from a renderbuffer"),st=p.next.colorAttachments[0].texture._texture.type,m.optional(function(){B.oes_texture_float?(m(st===An||st===fs,"Reading from a framebuffer is only allowed for the types 'uint8' and 'float'"),st===fs&&m(j.readFloat,"Reading 'float' values is not permitted in your browser. For a fallback, please see: https://www.npmjs.com/package/glsl-read-float")):m(st===An,"Reading from a framebuffer is only allowed for the type 'uint8'")}));var ut=0,K=0,it=k.framebufferWidth,R=k.framebufferHeight,G=null;e(at)?G=at:at&&(m.type(at,"object","invalid arguments to regl.read()"),ut=at.x|0,K=at.y|0,m(ut>=0&&ut<k.framebufferWidth,"invalid x offset for regl.read"),m(K>=0&&K<k.framebufferHeight,"invalid y offset for regl.read"),it=(at.width||k.framebufferWidth-ut)|0,R=(at.height||k.framebufferHeight-K)|0,G=at.data||null),G&&(st===An?m(G instanceof Uint8Array,"buffer must be 'Uint8Array' when reading from a framebuffer of type 'uint8'"):st===fs&&m(G instanceof Float32Array,"buffer must be 'Float32Array' when reading from a framebuffer of type 'float'")),m(it>0&&it+ut<=k.framebufferWidth,"invalid width for read pixels"),m(R>0&&R+K<=k.framebufferHeight,"invalid height for read pixels"),E();var rt=it*R*4;return G||(st===An?G=new Uint8Array(rt):st===fs&&(G=G||new Float32Array(rt))),m.isTypedArray(G,"data buffer for regl.read() must be a typedarray"),m(G.byteLength>=rt,"data buffer for regl.read() too small"),l.pixelStorei(Ym,4),l.readPixels(ut,K,it,R,Wm,st,G),G}function q(at){var st;return p.setFBO({framebuffer:at.framebuffer},function(){st=Z(at)}),st}function nt(at){return!at||!("framebuffer"in at)?Z(at):q(at)}return nt}function zi(l){return Array.prototype.slice.call(l)}function Ui(l){return zi(l).join("")}function $m(){var l=0,p=[],E=[];function k(st){for(var ut=0;ut<E.length;++ut)if(E[ut]===st)return p[ut];var K="g"+l++;return p.push(K),E.push(st),K}function Y(){var st=[];function ut(){st.push.apply(st,zi(arguments))}var K=[];function it(){var R="v"+l++;return K.push(R),arguments.length>0&&(st.push(R,"="),st.push.apply(st,zi(arguments)),st.push(";")),R}return r(ut,{def:it,toString:function(){return Ui([K.length>0?"var "+K.join(",")+";":"",Ui(st)])}})}function B(){var st=Y(),ut=Y(),K=st.toString,it=ut.toString;function R(G,rt){ut(G,rt,"=",st.def(G,rt),";")}return r(function(){st.apply(st,zi(arguments))},{def:st.def,entry:st,exit:ut,save:R,set:function(G,rt,vt){R(G,rt),st(G,rt,"=",vt,";")},toString:function(){return K()+it()}})}function j(){var st=Ui(arguments),ut=B(),K=B(),it=ut.toString,R=K.toString;return r(ut,{then:function(){return ut.apply(ut,zi(arguments)),this},else:function(){return K.apply(K,zi(arguments)),this},toString:function(){var G=R();return G&&(G="else{"+G+"}"),Ui(["if(",st,"){",it(),"}",G])}})}var Z=Y(),q={};function nt(st,ut){var K=[];function it(){var J="a"+K.length;return K.push(J),J}ut=ut||0;for(var R=0;R<ut;++R)it();var G=B(),rt=G.toString,vt=q[st]=r(G,{arg:it,toString:function(){return Ui(["function(",K.join(),"){",rt(),"}"])}});return vt}function at(){var st=['"use strict";',Z,"return {"];Object.keys(q).forEach(function(it){st.push('"',it,'":',q[it].toString(),",")}),st.push("}");var ut=Ui(st).replace(/;/g,`;
`).replace(/}/g,`}
`).replace(/{/g,`{
`),K=Function.apply(null,p.concat(ut));return K.apply(null,E)}return{global:Z,link:k,block:Y,proc:nt,scope:B,cond:j,compile:at}}var Gi="xyzw".split(""),hc=5121,Vi=1,Pa=2,Ba=0,ka=1,za=2,Ua=3,ds=4,uc=5,fc=6,dc="dither",mc="blend.enable",pc="blend.color",Ga="blend.equation",Va="blend.func",yc="depth.enable",xc="depth.func",gc="depth.range",_c="depth.mask",ja="colorMask",bc="cull.enable",vc="cull.face",Ha="frontFace",Wa="lineWidth",Ec="polygonOffset.enable",Ya="polygonOffset.offset",Ac="sample.alpha",Tc="sample.enable",Xa="sample.coverage",Sc="stencil.enable",wc="stencil.mask",$a="stencil.func",Ja="stencil.opFront",Tn="stencil.opBack",Mc="scissor.enable",ms="scissor.box",Rr="viewport",Sn="profile",yi="framebuffer",wn="vert",Mn="frag",xi="elements",gi="primitive",_i="count",ps="offset",ys="instances",Cn="vao",qa="Width",Za="Height",ji=yi+qa,Hi=yi+Za,Jm=Rr+qa,qm=Rr+Za,Cc="drawingBuffer",Ic=Cc+qa,Rc=Cc+Za,Zm=[Va,Ga,$a,Ja,Tn,Xa,Rr,ms,Ya],Wi=34962,Ka=34963,Km=35632,Qm=35633,Oc=3553,tp=34067,ep=2884,rp=3042,ip=3024,np=2960,sp=2929,ap=3089,op=32823,lp=32926,cp=32928,Qa=5126,xs=35664,gs=35665,_s=35666,to=5124,bs=35667,vs=35668,Es=35669,eo=35670,As=35671,Ts=35672,Ss=35673,In=35674,Rn=35675,On=35676,Nn=35678,Ln=35680,ro=4,Dn=1028,bi=1029,Nc=2304,io=2305,hp=32775,up=32776,fp=519,Jr=7680,Lc=0,Dc=1,Fc=32774,dp=513,Pc=36160,mp=36064,Ar={0:0,1:1,zero:0,one:1,"src color":768,"one minus src color":769,"src alpha":770,"one minus src alpha":771,"dst color":774,"one minus dst color":775,"dst alpha":772,"one minus dst alpha":773,"constant color":32769,"one minus constant color":32770,"constant alpha":32771,"one minus constant alpha":32772,"src alpha saturate":776},Bc=["constant color, constant alpha","one minus constant color, constant alpha","constant color, one minus constant alpha","one minus constant color, one minus constant alpha","constant alpha, constant color","constant alpha, one minus constant color","one minus constant alpha, constant color","one minus constant alpha, one minus constant color"],Yi={never:512,less:513,"<":513,equal:514,"=":514,"==":514,"===":514,lequal:515,"<=":515,greater:516,">":516,notequal:517,"!=":517,"!==":517,gequal:518,">=":518,always:519},qr={0:0,zero:0,keep:7680,replace:7681,increment:7682,decrement:7683,"increment wrap":34055,"decrement wrap":34056,invert:5386},kc={frag:Km,vert:Qm},no={cw:Nc,ccw:io};function ws(l){return Array.isArray(l)||e(l)||dr(l)}function zc(l){return l.sort(function(p,E){return p===Rr?-1:E===Rr?1:p<E?-1:1})}function Fe(l,p,E,k){this.thisDep=l,this.contextDep=p,this.propDep=E,this.append=k}function Zr(l){return l&&!(l.thisDep||l.contextDep||l.propDep)}function Re(l){return new Fe(!1,!1,!1,l)}function Qe(l,p){var E=l.type;if(E===Ba){var k=l.data.length;return new Fe(!0,k>=1,k>=2,p)}else if(E===ds){var Y=l.data;return new Fe(Y.thisDep,Y.contextDep,Y.propDep,p)}else{if(E===uc)return new Fe(!1,!1,!1,p);if(E===fc){for(var B=!1,j=!1,Z=!1,q=0;q<l.data.length;++q){var nt=l.data[q];if(nt.type===ka)Z=!0;else if(nt.type===za)j=!0;else if(nt.type===Ua)B=!0;else if(nt.type===Ba){B=!0;var at=nt.data;at>=1&&(j=!0),at>=2&&(Z=!0)}else nt.type===ds&&(B=B||nt.data.thisDep,j=j||nt.data.contextDep,Z=Z||nt.data.propDep)}return new Fe(B,j,Z,p)}else return new Fe(E===Ua,E===za,E===ka,p)}}var Uc=new Fe(!1,!1,!1,function(){});function pp(l,p,E,k,Y,B,j,Z,q,nt,at,st,ut,K,it){var R=nt.Record,G={add:32774,subtract:32778,"reverse subtract":32779};E.ext_blend_minmax&&(G.min=hp,G.max=up);var rt=E.angle_instanced_arrays,vt=E.webgl_draw_buffers,J=E.oes_vertex_array_object,_t={dirty:!0,profile:it.profile},yt={},Ft=[],X={},W={};function Ct(_){return _.replace(".","_")}function ft(_,f,S){var I=Ct(_);Ft.push(_),yt[I]=_t[I]=!!S,X[I]=f}function et(_,f,S){var I=Ct(_);Ft.push(_),Array.isArray(S)?(_t[I]=S.slice(),yt[I]=S.slice()):_t[I]=yt[I]=S,W[I]=f}ft(dc,ip),ft(mc,rp),et(pc,"blendColor",[0,0,0,0]),et(Ga,"blendEquationSeparate",[Fc,Fc]),et(Va,"blendFuncSeparate",[Dc,Lc,Dc,Lc]),ft(yc,sp,!0),et(xc,"depthFunc",dp),et(gc,"depthRange",[0,1]),et(_c,"depthMask",!0),et(ja,ja,[!0,!0,!0,!0]),ft(bc,ep),et(vc,"cullFace",bi),et(Ha,Ha,io),et(Wa,Wa,1),ft(Ec,op),et(Ya,"polygonOffset",[0,0]),ft(Ac,lp),ft(Tc,cp),et(Xa,"sampleCoverage",[1,!1]),ft(Sc,np),et(wc,"stencilMask",-1),et($a,"stencilFunc",[fp,0,-1]),et(Ja,"stencilOpSeparate",[Dn,Jr,Jr,Jr]),et(Tn,"stencilOpSeparate",[bi,Jr,Jr,Jr]),ft(Mc,ap),et(ms,"scissor",[0,0,l.drawingBufferWidth,l.drawingBufferHeight]),et(Rr,Rr,[0,0,l.drawingBufferWidth,l.drawingBufferHeight]);var dt={gl:l,context:ut,strings:p,next:yt,current:_t,draw:st,elements:B,buffer:Y,shader:at,attributes:nt.state,vao:nt,uniforms:q,framebuffer:Z,extensions:E,timer:K,isBufferArgs:ws},mt={primTypes:Xr,compareFuncs:Yi,blendFuncs:Ar,blendEquations:G,stencilOps:qr,glTypes:ui,orientationType:no};m.optional(function(){dt.isArrayLike=ve}),vt&&(mt.backBuffer=[bi],mt.drawBuffer=ir(k.maxDrawbuffers,function(_){return _===0?[0]:ir(_,function(f){return mp+f})}));var Ht=0;function Gt(){var _=$m(),f=_.link,S=_.global;_.id=Ht++,_.batchId="0";var I=f(dt),N=_.shared={props:"a0"};Object.keys(dt).forEach(function(T){N[T]=S.def(I,".",T)}),m.optional(function(){_.CHECK=f(m),_.commandStr=m.guessCommand(),_.command=f(_.commandStr),_.assert=function(T,b,O){T("if(!(",b,"))",this.CHECK,".commandRaise(",f(O),",",this.command,");")},mt.invalidBlendCombinations=Bc});var M=_.next={},w=_.current={};Object.keys(W).forEach(function(T){Array.isArray(_t[T])&&(M[T]=S.def(N.next,".",T),w[T]=S.def(N.current,".",T))});var C=_.constants={};Object.keys(mt).forEach(function(T){C[T]=S.def(JSON.stringify(mt[T]))}),_.invoke=function(T,b){switch(b.type){case Ba:var O=["this",N.context,N.props,_.batchId];return T.def(f(b.data),".call(",O.slice(0,Math.max(b.data.length+1,4)),")");case ka:return T.def(N.props,b.data);case za:return T.def(N.context,b.data);case Ua:return T.def("this",b.data);case ds:return b.data.append(_,T),b.data.ref;case uc:return b.data.toString();case fc:return b.data.map(function(D){return _.invoke(T,D)})}},_.attribCache={};var y={};return _.scopeAttrib=function(T){var b=p.id(T);if(b in y)return y[b];var O=nt.scope[b];O||(O=nt.scope[b]=new R);var D=y[b]=f(O);return D},_}function xt(_){var f=_.static,S=_.dynamic,I;if(Sn in f){var N=!!f[Sn];I=Re(function(w,C){return N}),I.enable=N}else if(Sn in S){var M=S[Sn];I=Qe(M,function(w,C){return w.invoke(C,M)})}return I}function bt(_,f){var S=_.static,I=_.dynamic;if(yi in S){var N=S[yi];return N?(N=Z.getFramebuffer(N),m.command(N,"invalid framebuffer object"),Re(function(w,C){var y=w.link(N),T=w.shared;C.set(T.framebuffer,".next",y);var b=T.context;return C.set(b,"."+ji,y+".width"),C.set(b,"."+Hi,y+".height"),y})):Re(function(w,C){var y=w.shared;C.set(y.framebuffer,".next","null");var T=y.context;return C.set(T,"."+ji,T+"."+Ic),C.set(T,"."+Hi,T+"."+Rc),"null"})}else if(yi in I){var M=I[yi];return Qe(M,function(w,C){var y=w.invoke(C,M),T=w.shared,b=T.framebuffer,O=C.def(b,".getFramebuffer(",y,")");m.optional(function(){w.assert(C,"!"+y+"||"+O,"invalid framebuffer object")}),C.set(b,".next",O);var D=T.context;return C.set(D,"."+ji,O+"?"+O+".width:"+D+"."+Ic),C.set(D,"."+Hi,O+"?"+O+".height:"+D+"."+Rc),O})}else return null}function zt(_,f,S){var I=_.static,N=_.dynamic;function M(y){if(y in I){var T=I[y];m.commandType(T,"object","invalid "+y,S.commandStr);var b=!0,O=T.x|0,D=T.y|0,$,ct;return"width"in T?($=T.width|0,m.command($>=0,"invalid "+y,S.commandStr)):b=!1,"height"in T?(ct=T.height|0,m.command(ct>=0,"invalid "+y,S.commandStr)):b=!1,new Fe(!b&&f&&f.thisDep,!b&&f&&f.contextDep,!b&&f&&f.propDep,function(ot,Ot){var Tt=ot.shared.context,It=$;"width"in T||(It=Ot.def(Tt,".",ji,"-",O));var Rt=ct;return"height"in T||(Rt=Ot.def(Tt,".",Hi,"-",D)),[O,D,It,Rt]})}else if(y in N){var ht=N[y],gt=Qe(ht,function(ot,Ot){var Tt=ot.invoke(Ot,ht);m.optional(function(){ot.assert(Ot,Tt+"&&typeof "+Tt+'==="object"',"invalid "+y)});var It=ot.shared.context,Rt=Ot.def(Tt,".x|0"),Nt=Ot.def(Tt,".y|0"),Ut=Ot.def('"width" in ',Tt,"?",Tt,".width|0:","(",It,".",ji,"-",Rt,")"),he=Ot.def('"height" in ',Tt,"?",Tt,".height|0:","(",It,".",Hi,"-",Nt,")");return m.optional(function(){ot.assert(Ot,Ut+">=0&&"+he+">=0","invalid "+y)}),[Rt,Nt,Ut,he]});return f&&(gt.thisDep=gt.thisDep||f.thisDep,gt.contextDep=gt.contextDep||f.contextDep,gt.propDep=gt.propDep||f.propDep),gt}else return f?new Fe(f.thisDep,f.contextDep,f.propDep,function(ot,Ot){var Tt=ot.shared.context;return[0,0,Ot.def(Tt,".",ji),Ot.def(Tt,".",Hi)]}):null}var w=M(Rr);if(w){var C=w;w=new Fe(w.thisDep,w.contextDep,w.propDep,function(y,T){var b=C.append(y,T),O=y.shared.context;return T.set(O,"."+Jm,b[2]),T.set(O,"."+qm,b[3]),b})}return{viewport:w,scissor_box:M(ms)}}function Vt(_,f){var S=_.static,I=typeof S[Mn]=="string"&&typeof S[wn]=="string";if(I){if(Object.keys(f.dynamic).length>0)return null;var N=f.static,M=Object.keys(N);if(M.length>0&&typeof N[M[0]]=="number"){for(var w=[],C=0;C<M.length;++C)m(typeof N[M[C]]=="number","must specify all vertex attribute locations when using vaos"),w.push([N[M[C]]|0,M[C]]);return w}}return null}function qt(_,f,S){var I=_.static,N=_.dynamic;function M(b){if(b in I){var O=p.id(I[b]);m.optional(function(){at.shader(kc[b],O,m.guessCommand())});var D=Re(function(){return O});return D.id=O,D}else if(b in N){var $=N[b];return Qe($,function(ct,ht){var gt=ct.invoke(ht,$),ot=ht.def(ct.shared.strings,".id(",gt,")");return m.optional(function(){ht(ct.shared.shader,".shader(",kc[b],",",ot,",",ct.command,");")}),ot})}return null}var w=M(Mn),C=M(wn),y=null,T;return Zr(w)&&Zr(C)?(y=at.program(C.id,w.id,null,S),T=Re(function(b,O){return b.link(y)})):T=new Fe(w&&w.thisDep||C&&C.thisDep,w&&w.contextDep||C&&C.contextDep,w&&w.propDep||C&&C.propDep,function(b,O){var D=b.shared.shader,$;w?$=w.append(b,O):$=O.def(D,".",Mn);var ct;C?ct=C.append(b,O):ct=O.def(D,".",wn);var ht=D+".program("+ct+","+$;return m.optional(function(){ht+=","+b.command}),O.def(ht+")")}),{frag:w,vert:C,progVar:T,program:y}}function pe(_,f){var S=_.static,I=_.dynamic,N={},M=!1;function w(){if(Cn in S){var Ot=S[Cn];return Ot!==null&&nt.getVAO(Ot)===null&&(Ot=nt.createVAO(Ot)),M=!0,N.vao=Ot,Re(function(It){var Rt=nt.getVAO(Ot);return Rt?It.link(Rt):"null"})}else if(Cn in I){M=!0;var Tt=I[Cn];return Qe(Tt,function(It,Rt){var Nt=It.invoke(Rt,Tt);return Rt.def(It.shared.vao+".getVAO("+Nt+")")})}return null}var C=w(),y=!1;function T(){if(xi in S){var Ot=S[xi];if(N.elements=Ot,ws(Ot)){var Tt=N.elements=B.create(Ot,!0);Ot=B.getElements(Tt),y=!0}else Ot&&(Ot=B.getElements(Ot),y=!0,m.command(Ot,"invalid elements",f.commandStr));var It=Re(function(Nt,Ut){if(Ot){var he=Nt.link(Ot);return Nt.ELEMENTS=he,he}return Nt.ELEMENTS=null,null});return It.value=Ot,It}else if(xi in I){y=!0;var Rt=I[xi];return Qe(Rt,function(Nt,Ut){var he=Nt.shared,ze=he.isBufferArgs,Or=he.elements,Nr=Nt.invoke(Ut,Rt),Lr=Ut.def("null"),Xe=Ut.def(ze,"(",Nr,")"),Sr=Nt.cond(Xe).then(Lr,"=",Or,".createStream(",Nr,");").else(Lr,"=",Or,".getElements(",Nr,");");return m.optional(function(){Nt.assert(Sr.else,"!"+Nr+"||"+Lr,"invalid elements")}),Ut.entry(Sr),Ut.exit(Nt.cond(Xe).then(Or,".destroyStream(",Lr,");")),Nt.ELEMENTS=Lr,Lr})}else if(M)return new Fe(C.thisDep,C.contextDep,C.propDep,function(Nt,Ut){return Ut.def(Nt.shared.vao+".currentVAO?"+Nt.shared.elements+".getElements("+Nt.shared.vao+".currentVAO.elements):null")});return null}var b=T();function O(){if(gi in S){var Ot=S[gi];return N.primitive=Ot,m.commandParameter(Ot,Xr,"invalid primitve",f.commandStr),Re(function(It,Rt){return Xr[Ot]})}else if(gi in I){var Tt=I[gi];return Qe(Tt,function(It,Rt){var Nt=It.constants.primTypes,Ut=It.invoke(Rt,Tt);return m.optional(function(){It.assert(Rt,Ut+" in "+Nt,"invalid primitive, must be one of "+Object.keys(Xr))}),Rt.def(Nt,"[",Ut,"]")})}else{if(y)return Zr(b)?b.value?Re(function(It,Rt){return Rt.def(It.ELEMENTS,".primType")}):Re(function(){return ro}):new Fe(b.thisDep,b.contextDep,b.propDep,function(It,Rt){var Nt=It.ELEMENTS;return Rt.def(Nt,"?",Nt,".primType:",ro)});if(M)return new Fe(C.thisDep,C.contextDep,C.propDep,function(It,Rt){return Rt.def(It.shared.vao+".currentVAO?"+It.shared.vao+".currentVAO.primitive:"+ro)})}return null}function D(Ot,Tt){if(Ot in S){var It=S[Ot]|0;return Tt?N.offset=It:N.instances=It,m.command(!Tt||It>=0,"invalid "+Ot,f.commandStr),Re(function(Nt,Ut){return Tt&&(Nt.OFFSET=It),It})}else if(Ot in I){var Rt=I[Ot];return Qe(Rt,function(Nt,Ut){var he=Nt.invoke(Ut,Rt);return Tt&&(Nt.OFFSET=he,m.optional(function(){Nt.assert(Ut,he+">=0","invalid "+Ot)})),he})}else if(Tt){if(y)return Re(function(Nt,Ut){return Nt.OFFSET=0,0});if(M)return new Fe(C.thisDep,C.contextDep,C.propDep,function(Nt,Ut){return Ut.def(Nt.shared.vao+".currentVAO?"+Nt.shared.vao+".currentVAO.offset:0")})}else if(M)return new Fe(C.thisDep,C.contextDep,C.propDep,function(Nt,Ut){return Ut.def(Nt.shared.vao+".currentVAO?"+Nt.shared.vao+".currentVAO.instances:-1")});return null}var $=D(ps,!0);function ct(){if(_i in S){var Ot=S[_i]|0;return N.count=Ot,m.command(typeof Ot=="number"&&Ot>=0,"invalid vertex count",f.commandStr),Re(function(){return Ot})}else if(_i in I){var Tt=I[_i];return Qe(Tt,function(Ut,he){var ze=Ut.invoke(he,Tt);return m.optional(function(){Ut.assert(he,"typeof "+ze+'==="number"&&'+ze+">=0&&"+ze+"===("+ze+"|0)","invalid vertex count")}),ze})}else if(y)if(Zr(b)){if(b)return $?new Fe($.thisDep,$.contextDep,$.propDep,function(Ut,he){var ze=he.def(Ut.ELEMENTS,".vertCount-",Ut.OFFSET);return m.optional(function(){Ut.assert(he,ze+">=0","invalid vertex offset/element buffer too small")}),ze}):Re(function(Ut,he){return he.def(Ut.ELEMENTS,".vertCount")});var It=Re(function(){return-1});return m.optional(function(){It.MISSING=!0}),It}else{var Rt=new Fe(b.thisDep||$.thisDep,b.contextDep||$.contextDep,b.propDep||$.propDep,function(Ut,he){var ze=Ut.ELEMENTS;return Ut.OFFSET?he.def(ze,"?",ze,".vertCount-",Ut.OFFSET,":-1"):he.def(ze,"?",ze,".vertCount:-1")});return m.optional(function(){Rt.DYNAMIC=!0}),Rt}else if(M){var Nt=new Fe(C.thisDep,C.contextDep,C.propDep,function(Ut,he){return he.def(Ut.shared.vao,".currentVAO?",Ut.shared.vao,".currentVAO.count:-1")});return Nt}return null}var ht=O(),gt=ct(),ot=D(ys,!1);return{elements:b,primitive:ht,count:gt,instances:ot,offset:$,vao:C,vaoActive:M,elementsActive:y,static:N}}function ge(_,f){var S=_.static,I=_.dynamic,N={};return Ft.forEach(function(M){var w=Ct(M);function C(y,T){if(M in S){var b=y(S[M]);N[w]=Re(function(){return b})}else if(M in I){var O=I[M];N[w]=Qe(O,function(D,$){return T(D,$,D.invoke($,O))})}}switch(M){case bc:case mc:case dc:case Sc:case yc:case Mc:case Ec:case Ac:case Tc:case _c:return C(function(y){return m.commandType(y,"boolean",M,f.commandStr),y},function(y,T,b){return m.optional(function(){y.assert(T,"typeof "+b+'==="boolean"',"invalid flag "+M,y.commandStr)}),b});case xc:return C(function(y){return m.commandParameter(y,Yi,"invalid "+M,f.commandStr),Yi[y]},function(y,T,b){var O=y.constants.compareFuncs;return m.optional(function(){y.assert(T,b+" in "+O,"invalid "+M+", must be one of "+Object.keys(Yi))}),T.def(O,"[",b,"]")});case gc:return C(function(y){return m.command(ve(y)&&y.length===2&&typeof y[0]=="number"&&typeof y[1]=="number"&&y[0]<=y[1],"depth range is 2d array",f.commandStr),y},function(y,T,b){m.optional(function(){y.assert(T,y.shared.isArrayLike+"("+b+")&&"+b+".length===2&&typeof "+b+'[0]==="number"&&typeof '+b+'[1]==="number"&&'+b+"[0]<="+b+"[1]","depth range must be a 2d array")});var O=T.def("+",b,"[0]"),D=T.def("+",b,"[1]");return[O,D]});case Va:return C(function(y){m.commandType(y,"object","blend.func",f.commandStr);var T="srcRGB"in y?y.srcRGB:y.src,b="srcAlpha"in y?y.srcAlpha:y.src,O="dstRGB"in y?y.dstRGB:y.dst,D="dstAlpha"in y?y.dstAlpha:y.dst;return m.commandParameter(T,Ar,w+".srcRGB",f.commandStr),m.commandParameter(b,Ar,w+".srcAlpha",f.commandStr),m.commandParameter(O,Ar,w+".dstRGB",f.commandStr),m.commandParameter(D,Ar,w+".dstAlpha",f.commandStr),m.command(Bc.indexOf(T+", "+O)===-1,"unallowed blending combination (srcRGB, dstRGB) = ("+T+", "+O+")",f.commandStr),[Ar[T],Ar[O],Ar[b],Ar[D]]},function(y,T,b){var O=y.constants.blendFuncs;m.optional(function(){y.assert(T,b+"&&typeof "+b+'==="object"',"invalid blend func, must be an object")});function D(Tt,It){var Rt=T.def('"',Tt,It,'" in ',b,"?",b,".",Tt,It,":",b,".",Tt);return m.optional(function(){y.assert(T,Rt+" in "+O,"invalid "+M+"."+Tt+It+", must be one of "+Object.keys(Ar))}),Rt}var $=D("src","RGB"),ct=D("dst","RGB");m.optional(function(){var Tt=y.constants.invalidBlendCombinations;y.assert(T,Tt+".indexOf("+$+'+", "+'+ct+") === -1 ","unallowed blending combination for (srcRGB, dstRGB)")});var ht=T.def(O,"[",$,"]"),gt=T.def(O,"[",D("src","Alpha"),"]"),ot=T.def(O,"[",ct,"]"),Ot=T.def(O,"[",D("dst","Alpha"),"]");return[ht,ot,gt,Ot]});case Ga:return C(function(y){if(typeof y=="string")return m.commandParameter(y,G,"invalid "+M,f.commandStr),[G[y],G[y]];if(typeof y=="object")return m.commandParameter(y.rgb,G,M+".rgb",f.commandStr),m.commandParameter(y.alpha,G,M+".alpha",f.commandStr),[G[y.rgb],G[y.alpha]];m.commandRaise("invalid blend.equation",f.commandStr)},function(y,T,b){var O=y.constants.blendEquations,D=T.def(),$=T.def(),ct=y.cond("typeof ",b,'==="string"');return m.optional(function(){function ht(gt,ot,Ot){y.assert(gt,Ot+" in "+O,"invalid "+ot+", must be one of "+Object.keys(G))}ht(ct.then,M,b),y.assert(ct.else,b+"&&typeof "+b+'==="object"',"invalid "+M),ht(ct.else,M+".rgb",b+".rgb"),ht(ct.else,M+".alpha",b+".alpha")}),ct.then(D,"=",$,"=",O,"[",b,"];"),ct.else(D,"=",O,"[",b,".rgb];",$,"=",O,"[",b,".alpha];"),T(ct),[D,$]});case pc:return C(function(y){return m.command(ve(y)&&y.length===4,"blend.color must be a 4d array",f.commandStr),ir(4,function(T){return+y[T]})},function(y,T,b){return m.optional(function(){y.assert(T,y.shared.isArrayLike+"("+b+")&&"+b+".length===4","blend.color must be a 4d array")}),ir(4,function(O){return T.def("+",b,"[",O,"]")})});case wc:return C(function(y){return m.commandType(y,"number",w,f.commandStr),y|0},function(y,T,b){return m.optional(function(){y.assert(T,"typeof "+b+'==="number"',"invalid stencil.mask")}),T.def(b,"|0")});case $a:return C(function(y){m.commandType(y,"object",w,f.commandStr);var T=y.cmp||"keep",b=y.ref||0,O="mask"in y?y.mask:-1;return m.commandParameter(T,Yi,M+".cmp",f.commandStr),m.commandType(b,"number",M+".ref",f.commandStr),m.commandType(O,"number",M+".mask",f.commandStr),[Yi[T],b,O]},function(y,T,b){var O=y.constants.compareFuncs;m.optional(function(){function ht(){y.assert(T,Array.prototype.join.call(arguments,""),"invalid stencil.func")}ht(b+"&&typeof ",b,'==="object"'),ht('!("cmp" in ',b,")||(",b,".cmp in ",O,")")});var D=T.def('"cmp" in ',b,"?",O,"[",b,".cmp]",":",Jr),$=T.def(b,".ref|0"),ct=T.def('"mask" in ',b,"?",b,".mask|0:-1");return[D,$,ct]});case Ja:case Tn:return C(function(y){m.commandType(y,"object",w,f.commandStr);var T=y.fail||"keep",b=y.zfail||"keep",O=y.zpass||"keep";return m.commandParameter(T,qr,M+".fail",f.commandStr),m.commandParameter(b,qr,M+".zfail",f.commandStr),m.commandParameter(O,qr,M+".zpass",f.commandStr),[M===Tn?bi:Dn,qr[T],qr[b],qr[O]]},function(y,T,b){var O=y.constants.stencilOps;m.optional(function(){y.assert(T,b+"&&typeof "+b+'==="object"',"invalid "+M)});function D($){return m.optional(function(){y.assert(T,'!("'+$+'" in '+b+")||("+b+"."+$+" in "+O+")","invalid "+M+"."+$+", must be one of "+Object.keys(qr))}),T.def('"',$,'" in ',b,"?",O,"[",b,".",$,"]:",Jr)}return[M===Tn?bi:Dn,D("fail"),D("zfail"),D("zpass")]});case Ya:return C(function(y){m.commandType(y,"object",w,f.commandStr);var T=y.factor|0,b=y.units|0;return m.commandType(T,"number",w+".factor",f.commandStr),m.commandType(b,"number",w+".units",f.commandStr),[T,b]},function(y,T,b){m.optional(function(){y.assert(T,b+"&&typeof "+b+'==="object"',"invalid "+M)});var O=T.def(b,".factor|0"),D=T.def(b,".units|0");return[O,D]});case vc:return C(function(y){var T=0;return y==="front"?T=Dn:y==="back"&&(T=bi),m.command(!!T,w,f.commandStr),T},function(y,T,b){return m.optional(function(){y.assert(T,b+'==="front"||'+b+'==="back"',"invalid cull.face")}),T.def(b,'==="front"?',Dn,":",bi)});case Wa:return C(function(y){return m.command(typeof y=="number"&&y>=k.lineWidthDims[0]&&y<=k.lineWidthDims[1],"invalid line width, must be a positive number between "+k.lineWidthDims[0]+" and "+k.lineWidthDims[1],f.commandStr),y},function(y,T,b){return m.optional(function(){y.assert(T,"typeof "+b+'==="number"&&'+b+">="+k.lineWidthDims[0]+"&&"+b+"<="+k.lineWidthDims[1],"invalid line width")}),b});case Ha:return C(function(y){return m.commandParameter(y,no,w,f.commandStr),no[y]},function(y,T,b){return m.optional(function(){y.assert(T,b+'==="cw"||'+b+'==="ccw"',"invalid frontFace, must be one of cw,ccw")}),T.def(b+'==="cw"?'+Nc+":"+io)});case ja:return C(function(y){return m.command(ve(y)&&y.length===4,"color.mask must be length 4 array",f.commandStr),y.map(function(T){return!!T})},function(y,T,b){return m.optional(function(){y.assert(T,y.shared.isArrayLike+"("+b+")&&"+b+".length===4","invalid color.mask")}),ir(4,function(O){return"!!"+b+"["+O+"]"})});case Xa:return C(function(y){m.command(typeof y=="object"&&y,w,f.commandStr);var T="value"in y?y.value:1,b=!!y.invert;return m.command(typeof T=="number"&&T>=0&&T<=1,"sample.coverage.value must be a number between 0 and 1",f.commandStr),[T,b]},function(y,T,b){m.optional(function(){y.assert(T,b+"&&typeof "+b+'==="object"',"invalid sample.coverage")});var O=T.def('"value" in ',b,"?+",b,".value:1"),D=T.def("!!",b,".invert");return[O,D]})}}),N}function Qt(_,f){var S=_.static,I=_.dynamic,N={};return Object.keys(S).forEach(function(M){var w=S[M],C;if(typeof w=="number"||typeof w=="boolean")C=Re(function(){return w});else if(typeof w=="function"){var y=w._reglType;y==="texture2d"||y==="textureCube"?C=Re(function(T){return T.link(w)}):y==="framebuffer"||y==="framebufferCube"?(m.command(w.color.length>0,'missing color attachment for framebuffer sent to uniform "'+M+'"',f.commandStr),C=Re(function(T){return T.link(w.color[0])})):m.commandRaise('invalid data for uniform "'+M+'"',f.commandStr)}else ve(w)?C=Re(function(T){var b=T.global.def("[",ir(w.length,function(O){return m.command(typeof w[O]=="number"||typeof w[O]=="boolean","invalid uniform "+M,T.commandStr),w[O]}),"]");return b}):m.commandRaise('invalid or missing data for uniform "'+M+'"',f.commandStr);C.value=w,N[M]=C}),Object.keys(I).forEach(function(M){var w=I[M];N[M]=Qe(w,function(C,y){return C.invoke(y,w)})}),N}function Ne(_,f){var S=_.static,I=_.dynamic,N={};return Object.keys(S).forEach(function(M){var w=S[M],C=p.id(M),y=new R;if(ws(w))y.state=Vi,y.buffer=Y.getBuffer(Y.create(w,Wi,!1,!0)),y.type=0;else{var T=Y.getBuffer(w);if(T)y.state=Vi,y.buffer=T,y.type=0;else if(m.command(typeof w=="object"&&w,"invalid data for attribute "+M,f.commandStr),"constant"in w){var b=w.constant;y.buffer="null",y.state=Pa,typeof b=="number"?y.x=b:(m.command(ve(b)&&b.length>0&&b.length<=4,"invalid constant for attribute "+M,f.commandStr),Gi.forEach(function(ot,Ot){Ot<b.length&&(y[ot]=b[Ot])}))}else{ws(w.buffer)?T=Y.getBuffer(Y.create(w.buffer,Wi,!1,!0)):T=Y.getBuffer(w.buffer),m.command(!!T,'missing buffer for attribute "'+M+'"',f.commandStr);var O=w.offset|0;m.command(O>=0,'invalid offset for attribute "'+M+'"',f.commandStr);var D=w.stride|0;m.command(D>=0&&D<256,'invalid stride for attribute "'+M+'", must be integer betweeen [0, 255]',f.commandStr);var $=w.size|0;m.command(!("size"in w)||$>0&&$<=4,'invalid size for attribute "'+M+'", must be 1,2,3,4',f.commandStr);var ct=!!w.normalized,ht=0;"type"in w&&(m.commandParameter(w.type,ui,"invalid type for attribute "+M,f.commandStr),ht=ui[w.type]);var gt=w.divisor|0;m.optional(function(){"divisor"in w&&(m.command(gt===0||rt,'cannot specify divisor for attribute "'+M+'", instancing not supported',f.commandStr),m.command(gt>=0,'invalid divisor for attribute "'+M+'"',f.commandStr));var ot=f.commandStr,Ot=["buffer","offset","divisor","normalized","type","size","stride"];Object.keys(w).forEach(function(Tt){m.command(Ot.indexOf(Tt)>=0,'unknown parameter "'+Tt+'" for attribute pointer "'+M+'" (valid parameters are '+Ot+")",ot)})}),y.buffer=T,y.state=Vi,y.size=$,y.normalized=ct,y.type=ht||T.dtype,y.offset=O,y.stride=D,y.divisor=gt}}N[M]=Re(function(ot,Ot){var Tt=ot.attribCache;if(C in Tt)return Tt[C];var It={isStream:!1};return Object.keys(y).forEach(function(Rt){It[Rt]=y[Rt]}),y.buffer&&(It.buffer=ot.link(y.buffer),It.type=It.type||It.buffer+".dtype"),Tt[C]=It,It})}),Object.keys(I).forEach(function(M){var w=I[M];function C(y,T){var b=y.invoke(T,w),O=y.shared,D=y.constants,$=O.isBufferArgs,ct=O.buffer;m.optional(function(){y.assert(T,b+"&&(typeof "+b+'==="object"||typeof '+b+'==="function")&&('+$+"("+b+")||"+ct+".getBuffer("+b+")||"+ct+".getBuffer("+b+".buffer)||"+$+"("+b+'.buffer)||("constant" in '+b+"&&(typeof "+b+'.constant==="number"||'+O.isArrayLike+"("+b+".constant))))",'invalid dynamic attribute "'+M+'"')});var ht={isStream:T.def(!1)},gt=new R;gt.state=Vi,Object.keys(gt).forEach(function(It){ht[It]=T.def(""+gt[It])});var ot=ht.buffer,Ot=ht.type;T("if(",$,"(",b,")){",ht.isStream,"=true;",ot,"=",ct,".createStream(",Wi,",",b,");",Ot,"=",ot,".dtype;","}else{",ot,"=",ct,".getBuffer(",b,");","if(",ot,"){",Ot,"=",ot,".dtype;",'}else if("constant" in ',b,"){",ht.state,"=",Pa,";","if(typeof "+b+'.constant === "number"){',ht[Gi[0]],"=",b,".constant;",Gi.slice(1).map(function(It){return ht[It]}).join("="),"=0;","}else{",Gi.map(function(It,Rt){return ht[It]+"="+b+".constant.length>"+Rt+"?"+b+".constant["+Rt+"]:0;"}).join(""),"}}else{","if(",$,"(",b,".buffer)){",ot,"=",ct,".createStream(",Wi,",",b,".buffer);","}else{",ot,"=",ct,".getBuffer(",b,".buffer);","}",Ot,'="type" in ',b,"?",D.glTypes,"[",b,".type]:",ot,".dtype;",ht.normalized,"=!!",b,".normalized;");function Tt(It){T(ht[It],"=",b,".",It,"|0;")}return Tt("size"),Tt("offset"),Tt("stride"),Tt("divisor"),T("}}"),T.exit("if(",ht.isStream,"){",ct,".destroyStream(",ot,");","}"),ht}N[M]=Qe(w,C)}),N}function fe(_){var f=_.static,S=_.dynamic,I={};return Object.keys(f).forEach(function(N){var M=f[N];I[N]=Re(function(w,C){return typeof M=="number"||typeof M=="boolean"?""+M:w.link(M)})}),Object.keys(S).forEach(function(N){var M=S[N];I[N]=Qe(M,function(w,C){return w.invoke(C,M)})}),I}function Oe(_,f,S,I,N){var M=_.static,w=_.dynamic;m.optional(function(){var Tt=[yi,wn,Mn,xi,gi,ps,_i,ys,Sn,Cn].concat(Ft);function It(Rt){Object.keys(Rt).forEach(function(Nt){m.command(Tt.indexOf(Nt)>=0,'unknown parameter "'+Nt+'"',N.commandStr)})}It(M),It(w)});var C=Vt(_,f),y=bt(_),T=zt(_,y,N),b=pe(_,N),O=ge(_,N),D=qt(_,N,C);function $(Tt){var It=T[Tt];It&&(O[Tt]=It)}$(Rr),$(Ct(ms));var ct=Object.keys(O).length>0,ht={framebuffer:y,draw:b,shader:D,state:O,dirty:ct,scopeVAO:null,drawVAO:null,useVAO:!1,attributes:{}};if(ht.profile=xt(_),ht.uniforms=Qt(S,N),ht.drawVAO=ht.scopeVAO=b.vao,!ht.drawVAO&&D.program&&!C&&E.angle_instanced_arrays&&b.static.elements){var gt=!0,ot=D.program.attributes.map(function(Tt){var It=f.static[Tt];return gt=gt&&!!It,It});if(gt&&ot.length>0){var Ot=nt.getVAO(nt.createVAO({attributes:ot,elements:b.static.elements}));ht.drawVAO=new Fe(null,null,null,function(Tt,It){return Tt.link(Ot)}),ht.useVAO=!0}}return C?ht.useVAO=!0:ht.attributes=Ne(f,N),ht.context=fe(I),ht}function Le(_,f,S){var I=_.shared,N=I.context,M=_.scope();Object.keys(S).forEach(function(w){f.save(N,"."+w);var C=S[w],y=C.append(_,f);Array.isArray(y)?M(N,".",w,"=[",y.join(),"];"):M(N,".",w,"=",y,";")}),f(M)}function De(_,f,S,I){var N=_.shared,M=N.gl,w=N.framebuffer,C;vt&&(C=f.def(N.extensions,".webgl_draw_buffers"));var y=_.constants,T=y.drawBuffer,b=y.backBuffer,O;S?O=S.append(_,f):O=f.def(w,".next"),I||f("if(",O,"!==",w,".cur){"),f("if(",O,"){",M,".bindFramebuffer(",Pc,",",O,".framebuffer);"),vt&&f(C,".drawBuffersWEBGL(",T,"[",O,".colorAttachments.length]);"),f("}else{",M,".bindFramebuffer(",Pc,",null);"),vt&&f(C,".drawBuffersWEBGL(",b,");"),f("}",w,".cur=",O,";"),I||f("}")}function ke(_,f,S){var I=_.shared,N=I.gl,M=_.current,w=_.next,C=I.current,y=I.next,T=_.cond(C,".dirty");Ft.forEach(function(b){var O=Ct(b);if(!(O in S.state)){var D,$;if(O in w){D=w[O],$=M[O];var ct=ir(_t[O].length,function(gt){return T.def(D,"[",gt,"]")});T(_.cond(ct.map(function(gt,ot){return gt+"!=="+$+"["+ot+"]"}).join("||")).then(N,".",W[O],"(",ct,");",ct.map(function(gt,ot){return $+"["+ot+"]="+gt}).join(";"),";"))}else{D=T.def(y,".",O);var ht=_.cond(D,"!==",C,".",O);T(ht),O in X?ht(_.cond(D).then(N,".enable(",X[O],");").else(N,".disable(",X[O],");"),C,".",O,"=",D,";"):ht(N,".",W[O],"(",D,");",C,".",O,"=",D,";")}}}),Object.keys(S.state).length===0&&T(C,".dirty=false;"),f(T)}function Ve(_,f,S,I){var N=_.shared,M=_.current,w=N.current,C=N.gl;zc(Object.keys(S)).forEach(function(y){var T=S[y];if(!(I&&!I(T))){var b=T.append(_,f);if(X[y]){var O=X[y];Zr(T)?b?f(C,".enable(",O,");"):f(C,".disable(",O,");"):f(_.cond(b).then(C,".enable(",O,");").else(C,".disable(",O,");")),f(w,".",y,"=",b,";")}else if(ve(b)){var D=M[y];f(C,".",W[y],"(",b,");",b.map(function($,ct){return D+"["+ct+"]="+$}).join(";"),";")}else f(C,".",W[y],"(",b,");",w,".",y,"=",b,";")}})}function Ee(_,f){rt&&(_.instancing=f.def(_.shared.extensions,".angle_instanced_arrays"))}function Yt(_,f,S,I,N){var M=_.shared,w=_.stats,C=M.current,y=M.timer,T=S.profile;function b(){return typeof performance>"u"?"Date.now()":"performance.now()"}var O,D;function $(Tt){O=f.def(),Tt(O,"=",b(),";"),typeof N=="string"?Tt(w,".count+=",N,";"):Tt(w,".count++;"),K&&(I?(D=f.def(),Tt(D,"=",y,".getNumPendingQueries();")):Tt(y,".beginQuery(",w,");"))}function ct(Tt){Tt(w,".cpuTime+=",b(),"-",O,";"),K&&(I?Tt(y,".pushScopeStats(",D,",",y,".getNumPendingQueries(),",w,");"):Tt(y,".endQuery();"))}function ht(Tt){var It=f.def(C,".profile");f(C,".profile=",Tt,";"),f.exit(C,".profile=",It,";")}var gt;if(T){if(Zr(T)){T.enable?($(f),ct(f.exit),ht("true")):ht("false");return}gt=T.append(_,f),ht(gt)}else gt=f.def(C,".profile");var ot=_.block();$(ot),f("if(",gt,"){",ot,"}");var Ot=_.block();ct(Ot),f.exit("if(",gt,"){",Ot,"}")}function je(_,f,S,I,N){var M=_.shared;function w(y){switch(y){case xs:case bs:case As:return 2;case gs:case vs:case Ts:return 3;case _s:case Es:case Ss:return 4;default:return 1}}function C(y,T,b){var O=M.gl,D=f.def(y,".location"),$=f.def(M.attributes,"[",D,"]"),ct=b.state,ht=b.buffer,gt=[b.x,b.y,b.z,b.w],ot=["buffer","normalized","offset","stride"];function Ot(){f("if(!",$,".buffer){",O,".enableVertexAttribArray(",D,");}");var It=b.type,Rt;if(b.size?Rt=f.def(b.size,"||",T):Rt=T,f("if(",$,".type!==",It,"||",$,".size!==",Rt,"||",ot.map(function(Ut){return $+"."+Ut+"!=="+b[Ut]}).join("||"),"){",O,".bindBuffer(",Wi,",",ht,".buffer);",O,".vertexAttribPointer(",[D,Rt,It,b.normalized,b.stride,b.offset],");",$,".type=",It,";",$,".size=",Rt,";",ot.map(function(Ut){return $+"."+Ut+"="+b[Ut]+";"}).join(""),"}"),rt){var Nt=b.divisor;f("if(",$,".divisor!==",Nt,"){",_.instancing,".vertexAttribDivisorANGLE(",[D,Nt],");",$,".divisor=",Nt,";}")}}function Tt(){f("if(",$,".buffer){",O,".disableVertexAttribArray(",D,");",$,".buffer=null;","}if(",Gi.map(function(It,Rt){return $+"."+It+"!=="+gt[Rt]}).join("||"),"){",O,".vertexAttrib4f(",D,",",gt,");",Gi.map(function(It,Rt){return $+"."+It+"="+gt[Rt]+";"}).join(""),"}")}ct===Vi?Ot():ct===Pa?Tt():(f("if(",ct,"===",Vi,"){"),Ot(),f("}else{"),Tt(),f("}"))}I.forEach(function(y){var T=y.name,b=S.attributes[T],O;if(b){if(!N(b))return;O=b.append(_,f)}else{if(!N(Uc))return;var D=_.scopeAttrib(T);m.optional(function(){_.assert(f,D+".state","missing attribute "+T)}),O={},Object.keys(new R).forEach(function($){O[$]=f.def(D,".",$)})}C(_.link(y),w(y.info.type),O)})}function oe(_,f,S,I,N,M){for(var w=_.shared,C=w.gl,y,T=0;T<I.length;++T){var b=I[T],O=b.name,D=b.info.type,$=S.uniforms[O],ct=_.link(b),ht=ct+".location",gt;if($){if(!N($))continue;if(Zr($)){var ot=$.value;if(m.command(ot!==null&&typeof ot<"u",'missing uniform "'+O+'"',_.commandStr),D===Nn||D===Ln){m.command(typeof ot=="function"&&(D===Nn&&(ot._reglType==="texture2d"||ot._reglType==="framebuffer")||D===Ln&&(ot._reglType==="textureCube"||ot._reglType==="framebufferCube")),"invalid texture for uniform "+O,_.commandStr);var Ot=_.link(ot._texture||ot.color[0]._texture);f(C,".uniform1i(",ht,",",Ot+".bind());"),f.exit(Ot,".unbind();")}else if(D===In||D===Rn||D===On){m.optional(function(){m.command(ve(ot),"invalid matrix for uniform "+O,_.commandStr),m.command(D===In&&ot.length===4||D===Rn&&ot.length===9||D===On&&ot.length===16,"invalid length for matrix uniform "+O,_.commandStr)});var Tt=_.global.def("new Float32Array(["+Array.prototype.slice.call(ot)+"])"),It=2;D===Rn?It=3:D===On&&(It=4),f(C,".uniformMatrix",It,"fv(",ht,",false,",Tt,");")}else{switch(D){case Qa:m.commandType(ot,"number","uniform "+O,_.commandStr),y="1f";break;case xs:m.command(ve(ot)&&ot.length===2,"uniform "+O,_.commandStr),y="2f";break;case gs:m.command(ve(ot)&&ot.length===3,"uniform "+O,_.commandStr),y="3f";break;case _s:m.command(ve(ot)&&ot.length===4,"uniform "+O,_.commandStr),y="4f";break;case eo:m.commandType(ot,"boolean","uniform "+O,_.commandStr),y="1i";break;case to:m.commandType(ot,"number","uniform "+O,_.commandStr),y="1i";break;case As:m.command(ve(ot)&&ot.length===2,"uniform "+O,_.commandStr),y="2i";break;case bs:m.command(ve(ot)&&ot.length===2,"uniform "+O,_.commandStr),y="2i";break;case Ts:m.command(ve(ot)&&ot.length===3,"uniform "+O,_.commandStr),y="3i";break;case vs:m.command(ve(ot)&&ot.length===3,"uniform "+O,_.commandStr),y="3i";break;case Ss:m.command(ve(ot)&&ot.length===4,"uniform "+O,_.commandStr),y="4i";break;case Es:m.command(ve(ot)&&ot.length===4,"uniform "+O,_.commandStr),y="4i";break}f(C,".uniform",y,"(",ht,",",ve(ot)?Array.prototype.slice.call(ot):ot,");")}continue}else gt=$.append(_,f)}else{if(!N(Uc))continue;gt=f.def(w.uniforms,"[",p.id(O),"]")}D===Nn?(m(!Array.isArray(gt),"must specify a scalar prop for textures"),f("if(",gt,"&&",gt,'._reglType==="framebuffer"){',gt,"=",gt,".color[0];","}")):D===Ln&&(m(!Array.isArray(gt),"must specify a scalar prop for cube maps"),f("if(",gt,"&&",gt,'._reglType==="framebufferCube"){',gt,"=",gt,".color[0];","}")),m.optional(function(){function Xe(pr,Xc){_.assert(f,pr,'bad data or missing for uniform "'+O+'".  '+Xc)}function Sr(pr){m(!Array.isArray(gt),"must not specify an array type for uniform"),Xe("typeof "+gt+'==="'+pr+'"',"invalid type, expected "+pr)}function hr(pr,Xc){Array.isArray(gt)?m(gt.length===pr,"must have length "+pr):Xe(w.isArrayLike+"("+gt+")&&"+gt+".length==="+pr,"invalid vector, should have length "+pr,_.commandStr)}function Yc(pr){m(!Array.isArray(gt),"must not specify a value type"),Xe("typeof "+gt+'==="function"&&'+gt+'._reglType==="texture'+(pr===Oc?"2d":"Cube")+'"',"invalid texture type",_.commandStr)}switch(D){case to:Sr("number");break;case bs:hr(2);break;case vs:hr(3);break;case Es:hr(4);break;case Qa:Sr("number");break;case xs:hr(2);break;case gs:hr(3);break;case _s:hr(4);break;case eo:Sr("boolean");break;case As:hr(2);break;case Ts:hr(3);break;case Ss:hr(4);break;case In:hr(4);break;case Rn:hr(9);break;case On:hr(16);break;case Nn:Yc(Oc);break;case Ln:Yc(tp);break}});var Rt=1;switch(D){case Nn:case Ln:var Nt=f.def(gt,"._texture");f(C,".uniform1i(",ht,",",Nt,".bind());"),f.exit(Nt,".unbind();");continue;case to:case eo:y="1i";break;case bs:case As:y="2i",Rt=2;break;case vs:case Ts:y="3i",Rt=3;break;case Es:case Ss:y="4i",Rt=4;break;case Qa:y="1f";break;case xs:y="2f",Rt=2;break;case gs:y="3f",Rt=3;break;case _s:y="4f",Rt=4;break;case In:y="Matrix2fv";break;case Rn:y="Matrix3fv";break;case On:y="Matrix4fv";break}if(y.charAt(0)==="M"){f(C,".uniform",y,"(",ht,",");var Ut=Math.pow(D-In+2,2),he=_.global.def("new Float32Array(",Ut,")");Array.isArray(gt)?f("false,(",ir(Ut,function(Xe){return he+"["+Xe+"]="+gt[Xe]}),",",he,")"):f("false,(Array.isArray(",gt,")||",gt," instanceof Float32Array)?",gt,":(",ir(Ut,function(Xe){return he+"["+Xe+"]="+gt+"["+Xe+"]"}),",",he,")"),f(");")}else if(Rt>1){for(var ze=[],Or=[],Nr=0;Nr<Rt;++Nr)Array.isArray(gt)?Or.push(gt[Nr]):Or.push(f.def(gt+"["+Nr+"]")),M&&ze.push(f.def());M&&f("if(!",_.batchId,"||",ze.map(function(Xe,Sr){return Xe+"!=="+Or[Sr]}).join("||"),"){",ze.map(function(Xe,Sr){return Xe+"="+Or[Sr]+";"}).join("")),f(C,".uniform",y,"(",ht,",",Or.join(","),");"),M&&f("}")}else{if(m(!Array.isArray(gt),"uniform value must not be an array"),M){var Lr=f.def();f("if(!",_.batchId,"||",Lr,"!==",gt,"){",Lr,"=",gt,";")}f(C,".uniform",y,"(",ht,",",gt,");"),M&&f("}")}}}function Bt(_,f,S,I){var N=_.shared,M=N.gl,w=N.draw,C=I.draw;function y(){var Rt=C.elements,Nt,Ut=f;return Rt?((Rt.contextDep&&I.contextDynamic||Rt.propDep)&&(Ut=S),Nt=Rt.append(_,Ut),C.elementsActive&&Ut("if("+Nt+")"+M+".bindBuffer("+Ka+","+Nt+".buffer.buffer);")):(Nt=Ut.def(),Ut(Nt,"=",w,".",xi,";","if(",Nt,"){",M,".bindBuffer(",Ka,",",Nt,".buffer.buffer);}","else if(",N.vao,".currentVAO){",Nt,"=",_.shared.elements+".getElements("+N.vao,".currentVAO.elements);",J?"":"if("+Nt+")"+M+".bindBuffer("+Ka+","+Nt+".buffer.buffer);","}")),Nt}function T(){var Rt=C.count,Nt,Ut=f;return Rt?((Rt.contextDep&&I.contextDynamic||Rt.propDep)&&(Ut=S),Nt=Rt.append(_,Ut),m.optional(function(){Rt.MISSING&&_.assert(f,"false","missing vertex count"),Rt.DYNAMIC&&_.assert(Ut,Nt+">=0","missing vertex count")})):(Nt=Ut.def(w,".",_i),m.optional(function(){_.assert(Ut,Nt+">=0","missing vertex count")})),Nt}var b=y();function O(Rt){var Nt=C[Rt];return Nt?Nt.contextDep&&I.contextDynamic||Nt.propDep?Nt.append(_,S):Nt.append(_,f):f.def(w,".",Rt)}var D=O(gi),$=O(ps),ct=T();if(typeof ct=="number"){if(ct===0)return}else S("if(",ct,"){"),S.exit("}");var ht,gt;rt&&(ht=O(ys),gt=_.instancing);var ot=b+".type",Ot=C.elements&&Zr(C.elements)&&!C.vaoActive;function Tt(){function Rt(){S(gt,".drawElementsInstancedANGLE(",[D,ct,ot,$+"<<(("+ot+"-"+hc+")>>1)",ht],");")}function Nt(){S(gt,".drawArraysInstancedANGLE(",[D,$,ct,ht],");")}b&&b!=="null"?Ot?Rt():(S("if(",b,"){"),Rt(),S("}else{"),Nt(),S("}")):Nt()}function It(){function Rt(){S(M+".drawElements("+[D,ct,ot,$+"<<(("+ot+"-"+hc+")>>1)"]+");")}function Nt(){S(M+".drawArrays("+[D,$,ct]+");")}b&&b!=="null"?Ot?Rt():(S("if(",b,"){"),Rt(),S("}else{"),Nt(),S("}")):Nt()}rt&&(typeof ht!="number"||ht>=0)?typeof ht=="string"?(S("if(",ht,">0){"),Tt(),S("}else if(",ht,"<0){"),It(),S("}")):Tt():It()}function Zt(_,f,S,I,N){var M=Gt(),w=M.proc("body",N);return m.optional(function(){M.commandStr=f.commandStr,M.command=M.link(f.commandStr)}),rt&&(M.instancing=w.def(M.shared.extensions,".angle_instanced_arrays")),_(M,w,S,I),M.compile().body}function ne(_,f,S,I){Ee(_,f),S.useVAO?S.drawVAO?f(_.shared.vao,".setVAO(",S.drawVAO.append(_,f),");"):f(_.shared.vao,".setVAO(",_.shared.vao,".targetVAO);"):(f(_.shared.vao,".setVAO(null);"),je(_,f,S,I.attributes,function(){return!0})),oe(_,f,S,I.uniforms,function(){return!0},!1),Bt(_,f,f,S)}function Ae(_,f){var S=_.proc("draw",1);Ee(_,S),Le(_,S,f.context),De(_,S,f.framebuffer),ke(_,S,f),Ve(_,S,f.state),Yt(_,S,f,!1,!0);var I=f.shader.progVar.append(_,S);if(S(_.shared.gl,".useProgram(",I,".program);"),f.shader.program)ne(_,S,f,f.shader.program);else{S(_.shared.vao,".setVAO(null);");var N=_.global.def("{}"),M=S.def(I,".id"),w=S.def(N,"[",M,"]");S(_.cond(w).then(w,".call(this,a0);").else(w,"=",N,"[",M,"]=",_.link(function(C){return Zt(ne,_,f,C,1)}),"(",I,");",w,".call(this,a0);"))}Object.keys(f.state).length>0&&S(_.shared.current,".dirty=true;"),_.shared.vao&&S(_.shared.vao,".setVAO(null);")}function Tr(_,f,S,I){_.batchId="a1",Ee(_,f);function N(){return!0}je(_,f,S,I.attributes,N),oe(_,f,S,I.uniforms,N,!1),Bt(_,f,f,S)}function vi(_,f,S,I){Ee(_,f);var N=S.contextDep,M=f.def(),w="a0",C="a1",y=f.def();_.shared.props=y,_.batchId=M;var T=_.scope(),b=_.scope();f(T.entry,"for(",M,"=0;",M,"<",C,";++",M,"){",y,"=",w,"[",M,"];",b,"}",T.exit);function O(ot){return ot.contextDep&&N||ot.propDep}function D(ot){return!O(ot)}if(S.needsContext&&Le(_,b,S.context),S.needsFramebuffer&&De(_,b,S.framebuffer),Ve(_,b,S.state,O),S.profile&&O(S.profile)&&Yt(_,b,S,!1,!0),I)S.useVAO?S.drawVAO?O(S.drawVAO)?b(_.shared.vao,".setVAO(",S.drawVAO.append(_,b),");"):T(_.shared.vao,".setVAO(",S.drawVAO.append(_,T),");"):T(_.shared.vao,".setVAO(",_.shared.vao,".targetVAO);"):(T(_.shared.vao,".setVAO(null);"),je(_,T,S,I.attributes,D),je(_,b,S,I.attributes,O)),oe(_,T,S,I.uniforms,D,!1),oe(_,b,S,I.uniforms,O,!0),Bt(_,T,b,S);else{var $=_.global.def("{}"),ct=S.shader.progVar.append(_,b),ht=b.def(ct,".id"),gt=b.def($,"[",ht,"]");b(_.shared.gl,".useProgram(",ct,".program);","if(!",gt,"){",gt,"=",$,"[",ht,"]=",_.link(function(ot){return Zt(Tr,_,S,ot,2)}),"(",ct,");}",gt,".call(this,a0[",M,"],",M,");")}}function v(_,f){var S=_.proc("batch",2);_.batchId="0",Ee(_,S);var I=!1,N=!0;Object.keys(f.context).forEach(function($){I=I||f.context[$].propDep}),I||(Le(_,S,f.context),N=!1);var M=f.framebuffer,w=!1;M?(M.propDep?I=w=!0:M.contextDep&&I&&(w=!0),w||De(_,S,M)):De(_,S,null),f.state.viewport&&f.state.viewport.propDep&&(I=!0);function C($){return $.contextDep&&I||$.propDep}ke(_,S,f),Ve(_,S,f.state,function($){return!C($)}),(!f.profile||!C(f.profile))&&Yt(_,S,f,!1,"a1"),f.contextDep=I,f.needsContext=N,f.needsFramebuffer=w;var y=f.shader.progVar;if(y.contextDep&&I||y.propDep)vi(_,S,f,null);else{var T=y.append(_,S);if(S(_.shared.gl,".useProgram(",T,".program);"),f.shader.program)vi(_,S,f,f.shader.program);else{S(_.shared.vao,".setVAO(null);");var b=_.global.def("{}"),O=S.def(T,".id"),D=S.def(b,"[",O,"]");S(_.cond(D).then(D,".call(this,a0,a1);").else(D,"=",b,"[",O,"]=",_.link(function($){return Zt(vi,_,f,$,2)}),"(",T,");",D,".call(this,a0,a1);"))}}Object.keys(f.state).length>0&&S(_.shared.current,".dirty=true;"),_.shared.vao&&S(_.shared.vao,".setVAO(null);")}function z(_,f){var S=_.proc("scope",3);_.batchId="a2";var I=_.shared,N=I.current;Le(_,S,f.context),f.framebuffer&&f.framebuffer.append(_,S),zc(Object.keys(f.state)).forEach(function(w){var C=f.state[w],y=C.append(_,S);ve(y)?y.forEach(function(T,b){S.set(_.next[w],"["+b+"]",T)}):S.set(I.next,"."+w,y)}),Yt(_,S,f,!0,!0),[xi,ps,_i,ys,gi].forEach(function(w){var C=f.draw[w];C&&S.set(I.draw,"."+w,""+C.append(_,S))}),Object.keys(f.uniforms).forEach(function(w){var C=f.uniforms[w].append(_,S);Array.isArray(C)&&(C="["+C.join()+"]"),S.set(I.uniforms,"["+p.id(w)+"]",C)}),Object.keys(f.attributes).forEach(function(w){var C=f.attributes[w].append(_,S),y=_.scopeAttrib(w);Object.keys(new R).forEach(function(T){S.set(y,"."+T,C[T])})}),f.scopeVAO&&S.set(I.vao,".targetVAO",f.scopeVAO.append(_,S));function M(w){var C=f.shader[w];C&&S.set(I.shader,"."+w,C.append(_,S))}M(wn),M(Mn),Object.keys(f.state).length>0&&(S(N,".dirty=true;"),S.exit(N,".dirty=true;")),S("a1(",_.shared.context,",a0,",_.batchId,");")}function F(_){if(!(typeof _!="object"||ve(_))){for(var f=Object.keys(_),S=0;S<f.length;++S)if(rr.isDynamic(_[f[S]]))return!0;return!1}}function Mt(_,f,S){var I=f.static[S];if(!I||!F(I))return;var N=_.global,M=Object.keys(I),w=!1,C=!1,y=!1,T=_.global.def("{}");M.forEach(function(O){var D=I[O];if(rr.isDynamic(D)){typeof D=="function"&&(D=I[O]=rr.unbox(D));var $=Qe(D,null);w=w||$.thisDep,y=y||$.propDep,C=C||$.contextDep}else{switch(N(T,".",O,"="),typeof D){case"number":N(D);break;case"string":N('"',D,'"');break;case"object":Array.isArray(D)&&N("[",D.join(),"]");break;default:N(_.link(D));break}N(";")}});function b(O,D){M.forEach(function($){var ct=I[$];if(rr.isDynamic(ct)){var ht=O.invoke(D,ct);D(T,".",$,"=",ht,";")}})}f.dynamic[S]=new rr.DynamicVariable(ds,{thisDep:w,contextDep:C,propDep:y,ref:T,append:b}),delete f.static[S]}function Jt(_,f,S,I,N){var M=Gt();M.stats=M.link(N),Object.keys(f.static).forEach(function(C){Mt(M,f,C)}),Zm.forEach(function(C){Mt(M,_,C)});var w=Oe(_,f,S,I,M);return Ae(M,w),z(M,w),v(M,w),r(M.compile(),{destroy:function(){w.shader.program.destroy()}})}return{next:yt,current:_t,procs:(function(){var _=Gt(),f=_.proc("poll"),S=_.proc("refresh"),I=_.block();f(I),S(I);var N=_.shared,M=N.gl,w=N.next,C=N.current;I(C,".dirty=false;"),De(_,f),De(_,S,null,!0);var y;rt&&(y=_.link(rt)),E.oes_vertex_array_object&&S(_.link(E.oes_vertex_array_object),".bindVertexArrayOES(null);");for(var T=0;T<k.maxAttributes;++T){var b=S.def(N.attributes,"[",T,"]"),O=_.cond(b,".buffer");O.then(M,".enableVertexAttribArray(",T,");",M,".bindBuffer(",Wi,",",b,".buffer.buffer);",M,".vertexAttribPointer(",T,",",b,".size,",b,".type,",b,".normalized,",b,".stride,",b,".offset);").else(M,".disableVertexAttribArray(",T,");",M,".vertexAttrib4f(",T,",",b,".x,",b,".y,",b,".z,",b,".w);",b,".buffer=null;"),S(O),rt&&S(y,".vertexAttribDivisorANGLE(",T,",",b,".divisor);")}return S(_.shared.vao,".currentVAO=null;",_.shared.vao,".setVAO(",_.shared.vao,".targetVAO);"),Object.keys(X).forEach(function(D){var $=X[D],ct=I.def(w,".",D),ht=_.block();ht("if(",ct,"){",M,".enable(",$,")}else{",M,".disable(",$,")}",C,".",D,"=",ct,";"),S(ht),f("if(",ct,"!==",C,".",D,"){",ht,"}")}),Object.keys(W).forEach(function(D){var $=W[D],ct=_t[D],ht,gt,ot=_.block();if(ot(M,".",$,"("),ve(ct)){var Ot=ct.length;ht=_.global.def(w,".",D),gt=_.global.def(C,".",D),ot(ir(Ot,function(Tt){return ht+"["+Tt+"]"}),");",ir(Ot,function(Tt){return gt+"["+Tt+"]="+ht+"["+Tt+"];"}).join("")),f("if(",ir(Ot,function(Tt){return ht+"["+Tt+"]!=="+gt+"["+Tt+"]"}).join("||"),"){",ot,"}")}else ht=I.def(w,".",D),gt=I.def(C,".",D),ot(ht,");",C,".",D,"=",ht,";"),f("if(",ht,"!==",gt,"){",ot,"}");S(ot)}),_.compile()})(),compile:Jt}}function yp(){return{vaoCount:0,bufferCount:0,elementsCount:0,framebufferCount:0,shaderCount:0,textureCount:0,cubeCount:0,renderbufferCount:0,maxTextureUnits:0}}var xp=34918,gp=34919,Gc=35007,_p=function(l,p){if(!p.ext_disjoint_timer_query)return null;var E=[];function k(){return E.pop()||p.ext_disjoint_timer_query.createQueryEXT()}function Y(rt){E.push(rt)}var B=[];function j(rt){var vt=k();p.ext_disjoint_timer_query.beginQueryEXT(Gc,vt),B.push(vt),K(B.length-1,B.length,rt)}function Z(){p.ext_disjoint_timer_query.endQueryEXT(Gc)}function q(){this.startQueryIndex=-1,this.endQueryIndex=-1,this.sum=0,this.stats=null}var nt=[];function at(){return nt.pop()||new q}function st(rt){nt.push(rt)}var ut=[];function K(rt,vt,J){var _t=at();_t.startQueryIndex=rt,_t.endQueryIndex=vt,_t.sum=0,_t.stats=J,ut.push(_t)}var it=[],R=[];function G(){var rt,vt,J=B.length;if(J!==0){R.length=Math.max(R.length,J+1),it.length=Math.max(it.length,J+1),it[0]=0,R[0]=0;var _t=0;for(rt=0,vt=0;vt<B.length;++vt){var yt=B[vt];p.ext_disjoint_timer_query.getQueryObjectEXT(yt,gp)?(_t+=p.ext_disjoint_timer_query.getQueryObjectEXT(yt,xp),Y(yt)):B[rt++]=yt,it[vt+1]=_t,R[vt+1]=rt}for(B.length=rt,rt=0,vt=0;vt<ut.length;++vt){var Ft=ut[vt],X=Ft.startQueryIndex,W=Ft.endQueryIndex;Ft.sum+=it[W]-it[X];var Ct=R[X],ft=R[W];ft===Ct?(Ft.stats.gpuTime+=Ft.sum/1e6,st(Ft)):(Ft.startQueryIndex=Ct,Ft.endQueryIndex=ft,ut[rt++]=Ft)}ut.length=rt}}return{beginQuery:j,endQuery:Z,pushScopeStats:K,update:G,getNumPendingQueries:function(){return B.length},clear:function(){E.push.apply(E,B);for(var rt=0;rt<E.length;rt++)p.ext_disjoint_timer_query.deleteQueryEXT(E[rt]);B.length=0,E.length=0},restore:function(){B.length=0,E.length=0}}},bp=16384,vp=256,Ep=1024,Ap=34962,Vc="webglcontextlost",jc="webglcontextrestored",Hc=1,Tp=2,Sp=3;function Wc(l,p){for(var E=0;E<l.length;++E)if(l[E]===p)return E;return-1}function wp(l){var p=Tf(l);if(!p)return null;var E=p.gl,k=E.getContextAttributes(),Y=E.isContextLost(),B=Sf(E,p);if(!B)return null;var j=_f(),Z=yp(),q=B.extensions,nt=_p(E,q),at=Qo(),st=E.drawingBufferWidth,ut=E.drawingBufferHeight,K={tick:0,time:0,viewportWidth:st,viewportHeight:ut,framebufferWidth:st,framebufferHeight:ut,drawingBufferWidth:st,drawingBufferHeight:ut,pixelRatio:p.pixelRatio},it={},R={elements:null,primitive:4,count:-1,offset:0,instances:-1},G=fd(E,q),rt=Cd(E,Z,p,_t),vt=Ud(E,q,rt,Z),J=Um(E,q,G,Z,rt,vt,R);function _t(Bt){return J.destroyBuffer(Bt)}var yt=Hm(E,j,Z,p),Ft=xm(E,q,G,function(){Ct.procs.poll()},K,Z,p),X=gm(E,q,G,Z,p),W=km(E,q,G,Ft,X,Z),Ct=pp(E,j,q,G,rt,vt,Ft,W,it,J,yt,R,K,nt,p),ft=Xm(E,W,Ct.procs.poll,K,k,q,G),et=Ct.next,dt=E.canvas,mt=[],Ht=[],Gt=[],xt=[p.onDestroy],bt=null;function zt(){if(mt.length===0){nt&&nt.update(),bt=null;return}bt=la.next(zt),Ve();for(var Bt=mt.length-1;Bt>=0;--Bt){var Zt=mt[Bt];Zt&&Zt(K,null,0)}E.flush(),nt&&nt.update()}function Vt(){!bt&&mt.length>0&&(bt=la.next(zt))}function qt(){bt&&(la.cancel(zt),bt=null)}function pe(Bt){Bt.preventDefault(),Y=!0,qt(),Ht.forEach(function(Zt){Zt()})}function ge(Bt){E.getError(),Y=!1,B.restore(),yt.restore(),rt.restore(),Ft.restore(),X.restore(),W.restore(),J.restore(),nt&&nt.restore(),Ct.procs.refresh(),Vt(),Gt.forEach(function(Zt){Zt()})}dt&&(dt.addEventListener(Vc,pe,!1),dt.addEventListener(jc,ge,!1));function Qt(){mt.length=0,qt(),dt&&(dt.removeEventListener(Vc,pe),dt.removeEventListener(jc,ge)),yt.clear(),W.clear(),X.clear(),J.clear(),Ft.clear(),vt.clear(),rt.clear(),nt&&nt.clear(),xt.forEach(function(Bt){Bt()})}function Ne(Bt){m(!!Bt,"invalid args to regl({...})"),m.type(Bt,"object","invalid args to regl({...})");function Zt(N){var M=r({},N);delete M.uniforms,delete M.attributes,delete M.context,delete M.vao,"stencil"in M&&M.stencil.op&&(M.stencil.opBack=M.stencil.opFront=M.stencil.op,delete M.stencil.op);function w(C){if(C in M){var y=M[C];delete M[C],Object.keys(y).forEach(function(T){M[C+"."+T]=y[T]})}}return w("blend"),w("depth"),w("cull"),w("stencil"),w("polygonOffset"),w("scissor"),w("sample"),"vao"in N&&(M.vao=N.vao),M}function ne(N,M){var w={},C={};return Object.keys(N).forEach(function(y){var T=N[y];if(rr.isDynamic(T)){C[y]=rr.unbox(T,y);return}else if(M&&Array.isArray(T)){for(var b=0;b<T.length;++b)if(rr.isDynamic(T[b])){C[y]=rr.unbox(T,y);return}}w[y]=T}),{dynamic:C,static:w}}var Ae=ne(Bt.context||{},!0),Tr=ne(Bt.uniforms||{},!0),vi=ne(Bt.attributes||{},!1),v=ne(Zt(Bt),!1),z={gpuTime:0,cpuTime:0,count:0},F=Ct.compile(v,vi,Tr,Ae,z),Mt=F.draw,Jt=F.batch,_=F.scope,f=[];function S(N){for(;f.length<N;)f.push(null);return f}function I(N,M){var w;if(Y&&m.raise("context lost"),typeof N=="function")return _.call(this,null,N,0);if(typeof M=="function")if(typeof N=="number")for(w=0;w<N;++w)_.call(this,null,M,w);else if(Array.isArray(N))for(w=0;w<N.length;++w)_.call(this,N[w],M,w);else return _.call(this,N,M,0);else if(typeof N=="number"){if(N>0)return Jt.call(this,S(N|0),N|0)}else if(Array.isArray(N)){if(N.length)return Jt.call(this,N,N.length)}else return Mt.call(this,N)}return r(I,{stats:z,destroy:function(){F.destroy()}})}var fe=W.setFBO=Ne({framebuffer:rr.define.call(null,Hc,"framebuffer")});function Oe(Bt,Zt){var ne=0;Ct.procs.poll();var Ae=Zt.color;Ae&&(E.clearColor(+Ae[0]||0,+Ae[1]||0,+Ae[2]||0,+Ae[3]||0),ne|=bp),"depth"in Zt&&(E.clearDepth(+Zt.depth),ne|=vp),"stencil"in Zt&&(E.clearStencil(Zt.stencil|0),ne|=Ep),m(!!ne,"called regl.clear with no buffer specified"),E.clear(ne)}function Le(Bt){if(m(typeof Bt=="object"&&Bt,"regl.clear() takes an object as input"),"framebuffer"in Bt)if(Bt.framebuffer&&Bt.framebuffer_reglType==="framebufferCube")for(var Zt=0;Zt<6;++Zt)fe(r({framebuffer:Bt.framebuffer.faces[Zt]},Bt),Oe);else fe(Bt,Oe);else Oe(null,Bt)}function De(Bt){m.type(Bt,"function","regl.frame() callback must be a function"),mt.push(Bt);function Zt(){var ne=Wc(mt,Bt);m(ne>=0,"cannot cancel a frame twice");function Ae(){var Tr=Wc(mt,Ae);mt[Tr]=mt[mt.length-1],mt.length-=1,mt.length<=0&&qt()}mt[ne]=Ae}return Vt(),{cancel:Zt}}function ke(){var Bt=et.viewport,Zt=et.scissor_box;Bt[0]=Bt[1]=Zt[0]=Zt[1]=0,K.viewportWidth=K.framebufferWidth=K.drawingBufferWidth=Bt[2]=Zt[2]=E.drawingBufferWidth,K.viewportHeight=K.framebufferHeight=K.drawingBufferHeight=Bt[3]=Zt[3]=E.drawingBufferHeight}function Ve(){K.tick+=1,K.time=Yt(),ke(),Ct.procs.poll()}function Ee(){Ft.refresh(),ke(),Ct.procs.refresh(),nt&&nt.update()}function Yt(){return(Qo()-at)/1e3}Ee();function je(Bt,Zt){m.type(Zt,"function","listener callback must be a function");var ne;switch(Bt){case"frame":return De(Zt);case"lost":ne=Ht;break;case"restore":ne=Gt;break;case"destroy":ne=xt;break;default:m.raise("invalid event, must be one of frame,lost,restore,destroy")}return ne.push(Zt),{cancel:function(){for(var Ae=0;Ae<ne.length;++Ae)if(ne[Ae]===Zt){ne[Ae]=ne[ne.length-1],ne.pop();return}}}}var oe=r(Ne,{clear:Le,prop:rr.define.bind(null,Hc),context:rr.define.bind(null,Tp),this:rr.define.bind(null,Sp),draw:Ne({}),buffer:function(Bt){return rt.create(Bt,Ap,!1,!1)},elements:function(Bt){return vt.create(Bt,!1)},texture:Ft.create2D,cube:Ft.createCube,renderbuffer:X.create,framebuffer:W.create,framebufferCube:W.createCube,vao:J.createVAO,attributes:k,frame:De,on:je,limits:G,hasExtension:function(Bt){return G.extensions.indexOf(Bt.toLowerCase())>=0},read:ft,destroy:Qt,_gl:E,_refresh:Ee,poll:function(){Ve(),nt&&nt.update()},now:Yt,stats:Z});return p.onDone(null,oe),oe}return wp}))})(Qs)),Qs.exports}var wx=Sx();const Mx=Ip(wx),Cx=({audioFeatures:n})=>{const t=te.useRef(null),e=te.useRef(null),r=te.useRef(null),i=te.useRef(null),[s,a]=te.useState(0),o=te.useRef(s);te.useEffect(()=>{if(t.current){const h=Mx(t.current);e.current=h;const u=h.buffer({usage:"dynamic"});i.current=u,r.current=h({vert:`
          precision mediump float;
          attribute vec2 position;
          void main() {
            // Position is already in clip space coordinates
            gl_Position = vec4(position, 0, 1);
          }`,frag:`
          precision mediump float;
          uniform vec4 color;
          void main() {
            gl_FragColor = color;
          }`,attributes:{position:u},uniforms:{color:[0,.8,.8,.7]},count:h.prop("count"),primitive:"line strip"});const d=h.frame(()=>{var g;h.clear({color:[0,0,0,0],depth:1});const x=o.current;x>0&&((g=r.current)==null||g.call(r,{count:x}))});return()=>{d.cancel(),h.destroy()}}},[]),te.useEffect(()=>{if(n!=null&&n.frameAnalyses&&n.frameAnalyses.length>0){const h=n.frameAnalyses,u=n.duration,d=h.flatMap(x=>{const g=x.timestamp/u*2-1,A=(x.energy*2-1)*.5;return[g,A]});if(i.current){i.current(d);const x=d.length/2;o.current=x,a(x)}}else a(0)},[n]);const c={position:"absolute",top:0,left:0,width:"100%",height:"100%",pointerEvents:"none",zIndex:30};return te.useEffect(()=>{const h=()=>{t.current&&(t.current.width=t.current.clientWidth,t.current.height=t.current.clientHeight)};return h(),window.addEventListener("resize",h),()=>window.removeEventListener("resize",h)},[]),U.jsx("canvas",{ref:t,style:c})};var Hu={};function Ix(n,t){if(!t)throw new Error(`Missing required environment variable: ${n}. Please check your .env file.`);return t}function Rx(n,t,e=!1){return t?t.toLowerCase()==="true":e}function ai(n){try{if(typeof process<"u"&&Hu){const t=Hu[n];if(typeof t<"u"&&t!==null&&t!=="")return String(t)}}catch{}try{const t=globalThis.__import_meta_env__;if(t&&typeof t[n]<"u"&&t[n]!==null&&t[n]!=="")return String(t[n])}catch{}}const Ox={development:{NODE_ENV:"development",VITE_BACKEND_URL:"http://localhost:8000",VITE_DEV_PORT:"5173",VITE_PROD_URL:"http://localhost:5173",VITE_DEBUG:"true"},production:{NODE_ENV:"production",VITE_BACKEND_URL:ai("VITE_BACKEND_URL")||"https://your-production-backend.com",VITE_DEV_PORT:"5173",VITE_PROD_URL:ai("VITE_PROD_URL")||"https://your-production-frontend.com",VITE_DEBUG:"false"},test:{NODE_ENV:"test",VITE_BACKEND_URL:"http://localhost:8000",VITE_DEV_PORT:"5173",VITE_PROD_URL:"http://localhost:5173",VITE_DEBUG:"false"}};function Nx(){const t=ai("NODE_ENV")||ai("MODE")||"development";return["development","production","test"].includes(t)?t:(console.warn(`Unknown environment "${t}", defaulting to development`),"development")}function Lx(){const n=Nx(),t=Ox[n];return{NODE_ENV:n,VITE_BACKEND_URL:Ix("VITE_BACKEND_URL",ai("VITE_BACKEND_URL")||t.VITE_BACKEND_URL),VITE_DEV_PORT:ai("VITE_DEV_PORT")||t.VITE_DEV_PORT,VITE_PROD_URL:ai("VITE_PROD_URL")||t.VITE_PROD_URL,VITE_DEBUG:ai("VITE_DEBUG")||t.VITE_DEBUG}}const wi=Lx(),ff=()=>wi.NODE_ENV==="development",df=()=>Rx("VITE_DEBUG",wi.VITE_DEBUG,!1);ff()&&df()&&console.log("[Environment Config]",{environment:wi.NODE_ENV,backendUrl:wi.VITE_BACKEND_URL,devPort:wi.VITE_DEV_PORT,prodUrl:wi.VITE_PROD_URL,debug:wi.VITE_DEBUG});const wr={curlStrength:.12,noiseScale:2,noiseSpeed:.12},Fo="audiorailrider:dev:curlParams",Po="audiorailrider:dev:visible",Dx=()=>{if(!ff()||!df())return null;const t=(()=>{try{const Q=localStorage.getItem(Fo);if(Q)return JSON.parse(Q)}catch{}return wr})(),[e,r]=te.useState(t.curlStrength??wr.curlStrength),[i,s]=te.useState(t.noiseScale??wr.noiseScale),[a,o]=te.useState(t.noiseSpeed??wr.noiseSpeed),[c,h]=te.useState(()=>{try{return localStorage.getItem(Po)==="1"}catch{return!0}}),[u,d]=te.useState(null),[x,g]=te.useState({}),[A,P]=te.useState({}),{addToast:H}=(()=>{try{return Op()}catch{return{addToast:St=>{}}}})(),V="audiorailrider:dev:presets",At="audiorailrider:dev:trackSettings",tt={placeUnderCamera:!0,verticalOffset:.55,defaultOpacity:.92,insideOpacity:.28,opacityLerpSpeed:6,trackRadius:.35},wt=(()=>{try{const Q=localStorage.getItem(At);if(Q)return JSON.parse(Q)}catch{}return tt})(),[Et,Lt]=te.useState(wt.placeUnderCamera??tt.placeUnderCamera),[Dt,Wt]=te.useState(wt.verticalOffset??tt.verticalOffset),[se,ce]=te.useState(wt.defaultOpacity??tt.defaultOpacity),[kt,jt]=te.useState(wt.insideOpacity??tt.insideOpacity),[ee,Xt]=te.useState(wt.opacityLerpSpeed??tt.opacityLerpSpeed),[$t,de]=te.useState(wt.trackRadius??tt.trackRadius),[me,Kt]=te.useState(!1),[re,ye]=te.useState(()=>{try{return JSON.parse(localStorage.getItem(V)||"[]")}catch{return[]}});te.useEffect(()=>{(()=>{window.dispatchEvent(new CustomEvent("audiorailrider:dev:setCurlParams",{detail:{curlStrength:e,noiseScale:i,noiseSpeed:a}}))})();const St=pt=>{if(pt.ctrlKey&&pt.shiftKey&&pt.key.toLowerCase()==="d"&&h(Pt=>{const Ce=!Pt;try{localStorage.setItem(Po,Ce?"1":"0")}catch{}return Ce}),pt.key==="Escape"){h(!1);try{localStorage.setItem(Po,"0")}catch{}}};return window.addEventListener("keydown",St),()=>window.removeEventListener("keydown",St)},[]),te.useEffect(()=>{const Q={placeUnderCamera:Et,verticalOffset:Dt,defaultOpacity:se,insideOpacity:kt,opacityLerpSpeed:ee,trackRadius:$t};try{localStorage.setItem(At,JSON.stringify(Q))}catch{}window.dispatchEvent(new CustomEvent("audiorailrider:dev:setTrackSettings",{detail:Q}))},[Et,Dt,se,kt,ee,$t]),te.useEffect(()=>{window.dispatchEvent(new CustomEvent("audiorailrider:dev:forceTrackInside",{detail:{force:me}}))},[me]),te.useEffect(()=>{const Q={curlStrength:e,noiseScale:i,noiseSpeed:a};try{localStorage.setItem(Fo,JSON.stringify(Q))}catch{}window.dispatchEvent(new CustomEvent("audiorailrider:dev:setCurlParams",{detail:Q}))},[e,i,a]);let ie=window.__audiorailrider_uniforms_manifest_promise||null;ie||(ie=(async()=>{try{const Q=await fetch("/shaders/shader-uniforms.json");return Q.ok?await Q.json():null}catch{return null}})(),window.__audiorailrider_uniforms_manifest_promise=ie),te.useEffect(()=>{let Q=!0;return(async()=>{const St=await ie;if(!Q||!St)return;d(St);const pt={};for(const Ce of Object.keys(St))for(const m of St[Ce])pt[m.name]=m;P(pt);const Pt={};for(const Ce of Object.keys(St))for(const m of St[Ce])m.default!==void 0?Pt[m.name]=m.default:m.control==="checkbox"?Pt[m.name]=!!m.default:m.min!==void 0?Pt[m.name]=m.min:Pt[m.name]=typeof m.default<"u"?m.default:0;g(Pt)})(),()=>{Q=!1}},[]);const xe=()=>{r(wr.curlStrength),s(wr.noiseScale),o(wr.noiseSpeed);try{localStorage.removeItem(Fo)}catch{}},_e=async()=>{try{const Q=await fetch("/shaders/shader-uniforms.json");if(!Q.ok)return;const St=await Q.json();console.log("Loaded shader manifest",St),d(St),window.dispatchEvent(new CustomEvent("audiorailrider:dev:loadUniformsManifest",{detail:{manifest:St}}))}catch(Q){console.error(Q)}},Ye=()=>{window.dispatchEvent(new CustomEvent("audiorailrider:dev:applyUniform",{detail:{name:"curlStrength",value:wr.curlStrength}})),window.dispatchEvent(new CustomEvent("audiorailrider:dev:applyUniform",{detail:{name:"noiseScale",value:wr.noiseScale}})),window.dispatchEvent(new CustomEvent("audiorailrider:dev:applyUniform",{detail:{name:"noiseSpeed",value:wr.noiseSpeed}}))},Be=(Q,St)=>{g(pt=>({...pt,[Q]:St})),window.dispatchEvent(new CustomEvent("audiorailrider:dev:applyUniform",{detail:{name:Q,value:St}}))},Ue=Q=>{try{return btoa(unescape(encodeURIComponent(JSON.stringify(Q)))).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}catch{return""}},Me=Q=>{try{for(Q=Q.replace(/-/g,"+").replace(/_/g,"/");Q.length%4;)Q+="=";return JSON.parse(decodeURIComponent(escape(atob(Q))))}catch{return null}},be=(Q,St)=>{const pt=A[Q];return pt&&typeof St=="number"&&typeof pt.min=="number"&&typeof pt.max=="number"?Math.min(pt.max,Math.max(pt.min,St)):St},qe=(Q,St)=>{const pt=A[Q];if(!pt)return St;if(pt.control==="checkbox")return!!St;if(pt.control==="select"&&Array.isArray(pt.options))return pt.options.includes(St)?St:pt.options[0];if(pt.control==="color")return typeof St=="string"&&/^#([0-9A-Fa-f]{6}|[0-9A-Fa-f]{3})$/.test(St)?St:pt.default??"#000000";if((pt.control==="range"||pt.control==="number")&&(typeof St=="number"||typeof St=="string"&&!isNaN(Number(St)))){const Pt=typeof St=="number"?St:Number(St);return typeof pt.min=="number"&&typeof pt.max=="number"?Math.min(pt.max,Math.max(pt.min,Pt)):Pt}return St},Cr=(Q,St="preset.json")=>{const pt=new Blob([JSON.stringify(Q,null,2)],{type:"application/json"}),Pt=URL.createObjectURL(pt),Ce=document.createElement("a");Ce.href=Pt,Ce.download=St,document.body.appendChild(Ce),Ce.click(),Ce.remove(),URL.revokeObjectURL(Pt)},or=async Q=>{if(navigator.clipboard&&navigator.clipboard.writeText)try{return await navigator.clipboard.writeText(Q),!0}catch{}try{return document.execCommand("copy"),!0}catch{return!1}},Hr=Q=>{const St={};for(const Pt of Object.keys(x))St[Pt]=x[Pt];St.curlStrength=e,St.noiseScale=i,St.noiseSpeed=a,St.placeUnderCamera=Et,St.verticalOffset=Dt,St.trackDefaultOpacity=se,St.trackInsideOpacity=kt,St.trackOpacityLerpSpeed=ee,St.trackRadius=$t;const pt=[...re,{name:Q,data:St}];ye(pt);try{localStorage.setItem(V,JSON.stringify(pt))}catch{}},lr=Q=>{Cr(Q,`audiorailrider-preset-${Date.now()}.json`)},Wr=Q=>{const St=Ue(Q),pt=`${location.origin}${location.pathname}?preset=${St}`;or(pt).then(Pt=>{Pt?H("Preset URL copied to clipboard","success"):H("Copy failed; showing URL","info")})},Oi=async Q=>{if(Q)try{const St=await Q.text(),pt=JSON.parse(St);let Pt=pt;pt&&pt.data&&typeof pt.data=="object"&&(Pt=pt.data);const Ce={};for(const m of Object.keys(Pt)){const yn=qe(m,Pt[m]);Ce[m]=be(m,yn)}ci(Ce),H("Preset imported and applied","success")}catch(St){console.error("Failed to import preset",St)}};te.useEffect(()=>{try{const St=new URLSearchParams(location.search).get("preset");if(St){const pt=Me(St);if(pt){const Pt=pt.data&&typeof pt.data=="object"?pt.data:pt,Ce={};for(const m of Object.keys(Pt)){const yn=qe(m,Pt[m]);Ce[m]=be(m,yn)}ci(Ce)}}}catch{}},[]);const ci=Q=>{for(const St of Object.keys(Q)){const pt=Q[St],Pt=typeof pt=="string"&&!isNaN(Number(pt))?Number(pt):pt;St==="curlStrength"&&typeof Pt=="number"&&r(Pt),St==="noiseScale"&&typeof Pt=="number"&&s(Pt),St==="noiseSpeed"&&typeof Pt=="number"&&o(Pt),St==="placeUnderCamera"&&typeof Pt=="boolean"&&Lt(Pt),St==="verticalOffset"&&typeof Pt=="number"&&Wt(Pt),St==="trackDefaultOpacity"&&typeof Pt=="number"&&ce(Pt),St==="trackInsideOpacity"&&typeof Pt=="number"&&jt(Pt),St==="trackOpacityLerpSpeed"&&typeof Pt=="number"&&Xt(Pt),St==="trackRadius"&&typeof Pt=="number"&&de(Pt),g(Ce=>({...Ce,[St]:Pt})),window.dispatchEvent(new CustomEvent("audiorailrider:dev:applyUniform",{detail:{name:St,value:Pt}}))}};return c?U.jsxs("div",{className:"fixed right-4 top-4 z-50 w-72 p-3 bg-gray-900/80 border border-gray-700 rounded-lg text-sm text-gray-200 backdrop-blur-md",children:[U.jsx("h3",{className:"font-semibold text-gray-100 mb-2",children:"Dev Panel"}),U.jsxs("div",{className:"mb-2",children:[U.jsxs("label",{className:"block text-xs text-gray-300",children:["Curl Strength: ",e.toFixed(2)]}),U.jsx("input",{type:"range",min:"0",max:"1",step:"0.01",value:e,onChange:Q=>r(Number(Q.target.value)),className:"w-full"})]}),U.jsxs("div",{className:"mb-2",children:[U.jsxs("label",{className:"block text-xs text-gray-300",children:["Noise Scale: ",i.toFixed(2)]}),U.jsx("input",{type:"range",min:"0.1",max:"8",step:"0.1",value:i,onChange:Q=>s(Number(Q.target.value)),className:"w-full"})]}),U.jsxs("div",{className:"mb-3",children:[U.jsxs("label",{className:"block text-xs text-gray-300",children:["Noise Speed: ",a.toFixed(2)]}),U.jsx("input",{type:"range",min:"0",max:"1",step:"0.01",value:a,onChange:Q=>o(Number(Q.target.value)),className:"w-full"})]}),U.jsxs("div",{className:"flex gap-2",children:[U.jsx("button",{onClick:xe,className:"flex-1 px-3 py-1 bg-gray-800 border border-gray-600 rounded",children:"Reset"}),U.jsx("button",{onClick:()=>window.dispatchEvent(new CustomEvent("audiorailrider:dev:dump",{detail:{curlStrength:e,noiseScale:i,noiseSpeed:a}})),className:"px-3 py-1 bg-cyan-600 rounded",children:"Log"})]}),U.jsxs("div",{className:"mt-3 flex gap-2",children:[U.jsx("button",{onClick:_e,className:"flex-1 px-3 py-1 bg-gray-800 border border-gray-600 rounded",children:"Load Uniforms"}),U.jsx("button",{onClick:Ye,className:"px-3 py-1 bg-emerald-600 rounded",children:"Apply Curl Defaults"})]}),U.jsxs("div",{className:"mt-4",children:[U.jsx("h4",{className:"font-medium text-gray-100 mb-1",children:"Track Settings"}),U.jsx("div",{className:"mb-2 text-xs text-gray-300",children:U.jsxs("label",{className:"inline-flex items-center gap-2",children:[U.jsx("input",{type:"checkbox",checked:Et,onChange:Q=>Lt(Q.target.checked)}),"Place track under camera"]})}),U.jsxs("div",{className:"mb-2",children:[U.jsxs("label",{className:"block text-xs text-gray-300",children:["Vertical Offset: ",Dt.toFixed(2)]}),U.jsx("input",{type:"range",min:"0",max:"3",step:"0.01",value:Dt,onChange:Q=>Wt(Number(Q.target.value)),className:"w-full"})]}),U.jsxs("div",{className:"mb-2",children:[U.jsxs("label",{className:"block text-xs text-gray-300",children:["Track Radius: ",$t.toFixed(2)]}),U.jsx("input",{type:"range",min:"0.05",max:"2",step:"0.01",value:$t,onChange:Q=>de(Number(Q.target.value)),className:"w-full"})]}),U.jsxs("div",{className:"mb-2",children:[U.jsxs("label",{className:"block text-xs text-gray-300",children:["Default Opacity: ",se.toFixed(2)]}),U.jsx("input",{type:"range",min:"0",max:"1",step:"0.01",value:se,onChange:Q=>ce(Number(Q.target.value)),className:"w-full"})]}),U.jsxs("div",{className:"mb-2",children:[U.jsxs("label",{className:"block text-xs text-gray-300",children:["Inside Opacity: ",kt.toFixed(2)]}),U.jsx("input",{type:"range",min:"0",max:"1",step:"0.01",value:kt,onChange:Q=>jt(Number(Q.target.value)),className:"w-full"})]}),U.jsxs("div",{className:"mb-3",children:[U.jsxs("label",{className:"block text-xs text-gray-300",children:["Opacity Lerp Speed: ",ee.toFixed(2)]}),U.jsx("input",{type:"range",min:"0.1",max:"12",step:"0.1",value:ee,onChange:Q=>Xt(Number(Q.target.value)),className:"w-full"})]}),U.jsxs("div",{className:"flex gap-2 mb-3",children:[U.jsx("button",{onClick:()=>Kt(Q=>!Q),className:"px-3 py-1 bg-orange-600 rounded",children:me?"Release Inside":"Force Inside"}),U.jsx("button",{onClick:()=>window.dispatchEvent(new CustomEvent("audiorailrider:dev:rebuildTrack")),className:"px-3 py-1 bg-blue-600 rounded",children:"Rebuild Track"})]})]}),u?U.jsxs("div",{className:"mt-3",children:[U.jsx("h4",{className:"font-medium text-gray-100 mb-1",children:"Shader Uniforms"}),U.jsx("div",{className:"space-y-2 max-h-48 overflow-auto pr-2",children:Object.entries(u).map(([Q,St])=>U.jsxs("div",{className:"mb-2",children:[U.jsx("div",{className:"text-xs text-gray-400",children:Q}),St.map(pt=>U.jsxs("div",{className:"mt-1",children:[U.jsx("label",{className:"block text-xs text-gray-300",children:pt.name}),pt.control==="range"&&U.jsx("input",{"data-uniform":`$${pt.name}`,type:"range",min:pt.min??0,max:pt.max??1,step:pt.step??.01,value:x[pt.name]??pt.min??0,onChange:Pt=>Be(pt.name,Number(Pt.target.value)),className:"w-full"}),pt.control==="number"&&U.jsx("input",{"data-uniform":`$${pt.name}`,type:"number",min:pt.min??0,max:pt.max??16,step:pt.step??1,value:x[pt.name]??pt.min??0,onChange:Pt=>Be(pt.name,Number(Pt.target.value)),className:"w-full"}),pt.control==="checkbox"&&U.jsx("input",{"data-uniform":`$${pt.name}`,type:"checkbox",checked:!!x[pt.name],onChange:Pt=>Be(pt.name,Pt.target.checked)}),pt.control==="color"&&U.jsx("input",{"data-uniform":`$${pt.name}`,type:"color",value:x[pt.name]??"#000000",onChange:Pt=>Be(pt.name,Pt.target.value)}),pt.control==="select"&&pt.options&&U.jsx("select",{"data-uniform":`$${pt.name}`,value:x[pt.name]??pt.options[0],onChange:Pt=>Be(pt.name,Pt.target.value),className:"w-full",children:pt.options.map(Pt=>U.jsx("option",{value:Pt,children:Pt},Pt))})]},pt.name))]},Q))}),U.jsxs("div",{className:"mt-2 flex gap-2",children:[U.jsx("input",{id:"presetName",placeholder:"Preset name",className:"flex-1 px-2 py-1 bg-gray-800 border border-gray-700 rounded text-sm"}),U.jsx("button",{onClick:()=>{const Q=document.getElementById("presetName");Q&&Q.value&&Hr(Q.value)},className:"px-3 py-1 bg-blue-600 rounded",children:"Save"})]}),U.jsxs("div",{className:"mt-2 flex gap-2",children:[U.jsx("button",{onClick:()=>{const Q=re[re.length-1];Q&&lr(Q.data)},className:"px-2 py-1 bg-gray-800 rounded",children:"Export Last"}),U.jsx("button",{onClick:()=>{if(re.length===0){H("No presets to share","info");return}const Q=re[re.length-1];Wr(Q.data)},className:"px-2 py-1 bg-cyan-600 rounded",children:"Share URL"}),U.jsxs("label",{className:"px-2 py-1 bg-emerald-600 rounded cursor-pointer",children:["Import",U.jsx("input",{id:"presetFile",type:"file",accept:"application/json",className:"hidden",onChange:Q=>Oi(Q.target.files?Q.target.files[0]:null)})]})]}),re.length>0&&U.jsxs("div",{className:"mt-2",children:[U.jsx("div",{className:"text-xs text-gray-400 mb-1",children:"Presets"}),U.jsx("div",{className:"space-y-1",children:re.map((Q,St)=>U.jsxs("div",{className:"flex gap-2 items-center",children:[U.jsx("div",{className:"text-sm flex-1",children:Q.name}),U.jsx("button",{onClick:()=>ci(Q.data),className:"px-2 py-1 bg-gray-800 rounded",children:"Load"}),U.jsx("button",{onClick:()=>lr(Q.data),className:"px-2 py-1 bg-blue-600 rounded",children:"Export"}),U.jsx("button",{onClick:()=>Wr(Q.data),className:"px-2 py-1 bg-cyan-600 rounded",children:"Share"})]},St))})]})]}):null]}):null},Fx=(n,t)=>{if(!n&&!t)return!1;const e=(n||"").toLowerCase(),r=(t||"").toLowerCase();return!!(e.includes("swiftshader")||r==="google inc. (google)")},Px=()=>{const[n,t]=te.useState(!1),[e,r]=te.useState(null),[i,s]=te.useState(null);return te.useEffect(()=>{try{const a=document.createElement("canvas"),o=a.getContext("webgl")||a.getContext("experimental-webgl");if(!o)return;const c=o.getExtension("WEBGL_debug_renderer_info");if(c){const h=o.getParameter(c.UNMASKED_RENDERER_WEBGL),u=o.getParameter(c.UNMASKED_VENDOR_WEBGL);r(h),s(u),Fx(h,u)&&t(!0)}}catch{}},[]),n?U.jsx("div",{role:"status",className:"fixed top-4 left-1/2 transform -translate-x-1/2 z-50 bg-yellow-900/90 border border-yellow-700 text-yellow-100 px-4 py-3 rounded-md shadow-lg",children:U.jsxs("div",{className:"flex items-center gap-3",children:[U.jsxs("div",{className:"flex-1 text-sm",children:["VisualEffects is running on a software renderer (",e||"unknown","). Performance may be reduced. For best visuals enable hardware acceleration or run with a GPU-enabled browser."]}),U.jsx("button",{"aria-label":"dismiss",onClick:()=>t(!1),className:"ml-3 px-3 py-1 bg-yellow-800/60 rounded",children:"Dismiss"})]})}):null},Bx=n=>U.jsx("svg",{...n,xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor",children:U.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5m-13.5-9L12 3m0 0 4.5 4.5M12 3v13.5"})}),kx=n=>U.jsx("svg",{...n,xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor",children:U.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M5.25 5.653c0-.856.917-1.398 1.667-.986l11.54 6.347a1.125 1.125 0 0 1 0 1.972l-11.54 6.347a1.125 1.125 0 0 1-1.667-.986V5.653Z"})}),zx=n=>U.jsx("svg",{...n,xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor",children:U.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M9.813 15.904 9 18.75l-.813-2.846a4.5 4.5 0 0 0-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 0 0 3.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 0 0 3.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 0 0-3.09 3.09ZM18.259 8.715 18 9.75l-.259-1.035a3.375 3.375 0 0 0-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 0 0 2.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 0 0 2.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 0 0-2.456 2.456Z"})}),Ux=n=>U.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor",...n,children:U.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z"})}),Gx=["classic","extreme","flowing","technical","experimental"],Vx=["fantasy","cyberpunk","aurora","desert","space","underwater","noir"],jx=["photorealistic","stylized","painterly","lowpoly","retro"],Hx=["low","medium","high"],Wx=["fog","fireworks","starshow","lightBurst","sparkRing","confetti"],Yx=()=>{const n=Se(i=>i.generationOptions),t=Se(i=>i.actions.setGenerationOptions),e=(i,s)=>{t({...n,[i]:s})},r=(i,s)=>{const a=(n==null?void 0:n.preferredEventPresets)||[],o=i.target.checked?Array.from(new Set([...a,s])):a.filter(c=>c!==s);t({...n,preferredEventPresets:o})};return U.jsxs("div",{className:"mt-6 grid grid-cols-1 md:grid-cols-2 gap-3 max-w-xl mx-auto text-left",children:[U.jsxs("div",{children:[U.jsx("label",{className:"block text-xs text-gray-400",children:"Track Style"}),U.jsxs("select",{value:(n==null?void 0:n.trackStyle)||"",onChange:i=>e("trackStyle",i.target.value||void 0),className:"mt-1 w-full bg-gray-800/60 border border-gray-700 rounded-md p-2 text-sm text-gray-200",children:[U.jsx("option",{value:"",children:"(auto)"}),Gx.map(i=>U.jsx("option",{value:i,children:i},i))]})]}),U.jsxs("div",{children:[U.jsx("label",{className:"block text-xs text-gray-400",children:"World Theme"}),U.jsxs("select",{value:(n==null?void 0:n.worldTheme)||"",onChange:i=>e("worldTheme",i.target.value||void 0),className:"mt-1 w-full bg-gray-800/60 border border-gray-700 rounded-md p-2 text-sm text-gray-200",children:[U.jsx("option",{value:"",children:"(auto)"}),Vx.map(i=>U.jsx("option",{value:i,children:i},i))]})]}),U.jsxs("div",{children:[U.jsx("label",{className:"block text-xs text-gray-400",children:"Visual Style"}),U.jsxs("select",{value:(n==null?void 0:n.visualStyle)||"",onChange:i=>e("visualStyle",i.target.value||void 0),className:"mt-1 w-full bg-gray-800/60 border border-gray-700 rounded-md p-2 text-sm text-gray-200",children:[U.jsx("option",{value:"",children:"(auto)"}),jx.map(i=>U.jsx("option",{value:i,children:i},i))]})]}),U.jsxs("div",{children:[U.jsx("label",{className:"block text-xs text-gray-400",children:"Detail Level"}),U.jsxs("select",{value:(n==null?void 0:n.detailLevel)||"",onChange:i=>e("detailLevel",i.target.value||void 0),className:"mt-1 w-full bg-gray-800/60 border border-gray-700 rounded-md p-2 text-sm text-gray-200",children:[U.jsx("option",{value:"",children:"(auto)"}),Hx.map(i=>U.jsx("option",{value:i,children:i},i))]})]}),U.jsxs("div",{className:"md:col-span-2",children:[U.jsx("label",{className:"block text-xs text-gray-400",children:"Event Presets"}),U.jsx("div",{className:"mt-2 flex flex-wrap gap-2",children:Wx.map(i=>{const s=((n==null?void 0:n.preferredEventPresets)||[]).includes(i);return U.jsxs("label",{className:"inline-flex items-center gap-2 text-sm text-gray-300 bg-gray-800/40 px-3 py-1 rounded-md cursor-pointer",children:[U.jsx("input",{type:"checkbox",checked:s,onChange:a=>r(a,i)}),U.jsx("span",{className:"capitalize",children:i})]},i)})})]})]})},Xx=()=>{const{setAudioFile:n,setError:t}=Se(i=>i.actions),e=te.useRef(null);te.useEffect(()=>{e.current&&(e.current.value="")},[]);const r=te.useCallback(i=>{var c;const s=(c=i.target.files)==null?void 0:c[0];if(!s)return;const a=new Set(["audio/mpeg","audio/wav","audio/x-wav"]),o=20*1024*1024;if(!a.has(s.type)){t({title:"Unsupported File Type",message:`Please select a valid audio file (MP3, WAV). You selected a file of type: ${s.type}`});return}if(s.size>o){t({title:"File Too Large",message:`The selected file is too large (${(s.size/(1024*1024)).toFixed(1)}MB). Please select a file smaller than 20MB.`});return}n(s)},[n,t]);return U.jsxs("div",{className:"text-center animate-fade-in",children:[U.jsx("h1",{className:"text-5xl md:text-7xl font-thin tracking-widest uppercase bg-clip-text text-transparent bg-gradient-to-r from-fuchsia-400 to-cyan-400",children:"AudioRail Rider"}),U.jsx("p",{className:"mt-4 max-w-2xl mx-auto text-gray-400",children:"Translate music into a navigable space. Inhabit the soul of a song."}),U.jsxs("label",{htmlFor:"audio-upload",className:"mt-8 inline-flex items-center gap-3 px-8 py-4 bg-gray-800/50 border border-gray-600 rounded-lg cursor-pointer hover:bg-gray-700/70 hover:border-cyan-400 transition-all duration-300 transform hover:scale-105",children:[U.jsx(Bx,{className:"w-6 h-6"}),U.jsx("span",{children:"Offer a ghost... (MP3, WAV)"})]}),U.jsx("input",{ref:e,id:"audio-upload",type:"file",accept:"audio/mp3, audio/wav, audio/mpeg",className:"hidden",onChange:r}),U.jsx("p",{className:"text-xs text-gray-600 mt-4",children:"For the best experience, use a track with dynamic range."}),U.jsx(Yx,{}),U.jsxs("div",{className:"mt-8 text-sm text-gray-500",children:["Powered by ",U.jsx("span",{className:"font-semibold text-gray-400",children:"Gemini"})," & ",U.jsx("span",{className:"font-semibold text-gray-400",children:"Three.js"})]})]})},$x=()=>{const{audioFile:n}=Se(e=>e),{startRide:t}=Se(e=>e.actions);return U.jsxs("div",{className:"text-center flex flex-col items-center animate-fade-in",children:[U.jsx(zx,{className:"w-16 h-16 text-cyan-300"}),U.jsx("h2",{className:"text-4xl font-bold mt-4 bg-clip-text text-transparent bg-gradient-to-r from-fuchsia-400 to-cyan-400",children:"The Dreamscape is Ready"}),U.jsxs("p",{className:"mt-2 text-gray-300",children:['Your ride through "',n==null?void 0:n.name,'" has been constructed.']}),U.jsxs("button",{onClick:()=>{console.log("[App] Begin the Ride button clicked"),t()},className:"mt-8 inline-flex items-center gap-3 px-12 py-5 bg-cyan-500/80 text-white font-bold rounded-full shadow-lg shadow-cyan-500/20 hover:bg-cyan-400 transition-all duration-300 transform hover:scale-110",children:[U.jsx(kx,{className:"w-8 h-8"}),U.jsx("span",{children:"Begin the Ride"})]})]})},Jx=()=>{const n=Se(r=>r.audioFile),{startRideAgain:t,resetApp:e}=Se(r=>r.actions);return U.jsxs("div",{className:"text-center animate-fade-in",children:[U.jsx("h2",{className:"text-4xl font-bold",children:"Ride Complete"}),U.jsxs("p",{className:"mt-2 text-gray-300",children:['You have journeyed through "',(n==null?void 0:n.name)||"your audio",'".']}),U.jsxs("div",{className:"mt-8 flex justify-center gap-4",children:[U.jsx("button",{onClick:t,className:"px-6 py-2 bg-cyan-500 hover:bg-cyan-600 rounded-md transition-colors",children:"Ride Again"}),U.jsx("button",{onClick:e,className:"px-6 py-2 bg-gray-600 hover:bg-gray-700 rounded-md transition-colors",children:"Upload New Song"})]})]})},Wu=()=>{const n=Se(e=>e.error),t=Se(e=>e.actions.resetApp);return n?U.jsxs("div",{className:"text-center animate-fade-in bg-red-900/20 border border-red-500/50 rounded-lg p-8 max-w-lg shadow-xl",children:[U.jsx(Ux,{className:"w-16 h-16 text-red-400 mx-auto"}),U.jsx("h2",{className:"mt-4 text-3xl font-bold text-red-300",children:n.title}),U.jsx("p",{className:"mt-2 text-red-200",children:n.message}),U.jsx("button",{onClick:t,className:"mt-6 px-8 py-3 bg-red-600 hover:bg-red-700 text-white font-bold rounded-md transition-colors transform hover:scale-105",children:"Try Again"})]}):null},qx=Hn.lazy(()=>Rp(()=>import("./ThreeCanvas-D13cZOo7.js"),__vite__mapDeps([0,1,2,3]))),Zx=()=>{const n=Se(a=>a.status),t=Se(a=>a.statusMessage),e=Se(a=>a.trackData),r=Se(a=>{var o;return(o=a.trackData)==null?void 0:o.audioFeatures});te.useEffect(()=>{Ex()},[]),xx();const s={[ue.Idle]:Xx,[ue.Ready]:$x,[ue.Finished]:Jx,[ue.Error]:Wu,[ue.Analyzing]:null,[ue.Generating]:null,[ue.Riding]:null}[n]||Wu;return U.jsxs("main",{className:"relative w-full h-screen bg-black overflow-hidden flex items-center justify-center",children:[U.jsx("div",{className:"absolute inset-0 z-0 bg-[url('https://www.transparenttextures.com/patterns/stardust.png')] opacity-20"}),n===ue.Analyzing&&U.jsx(jn,{stage:"analyzing"}),n===ue.Generating&&(t.includes("Translating")?U.jsx(jn,{stage:"generating"}):t.includes("Refining")?U.jsx(jn,{stage:"generating",progress:50}):U.jsx(jn,{stage:"building",progress:75})),s&&U.jsxs("div",{className:"relative z-20 p-4",children:[U.jsx(Px,{}),U.jsx(s,{})]}),(n===ue.Riding||n===ue.Ready)&&e&&U.jsxs(Ax,{children:[U.jsx(te.Suspense,{fallback:U.jsx(jn,{stage:"loading"}),children:U.jsx(qx,{})}),n===ue.Ready&&U.jsx(Cx,{audioFeatures:r||null})]}),U.jsx(Dx,{})]})},G_=Object.freeze(Object.defineProperty({__proto__:null,default:Zx},Symbol.toStringTag,{value:"Module"}));export{gg as $,F_ as A,$u as B,vr as C,lg as D,Jn as E,Py as F,wg as G,$p as H,Eg as I,Tg as J,Yh as K,qu as L,we as M,zg as N,Ig as O,ni as P,bg as Q,Xu as R,_r as S,vg as T,Uo as U,L as V,oy as W,Ag as X,Sg as Y,Wh as Z,_g as _,tr as a,v0 as a$,xg as a0,Jh as a1,dn as a2,$h as a3,Qg as a4,ea as a5,Kg as a6,Zg as a7,oi as a8,l_ as a9,Wp as aA,Xp as aB,Go as aC,Kp as aD,Qp as aE,Qu as aF,e0 as aG,r0 as aH,i0 as aI,n0 as aJ,s0 as aK,a0 as aL,o0 as aM,l0 as aN,so as aO,c0 as aP,h0 as aQ,u0 as aR,f0 as aS,d0 as aT,m0 as aU,p0 as aV,y0 as aW,x0 as aX,g0 as aY,_0 as aZ,b0 as a_,o_ as aa,c_ as ab,s_ as ac,a_ as ad,n_ as ae,h_ as af,i_ as ag,ln as ah,Gr as ai,I_ as aj,e_ as ak,R_ as al,My as am,Vr as an,Mi as ao,Wo as ap,sg as aq,Gp as ar,og as as,Yp as at,Jp as au,qp as av,er as aw,lf as ax,Zp as ay,Hp as az,fr as b,g_ as b$,E0 as b0,A0 as b1,T0 as b2,S0 as b3,w0 as b4,M0 as b5,C0 as b6,I0 as b7,R0 as b8,O0 as b9,qg as bA,k0 as bB,r_ as bC,__ as bD,Yo as bE,oa as bF,li as bG,k_ as bH,Kh as bI,jp as bJ,Xg as bK,ax as bL,xy as bM,by as bN,_y as bO,ey as bP,f_ as bQ,uy as bR,ag as bS,Hg as bT,Yg as bU,Wg as bV,jg as bW,Vg as bX,Gg as bY,Ug as bZ,Iy as b_,N0 as ba,L0 as bb,D0 as bc,F0 as bd,P0 as be,Pg as bf,Fg as bg,Dg as bh,Lg as bi,Ng as bj,Og as bk,Rg as bl,rg as bm,ig as bn,ng as bo,jh as bp,fg as bq,ug as br,hg as bs,cg as bt,$g as bu,Jg as bv,v_ as bw,x_ as bx,b_ as by,Ay as bz,d_ as c,na as c0,kg as c1,Bg as c2,Vp as c3,pg as c4,yg as c5,A_ as c6,Ks as c7,sf as c8,D_ as c9,ue as cA,P_ as cB,Yu as cC,G_ as cD,L_ as ca,O_ as cb,Te as cc,Se as cd,Gy as ce,B_ as cf,br as cg,Ii as ch,Ci as ci,We as cj,By as ck,S_ as cl,z_ as cm,U_ as cn,Oy as co,cf as cp,T_ as cq,u_ as cr,bu as cs,w_ as ct,zy as cu,nf as cv,hf as cw,C_ as cx,N_ as cy,eg as cz,ko as d,y_ as e,Zh as f,si as g,le as h,E_ as i,Ku as j,t0 as k,qh as l,t_ as m,Zu as n,M_ as o,m_ as p,ia as q,tf as r,Xh as s,p_ as t,mg as u,dg as v,nu as w,Hh as x,Cg as y,Mg as z};
