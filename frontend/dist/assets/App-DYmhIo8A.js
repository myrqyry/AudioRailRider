const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/ThreeCanvas-CcinmEnU.js","assets/index-BfJFogZZ.js","assets/index-CybVBpYt.css","assets/ToastProvider-BS7mwvvo.js"])))=>i.map(i=>d[i]);
var Mp=Object.defineProperty;var Cp=(s,t,e)=>t in s?Mp(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e;var $c=(s,t,e)=>Cp(s,typeof t!="symbol"?t+"":t,e);import{R as jn,r as re,j as U,g as Ip,_ as Rp}from"./index-BfJFogZZ.js";import{useToast as Op}from"./ToastProvider-BS7mwvvo.js";var de=(s=>(s.Idle="idle",s.Analyzing="analyzing",s.Generating="generating",s.Ready="ready",s.Riding="riding",s.Finished="finished",s.Error="error",s))(de||{});const Yu=s=>s,eg=s=>s,qc=s=>{let t;const e=new Set,r=(h,u)=>{const d=typeof h=="function"?h(t):h;if(!Object.is(d,t)){const y=t;t=u??(typeof d!="object"||d===null)?d:Object.assign({},t,d),e.forEach(g=>g(t,y))}},i=()=>t,o={setState:r,getState:i,getInitialState:()=>c,subscribe:h=>(e.add(h),()=>e.delete(h))},c=t=s(r,i,o);return o},Np=(s=>s?qc(s):qc),Lp=s=>s;function Dp(s,t=Lp){const e=jn.useSyncExternalStore(s.subscribe,jn.useCallback(()=>t(s.getState()),[s,t]),jn.useCallback(()=>t(s.getInitialState()),[s,t]));return jn.useDebugValue(e),e}const Jc=s=>{const t=Np(s),e=r=>Dp(t,r);return Object.assign(e,t),e},Fp=(s=>s?Jc(s):Jc),be=Fp((s,t)=>({status:de.Idle,error:null,statusMessage:"",audioFile:null,blueprint:null,audioFeatures:null,trackData:null,workflowProgress:0,generationProgress:0,skyboxUrl:null,generationOptions:null,actions:{setGenerationOptions:e=>s({generationOptions:e}),setStatus:(e,r)=>s({status:e,statusMessage:r||"",error:null}),setBlueprint:e=>s({blueprint:e}),setAudioFeatures:e=>s({audioFeatures:e}),setTrackData:e=>{const r=t().status;e===null&&(r===de.Riding||r===de.Ready)?s({trackData:null,status:de.Idle,statusMessage:"Track data was cleared, returning to start."}):s({trackData:e})},setError:e=>s({error:e,status:e?de.Error:t().status}),setAudioFile:e=>{s({audioFile:e,status:de.Idle,error:null,workflowProgress:0,skyboxUrl:null})},setWorkflowProgress:e=>s({workflowProgress:e}),setGenerationProgress:e=>s({generationProgress:e}),setSkyboxUrl:e=>s({skyboxUrl:e}),startRide:()=>{const e=t();console.log("[Store] startRide called",{status:e.status,hasTrackData:!!e.trackData,hasAudioFile:!!e.audioFile}),e.status===de.Ready&&e.trackData&&e.audioFile?(console.log("[Store] Transitioning to Riding state"),s({status:de.Riding})):console.warn("[Store] Cannot start ride - conditions not met")},resetApp:()=>{s({status:de.Idle,error:null,statusMessage:"",audioFile:null,blueprint:null,audioFeatures:null,trackData:null,workflowProgress:0,skyboxUrl:null})},handleRideFinish:()=>{t().status===de.Riding&&s({status:de.Finished,statusMessage:"Your journey is complete."})},startRideAgain:()=>{t().status===de.Finished&&t().trackData&&t().audioFile&&s({status:de.Riding})}}}));/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 *//**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */var Zc;(function(s){s.OUTCOME_UNSPECIFIED="OUTCOME_UNSPECIFIED",s.OUTCOME_OK="OUTCOME_OK",s.OUTCOME_FAILED="OUTCOME_FAILED",s.OUTCOME_DEADLINE_EXCEEDED="OUTCOME_DEADLINE_EXCEEDED"})(Zc||(Zc={}));var Kc;(function(s){s.LANGUAGE_UNSPECIFIED="LANGUAGE_UNSPECIFIED",s.PYTHON="PYTHON"})(Kc||(Kc={}));var Qc;(function(s){s.TYPE_UNSPECIFIED="TYPE_UNSPECIFIED",s.STRING="STRING",s.NUMBER="NUMBER",s.INTEGER="INTEGER",s.BOOLEAN="BOOLEAN",s.ARRAY="ARRAY",s.OBJECT="OBJECT",s.NULL="NULL"})(Qc||(Qc={}));var un;(function(s){s.HARM_CATEGORY_UNSPECIFIED="HARM_CATEGORY_UNSPECIFIED",s.HARM_CATEGORY_HATE_SPEECH="HARM_CATEGORY_HATE_SPEECH",s.HARM_CATEGORY_DANGEROUS_CONTENT="HARM_CATEGORY_DANGEROUS_CONTENT",s.HARM_CATEGORY_HARASSMENT="HARM_CATEGORY_HARASSMENT",s.HARM_CATEGORY_SEXUALLY_EXPLICIT="HARM_CATEGORY_SEXUALLY_EXPLICIT",s.HARM_CATEGORY_CIVIC_INTEGRITY="HARM_CATEGORY_CIVIC_INTEGRITY",s.HARM_CATEGORY_IMAGE_HATE="HARM_CATEGORY_IMAGE_HATE",s.HARM_CATEGORY_IMAGE_DANGEROUS_CONTENT="HARM_CATEGORY_IMAGE_DANGEROUS_CONTENT",s.HARM_CATEGORY_IMAGE_HARASSMENT="HARM_CATEGORY_IMAGE_HARASSMENT",s.HARM_CATEGORY_IMAGE_SEXUALLY_EXPLICIT="HARM_CATEGORY_IMAGE_SEXUALLY_EXPLICIT"})(un||(un={}));var th;(function(s){s.HARM_BLOCK_METHOD_UNSPECIFIED="HARM_BLOCK_METHOD_UNSPECIFIED",s.SEVERITY="SEVERITY",s.PROBABILITY="PROBABILITY"})(th||(th={}));var fn;(function(s){s.HARM_BLOCK_THRESHOLD_UNSPECIFIED="HARM_BLOCK_THRESHOLD_UNSPECIFIED",s.BLOCK_LOW_AND_ABOVE="BLOCK_LOW_AND_ABOVE",s.BLOCK_MEDIUM_AND_ABOVE="BLOCK_MEDIUM_AND_ABOVE",s.BLOCK_ONLY_HIGH="BLOCK_ONLY_HIGH",s.BLOCK_NONE="BLOCK_NONE",s.OFF="OFF"})(fn||(fn={}));var eh;(function(s){s.MODE_UNSPECIFIED="MODE_UNSPECIFIED",s.MODE_DYNAMIC="MODE_DYNAMIC"})(eh||(eh={}));var rh;(function(s){s.AUTH_TYPE_UNSPECIFIED="AUTH_TYPE_UNSPECIFIED",s.NO_AUTH="NO_AUTH",s.API_KEY_AUTH="API_KEY_AUTH",s.HTTP_BASIC_AUTH="HTTP_BASIC_AUTH",s.GOOGLE_SERVICE_ACCOUNT_AUTH="GOOGLE_SERVICE_ACCOUNT_AUTH",s.OAUTH="OAUTH",s.OIDC_AUTH="OIDC_AUTH"})(rh||(rh={}));var ih;(function(s){s.API_SPEC_UNSPECIFIED="API_SPEC_UNSPECIFIED",s.SIMPLE_SEARCH="SIMPLE_SEARCH",s.ELASTIC_SEARCH="ELASTIC_SEARCH"})(ih||(ih={}));var nh;(function(s){s.URL_RETRIEVAL_STATUS_UNSPECIFIED="URL_RETRIEVAL_STATUS_UNSPECIFIED",s.URL_RETRIEVAL_STATUS_SUCCESS="URL_RETRIEVAL_STATUS_SUCCESS",s.URL_RETRIEVAL_STATUS_ERROR="URL_RETRIEVAL_STATUS_ERROR",s.URL_RETRIEVAL_STATUS_PAYWALL="URL_RETRIEVAL_STATUS_PAYWALL",s.URL_RETRIEVAL_STATUS_UNSAFE="URL_RETRIEVAL_STATUS_UNSAFE"})(nh||(nh={}));var sh;(function(s){s.FINISH_REASON_UNSPECIFIED="FINISH_REASON_UNSPECIFIED",s.STOP="STOP",s.MAX_TOKENS="MAX_TOKENS",s.SAFETY="SAFETY",s.RECITATION="RECITATION",s.LANGUAGE="LANGUAGE",s.OTHER="OTHER",s.BLOCKLIST="BLOCKLIST",s.PROHIBITED_CONTENT="PROHIBITED_CONTENT",s.SPII="SPII",s.MALFORMED_FUNCTION_CALL="MALFORMED_FUNCTION_CALL",s.IMAGE_SAFETY="IMAGE_SAFETY",s.UNEXPECTED_TOOL_CALL="UNEXPECTED_TOOL_CALL"})(sh||(sh={}));var ah;(function(s){s.HARM_PROBABILITY_UNSPECIFIED="HARM_PROBABILITY_UNSPECIFIED",s.NEGLIGIBLE="NEGLIGIBLE",s.LOW="LOW",s.MEDIUM="MEDIUM",s.HIGH="HIGH"})(ah||(ah={}));var oh;(function(s){s.HARM_SEVERITY_UNSPECIFIED="HARM_SEVERITY_UNSPECIFIED",s.HARM_SEVERITY_NEGLIGIBLE="HARM_SEVERITY_NEGLIGIBLE",s.HARM_SEVERITY_LOW="HARM_SEVERITY_LOW",s.HARM_SEVERITY_MEDIUM="HARM_SEVERITY_MEDIUM",s.HARM_SEVERITY_HIGH="HARM_SEVERITY_HIGH"})(oh||(oh={}));var lh;(function(s){s.BLOCKED_REASON_UNSPECIFIED="BLOCKED_REASON_UNSPECIFIED",s.SAFETY="SAFETY",s.OTHER="OTHER",s.BLOCKLIST="BLOCKLIST",s.PROHIBITED_CONTENT="PROHIBITED_CONTENT",s.IMAGE_SAFETY="IMAGE_SAFETY"})(lh||(lh={}));var ch;(function(s){s.TRAFFIC_TYPE_UNSPECIFIED="TRAFFIC_TYPE_UNSPECIFIED",s.ON_DEMAND="ON_DEMAND",s.PROVISIONED_THROUGHPUT="PROVISIONED_THROUGHPUT"})(ch||(ch={}));var hh;(function(s){s.MODALITY_UNSPECIFIED="MODALITY_UNSPECIFIED",s.TEXT="TEXT",s.IMAGE="IMAGE",s.AUDIO="AUDIO"})(hh||(hh={}));var uh;(function(s){s.MEDIA_RESOLUTION_UNSPECIFIED="MEDIA_RESOLUTION_UNSPECIFIED",s.MEDIA_RESOLUTION_LOW="MEDIA_RESOLUTION_LOW",s.MEDIA_RESOLUTION_MEDIUM="MEDIA_RESOLUTION_MEDIUM",s.MEDIA_RESOLUTION_HIGH="MEDIA_RESOLUTION_HIGH"})(uh||(uh={}));var fh;(function(s){s.JOB_STATE_UNSPECIFIED="JOB_STATE_UNSPECIFIED",s.JOB_STATE_QUEUED="JOB_STATE_QUEUED",s.JOB_STATE_PENDING="JOB_STATE_PENDING",s.JOB_STATE_RUNNING="JOB_STATE_RUNNING",s.JOB_STATE_SUCCEEDED="JOB_STATE_SUCCEEDED",s.JOB_STATE_FAILED="JOB_STATE_FAILED",s.JOB_STATE_CANCELLING="JOB_STATE_CANCELLING",s.JOB_STATE_CANCELLED="JOB_STATE_CANCELLED",s.JOB_STATE_PAUSED="JOB_STATE_PAUSED",s.JOB_STATE_EXPIRED="JOB_STATE_EXPIRED",s.JOB_STATE_UPDATING="JOB_STATE_UPDATING",s.JOB_STATE_PARTIALLY_SUCCEEDED="JOB_STATE_PARTIALLY_SUCCEEDED"})(fh||(fh={}));var dh;(function(s){s.TUNING_MODE_UNSPECIFIED="TUNING_MODE_UNSPECIFIED",s.TUNING_MODE_FULL="TUNING_MODE_FULL",s.TUNING_MODE_PEFT_ADAPTER="TUNING_MODE_PEFT_ADAPTER"})(dh||(dh={}));var mh;(function(s){s.ADAPTER_SIZE_UNSPECIFIED="ADAPTER_SIZE_UNSPECIFIED",s.ADAPTER_SIZE_ONE="ADAPTER_SIZE_ONE",s.ADAPTER_SIZE_TWO="ADAPTER_SIZE_TWO",s.ADAPTER_SIZE_FOUR="ADAPTER_SIZE_FOUR",s.ADAPTER_SIZE_EIGHT="ADAPTER_SIZE_EIGHT",s.ADAPTER_SIZE_SIXTEEN="ADAPTER_SIZE_SIXTEEN",s.ADAPTER_SIZE_THIRTY_TWO="ADAPTER_SIZE_THIRTY_TWO"})(mh||(mh={}));var ph;(function(s){s.FEATURE_SELECTION_PREFERENCE_UNSPECIFIED="FEATURE_SELECTION_PREFERENCE_UNSPECIFIED",s.PRIORITIZE_QUALITY="PRIORITIZE_QUALITY",s.BALANCED="BALANCED",s.PRIORITIZE_COST="PRIORITIZE_COST"})(ph||(ph={}));var yh;(function(s){s.UNSPECIFIED="UNSPECIFIED",s.BLOCKING="BLOCKING",s.NON_BLOCKING="NON_BLOCKING"})(yh||(yh={}));var xh;(function(s){s.MODE_UNSPECIFIED="MODE_UNSPECIFIED",s.MODE_DYNAMIC="MODE_DYNAMIC"})(xh||(xh={}));var gh;(function(s){s.ENVIRONMENT_UNSPECIFIED="ENVIRONMENT_UNSPECIFIED",s.ENVIRONMENT_BROWSER="ENVIRONMENT_BROWSER"})(gh||(gh={}));var _h;(function(s){s.MODE_UNSPECIFIED="MODE_UNSPECIFIED",s.AUTO="AUTO",s.ANY="ANY",s.NONE="NONE",s.VALIDATED="VALIDATED"})(_h||(_h={}));var bh;(function(s){s.BLOCK_LOW_AND_ABOVE="BLOCK_LOW_AND_ABOVE",s.BLOCK_MEDIUM_AND_ABOVE="BLOCK_MEDIUM_AND_ABOVE",s.BLOCK_ONLY_HIGH="BLOCK_ONLY_HIGH",s.BLOCK_NONE="BLOCK_NONE"})(bh||(bh={}));var vh;(function(s){s.DONT_ALLOW="DONT_ALLOW",s.ALLOW_ADULT="ALLOW_ADULT",s.ALLOW_ALL="ALLOW_ALL"})(vh||(vh={}));var Eh;(function(s){s.auto="auto",s.en="en",s.ja="ja",s.ko="ko",s.hi="hi",s.zh="zh",s.pt="pt",s.es="es"})(Eh||(Eh={}));var Ah;(function(s){s.MASK_MODE_DEFAULT="MASK_MODE_DEFAULT",s.MASK_MODE_USER_PROVIDED="MASK_MODE_USER_PROVIDED",s.MASK_MODE_BACKGROUND="MASK_MODE_BACKGROUND",s.MASK_MODE_FOREGROUND="MASK_MODE_FOREGROUND",s.MASK_MODE_SEMANTIC="MASK_MODE_SEMANTIC"})(Ah||(Ah={}));var Th;(function(s){s.CONTROL_TYPE_DEFAULT="CONTROL_TYPE_DEFAULT",s.CONTROL_TYPE_CANNY="CONTROL_TYPE_CANNY",s.CONTROL_TYPE_SCRIBBLE="CONTROL_TYPE_SCRIBBLE",s.CONTROL_TYPE_FACE_MESH="CONTROL_TYPE_FACE_MESH"})(Th||(Th={}));var Sh;(function(s){s.SUBJECT_TYPE_DEFAULT="SUBJECT_TYPE_DEFAULT",s.SUBJECT_TYPE_PERSON="SUBJECT_TYPE_PERSON",s.SUBJECT_TYPE_ANIMAL="SUBJECT_TYPE_ANIMAL",s.SUBJECT_TYPE_PRODUCT="SUBJECT_TYPE_PRODUCT"})(Sh||(Sh={}));var wh;(function(s){s.EDIT_MODE_DEFAULT="EDIT_MODE_DEFAULT",s.EDIT_MODE_INPAINT_REMOVAL="EDIT_MODE_INPAINT_REMOVAL",s.EDIT_MODE_INPAINT_INSERTION="EDIT_MODE_INPAINT_INSERTION",s.EDIT_MODE_OUTPAINT="EDIT_MODE_OUTPAINT",s.EDIT_MODE_CONTROLLED_EDITING="EDIT_MODE_CONTROLLED_EDITING",s.EDIT_MODE_STYLE="EDIT_MODE_STYLE",s.EDIT_MODE_BGSWAP="EDIT_MODE_BGSWAP",s.EDIT_MODE_PRODUCT_IMAGE="EDIT_MODE_PRODUCT_IMAGE"})(wh||(wh={}));var Mh;(function(s){s.FOREGROUND="FOREGROUND",s.BACKGROUND="BACKGROUND",s.PROMPT="PROMPT",s.SEMANTIC="SEMANTIC",s.INTERACTIVE="INTERACTIVE"})(Mh||(Mh={}));var Ch;(function(s){s.ASSET="ASSET",s.STYLE="STYLE"})(Ch||(Ch={}));var Ih;(function(s){s.OPTIMIZED="OPTIMIZED",s.LOSSLESS="LOSSLESS"})(Ih||(Ih={}));var Rh;(function(s){s.STATE_UNSPECIFIED="STATE_UNSPECIFIED",s.PROCESSING="PROCESSING",s.ACTIVE="ACTIVE",s.FAILED="FAILED"})(Rh||(Rh={}));var Oh;(function(s){s.SOURCE_UNSPECIFIED="SOURCE_UNSPECIFIED",s.UPLOADED="UPLOADED",s.GENERATED="GENERATED"})(Oh||(Oh={}));var Nh;(function(s){s.MODALITY_UNSPECIFIED="MODALITY_UNSPECIFIED",s.TEXT="TEXT",s.IMAGE="IMAGE",s.VIDEO="VIDEO",s.AUDIO="AUDIO",s.DOCUMENT="DOCUMENT"})(Nh||(Nh={}));var Lh;(function(s){s.START_SENSITIVITY_UNSPECIFIED="START_SENSITIVITY_UNSPECIFIED",s.START_SENSITIVITY_HIGH="START_SENSITIVITY_HIGH",s.START_SENSITIVITY_LOW="START_SENSITIVITY_LOW"})(Lh||(Lh={}));var Dh;(function(s){s.END_SENSITIVITY_UNSPECIFIED="END_SENSITIVITY_UNSPECIFIED",s.END_SENSITIVITY_HIGH="END_SENSITIVITY_HIGH",s.END_SENSITIVITY_LOW="END_SENSITIVITY_LOW"})(Dh||(Dh={}));var Fh;(function(s){s.ACTIVITY_HANDLING_UNSPECIFIED="ACTIVITY_HANDLING_UNSPECIFIED",s.START_OF_ACTIVITY_INTERRUPTS="START_OF_ACTIVITY_INTERRUPTS",s.NO_INTERRUPTION="NO_INTERRUPTION"})(Fh||(Fh={}));var Ph;(function(s){s.TURN_COVERAGE_UNSPECIFIED="TURN_COVERAGE_UNSPECIFIED",s.TURN_INCLUDES_ONLY_ACTIVITY="TURN_INCLUDES_ONLY_ACTIVITY",s.TURN_INCLUDES_ALL_INPUT="TURN_INCLUDES_ALL_INPUT"})(Ph||(Ph={}));var Bh;(function(s){s.SCHEDULING_UNSPECIFIED="SCHEDULING_UNSPECIFIED",s.SILENT="SILENT",s.WHEN_IDLE="WHEN_IDLE",s.INTERRUPT="INTERRUPT"})(Bh||(Bh={}));var kh;(function(s){s.SCALE_UNSPECIFIED="SCALE_UNSPECIFIED",s.C_MAJOR_A_MINOR="C_MAJOR_A_MINOR",s.D_FLAT_MAJOR_B_FLAT_MINOR="D_FLAT_MAJOR_B_FLAT_MINOR",s.D_MAJOR_B_MINOR="D_MAJOR_B_MINOR",s.E_FLAT_MAJOR_C_MINOR="E_FLAT_MAJOR_C_MINOR",s.E_MAJOR_D_FLAT_MINOR="E_MAJOR_D_FLAT_MINOR",s.F_MAJOR_D_MINOR="F_MAJOR_D_MINOR",s.G_FLAT_MAJOR_E_FLAT_MINOR="G_FLAT_MAJOR_E_FLAT_MINOR",s.G_MAJOR_E_MINOR="G_MAJOR_E_MINOR",s.A_FLAT_MAJOR_F_MINOR="A_FLAT_MAJOR_F_MINOR",s.A_MAJOR_G_FLAT_MINOR="A_MAJOR_G_FLAT_MINOR",s.B_FLAT_MAJOR_G_MINOR="B_FLAT_MAJOR_G_MINOR",s.B_MAJOR_A_FLAT_MINOR="B_MAJOR_A_FLAT_MINOR"})(kh||(kh={}));var zh;(function(s){s.MUSIC_GENERATION_MODE_UNSPECIFIED="MUSIC_GENERATION_MODE_UNSPECIFIED",s.QUALITY="QUALITY",s.DIVERSITY="DIVERSITY",s.VOCALIZATION="VOCALIZATION"})(zh||(zh={}));var Uh;(function(s){s.PLAYBACK_CONTROL_UNSPECIFIED="PLAYBACK_CONTROL_UNSPECIFIED",s.PLAY="PLAY",s.PAUSE="PAUSE",s.STOP="STOP",s.RESET_CONTEXT="RESET_CONTEXT"})(Uh||(Uh={}));/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */var Gh;(function(s){s.PAGED_ITEM_BATCH_JOBS="batchJobs",s.PAGED_ITEM_MODELS="models",s.PAGED_ITEM_TUNING_JOBS="tuningJobs",s.PAGED_ITEM_FILES="files",s.PAGED_ITEM_CACHED_CONTENTS="cachedContents"})(Gh||(Gh={}));function Pp(){const s="AIzaSyC0W595gQfd_V-pDmy2e2wRqoGOFJbhYKI";if(s.trim()==="")throw new Error("VITE_GEMINI_API_KEY is not configured in the .env file.");return s}const Qs=Object.freeze({get apiKey(){return Pp()},gemini:{modelName:"gemini-2.5-pro",generationConfig:{temperature:.9,topK:1,topP:1,maxOutputTokens:2048},safetySettings:[{category:un.HARM_CATEGORY_HARASSMENT,threshold:fn.BLOCK_MEDIUM_AND_ABOVE},{category:un.HARM_CATEGORY_HATE_SPEECH,threshold:fn.BLOCK_MEDIUM_AND_ABOVE},{category:un.HARM_CATEGORY_SEXUALLY_EXPLICIT,threshold:fn.BLOCK_MEDIUM_AND_ABOVE},{category:un.HARM_CATEGORY_DANGEROUS_CONTENT,threshold:fn.BLOCK_MEDIUM_AND_ABOVE}]},api:{baseUrl:"/api",endpoints:{processAudio:"/generate-blueprint",generateSkybox:"/generate-skybox"}}}),Bp=async(s,t,e)=>{const r=`${Qs.api.baseUrl}${Qs.api.endpoints.processAudio}`,i=new FormData;if(i.append("audio_file",s),e&&typeof e=="object")try{i.append("options",JSON.stringify(e))}catch{}try{console.debug("[GeminiService] Posting audio to backend",{url:r,fileName:s.name,fileSize:s.size});const n=await fetch(r,{method:"POST",body:i,signal:t});if(!n.ok){let o="Unknown server error";try{const c=await n.json();o=c.detail||c.error||JSON.stringify(c)}catch{}throw new Error(`Backend error: ${n.status} ${n.statusText} - ${o}`)}const a=await n.json();if(!a||!a.blueprint)throw new Error("Backend returned invalid payload");return{blueprint:a.blueprint,features:a.features}}catch(n){console.error("[GeminiService] generateRideBlueprint failed:",n);const a=n instanceof Error?n.message:String(n);throw a.includes("Failed to fetch")||a.includes("NetworkError")||a.includes("TypeError")?new Error(`Failed to contact backend at ${r}. This may indicate the backend is not running, CORS is blocking the request, or a network problem. Original error: ${a}`):n}},kp=async(s,t)=>{try{const e=`${Qs.api.baseUrl}${Qs.api.endpoints.generateSkybox}`,r=t&&t.generationOptions?t.generationOptions:null,i=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({prompt:s,blueprint:t,options:r})});if(!i.ok){const a=await i.json();throw i.status===501?(console.info("[GeminiService] Skybox generation not supported:",a.detail),new Error("Skybox generation not supported by Gemini API")):new Error(a.detail||"Failed to generate skybox image")}return(await i.json()).imageUrl}catch(e){console.warn("[GeminiService] Skybox generation failed, continuing without custom skybox:",e);const r=e instanceof Error?e.message:String(e);throw new Error(`Skybox generation unavailable: ${r}`)}},Bo=s=>{const t=s.component??s.type;return typeof t=="string"?t:void 0},Vh=s=>{switch((Bo(s)||"").toLowerCase()){case"drop":case"loop":case"barrelRoll":return!0;case"turn":{const e=s;return e.radius!==void 0&&e.radius<100}default:return!1}},zp=()=>({component:"climb",angle:0,length:30,intensity:10,lightingEffect:"none",environmentChange:"none",audioSyncPoint:Yu(0)}),Up=s=>{var r;console.log("Starting blueprint validation and refinement..."),console.log("[Validator] Blueprint structure:",{hasTrack:!!s.track,trackType:typeof s.track,trackLength:(r=s.track)==null?void 0:r.length,rideName:s.rideName,blueprintKeys:Object.keys(s)});const t=s.track;if(!t||!Array.isArray(t))throw console.error("[Validator] Invalid blueprint.track:",t),new Error("Blueprint is missing a valid track array");if(t.length<2)return s;const e=[t[0]];for(let i=1;i<t.length;i++){const n=t[i-1],a=t[i];Vh(n)&&Vh(a)&&(console.log(`[Validator] Intense transition found between segment ${i-1} (${Bo(n)}) and ${i} (${Bo(a)}). Inserting easing segment.`),e.push(zp())),e.push(a)}return console.log(`Blueprint refined. Original segments: ${t.length}, Refined segments: ${e.length}`),{...s,track:e}};/**
 * @license
 * Copyright 2010-2025 Three.js Authors
 * SPDX-License-Identifier: MIT
 */const Xu="178",rg=0,ig=1,ng=2,sg=1,ag=2,og=3,ko=0,$u=1,lg=2,Gp=0,jh=1,cg=2,hg=3,ug=4,fg=5,Hh=100,dg=101,mg=102,pg=103,yg=104,xg=200,gg=201,_g=202,bg=203,Wh=204,Yh=205,vg=206,Eg=207,Ag=208,Tg=209,Sg=210,wg=211,Mg=212,Cg=213,Ig=214,Rg=0,Og=1,Ng=2,Xh=3,Lg=4,Dg=5,Fg=6,Pg=7,Vp=0,Bg=1,kg=2,zg=0,Ug=1,Gg=2,Vg=3,jg=4,Hg=5,Wg=6,Yg=7,qu=300,jp=301,Xg=302,$g=303,qg=304,Jg=306,$h=1e3,dn=1001,qh=1002,ai=1003,Zg=1004,Kg=1005,ta=1006,Qg=1007,Ju=1008,Uo=1009,Hp=1010,Wp=1011,Yp=1012,Xp=1013,Zu=1014,Go=1015,$p=1016,qp=1017,Jp=1018,t_=1020,Zp=35902,Kp=1021,Qp=1022,Ku=1023,Jh=1026,t0=1027,Qu=1028,e0=1029,r0=1030,i0=1031,n0=1033,s0=33776,a0=33777,o0=33778,l0=33779,c0=35840,h0=35841,u0=35842,f0=35843,d0=36196,m0=37492,p0=37496,y0=37808,x0=37809,g0=37810,_0=37811,b0=37812,v0=37813,E0=37814,A0=37815,T0=37816,S0=37817,w0=37818,M0=37819,C0=37820,I0=37821,R0=36492,O0=36494,N0=36495,L0=36283,D0=36284,F0=36285,P0=36286,B0=3200,e_=3201,k0=0,r_=1,tf="",vr="srgb",Zh="srgb-linear",Kh="linear",no="srgb",Xi=7680,Qh=519,i_=512,n_=513,s_=514,a_=515,o_=516,l_=517,c_=518,h_=519,tu=35044,u_=35048,f_="300 es",ni=2e3,ea=2001;class $n{addEventListener(t,e){this._listeners===void 0&&(this._listeners={});const r=this._listeners;r[t]===void 0&&(r[t]=[]),r[t].indexOf(e)===-1&&r[t].push(e)}hasEventListener(t,e){const r=this._listeners;return r===void 0?!1:r[t]!==void 0&&r[t].indexOf(e)!==-1}removeEventListener(t,e){const r=this._listeners;if(r===void 0)return;const i=r[t];if(i!==void 0){const n=i.indexOf(e);n!==-1&&i.splice(n,1)}}dispatchEvent(t){const e=this._listeners;if(e===void 0)return;const r=e[t.type];if(r!==void 0){t.target=this;const i=r.slice(0);for(let n=0,a=i.length;n<a;n++)i[n].call(this,t);t.target=null}}}const $e=["00","01","02","03","04","05","06","07","08","09","0a","0b","0c","0d","0e","0f","10","11","12","13","14","15","16","17","18","19","1a","1b","1c","1d","1e","1f","20","21","22","23","24","25","26","27","28","29","2a","2b","2c","2d","2e","2f","30","31","32","33","34","35","36","37","38","39","3a","3b","3c","3d","3e","3f","40","41","42","43","44","45","46","47","48","49","4a","4b","4c","4d","4e","4f","50","51","52","53","54","55","56","57","58","59","5a","5b","5c","5d","5e","5f","60","61","62","63","64","65","66","67","68","69","6a","6b","6c","6d","6e","6f","70","71","72","73","74","75","76","77","78","79","7a","7b","7c","7d","7e","7f","80","81","82","83","84","85","86","87","88","89","8a","8b","8c","8d","8e","8f","90","91","92","93","94","95","96","97","98","99","9a","9b","9c","9d","9e","9f","a0","a1","a2","a3","a4","a5","a6","a7","a8","a9","aa","ab","ac","ad","ae","af","b0","b1","b2","b3","b4","b5","b6","b7","b8","b9","ba","bb","bc","bd","be","bf","c0","c1","c2","c3","c4","c5","c6","c7","c8","c9","ca","cb","cc","cd","ce","cf","d0","d1","d2","d3","d4","d5","d6","d7","d8","d9","da","db","dc","dd","de","df","e0","e1","e2","e3","e4","e5","e6","e7","e8","e9","ea","eb","ec","ed","ee","ef","f0","f1","f2","f3","f4","f5","f6","f7","f8","f9","fa","fb","fc","fd","fe","ff"];let eu=1234567;const Hn=Math.PI/180,ra=180/Math.PI;function pn(){const s=Math.random()*4294967295|0,t=Math.random()*4294967295|0,e=Math.random()*4294967295|0,r=Math.random()*4294967295|0;return($e[s&255]+$e[s>>8&255]+$e[s>>16&255]+$e[s>>24&255]+"-"+$e[t&255]+$e[t>>8&255]+"-"+$e[t>>16&15|64]+$e[t>>24&255]+"-"+$e[e&63|128]+$e[e>>8&255]+"-"+$e[e>>16&255]+$e[e>>24&255]+$e[r&255]+$e[r>>8&255]+$e[r>>16&255]+$e[r>>24&255]).toLowerCase()}function ne(s,t,e){return Math.max(t,Math.min(e,s))}function Vo(s,t){return(s%t+t)%t}function z0(s,t,e,r,i){return r+(s-t)*(i-r)/(e-t)}function U0(s,t,e){return s!==t?(e-s)/(t-s):0}function Wn(s,t,e){return(1-e)*s+e*t}function G0(s,t,e,r){return Wn(s,t,1-Math.exp(-e*r))}function V0(s,t=1){return t-Math.abs(Vo(s,t*2)-t)}function j0(s,t,e){return s<=t?0:s>=e?1:(s=(s-t)/(e-t),s*s*(3-2*s))}function H0(s,t,e){return s<=t?0:s>=e?1:(s=(s-t)/(e-t),s*s*s*(s*(s*6-15)+10))}function W0(s,t){return s+Math.floor(Math.random()*(t-s+1))}function Y0(s,t){return s+Math.random()*(t-s)}function X0(s){return s*(.5-Math.random())}function $0(s){s!==void 0&&(eu=s);let t=eu+=1831565813;return t=Math.imul(t^t>>>15,t|1),t^=t+Math.imul(t^t>>>7,t|61),((t^t>>>14)>>>0)/4294967296}function q0(s){return s*Hn}function J0(s){return s*ra}function Z0(s){return(s&s-1)===0&&s!==0}function K0(s){return Math.pow(2,Math.ceil(Math.log(s)/Math.LN2))}function Q0(s){return Math.pow(2,Math.floor(Math.log(s)/Math.LN2))}function ty(s,t,e,r,i){const n=Math.cos,a=Math.sin,o=n(e/2),c=a(e/2),h=n((t+r)/2),u=a((t+r)/2),d=n((t-r)/2),y=a((t-r)/2),g=n((r-t)/2),A=a((r-t)/2);switch(i){case"XYX":s.set(o*u,c*d,c*y,o*h);break;case"YZY":s.set(c*y,o*u,c*d,o*h);break;case"ZXZ":s.set(c*d,c*y,o*u,o*h);break;case"XZX":s.set(o*u,c*A,c*g,o*h);break;case"YXY":s.set(c*g,o*u,c*A,o*h);break;case"ZYZ":s.set(c*A,c*g,o*u,o*h);break;default:console.warn("THREE.MathUtils: .setQuaternionFromProperEuler() encountered an unknown order: "+i)}}function hn(s,t){switch(t.constructor){case Float32Array:return s;case Uint32Array:return s/4294967295;case Uint16Array:return s/65535;case Uint8Array:return s/255;case Int32Array:return Math.max(s/2147483647,-1);case Int16Array:return Math.max(s/32767,-1);case Int8Array:return Math.max(s/127,-1);default:throw new Error("Invalid component type.")}}function Ze(s,t){switch(t.constructor){case Float32Array:return s;case Uint32Array:return Math.round(s*4294967295);case Uint16Array:return Math.round(s*65535);case Uint8Array:return Math.round(s*255);case Int32Array:return Math.round(s*2147483647);case Int16Array:return Math.round(s*32767);case Int8Array:return Math.round(s*127);default:throw new Error("Invalid component type.")}}const Se={DEG2RAD:Hn,RAD2DEG:ra,generateUUID:pn,clamp:ne,euclideanModulo:Vo,mapLinear:z0,inverseLerp:U0,lerp:Wn,damp:G0,pingpong:V0,smoothstep:j0,smootherstep:H0,randInt:W0,randFloat:Y0,randFloatSpread:X0,seededRandom:$0,degToRad:q0,radToDeg:J0,isPowerOfTwo:Z0,ceilPowerOfTwo:K0,floorPowerOfTwo:Q0,setQuaternionFromProperEuler:ty,normalize:Ze,denormalize:hn};class le{constructor(t=0,e=0){le.prototype.isVector2=!0,this.x=t,this.y=e}get width(){return this.x}set width(t){this.x=t}get height(){return this.y}set height(t){this.y=t}set(t,e){return this.x=t,this.y=e,this}setScalar(t){return this.x=t,this.y=t,this}setX(t){return this.x=t,this}setY(t){return this.y=t,this}setComponent(t,e){switch(t){case 0:this.x=e;break;case 1:this.y=e;break;default:throw new Error("index is out of range: "+t)}return this}getComponent(t){switch(t){case 0:return this.x;case 1:return this.y;default:throw new Error("index is out of range: "+t)}}clone(){return new this.constructor(this.x,this.y)}copy(t){return this.x=t.x,this.y=t.y,this}add(t){return this.x+=t.x,this.y+=t.y,this}addScalar(t){return this.x+=t,this.y+=t,this}addVectors(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this}addScaledVector(t,e){return this.x+=t.x*e,this.y+=t.y*e,this}sub(t){return this.x-=t.x,this.y-=t.y,this}subScalar(t){return this.x-=t,this.y-=t,this}subVectors(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this}multiply(t){return this.x*=t.x,this.y*=t.y,this}multiplyScalar(t){return this.x*=t,this.y*=t,this}divide(t){return this.x/=t.x,this.y/=t.y,this}divideScalar(t){return this.multiplyScalar(1/t)}applyMatrix3(t){const e=this.x,r=this.y,i=t.elements;return this.x=i[0]*e+i[3]*r+i[6],this.y=i[1]*e+i[4]*r+i[7],this}min(t){return this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this}max(t){return this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this}clamp(t,e){return this.x=ne(this.x,t.x,e.x),this.y=ne(this.y,t.y,e.y),this}clampScalar(t,e){return this.x=ne(this.x,t,e),this.y=ne(this.y,t,e),this}clampLength(t,e){const r=this.length();return this.divideScalar(r||1).multiplyScalar(ne(r,t,e))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}roundToZero(){return this.x=Math.trunc(this.x),this.y=Math.trunc(this.y),this}negate(){return this.x=-this.x,this.y=-this.y,this}dot(t){return this.x*t.x+this.y*t.y}cross(t){return this.x*t.y-this.y*t.x}lengthSq(){return this.x*this.x+this.y*this.y}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)}normalize(){return this.divideScalar(this.length()||1)}angle(){return Math.atan2(-this.y,-this.x)+Math.PI}angleTo(t){const e=Math.sqrt(this.lengthSq()*t.lengthSq());if(e===0)return Math.PI/2;const r=this.dot(t)/e;return Math.acos(ne(r,-1,1))}distanceTo(t){return Math.sqrt(this.distanceToSquared(t))}distanceToSquared(t){const e=this.x-t.x,r=this.y-t.y;return e*e+r*r}manhattanDistanceTo(t){return Math.abs(this.x-t.x)+Math.abs(this.y-t.y)}setLength(t){return this.normalize().multiplyScalar(t)}lerp(t,e){return this.x+=(t.x-this.x)*e,this.y+=(t.y-this.y)*e,this}lerpVectors(t,e,r){return this.x=t.x+(e.x-t.x)*r,this.y=t.y+(e.y-t.y)*r,this}equals(t){return t.x===this.x&&t.y===this.y}fromArray(t,e=0){return this.x=t[e],this.y=t[e+1],this}toArray(t=[],e=0){return t[e]=this.x,t[e+1]=this.y,t}fromBufferAttribute(t,e){return this.x=t.getX(e),this.y=t.getY(e),this}rotateAround(t,e){const r=Math.cos(e),i=Math.sin(e),n=this.x-t.x,a=this.y-t.y;return this.x=n*r-a*i+t.x,this.y=n*i+a*r+t.y,this}random(){return this.x=Math.random(),this.y=Math.random(),this}*[Symbol.iterator](){yield this.x,yield this.y}}class qn{constructor(t=0,e=0,r=0,i=1){this.isQuaternion=!0,this._x=t,this._y=e,this._z=r,this._w=i}static slerpFlat(t,e,r,i,n,a,o){let c=r[i+0],h=r[i+1],u=r[i+2],d=r[i+3];const y=n[a+0],g=n[a+1],A=n[a+2],D=n[a+3];if(o===0){t[e+0]=c,t[e+1]=h,t[e+2]=u,t[e+3]=d;return}if(o===1){t[e+0]=y,t[e+1]=g,t[e+2]=A,t[e+3]=D;return}if(d!==D||c!==y||h!==g||u!==A){let H=1-o;const V=c*y+h*g+u*A+d*D,Tt=V>=0?1:-1,ft=1-V*V;if(ft>Number.EPSILON){const Mt=Math.sqrt(ft),Dt=Math.atan2(Mt,V*Tt);H=Math.sin(H*Dt)/Mt,o=Math.sin(o*Dt)/Mt}const ct=o*Tt;if(c=c*H+y*ct,h=h*H+g*ct,u=u*H+A*ct,d=d*H+D*ct,H===1-o){const Mt=1/Math.sqrt(c*c+h*h+u*u+d*d);c*=Mt,h*=Mt,u*=Mt,d*=Mt}}t[e]=c,t[e+1]=h,t[e+2]=u,t[e+3]=d}static multiplyQuaternionsFlat(t,e,r,i,n,a){const o=r[i],c=r[i+1],h=r[i+2],u=r[i+3],d=n[a],y=n[a+1],g=n[a+2],A=n[a+3];return t[e]=o*A+u*d+c*g-h*y,t[e+1]=c*A+u*y+h*d-o*g,t[e+2]=h*A+u*g+o*y-c*d,t[e+3]=u*A-o*d-c*y-h*g,t}get x(){return this._x}set x(t){this._x=t,this._onChangeCallback()}get y(){return this._y}set y(t){this._y=t,this._onChangeCallback()}get z(){return this._z}set z(t){this._z=t,this._onChangeCallback()}get w(){return this._w}set w(t){this._w=t,this._onChangeCallback()}set(t,e,r,i){return this._x=t,this._y=e,this._z=r,this._w=i,this._onChangeCallback(),this}clone(){return new this.constructor(this._x,this._y,this._z,this._w)}copy(t){return this._x=t.x,this._y=t.y,this._z=t.z,this._w=t.w,this._onChangeCallback(),this}setFromEuler(t,e=!0){const r=t._x,i=t._y,n=t._z,a=t._order,o=Math.cos,c=Math.sin,h=o(r/2),u=o(i/2),d=o(n/2),y=c(r/2),g=c(i/2),A=c(n/2);switch(a){case"XYZ":this._x=y*u*d+h*g*A,this._y=h*g*d-y*u*A,this._z=h*u*A+y*g*d,this._w=h*u*d-y*g*A;break;case"YXZ":this._x=y*u*d+h*g*A,this._y=h*g*d-y*u*A,this._z=h*u*A-y*g*d,this._w=h*u*d+y*g*A;break;case"ZXY":this._x=y*u*d-h*g*A,this._y=h*g*d+y*u*A,this._z=h*u*A+y*g*d,this._w=h*u*d-y*g*A;break;case"ZYX":this._x=y*u*d-h*g*A,this._y=h*g*d+y*u*A,this._z=h*u*A-y*g*d,this._w=h*u*d+y*g*A;break;case"YZX":this._x=y*u*d+h*g*A,this._y=h*g*d+y*u*A,this._z=h*u*A-y*g*d,this._w=h*u*d-y*g*A;break;case"XZY":this._x=y*u*d-h*g*A,this._y=h*g*d-y*u*A,this._z=h*u*A+y*g*d,this._w=h*u*d+y*g*A;break;default:console.warn("THREE.Quaternion: .setFromEuler() encountered an unknown order: "+a)}return e===!0&&this._onChangeCallback(),this}setFromAxisAngle(t,e){const r=e/2,i=Math.sin(r);return this._x=t.x*i,this._y=t.y*i,this._z=t.z*i,this._w=Math.cos(r),this._onChangeCallback(),this}setFromRotationMatrix(t){const e=t.elements,r=e[0],i=e[4],n=e[8],a=e[1],o=e[5],c=e[9],h=e[2],u=e[6],d=e[10],y=r+o+d;if(y>0){const g=.5/Math.sqrt(y+1);this._w=.25/g,this._x=(u-c)*g,this._y=(n-h)*g,this._z=(a-i)*g}else if(r>o&&r>d){const g=2*Math.sqrt(1+r-o-d);this._w=(u-c)/g,this._x=.25*g,this._y=(i+a)/g,this._z=(n+h)/g}else if(o>d){const g=2*Math.sqrt(1+o-r-d);this._w=(n-h)/g,this._x=(i+a)/g,this._y=.25*g,this._z=(c+u)/g}else{const g=2*Math.sqrt(1+d-r-o);this._w=(a-i)/g,this._x=(n+h)/g,this._y=(c+u)/g,this._z=.25*g}return this._onChangeCallback(),this}setFromUnitVectors(t,e){let r=t.dot(e)+1;return r<1e-8?(r=0,Math.abs(t.x)>Math.abs(t.z)?(this._x=-t.y,this._y=t.x,this._z=0,this._w=r):(this._x=0,this._y=-t.z,this._z=t.y,this._w=r)):(this._x=t.y*e.z-t.z*e.y,this._y=t.z*e.x-t.x*e.z,this._z=t.x*e.y-t.y*e.x,this._w=r),this.normalize()}angleTo(t){return 2*Math.acos(Math.abs(ne(this.dot(t),-1,1)))}rotateTowards(t,e){const r=this.angleTo(t);if(r===0)return this;const i=Math.min(1,e/r);return this.slerp(t,i),this}identity(){return this.set(0,0,0,1)}invert(){return this.conjugate()}conjugate(){return this._x*=-1,this._y*=-1,this._z*=-1,this._onChangeCallback(),this}dot(t){return this._x*t._x+this._y*t._y+this._z*t._z+this._w*t._w}lengthSq(){return this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w}length(){return Math.sqrt(this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w)}normalize(){let t=this.length();return t===0?(this._x=0,this._y=0,this._z=0,this._w=1):(t=1/t,this._x=this._x*t,this._y=this._y*t,this._z=this._z*t,this._w=this._w*t),this._onChangeCallback(),this}multiply(t){return this.multiplyQuaternions(this,t)}premultiply(t){return this.multiplyQuaternions(t,this)}multiplyQuaternions(t,e){const r=t._x,i=t._y,n=t._z,a=t._w,o=e._x,c=e._y,h=e._z,u=e._w;return this._x=r*u+a*o+i*h-n*c,this._y=i*u+a*c+n*o-r*h,this._z=n*u+a*h+r*c-i*o,this._w=a*u-r*o-i*c-n*h,this._onChangeCallback(),this}slerp(t,e){if(e===0)return this;if(e===1)return this.copy(t);const r=this._x,i=this._y,n=this._z,a=this._w;let o=a*t._w+r*t._x+i*t._y+n*t._z;if(o<0?(this._w=-t._w,this._x=-t._x,this._y=-t._y,this._z=-t._z,o=-o):this.copy(t),o>=1)return this._w=a,this._x=r,this._y=i,this._z=n,this;const c=1-o*o;if(c<=Number.EPSILON){const g=1-e;return this._w=g*a+e*this._w,this._x=g*r+e*this._x,this._y=g*i+e*this._y,this._z=g*n+e*this._z,this.normalize(),this}const h=Math.sqrt(c),u=Math.atan2(h,o),d=Math.sin((1-e)*u)/h,y=Math.sin(e*u)/h;return this._w=a*d+this._w*y,this._x=r*d+this._x*y,this._y=i*d+this._y*y,this._z=n*d+this._z*y,this._onChangeCallback(),this}slerpQuaternions(t,e,r){return this.copy(t).slerp(e,r)}random(){const t=2*Math.PI*Math.random(),e=2*Math.PI*Math.random(),r=Math.random(),i=Math.sqrt(1-r),n=Math.sqrt(r);return this.set(i*Math.sin(t),i*Math.cos(t),n*Math.sin(e),n*Math.cos(e))}equals(t){return t._x===this._x&&t._y===this._y&&t._z===this._z&&t._w===this._w}fromArray(t,e=0){return this._x=t[e],this._y=t[e+1],this._z=t[e+2],this._w=t[e+3],this._onChangeCallback(),this}toArray(t=[],e=0){return t[e]=this._x,t[e+1]=this._y,t[e+2]=this._z,t[e+3]=this._w,t}fromBufferAttribute(t,e){return this._x=t.getX(e),this._y=t.getY(e),this._z=t.getZ(e),this._w=t.getW(e),this._onChangeCallback(),this}toJSON(){return this.toArray()}_onChange(t){return this._onChangeCallback=t,this}_onChangeCallback(){}*[Symbol.iterator](){yield this._x,yield this._y,yield this._z,yield this._w}}class L{constructor(t=0,e=0,r=0){L.prototype.isVector3=!0,this.x=t,this.y=e,this.z=r}set(t,e,r){return r===void 0&&(r=this.z),this.x=t,this.y=e,this.z=r,this}setScalar(t){return this.x=t,this.y=t,this.z=t,this}setX(t){return this.x=t,this}setY(t){return this.y=t,this}setZ(t){return this.z=t,this}setComponent(t,e){switch(t){case 0:this.x=e;break;case 1:this.y=e;break;case 2:this.z=e;break;default:throw new Error("index is out of range: "+t)}return this}getComponent(t){switch(t){case 0:return this.x;case 1:return this.y;case 2:return this.z;default:throw new Error("index is out of range: "+t)}}clone(){return new this.constructor(this.x,this.y,this.z)}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this}add(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this}addScalar(t){return this.x+=t,this.y+=t,this.z+=t,this}addVectors(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this.z=t.z+e.z,this}addScaledVector(t,e){return this.x+=t.x*e,this.y+=t.y*e,this.z+=t.z*e,this}sub(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this}subScalar(t){return this.x-=t,this.y-=t,this.z-=t,this}subVectors(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this.z=t.z-e.z,this}multiply(t){return this.x*=t.x,this.y*=t.y,this.z*=t.z,this}multiplyScalar(t){return this.x*=t,this.y*=t,this.z*=t,this}multiplyVectors(t,e){return this.x=t.x*e.x,this.y=t.y*e.y,this.z=t.z*e.z,this}applyEuler(t){return this.applyQuaternion(ru.setFromEuler(t))}applyAxisAngle(t,e){return this.applyQuaternion(ru.setFromAxisAngle(t,e))}applyMatrix3(t){const e=this.x,r=this.y,i=this.z,n=t.elements;return this.x=n[0]*e+n[3]*r+n[6]*i,this.y=n[1]*e+n[4]*r+n[7]*i,this.z=n[2]*e+n[5]*r+n[8]*i,this}applyNormalMatrix(t){return this.applyMatrix3(t).normalize()}applyMatrix4(t){const e=this.x,r=this.y,i=this.z,n=t.elements,a=1/(n[3]*e+n[7]*r+n[11]*i+n[15]);return this.x=(n[0]*e+n[4]*r+n[8]*i+n[12])*a,this.y=(n[1]*e+n[5]*r+n[9]*i+n[13])*a,this.z=(n[2]*e+n[6]*r+n[10]*i+n[14])*a,this}applyQuaternion(t){const e=this.x,r=this.y,i=this.z,n=t.x,a=t.y,o=t.z,c=t.w,h=2*(a*i-o*r),u=2*(o*e-n*i),d=2*(n*r-a*e);return this.x=e+c*h+a*d-o*u,this.y=r+c*u+o*h-n*d,this.z=i+c*d+n*u-a*h,this}project(t){return this.applyMatrix4(t.matrixWorldInverse).applyMatrix4(t.projectionMatrix)}unproject(t){return this.applyMatrix4(t.projectionMatrixInverse).applyMatrix4(t.matrixWorld)}transformDirection(t){const e=this.x,r=this.y,i=this.z,n=t.elements;return this.x=n[0]*e+n[4]*r+n[8]*i,this.y=n[1]*e+n[5]*r+n[9]*i,this.z=n[2]*e+n[6]*r+n[10]*i,this.normalize()}divide(t){return this.x/=t.x,this.y/=t.y,this.z/=t.z,this}divideScalar(t){return this.multiplyScalar(1/t)}min(t){return this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this.z=Math.min(this.z,t.z),this}max(t){return this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this.z=Math.max(this.z,t.z),this}clamp(t,e){return this.x=ne(this.x,t.x,e.x),this.y=ne(this.y,t.y,e.y),this.z=ne(this.z,t.z,e.z),this}clampScalar(t,e){return this.x=ne(this.x,t,e),this.y=ne(this.y,t,e),this.z=ne(this.z,t,e),this}clampLength(t,e){const r=this.length();return this.divideScalar(r||1).multiplyScalar(ne(r,t,e))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this}roundToZero(){return this.x=Math.trunc(this.x),this.y=Math.trunc(this.y),this.z=Math.trunc(this.z),this}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)}normalize(){return this.divideScalar(this.length()||1)}setLength(t){return this.normalize().multiplyScalar(t)}lerp(t,e){return this.x+=(t.x-this.x)*e,this.y+=(t.y-this.y)*e,this.z+=(t.z-this.z)*e,this}lerpVectors(t,e,r){return this.x=t.x+(e.x-t.x)*r,this.y=t.y+(e.y-t.y)*r,this.z=t.z+(e.z-t.z)*r,this}cross(t){return this.crossVectors(this,t)}crossVectors(t,e){const r=t.x,i=t.y,n=t.z,a=e.x,o=e.y,c=e.z;return this.x=i*c-n*o,this.y=n*a-r*c,this.z=r*o-i*a,this}projectOnVector(t){const e=t.lengthSq();if(e===0)return this.set(0,0,0);const r=t.dot(this)/e;return this.copy(t).multiplyScalar(r)}projectOnPlane(t){return so.copy(this).projectOnVector(t),this.sub(so)}reflect(t){return this.sub(so.copy(t).multiplyScalar(2*this.dot(t)))}angleTo(t){const e=Math.sqrt(this.lengthSq()*t.lengthSq());if(e===0)return Math.PI/2;const r=this.dot(t)/e;return Math.acos(ne(r,-1,1))}distanceTo(t){return Math.sqrt(this.distanceToSquared(t))}distanceToSquared(t){const e=this.x-t.x,r=this.y-t.y,i=this.z-t.z;return e*e+r*r+i*i}manhattanDistanceTo(t){return Math.abs(this.x-t.x)+Math.abs(this.y-t.y)+Math.abs(this.z-t.z)}setFromSpherical(t){return this.setFromSphericalCoords(t.radius,t.phi,t.theta)}setFromSphericalCoords(t,e,r){const i=Math.sin(e)*t;return this.x=i*Math.sin(r),this.y=Math.cos(e)*t,this.z=i*Math.cos(r),this}setFromCylindrical(t){return this.setFromCylindricalCoords(t.radius,t.theta,t.y)}setFromCylindricalCoords(t,e,r){return this.x=t*Math.sin(e),this.y=r,this.z=t*Math.cos(e),this}setFromMatrixPosition(t){const e=t.elements;return this.x=e[12],this.y=e[13],this.z=e[14],this}setFromMatrixScale(t){const e=this.setFromMatrixColumn(t,0).length(),r=this.setFromMatrixColumn(t,1).length(),i=this.setFromMatrixColumn(t,2).length();return this.x=e,this.y=r,this.z=i,this}setFromMatrixColumn(t,e){return this.fromArray(t.elements,e*4)}setFromMatrix3Column(t,e){return this.fromArray(t.elements,e*3)}setFromEuler(t){return this.x=t._x,this.y=t._y,this.z=t._z,this}setFromColor(t){return this.x=t.r,this.y=t.g,this.z=t.b,this}equals(t){return t.x===this.x&&t.y===this.y&&t.z===this.z}fromArray(t,e=0){return this.x=t[e],this.y=t[e+1],this.z=t[e+2],this}toArray(t=[],e=0){return t[e]=this.x,t[e+1]=this.y,t[e+2]=this.z,t}fromBufferAttribute(t,e){return this.x=t.getX(e),this.y=t.getY(e),this.z=t.getZ(e),this}random(){return this.x=Math.random(),this.y=Math.random(),this.z=Math.random(),this}randomDirection(){const t=Math.random()*Math.PI*2,e=Math.random()*2-1,r=Math.sqrt(1-e*e);return this.x=r*Math.cos(t),this.y=e,this.z=r*Math.sin(t),this}*[Symbol.iterator](){yield this.x,yield this.y,yield this.z}}const so=new L,ru=new qn;class Vr{constructor(t,e,r,i,n,a,o,c,h){Vr.prototype.isMatrix3=!0,this.elements=[1,0,0,0,1,0,0,0,1],t!==void 0&&this.set(t,e,r,i,n,a,o,c,h)}set(t,e,r,i,n,a,o,c,h){const u=this.elements;return u[0]=t,u[1]=i,u[2]=o,u[3]=e,u[4]=n,u[5]=c,u[6]=r,u[7]=a,u[8]=h,this}identity(){return this.set(1,0,0,0,1,0,0,0,1),this}copy(t){const e=this.elements,r=t.elements;return e[0]=r[0],e[1]=r[1],e[2]=r[2],e[3]=r[3],e[4]=r[4],e[5]=r[5],e[6]=r[6],e[7]=r[7],e[8]=r[8],this}extractBasis(t,e,r){return t.setFromMatrix3Column(this,0),e.setFromMatrix3Column(this,1),r.setFromMatrix3Column(this,2),this}setFromMatrix4(t){const e=t.elements;return this.set(e[0],e[4],e[8],e[1],e[5],e[9],e[2],e[6],e[10]),this}multiply(t){return this.multiplyMatrices(this,t)}premultiply(t){return this.multiplyMatrices(t,this)}multiplyMatrices(t,e){const r=t.elements,i=e.elements,n=this.elements,a=r[0],o=r[3],c=r[6],h=r[1],u=r[4],d=r[7],y=r[2],g=r[5],A=r[8],D=i[0],H=i[3],V=i[6],Tt=i[1],ft=i[4],ct=i[7],Mt=i[2],Dt=i[5],Et=i[8];return n[0]=a*D+o*Tt+c*Mt,n[3]=a*H+o*ft+c*Dt,n[6]=a*V+o*ct+c*Et,n[1]=h*D+u*Tt+d*Mt,n[4]=h*H+u*ft+d*Dt,n[7]=h*V+u*ct+d*Et,n[2]=y*D+g*Tt+A*Mt,n[5]=y*H+g*ft+A*Dt,n[8]=y*V+g*ct+A*Et,this}multiplyScalar(t){const e=this.elements;return e[0]*=t,e[3]*=t,e[6]*=t,e[1]*=t,e[4]*=t,e[7]*=t,e[2]*=t,e[5]*=t,e[8]*=t,this}determinant(){const t=this.elements,e=t[0],r=t[1],i=t[2],n=t[3],a=t[4],o=t[5],c=t[6],h=t[7],u=t[8];return e*a*u-e*o*h-r*n*u+r*o*c+i*n*h-i*a*c}invert(){const t=this.elements,e=t[0],r=t[1],i=t[2],n=t[3],a=t[4],o=t[5],c=t[6],h=t[7],u=t[8],d=u*a-o*h,y=o*c-u*n,g=h*n-a*c,A=e*d+r*y+i*g;if(A===0)return this.set(0,0,0,0,0,0,0,0,0);const D=1/A;return t[0]=d*D,t[1]=(i*h-u*r)*D,t[2]=(o*r-i*a)*D,t[3]=y*D,t[4]=(u*e-i*c)*D,t[5]=(i*n-o*e)*D,t[6]=g*D,t[7]=(r*c-h*e)*D,t[8]=(a*e-r*n)*D,this}transpose(){let t;const e=this.elements;return t=e[1],e[1]=e[3],e[3]=t,t=e[2],e[2]=e[6],e[6]=t,t=e[5],e[5]=e[7],e[7]=t,this}getNormalMatrix(t){return this.setFromMatrix4(t).invert().transpose()}transposeIntoArray(t){const e=this.elements;return t[0]=e[0],t[1]=e[3],t[2]=e[6],t[3]=e[1],t[4]=e[4],t[5]=e[7],t[6]=e[2],t[7]=e[5],t[8]=e[8],this}setUvTransform(t,e,r,i,n,a,o){const c=Math.cos(n),h=Math.sin(n);return this.set(r*c,r*h,-r*(c*a+h*o)+a+t,-i*h,i*c,-i*(-h*a+c*o)+o+e,0,0,1),this}scale(t,e){return this.premultiply(ao.makeScale(t,e)),this}rotate(t){return this.premultiply(ao.makeRotation(-t)),this}translate(t,e){return this.premultiply(ao.makeTranslation(t,e)),this}makeTranslation(t,e){return t.isVector2?this.set(1,0,t.x,0,1,t.y,0,0,1):this.set(1,0,t,0,1,e,0,0,1),this}makeRotation(t){const e=Math.cos(t),r=Math.sin(t);return this.set(e,-r,0,r,e,0,0,0,1),this}makeScale(t,e){return this.set(t,0,0,0,e,0,0,0,1),this}equals(t){const e=this.elements,r=t.elements;for(let i=0;i<9;i++)if(e[i]!==r[i])return!1;return!0}fromArray(t,e=0){for(let r=0;r<9;r++)this.elements[r]=t[r+e];return this}toArray(t=[],e=0){const r=this.elements;return t[e]=r[0],t[e+1]=r[1],t[e+2]=r[2],t[e+3]=r[3],t[e+4]=r[4],t[e+5]=r[5],t[e+6]=r[6],t[e+7]=r[7],t[e+8]=r[8],t}clone(){return new this.constructor().fromArray(this.elements)}}const ao=new Vr;function ey(s){for(let t=s.length-1;t>=0;--t)if(s[t]>=65535)return!0;return!1}function ia(s){return document.createElementNS("http://www.w3.org/1999/xhtml",s)}function d_(){const s=ia("canvas");return s.style.display="block",s}const iu={};function nu(s){s in iu||(iu[s]=!0,console.warn(s))}function m_(s,t,e){return new Promise(function(r,i){function n(){switch(s.clientWaitSync(t,s.SYNC_FLUSH_COMMANDS_BIT,0)){case s.WAIT_FAILED:i();break;case s.TIMEOUT_EXPIRED:setTimeout(n,e);break;default:r()}}setTimeout(n,e)})}function p_(s){const t=s.elements;t[2]=.5*t[2]+.5*t[3],t[6]=.5*t[6]+.5*t[7],t[10]=.5*t[10]+.5*t[11],t[14]=.5*t[14]+.5*t[15]}function y_(s){const t=s.elements;t[11]===-1?(t[10]=-t[10]-1,t[14]=-t[14]):(t[10]=-t[10],t[14]=-t[14]+1)}const su=new Vr().set(.4123908,.3575843,.1804808,.212639,.7151687,.0721923,.0193308,.1191948,.9505322),au=new Vr().set(3.2409699,-1.5373832,-.4986108,-.9692436,1.8759675,.0415551,.0556301,-.203977,1.0569715);function ry(){const s={enabled:!0,workingColorSpace:Zh,spaces:{},convert:function(i,n,a){return this.enabled===!1||n===a||!n||!a||(this.spaces[n].transfer===no&&(i.r=Gr(i.r),i.g=Gr(i.g),i.b=Gr(i.b)),this.spaces[n].primaries!==this.spaces[a].primaries&&(i.applyMatrix3(this.spaces[n].toXYZ),i.applyMatrix3(this.spaces[a].fromXYZ)),this.spaces[a].transfer===no&&(i.r=mn(i.r),i.g=mn(i.g),i.b=mn(i.b))),i},workingToColorSpace:function(i,n){return this.convert(i,this.workingColorSpace,n)},colorSpaceToWorking:function(i,n){return this.convert(i,n,this.workingColorSpace)},getPrimaries:function(i){return this.spaces[i].primaries},getTransfer:function(i){return i===tf?Kh:this.spaces[i].transfer},getLuminanceCoefficients:function(i,n=this.workingColorSpace){return i.fromArray(this.spaces[n].luminanceCoefficients)},define:function(i){Object.assign(this.spaces,i)},_getMatrix:function(i,n,a){return i.copy(this.spaces[n].toXYZ).multiply(this.spaces[a].fromXYZ)},_getDrawingBufferColorSpace:function(i){return this.spaces[i].outputColorSpaceConfig.drawingBufferColorSpace},_getUnpackColorSpace:function(i=this.workingColorSpace){return this.spaces[i].workingColorSpaceConfig.unpackColorSpace},fromWorkingColorSpace:function(i,n){return nu("THREE.ColorManagement: .fromWorkingColorSpace() has been renamed to .workingToColorSpace()."),s.workingToColorSpace(i,n)},toWorkingColorSpace:function(i,n){return nu("THREE.ColorManagement: .toWorkingColorSpace() has been renamed to .colorSpaceToWorking()."),s.colorSpaceToWorking(i,n)}},t=[.64,.33,.3,.6,.15,.06],e=[.2126,.7152,.0722],r=[.3127,.329];return s.define({[Zh]:{primaries:t,whitePoint:r,transfer:Kh,toXYZ:su,fromXYZ:au,luminanceCoefficients:e,workingColorSpaceConfig:{unpackColorSpace:vr},outputColorSpaceConfig:{drawingBufferColorSpace:vr}},[vr]:{primaries:t,whitePoint:r,transfer:no,toXYZ:su,fromXYZ:au,luminanceCoefficients:e,outputColorSpaceConfig:{drawingBufferColorSpace:vr}}}),s}const dr=ry();function Gr(s){return s<.04045?s*.0773993808:Math.pow(s*.9478672986+.0521327014,2.4)}function mn(s){return s<.0031308?s*12.92:1.055*Math.pow(s,.41666)-.055}let $i;class iy{static getDataURL(t,e="image/png"){if(/^data:/i.test(t.src)||typeof HTMLCanvasElement>"u")return t.src;let r;if(t instanceof HTMLCanvasElement)r=t;else{$i===void 0&&($i=ia("canvas")),$i.width=t.width,$i.height=t.height;const i=$i.getContext("2d");t instanceof ImageData?i.putImageData(t,0,0):i.drawImage(t,0,0,t.width,t.height),r=$i}return r.toDataURL(e)}static sRGBToLinear(t){if(typeof HTMLImageElement<"u"&&t instanceof HTMLImageElement||typeof HTMLCanvasElement<"u"&&t instanceof HTMLCanvasElement||typeof ImageBitmap<"u"&&t instanceof ImageBitmap){const e=ia("canvas");e.width=t.width,e.height=t.height;const r=e.getContext("2d");r.drawImage(t,0,0,t.width,t.height);const i=r.getImageData(0,0,t.width,t.height),n=i.data;for(let a=0;a<n.length;a++)n[a]=Gr(n[a]/255)*255;return r.putImageData(i,0,0),e}else if(t.data){const e=t.data.slice(0);for(let r=0;r<e.length;r++)e instanceof Uint8Array||e instanceof Uint8ClampedArray?e[r]=Math.floor(Gr(e[r]/255)*255):e[r]=Gr(e[r]);return{data:e,width:t.width,height:t.height}}else return console.warn("THREE.ImageUtils.sRGBToLinear(): Unsupported image type. No color space conversion applied."),t}}let ny=0;class jo{constructor(t=null){this.isSource=!0,Object.defineProperty(this,"id",{value:ny++}),this.uuid=pn(),this.data=t,this.dataReady=!0,this.version=0}getSize(t){const e=this.data;return e instanceof HTMLVideoElement?t.set(e.videoWidth,e.videoHeight):e!==null?t.set(e.width,e.height,e.depth||0):t.set(0,0,0),t}set needsUpdate(t){t===!0&&this.version++}toJSON(t){const e=t===void 0||typeof t=="string";if(!e&&t.images[this.uuid]!==void 0)return t.images[this.uuid];const r={uuid:this.uuid,url:""},i=this.data;if(i!==null){let n;if(Array.isArray(i)){n=[];for(let a=0,o=i.length;a<o;a++)i[a].isDataTexture?n.push(oo(i[a].image)):n.push(oo(i[a]))}else n=oo(i);r.url=n}return e||(t.images[this.uuid]=r),r}}function oo(s){return typeof HTMLImageElement<"u"&&s instanceof HTMLImageElement||typeof HTMLCanvasElement<"u"&&s instanceof HTMLCanvasElement||typeof ImageBitmap<"u"&&s instanceof ImageBitmap?iy.getDataURL(s):s.data?{data:Array.from(s.data),width:s.width,height:s.height,type:s.data.constructor.name}:(console.warn("THREE.Texture: Unable to serialize Texture."),{})}let sy=0;const lo=new L;class rr extends $n{constructor(t=rr.DEFAULT_IMAGE,e=rr.DEFAULT_MAPPING,r=dn,i=dn,n=ta,a=Ju,o=Ku,c=Uo,h=rr.DEFAULT_ANISOTROPY,u=tf){super(),this.isTexture=!0,Object.defineProperty(this,"id",{value:sy++}),this.uuid=pn(),this.name="",this.source=new jo(t),this.mipmaps=[],this.mapping=e,this.channel=0,this.wrapS=r,this.wrapT=i,this.magFilter=n,this.minFilter=a,this.anisotropy=h,this.format=o,this.internalFormat=null,this.type=c,this.offset=new le(0,0),this.repeat=new le(1,1),this.center=new le(0,0),this.rotation=0,this.matrixAutoUpdate=!0,this.matrix=new Vr,this.generateMipmaps=!0,this.premultiplyAlpha=!1,this.flipY=!0,this.unpackAlignment=4,this.colorSpace=u,this.userData={},this.updateRanges=[],this.version=0,this.onUpdate=null,this.renderTarget=null,this.isRenderTargetTexture=!1,this.isArrayTexture=!!(t&&t.depth&&t.depth>1),this.pmremVersion=0}get width(){return this.source.getSize(lo).x}get height(){return this.source.getSize(lo).y}get depth(){return this.source.getSize(lo).z}get image(){return this.source.data}set image(t=null){this.source.data=t}updateMatrix(){this.matrix.setUvTransform(this.offset.x,this.offset.y,this.repeat.x,this.repeat.y,this.rotation,this.center.x,this.center.y)}addUpdateRange(t,e){this.updateRanges.push({start:t,count:e})}clearUpdateRanges(){this.updateRanges.length=0}clone(){return new this.constructor().copy(this)}copy(t){return this.name=t.name,this.source=t.source,this.mipmaps=t.mipmaps.slice(0),this.mapping=t.mapping,this.channel=t.channel,this.wrapS=t.wrapS,this.wrapT=t.wrapT,this.magFilter=t.magFilter,this.minFilter=t.minFilter,this.anisotropy=t.anisotropy,this.format=t.format,this.internalFormat=t.internalFormat,this.type=t.type,this.offset.copy(t.offset),this.repeat.copy(t.repeat),this.center.copy(t.center),this.rotation=t.rotation,this.matrixAutoUpdate=t.matrixAutoUpdate,this.matrix.copy(t.matrix),this.generateMipmaps=t.generateMipmaps,this.premultiplyAlpha=t.premultiplyAlpha,this.flipY=t.flipY,this.unpackAlignment=t.unpackAlignment,this.colorSpace=t.colorSpace,this.renderTarget=t.renderTarget,this.isRenderTargetTexture=t.isRenderTargetTexture,this.isArrayTexture=t.isArrayTexture,this.userData=JSON.parse(JSON.stringify(t.userData)),this.needsUpdate=!0,this}setValues(t){for(const e in t){const r=t[e];if(r===void 0){console.warn(`THREE.Texture.setValues(): parameter '${e}' has value of undefined.`);continue}const i=this[e];if(i===void 0){console.warn(`THREE.Texture.setValues(): property '${e}' does not exist.`);continue}i&&r&&i.isVector2&&r.isVector2||i&&r&&i.isVector3&&r.isVector3||i&&r&&i.isMatrix3&&r.isMatrix3?i.copy(r):this[e]=r}}toJSON(t){const e=t===void 0||typeof t=="string";if(!e&&t.textures[this.uuid]!==void 0)return t.textures[this.uuid];const r={metadata:{version:4.7,type:"Texture",generator:"Texture.toJSON"},uuid:this.uuid,name:this.name,image:this.source.toJSON(t).uuid,mapping:this.mapping,channel:this.channel,repeat:[this.repeat.x,this.repeat.y],offset:[this.offset.x,this.offset.y],center:[this.center.x,this.center.y],rotation:this.rotation,wrap:[this.wrapS,this.wrapT],format:this.format,internalFormat:this.internalFormat,type:this.type,colorSpace:this.colorSpace,minFilter:this.minFilter,magFilter:this.magFilter,anisotropy:this.anisotropy,flipY:this.flipY,generateMipmaps:this.generateMipmaps,premultiplyAlpha:this.premultiplyAlpha,unpackAlignment:this.unpackAlignment};return Object.keys(this.userData).length>0&&(r.userData=this.userData),e||(t.textures[this.uuid]=r),r}dispose(){this.dispatchEvent({type:"dispose"})}transformUv(t){if(this.mapping!==qu)return t;if(t.applyMatrix3(this.matrix),t.x<0||t.x>1)switch(this.wrapS){case $h:t.x=t.x-Math.floor(t.x);break;case dn:t.x=t.x<0?0:1;break;case qh:Math.abs(Math.floor(t.x)%2)===1?t.x=Math.ceil(t.x)-t.x:t.x=t.x-Math.floor(t.x);break}if(t.y<0||t.y>1)switch(this.wrapT){case $h:t.y=t.y-Math.floor(t.y);break;case dn:t.y=t.y<0?0:1;break;case qh:Math.abs(Math.floor(t.y)%2)===1?t.y=Math.ceil(t.y)-t.y:t.y=t.y-Math.floor(t.y);break}return this.flipY&&(t.y=1-t.y),t}set needsUpdate(t){t===!0&&(this.version++,this.source.needsUpdate=!0)}set needsPMREMUpdate(t){t===!0&&this.pmremVersion++}}rr.DEFAULT_IMAGE=null;rr.DEFAULT_MAPPING=qu;rr.DEFAULT_ANISOTROPY=1;class er{constructor(t=0,e=0,r=0,i=1){er.prototype.isVector4=!0,this.x=t,this.y=e,this.z=r,this.w=i}get width(){return this.z}set width(t){this.z=t}get height(){return this.w}set height(t){this.w=t}set(t,e,r,i){return this.x=t,this.y=e,this.z=r,this.w=i,this}setScalar(t){return this.x=t,this.y=t,this.z=t,this.w=t,this}setX(t){return this.x=t,this}setY(t){return this.y=t,this}setZ(t){return this.z=t,this}setW(t){return this.w=t,this}setComponent(t,e){switch(t){case 0:this.x=e;break;case 1:this.y=e;break;case 2:this.z=e;break;case 3:this.w=e;break;default:throw new Error("index is out of range: "+t)}return this}getComponent(t){switch(t){case 0:return this.x;case 1:return this.y;case 2:return this.z;case 3:return this.w;default:throw new Error("index is out of range: "+t)}}clone(){return new this.constructor(this.x,this.y,this.z,this.w)}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w!==void 0?t.w:1,this}add(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this.w+=t.w,this}addScalar(t){return this.x+=t,this.y+=t,this.z+=t,this.w+=t,this}addVectors(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this.z=t.z+e.z,this.w=t.w+e.w,this}addScaledVector(t,e){return this.x+=t.x*e,this.y+=t.y*e,this.z+=t.z*e,this.w+=t.w*e,this}sub(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this.w-=t.w,this}subScalar(t){return this.x-=t,this.y-=t,this.z-=t,this.w-=t,this}subVectors(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this.z=t.z-e.z,this.w=t.w-e.w,this}multiply(t){return this.x*=t.x,this.y*=t.y,this.z*=t.z,this.w*=t.w,this}multiplyScalar(t){return this.x*=t,this.y*=t,this.z*=t,this.w*=t,this}applyMatrix4(t){const e=this.x,r=this.y,i=this.z,n=this.w,a=t.elements;return this.x=a[0]*e+a[4]*r+a[8]*i+a[12]*n,this.y=a[1]*e+a[5]*r+a[9]*i+a[13]*n,this.z=a[2]*e+a[6]*r+a[10]*i+a[14]*n,this.w=a[3]*e+a[7]*r+a[11]*i+a[15]*n,this}divide(t){return this.x/=t.x,this.y/=t.y,this.z/=t.z,this.w/=t.w,this}divideScalar(t){return this.multiplyScalar(1/t)}setAxisAngleFromQuaternion(t){this.w=2*Math.acos(t.w);const e=Math.sqrt(1-t.w*t.w);return e<1e-4?(this.x=1,this.y=0,this.z=0):(this.x=t.x/e,this.y=t.y/e,this.z=t.z/e),this}setAxisAngleFromRotationMatrix(t){let e,r,i,n;const c=t.elements,h=c[0],u=c[4],d=c[8],y=c[1],g=c[5],A=c[9],D=c[2],H=c[6],V=c[10];if(Math.abs(u-y)<.01&&Math.abs(d-D)<.01&&Math.abs(A-H)<.01){if(Math.abs(u+y)<.1&&Math.abs(d+D)<.1&&Math.abs(A+H)<.1&&Math.abs(h+g+V-3)<.1)return this.set(1,0,0,0),this;e=Math.PI;const ft=(h+1)/2,ct=(g+1)/2,Mt=(V+1)/2,Dt=(u+y)/4,Et=(d+D)/4,St=(A+H)/4;return ft>ct&&ft>Mt?ft<.01?(r=0,i=.707106781,n=.707106781):(r=Math.sqrt(ft),i=Dt/r,n=Et/r):ct>Mt?ct<.01?(r=.707106781,i=0,n=.707106781):(i=Math.sqrt(ct),r=Dt/i,n=St/i):Mt<.01?(r=.707106781,i=.707106781,n=0):(n=Math.sqrt(Mt),r=Et/n,i=St/n),this.set(r,i,n,e),this}let Tt=Math.sqrt((H-A)*(H-A)+(d-D)*(d-D)+(y-u)*(y-u));return Math.abs(Tt)<.001&&(Tt=1),this.x=(H-A)/Tt,this.y=(d-D)/Tt,this.z=(y-u)/Tt,this.w=Math.acos((h+g+V-1)/2),this}setFromMatrixPosition(t){const e=t.elements;return this.x=e[12],this.y=e[13],this.z=e[14],this.w=e[15],this}min(t){return this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this.z=Math.min(this.z,t.z),this.w=Math.min(this.w,t.w),this}max(t){return this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this.z=Math.max(this.z,t.z),this.w=Math.max(this.w,t.w),this}clamp(t,e){return this.x=ne(this.x,t.x,e.x),this.y=ne(this.y,t.y,e.y),this.z=ne(this.z,t.z,e.z),this.w=ne(this.w,t.w,e.w),this}clampScalar(t,e){return this.x=ne(this.x,t,e),this.y=ne(this.y,t,e),this.z=ne(this.z,t,e),this.w=ne(this.w,t,e),this}clampLength(t,e){const r=this.length();return this.divideScalar(r||1).multiplyScalar(ne(r,t,e))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this.w=Math.floor(this.w),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this.w=Math.ceil(this.w),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this.w=Math.round(this.w),this}roundToZero(){return this.x=Math.trunc(this.x),this.y=Math.trunc(this.y),this.z=Math.trunc(this.z),this.w=Math.trunc(this.w),this}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this.w=-this.w,this}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z+this.w*t.w}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)+Math.abs(this.w)}normalize(){return this.divideScalar(this.length()||1)}setLength(t){return this.normalize().multiplyScalar(t)}lerp(t,e){return this.x+=(t.x-this.x)*e,this.y+=(t.y-this.y)*e,this.z+=(t.z-this.z)*e,this.w+=(t.w-this.w)*e,this}lerpVectors(t,e,r){return this.x=t.x+(e.x-t.x)*r,this.y=t.y+(e.y-t.y)*r,this.z=t.z+(e.z-t.z)*r,this.w=t.w+(e.w-t.w)*r,this}equals(t){return t.x===this.x&&t.y===this.y&&t.z===this.z&&t.w===this.w}fromArray(t,e=0){return this.x=t[e],this.y=t[e+1],this.z=t[e+2],this.w=t[e+3],this}toArray(t=[],e=0){return t[e]=this.x,t[e+1]=this.y,t[e+2]=this.z,t[e+3]=this.w,t}fromBufferAttribute(t,e){return this.x=t.getX(e),this.y=t.getY(e),this.z=t.getZ(e),this.w=t.getW(e),this}random(){return this.x=Math.random(),this.y=Math.random(),this.z=Math.random(),this.w=Math.random(),this}*[Symbol.iterator](){yield this.x,yield this.y,yield this.z,yield this.w}}class ay extends $n{constructor(t=1,e=1,r={}){super(),r=Object.assign({generateMipmaps:!1,internalFormat:null,minFilter:ta,depthBuffer:!0,stencilBuffer:!1,resolveDepthBuffer:!0,resolveStencilBuffer:!0,depthTexture:null,samples:0,count:1,depth:1,multiview:!1},r),this.isRenderTarget=!0,this.width=t,this.height=e,this.depth=r.depth,this.scissor=new er(0,0,t,e),this.scissorTest=!1,this.viewport=new er(0,0,t,e);const i={width:t,height:e,depth:r.depth},n=new rr(i);this.textures=[];const a=r.count;for(let o=0;o<a;o++)this.textures[o]=n.clone(),this.textures[o].isRenderTargetTexture=!0,this.textures[o].renderTarget=this;this._setTextureOptions(r),this.depthBuffer=r.depthBuffer,this.stencilBuffer=r.stencilBuffer,this.resolveDepthBuffer=r.resolveDepthBuffer,this.resolveStencilBuffer=r.resolveStencilBuffer,this._depthTexture=null,this.depthTexture=r.depthTexture,this.samples=r.samples,this.multiview=r.multiview}_setTextureOptions(t={}){const e={minFilter:ta,generateMipmaps:!1,flipY:!1,internalFormat:null};t.mapping!==void 0&&(e.mapping=t.mapping),t.wrapS!==void 0&&(e.wrapS=t.wrapS),t.wrapT!==void 0&&(e.wrapT=t.wrapT),t.wrapR!==void 0&&(e.wrapR=t.wrapR),t.magFilter!==void 0&&(e.magFilter=t.magFilter),t.minFilter!==void 0&&(e.minFilter=t.minFilter),t.format!==void 0&&(e.format=t.format),t.type!==void 0&&(e.type=t.type),t.anisotropy!==void 0&&(e.anisotropy=t.anisotropy),t.colorSpace!==void 0&&(e.colorSpace=t.colorSpace),t.flipY!==void 0&&(e.flipY=t.flipY),t.generateMipmaps!==void 0&&(e.generateMipmaps=t.generateMipmaps),t.internalFormat!==void 0&&(e.internalFormat=t.internalFormat);for(let r=0;r<this.textures.length;r++)this.textures[r].setValues(e)}get texture(){return this.textures[0]}set texture(t){this.textures[0]=t}set depthTexture(t){this._depthTexture!==null&&(this._depthTexture.renderTarget=null),t!==null&&(t.renderTarget=this),this._depthTexture=t}get depthTexture(){return this._depthTexture}setSize(t,e,r=1){if(this.width!==t||this.height!==e||this.depth!==r){this.width=t,this.height=e,this.depth=r;for(let i=0,n=this.textures.length;i<n;i++)this.textures[i].image.width=t,this.textures[i].image.height=e,this.textures[i].image.depth=r,this.textures[i].isArrayTexture=this.textures[i].image.depth>1;this.dispose()}this.viewport.set(0,0,t,e),this.scissor.set(0,0,t,e)}clone(){return new this.constructor().copy(this)}copy(t){this.width=t.width,this.height=t.height,this.depth=t.depth,this.scissor.copy(t.scissor),this.scissorTest=t.scissorTest,this.viewport.copy(t.viewport),this.textures.length=0;for(let e=0,r=t.textures.length;e<r;e++){this.textures[e]=t.textures[e].clone(),this.textures[e].isRenderTargetTexture=!0,this.textures[e].renderTarget=this;const i=Object.assign({},t.textures[e].image);this.textures[e].source=new jo(i)}return this.depthBuffer=t.depthBuffer,this.stencilBuffer=t.stencilBuffer,this.resolveDepthBuffer=t.resolveDepthBuffer,this.resolveStencilBuffer=t.resolveStencilBuffer,t.depthTexture!==null&&(this.depthTexture=t.depthTexture.clone()),this.samples=t.samples,this}dispose(){this.dispatchEvent({type:"dispose"})}}class oy extends ay{constructor(t=1,e=1,r={}){super(t,e,r),this.isWebGLRenderTarget=!0}}class x_ extends rr{constructor(t=null,e=1,r=1,i=1){super(null),this.isDataArrayTexture=!0,this.image={data:t,width:e,height:r,depth:i},this.magFilter=ai,this.minFilter=ai,this.wrapR=dn,this.generateMipmaps=!1,this.flipY=!1,this.unpackAlignment=1,this.layerUpdates=new Set}addLayerUpdate(t){this.layerUpdates.add(t)}clearLayerUpdates(){this.layerUpdates.clear()}}class g_ extends rr{constructor(t=null,e=1,r=1,i=1){super(null),this.isData3DTexture=!0,this.image={data:t,width:e,height:r,depth:i},this.magFilter=ai,this.minFilter=ai,this.wrapR=dn,this.generateMipmaps=!1,this.flipY=!1,this.unpackAlignment=1}}class Ci{constructor(t=new L(1/0,1/0,1/0),e=new L(-1/0,-1/0,-1/0)){this.isBox3=!0,this.min=t,this.max=e}set(t,e){return this.min.copy(t),this.max.copy(e),this}setFromArray(t){this.makeEmpty();for(let e=0,r=t.length;e<r;e+=3)this.expandByPoint(gr.fromArray(t,e));return this}setFromBufferAttribute(t){this.makeEmpty();for(let e=0,r=t.count;e<r;e++)this.expandByPoint(gr.fromBufferAttribute(t,e));return this}setFromPoints(t){this.makeEmpty();for(let e=0,r=t.length;e<r;e++)this.expandByPoint(t[e]);return this}setFromCenterAndSize(t,e){const r=gr.copy(e).multiplyScalar(.5);return this.min.copy(t).sub(r),this.max.copy(t).add(r),this}setFromObject(t,e=!1){return this.makeEmpty(),this.expandByObject(t,e)}clone(){return new this.constructor().copy(this)}copy(t){return this.min.copy(t.min),this.max.copy(t.max),this}makeEmpty(){return this.min.x=this.min.y=this.min.z=1/0,this.max.x=this.max.y=this.max.z=-1/0,this}isEmpty(){return this.max.x<this.min.x||this.max.y<this.min.y||this.max.z<this.min.z}getCenter(t){return this.isEmpty()?t.set(0,0,0):t.addVectors(this.min,this.max).multiplyScalar(.5)}getSize(t){return this.isEmpty()?t.set(0,0,0):t.subVectors(this.max,this.min)}expandByPoint(t){return this.min.min(t),this.max.max(t),this}expandByVector(t){return this.min.sub(t),this.max.add(t),this}expandByScalar(t){return this.min.addScalar(-t),this.max.addScalar(t),this}expandByObject(t,e=!1){t.updateWorldMatrix(!1,!1);const r=t.geometry;if(r!==void 0){const n=r.getAttribute("position");if(e===!0&&n!==void 0&&t.isInstancedMesh!==!0)for(let a=0,o=n.count;a<o;a++)t.isMesh===!0?t.getVertexPosition(a,gr):gr.fromBufferAttribute(n,a),gr.applyMatrix4(t.matrixWorld),this.expandByPoint(gr);else t.boundingBox!==void 0?(t.boundingBox===null&&t.computeBoundingBox(),ws.copy(t.boundingBox)):(r.boundingBox===null&&r.computeBoundingBox(),ws.copy(r.boundingBox)),ws.applyMatrix4(t.matrixWorld),this.union(ws)}const i=t.children;for(let n=0,a=i.length;n<a;n++)this.expandByObject(i[n],e);return this}containsPoint(t){return t.x>=this.min.x&&t.x<=this.max.x&&t.y>=this.min.y&&t.y<=this.max.y&&t.z>=this.min.z&&t.z<=this.max.z}containsBox(t){return this.min.x<=t.min.x&&t.max.x<=this.max.x&&this.min.y<=t.min.y&&t.max.y<=this.max.y&&this.min.z<=t.min.z&&t.max.z<=this.max.z}getParameter(t,e){return e.set((t.x-this.min.x)/(this.max.x-this.min.x),(t.y-this.min.y)/(this.max.y-this.min.y),(t.z-this.min.z)/(this.max.z-this.min.z))}intersectsBox(t){return t.max.x>=this.min.x&&t.min.x<=this.max.x&&t.max.y>=this.min.y&&t.min.y<=this.max.y&&t.max.z>=this.min.z&&t.min.z<=this.max.z}intersectsSphere(t){return this.clampPoint(t.center,gr),gr.distanceToSquared(t.center)<=t.radius*t.radius}intersectsPlane(t){let e,r;return t.normal.x>0?(e=t.normal.x*this.min.x,r=t.normal.x*this.max.x):(e=t.normal.x*this.max.x,r=t.normal.x*this.min.x),t.normal.y>0?(e+=t.normal.y*this.min.y,r+=t.normal.y*this.max.y):(e+=t.normal.y*this.max.y,r+=t.normal.y*this.min.y),t.normal.z>0?(e+=t.normal.z*this.min.z,r+=t.normal.z*this.max.z):(e+=t.normal.z*this.max.z,r+=t.normal.z*this.min.z),e<=-t.constant&&r>=-t.constant}intersectsTriangle(t){if(this.isEmpty())return!1;this.getCenter(Fn),Ms.subVectors(this.max,Fn),qi.subVectors(t.a,Fn),Ji.subVectors(t.b,Fn),Zi.subVectors(t.c,Fn),Zr.subVectors(Ji,qi),Kr.subVectors(Zi,Ji),Ei.subVectors(qi,Zi);let e=[0,-Zr.z,Zr.y,0,-Kr.z,Kr.y,0,-Ei.z,Ei.y,Zr.z,0,-Zr.x,Kr.z,0,-Kr.x,Ei.z,0,-Ei.x,-Zr.y,Zr.x,0,-Kr.y,Kr.x,0,-Ei.y,Ei.x,0];return!co(e,qi,Ji,Zi,Ms)||(e=[1,0,0,0,1,0,0,0,1],!co(e,qi,Ji,Zi,Ms))?!1:(Cs.crossVectors(Zr,Kr),e=[Cs.x,Cs.y,Cs.z],co(e,qi,Ji,Zi,Ms))}clampPoint(t,e){return e.copy(t).clamp(this.min,this.max)}distanceToPoint(t){return this.clampPoint(t,gr).distanceTo(t)}getBoundingSphere(t){return this.isEmpty()?t.makeEmpty():(this.getCenter(t.center),t.radius=this.getSize(gr).length()*.5),t}intersect(t){return this.min.max(t.min),this.max.min(t.max),this.isEmpty()&&this.makeEmpty(),this}union(t){return this.min.min(t.min),this.max.max(t.max),this}applyMatrix4(t){return this.isEmpty()?this:(Pr[0].set(this.min.x,this.min.y,this.min.z).applyMatrix4(t),Pr[1].set(this.min.x,this.min.y,this.max.z).applyMatrix4(t),Pr[2].set(this.min.x,this.max.y,this.min.z).applyMatrix4(t),Pr[3].set(this.min.x,this.max.y,this.max.z).applyMatrix4(t),Pr[4].set(this.max.x,this.min.y,this.min.z).applyMatrix4(t),Pr[5].set(this.max.x,this.min.y,this.max.z).applyMatrix4(t),Pr[6].set(this.max.x,this.max.y,this.min.z).applyMatrix4(t),Pr[7].set(this.max.x,this.max.y,this.max.z).applyMatrix4(t),this.setFromPoints(Pr),this)}translate(t){return this.min.add(t),this.max.add(t),this}equals(t){return t.min.equals(this.min)&&t.max.equals(this.max)}toJSON(){return{min:this.min.toArray(),max:this.max.toArray()}}fromJSON(t){return this.min.fromArray(t.min),this.max.fromArray(t.max),this}}const Pr=[new L,new L,new L,new L,new L,new L,new L,new L],gr=new L,ws=new Ci,qi=new L,Ji=new L,Zi=new L,Zr=new L,Kr=new L,Ei=new L,Fn=new L,Ms=new L,Cs=new L,Ai=new L;function co(s,t,e,r,i){for(let n=0,a=s.length-3;n<=a;n+=3){Ai.fromArray(s,n);const o=i.x*Math.abs(Ai.x)+i.y*Math.abs(Ai.y)+i.z*Math.abs(Ai.z),c=t.dot(Ai),h=e.dot(Ai),u=r.dot(Ai);if(Math.max(-Math.max(c,h,u),Math.min(c,h,u))>o)return!1}return!0}const ly=new Ci,Pn=new L,ho=new L;class Ii{constructor(t=new L,e=-1){this.isSphere=!0,this.center=t,this.radius=e}set(t,e){return this.center.copy(t),this.radius=e,this}setFromPoints(t,e){const r=this.center;e!==void 0?r.copy(e):ly.setFromPoints(t).getCenter(r);let i=0;for(let n=0,a=t.length;n<a;n++)i=Math.max(i,r.distanceToSquared(t[n]));return this.radius=Math.sqrt(i),this}copy(t){return this.center.copy(t.center),this.radius=t.radius,this}isEmpty(){return this.radius<0}makeEmpty(){return this.center.set(0,0,0),this.radius=-1,this}containsPoint(t){return t.distanceToSquared(this.center)<=this.radius*this.radius}distanceToPoint(t){return t.distanceTo(this.center)-this.radius}intersectsSphere(t){const e=this.radius+t.radius;return t.center.distanceToSquared(this.center)<=e*e}intersectsBox(t){return t.intersectsSphere(this)}intersectsPlane(t){return Math.abs(t.distanceToPoint(this.center))<=this.radius}clampPoint(t,e){const r=this.center.distanceToSquared(t);return e.copy(t),r>this.radius*this.radius&&(e.sub(this.center).normalize(),e.multiplyScalar(this.radius).add(this.center)),e}getBoundingBox(t){return this.isEmpty()?(t.makeEmpty(),t):(t.set(this.center,this.center),t.expandByScalar(this.radius),t)}applyMatrix4(t){return this.center.applyMatrix4(t),this.radius=this.radius*t.getMaxScaleOnAxis(),this}translate(t){return this.center.add(t),this}expandByPoint(t){if(this.isEmpty())return this.center.copy(t),this.radius=0,this;Pn.subVectors(t,this.center);const e=Pn.lengthSq();if(e>this.radius*this.radius){const r=Math.sqrt(e),i=(r-this.radius)*.5;this.center.addScaledVector(Pn,i/r),this.radius+=i}return this}union(t){return t.isEmpty()?this:this.isEmpty()?(this.copy(t),this):(this.center.equals(t.center)===!0?this.radius=Math.max(this.radius,t.radius):(ho.subVectors(t.center,this.center).setLength(t.radius),this.expandByPoint(Pn.copy(t.center).add(ho)),this.expandByPoint(Pn.copy(t.center).sub(ho))),this)}equals(t){return t.center.equals(this.center)&&t.radius===this.radius}clone(){return new this.constructor().copy(this)}toJSON(){return{radius:this.radius,center:this.center.toArray()}}fromJSON(t){return this.radius=t.radius,this.center.fromArray(t.center),this}}const Br=new L,uo=new L,Is=new L,Qr=new L,fo=new L,Rs=new L,mo=new L;class Ho{constructor(t=new L,e=new L(0,0,-1)){this.origin=t,this.direction=e}set(t,e){return this.origin.copy(t),this.direction.copy(e),this}copy(t){return this.origin.copy(t.origin),this.direction.copy(t.direction),this}at(t,e){return e.copy(this.origin).addScaledVector(this.direction,t)}lookAt(t){return this.direction.copy(t).sub(this.origin).normalize(),this}recast(t){return this.origin.copy(this.at(t,Br)),this}closestPointToPoint(t,e){e.subVectors(t,this.origin);const r=e.dot(this.direction);return r<0?e.copy(this.origin):e.copy(this.origin).addScaledVector(this.direction,r)}distanceToPoint(t){return Math.sqrt(this.distanceSqToPoint(t))}distanceSqToPoint(t){const e=Br.subVectors(t,this.origin).dot(this.direction);return e<0?this.origin.distanceToSquared(t):(Br.copy(this.origin).addScaledVector(this.direction,e),Br.distanceToSquared(t))}distanceSqToSegment(t,e,r,i){uo.copy(t).add(e).multiplyScalar(.5),Is.copy(e).sub(t).normalize(),Qr.copy(this.origin).sub(uo);const n=t.distanceTo(e)*.5,a=-this.direction.dot(Is),o=Qr.dot(this.direction),c=-Qr.dot(Is),h=Qr.lengthSq(),u=Math.abs(1-a*a);let d,y,g,A;if(u>0)if(d=a*c-o,y=a*o-c,A=n*u,d>=0)if(y>=-A)if(y<=A){const D=1/u;d*=D,y*=D,g=d*(d+a*y+2*o)+y*(a*d+y+2*c)+h}else y=n,d=Math.max(0,-(a*y+o)),g=-d*d+y*(y+2*c)+h;else y=-n,d=Math.max(0,-(a*y+o)),g=-d*d+y*(y+2*c)+h;else y<=-A?(d=Math.max(0,-(-a*n+o)),y=d>0?-n:Math.min(Math.max(-n,-c),n),g=-d*d+y*(y+2*c)+h):y<=A?(d=0,y=Math.min(Math.max(-n,-c),n),g=y*(y+2*c)+h):(d=Math.max(0,-(a*n+o)),y=d>0?n:Math.min(Math.max(-n,-c),n),g=-d*d+y*(y+2*c)+h);else y=a>0?-n:n,d=Math.max(0,-(a*y+o)),g=-d*d+y*(y+2*c)+h;return r&&r.copy(this.origin).addScaledVector(this.direction,d),i&&i.copy(uo).addScaledVector(Is,y),g}intersectSphere(t,e){Br.subVectors(t.center,this.origin);const r=Br.dot(this.direction),i=Br.dot(Br)-r*r,n=t.radius*t.radius;if(i>n)return null;const a=Math.sqrt(n-i),o=r-a,c=r+a;return c<0?null:o<0?this.at(c,e):this.at(o,e)}intersectsSphere(t){return t.radius<0?!1:this.distanceSqToPoint(t.center)<=t.radius*t.radius}distanceToPlane(t){const e=t.normal.dot(this.direction);if(e===0)return t.distanceToPoint(this.origin)===0?0:null;const r=-(this.origin.dot(t.normal)+t.constant)/e;return r>=0?r:null}intersectPlane(t,e){const r=this.distanceToPlane(t);return r===null?null:this.at(r,e)}intersectsPlane(t){const e=t.distanceToPoint(this.origin);return e===0||t.normal.dot(this.direction)*e<0}intersectBox(t,e){let r,i,n,a,o,c;const h=1/this.direction.x,u=1/this.direction.y,d=1/this.direction.z,y=this.origin;return h>=0?(r=(t.min.x-y.x)*h,i=(t.max.x-y.x)*h):(r=(t.max.x-y.x)*h,i=(t.min.x-y.x)*h),u>=0?(n=(t.min.y-y.y)*u,a=(t.max.y-y.y)*u):(n=(t.max.y-y.y)*u,a=(t.min.y-y.y)*u),r>a||n>i||((n>r||isNaN(r))&&(r=n),(a<i||isNaN(i))&&(i=a),d>=0?(o=(t.min.z-y.z)*d,c=(t.max.z-y.z)*d):(o=(t.max.z-y.z)*d,c=(t.min.z-y.z)*d),r>c||o>i)||((o>r||r!==r)&&(r=o),(c<i||i!==i)&&(i=c),i<0)?null:this.at(r>=0?r:i,e)}intersectsBox(t){return this.intersectBox(t,Br)!==null}intersectTriangle(t,e,r,i,n){fo.subVectors(e,t),Rs.subVectors(r,t),mo.crossVectors(fo,Rs);let a=this.direction.dot(mo),o;if(a>0){if(i)return null;o=1}else if(a<0)o=-1,a=-a;else return null;Qr.subVectors(this.origin,t);const c=o*this.direction.dot(Rs.crossVectors(Qr,Rs));if(c<0)return null;const h=o*this.direction.dot(fo.cross(Qr));if(h<0||c+h>a)return null;const u=-o*Qr.dot(mo);return u<0?null:this.at(u/a,n)}applyMatrix4(t){return this.origin.applyMatrix4(t),this.direction.transformDirection(t),this}equals(t){return t.origin.equals(this.origin)&&t.direction.equals(this.direction)}clone(){return new this.constructor().copy(this)}}class we{constructor(t,e,r,i,n,a,o,c,h,u,d,y,g,A,D,H){we.prototype.isMatrix4=!0,this.elements=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],t!==void 0&&this.set(t,e,r,i,n,a,o,c,h,u,d,y,g,A,D,H)}set(t,e,r,i,n,a,o,c,h,u,d,y,g,A,D,H){const V=this.elements;return V[0]=t,V[4]=e,V[8]=r,V[12]=i,V[1]=n,V[5]=a,V[9]=o,V[13]=c,V[2]=h,V[6]=u,V[10]=d,V[14]=y,V[3]=g,V[7]=A,V[11]=D,V[15]=H,this}identity(){return this.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this}clone(){return new we().fromArray(this.elements)}copy(t){const e=this.elements,r=t.elements;return e[0]=r[0],e[1]=r[1],e[2]=r[2],e[3]=r[3],e[4]=r[4],e[5]=r[5],e[6]=r[6],e[7]=r[7],e[8]=r[8],e[9]=r[9],e[10]=r[10],e[11]=r[11],e[12]=r[12],e[13]=r[13],e[14]=r[14],e[15]=r[15],this}copyPosition(t){const e=this.elements,r=t.elements;return e[12]=r[12],e[13]=r[13],e[14]=r[14],this}setFromMatrix3(t){const e=t.elements;return this.set(e[0],e[3],e[6],0,e[1],e[4],e[7],0,e[2],e[5],e[8],0,0,0,0,1),this}extractBasis(t,e,r){return t.setFromMatrixColumn(this,0),e.setFromMatrixColumn(this,1),r.setFromMatrixColumn(this,2),this}makeBasis(t,e,r){return this.set(t.x,e.x,r.x,0,t.y,e.y,r.y,0,t.z,e.z,r.z,0,0,0,0,1),this}extractRotation(t){const e=this.elements,r=t.elements,i=1/Ki.setFromMatrixColumn(t,0).length(),n=1/Ki.setFromMatrixColumn(t,1).length(),a=1/Ki.setFromMatrixColumn(t,2).length();return e[0]=r[0]*i,e[1]=r[1]*i,e[2]=r[2]*i,e[3]=0,e[4]=r[4]*n,e[5]=r[5]*n,e[6]=r[6]*n,e[7]=0,e[8]=r[8]*a,e[9]=r[9]*a,e[10]=r[10]*a,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,this}makeRotationFromEuler(t){const e=this.elements,r=t.x,i=t.y,n=t.z,a=Math.cos(r),o=Math.sin(r),c=Math.cos(i),h=Math.sin(i),u=Math.cos(n),d=Math.sin(n);if(t.order==="XYZ"){const y=a*u,g=a*d,A=o*u,D=o*d;e[0]=c*u,e[4]=-c*d,e[8]=h,e[1]=g+A*h,e[5]=y-D*h,e[9]=-o*c,e[2]=D-y*h,e[6]=A+g*h,e[10]=a*c}else if(t.order==="YXZ"){const y=c*u,g=c*d,A=h*u,D=h*d;e[0]=y+D*o,e[4]=A*o-g,e[8]=a*h,e[1]=a*d,e[5]=a*u,e[9]=-o,e[2]=g*o-A,e[6]=D+y*o,e[10]=a*c}else if(t.order==="ZXY"){const y=c*u,g=c*d,A=h*u,D=h*d;e[0]=y-D*o,e[4]=-a*d,e[8]=A+g*o,e[1]=g+A*o,e[5]=a*u,e[9]=D-y*o,e[2]=-a*h,e[6]=o,e[10]=a*c}else if(t.order==="ZYX"){const y=a*u,g=a*d,A=o*u,D=o*d;e[0]=c*u,e[4]=A*h-g,e[8]=y*h+D,e[1]=c*d,e[5]=D*h+y,e[9]=g*h-A,e[2]=-h,e[6]=o*c,e[10]=a*c}else if(t.order==="YZX"){const y=a*c,g=a*h,A=o*c,D=o*h;e[0]=c*u,e[4]=D-y*d,e[8]=A*d+g,e[1]=d,e[5]=a*u,e[9]=-o*u,e[2]=-h*u,e[6]=g*d+A,e[10]=y-D*d}else if(t.order==="XZY"){const y=a*c,g=a*h,A=o*c,D=o*h;e[0]=c*u,e[4]=-d,e[8]=h*u,e[1]=y*d+D,e[5]=a*u,e[9]=g*d-A,e[2]=A*d-g,e[6]=o*u,e[10]=D*d+y}return e[3]=0,e[7]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,this}makeRotationFromQuaternion(t){return this.compose(cy,t,hy)}lookAt(t,e,r){const i=this.elements;return or.subVectors(t,e),or.lengthSq()===0&&(or.z=1),or.normalize(),ti.crossVectors(r,or),ti.lengthSq()===0&&(Math.abs(r.z)===1?or.x+=1e-4:or.z+=1e-4,or.normalize(),ti.crossVectors(r,or)),ti.normalize(),Os.crossVectors(or,ti),i[0]=ti.x,i[4]=Os.x,i[8]=or.x,i[1]=ti.y,i[5]=Os.y,i[9]=or.y,i[2]=ti.z,i[6]=Os.z,i[10]=or.z,this}multiply(t){return this.multiplyMatrices(this,t)}premultiply(t){return this.multiplyMatrices(t,this)}multiplyMatrices(t,e){const r=t.elements,i=e.elements,n=this.elements,a=r[0],o=r[4],c=r[8],h=r[12],u=r[1],d=r[5],y=r[9],g=r[13],A=r[2],D=r[6],H=r[10],V=r[14],Tt=r[3],ft=r[7],ct=r[11],Mt=r[15],Dt=i[0],Et=i[4],St=i[8],Xt=i[12],Ht=i[1],se=i[5],Ut=i[9],Yt=i[13],ae=i[2],me=i[6],ce=i[10],Me=i[14],ge=i[3],ee=i[7],Gt=i[11],te=i[15];return n[0]=a*Dt+o*Ht+c*ae+h*ge,n[4]=a*Et+o*se+c*me+h*ee,n[8]=a*St+o*Ut+c*ce+h*Gt,n[12]=a*Xt+o*Yt+c*Me+h*te,n[1]=u*Dt+d*Ht+y*ae+g*ge,n[5]=u*Et+d*se+y*me+g*ee,n[9]=u*St+d*Ut+y*ce+g*Gt,n[13]=u*Xt+d*Yt+y*Me+g*te,n[2]=A*Dt+D*Ht+H*ae+V*ge,n[6]=A*Et+D*se+H*me+V*ee,n[10]=A*St+D*Ut+H*ce+V*Gt,n[14]=A*Xt+D*Yt+H*Me+V*te,n[3]=Tt*Dt+ft*Ht+ct*ae+Mt*ge,n[7]=Tt*Et+ft*se+ct*me+Mt*ee,n[11]=Tt*St+ft*Ut+ct*ce+Mt*Gt,n[15]=Tt*Xt+ft*Yt+ct*Me+Mt*te,this}multiplyScalar(t){const e=this.elements;return e[0]*=t,e[4]*=t,e[8]*=t,e[12]*=t,e[1]*=t,e[5]*=t,e[9]*=t,e[13]*=t,e[2]*=t,e[6]*=t,e[10]*=t,e[14]*=t,e[3]*=t,e[7]*=t,e[11]*=t,e[15]*=t,this}determinant(){const t=this.elements,e=t[0],r=t[4],i=t[8],n=t[12],a=t[1],o=t[5],c=t[9],h=t[13],u=t[2],d=t[6],y=t[10],g=t[14],A=t[3],D=t[7],H=t[11],V=t[15];return A*(+n*c*d-i*h*d-n*o*y+r*h*y+i*o*g-r*c*g)+D*(+e*c*g-e*h*y+n*a*y-i*a*g+i*h*u-n*c*u)+H*(+e*h*d-e*o*g-n*a*d+r*a*g+n*o*u-r*h*u)+V*(-i*o*u-e*c*d+e*o*y+i*a*d-r*a*y+r*c*u)}transpose(){const t=this.elements;let e;return e=t[1],t[1]=t[4],t[4]=e,e=t[2],t[2]=t[8],t[8]=e,e=t[6],t[6]=t[9],t[9]=e,e=t[3],t[3]=t[12],t[12]=e,e=t[7],t[7]=t[13],t[13]=e,e=t[11],t[11]=t[14],t[14]=e,this}setPosition(t,e,r){const i=this.elements;return t.isVector3?(i[12]=t.x,i[13]=t.y,i[14]=t.z):(i[12]=t,i[13]=e,i[14]=r),this}invert(){const t=this.elements,e=t[0],r=t[1],i=t[2],n=t[3],a=t[4],o=t[5],c=t[6],h=t[7],u=t[8],d=t[9],y=t[10],g=t[11],A=t[12],D=t[13],H=t[14],V=t[15],Tt=d*H*h-D*y*h+D*c*g-o*H*g-d*c*V+o*y*V,ft=A*y*h-u*H*h-A*c*g+a*H*g+u*c*V-a*y*V,ct=u*D*h-A*d*h+A*o*g-a*D*g-u*o*V+a*d*V,Mt=A*d*c-u*D*c-A*o*y+a*D*y+u*o*H-a*d*H,Dt=e*Tt+r*ft+i*ct+n*Mt;if(Dt===0)return this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);const Et=1/Dt;return t[0]=Tt*Et,t[1]=(D*y*n-d*H*n-D*i*g+r*H*g+d*i*V-r*y*V)*Et,t[2]=(o*H*n-D*c*n+D*i*h-r*H*h-o*i*V+r*c*V)*Et,t[3]=(d*c*n-o*y*n-d*i*h+r*y*h+o*i*g-r*c*g)*Et,t[4]=ft*Et,t[5]=(u*H*n-A*y*n+A*i*g-e*H*g-u*i*V+e*y*V)*Et,t[6]=(A*c*n-a*H*n-A*i*h+e*H*h+a*i*V-e*c*V)*Et,t[7]=(a*y*n-u*c*n+u*i*h-e*y*h-a*i*g+e*c*g)*Et,t[8]=ct*Et,t[9]=(A*d*n-u*D*n-A*r*g+e*D*g+u*r*V-e*d*V)*Et,t[10]=(a*D*n-A*o*n+A*r*h-e*D*h-a*r*V+e*o*V)*Et,t[11]=(u*o*n-a*d*n-u*r*h+e*d*h+a*r*g-e*o*g)*Et,t[12]=Mt*Et,t[13]=(u*D*i-A*d*i+A*r*y-e*D*y-u*r*H+e*d*H)*Et,t[14]=(A*o*i-a*D*i-A*r*c+e*D*c+a*r*H-e*o*H)*Et,t[15]=(a*d*i-u*o*i+u*r*c-e*d*c-a*r*y+e*o*y)*Et,this}scale(t){const e=this.elements,r=t.x,i=t.y,n=t.z;return e[0]*=r,e[4]*=i,e[8]*=n,e[1]*=r,e[5]*=i,e[9]*=n,e[2]*=r,e[6]*=i,e[10]*=n,e[3]*=r,e[7]*=i,e[11]*=n,this}getMaxScaleOnAxis(){const t=this.elements,e=t[0]*t[0]+t[1]*t[1]+t[2]*t[2],r=t[4]*t[4]+t[5]*t[5]+t[6]*t[6],i=t[8]*t[8]+t[9]*t[9]+t[10]*t[10];return Math.sqrt(Math.max(e,r,i))}makeTranslation(t,e,r){return t.isVector3?this.set(1,0,0,t.x,0,1,0,t.y,0,0,1,t.z,0,0,0,1):this.set(1,0,0,t,0,1,0,e,0,0,1,r,0,0,0,1),this}makeRotationX(t){const e=Math.cos(t),r=Math.sin(t);return this.set(1,0,0,0,0,e,-r,0,0,r,e,0,0,0,0,1),this}makeRotationY(t){const e=Math.cos(t),r=Math.sin(t);return this.set(e,0,r,0,0,1,0,0,-r,0,e,0,0,0,0,1),this}makeRotationZ(t){const e=Math.cos(t),r=Math.sin(t);return this.set(e,-r,0,0,r,e,0,0,0,0,1,0,0,0,0,1),this}makeRotationAxis(t,e){const r=Math.cos(e),i=Math.sin(e),n=1-r,a=t.x,o=t.y,c=t.z,h=n*a,u=n*o;return this.set(h*a+r,h*o-i*c,h*c+i*o,0,h*o+i*c,u*o+r,u*c-i*a,0,h*c-i*o,u*c+i*a,n*c*c+r,0,0,0,0,1),this}makeScale(t,e,r){return this.set(t,0,0,0,0,e,0,0,0,0,r,0,0,0,0,1),this}makeShear(t,e,r,i,n,a){return this.set(1,r,n,0,t,1,a,0,e,i,1,0,0,0,0,1),this}compose(t,e,r){const i=this.elements,n=e._x,a=e._y,o=e._z,c=e._w,h=n+n,u=a+a,d=o+o,y=n*h,g=n*u,A=n*d,D=a*u,H=a*d,V=o*d,Tt=c*h,ft=c*u,ct=c*d,Mt=r.x,Dt=r.y,Et=r.z;return i[0]=(1-(D+V))*Mt,i[1]=(g+ct)*Mt,i[2]=(A-ft)*Mt,i[3]=0,i[4]=(g-ct)*Dt,i[5]=(1-(y+V))*Dt,i[6]=(H+Tt)*Dt,i[7]=0,i[8]=(A+ft)*Et,i[9]=(H-Tt)*Et,i[10]=(1-(y+D))*Et,i[11]=0,i[12]=t.x,i[13]=t.y,i[14]=t.z,i[15]=1,this}decompose(t,e,r){const i=this.elements;let n=Ki.set(i[0],i[1],i[2]).length();const a=Ki.set(i[4],i[5],i[6]).length(),o=Ki.set(i[8],i[9],i[10]).length();this.determinant()<0&&(n=-n),t.x=i[12],t.y=i[13],t.z=i[14],_r.copy(this);const h=1/n,u=1/a,d=1/o;return _r.elements[0]*=h,_r.elements[1]*=h,_r.elements[2]*=h,_r.elements[4]*=u,_r.elements[5]*=u,_r.elements[6]*=u,_r.elements[8]*=d,_r.elements[9]*=d,_r.elements[10]*=d,e.setFromRotationMatrix(_r),r.x=n,r.y=a,r.z=o,this}makePerspective(t,e,r,i,n,a,o=ni){const c=this.elements,h=2*n/(e-t),u=2*n/(r-i),d=(e+t)/(e-t),y=(r+i)/(r-i);let g,A;if(o===ni)g=-(a+n)/(a-n),A=-2*a*n/(a-n);else if(o===ea)g=-a/(a-n),A=-a*n/(a-n);else throw new Error("THREE.Matrix4.makePerspective(): Invalid coordinate system: "+o);return c[0]=h,c[4]=0,c[8]=d,c[12]=0,c[1]=0,c[5]=u,c[9]=y,c[13]=0,c[2]=0,c[6]=0,c[10]=g,c[14]=A,c[3]=0,c[7]=0,c[11]=-1,c[15]=0,this}makeOrthographic(t,e,r,i,n,a,o=ni){const c=this.elements,h=1/(e-t),u=1/(r-i),d=1/(a-n),y=(e+t)*h,g=(r+i)*u;let A,D;if(o===ni)A=(a+n)*d,D=-2*d;else if(o===ea)A=n*d,D=-1*d;else throw new Error("THREE.Matrix4.makeOrthographic(): Invalid coordinate system: "+o);return c[0]=2*h,c[4]=0,c[8]=0,c[12]=-y,c[1]=0,c[5]=2*u,c[9]=0,c[13]=-g,c[2]=0,c[6]=0,c[10]=D,c[14]=-A,c[3]=0,c[7]=0,c[11]=0,c[15]=1,this}equals(t){const e=this.elements,r=t.elements;for(let i=0;i<16;i++)if(e[i]!==r[i])return!1;return!0}fromArray(t,e=0){for(let r=0;r<16;r++)this.elements[r]=t[r+e];return this}toArray(t=[],e=0){const r=this.elements;return t[e]=r[0],t[e+1]=r[1],t[e+2]=r[2],t[e+3]=r[3],t[e+4]=r[4],t[e+5]=r[5],t[e+6]=r[6],t[e+7]=r[7],t[e+8]=r[8],t[e+9]=r[9],t[e+10]=r[10],t[e+11]=r[11],t[e+12]=r[12],t[e+13]=r[13],t[e+14]=r[14],t[e+15]=r[15],t}}const Ki=new L,_r=new we,cy=new L(0,0,0),hy=new L(1,1,1),ti=new L,Os=new L,or=new L,ou=new we,lu=new qn;class oi{constructor(t=0,e=0,r=0,i=oi.DEFAULT_ORDER){this.isEuler=!0,this._x=t,this._y=e,this._z=r,this._order=i}get x(){return this._x}set x(t){this._x=t,this._onChangeCallback()}get y(){return this._y}set y(t){this._y=t,this._onChangeCallback()}get z(){return this._z}set z(t){this._z=t,this._onChangeCallback()}get order(){return this._order}set order(t){this._order=t,this._onChangeCallback()}set(t,e,r,i=this._order){return this._x=t,this._y=e,this._z=r,this._order=i,this._onChangeCallback(),this}clone(){return new this.constructor(this._x,this._y,this._z,this._order)}copy(t){return this._x=t._x,this._y=t._y,this._z=t._z,this._order=t._order,this._onChangeCallback(),this}setFromRotationMatrix(t,e=this._order,r=!0){const i=t.elements,n=i[0],a=i[4],o=i[8],c=i[1],h=i[5],u=i[9],d=i[2],y=i[6],g=i[10];switch(e){case"XYZ":this._y=Math.asin(ne(o,-1,1)),Math.abs(o)<.9999999?(this._x=Math.atan2(-u,g),this._z=Math.atan2(-a,n)):(this._x=Math.atan2(y,h),this._z=0);break;case"YXZ":this._x=Math.asin(-ne(u,-1,1)),Math.abs(u)<.9999999?(this._y=Math.atan2(o,g),this._z=Math.atan2(c,h)):(this._y=Math.atan2(-d,n),this._z=0);break;case"ZXY":this._x=Math.asin(ne(y,-1,1)),Math.abs(y)<.9999999?(this._y=Math.atan2(-d,g),this._z=Math.atan2(-a,h)):(this._y=0,this._z=Math.atan2(c,n));break;case"ZYX":this._y=Math.asin(-ne(d,-1,1)),Math.abs(d)<.9999999?(this._x=Math.atan2(y,g),this._z=Math.atan2(c,n)):(this._x=0,this._z=Math.atan2(-a,h));break;case"YZX":this._z=Math.asin(ne(c,-1,1)),Math.abs(c)<.9999999?(this._x=Math.atan2(-u,h),this._y=Math.atan2(-d,n)):(this._x=0,this._y=Math.atan2(o,g));break;case"XZY":this._z=Math.asin(-ne(a,-1,1)),Math.abs(a)<.9999999?(this._x=Math.atan2(y,h),this._y=Math.atan2(o,n)):(this._x=Math.atan2(-u,g),this._y=0);break;default:console.warn("THREE.Euler: .setFromRotationMatrix() encountered an unknown order: "+e)}return this._order=e,r===!0&&this._onChangeCallback(),this}setFromQuaternion(t,e,r){return ou.makeRotationFromQuaternion(t),this.setFromRotationMatrix(ou,e,r)}setFromVector3(t,e=this._order){return this.set(t.x,t.y,t.z,e)}reorder(t){return lu.setFromEuler(this),this.setFromQuaternion(lu,t)}equals(t){return t._x===this._x&&t._y===this._y&&t._z===this._z&&t._order===this._order}fromArray(t){return this._x=t[0],this._y=t[1],this._z=t[2],t[3]!==void 0&&(this._order=t[3]),this._onChangeCallback(),this}toArray(t=[],e=0){return t[e]=this._x,t[e+1]=this._y,t[e+2]=this._z,t[e+3]=this._order,t}_onChange(t){return this._onChangeCallback=t,this}_onChangeCallback(){}*[Symbol.iterator](){yield this._x,yield this._y,yield this._z,yield this._order}}oi.DEFAULT_ORDER="XYZ";class uy{constructor(){this.mask=1}set(t){this.mask=(1<<t|0)>>>0}enable(t){this.mask|=1<<t|0}enableAll(){this.mask=-1}toggle(t){this.mask^=1<<t|0}disable(t){this.mask&=~(1<<t|0)}disableAll(){this.mask=0}test(t){return(this.mask&t.mask)!==0}isEnabled(t){return(this.mask&(1<<t|0))!==0}}let fy=0;const cu=new L,Qi=new qn,kr=new we,Ns=new L,Bn=new L,dy=new L,my=new qn,hu=new L(1,0,0),uu=new L(0,1,0),fu=new L(0,0,1),du={type:"added"},py={type:"removed"},tn={type:"childadded",child:null},po={type:"childremoved",child:null};class Ye extends $n{constructor(){super(),this.isObject3D=!0,Object.defineProperty(this,"id",{value:fy++}),this.uuid=pn(),this.name="",this.type="Object3D",this.parent=null,this.children=[],this.up=Ye.DEFAULT_UP.clone();const t=new L,e=new oi,r=new qn,i=new L(1,1,1);function n(){r.setFromEuler(e,!1)}function a(){e.setFromQuaternion(r,void 0,!1)}e._onChange(n),r._onChange(a),Object.defineProperties(this,{position:{configurable:!0,enumerable:!0,value:t},rotation:{configurable:!0,enumerable:!0,value:e},quaternion:{configurable:!0,enumerable:!0,value:r},scale:{configurable:!0,enumerable:!0,value:i},modelViewMatrix:{value:new we},normalMatrix:{value:new Vr}}),this.matrix=new we,this.matrixWorld=new we,this.matrixAutoUpdate=Ye.DEFAULT_MATRIX_AUTO_UPDATE,this.matrixWorldAutoUpdate=Ye.DEFAULT_MATRIX_WORLD_AUTO_UPDATE,this.matrixWorldNeedsUpdate=!1,this.layers=new uy,this.visible=!0,this.castShadow=!1,this.receiveShadow=!1,this.frustumCulled=!0,this.renderOrder=0,this.animations=[],this.customDepthMaterial=void 0,this.customDistanceMaterial=void 0,this.userData={}}onBeforeShadow(){}onAfterShadow(){}onBeforeRender(){}onAfterRender(){}applyMatrix4(t){this.matrixAutoUpdate&&this.updateMatrix(),this.matrix.premultiply(t),this.matrix.decompose(this.position,this.quaternion,this.scale)}applyQuaternion(t){return this.quaternion.premultiply(t),this}setRotationFromAxisAngle(t,e){this.quaternion.setFromAxisAngle(t,e)}setRotationFromEuler(t){this.quaternion.setFromEuler(t,!0)}setRotationFromMatrix(t){this.quaternion.setFromRotationMatrix(t)}setRotationFromQuaternion(t){this.quaternion.copy(t)}rotateOnAxis(t,e){return Qi.setFromAxisAngle(t,e),this.quaternion.multiply(Qi),this}rotateOnWorldAxis(t,e){return Qi.setFromAxisAngle(t,e),this.quaternion.premultiply(Qi),this}rotateX(t){return this.rotateOnAxis(hu,t)}rotateY(t){return this.rotateOnAxis(uu,t)}rotateZ(t){return this.rotateOnAxis(fu,t)}translateOnAxis(t,e){return cu.copy(t).applyQuaternion(this.quaternion),this.position.add(cu.multiplyScalar(e)),this}translateX(t){return this.translateOnAxis(hu,t)}translateY(t){return this.translateOnAxis(uu,t)}translateZ(t){return this.translateOnAxis(fu,t)}localToWorld(t){return this.updateWorldMatrix(!0,!1),t.applyMatrix4(this.matrixWorld)}worldToLocal(t){return this.updateWorldMatrix(!0,!1),t.applyMatrix4(kr.copy(this.matrixWorld).invert())}lookAt(t,e,r){t.isVector3?Ns.copy(t):Ns.set(t,e,r);const i=this.parent;this.updateWorldMatrix(!0,!1),Bn.setFromMatrixPosition(this.matrixWorld),this.isCamera||this.isLight?kr.lookAt(Bn,Ns,this.up):kr.lookAt(Ns,Bn,this.up),this.quaternion.setFromRotationMatrix(kr),i&&(kr.extractRotation(i.matrixWorld),Qi.setFromRotationMatrix(kr),this.quaternion.premultiply(Qi.invert()))}add(t){if(arguments.length>1){for(let e=0;e<arguments.length;e++)this.add(arguments[e]);return this}return t===this?(console.error("THREE.Object3D.add: object can't be added as a child of itself.",t),this):(t&&t.isObject3D?(t.removeFromParent(),t.parent=this,this.children.push(t),t.dispatchEvent(du),tn.child=t,this.dispatchEvent(tn),tn.child=null):console.error("THREE.Object3D.add: object not an instance of THREE.Object3D.",t),this)}remove(t){if(arguments.length>1){for(let r=0;r<arguments.length;r++)this.remove(arguments[r]);return this}const e=this.children.indexOf(t);return e!==-1&&(t.parent=null,this.children.splice(e,1),t.dispatchEvent(py),po.child=t,this.dispatchEvent(po),po.child=null),this}removeFromParent(){const t=this.parent;return t!==null&&t.remove(this),this}clear(){return this.remove(...this.children)}attach(t){return this.updateWorldMatrix(!0,!1),kr.copy(this.matrixWorld).invert(),t.parent!==null&&(t.parent.updateWorldMatrix(!0,!1),kr.multiply(t.parent.matrixWorld)),t.applyMatrix4(kr),t.removeFromParent(),t.parent=this,this.children.push(t),t.updateWorldMatrix(!1,!0),t.dispatchEvent(du),tn.child=t,this.dispatchEvent(tn),tn.child=null,this}getObjectById(t){return this.getObjectByProperty("id",t)}getObjectByName(t){return this.getObjectByProperty("name",t)}getObjectByProperty(t,e){if(this[t]===e)return this;for(let r=0,i=this.children.length;r<i;r++){const a=this.children[r].getObjectByProperty(t,e);if(a!==void 0)return a}}getObjectsByProperty(t,e,r=[]){this[t]===e&&r.push(this);const i=this.children;for(let n=0,a=i.length;n<a;n++)i[n].getObjectsByProperty(t,e,r);return r}getWorldPosition(t){return this.updateWorldMatrix(!0,!1),t.setFromMatrixPosition(this.matrixWorld)}getWorldQuaternion(t){return this.updateWorldMatrix(!0,!1),this.matrixWorld.decompose(Bn,t,dy),t}getWorldScale(t){return this.updateWorldMatrix(!0,!1),this.matrixWorld.decompose(Bn,my,t),t}getWorldDirection(t){this.updateWorldMatrix(!0,!1);const e=this.matrixWorld.elements;return t.set(e[8],e[9],e[10]).normalize()}raycast(){}traverse(t){t(this);const e=this.children;for(let r=0,i=e.length;r<i;r++)e[r].traverse(t)}traverseVisible(t){if(this.visible===!1)return;t(this);const e=this.children;for(let r=0,i=e.length;r<i;r++)e[r].traverseVisible(t)}traverseAncestors(t){const e=this.parent;e!==null&&(t(e),e.traverseAncestors(t))}updateMatrix(){this.matrix.compose(this.position,this.quaternion,this.scale),this.matrixWorldNeedsUpdate=!0}updateMatrixWorld(t){this.matrixAutoUpdate&&this.updateMatrix(),(this.matrixWorldNeedsUpdate||t)&&(this.matrixWorldAutoUpdate===!0&&(this.parent===null?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix)),this.matrixWorldNeedsUpdate=!1,t=!0);const e=this.children;for(let r=0,i=e.length;r<i;r++)e[r].updateMatrixWorld(t)}updateWorldMatrix(t,e){const r=this.parent;if(t===!0&&r!==null&&r.updateWorldMatrix(!0,!1),this.matrixAutoUpdate&&this.updateMatrix(),this.matrixWorldAutoUpdate===!0&&(this.parent===null?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix)),e===!0){const i=this.children;for(let n=0,a=i.length;n<a;n++)i[n].updateWorldMatrix(!1,!0)}}toJSON(t){const e=t===void 0||typeof t=="string",r={};e&&(t={geometries:{},materials:{},textures:{},images:{},shapes:{},skeletons:{},animations:{},nodes:{}},r.metadata={version:4.7,type:"Object",generator:"Object3D.toJSON"});const i={};i.uuid=this.uuid,i.type=this.type,this.name!==""&&(i.name=this.name),this.castShadow===!0&&(i.castShadow=!0),this.receiveShadow===!0&&(i.receiveShadow=!0),this.visible===!1&&(i.visible=!1),this.frustumCulled===!1&&(i.frustumCulled=!1),this.renderOrder!==0&&(i.renderOrder=this.renderOrder),Object.keys(this.userData).length>0&&(i.userData=this.userData),i.layers=this.layers.mask,i.matrix=this.matrix.toArray(),i.up=this.up.toArray(),this.matrixAutoUpdate===!1&&(i.matrixAutoUpdate=!1),this.isInstancedMesh&&(i.type="InstancedMesh",i.count=this.count,i.instanceMatrix=this.instanceMatrix.toJSON(),this.instanceColor!==null&&(i.instanceColor=this.instanceColor.toJSON())),this.isBatchedMesh&&(i.type="BatchedMesh",i.perObjectFrustumCulled=this.perObjectFrustumCulled,i.sortObjects=this.sortObjects,i.drawRanges=this._drawRanges,i.reservedRanges=this._reservedRanges,i.geometryInfo=this._geometryInfo.map(o=>({...o,boundingBox:o.boundingBox?o.boundingBox.toJSON():void 0,boundingSphere:o.boundingSphere?o.boundingSphere.toJSON():void 0})),i.instanceInfo=this._instanceInfo.map(o=>({...o})),i.availableInstanceIds=this._availableInstanceIds.slice(),i.availableGeometryIds=this._availableGeometryIds.slice(),i.nextIndexStart=this._nextIndexStart,i.nextVertexStart=this._nextVertexStart,i.geometryCount=this._geometryCount,i.maxInstanceCount=this._maxInstanceCount,i.maxVertexCount=this._maxVertexCount,i.maxIndexCount=this._maxIndexCount,i.geometryInitialized=this._geometryInitialized,i.matricesTexture=this._matricesTexture.toJSON(t),i.indirectTexture=this._indirectTexture.toJSON(t),this._colorsTexture!==null&&(i.colorsTexture=this._colorsTexture.toJSON(t)),this.boundingSphere!==null&&(i.boundingSphere=this.boundingSphere.toJSON()),this.boundingBox!==null&&(i.boundingBox=this.boundingBox.toJSON()));function n(o,c){return o[c.uuid]===void 0&&(o[c.uuid]=c.toJSON(t)),c.uuid}if(this.isScene)this.background&&(this.background.isColor?i.background=this.background.toJSON():this.background.isTexture&&(i.background=this.background.toJSON(t).uuid)),this.environment&&this.environment.isTexture&&this.environment.isRenderTargetTexture!==!0&&(i.environment=this.environment.toJSON(t).uuid);else if(this.isMesh||this.isLine||this.isPoints){i.geometry=n(t.geometries,this.geometry);const o=this.geometry.parameters;if(o!==void 0&&o.shapes!==void 0){const c=o.shapes;if(Array.isArray(c))for(let h=0,u=c.length;h<u;h++){const d=c[h];n(t.shapes,d)}else n(t.shapes,c)}}if(this.isSkinnedMesh&&(i.bindMode=this.bindMode,i.bindMatrix=this.bindMatrix.toArray(),this.skeleton!==void 0&&(n(t.skeletons,this.skeleton),i.skeleton=this.skeleton.uuid)),this.material!==void 0)if(Array.isArray(this.material)){const o=[];for(let c=0,h=this.material.length;c<h;c++)o.push(n(t.materials,this.material[c]));i.material=o}else i.material=n(t.materials,this.material);if(this.children.length>0){i.children=[];for(let o=0;o<this.children.length;o++)i.children.push(this.children[o].toJSON(t).object)}if(this.animations.length>0){i.animations=[];for(let o=0;o<this.animations.length;o++){const c=this.animations[o];i.animations.push(n(t.animations,c))}}if(e){const o=a(t.geometries),c=a(t.materials),h=a(t.textures),u=a(t.images),d=a(t.shapes),y=a(t.skeletons),g=a(t.animations),A=a(t.nodes);o.length>0&&(r.geometries=o),c.length>0&&(r.materials=c),h.length>0&&(r.textures=h),u.length>0&&(r.images=u),d.length>0&&(r.shapes=d),y.length>0&&(r.skeletons=y),g.length>0&&(r.animations=g),A.length>0&&(r.nodes=A)}return r.object=i,r;function a(o){const c=[];for(const h in o){const u=o[h];delete u.metadata,c.push(u)}return c}}clone(t){return new this.constructor().copy(this,t)}copy(t,e=!0){if(this.name=t.name,this.up.copy(t.up),this.position.copy(t.position),this.rotation.order=t.rotation.order,this.quaternion.copy(t.quaternion),this.scale.copy(t.scale),this.matrix.copy(t.matrix),this.matrixWorld.copy(t.matrixWorld),this.matrixAutoUpdate=t.matrixAutoUpdate,this.matrixWorldAutoUpdate=t.matrixWorldAutoUpdate,this.matrixWorldNeedsUpdate=t.matrixWorldNeedsUpdate,this.layers.mask=t.layers.mask,this.visible=t.visible,this.castShadow=t.castShadow,this.receiveShadow=t.receiveShadow,this.frustumCulled=t.frustumCulled,this.renderOrder=t.renderOrder,this.animations=t.animations.slice(),this.userData=JSON.parse(JSON.stringify(t.userData)),e===!0)for(let r=0;r<t.children.length;r++){const i=t.children[r];this.add(i.clone())}return this}}Ye.DEFAULT_UP=new L(0,1,0);Ye.DEFAULT_MATRIX_AUTO_UPDATE=!0;Ye.DEFAULT_MATRIX_WORLD_AUTO_UPDATE=!0;const br=new L,zr=new L,yo=new L,Ur=new L,en=new L,rn=new L,mu=new L,xo=new L,go=new L,_o=new L,bo=new er,vo=new er,Eo=new er;class Er{constructor(t=new L,e=new L,r=new L){this.a=t,this.b=e,this.c=r}static getNormal(t,e,r,i){i.subVectors(r,e),br.subVectors(t,e),i.cross(br);const n=i.lengthSq();return n>0?i.multiplyScalar(1/Math.sqrt(n)):i.set(0,0,0)}static getBarycoord(t,e,r,i,n){br.subVectors(i,e),zr.subVectors(r,e),yo.subVectors(t,e);const a=br.dot(br),o=br.dot(zr),c=br.dot(yo),h=zr.dot(zr),u=zr.dot(yo),d=a*h-o*o;if(d===0)return n.set(0,0,0),null;const y=1/d,g=(h*c-o*u)*y,A=(a*u-o*c)*y;return n.set(1-g-A,A,g)}static containsPoint(t,e,r,i){return this.getBarycoord(t,e,r,i,Ur)===null?!1:Ur.x>=0&&Ur.y>=0&&Ur.x+Ur.y<=1}static getInterpolation(t,e,r,i,n,a,o,c){return this.getBarycoord(t,e,r,i,Ur)===null?(c.x=0,c.y=0,"z"in c&&(c.z=0),"w"in c&&(c.w=0),null):(c.setScalar(0),c.addScaledVector(n,Ur.x),c.addScaledVector(a,Ur.y),c.addScaledVector(o,Ur.z),c)}static getInterpolatedAttribute(t,e,r,i,n,a){return bo.setScalar(0),vo.setScalar(0),Eo.setScalar(0),bo.fromBufferAttribute(t,e),vo.fromBufferAttribute(t,r),Eo.fromBufferAttribute(t,i),a.setScalar(0),a.addScaledVector(bo,n.x),a.addScaledVector(vo,n.y),a.addScaledVector(Eo,n.z),a}static isFrontFacing(t,e,r,i){return br.subVectors(r,e),zr.subVectors(t,e),br.cross(zr).dot(i)<0}set(t,e,r){return this.a.copy(t),this.b.copy(e),this.c.copy(r),this}setFromPointsAndIndices(t,e,r,i){return this.a.copy(t[e]),this.b.copy(t[r]),this.c.copy(t[i]),this}setFromAttributeAndIndices(t,e,r,i){return this.a.fromBufferAttribute(t,e),this.b.fromBufferAttribute(t,r),this.c.fromBufferAttribute(t,i),this}clone(){return new this.constructor().copy(this)}copy(t){return this.a.copy(t.a),this.b.copy(t.b),this.c.copy(t.c),this}getArea(){return br.subVectors(this.c,this.b),zr.subVectors(this.a,this.b),br.cross(zr).length()*.5}getMidpoint(t){return t.addVectors(this.a,this.b).add(this.c).multiplyScalar(1/3)}getNormal(t){return Er.getNormal(this.a,this.b,this.c,t)}getPlane(t){return t.setFromCoplanarPoints(this.a,this.b,this.c)}getBarycoord(t,e){return Er.getBarycoord(t,this.a,this.b,this.c,e)}getInterpolation(t,e,r,i,n){return Er.getInterpolation(t,this.a,this.b,this.c,e,r,i,n)}containsPoint(t){return Er.containsPoint(t,this.a,this.b,this.c)}isFrontFacing(t){return Er.isFrontFacing(this.a,this.b,this.c,t)}intersectsBox(t){return t.intersectsTriangle(this)}closestPointToPoint(t,e){const r=this.a,i=this.b,n=this.c;let a,o;en.subVectors(i,r),rn.subVectors(n,r),xo.subVectors(t,r);const c=en.dot(xo),h=rn.dot(xo);if(c<=0&&h<=0)return e.copy(r);go.subVectors(t,i);const u=en.dot(go),d=rn.dot(go);if(u>=0&&d<=u)return e.copy(i);const y=c*d-u*h;if(y<=0&&c>=0&&u<=0)return a=c/(c-u),e.copy(r).addScaledVector(en,a);_o.subVectors(t,n);const g=en.dot(_o),A=rn.dot(_o);if(A>=0&&g<=A)return e.copy(n);const D=g*h-c*A;if(D<=0&&h>=0&&A<=0)return o=h/(h-A),e.copy(r).addScaledVector(rn,o);const H=u*A-g*d;if(H<=0&&d-u>=0&&g-A>=0)return mu.subVectors(n,i),o=(d-u)/(d-u+(g-A)),e.copy(i).addScaledVector(mu,o);const V=1/(H+D+y);return a=D*V,o=y*V,e.copy(r).addScaledVector(en,a).addScaledVector(rn,o)}equals(t){return t.a.equals(this.a)&&t.b.equals(this.b)&&t.c.equals(this.c)}}const ef={aliceblue:15792383,antiquewhite:16444375,aqua:65535,aquamarine:8388564,azure:15794175,beige:16119260,bisque:16770244,black:0,blanchedalmond:16772045,blue:255,blueviolet:9055202,brown:10824234,burlywood:14596231,cadetblue:6266528,chartreuse:8388352,chocolate:13789470,coral:16744272,cornflowerblue:6591981,cornsilk:16775388,crimson:14423100,cyan:65535,darkblue:139,darkcyan:35723,darkgoldenrod:12092939,darkgray:11119017,darkgreen:25600,darkgrey:11119017,darkkhaki:12433259,darkmagenta:9109643,darkolivegreen:5597999,darkorange:16747520,darkorchid:10040012,darkred:9109504,darksalmon:15308410,darkseagreen:9419919,darkslateblue:4734347,darkslategray:3100495,darkslategrey:3100495,darkturquoise:52945,darkviolet:9699539,deeppink:16716947,deepskyblue:49151,dimgray:6908265,dimgrey:6908265,dodgerblue:2003199,firebrick:11674146,floralwhite:16775920,forestgreen:2263842,fuchsia:16711935,gainsboro:14474460,ghostwhite:16316671,gold:16766720,goldenrod:14329120,gray:8421504,green:32768,greenyellow:11403055,grey:8421504,honeydew:15794160,hotpink:16738740,indianred:13458524,indigo:4915330,ivory:16777200,khaki:15787660,lavender:15132410,lavenderblush:16773365,lawngreen:8190976,lemonchiffon:16775885,lightblue:11393254,lightcoral:15761536,lightcyan:14745599,lightgoldenrodyellow:16448210,lightgray:13882323,lightgreen:9498256,lightgrey:13882323,lightpink:16758465,lightsalmon:16752762,lightseagreen:2142890,lightskyblue:8900346,lightslategray:7833753,lightslategrey:7833753,lightsteelblue:11584734,lightyellow:16777184,lime:65280,limegreen:3329330,linen:16445670,magenta:16711935,maroon:8388608,mediumaquamarine:6737322,mediumblue:205,mediumorchid:12211667,mediumpurple:9662683,mediumseagreen:3978097,mediumslateblue:8087790,mediumspringgreen:64154,mediumturquoise:4772300,mediumvioletred:13047173,midnightblue:1644912,mintcream:16121850,mistyrose:16770273,moccasin:16770229,navajowhite:16768685,navy:128,oldlace:16643558,olive:8421376,olivedrab:7048739,orange:16753920,orangered:16729344,orchid:14315734,palegoldenrod:15657130,palegreen:10025880,paleturquoise:11529966,palevioletred:14381203,papayawhip:16773077,peachpuff:16767673,peru:13468991,pink:16761035,plum:14524637,powderblue:11591910,purple:8388736,rebeccapurple:6697881,red:16711680,rosybrown:12357519,royalblue:4286945,saddlebrown:9127187,salmon:16416882,sandybrown:16032864,seagreen:3050327,seashell:16774638,sienna:10506797,silver:12632256,skyblue:8900331,slateblue:6970061,slategray:7372944,slategrey:7372944,snow:16775930,springgreen:65407,steelblue:4620980,tan:13808780,teal:32896,thistle:14204888,tomato:16737095,turquoise:4251856,violet:15631086,wheat:16113331,white:16777215,whitesmoke:16119285,yellow:16776960,yellowgreen:10145074},ei={h:0,s:0,l:0},Ls={h:0,s:0,l:0};function Ao(s,t,e){return e<0&&(e+=1),e>1&&(e-=1),e<1/6?s+(t-s)*6*e:e<1/2?t:e<2/3?s+(t-s)*6*(2/3-e):s}class Ar{constructor(t,e,r){return this.isColor=!0,this.r=1,this.g=1,this.b=1,this.set(t,e,r)}set(t,e,r){if(e===void 0&&r===void 0){const i=t;i&&i.isColor?this.copy(i):typeof i=="number"?this.setHex(i):typeof i=="string"&&this.setStyle(i)}else this.setRGB(t,e,r);return this}setScalar(t){return this.r=t,this.g=t,this.b=t,this}setHex(t,e=vr){return t=Math.floor(t),this.r=(t>>16&255)/255,this.g=(t>>8&255)/255,this.b=(t&255)/255,dr.colorSpaceToWorking(this,e),this}setRGB(t,e,r,i=dr.workingColorSpace){return this.r=t,this.g=e,this.b=r,dr.colorSpaceToWorking(this,i),this}setHSL(t,e,r,i=dr.workingColorSpace){if(t=Vo(t,1),e=ne(e,0,1),r=ne(r,0,1),e===0)this.r=this.g=this.b=r;else{const n=r<=.5?r*(1+e):r+e-r*e,a=2*r-n;this.r=Ao(a,n,t+1/3),this.g=Ao(a,n,t),this.b=Ao(a,n,t-1/3)}return dr.colorSpaceToWorking(this,i),this}setStyle(t,e=vr){function r(n){n!==void 0&&parseFloat(n)<1&&console.warn("THREE.Color: Alpha component of "+t+" will be ignored.")}let i;if(i=/^(\w+)\(([^\)]*)\)/.exec(t)){let n;const a=i[1],o=i[2];switch(a){case"rgb":case"rgba":if(n=/^\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(o))return r(n[4]),this.setRGB(Math.min(255,parseInt(n[1],10))/255,Math.min(255,parseInt(n[2],10))/255,Math.min(255,parseInt(n[3],10))/255,e);if(n=/^\s*(\d+)\%\s*,\s*(\d+)\%\s*,\s*(\d+)\%\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(o))return r(n[4]),this.setRGB(Math.min(100,parseInt(n[1],10))/100,Math.min(100,parseInt(n[2],10))/100,Math.min(100,parseInt(n[3],10))/100,e);break;case"hsl":case"hsla":if(n=/^\s*(\d*\.?\d+)\s*,\s*(\d*\.?\d+)\%\s*,\s*(\d*\.?\d+)\%\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(o))return r(n[4]),this.setHSL(parseFloat(n[1])/360,parseFloat(n[2])/100,parseFloat(n[3])/100,e);break;default:console.warn("THREE.Color: Unknown color model "+t)}}else if(i=/^\#([A-Fa-f\d]+)$/.exec(t)){const n=i[1],a=n.length;if(a===3)return this.setRGB(parseInt(n.charAt(0),16)/15,parseInt(n.charAt(1),16)/15,parseInt(n.charAt(2),16)/15,e);if(a===6)return this.setHex(parseInt(n,16),e);console.warn("THREE.Color: Invalid hex color "+t)}else if(t&&t.length>0)return this.setColorName(t,e);return this}setColorName(t,e=vr){const r=ef[t.toLowerCase()];return r!==void 0?this.setHex(r,e):console.warn("THREE.Color: Unknown color "+t),this}clone(){return new this.constructor(this.r,this.g,this.b)}copy(t){return this.r=t.r,this.g=t.g,this.b=t.b,this}copySRGBToLinear(t){return this.r=Gr(t.r),this.g=Gr(t.g),this.b=Gr(t.b),this}copyLinearToSRGB(t){return this.r=mn(t.r),this.g=mn(t.g),this.b=mn(t.b),this}convertSRGBToLinear(){return this.copySRGBToLinear(this),this}convertLinearToSRGB(){return this.copyLinearToSRGB(this),this}getHex(t=vr){return dr.workingToColorSpace(qe.copy(this),t),Math.round(ne(qe.r*255,0,255))*65536+Math.round(ne(qe.g*255,0,255))*256+Math.round(ne(qe.b*255,0,255))}getHexString(t=vr){return("000000"+this.getHex(t).toString(16)).slice(-6)}getHSL(t,e=dr.workingColorSpace){dr.workingToColorSpace(qe.copy(this),e);const r=qe.r,i=qe.g,n=qe.b,a=Math.max(r,i,n),o=Math.min(r,i,n);let c,h;const u=(o+a)/2;if(o===a)c=0,h=0;else{const d=a-o;switch(h=u<=.5?d/(a+o):d/(2-a-o),a){case r:c=(i-n)/d+(i<n?6:0);break;case i:c=(n-r)/d+2;break;case n:c=(r-i)/d+4;break}c/=6}return t.h=c,t.s=h,t.l=u,t}getRGB(t,e=dr.workingColorSpace){return dr.workingToColorSpace(qe.copy(this),e),t.r=qe.r,t.g=qe.g,t.b=qe.b,t}getStyle(t=vr){dr.workingToColorSpace(qe.copy(this),t);const e=qe.r,r=qe.g,i=qe.b;return t!==vr?`color(${t} ${e.toFixed(3)} ${r.toFixed(3)} ${i.toFixed(3)})`:`rgb(${Math.round(e*255)},${Math.round(r*255)},${Math.round(i*255)})`}offsetHSL(t,e,r){return this.getHSL(ei),this.setHSL(ei.h+t,ei.s+e,ei.l+r)}add(t){return this.r+=t.r,this.g+=t.g,this.b+=t.b,this}addColors(t,e){return this.r=t.r+e.r,this.g=t.g+e.g,this.b=t.b+e.b,this}addScalar(t){return this.r+=t,this.g+=t,this.b+=t,this}sub(t){return this.r=Math.max(0,this.r-t.r),this.g=Math.max(0,this.g-t.g),this.b=Math.max(0,this.b-t.b),this}multiply(t){return this.r*=t.r,this.g*=t.g,this.b*=t.b,this}multiplyScalar(t){return this.r*=t,this.g*=t,this.b*=t,this}lerp(t,e){return this.r+=(t.r-this.r)*e,this.g+=(t.g-this.g)*e,this.b+=(t.b-this.b)*e,this}lerpColors(t,e,r){return this.r=t.r+(e.r-t.r)*r,this.g=t.g+(e.g-t.g)*r,this.b=t.b+(e.b-t.b)*r,this}lerpHSL(t,e){this.getHSL(ei),t.getHSL(Ls);const r=Wn(ei.h,Ls.h,e),i=Wn(ei.s,Ls.s,e),n=Wn(ei.l,Ls.l,e);return this.setHSL(r,i,n),this}setFromVector3(t){return this.r=t.x,this.g=t.y,this.b=t.z,this}applyMatrix3(t){const e=this.r,r=this.g,i=this.b,n=t.elements;return this.r=n[0]*e+n[3]*r+n[6]*i,this.g=n[1]*e+n[4]*r+n[7]*i,this.b=n[2]*e+n[5]*r+n[8]*i,this}equals(t){return t.r===this.r&&t.g===this.g&&t.b===this.b}fromArray(t,e=0){return this.r=t[e],this.g=t[e+1],this.b=t[e+2],this}toArray(t=[],e=0){return t[e]=this.r,t[e+1]=this.g,t[e+2]=this.b,t}fromBufferAttribute(t,e){return this.r=t.getX(e),this.g=t.getY(e),this.b=t.getZ(e),this}toJSON(){return this.getHex()}*[Symbol.iterator](){yield this.r,yield this.g,yield this.b}}const qe=new Ar;Ar.NAMES=ef;let yy=0;class Ri extends $n{constructor(){super(),this.isMaterial=!0,Object.defineProperty(this,"id",{value:yy++}),this.uuid=pn(),this.name="",this.type="Material",this.blending=jh,this.side=ko,this.vertexColors=!1,this.opacity=1,this.transparent=!1,this.alphaHash=!1,this.blendSrc=Wh,this.blendDst=Yh,this.blendEquation=Hh,this.blendSrcAlpha=null,this.blendDstAlpha=null,this.blendEquationAlpha=null,this.blendColor=new Ar(0,0,0),this.blendAlpha=0,this.depthFunc=Xh,this.depthTest=!0,this.depthWrite=!0,this.stencilWriteMask=255,this.stencilFunc=Qh,this.stencilRef=0,this.stencilFuncMask=255,this.stencilFail=Xi,this.stencilZFail=Xi,this.stencilZPass=Xi,this.stencilWrite=!1,this.clippingPlanes=null,this.clipIntersection=!1,this.clipShadows=!1,this.shadowSide=null,this.colorWrite=!0,this.precision=null,this.polygonOffset=!1,this.polygonOffsetFactor=0,this.polygonOffsetUnits=0,this.dithering=!1,this.alphaToCoverage=!1,this.premultipliedAlpha=!1,this.forceSinglePass=!1,this.allowOverride=!0,this.visible=!0,this.toneMapped=!0,this.userData={},this.version=0,this._alphaTest=0}get alphaTest(){return this._alphaTest}set alphaTest(t){this._alphaTest>0!=t>0&&this.version++,this._alphaTest=t}onBeforeRender(){}onBeforeCompile(){}customProgramCacheKey(){return this.onBeforeCompile.toString()}setValues(t){if(t!==void 0)for(const e in t){const r=t[e];if(r===void 0){console.warn(`THREE.Material: parameter '${e}' has value of undefined.`);continue}const i=this[e];if(i===void 0){console.warn(`THREE.Material: '${e}' is not a property of THREE.${this.type}.`);continue}i&&i.isColor?i.set(r):i&&i.isVector3&&r&&r.isVector3?i.copy(r):this[e]=r}}toJSON(t){const e=t===void 0||typeof t=="string";e&&(t={textures:{},images:{}});const r={metadata:{version:4.7,type:"Material",generator:"Material.toJSON"}};r.uuid=this.uuid,r.type=this.type,this.name!==""&&(r.name=this.name),this.color&&this.color.isColor&&(r.color=this.color.getHex()),this.roughness!==void 0&&(r.roughness=this.roughness),this.metalness!==void 0&&(r.metalness=this.metalness),this.sheen!==void 0&&(r.sheen=this.sheen),this.sheenColor&&this.sheenColor.isColor&&(r.sheenColor=this.sheenColor.getHex()),this.sheenRoughness!==void 0&&(r.sheenRoughness=this.sheenRoughness),this.emissive&&this.emissive.isColor&&(r.emissive=this.emissive.getHex()),this.emissiveIntensity!==void 0&&this.emissiveIntensity!==1&&(r.emissiveIntensity=this.emissiveIntensity),this.specular&&this.specular.isColor&&(r.specular=this.specular.getHex()),this.specularIntensity!==void 0&&(r.specularIntensity=this.specularIntensity),this.specularColor&&this.specularColor.isColor&&(r.specularColor=this.specularColor.getHex()),this.shininess!==void 0&&(r.shininess=this.shininess),this.clearcoat!==void 0&&(r.clearcoat=this.clearcoat),this.clearcoatRoughness!==void 0&&(r.clearcoatRoughness=this.clearcoatRoughness),this.clearcoatMap&&this.clearcoatMap.isTexture&&(r.clearcoatMap=this.clearcoatMap.toJSON(t).uuid),this.clearcoatRoughnessMap&&this.clearcoatRoughnessMap.isTexture&&(r.clearcoatRoughnessMap=this.clearcoatRoughnessMap.toJSON(t).uuid),this.clearcoatNormalMap&&this.clearcoatNormalMap.isTexture&&(r.clearcoatNormalMap=this.clearcoatNormalMap.toJSON(t).uuid,r.clearcoatNormalScale=this.clearcoatNormalScale.toArray()),this.dispersion!==void 0&&(r.dispersion=this.dispersion),this.iridescence!==void 0&&(r.iridescence=this.iridescence),this.iridescenceIOR!==void 0&&(r.iridescenceIOR=this.iridescenceIOR),this.iridescenceThicknessRange!==void 0&&(r.iridescenceThicknessRange=this.iridescenceThicknessRange),this.iridescenceMap&&this.iridescenceMap.isTexture&&(r.iridescenceMap=this.iridescenceMap.toJSON(t).uuid),this.iridescenceThicknessMap&&this.iridescenceThicknessMap.isTexture&&(r.iridescenceThicknessMap=this.iridescenceThicknessMap.toJSON(t).uuid),this.anisotropy!==void 0&&(r.anisotropy=this.anisotropy),this.anisotropyRotation!==void 0&&(r.anisotropyRotation=this.anisotropyRotation),this.anisotropyMap&&this.anisotropyMap.isTexture&&(r.anisotropyMap=this.anisotropyMap.toJSON(t).uuid),this.map&&this.map.isTexture&&(r.map=this.map.toJSON(t).uuid),this.matcap&&this.matcap.isTexture&&(r.matcap=this.matcap.toJSON(t).uuid),this.alphaMap&&this.alphaMap.isTexture&&(r.alphaMap=this.alphaMap.toJSON(t).uuid),this.lightMap&&this.lightMap.isTexture&&(r.lightMap=this.lightMap.toJSON(t).uuid,r.lightMapIntensity=this.lightMapIntensity),this.aoMap&&this.aoMap.isTexture&&(r.aoMap=this.aoMap.toJSON(t).uuid,r.aoMapIntensity=this.aoMapIntensity),this.bumpMap&&this.bumpMap.isTexture&&(r.bumpMap=this.bumpMap.toJSON(t).uuid,r.bumpScale=this.bumpScale),this.normalMap&&this.normalMap.isTexture&&(r.normalMap=this.normalMap.toJSON(t).uuid,r.normalMapType=this.normalMapType,r.normalScale=this.normalScale.toArray()),this.displacementMap&&this.displacementMap.isTexture&&(r.displacementMap=this.displacementMap.toJSON(t).uuid,r.displacementScale=this.displacementScale,r.displacementBias=this.displacementBias),this.roughnessMap&&this.roughnessMap.isTexture&&(r.roughnessMap=this.roughnessMap.toJSON(t).uuid),this.metalnessMap&&this.metalnessMap.isTexture&&(r.metalnessMap=this.metalnessMap.toJSON(t).uuid),this.emissiveMap&&this.emissiveMap.isTexture&&(r.emissiveMap=this.emissiveMap.toJSON(t).uuid),this.specularMap&&this.specularMap.isTexture&&(r.specularMap=this.specularMap.toJSON(t).uuid),this.specularIntensityMap&&this.specularIntensityMap.isTexture&&(r.specularIntensityMap=this.specularIntensityMap.toJSON(t).uuid),this.specularColorMap&&this.specularColorMap.isTexture&&(r.specularColorMap=this.specularColorMap.toJSON(t).uuid),this.envMap&&this.envMap.isTexture&&(r.envMap=this.envMap.toJSON(t).uuid,this.combine!==void 0&&(r.combine=this.combine)),this.envMapRotation!==void 0&&(r.envMapRotation=this.envMapRotation.toArray()),this.envMapIntensity!==void 0&&(r.envMapIntensity=this.envMapIntensity),this.reflectivity!==void 0&&(r.reflectivity=this.reflectivity),this.refractionRatio!==void 0&&(r.refractionRatio=this.refractionRatio),this.gradientMap&&this.gradientMap.isTexture&&(r.gradientMap=this.gradientMap.toJSON(t).uuid),this.transmission!==void 0&&(r.transmission=this.transmission),this.transmissionMap&&this.transmissionMap.isTexture&&(r.transmissionMap=this.transmissionMap.toJSON(t).uuid),this.thickness!==void 0&&(r.thickness=this.thickness),this.thicknessMap&&this.thicknessMap.isTexture&&(r.thicknessMap=this.thicknessMap.toJSON(t).uuid),this.attenuationDistance!==void 0&&this.attenuationDistance!==1/0&&(r.attenuationDistance=this.attenuationDistance),this.attenuationColor!==void 0&&(r.attenuationColor=this.attenuationColor.getHex()),this.size!==void 0&&(r.size=this.size),this.shadowSide!==null&&(r.shadowSide=this.shadowSide),this.sizeAttenuation!==void 0&&(r.sizeAttenuation=this.sizeAttenuation),this.blending!==jh&&(r.blending=this.blending),this.side!==ko&&(r.side=this.side),this.vertexColors===!0&&(r.vertexColors=!0),this.opacity<1&&(r.opacity=this.opacity),this.transparent===!0&&(r.transparent=!0),this.blendSrc!==Wh&&(r.blendSrc=this.blendSrc),this.blendDst!==Yh&&(r.blendDst=this.blendDst),this.blendEquation!==Hh&&(r.blendEquation=this.blendEquation),this.blendSrcAlpha!==null&&(r.blendSrcAlpha=this.blendSrcAlpha),this.blendDstAlpha!==null&&(r.blendDstAlpha=this.blendDstAlpha),this.blendEquationAlpha!==null&&(r.blendEquationAlpha=this.blendEquationAlpha),this.blendColor&&this.blendColor.isColor&&(r.blendColor=this.blendColor.getHex()),this.blendAlpha!==0&&(r.blendAlpha=this.blendAlpha),this.depthFunc!==Xh&&(r.depthFunc=this.depthFunc),this.depthTest===!1&&(r.depthTest=this.depthTest),this.depthWrite===!1&&(r.depthWrite=this.depthWrite),this.colorWrite===!1&&(r.colorWrite=this.colorWrite),this.stencilWriteMask!==255&&(r.stencilWriteMask=this.stencilWriteMask),this.stencilFunc!==Qh&&(r.stencilFunc=this.stencilFunc),this.stencilRef!==0&&(r.stencilRef=this.stencilRef),this.stencilFuncMask!==255&&(r.stencilFuncMask=this.stencilFuncMask),this.stencilFail!==Xi&&(r.stencilFail=this.stencilFail),this.stencilZFail!==Xi&&(r.stencilZFail=this.stencilZFail),this.stencilZPass!==Xi&&(r.stencilZPass=this.stencilZPass),this.stencilWrite===!0&&(r.stencilWrite=this.stencilWrite),this.rotation!==void 0&&this.rotation!==0&&(r.rotation=this.rotation),this.polygonOffset===!0&&(r.polygonOffset=!0),this.polygonOffsetFactor!==0&&(r.polygonOffsetFactor=this.polygonOffsetFactor),this.polygonOffsetUnits!==0&&(r.polygonOffsetUnits=this.polygonOffsetUnits),this.linewidth!==void 0&&this.linewidth!==1&&(r.linewidth=this.linewidth),this.dashSize!==void 0&&(r.dashSize=this.dashSize),this.gapSize!==void 0&&(r.gapSize=this.gapSize),this.scale!==void 0&&(r.scale=this.scale),this.dithering===!0&&(r.dithering=!0),this.alphaTest>0&&(r.alphaTest=this.alphaTest),this.alphaHash===!0&&(r.alphaHash=!0),this.alphaToCoverage===!0&&(r.alphaToCoverage=!0),this.premultipliedAlpha===!0&&(r.premultipliedAlpha=!0),this.forceSinglePass===!0&&(r.forceSinglePass=!0),this.wireframe===!0&&(r.wireframe=!0),this.wireframeLinewidth>1&&(r.wireframeLinewidth=this.wireframeLinewidth),this.wireframeLinecap!=="round"&&(r.wireframeLinecap=this.wireframeLinecap),this.wireframeLinejoin!=="round"&&(r.wireframeLinejoin=this.wireframeLinejoin),this.flatShading===!0&&(r.flatShading=!0),this.visible===!1&&(r.visible=!1),this.toneMapped===!1&&(r.toneMapped=!1),this.fog===!1&&(r.fog=!1),Object.keys(this.userData).length>0&&(r.userData=this.userData);function i(n){const a=[];for(const o in n){const c=n[o];delete c.metadata,a.push(c)}return a}if(e){const n=i(t.textures),a=i(t.images);n.length>0&&(r.textures=n),a.length>0&&(r.images=a)}return r}clone(){return new this.constructor().copy(this)}copy(t){this.name=t.name,this.blending=t.blending,this.side=t.side,this.vertexColors=t.vertexColors,this.opacity=t.opacity,this.transparent=t.transparent,this.blendSrc=t.blendSrc,this.blendDst=t.blendDst,this.blendEquation=t.blendEquation,this.blendSrcAlpha=t.blendSrcAlpha,this.blendDstAlpha=t.blendDstAlpha,this.blendEquationAlpha=t.blendEquationAlpha,this.blendColor.copy(t.blendColor),this.blendAlpha=t.blendAlpha,this.depthFunc=t.depthFunc,this.depthTest=t.depthTest,this.depthWrite=t.depthWrite,this.stencilWriteMask=t.stencilWriteMask,this.stencilFunc=t.stencilFunc,this.stencilRef=t.stencilRef,this.stencilFuncMask=t.stencilFuncMask,this.stencilFail=t.stencilFail,this.stencilZFail=t.stencilZFail,this.stencilZPass=t.stencilZPass,this.stencilWrite=t.stencilWrite;const e=t.clippingPlanes;let r=null;if(e!==null){const i=e.length;r=new Array(i);for(let n=0;n!==i;++n)r[n]=e[n].clone()}return this.clippingPlanes=r,this.clipIntersection=t.clipIntersection,this.clipShadows=t.clipShadows,this.shadowSide=t.shadowSide,this.colorWrite=t.colorWrite,this.precision=t.precision,this.polygonOffset=t.polygonOffset,this.polygonOffsetFactor=t.polygonOffsetFactor,this.polygonOffsetUnits=t.polygonOffsetUnits,this.dithering=t.dithering,this.alphaTest=t.alphaTest,this.alphaHash=t.alphaHash,this.alphaToCoverage=t.alphaToCoverage,this.premultipliedAlpha=t.premultipliedAlpha,this.forceSinglePass=t.forceSinglePass,this.visible=t.visible,this.toneMapped=t.toneMapped,this.userData=JSON.parse(JSON.stringify(t.userData)),this}dispose(){this.dispatchEvent({type:"dispose"})}set needsUpdate(t){t===!0&&this.version++}}class xy extends Ri{constructor(t){super(),this.isMeshBasicMaterial=!0,this.type="MeshBasicMaterial",this.color=new Ar(16777215),this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.envMapRotation=new oi,this.combine=Vp,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.fog=!0,this.setValues(t)}copy(t){return super.copy(t),this.color.copy(t.color),this.map=t.map,this.lightMap=t.lightMap,this.lightMapIntensity=t.lightMapIntensity,this.aoMap=t.aoMap,this.aoMapIntensity=t.aoMapIntensity,this.specularMap=t.specularMap,this.alphaMap=t.alphaMap,this.envMap=t.envMap,this.envMapRotation.copy(t.envMapRotation),this.combine=t.combine,this.reflectivity=t.reflectivity,this.refractionRatio=t.refractionRatio,this.wireframe=t.wireframe,this.wireframeLinewidth=t.wireframeLinewidth,this.wireframeLinecap=t.wireframeLinecap,this.wireframeLinejoin=t.wireframeLinejoin,this.fog=t.fog,this}}const Be=new L,Ds=new le;let gy=0;class Mi{constructor(t,e,r=!1){if(Array.isArray(t))throw new TypeError("THREE.BufferAttribute: array should be a Typed Array.");this.isBufferAttribute=!0,Object.defineProperty(this,"id",{value:gy++}),this.name="",this.array=t,this.itemSize=e,this.count=t!==void 0?t.length/e:0,this.normalized=r,this.usage=tu,this.updateRanges=[],this.gpuType=Go,this.version=0}onUploadCallback(){}set needsUpdate(t){t===!0&&this.version++}setUsage(t){return this.usage=t,this}addUpdateRange(t,e){this.updateRanges.push({start:t,count:e})}clearUpdateRanges(){this.updateRanges.length=0}copy(t){return this.name=t.name,this.array=new t.array.constructor(t.array),this.itemSize=t.itemSize,this.count=t.count,this.normalized=t.normalized,this.usage=t.usage,this.gpuType=t.gpuType,this}copyAt(t,e,r){t*=this.itemSize,r*=e.itemSize;for(let i=0,n=this.itemSize;i<n;i++)this.array[t+i]=e.array[r+i];return this}copyArray(t){return this.array.set(t),this}applyMatrix3(t){if(this.itemSize===2)for(let e=0,r=this.count;e<r;e++)Ds.fromBufferAttribute(this,e),Ds.applyMatrix3(t),this.setXY(e,Ds.x,Ds.y);else if(this.itemSize===3)for(let e=0,r=this.count;e<r;e++)Be.fromBufferAttribute(this,e),Be.applyMatrix3(t),this.setXYZ(e,Be.x,Be.y,Be.z);return this}applyMatrix4(t){for(let e=0,r=this.count;e<r;e++)Be.fromBufferAttribute(this,e),Be.applyMatrix4(t),this.setXYZ(e,Be.x,Be.y,Be.z);return this}applyNormalMatrix(t){for(let e=0,r=this.count;e<r;e++)Be.fromBufferAttribute(this,e),Be.applyNormalMatrix(t),this.setXYZ(e,Be.x,Be.y,Be.z);return this}transformDirection(t){for(let e=0,r=this.count;e<r;e++)Be.fromBufferAttribute(this,e),Be.transformDirection(t),this.setXYZ(e,Be.x,Be.y,Be.z);return this}set(t,e=0){return this.array.set(t,e),this}getComponent(t,e){let r=this.array[t*this.itemSize+e];return this.normalized&&(r=hn(r,this.array)),r}setComponent(t,e,r){return this.normalized&&(r=Ze(r,this.array)),this.array[t*this.itemSize+e]=r,this}getX(t){let e=this.array[t*this.itemSize];return this.normalized&&(e=hn(e,this.array)),e}setX(t,e){return this.normalized&&(e=Ze(e,this.array)),this.array[t*this.itemSize]=e,this}getY(t){let e=this.array[t*this.itemSize+1];return this.normalized&&(e=hn(e,this.array)),e}setY(t,e){return this.normalized&&(e=Ze(e,this.array)),this.array[t*this.itemSize+1]=e,this}getZ(t){let e=this.array[t*this.itemSize+2];return this.normalized&&(e=hn(e,this.array)),e}setZ(t,e){return this.normalized&&(e=Ze(e,this.array)),this.array[t*this.itemSize+2]=e,this}getW(t){let e=this.array[t*this.itemSize+3];return this.normalized&&(e=hn(e,this.array)),e}setW(t,e){return this.normalized&&(e=Ze(e,this.array)),this.array[t*this.itemSize+3]=e,this}setXY(t,e,r){return t*=this.itemSize,this.normalized&&(e=Ze(e,this.array),r=Ze(r,this.array)),this.array[t+0]=e,this.array[t+1]=r,this}setXYZ(t,e,r,i){return t*=this.itemSize,this.normalized&&(e=Ze(e,this.array),r=Ze(r,this.array),i=Ze(i,this.array)),this.array[t+0]=e,this.array[t+1]=r,this.array[t+2]=i,this}setXYZW(t,e,r,i,n){return t*=this.itemSize,this.normalized&&(e=Ze(e,this.array),r=Ze(r,this.array),i=Ze(i,this.array),n=Ze(n,this.array)),this.array[t+0]=e,this.array[t+1]=r,this.array[t+2]=i,this.array[t+3]=n,this}onUpload(t){return this.onUploadCallback=t,this}clone(){return new this.constructor(this.array,this.itemSize).copy(this)}toJSON(){const t={itemSize:this.itemSize,type:this.array.constructor.name,array:Array.from(this.array),normalized:this.normalized};return this.name!==""&&(t.name=this.name),this.usage!==tu&&(t.usage=this.usage),t}}class _y extends Mi{constructor(t,e,r){super(new Uint16Array(t),e,r)}}class by extends Mi{constructor(t,e,r){super(new Uint32Array(t),e,r)}}class Ke extends Mi{constructor(t,e,r){super(new Float32Array(t),e,r)}}let vy=0;const fr=new we,To=new Ye,nn=new L,lr=new Ci,kn=new Ci,We=new L;class jr extends $n{constructor(){super(),this.isBufferGeometry=!0,Object.defineProperty(this,"id",{value:vy++}),this.uuid=pn(),this.name="",this.type="BufferGeometry",this.index=null,this.indirect=null,this.attributes={},this.morphAttributes={},this.morphTargetsRelative=!1,this.groups=[],this.boundingBox=null,this.boundingSphere=null,this.drawRange={start:0,count:1/0},this.userData={}}getIndex(){return this.index}setIndex(t){return Array.isArray(t)?this.index=new(ey(t)?by:_y)(t,1):this.index=t,this}setIndirect(t){return this.indirect=t,this}getIndirect(){return this.indirect}getAttribute(t){return this.attributes[t]}setAttribute(t,e){return this.attributes[t]=e,this}deleteAttribute(t){return delete this.attributes[t],this}hasAttribute(t){return this.attributes[t]!==void 0}addGroup(t,e,r=0){this.groups.push({start:t,count:e,materialIndex:r})}clearGroups(){this.groups=[]}setDrawRange(t,e){this.drawRange.start=t,this.drawRange.count=e}applyMatrix4(t){const e=this.attributes.position;e!==void 0&&(e.applyMatrix4(t),e.needsUpdate=!0);const r=this.attributes.normal;if(r!==void 0){const n=new Vr().getNormalMatrix(t);r.applyNormalMatrix(n),r.needsUpdate=!0}const i=this.attributes.tangent;return i!==void 0&&(i.transformDirection(t),i.needsUpdate=!0),this.boundingBox!==null&&this.computeBoundingBox(),this.boundingSphere!==null&&this.computeBoundingSphere(),this}applyQuaternion(t){return fr.makeRotationFromQuaternion(t),this.applyMatrix4(fr),this}rotateX(t){return fr.makeRotationX(t),this.applyMatrix4(fr),this}rotateY(t){return fr.makeRotationY(t),this.applyMatrix4(fr),this}rotateZ(t){return fr.makeRotationZ(t),this.applyMatrix4(fr),this}translate(t,e,r){return fr.makeTranslation(t,e,r),this.applyMatrix4(fr),this}scale(t,e,r){return fr.makeScale(t,e,r),this.applyMatrix4(fr),this}lookAt(t){return To.lookAt(t),To.updateMatrix(),this.applyMatrix4(To.matrix),this}center(){return this.computeBoundingBox(),this.boundingBox.getCenter(nn).negate(),this.translate(nn.x,nn.y,nn.z),this}setFromPoints(t){const e=this.getAttribute("position");if(e===void 0){const r=[];for(let i=0,n=t.length;i<n;i++){const a=t[i];r.push(a.x,a.y,a.z||0)}this.setAttribute("position",new Ke(r,3))}else{const r=Math.min(t.length,e.count);for(let i=0;i<r;i++){const n=t[i];e.setXYZ(i,n.x,n.y,n.z||0)}t.length>e.count&&console.warn("THREE.BufferGeometry: Buffer size too small for points data. Use .dispose() and create a new geometry."),e.needsUpdate=!0}return this}computeBoundingBox(){this.boundingBox===null&&(this.boundingBox=new Ci);const t=this.attributes.position,e=this.morphAttributes.position;if(t&&t.isGLBufferAttribute){console.error("THREE.BufferGeometry.computeBoundingBox(): GLBufferAttribute requires a manual bounding box.",this),this.boundingBox.set(new L(-1/0,-1/0,-1/0),new L(1/0,1/0,1/0));return}if(t!==void 0){if(this.boundingBox.setFromBufferAttribute(t),e)for(let r=0,i=e.length;r<i;r++){const n=e[r];lr.setFromBufferAttribute(n),this.morphTargetsRelative?(We.addVectors(this.boundingBox.min,lr.min),this.boundingBox.expandByPoint(We),We.addVectors(this.boundingBox.max,lr.max),this.boundingBox.expandByPoint(We)):(this.boundingBox.expandByPoint(lr.min),this.boundingBox.expandByPoint(lr.max))}}else this.boundingBox.makeEmpty();(isNaN(this.boundingBox.min.x)||isNaN(this.boundingBox.min.y)||isNaN(this.boundingBox.min.z))&&console.error('THREE.BufferGeometry.computeBoundingBox(): Computed min/max have NaN values. The "position" attribute is likely to have NaN values.',this)}computeBoundingSphere(){this.boundingSphere===null&&(this.boundingSphere=new Ii);const t=this.attributes.position,e=this.morphAttributes.position;if(t&&t.isGLBufferAttribute){console.error("THREE.BufferGeometry.computeBoundingSphere(): GLBufferAttribute requires a manual bounding sphere.",this),this.boundingSphere.set(new L,1/0);return}if(t){const r=this.boundingSphere.center;if(lr.setFromBufferAttribute(t),e)for(let n=0,a=e.length;n<a;n++){const o=e[n];kn.setFromBufferAttribute(o),this.morphTargetsRelative?(We.addVectors(lr.min,kn.min),lr.expandByPoint(We),We.addVectors(lr.max,kn.max),lr.expandByPoint(We)):(lr.expandByPoint(kn.min),lr.expandByPoint(kn.max))}lr.getCenter(r);let i=0;for(let n=0,a=t.count;n<a;n++)We.fromBufferAttribute(t,n),i=Math.max(i,r.distanceToSquared(We));if(e)for(let n=0,a=e.length;n<a;n++){const o=e[n],c=this.morphTargetsRelative;for(let h=0,u=o.count;h<u;h++)We.fromBufferAttribute(o,h),c&&(nn.fromBufferAttribute(t,h),We.add(nn)),i=Math.max(i,r.distanceToSquared(We))}this.boundingSphere.radius=Math.sqrt(i),isNaN(this.boundingSphere.radius)&&console.error('THREE.BufferGeometry.computeBoundingSphere(): Computed radius is NaN. The "position" attribute is likely to have NaN values.',this)}}computeTangents(){const t=this.index,e=this.attributes;if(t===null||e.position===void 0||e.normal===void 0||e.uv===void 0){console.error("THREE.BufferGeometry: .computeTangents() failed. Missing required attributes (index, position, normal or uv)");return}const r=e.position,i=e.normal,n=e.uv;this.hasAttribute("tangent")===!1&&this.setAttribute("tangent",new Mi(new Float32Array(4*r.count),4));const a=this.getAttribute("tangent"),o=[],c=[];for(let St=0;St<r.count;St++)o[St]=new L,c[St]=new L;const h=new L,u=new L,d=new L,y=new le,g=new le,A=new le,D=new L,H=new L;function V(St,Xt,Ht){h.fromBufferAttribute(r,St),u.fromBufferAttribute(r,Xt),d.fromBufferAttribute(r,Ht),y.fromBufferAttribute(n,St),g.fromBufferAttribute(n,Xt),A.fromBufferAttribute(n,Ht),u.sub(h),d.sub(h),g.sub(y),A.sub(y);const se=1/(g.x*A.y-A.x*g.y);isFinite(se)&&(D.copy(u).multiplyScalar(A.y).addScaledVector(d,-g.y).multiplyScalar(se),H.copy(d).multiplyScalar(g.x).addScaledVector(u,-A.x).multiplyScalar(se),o[St].add(D),o[Xt].add(D),o[Ht].add(D),c[St].add(H),c[Xt].add(H),c[Ht].add(H))}let Tt=this.groups;Tt.length===0&&(Tt=[{start:0,count:t.count}]);for(let St=0,Xt=Tt.length;St<Xt;++St){const Ht=Tt[St],se=Ht.start,Ut=Ht.count;for(let Yt=se,ae=se+Ut;Yt<ae;Yt+=3)V(t.getX(Yt+0),t.getX(Yt+1),t.getX(Yt+2))}const ft=new L,ct=new L,Mt=new L,Dt=new L;function Et(St){Mt.fromBufferAttribute(i,St),Dt.copy(Mt);const Xt=o[St];ft.copy(Xt),ft.sub(Mt.multiplyScalar(Mt.dot(Xt))).normalize(),ct.crossVectors(Dt,Xt);const se=ct.dot(c[St])<0?-1:1;a.setXYZW(St,ft.x,ft.y,ft.z,se)}for(let St=0,Xt=Tt.length;St<Xt;++St){const Ht=Tt[St],se=Ht.start,Ut=Ht.count;for(let Yt=se,ae=se+Ut;Yt<ae;Yt+=3)Et(t.getX(Yt+0)),Et(t.getX(Yt+1)),Et(t.getX(Yt+2))}}computeVertexNormals(){const t=this.index,e=this.getAttribute("position");if(e!==void 0){let r=this.getAttribute("normal");if(r===void 0)r=new Mi(new Float32Array(e.count*3),3),this.setAttribute("normal",r);else for(let y=0,g=r.count;y<g;y++)r.setXYZ(y,0,0,0);const i=new L,n=new L,a=new L,o=new L,c=new L,h=new L,u=new L,d=new L;if(t)for(let y=0,g=t.count;y<g;y+=3){const A=t.getX(y+0),D=t.getX(y+1),H=t.getX(y+2);i.fromBufferAttribute(e,A),n.fromBufferAttribute(e,D),a.fromBufferAttribute(e,H),u.subVectors(a,n),d.subVectors(i,n),u.cross(d),o.fromBufferAttribute(r,A),c.fromBufferAttribute(r,D),h.fromBufferAttribute(r,H),o.add(u),c.add(u),h.add(u),r.setXYZ(A,o.x,o.y,o.z),r.setXYZ(D,c.x,c.y,c.z),r.setXYZ(H,h.x,h.y,h.z)}else for(let y=0,g=e.count;y<g;y+=3)i.fromBufferAttribute(e,y+0),n.fromBufferAttribute(e,y+1),a.fromBufferAttribute(e,y+2),u.subVectors(a,n),d.subVectors(i,n),u.cross(d),r.setXYZ(y+0,u.x,u.y,u.z),r.setXYZ(y+1,u.x,u.y,u.z),r.setXYZ(y+2,u.x,u.y,u.z);this.normalizeNormals(),r.needsUpdate=!0}}normalizeNormals(){const t=this.attributes.normal;for(let e=0,r=t.count;e<r;e++)We.fromBufferAttribute(t,e),We.normalize(),t.setXYZ(e,We.x,We.y,We.z)}toNonIndexed(){function t(o,c){const h=o.array,u=o.itemSize,d=o.normalized,y=new h.constructor(c.length*u);let g=0,A=0;for(let D=0,H=c.length;D<H;D++){o.isInterleavedBufferAttribute?g=c[D]*o.data.stride+o.offset:g=c[D]*u;for(let V=0;V<u;V++)y[A++]=h[g++]}return new Mi(y,u,d)}if(this.index===null)return console.warn("THREE.BufferGeometry.toNonIndexed(): BufferGeometry is already non-indexed."),this;const e=new jr,r=this.index.array,i=this.attributes;for(const o in i){const c=i[o],h=t(c,r);e.setAttribute(o,h)}const n=this.morphAttributes;for(const o in n){const c=[],h=n[o];for(let u=0,d=h.length;u<d;u++){const y=h[u],g=t(y,r);c.push(g)}e.morphAttributes[o]=c}e.morphTargetsRelative=this.morphTargetsRelative;const a=this.groups;for(let o=0,c=a.length;o<c;o++){const h=a[o];e.addGroup(h.start,h.count,h.materialIndex)}return e}toJSON(){const t={metadata:{version:4.7,type:"BufferGeometry",generator:"BufferGeometry.toJSON"}};if(t.uuid=this.uuid,t.type=this.type,this.name!==""&&(t.name=this.name),Object.keys(this.userData).length>0&&(t.userData=this.userData),this.parameters!==void 0){const c=this.parameters;for(const h in c)c[h]!==void 0&&(t[h]=c[h]);return t}t.data={attributes:{}};const e=this.index;e!==null&&(t.data.index={type:e.array.constructor.name,array:Array.prototype.slice.call(e.array)});const r=this.attributes;for(const c in r){const h=r[c];t.data.attributes[c]=h.toJSON(t.data)}const i={};let n=!1;for(const c in this.morphAttributes){const h=this.morphAttributes[c],u=[];for(let d=0,y=h.length;d<y;d++){const g=h[d];u.push(g.toJSON(t.data))}u.length>0&&(i[c]=u,n=!0)}n&&(t.data.morphAttributes=i,t.data.morphTargetsRelative=this.morphTargetsRelative);const a=this.groups;a.length>0&&(t.data.groups=JSON.parse(JSON.stringify(a)));const o=this.boundingSphere;return o!==null&&(t.data.boundingSphere=o.toJSON()),t}clone(){return new this.constructor().copy(this)}copy(t){this.index=null,this.attributes={},this.morphAttributes={},this.groups=[],this.boundingBox=null,this.boundingSphere=null;const e={};this.name=t.name;const r=t.index;r!==null&&this.setIndex(r.clone());const i=t.attributes;for(const h in i){const u=i[h];this.setAttribute(h,u.clone(e))}const n=t.morphAttributes;for(const h in n){const u=[],d=n[h];for(let y=0,g=d.length;y<g;y++)u.push(d[y].clone(e));this.morphAttributes[h]=u}this.morphTargetsRelative=t.morphTargetsRelative;const a=t.groups;for(let h=0,u=a.length;h<u;h++){const d=a[h];this.addGroup(d.start,d.count,d.materialIndex)}const o=t.boundingBox;o!==null&&(this.boundingBox=o.clone());const c=t.boundingSphere;return c!==null&&(this.boundingSphere=c.clone()),this.drawRange.start=t.drawRange.start,this.drawRange.count=t.drawRange.count,this.userData=t.userData,this}dispose(){this.dispatchEvent({type:"dispose"})}}const pu=new we,Ti=new Ho,Fs=new Ii,yu=new L,Ps=new L,Bs=new L,ks=new L,So=new L,zs=new L,xu=new L,Us=new L;class Wo extends Ye{constructor(t=new jr,e=new xy){super(),this.isMesh=!0,this.type="Mesh",this.geometry=t,this.material=e,this.morphTargetDictionary=void 0,this.morphTargetInfluences=void 0,this.count=1,this.updateMorphTargets()}copy(t,e){return super.copy(t,e),t.morphTargetInfluences!==void 0&&(this.morphTargetInfluences=t.morphTargetInfluences.slice()),t.morphTargetDictionary!==void 0&&(this.morphTargetDictionary=Object.assign({},t.morphTargetDictionary)),this.material=Array.isArray(t.material)?t.material.slice():t.material,this.geometry=t.geometry,this}updateMorphTargets(){const e=this.geometry.morphAttributes,r=Object.keys(e);if(r.length>0){const i=e[r[0]];if(i!==void 0){this.morphTargetInfluences=[],this.morphTargetDictionary={};for(let n=0,a=i.length;n<a;n++){const o=i[n].name||String(n);this.morphTargetInfluences.push(0),this.morphTargetDictionary[o]=n}}}}getVertexPosition(t,e){const r=this.geometry,i=r.attributes.position,n=r.morphAttributes.position,a=r.morphTargetsRelative;e.fromBufferAttribute(i,t);const o=this.morphTargetInfluences;if(n&&o){zs.set(0,0,0);for(let c=0,h=n.length;c<h;c++){const u=o[c],d=n[c];u!==0&&(So.fromBufferAttribute(d,t),a?zs.addScaledVector(So,u):zs.addScaledVector(So.sub(e),u))}e.add(zs)}return e}raycast(t,e){const r=this.geometry,i=this.material,n=this.matrixWorld;i!==void 0&&(r.boundingSphere===null&&r.computeBoundingSphere(),Fs.copy(r.boundingSphere),Fs.applyMatrix4(n),Ti.copy(t.ray).recast(t.near),!(Fs.containsPoint(Ti.origin)===!1&&(Ti.intersectSphere(Fs,yu)===null||Ti.origin.distanceToSquared(yu)>(t.far-t.near)**2))&&(pu.copy(n).invert(),Ti.copy(t.ray).applyMatrix4(pu),!(r.boundingBox!==null&&Ti.intersectsBox(r.boundingBox)===!1)&&this._computeIntersections(t,e,Ti)))}_computeIntersections(t,e,r){let i;const n=this.geometry,a=this.material,o=n.index,c=n.attributes.position,h=n.attributes.uv,u=n.attributes.uv1,d=n.attributes.normal,y=n.groups,g=n.drawRange;if(o!==null)if(Array.isArray(a))for(let A=0,D=y.length;A<D;A++){const H=y[A],V=a[H.materialIndex],Tt=Math.max(H.start,g.start),ft=Math.min(o.count,Math.min(H.start+H.count,g.start+g.count));for(let ct=Tt,Mt=ft;ct<Mt;ct+=3){const Dt=o.getX(ct),Et=o.getX(ct+1),St=o.getX(ct+2);i=Gs(this,V,t,r,h,u,d,Dt,Et,St),i&&(i.faceIndex=Math.floor(ct/3),i.face.materialIndex=H.materialIndex,e.push(i))}}else{const A=Math.max(0,g.start),D=Math.min(o.count,g.start+g.count);for(let H=A,V=D;H<V;H+=3){const Tt=o.getX(H),ft=o.getX(H+1),ct=o.getX(H+2);i=Gs(this,a,t,r,h,u,d,Tt,ft,ct),i&&(i.faceIndex=Math.floor(H/3),e.push(i))}}else if(c!==void 0)if(Array.isArray(a))for(let A=0,D=y.length;A<D;A++){const H=y[A],V=a[H.materialIndex],Tt=Math.max(H.start,g.start),ft=Math.min(c.count,Math.min(H.start+H.count,g.start+g.count));for(let ct=Tt,Mt=ft;ct<Mt;ct+=3){const Dt=ct,Et=ct+1,St=ct+2;i=Gs(this,V,t,r,h,u,d,Dt,Et,St),i&&(i.faceIndex=Math.floor(ct/3),i.face.materialIndex=H.materialIndex,e.push(i))}}else{const A=Math.max(0,g.start),D=Math.min(c.count,g.start+g.count);for(let H=A,V=D;H<V;H+=3){const Tt=H,ft=H+1,ct=H+2;i=Gs(this,a,t,r,h,u,d,Tt,ft,ct),i&&(i.faceIndex=Math.floor(H/3),e.push(i))}}}}function Ey(s,t,e,r,i,n,a,o){let c;if(t.side===$u?c=r.intersectTriangle(a,n,i,!0,o):c=r.intersectTriangle(i,n,a,t.side===ko,o),c===null)return null;Us.copy(o),Us.applyMatrix4(s.matrixWorld);const h=e.ray.origin.distanceTo(Us);return h<e.near||h>e.far?null:{distance:h,point:Us.clone(),object:s}}function Gs(s,t,e,r,i,n,a,o,c,h){s.getVertexPosition(o,Ps),s.getVertexPosition(c,Bs),s.getVertexPosition(h,ks);const u=Ey(s,t,e,r,Ps,Bs,ks,xu);if(u){const d=new L;Er.getBarycoord(xu,Ps,Bs,ks,d),i&&(u.uv=Er.getInterpolatedAttribute(i,o,c,h,d,new le)),n&&(u.uv1=Er.getInterpolatedAttribute(n,o,c,h,d,new le)),a&&(u.normal=Er.getInterpolatedAttribute(a,o,c,h,d,new L),u.normal.dot(r.direction)>0&&u.normal.multiplyScalar(-1));const y={a:o,b:c,c:h,normal:new L,materialIndex:0};Er.getNormal(Ps,Bs,ks,y.normal),u.face=y,u.barycoord=d}return u}class Yo extends jr{constructor(t=1,e=1,r=1,i=1,n=1,a=1){super(),this.type="BoxGeometry",this.parameters={width:t,height:e,depth:r,widthSegments:i,heightSegments:n,depthSegments:a};const o=this;i=Math.floor(i),n=Math.floor(n),a=Math.floor(a);const c=[],h=[],u=[],d=[];let y=0,g=0;A("z","y","x",-1,-1,r,e,t,a,n,0),A("z","y","x",1,-1,r,e,-t,a,n,1),A("x","z","y",1,1,t,r,e,i,a,2),A("x","z","y",1,-1,t,r,-e,i,a,3),A("x","y","z",1,-1,t,e,r,i,n,4),A("x","y","z",-1,-1,t,e,-r,i,n,5),this.setIndex(c),this.setAttribute("position",new Ke(h,3)),this.setAttribute("normal",new Ke(u,3)),this.setAttribute("uv",new Ke(d,2));function A(D,H,V,Tt,ft,ct,Mt,Dt,Et,St,Xt){const Ht=ct/Et,se=Mt/St,Ut=ct/2,Yt=Mt/2,ae=Dt/2,me=Et+1,ce=St+1;let Me=0,ge=0;const ee=new L;for(let Gt=0;Gt<ce;Gt++){const te=Gt*se-Yt;for(let qt=0;qt<me;qt++){const he=qt*Ht-Ut;ee[D]=he*Tt,ee[H]=te*ft,ee[V]=ae,h.push(ee.x,ee.y,ee.z),ee[D]=0,ee[H]=0,ee[V]=Dt>0?1:-1,u.push(ee.x,ee.y,ee.z),d.push(qt/Et),d.push(1-Gt/St),Me+=1}}for(let Gt=0;Gt<St;Gt++)for(let te=0;te<Et;te++){const qt=y+te+me*Gt,he=y+te+me*(Gt+1),ue=y+(te+1)+me*(Gt+1),ve=y+(te+1)+me*Gt;c.push(qt,he,ve),c.push(he,ue,ve),ge+=6}o.addGroup(g,ge,Xt),g+=ge,y+=Me}}copy(t){return super.copy(t),this.parameters=Object.assign({},t.parameters),this}static fromJSON(t){return new Yo(t.width,t.height,t.depth,t.widthSegments,t.heightSegments,t.depthSegments)}}function aa(s){const t={};for(const e in s){t[e]={};for(const r in s[e]){const i=s[e][r];i&&(i.isColor||i.isMatrix3||i.isMatrix4||i.isVector2||i.isVector3||i.isVector4||i.isTexture||i.isQuaternion)?i.isRenderTargetTexture?(console.warn("UniformsUtils: Textures of render targets cannot be cloned via cloneUniforms() or mergeUniforms()."),t[e][r]=null):t[e][r]=i.clone():Array.isArray(i)?t[e][r]=i.slice():t[e][r]=i}}return t}function Ay(s){const t={};for(let e=0;e<s.length;e++){const r=aa(s[e]);for(const i in r)t[i]=r[i]}return t}function Ty(s){const t=[];for(let e=0;e<s.length;e++)t.push(s[e].clone());return t}function __(s){const t=s.getRenderTarget();return t===null?s.outputColorSpace:t.isXRRenderTarget===!0?t.texture.colorSpace:dr.workingColorSpace}const b_={clone:aa,merge:Ay};var Sy=`void main() {
	gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
}`,wy=`void main() {
	gl_FragColor = vec4( 1.0, 0.0, 0.0, 1.0 );
}`;class My extends Ri{constructor(t){super(),this.isShaderMaterial=!0,this.type="ShaderMaterial",this.defines={},this.uniforms={},this.uniformsGroups=[],this.vertexShader=Sy,this.fragmentShader=wy,this.linewidth=1,this.wireframe=!1,this.wireframeLinewidth=1,this.fog=!1,this.lights=!1,this.clipping=!1,this.forceSinglePass=!0,this.extensions={clipCullDistance:!1,multiDraw:!1},this.defaultAttributeValues={color:[1,1,1],uv:[0,0],uv1:[0,0]},this.index0AttributeName=void 0,this.uniformsNeedUpdate=!1,this.glslVersion=null,t!==void 0&&this.setValues(t)}copy(t){return super.copy(t),this.fragmentShader=t.fragmentShader,this.vertexShader=t.vertexShader,this.uniforms=aa(t.uniforms),this.uniformsGroups=Ty(t.uniformsGroups),this.defines=Object.assign({},t.defines),this.wireframe=t.wireframe,this.wireframeLinewidth=t.wireframeLinewidth,this.fog=t.fog,this.lights=t.lights,this.clipping=t.clipping,this.extensions=Object.assign({},t.extensions),this.glslVersion=t.glslVersion,this}toJSON(t){const e=super.toJSON(t);e.glslVersion=this.glslVersion,e.uniforms={};for(const i in this.uniforms){const a=this.uniforms[i].value;a&&a.isTexture?e.uniforms[i]={type:"t",value:a.toJSON(t).uuid}:a&&a.isColor?e.uniforms[i]={type:"c",value:a.getHex()}:a&&a.isVector2?e.uniforms[i]={type:"v2",value:a.toArray()}:a&&a.isVector3?e.uniforms[i]={type:"v3",value:a.toArray()}:a&&a.isVector4?e.uniforms[i]={type:"v4",value:a.toArray()}:a&&a.isMatrix3?e.uniforms[i]={type:"m3",value:a.toArray()}:a&&a.isMatrix4?e.uniforms[i]={type:"m4",value:a.toArray()}:e.uniforms[i]={value:a}}Object.keys(this.defines).length>0&&(e.defines=this.defines),e.vertexShader=this.vertexShader,e.fragmentShader=this.fragmentShader,e.lights=this.lights,e.clipping=this.clipping;const r={};for(const i in this.extensions)this.extensions[i]===!0&&(r[i]=!0);return Object.keys(r).length>0&&(e.extensions=r),e}}class rf extends Ye{constructor(){super(),this.isCamera=!0,this.type="Camera",this.matrixWorldInverse=new we,this.projectionMatrix=new we,this.projectionMatrixInverse=new we,this.coordinateSystem=ni}copy(t,e){return super.copy(t,e),this.matrixWorldInverse.copy(t.matrixWorldInverse),this.projectionMatrix.copy(t.projectionMatrix),this.projectionMatrixInverse.copy(t.projectionMatrixInverse),this.coordinateSystem=t.coordinateSystem,this}getWorldDirection(t){return super.getWorldDirection(t).negate()}updateMatrixWorld(t){super.updateMatrixWorld(t),this.matrixWorldInverse.copy(this.matrixWorld).invert()}updateWorldMatrix(t,e){super.updateWorldMatrix(t,e),this.matrixWorldInverse.copy(this.matrixWorld).invert()}clone(){return new this.constructor().copy(this)}}const ri=new L,gu=new le,_u=new le;class ii extends rf{constructor(t=50,e=1,r=.1,i=2e3){super(),this.isPerspectiveCamera=!0,this.type="PerspectiveCamera",this.fov=t,this.zoom=1,this.near=r,this.far=i,this.focus=10,this.aspect=e,this.view=null,this.filmGauge=35,this.filmOffset=0,this.updateProjectionMatrix()}copy(t,e){return super.copy(t,e),this.fov=t.fov,this.zoom=t.zoom,this.near=t.near,this.far=t.far,this.focus=t.focus,this.aspect=t.aspect,this.view=t.view===null?null:Object.assign({},t.view),this.filmGauge=t.filmGauge,this.filmOffset=t.filmOffset,this}setFocalLength(t){const e=.5*this.getFilmHeight()/t;this.fov=ra*2*Math.atan(e),this.updateProjectionMatrix()}getFocalLength(){const t=Math.tan(Hn*.5*this.fov);return .5*this.getFilmHeight()/t}getEffectiveFOV(){return ra*2*Math.atan(Math.tan(Hn*.5*this.fov)/this.zoom)}getFilmWidth(){return this.filmGauge*Math.min(this.aspect,1)}getFilmHeight(){return this.filmGauge/Math.max(this.aspect,1)}getViewBounds(t,e,r){ri.set(-1,-1,.5).applyMatrix4(this.projectionMatrixInverse),e.set(ri.x,ri.y).multiplyScalar(-t/ri.z),ri.set(1,1,.5).applyMatrix4(this.projectionMatrixInverse),r.set(ri.x,ri.y).multiplyScalar(-t/ri.z)}getViewSize(t,e){return this.getViewBounds(t,gu,_u),e.subVectors(_u,gu)}setViewOffset(t,e,r,i,n,a){this.aspect=t/e,this.view===null&&(this.view={enabled:!0,fullWidth:1,fullHeight:1,offsetX:0,offsetY:0,width:1,height:1}),this.view.enabled=!0,this.view.fullWidth=t,this.view.fullHeight=e,this.view.offsetX=r,this.view.offsetY=i,this.view.width=n,this.view.height=a,this.updateProjectionMatrix()}clearViewOffset(){this.view!==null&&(this.view.enabled=!1),this.updateProjectionMatrix()}updateProjectionMatrix(){const t=this.near;let e=t*Math.tan(Hn*.5*this.fov)/this.zoom,r=2*e,i=this.aspect*r,n=-.5*i;const a=this.view;if(this.view!==null&&this.view.enabled){const c=a.fullWidth,h=a.fullHeight;n+=a.offsetX*i/c,e-=a.offsetY*r/h,i*=a.width/c,r*=a.height/h}const o=this.filmOffset;o!==0&&(n+=t*o/this.getFilmWidth()),this.projectionMatrix.makePerspective(n,n+i,e,e-r,t,this.far,this.coordinateSystem),this.projectionMatrixInverse.copy(this.projectionMatrix).invert()}toJSON(t){const e=super.toJSON(t);return e.object.fov=this.fov,e.object.zoom=this.zoom,e.object.near=this.near,e.object.far=this.far,e.object.focus=this.focus,e.object.aspect=this.aspect,this.view!==null&&(e.object.view=Object.assign({},this.view)),e.object.filmGauge=this.filmGauge,e.object.filmOffset=this.filmOffset,e}}const sn=-90,an=1;class Cy extends Ye{constructor(t,e,r){super(),this.type="CubeCamera",this.renderTarget=r,this.coordinateSystem=null,this.activeMipmapLevel=0;const i=new ii(sn,an,t,e);i.layers=this.layers,this.add(i);const n=new ii(sn,an,t,e);n.layers=this.layers,this.add(n);const a=new ii(sn,an,t,e);a.layers=this.layers,this.add(a);const o=new ii(sn,an,t,e);o.layers=this.layers,this.add(o);const c=new ii(sn,an,t,e);c.layers=this.layers,this.add(c);const h=new ii(sn,an,t,e);h.layers=this.layers,this.add(h)}updateCoordinateSystem(){const t=this.coordinateSystem,e=this.children.concat(),[r,i,n,a,o,c]=e;for(const h of e)this.remove(h);if(t===ni)r.up.set(0,1,0),r.lookAt(1,0,0),i.up.set(0,1,0),i.lookAt(-1,0,0),n.up.set(0,0,-1),n.lookAt(0,1,0),a.up.set(0,0,1),a.lookAt(0,-1,0),o.up.set(0,1,0),o.lookAt(0,0,1),c.up.set(0,1,0),c.lookAt(0,0,-1);else if(t===ea)r.up.set(0,-1,0),r.lookAt(-1,0,0),i.up.set(0,-1,0),i.lookAt(1,0,0),n.up.set(0,0,1),n.lookAt(0,1,0),a.up.set(0,0,-1),a.lookAt(0,-1,0),o.up.set(0,-1,0),o.lookAt(0,0,1),c.up.set(0,-1,0),c.lookAt(0,0,-1);else throw new Error("THREE.CubeCamera.updateCoordinateSystem(): Invalid coordinate system: "+t);for(const h of e)this.add(h),h.updateMatrixWorld()}update(t,e){this.parent===null&&this.updateMatrixWorld();const{renderTarget:r,activeMipmapLevel:i}=this;this.coordinateSystem!==t.coordinateSystem&&(this.coordinateSystem=t.coordinateSystem,this.updateCoordinateSystem());const[n,a,o,c,h,u]=this.children,d=t.getRenderTarget(),y=t.getActiveCubeFace(),g=t.getActiveMipmapLevel(),A=t.xr.enabled;t.xr.enabled=!1;const D=r.texture.generateMipmaps;r.texture.generateMipmaps=!1,t.setRenderTarget(r,0,i),t.render(e,n),t.setRenderTarget(r,1,i),t.render(e,a),t.setRenderTarget(r,2,i),t.render(e,o),t.setRenderTarget(r,3,i),t.render(e,c),t.setRenderTarget(r,4,i),t.render(e,h),r.texture.generateMipmaps=D,t.setRenderTarget(r,5,i),t.render(e,u),t.setRenderTarget(d,y,g),t.xr.enabled=A,r.texture.needsPMREMUpdate=!0}}class Iy extends rr{constructor(t=[],e=jp,r,i,n,a,o,c,h,u){super(t,e,r,i,n,a,o,c,h,u),this.isCubeTexture=!0,this.flipY=!1}get images(){return this.image}set images(t){this.image=t}}class v_ extends oy{constructor(t=1,e={}){super(t,t,e),this.isWebGLCubeRenderTarget=!0;const r={width:t,height:t,depth:1},i=[r,r,r,r,r,r];this.texture=new Iy(i),this._setTextureOptions(e),this.texture.isRenderTargetTexture=!0}fromEquirectangularTexture(t,e){this.texture.type=e.type,this.texture.colorSpace=e.colorSpace,this.texture.generateMipmaps=e.generateMipmaps,this.texture.minFilter=e.minFilter,this.texture.magFilter=e.magFilter;const r={uniforms:{tEquirect:{value:null}},vertexShader:`

				varying vec3 vWorldDirection;

				vec3 transformDirection( in vec3 dir, in mat4 matrix ) {

					return normalize( ( matrix * vec4( dir, 0.0 ) ).xyz );

				}

				void main() {

					vWorldDirection = transformDirection( position, modelMatrix );

					#include <begin_vertex>
					#include <project_vertex>

				}
			`,fragmentShader:`

				uniform sampler2D tEquirect;

				varying vec3 vWorldDirection;

				#include <common>

				void main() {

					vec3 direction = normalize( vWorldDirection );

					vec2 sampleUV = equirectUv( direction );

					gl_FragColor = texture2D( tEquirect, sampleUV );

				}
			`},i=new Yo(5,5,5),n=new My({name:"CubemapFromEquirect",uniforms:aa(r.uniforms),vertexShader:r.vertexShader,fragmentShader:r.fragmentShader,side:$u,blending:Gp});n.uniforms.tEquirect.value=e;const a=new Wo(i,n),o=e.minFilter;return e.minFilter===Ju&&(e.minFilter=ta),new Cy(1,10,this).update(t,a),e.minFilter=o,a.geometry.dispose(),a.material.dispose(),this}clear(t,e=!0,r=!0,i=!0){const n=t.getRenderTarget();for(let a=0;a<6;a++)t.setRenderTarget(this,a),t.clear(e,r,i);t.setRenderTarget(n)}}class Vs extends Ye{constructor(){super(),this.isGroup=!0,this.type="Group"}}const Ry={type:"move"};class E_{constructor(){this._targetRay=null,this._grip=null,this._hand=null}getHandSpace(){return this._hand===null&&(this._hand=new Vs,this._hand.matrixAutoUpdate=!1,this._hand.visible=!1,this._hand.joints={},this._hand.inputState={pinching:!1}),this._hand}getTargetRaySpace(){return this._targetRay===null&&(this._targetRay=new Vs,this._targetRay.matrixAutoUpdate=!1,this._targetRay.visible=!1,this._targetRay.hasLinearVelocity=!1,this._targetRay.linearVelocity=new L,this._targetRay.hasAngularVelocity=!1,this._targetRay.angularVelocity=new L),this._targetRay}getGripSpace(){return this._grip===null&&(this._grip=new Vs,this._grip.matrixAutoUpdate=!1,this._grip.visible=!1,this._grip.hasLinearVelocity=!1,this._grip.linearVelocity=new L,this._grip.hasAngularVelocity=!1,this._grip.angularVelocity=new L),this._grip}dispatchEvent(t){return this._targetRay!==null&&this._targetRay.dispatchEvent(t),this._grip!==null&&this._grip.dispatchEvent(t),this._hand!==null&&this._hand.dispatchEvent(t),this}connect(t){if(t&&t.hand){const e=this._hand;if(e)for(const r of t.hand.values())this._getHandJoint(e,r)}return this.dispatchEvent({type:"connected",data:t}),this}disconnect(t){return this.dispatchEvent({type:"disconnected",data:t}),this._targetRay!==null&&(this._targetRay.visible=!1),this._grip!==null&&(this._grip.visible=!1),this._hand!==null&&(this._hand.visible=!1),this}update(t,e,r){let i=null,n=null,a=null;const o=this._targetRay,c=this._grip,h=this._hand;if(t&&e.session.visibilityState!=="visible-blurred"){if(h&&t.hand){a=!0;for(const D of t.hand.values()){const H=e.getJointPose(D,r),V=this._getHandJoint(h,D);H!==null&&(V.matrix.fromArray(H.transform.matrix),V.matrix.decompose(V.position,V.rotation,V.scale),V.matrixWorldNeedsUpdate=!0,V.jointRadius=H.radius),V.visible=H!==null}const u=h.joints["index-finger-tip"],d=h.joints["thumb-tip"],y=u.position.distanceTo(d.position),g=.02,A=.005;h.inputState.pinching&&y>g+A?(h.inputState.pinching=!1,this.dispatchEvent({type:"pinchend",handedness:t.handedness,target:this})):!h.inputState.pinching&&y<=g-A&&(h.inputState.pinching=!0,this.dispatchEvent({type:"pinchstart",handedness:t.handedness,target:this}))}else c!==null&&t.gripSpace&&(n=e.getPose(t.gripSpace,r),n!==null&&(c.matrix.fromArray(n.transform.matrix),c.matrix.decompose(c.position,c.rotation,c.scale),c.matrixWorldNeedsUpdate=!0,n.linearVelocity?(c.hasLinearVelocity=!0,c.linearVelocity.copy(n.linearVelocity)):c.hasLinearVelocity=!1,n.angularVelocity?(c.hasAngularVelocity=!0,c.angularVelocity.copy(n.angularVelocity)):c.hasAngularVelocity=!1));o!==null&&(i=e.getPose(t.targetRaySpace,r),i===null&&n!==null&&(i=n),i!==null&&(o.matrix.fromArray(i.transform.matrix),o.matrix.decompose(o.position,o.rotation,o.scale),o.matrixWorldNeedsUpdate=!0,i.linearVelocity?(o.hasLinearVelocity=!0,o.linearVelocity.copy(i.linearVelocity)):o.hasLinearVelocity=!1,i.angularVelocity?(o.hasAngularVelocity=!0,o.angularVelocity.copy(i.angularVelocity)):o.hasAngularVelocity=!1,this.dispatchEvent(Ry)))}return o!==null&&(o.visible=i!==null),c!==null&&(c.visible=n!==null),h!==null&&(h.visible=a!==null),this}_getHandJoint(t,e){if(t.joints[e.jointName]===void 0){const r=new Vs;r.matrixAutoUpdate=!1,r.visible=!1,t.joints[e.jointName]=r,t.add(r)}return t.joints[e.jointName]}}class nf{constructor(t,e=25e-5){this.isFogExp2=!0,this.name="",this.color=new Ar(t),this.density=e}clone(){return new nf(this.color,this.density)}toJSON(){return{type:"FogExp2",name:this.name,color:this.color.getHex(),density:this.density}}}class sf{constructor(t,e=1,r=1e3){this.isFog=!0,this.name="",this.color=new Ar(t),this.near=e,this.far=r}clone(){return new sf(this.color,this.near,this.far)}toJSON(){return{type:"Fog",name:this.name,color:this.color.getHex(),near:this.near,far:this.far}}}class A_ extends Ye{constructor(){super(),this.isScene=!0,this.type="Scene",this.background=null,this.environment=null,this.fog=null,this.backgroundBlurriness=0,this.backgroundIntensity=1,this.backgroundRotation=new oi,this.environmentIntensity=1,this.environmentRotation=new oi,this.overrideMaterial=null,typeof __THREE_DEVTOOLS__<"u"&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("observe",{detail:this}))}copy(t,e){return super.copy(t,e),t.background!==null&&(this.background=t.background.clone()),t.environment!==null&&(this.environment=t.environment.clone()),t.fog!==null&&(this.fog=t.fog.clone()),this.backgroundBlurriness=t.backgroundBlurriness,this.backgroundIntensity=t.backgroundIntensity,this.backgroundRotation.copy(t.backgroundRotation),this.environmentIntensity=t.environmentIntensity,this.environmentRotation.copy(t.environmentRotation),t.overrideMaterial!==null&&(this.overrideMaterial=t.overrideMaterial.clone()),this.matrixAutoUpdate=t.matrixAutoUpdate,this}toJSON(t){const e=super.toJSON(t);return this.fog!==null&&(e.object.fog=this.fog.toJSON()),this.backgroundBlurriness>0&&(e.object.backgroundBlurriness=this.backgroundBlurriness),this.backgroundIntensity!==1&&(e.object.backgroundIntensity=this.backgroundIntensity),e.object.backgroundRotation=this.backgroundRotation.toArray(),this.environmentIntensity!==1&&(e.object.environmentIntensity=this.environmentIntensity),e.object.environmentRotation=this.environmentRotation.toArray(),e}}class Oy extends rr{constructor(t=null,e=1,r=1,i,n,a,o,c,h=ai,u=ai,d,y){super(null,a,o,c,h,u,i,n,d,y),this.isDataTexture=!0,this.image={data:t,width:e,height:r},this.generateMipmaps=!1,this.flipY=!1,this.unpackAlignment=1}}class bu extends Mi{constructor(t,e,r,i=1){super(t,e,r),this.isInstancedBufferAttribute=!0,this.meshPerAttribute=i}copy(t){return super.copy(t),this.meshPerAttribute=t.meshPerAttribute,this}toJSON(){const t=super.toJSON();return t.meshPerAttribute=this.meshPerAttribute,t.isInstancedBufferAttribute=!0,t}}const on=new we,vu=new we,js=[],Eu=new Ci,Ny=new we,zn=new Wo,Un=new Ii;class T_ extends Wo{constructor(t,e,r){super(t,e),this.isInstancedMesh=!0,this.instanceMatrix=new bu(new Float32Array(r*16),16),this.instanceColor=null,this.morphTexture=null,this.count=r,this.boundingBox=null,this.boundingSphere=null;for(let i=0;i<r;i++)this.setMatrixAt(i,Ny)}computeBoundingBox(){const t=this.geometry,e=this.count;this.boundingBox===null&&(this.boundingBox=new Ci),t.boundingBox===null&&t.computeBoundingBox(),this.boundingBox.makeEmpty();for(let r=0;r<e;r++)this.getMatrixAt(r,on),Eu.copy(t.boundingBox).applyMatrix4(on),this.boundingBox.union(Eu)}computeBoundingSphere(){const t=this.geometry,e=this.count;this.boundingSphere===null&&(this.boundingSphere=new Ii),t.boundingSphere===null&&t.computeBoundingSphere(),this.boundingSphere.makeEmpty();for(let r=0;r<e;r++)this.getMatrixAt(r,on),Un.copy(t.boundingSphere).applyMatrix4(on),this.boundingSphere.union(Un)}copy(t,e){return super.copy(t,e),this.instanceMatrix.copy(t.instanceMatrix),t.morphTexture!==null&&(this.morphTexture=t.morphTexture.clone()),t.instanceColor!==null&&(this.instanceColor=t.instanceColor.clone()),this.count=t.count,t.boundingBox!==null&&(this.boundingBox=t.boundingBox.clone()),t.boundingSphere!==null&&(this.boundingSphere=t.boundingSphere.clone()),this}getColorAt(t,e){e.fromArray(this.instanceColor.array,t*3)}getMatrixAt(t,e){e.fromArray(this.instanceMatrix.array,t*16)}getMorphAt(t,e){const r=e.morphTargetInfluences,i=this.morphTexture.source.data.data,n=r.length+1,a=t*n+1;for(let o=0;o<r.length;o++)r[o]=i[a+o]}raycast(t,e){const r=this.matrixWorld,i=this.count;if(zn.geometry=this.geometry,zn.material=this.material,zn.material!==void 0&&(this.boundingSphere===null&&this.computeBoundingSphere(),Un.copy(this.boundingSphere),Un.applyMatrix4(r),t.ray.intersectsSphere(Un)!==!1))for(let n=0;n<i;n++){this.getMatrixAt(n,on),vu.multiplyMatrices(r,on),zn.matrixWorld=vu,zn.raycast(t,js);for(let a=0,o=js.length;a<o;a++){const c=js[a];c.instanceId=n,c.object=this,e.push(c)}js.length=0}}setColorAt(t,e){this.instanceColor===null&&(this.instanceColor=new bu(new Float32Array(this.instanceMatrix.count*3).fill(1),3)),e.toArray(this.instanceColor.array,t*3)}setMatrixAt(t,e){e.toArray(this.instanceMatrix.array,t*16)}setMorphAt(t,e){const r=e.morphTargetInfluences,i=r.length+1;this.morphTexture===null&&(this.morphTexture=new Oy(new Float32Array(i*this.count),i,this.count,Qu,Go));const n=this.morphTexture.source.data.data;let a=0;for(let h=0;h<r.length;h++)a+=r[h];const o=this.geometry.morphTargetsRelative?1:1-a,c=i*t;n[c]=o,n.set(r,c+1)}updateMorphTargets(){}dispose(){this.dispatchEvent({type:"dispose"}),this.morphTexture!==null&&(this.morphTexture.dispose(),this.morphTexture=null)}}const wo=new L,Ly=new L,Dy=new Vr;class ln{constructor(t=new L(1,0,0),e=0){this.isPlane=!0,this.normal=t,this.constant=e}set(t,e){return this.normal.copy(t),this.constant=e,this}setComponents(t,e,r,i){return this.normal.set(t,e,r),this.constant=i,this}setFromNormalAndCoplanarPoint(t,e){return this.normal.copy(t),this.constant=-e.dot(this.normal),this}setFromCoplanarPoints(t,e,r){const i=wo.subVectors(r,e).cross(Ly.subVectors(t,e)).normalize();return this.setFromNormalAndCoplanarPoint(i,t),this}copy(t){return this.normal.copy(t.normal),this.constant=t.constant,this}normalize(){const t=1/this.normal.length();return this.normal.multiplyScalar(t),this.constant*=t,this}negate(){return this.constant*=-1,this.normal.negate(),this}distanceToPoint(t){return this.normal.dot(t)+this.constant}distanceToSphere(t){return this.distanceToPoint(t.center)-t.radius}projectPoint(t,e){return e.copy(t).addScaledVector(this.normal,-this.distanceToPoint(t))}intersectLine(t,e){const r=t.delta(wo),i=this.normal.dot(r);if(i===0)return this.distanceToPoint(t.start)===0?e.copy(t.start):null;const n=-(t.start.dot(this.normal)+this.constant)/i;return n<0||n>1?null:e.copy(t.start).addScaledVector(r,n)}intersectsLine(t){const e=this.distanceToPoint(t.start),r=this.distanceToPoint(t.end);return e<0&&r>0||r<0&&e>0}intersectsBox(t){return t.intersectsPlane(this)}intersectsSphere(t){return t.intersectsPlane(this)}coplanarPoint(t){return t.copy(this.normal).multiplyScalar(-this.constant)}applyMatrix4(t,e){const r=e||Dy.getNormalMatrix(t),i=this.coplanarPoint(wo).applyMatrix4(t),n=this.normal.applyMatrix3(r).normalize();return this.constant=-i.dot(n),this}translate(t){return this.constant-=t.dot(this.normal),this}equals(t){return t.normal.equals(this.normal)&&t.constant===this.constant}clone(){return new this.constructor().copy(this)}}const Si=new Ii,Fy=new le(.5,.5),Hs=new L;class Py{constructor(t=new ln,e=new ln,r=new ln,i=new ln,n=new ln,a=new ln){this.planes=[t,e,r,i,n,a]}set(t,e,r,i,n,a){const o=this.planes;return o[0].copy(t),o[1].copy(e),o[2].copy(r),o[3].copy(i),o[4].copy(n),o[5].copy(a),this}copy(t){const e=this.planes;for(let r=0;r<6;r++)e[r].copy(t.planes[r]);return this}setFromProjectionMatrix(t,e=ni){const r=this.planes,i=t.elements,n=i[0],a=i[1],o=i[2],c=i[3],h=i[4],u=i[5],d=i[6],y=i[7],g=i[8],A=i[9],D=i[10],H=i[11],V=i[12],Tt=i[13],ft=i[14],ct=i[15];if(r[0].setComponents(c-n,y-h,H-g,ct-V).normalize(),r[1].setComponents(c+n,y+h,H+g,ct+V).normalize(),r[2].setComponents(c+a,y+u,H+A,ct+Tt).normalize(),r[3].setComponents(c-a,y-u,H-A,ct-Tt).normalize(),r[4].setComponents(c-o,y-d,H-D,ct-ft).normalize(),e===ni)r[5].setComponents(c+o,y+d,H+D,ct+ft).normalize();else if(e===ea)r[5].setComponents(o,d,D,ft).normalize();else throw new Error("THREE.Frustum.setFromProjectionMatrix(): Invalid coordinate system: "+e);return this}intersectsObject(t){if(t.boundingSphere!==void 0)t.boundingSphere===null&&t.computeBoundingSphere(),Si.copy(t.boundingSphere).applyMatrix4(t.matrixWorld);else{const e=t.geometry;e.boundingSphere===null&&e.computeBoundingSphere(),Si.copy(e.boundingSphere).applyMatrix4(t.matrixWorld)}return this.intersectsSphere(Si)}intersectsSprite(t){Si.center.set(0,0,0);const e=Fy.distanceTo(t.center);return Si.radius=.7071067811865476+e,Si.applyMatrix4(t.matrixWorld),this.intersectsSphere(Si)}intersectsSphere(t){const e=this.planes,r=t.center,i=-t.radius;for(let n=0;n<6;n++)if(e[n].distanceToPoint(r)<i)return!1;return!0}intersectsBox(t){const e=this.planes;for(let r=0;r<6;r++){const i=e[r];if(Hs.x=i.normal.x>0?t.max.x:t.min.x,Hs.y=i.normal.y>0?t.max.y:t.min.y,Hs.z=i.normal.z>0?t.max.z:t.min.z,i.distanceToPoint(Hs)<0)return!1}return!0}containsPoint(t){const e=this.planes;for(let r=0;r<6;r++)if(e[r].distanceToPoint(t)<0)return!1;return!0}clone(){return new this.constructor().copy(this)}}class By extends Ri{constructor(t){super(),this.isLineBasicMaterial=!0,this.type="LineBasicMaterial",this.color=new Ar(16777215),this.map=null,this.linewidth=1,this.linecap="round",this.linejoin="round",this.fog=!0,this.setValues(t)}copy(t){return super.copy(t),this.color.copy(t.color),this.map=t.map,this.linewidth=t.linewidth,this.linecap=t.linecap,this.linejoin=t.linejoin,this.fog=t.fog,this}}const na=new L,sa=new L,Au=new we,Gn=new Ho,Ws=new Ii,Mo=new L,Tu=new L;class ky extends Ye{constructor(t=new jr,e=new By){super(),this.isLine=!0,this.type="Line",this.geometry=t,this.material=e,this.morphTargetDictionary=void 0,this.morphTargetInfluences=void 0,this.updateMorphTargets()}copy(t,e){return super.copy(t,e),this.material=Array.isArray(t.material)?t.material.slice():t.material,this.geometry=t.geometry,this}computeLineDistances(){const t=this.geometry;if(t.index===null){const e=t.attributes.position,r=[0];for(let i=1,n=e.count;i<n;i++)na.fromBufferAttribute(e,i-1),sa.fromBufferAttribute(e,i),r[i]=r[i-1],r[i]+=na.distanceTo(sa);t.setAttribute("lineDistance",new Ke(r,1))}else console.warn("THREE.Line.computeLineDistances(): Computation only possible with non-indexed BufferGeometry.");return this}raycast(t,e){const r=this.geometry,i=this.matrixWorld,n=t.params.Line.threshold,a=r.drawRange;if(r.boundingSphere===null&&r.computeBoundingSphere(),Ws.copy(r.boundingSphere),Ws.applyMatrix4(i),Ws.radius+=n,t.ray.intersectsSphere(Ws)===!1)return;Au.copy(i).invert(),Gn.copy(t.ray).applyMatrix4(Au);const o=n/((this.scale.x+this.scale.y+this.scale.z)/3),c=o*o,h=this.isLineSegments?2:1,u=r.index,y=r.attributes.position;if(u!==null){const g=Math.max(0,a.start),A=Math.min(u.count,a.start+a.count);for(let D=g,H=A-1;D<H;D+=h){const V=u.getX(D),Tt=u.getX(D+1),ft=Ys(this,t,Gn,c,V,Tt,D);ft&&e.push(ft)}if(this.isLineLoop){const D=u.getX(A-1),H=u.getX(g),V=Ys(this,t,Gn,c,D,H,A-1);V&&e.push(V)}}else{const g=Math.max(0,a.start),A=Math.min(y.count,a.start+a.count);for(let D=g,H=A-1;D<H;D+=h){const V=Ys(this,t,Gn,c,D,D+1,D);V&&e.push(V)}if(this.isLineLoop){const D=Ys(this,t,Gn,c,A-1,g,A-1);D&&e.push(D)}}}updateMorphTargets(){const e=this.geometry.morphAttributes,r=Object.keys(e);if(r.length>0){const i=e[r[0]];if(i!==void 0){this.morphTargetInfluences=[],this.morphTargetDictionary={};for(let n=0,a=i.length;n<a;n++){const o=i[n].name||String(n);this.morphTargetInfluences.push(0),this.morphTargetDictionary[o]=n}}}}}function Ys(s,t,e,r,i,n,a){const o=s.geometry.attributes.position;if(na.fromBufferAttribute(o,i),sa.fromBufferAttribute(o,n),e.distanceSqToSegment(na,sa,Mo,Tu)>r)return;Mo.applyMatrix4(s.matrixWorld);const h=t.ray.origin.distanceTo(Mo);if(!(h<t.near||h>t.far))return{distance:h,point:Tu.clone().applyMatrix4(s.matrixWorld),index:a,face:null,faceIndex:null,barycoord:null,object:s}}const Su=new L,wu=new L;class S_ extends ky{constructor(t,e){super(t,e),this.isLineSegments=!0,this.type="LineSegments"}computeLineDistances(){const t=this.geometry;if(t.index===null){const e=t.attributes.position,r=[];for(let i=0,n=e.count;i<n;i+=2)Su.fromBufferAttribute(e,i),wu.fromBufferAttribute(e,i+1),r[i]=i===0?0:r[i-1],r[i+1]=r[i]+Su.distanceTo(wu);t.setAttribute("lineDistance",new Ke(r,1))}else console.warn("THREE.LineSegments.computeLineDistances(): Computation only possible with non-indexed BufferGeometry.");return this}}class zy extends Ri{constructor(t){super(),this.isPointsMaterial=!0,this.type="PointsMaterial",this.color=new Ar(16777215),this.map=null,this.alphaMap=null,this.size=1,this.sizeAttenuation=!0,this.fog=!0,this.setValues(t)}copy(t){return super.copy(t),this.color.copy(t.color),this.map=t.map,this.alphaMap=t.alphaMap,this.size=t.size,this.sizeAttenuation=t.sizeAttenuation,this.fog=t.fog,this}}const Mu=new we,zo=new Ho,Xs=new Ii,$s=new L;class w_ extends Ye{constructor(t=new jr,e=new zy){super(),this.isPoints=!0,this.type="Points",this.geometry=t,this.material=e,this.morphTargetDictionary=void 0,this.morphTargetInfluences=void 0,this.updateMorphTargets()}copy(t,e){return super.copy(t,e),this.material=Array.isArray(t.material)?t.material.slice():t.material,this.geometry=t.geometry,this}raycast(t,e){const r=this.geometry,i=this.matrixWorld,n=t.params.Points.threshold,a=r.drawRange;if(r.boundingSphere===null&&r.computeBoundingSphere(),Xs.copy(r.boundingSphere),Xs.applyMatrix4(i),Xs.radius+=n,t.ray.intersectsSphere(Xs)===!1)return;Mu.copy(i).invert(),zo.copy(t.ray).applyMatrix4(Mu);const o=n/((this.scale.x+this.scale.y+this.scale.z)/3),c=o*o,h=r.index,d=r.attributes.position;if(h!==null){const y=Math.max(0,a.start),g=Math.min(h.count,a.start+a.count);for(let A=y,D=g;A<D;A++){const H=h.getX(A);$s.fromBufferAttribute(d,H),Cu($s,H,c,i,t,e,this)}}else{const y=Math.max(0,a.start),g=Math.min(d.count,a.start+a.count);for(let A=y,D=g;A<D;A++)$s.fromBufferAttribute(d,A),Cu($s,A,c,i,t,e,this)}}updateMorphTargets(){const e=this.geometry.morphAttributes,r=Object.keys(e);if(r.length>0){const i=e[r[0]];if(i!==void 0){this.morphTargetInfluences=[],this.morphTargetDictionary={};for(let n=0,a=i.length;n<a;n++){const o=i[n].name||String(n);this.morphTargetInfluences.push(0),this.morphTargetDictionary[o]=n}}}}}function Cu(s,t,e,r,i,n,a){const o=zo.distanceSqToPoint(s);if(o<e){const c=new L;zo.closestPointToPoint(s,c),c.applyMatrix4(r);const h=i.ray.origin.distanceTo(c);if(h<i.near||h>i.far)return;n.push({distance:h,distanceToRay:Math.sqrt(o),point:c,index:t,face:null,faceIndex:null,barycoord:null,object:a})}}class M_ extends rr{constructor(t,e,r=Zu,i,n,a,o=ai,c=ai,h,u=Jh,d=1){if(u!==Jh&&u!==t0)throw new Error("DepthTexture format must be either THREE.DepthFormat or THREE.DepthStencilFormat");const y={width:t,height:e,depth:d};super(y,i,n,a,o,c,u,r,h),this.isDepthTexture=!0,this.flipY=!1,this.generateMipmaps=!1,this.compareFunction=null}copy(t){return super.copy(t),this.source=new jo(Object.assign({},t.image)),this.compareFunction=t.compareFunction,this}toJSON(t){const e=super.toJSON(t);return this.compareFunction!==null&&(e.compareFunction=this.compareFunction),e}}class Hr{constructor(){this.type="Curve",this.arcLengthDivisions=200,this.needsUpdate=!1,this.cacheArcLengths=null}getPoint(){console.warn("THREE.Curve: .getPoint() not implemented.")}getPointAt(t,e){const r=this.getUtoTmapping(t);return this.getPoint(r,e)}getPoints(t=5){const e=[];for(let r=0;r<=t;r++)e.push(this.getPoint(r/t));return e}getSpacedPoints(t=5){const e=[];for(let r=0;r<=t;r++)e.push(this.getPointAt(r/t));return e}getLength(){const t=this.getLengths();return t[t.length-1]}getLengths(t=this.arcLengthDivisions){if(this.cacheArcLengths&&this.cacheArcLengths.length===t+1&&!this.needsUpdate)return this.cacheArcLengths;this.needsUpdate=!1;const e=[];let r,i=this.getPoint(0),n=0;e.push(0);for(let a=1;a<=t;a++)r=this.getPoint(a/t),n+=r.distanceTo(i),e.push(n),i=r;return this.cacheArcLengths=e,e}updateArcLengths(){this.needsUpdate=!0,this.getLengths()}getUtoTmapping(t,e=null){const r=this.getLengths();let i=0;const n=r.length;let a;e?a=e:a=t*r[n-1];let o=0,c=n-1,h;for(;o<=c;)if(i=Math.floor(o+(c-o)/2),h=r[i]-a,h<0)o=i+1;else if(h>0)c=i-1;else{c=i;break}if(i=c,r[i]===a)return i/(n-1);const u=r[i],y=r[i+1]-u,g=(a-u)/y;return(i+g)/(n-1)}getTangent(t,e){let i=t-1e-4,n=t+1e-4;i<0&&(i=0),n>1&&(n=1);const a=this.getPoint(i),o=this.getPoint(n),c=e||(a.isVector2?new le:new L);return c.copy(o).sub(a).normalize(),c}getTangentAt(t,e){const r=this.getUtoTmapping(t);return this.getTangent(r,e)}computeFrenetFrames(t,e=!1){const r=new L,i=[],n=[],a=[],o=new L,c=new we;for(let g=0;g<=t;g++){const A=g/t;i[g]=this.getTangentAt(A,new L)}n[0]=new L,a[0]=new L;let h=Number.MAX_VALUE;const u=Math.abs(i[0].x),d=Math.abs(i[0].y),y=Math.abs(i[0].z);u<=h&&(h=u,r.set(1,0,0)),d<=h&&(h=d,r.set(0,1,0)),y<=h&&r.set(0,0,1),o.crossVectors(i[0],r).normalize(),n[0].crossVectors(i[0],o),a[0].crossVectors(i[0],n[0]);for(let g=1;g<=t;g++){if(n[g]=n[g-1].clone(),a[g]=a[g-1].clone(),o.crossVectors(i[g-1],i[g]),o.length()>Number.EPSILON){o.normalize();const A=Math.acos(ne(i[g-1].dot(i[g]),-1,1));n[g].applyMatrix4(c.makeRotationAxis(o,A))}a[g].crossVectors(i[g],n[g])}if(e===!0){let g=Math.acos(ne(n[0].dot(n[t]),-1,1));g/=t,i[0].dot(o.crossVectors(n[0],n[t]))>0&&(g=-g);for(let A=1;A<=t;A++)n[A].applyMatrix4(c.makeRotationAxis(i[A],g*A)),a[A].crossVectors(i[A],n[A])}return{tangents:i,normals:n,binormals:a}}clone(){return new this.constructor().copy(this)}copy(t){return this.arcLengthDivisions=t.arcLengthDivisions,this}toJSON(){const t={metadata:{version:4.7,type:"Curve",generator:"Curve.toJSON"}};return t.arcLengthDivisions=this.arcLengthDivisions,t.type=this.type,t}fromJSON(t){return this.arcLengthDivisions=t.arcLengthDivisions,this}}class af extends Hr{constructor(t=0,e=0,r=1,i=1,n=0,a=Math.PI*2,o=!1,c=0){super(),this.isEllipseCurve=!0,this.type="EllipseCurve",this.aX=t,this.aY=e,this.xRadius=r,this.yRadius=i,this.aStartAngle=n,this.aEndAngle=a,this.aClockwise=o,this.aRotation=c}getPoint(t,e=new le){const r=e,i=Math.PI*2;let n=this.aEndAngle-this.aStartAngle;const a=Math.abs(n)<Number.EPSILON;for(;n<0;)n+=i;for(;n>i;)n-=i;n<Number.EPSILON&&(a?n=0:n=i),this.aClockwise===!0&&!a&&(n===i?n=-i:n=n-i);const o=this.aStartAngle+t*n;let c=this.aX+this.xRadius*Math.cos(o),h=this.aY+this.yRadius*Math.sin(o);if(this.aRotation!==0){const u=Math.cos(this.aRotation),d=Math.sin(this.aRotation),y=c-this.aX,g=h-this.aY;c=y*u-g*d+this.aX,h=y*d+g*u+this.aY}return r.set(c,h)}copy(t){return super.copy(t),this.aX=t.aX,this.aY=t.aY,this.xRadius=t.xRadius,this.yRadius=t.yRadius,this.aStartAngle=t.aStartAngle,this.aEndAngle=t.aEndAngle,this.aClockwise=t.aClockwise,this.aRotation=t.aRotation,this}toJSON(){const t=super.toJSON();return t.aX=this.aX,t.aY=this.aY,t.xRadius=this.xRadius,t.yRadius=this.yRadius,t.aStartAngle=this.aStartAngle,t.aEndAngle=this.aEndAngle,t.aClockwise=this.aClockwise,t.aRotation=this.aRotation,t}fromJSON(t){return super.fromJSON(t),this.aX=t.aX,this.aY=t.aY,this.xRadius=t.xRadius,this.yRadius=t.yRadius,this.aStartAngle=t.aStartAngle,this.aEndAngle=t.aEndAngle,this.aClockwise=t.aClockwise,this.aRotation=t.aRotation,this}}class Uy extends af{constructor(t,e,r,i,n,a){super(t,e,r,r,i,n,a),this.isArcCurve=!0,this.type="ArcCurve"}}function Xo(){let s=0,t=0,e=0,r=0;function i(n,a,o,c){s=n,t=o,e=-3*n+3*a-2*o-c,r=2*n-2*a+o+c}return{initCatmullRom:function(n,a,o,c,h){i(a,o,h*(o-n),h*(c-a))},initNonuniformCatmullRom:function(n,a,o,c,h,u,d){let y=(a-n)/h-(o-n)/(h+u)+(o-a)/u,g=(o-a)/u-(c-a)/(u+d)+(c-o)/d;y*=u,g*=u,i(a,o,y,g)},calc:function(n){const a=n*n,o=a*n;return s+t*n+e*a+r*o}}}const qs=new L,Co=new Xo,Io=new Xo,Ro=new Xo;class Gy extends Hr{constructor(t=[],e=!1,r="centripetal",i=.5){super(),this.isCatmullRomCurve3=!0,this.type="CatmullRomCurve3",this.points=t,this.closed=e,this.curveType=r,this.tension=i}getPoint(t,e=new L){const r=e,i=this.points,n=i.length,a=(n-(this.closed?0:1))*t;let o=Math.floor(a),c=a-o;this.closed?o+=o>0?0:(Math.floor(Math.abs(o)/n)+1)*n:c===0&&o===n-1&&(o=n-2,c=1);let h,u;this.closed||o>0?h=i[(o-1)%n]:(qs.subVectors(i[0],i[1]).add(i[0]),h=qs);const d=i[o%n],y=i[(o+1)%n];if(this.closed||o+2<n?u=i[(o+2)%n]:(qs.subVectors(i[n-1],i[n-2]).add(i[n-1]),u=qs),this.curveType==="centripetal"||this.curveType==="chordal"){const g=this.curveType==="chordal"?.5:.25;let A=Math.pow(h.distanceToSquared(d),g),D=Math.pow(d.distanceToSquared(y),g),H=Math.pow(y.distanceToSquared(u),g);D<1e-4&&(D=1),A<1e-4&&(A=D),H<1e-4&&(H=D),Co.initNonuniformCatmullRom(h.x,d.x,y.x,u.x,A,D,H),Io.initNonuniformCatmullRom(h.y,d.y,y.y,u.y,A,D,H),Ro.initNonuniformCatmullRom(h.z,d.z,y.z,u.z,A,D,H)}else this.curveType==="catmullrom"&&(Co.initCatmullRom(h.x,d.x,y.x,u.x,this.tension),Io.initCatmullRom(h.y,d.y,y.y,u.y,this.tension),Ro.initCatmullRom(h.z,d.z,y.z,u.z,this.tension));return r.set(Co.calc(c),Io.calc(c),Ro.calc(c)),r}copy(t){super.copy(t),this.points=[];for(let e=0,r=t.points.length;e<r;e++){const i=t.points[e];this.points.push(i.clone())}return this.closed=t.closed,this.curveType=t.curveType,this.tension=t.tension,this}toJSON(){const t=super.toJSON();t.points=[];for(let e=0,r=this.points.length;e<r;e++){const i=this.points[e];t.points.push(i.toArray())}return t.closed=this.closed,t.curveType=this.curveType,t.tension=this.tension,t}fromJSON(t){super.fromJSON(t),this.points=[];for(let e=0,r=t.points.length;e<r;e++){const i=t.points[e];this.points.push(new L().fromArray(i))}return this.closed=t.closed,this.curveType=t.curveType,this.tension=t.tension,this}}function Iu(s,t,e,r,i){const n=(r-t)*.5,a=(i-e)*.5,o=s*s,c=s*o;return(2*e-2*r+n+a)*c+(-3*e+3*r-2*n-a)*o+n*s+e}function Vy(s,t){const e=1-s;return e*e*t}function jy(s,t){return 2*(1-s)*s*t}function Hy(s,t){return s*s*t}function Yn(s,t,e,r){return Vy(s,t)+jy(s,e)+Hy(s,r)}function Wy(s,t){const e=1-s;return e*e*e*t}function Yy(s,t){const e=1-s;return 3*e*e*s*t}function Xy(s,t){return 3*(1-s)*s*s*t}function $y(s,t){return s*s*s*t}function Xn(s,t,e,r,i){return Wy(s,t)+Yy(s,e)+Xy(s,r)+$y(s,i)}class qy extends Hr{constructor(t=new le,e=new le,r=new le,i=new le){super(),this.isCubicBezierCurve=!0,this.type="CubicBezierCurve",this.v0=t,this.v1=e,this.v2=r,this.v3=i}getPoint(t,e=new le){const r=e,i=this.v0,n=this.v1,a=this.v2,o=this.v3;return r.set(Xn(t,i.x,n.x,a.x,o.x),Xn(t,i.y,n.y,a.y,o.y)),r}copy(t){return super.copy(t),this.v0.copy(t.v0),this.v1.copy(t.v1),this.v2.copy(t.v2),this.v3.copy(t.v3),this}toJSON(){const t=super.toJSON();return t.v0=this.v0.toArray(),t.v1=this.v1.toArray(),t.v2=this.v2.toArray(),t.v3=this.v3.toArray(),t}fromJSON(t){return super.fromJSON(t),this.v0.fromArray(t.v0),this.v1.fromArray(t.v1),this.v2.fromArray(t.v2),this.v3.fromArray(t.v3),this}}class Jy extends Hr{constructor(t=new L,e=new L,r=new L,i=new L){super(),this.isCubicBezierCurve3=!0,this.type="CubicBezierCurve3",this.v0=t,this.v1=e,this.v2=r,this.v3=i}getPoint(t,e=new L){const r=e,i=this.v0,n=this.v1,a=this.v2,o=this.v3;return r.set(Xn(t,i.x,n.x,a.x,o.x),Xn(t,i.y,n.y,a.y,o.y),Xn(t,i.z,n.z,a.z,o.z)),r}copy(t){return super.copy(t),this.v0.copy(t.v0),this.v1.copy(t.v1),this.v2.copy(t.v2),this.v3.copy(t.v3),this}toJSON(){const t=super.toJSON();return t.v0=this.v0.toArray(),t.v1=this.v1.toArray(),t.v2=this.v2.toArray(),t.v3=this.v3.toArray(),t}fromJSON(t){return super.fromJSON(t),this.v0.fromArray(t.v0),this.v1.fromArray(t.v1),this.v2.fromArray(t.v2),this.v3.fromArray(t.v3),this}}class Zy extends Hr{constructor(t=new le,e=new le){super(),this.isLineCurve=!0,this.type="LineCurve",this.v1=t,this.v2=e}getPoint(t,e=new le){const r=e;return t===1?r.copy(this.v2):(r.copy(this.v2).sub(this.v1),r.multiplyScalar(t).add(this.v1)),r}getPointAt(t,e){return this.getPoint(t,e)}getTangent(t,e=new le){return e.subVectors(this.v2,this.v1).normalize()}getTangentAt(t,e){return this.getTangent(t,e)}copy(t){return super.copy(t),this.v1.copy(t.v1),this.v2.copy(t.v2),this}toJSON(){const t=super.toJSON();return t.v1=this.v1.toArray(),t.v2=this.v2.toArray(),t}fromJSON(t){return super.fromJSON(t),this.v1.fromArray(t.v1),this.v2.fromArray(t.v2),this}}class Ky extends Hr{constructor(t=new L,e=new L){super(),this.isLineCurve3=!0,this.type="LineCurve3",this.v1=t,this.v2=e}getPoint(t,e=new L){const r=e;return t===1?r.copy(this.v2):(r.copy(this.v2).sub(this.v1),r.multiplyScalar(t).add(this.v1)),r}getPointAt(t,e){return this.getPoint(t,e)}getTangent(t,e=new L){return e.subVectors(this.v2,this.v1).normalize()}getTangentAt(t,e){return this.getTangent(t,e)}copy(t){return super.copy(t),this.v1.copy(t.v1),this.v2.copy(t.v2),this}toJSON(){const t=super.toJSON();return t.v1=this.v1.toArray(),t.v2=this.v2.toArray(),t}fromJSON(t){return super.fromJSON(t),this.v1.fromArray(t.v1),this.v2.fromArray(t.v2),this}}class Qy extends Hr{constructor(t=new le,e=new le,r=new le){super(),this.isQuadraticBezierCurve=!0,this.type="QuadraticBezierCurve",this.v0=t,this.v1=e,this.v2=r}getPoint(t,e=new le){const r=e,i=this.v0,n=this.v1,a=this.v2;return r.set(Yn(t,i.x,n.x,a.x),Yn(t,i.y,n.y,a.y)),r}copy(t){return super.copy(t),this.v0.copy(t.v0),this.v1.copy(t.v1),this.v2.copy(t.v2),this}toJSON(){const t=super.toJSON();return t.v0=this.v0.toArray(),t.v1=this.v1.toArray(),t.v2=this.v2.toArray(),t}fromJSON(t){return super.fromJSON(t),this.v0.fromArray(t.v0),this.v1.fromArray(t.v1),this.v2.fromArray(t.v2),this}}class of extends Hr{constructor(t=new L,e=new L,r=new L){super(),this.isQuadraticBezierCurve3=!0,this.type="QuadraticBezierCurve3",this.v0=t,this.v1=e,this.v2=r}getPoint(t,e=new L){const r=e,i=this.v0,n=this.v1,a=this.v2;return r.set(Yn(t,i.x,n.x,a.x),Yn(t,i.y,n.y,a.y),Yn(t,i.z,n.z,a.z)),r}copy(t){return super.copy(t),this.v0.copy(t.v0),this.v1.copy(t.v1),this.v2.copy(t.v2),this}toJSON(){const t=super.toJSON();return t.v0=this.v0.toArray(),t.v1=this.v1.toArray(),t.v2=this.v2.toArray(),t}fromJSON(t){return super.fromJSON(t),this.v0.fromArray(t.v0),this.v1.fromArray(t.v1),this.v2.fromArray(t.v2),this}}class tx extends Hr{constructor(t=[]){super(),this.isSplineCurve=!0,this.type="SplineCurve",this.points=t}getPoint(t,e=new le){const r=e,i=this.points,n=(i.length-1)*t,a=Math.floor(n),o=n-a,c=i[a===0?a:a-1],h=i[a],u=i[a>i.length-2?i.length-1:a+1],d=i[a>i.length-3?i.length-1:a+2];return r.set(Iu(o,c.x,h.x,u.x,d.x),Iu(o,c.y,h.y,u.y,d.y)),r}copy(t){super.copy(t),this.points=[];for(let e=0,r=t.points.length;e<r;e++){const i=t.points[e];this.points.push(i.clone())}return this}toJSON(){const t=super.toJSON();t.points=[];for(let e=0,r=this.points.length;e<r;e++){const i=this.points[e];t.points.push(i.toArray())}return t}fromJSON(t){super.fromJSON(t),this.points=[];for(let e=0,r=t.points.length;e<r;e++){const i=t.points[e];this.points.push(new le().fromArray(i))}return this}}var ex=Object.freeze({__proto__:null,ArcCurve:Uy,CatmullRomCurve3:Gy,CubicBezierCurve:qy,CubicBezierCurve3:Jy,EllipseCurve:af,LineCurve:Zy,LineCurve3:Ky,QuadraticBezierCurve:Qy,QuadraticBezierCurve3:of,SplineCurve:tx});class lf extends jr{constructor(t=1,e=1,r=1,i=1){super(),this.type="PlaneGeometry",this.parameters={width:t,height:e,widthSegments:r,heightSegments:i};const n=t/2,a=e/2,o=Math.floor(r),c=Math.floor(i),h=o+1,u=c+1,d=t/o,y=e/c,g=[],A=[],D=[],H=[];for(let V=0;V<u;V++){const Tt=V*y-a;for(let ft=0;ft<h;ft++){const ct=ft*d-n;A.push(ct,-Tt,0),D.push(0,0,1),H.push(ft/o),H.push(1-V/c)}}for(let V=0;V<c;V++)for(let Tt=0;Tt<o;Tt++){const ft=Tt+h*V,ct=Tt+h*(V+1),Mt=Tt+1+h*(V+1),Dt=Tt+1+h*V;g.push(ft,ct,Dt),g.push(ct,Mt,Dt)}this.setIndex(g),this.setAttribute("position",new Ke(A,3)),this.setAttribute("normal",new Ke(D,3)),this.setAttribute("uv",new Ke(H,2))}copy(t){return super.copy(t),this.parameters=Object.assign({},t.parameters),this}static fromJSON(t){return new lf(t.width,t.height,t.widthSegments,t.heightSegments)}}class cf extends jr{constructor(t=1,e=32,r=16,i=0,n=Math.PI*2,a=0,o=Math.PI){super(),this.type="SphereGeometry",this.parameters={radius:t,widthSegments:e,heightSegments:r,phiStart:i,phiLength:n,thetaStart:a,thetaLength:o},e=Math.max(3,Math.floor(e)),r=Math.max(2,Math.floor(r));const c=Math.min(a+o,Math.PI);let h=0;const u=[],d=new L,y=new L,g=[],A=[],D=[],H=[];for(let V=0;V<=r;V++){const Tt=[],ft=V/r;let ct=0;V===0&&a===0?ct=.5/e:V===r&&c===Math.PI&&(ct=-.5/e);for(let Mt=0;Mt<=e;Mt++){const Dt=Mt/e;d.x=-t*Math.cos(i+Dt*n)*Math.sin(a+ft*o),d.y=t*Math.cos(a+ft*o),d.z=t*Math.sin(i+Dt*n)*Math.sin(a+ft*o),A.push(d.x,d.y,d.z),y.copy(d).normalize(),D.push(y.x,y.y,y.z),H.push(Dt+ct,1-ft),Tt.push(h++)}u.push(Tt)}for(let V=0;V<r;V++)for(let Tt=0;Tt<e;Tt++){const ft=u[V][Tt+1],ct=u[V][Tt],Mt=u[V+1][Tt],Dt=u[V+1][Tt+1];(V!==0||a>0)&&g.push(ft,ct,Dt),(V!==r-1||c<Math.PI)&&g.push(ct,Mt,Dt)}this.setIndex(g),this.setAttribute("position",new Ke(A,3)),this.setAttribute("normal",new Ke(D,3)),this.setAttribute("uv",new Ke(H,2))}copy(t){return super.copy(t),this.parameters=Object.assign({},t.parameters),this}static fromJSON(t){return new cf(t.radius,t.widthSegments,t.heightSegments,t.phiStart,t.phiLength,t.thetaStart,t.thetaLength)}}class hf extends jr{constructor(t=new of(new L(-1,-1,0),new L(-1,1,0),new L(1,1,0)),e=64,r=1,i=8,n=!1){super(),this.type="TubeGeometry",this.parameters={path:t,tubularSegments:e,radius:r,radialSegments:i,closed:n};const a=t.computeFrenetFrames(e,n);this.tangents=a.tangents,this.normals=a.normals,this.binormals=a.binormals;const o=new L,c=new L,h=new le;let u=new L;const d=[],y=[],g=[],A=[];D(),this.setIndex(A),this.setAttribute("position",new Ke(d,3)),this.setAttribute("normal",new Ke(y,3)),this.setAttribute("uv",new Ke(g,2));function D(){for(let ft=0;ft<e;ft++)H(ft);H(n===!1?e:0),Tt(),V()}function H(ft){u=t.getPointAt(ft/e,u);const ct=a.normals[ft],Mt=a.binormals[ft];for(let Dt=0;Dt<=i;Dt++){const Et=Dt/i*Math.PI*2,St=Math.sin(Et),Xt=-Math.cos(Et);c.x=Xt*ct.x+St*Mt.x,c.y=Xt*ct.y+St*Mt.y,c.z=Xt*ct.z+St*Mt.z,c.normalize(),y.push(c.x,c.y,c.z),o.x=u.x+r*c.x,o.y=u.y+r*c.y,o.z=u.z+r*c.z,d.push(o.x,o.y,o.z)}}function V(){for(let ft=1;ft<=e;ft++)for(let ct=1;ct<=i;ct++){const Mt=(i+1)*(ft-1)+(ct-1),Dt=(i+1)*ft+(ct-1),Et=(i+1)*ft+ct,St=(i+1)*(ft-1)+ct;A.push(Mt,Dt,St),A.push(Dt,Et,St)}}function Tt(){for(let ft=0;ft<=e;ft++)for(let ct=0;ct<=i;ct++)h.x=ft/e,h.y=ct/i,g.push(h.x,h.y)}}copy(t){return super.copy(t),this.parameters=Object.assign({},t.parameters),this}toJSON(){const t=super.toJSON();return t.path=this.parameters.path.toJSON(),t}static fromJSON(t){return new hf(new ex[t.path.type]().fromJSON(t.path),t.tubularSegments,t.radius,t.radialSegments,t.closed)}}class C_ extends Ri{constructor(t){super(),this.isMeshStandardMaterial=!0,this.type="MeshStandardMaterial",this.defines={STANDARD:""},this.color=new Ar(16777215),this.roughness=1,this.metalness=0,this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new Ar(0),this.emissiveIntensity=1,this.emissiveMap=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=k0,this.normalScale=new le(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.roughnessMap=null,this.metalnessMap=null,this.alphaMap=null,this.envMap=null,this.envMapRotation=new oi,this.envMapIntensity=1,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.flatShading=!1,this.fog=!0,this.setValues(t)}copy(t){return super.copy(t),this.defines={STANDARD:""},this.color.copy(t.color),this.roughness=t.roughness,this.metalness=t.metalness,this.map=t.map,this.lightMap=t.lightMap,this.lightMapIntensity=t.lightMapIntensity,this.aoMap=t.aoMap,this.aoMapIntensity=t.aoMapIntensity,this.emissive.copy(t.emissive),this.emissiveMap=t.emissiveMap,this.emissiveIntensity=t.emissiveIntensity,this.bumpMap=t.bumpMap,this.bumpScale=t.bumpScale,this.normalMap=t.normalMap,this.normalMapType=t.normalMapType,this.normalScale.copy(t.normalScale),this.displacementMap=t.displacementMap,this.displacementScale=t.displacementScale,this.displacementBias=t.displacementBias,this.roughnessMap=t.roughnessMap,this.metalnessMap=t.metalnessMap,this.alphaMap=t.alphaMap,this.envMap=t.envMap,this.envMapRotation.copy(t.envMapRotation),this.envMapIntensity=t.envMapIntensity,this.wireframe=t.wireframe,this.wireframeLinewidth=t.wireframeLinewidth,this.wireframeLinecap=t.wireframeLinecap,this.wireframeLinejoin=t.wireframeLinejoin,this.flatShading=t.flatShading,this.fog=t.fog,this}}class I_ extends Ri{constructor(t){super(),this.isMeshDepthMaterial=!0,this.type="MeshDepthMaterial",this.depthPacking=B0,this.map=null,this.alphaMap=null,this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.wireframe=!1,this.wireframeLinewidth=1,this.setValues(t)}copy(t){return super.copy(t),this.depthPacking=t.depthPacking,this.map=t.map,this.alphaMap=t.alphaMap,this.displacementMap=t.displacementMap,this.displacementScale=t.displacementScale,this.displacementBias=t.displacementBias,this.wireframe=t.wireframe,this.wireframeLinewidth=t.wireframeLinewidth,this}}class R_ extends Ri{constructor(t){super(),this.isMeshDistanceMaterial=!0,this.type="MeshDistanceMaterial",this.map=null,this.alphaMap=null,this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.setValues(t)}copy(t){return super.copy(t),this.map=t.map,this.alphaMap=t.alphaMap,this.displacementMap=t.displacementMap,this.displacementScale=t.displacementScale,this.displacementBias=t.displacementBias,this}}const Oo={enabled:!1,files:{},add:function(s,t){this.enabled!==!1&&(this.files[s]=t)},get:function(s){if(this.enabled!==!1)return this.files[s]},remove:function(s){delete this.files[s]},clear:function(){this.files={}}};class rx{constructor(t,e,r){const i=this;let n=!1,a=0,o=0,c;const h=[];this.onStart=void 0,this.onLoad=t,this.onProgress=e,this.onError=r,this.itemStart=function(u){o++,n===!1&&i.onStart!==void 0&&i.onStart(u,a,o),n=!0},this.itemEnd=function(u){a++,i.onProgress!==void 0&&i.onProgress(u,a,o),a===o&&(n=!1,i.onLoad!==void 0&&i.onLoad())},this.itemError=function(u){i.onError!==void 0&&i.onError(u)},this.resolveURL=function(u){return c?c(u):u},this.setURLModifier=function(u){return c=u,this},this.addHandler=function(u,d){return h.push(u,d),this},this.removeHandler=function(u){const d=h.indexOf(u);return d!==-1&&h.splice(d,2),this},this.getHandler=function(u){for(let d=0,y=h.length;d<y;d+=2){const g=h[d],A=h[d+1];if(g.global&&(g.lastIndex=0),g.test(u))return A}return null}}}const ix=new rx;class $o{constructor(t){this.manager=t!==void 0?t:ix,this.crossOrigin="anonymous",this.withCredentials=!1,this.path="",this.resourcePath="",this.requestHeader={}}load(){}loadAsync(t,e){const r=this;return new Promise(function(i,n){r.load(t,i,e,n)})}parse(){}setCrossOrigin(t){return this.crossOrigin=t,this}setWithCredentials(t){return this.withCredentials=t,this}setPath(t){return this.path=t,this}setResourcePath(t){return this.resourcePath=t,this}setRequestHeader(t){return this.requestHeader=t,this}}$o.DEFAULT_MATERIAL_NAME="__DEFAULT";const cn=new WeakMap;class nx extends $o{constructor(t){super(t)}load(t,e,r,i){this.path!==void 0&&(t=this.path+t),t=this.manager.resolveURL(t);const n=this,a=Oo.get(`image:${t}`);if(a!==void 0){if(a.complete===!0)n.manager.itemStart(t),setTimeout(function(){e&&e(a),n.manager.itemEnd(t)},0);else{let d=cn.get(a);d===void 0&&(d=[],cn.set(a,d)),d.push({onLoad:e,onError:i})}return a}const o=ia("img");function c(){u(),e&&e(this);const d=cn.get(this)||[];for(let y=0;y<d.length;y++){const g=d[y];g.onLoad&&g.onLoad(this)}cn.delete(this),n.manager.itemEnd(t)}function h(d){u(),i&&i(d),Oo.remove(`image:${t}`);const y=cn.get(this)||[];for(let g=0;g<y.length;g++){const A=y[g];A.onError&&A.onError(d)}cn.delete(this),n.manager.itemError(t),n.manager.itemEnd(t)}function u(){o.removeEventListener("load",c,!1),o.removeEventListener("error",h,!1)}return o.addEventListener("load",c,!1),o.addEventListener("error",h,!1),t.slice(0,5)!=="data:"&&this.crossOrigin!==void 0&&(o.crossOrigin=this.crossOrigin),Oo.add(`image:${t}`,o),n.manager.itemStart(t),o.src=t,o}}class O_ extends $o{constructor(t){super(t)}load(t,e,r,i){const n=new rr,a=new nx(this.manager);return a.setCrossOrigin(this.crossOrigin),a.setPath(this.path),a.load(t,function(o){n.image=o,n.needsUpdate=!0,e!==void 0&&e(n)},r,i),n}}class qo extends Ye{constructor(t,e=1){super(),this.isLight=!0,this.type="Light",this.color=new Ar(t),this.intensity=e}dispose(){}copy(t,e){return super.copy(t,e),this.color.copy(t.color),this.intensity=t.intensity,this}toJSON(t){const e=super.toJSON(t);return e.object.color=this.color.getHex(),e.object.intensity=this.intensity,this.groundColor!==void 0&&(e.object.groundColor=this.groundColor.getHex()),this.distance!==void 0&&(e.object.distance=this.distance),this.angle!==void 0&&(e.object.angle=this.angle),this.decay!==void 0&&(e.object.decay=this.decay),this.penumbra!==void 0&&(e.object.penumbra=this.penumbra),this.shadow!==void 0&&(e.object.shadow=this.shadow.toJSON()),this.target!==void 0&&(e.object.target=this.target.uuid),e}}const No=new we,Ru=new L,Ou=new L;class uf{constructor(t){this.camera=t,this.intensity=1,this.bias=0,this.normalBias=0,this.radius=1,this.blurSamples=8,this.mapSize=new le(512,512),this.mapType=Uo,this.map=null,this.mapPass=null,this.matrix=new we,this.autoUpdate=!0,this.needsUpdate=!1,this._frustum=new Py,this._frameExtents=new le(1,1),this._viewportCount=1,this._viewports=[new er(0,0,1,1)]}getViewportCount(){return this._viewportCount}getFrustum(){return this._frustum}updateMatrices(t){const e=this.camera,r=this.matrix;Ru.setFromMatrixPosition(t.matrixWorld),e.position.copy(Ru),Ou.setFromMatrixPosition(t.target.matrixWorld),e.lookAt(Ou),e.updateMatrixWorld(),No.multiplyMatrices(e.projectionMatrix,e.matrixWorldInverse),this._frustum.setFromProjectionMatrix(No),r.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),r.multiply(No)}getViewport(t){return this._viewports[t]}getFrameExtents(){return this._frameExtents}dispose(){this.map&&this.map.dispose(),this.mapPass&&this.mapPass.dispose()}copy(t){return this.camera=t.camera.clone(),this.intensity=t.intensity,this.bias=t.bias,this.radius=t.radius,this.autoUpdate=t.autoUpdate,this.needsUpdate=t.needsUpdate,this.normalBias=t.normalBias,this.blurSamples=t.blurSamples,this.mapSize.copy(t.mapSize),this}clone(){return new this.constructor().copy(this)}toJSON(){const t={};return this.intensity!==1&&(t.intensity=this.intensity),this.bias!==0&&(t.bias=this.bias),this.normalBias!==0&&(t.normalBias=this.normalBias),this.radius!==1&&(t.radius=this.radius),(this.mapSize.x!==512||this.mapSize.y!==512)&&(t.mapSize=this.mapSize.toArray()),t.camera=this.camera.toJSON(!1).object,delete t.camera.matrix,t}}const Nu=new we,Vn=new L,Lo=new L;class sx extends uf{constructor(){super(new ii(90,1,.5,500)),this.isPointLightShadow=!0,this._frameExtents=new le(4,2),this._viewportCount=6,this._viewports=[new er(2,1,1,1),new er(0,1,1,1),new er(3,1,1,1),new er(1,1,1,1),new er(3,0,1,1),new er(1,0,1,1)],this._cubeDirections=[new L(1,0,0),new L(-1,0,0),new L(0,0,1),new L(0,0,-1),new L(0,1,0),new L(0,-1,0)],this._cubeUps=[new L(0,1,0),new L(0,1,0),new L(0,1,0),new L(0,1,0),new L(0,0,1),new L(0,0,-1)]}updateMatrices(t,e=0){const r=this.camera,i=this.matrix,n=t.distance||r.far;n!==r.far&&(r.far=n,r.updateProjectionMatrix()),Vn.setFromMatrixPosition(t.matrixWorld),r.position.copy(Vn),Lo.copy(r.position),Lo.add(this._cubeDirections[e]),r.up.copy(this._cubeUps[e]),r.lookAt(Lo),r.updateMatrixWorld(),i.makeTranslation(-Vn.x,-Vn.y,-Vn.z),Nu.multiplyMatrices(r.projectionMatrix,r.matrixWorldInverse),this._frustum.setFromProjectionMatrix(Nu)}}class N_ extends qo{constructor(t,e,r=0,i=2){super(t,e),this.isPointLight=!0,this.type="PointLight",this.distance=r,this.decay=i,this.shadow=new sx}get power(){return this.intensity*4*Math.PI}set power(t){this.intensity=t/(4*Math.PI)}dispose(){this.shadow.dispose()}copy(t,e){return super.copy(t,e),this.distance=t.distance,this.decay=t.decay,this.shadow=t.shadow.clone(),this}}class ax extends rf{constructor(t=-1,e=1,r=1,i=-1,n=.1,a=2e3){super(),this.isOrthographicCamera=!0,this.type="OrthographicCamera",this.zoom=1,this.view=null,this.left=t,this.right=e,this.top=r,this.bottom=i,this.near=n,this.far=a,this.updateProjectionMatrix()}copy(t,e){return super.copy(t,e),this.left=t.left,this.right=t.right,this.top=t.top,this.bottom=t.bottom,this.near=t.near,this.far=t.far,this.zoom=t.zoom,this.view=t.view===null?null:Object.assign({},t.view),this}setViewOffset(t,e,r,i,n,a){this.view===null&&(this.view={enabled:!0,fullWidth:1,fullHeight:1,offsetX:0,offsetY:0,width:1,height:1}),this.view.enabled=!0,this.view.fullWidth=t,this.view.fullHeight=e,this.view.offsetX=r,this.view.offsetY=i,this.view.width=n,this.view.height=a,this.updateProjectionMatrix()}clearViewOffset(){this.view!==null&&(this.view.enabled=!1),this.updateProjectionMatrix()}updateProjectionMatrix(){const t=(this.right-this.left)/(2*this.zoom),e=(this.top-this.bottom)/(2*this.zoom),r=(this.right+this.left)/2,i=(this.top+this.bottom)/2;let n=r-t,a=r+t,o=i+e,c=i-e;if(this.view!==null&&this.view.enabled){const h=(this.right-this.left)/this.view.fullWidth/this.zoom,u=(this.top-this.bottom)/this.view.fullHeight/this.zoom;n+=h*this.view.offsetX,a=n+h*this.view.width,o-=u*this.view.offsetY,c=o-u*this.view.height}this.projectionMatrix.makeOrthographic(n,a,o,c,this.near,this.far,this.coordinateSystem),this.projectionMatrixInverse.copy(this.projectionMatrix).invert()}toJSON(t){const e=super.toJSON(t);return e.object.zoom=this.zoom,e.object.left=this.left,e.object.right=this.right,e.object.top=this.top,e.object.bottom=this.bottom,e.object.near=this.near,e.object.far=this.far,this.view!==null&&(e.object.view=Object.assign({},this.view)),e}}class ox extends uf{constructor(){super(new ax(-5,5,5,-5,.5,500)),this.isDirectionalLightShadow=!0}}class L_ extends qo{constructor(t,e){super(t,e),this.isDirectionalLight=!0,this.type="DirectionalLight",this.position.copy(Ye.DEFAULT_UP),this.updateMatrix(),this.target=new Ye,this.shadow=new ox}dispose(){this.shadow.dispose()}copy(t){return super.copy(t),this.target=t.target.clone(),this.shadow=t.shadow.clone(),this}}class D_ extends qo{constructor(t,e){super(t,e),this.isAmbientLight=!0,this.type="AmbientLight"}}class F_ extends ii{constructor(t=[]){super(),this.isArrayCamera=!0,this.isMultiViewCamera=!1,this.cameras=t}}class P_{constructor(t=!0){this.autoStart=t,this.startTime=0,this.oldTime=0,this.elapsedTime=0,this.running=!1}start(){this.startTime=performance.now(),this.oldTime=this.startTime,this.elapsedTime=0,this.running=!0}stop(){this.getElapsedTime(),this.running=!1,this.autoStart=!1}getElapsedTime(){return this.getDelta(),this.elapsedTime}getDelta(){let t=0;if(this.autoStart&&!this.running)return this.start(),0;if(this.running){const e=performance.now();t=(e-this.oldTime)/1e3,this.oldTime=e,this.elapsedTime+=t}return t}}const Lu=new L,Js=new L;class B_{constructor(t=new L,e=new L){this.start=t,this.end=e}set(t,e){return this.start.copy(t),this.end.copy(e),this}copy(t){return this.start.copy(t.start),this.end.copy(t.end),this}getCenter(t){return t.addVectors(this.start,this.end).multiplyScalar(.5)}delta(t){return t.subVectors(this.end,this.start)}distanceSq(){return this.start.distanceToSquared(this.end)}distance(){return this.start.distanceTo(this.end)}at(t,e){return this.delta(e).multiplyScalar(t).add(this.start)}closestPointToPointParameter(t,e){Lu.subVectors(t,this.start),Js.subVectors(this.end,this.start);const r=Js.dot(Js);let n=Js.dot(Lu)/r;return e&&(n=ne(n,0,1)),n}closestPointToPoint(t,e,r){const i=this.closestPointToPointParameter(t,e);return this.delta(r).multiplyScalar(i).add(this.start)}applyMatrix4(t){return this.start.applyMatrix4(t),this.end.applyMatrix4(t),this}equals(t){return t.start.equals(this.start)&&t.end.equals(this.end)}clone(){return new this.constructor().copy(this)}}function k_(s,t,e,r){const i=lx(r);switch(e){case Kp:return s*t;case Qu:return s*t/i.components*i.byteLength;case e0:return s*t/i.components*i.byteLength;case r0:return s*t*2/i.components*i.byteLength;case i0:return s*t*2/i.components*i.byteLength;case Qp:return s*t*3/i.components*i.byteLength;case Ku:return s*t*4/i.components*i.byteLength;case n0:return s*t*4/i.components*i.byteLength;case s0:case a0:return Math.floor((s+3)/4)*Math.floor((t+3)/4)*8;case o0:case l0:return Math.floor((s+3)/4)*Math.floor((t+3)/4)*16;case h0:case f0:return Math.max(s,16)*Math.max(t,8)/4;case c0:case u0:return Math.max(s,8)*Math.max(t,8)/2;case d0:case m0:return Math.floor((s+3)/4)*Math.floor((t+3)/4)*8;case p0:return Math.floor((s+3)/4)*Math.floor((t+3)/4)*16;case y0:return Math.floor((s+3)/4)*Math.floor((t+3)/4)*16;case x0:return Math.floor((s+4)/5)*Math.floor((t+3)/4)*16;case g0:return Math.floor((s+4)/5)*Math.floor((t+4)/5)*16;case _0:return Math.floor((s+5)/6)*Math.floor((t+4)/5)*16;case b0:return Math.floor((s+5)/6)*Math.floor((t+5)/6)*16;case v0:return Math.floor((s+7)/8)*Math.floor((t+4)/5)*16;case E0:return Math.floor((s+7)/8)*Math.floor((t+5)/6)*16;case A0:return Math.floor((s+7)/8)*Math.floor((t+7)/8)*16;case T0:return Math.floor((s+9)/10)*Math.floor((t+4)/5)*16;case S0:return Math.floor((s+9)/10)*Math.floor((t+5)/6)*16;case w0:return Math.floor((s+9)/10)*Math.floor((t+7)/8)*16;case M0:return Math.floor((s+9)/10)*Math.floor((t+9)/10)*16;case C0:return Math.floor((s+11)/12)*Math.floor((t+9)/10)*16;case I0:return Math.floor((s+11)/12)*Math.floor((t+11)/12)*16;case R0:case O0:case N0:return Math.ceil(s/4)*Math.ceil(t/4)*16;case L0:case D0:return Math.ceil(s/4)*Math.ceil(t/4)*8;case F0:case P0:return Math.ceil(s/4)*Math.ceil(t/4)*16}throw new Error(`Unable to determine texture byte length for ${e} format.`)}function lx(s){switch(s){case Uo:case Hp:return{byteLength:1,components:1};case Yp:case Wp:case $p:return{byteLength:2,components:1};case qp:case Jp:return{byteLength:2,components:4};case Zu:case Xp:case Go:return{byteLength:4,components:1};case Zp:return{byteLength:4,components:3}}throw new Error(`Unknown texture type ${s}.`)}typeof __THREE_DEVTOOLS__<"u"&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("register",{detail:{revision:Xu}}));typeof window<"u"&&(window.__THREE__?console.warn("WARNING: Multiple instances of Three.js being imported."):window.__THREE__=Xu);const Zs={CAMERA_BASE_FOV:75,CAMERA_MAX_FOV_BOOST:25,CAMERA_SPEED_FOV_FACTOR:5,INITIAL_TRACK_SEGMENT_LENGTH:50,INITIAL_TRACK_SEGMENT_SPACING:2.5,TRACK_SEGMENT_RESOLUTION:100,DEFAULT_SKY_COLOR_2:"#1a0b2e",PARTICLE_COUNT:1e4,PARTICLE_SPAWN_COUNT:200,PARTICLE_BASE_SIZE:.5},cx=2.5,hx=s=>{if(typeof s!="string")return"unknown";const t=s.trim().toLowerCase();return t==="climb"||t.startsWith("climb")?"climb":t==="drop"||t.startsWith("drop")?"drop":t==="turn"||t.startsWith("turn")?"turn":t==="loop"||t.includes("loop")?"loop":t==="barrelroll"||t==="barrel_roll"||t==="barrel roll"||t==="roll"||t.includes("roll")?"barrelRoll":"unknown"},mr=(s,t)=>Number.isFinite(s)?Se.clamp(s,0,1):Se.clamp(t,0,1),ux=s=>{if(!s||typeof s!="object")return null;const t=s;let e=null;if(t.geometry&&typeof t.geometry=="object"){const n=t.geometry,a=typeof n.breathingDriver=="string"?n.breathingDriver.toString().toLowerCase():void 0;e={wireframeDensity:Number.isFinite(n.wireframeDensity)?mr(n.wireframeDensity,.55):void 0,impossiblePhysics:typeof n.impossiblePhysics=="object"&&n.impossiblePhysics!==null?{enabled:typeof n.impossiblePhysics.enabled=="boolean"?n.impossiblePhysics.enabled:!1,intensity:Number.isFinite(n.impossiblePhysics.intensity)?mr(n.impossiblePhysics.intensity,.5):void 0,frequency:Number.isFinite(n.impossiblePhysics.frequency)?Math.max(.1,n.impossiblePhysics.frequency):void 0}:void 0,organicBreathing:Number.isFinite(n.organicBreathing)?mr(n.organicBreathing,.4):void 0,breathingDriver:a==="energy"||a==="spectralflux"||a==="spectralcentroid"?a==="spectralflux"?"spectralFlux":a==="spectralcentroid"?"spectralCentroid":"energy":void 0}}let r=null;if(t.particles&&typeof t.particles=="object"){const n=t.particles;r={connectionDensity:Number.isFinite(n.connectionDensity)?mr(n.connectionDensity,.45):void 0,resonanceThreshold:Number.isFinite(n.resonanceThreshold)?mr(n.resonanceThreshold,.4):void 0,lifespanSeconds:Number.isFinite(n.lifespanSeconds)?Math.max(0,n.lifespanSeconds):void 0,persistence:Number.isFinite(n.persistence)?mr(n.persistence,.5):void 0}}let i=null;if(t.atmosphere&&typeof t.atmosphere=="object"){const n=t.atmosphere;i={skyMood:typeof n.skyMood=="string"?n.skyMood:void 0,turbulenceBias:Number.isFinite(n.turbulenceBias)?n.turbulenceBias:void 0,passionIntensity:Number.isFinite(n.passionIntensity)?Math.max(0,n.passionIntensity):void 0,tint:typeof n.tint=="string"?n.tint:void 0}}return!e&&!r&&!i?null:{geometry:e,particles:r,atmosphere:i}},Du=s=>{if(s.length<2)return 0;let t=0;for(let e=1;e<s.length;e++)t+=s[e].distanceTo(s[e-1]);return t},Fu=18,Pu=24,Bu=12,ku=16,fx=.55,dx=.4,zu=Math.PI/4,mx=(s,t)=>{const r=[],i=[],n=[],a=[],o=[],c=ux(s.synesthetic),h=(c==null?void 0:c.geometry)??null;let u=new L(0,5,0),d=new L(0,0,-1),y=new L(0,1,0);const g=(Ut,Yt)=>{if(!Ut||Ut.length===0)return null;const ae=r.length;return r.push(...Ut),i.push(...Yt),u=Ut[Ut.length-1],Ut.length>1&&d.subVectors(Ut[Ut.length-1],Ut[Ut.length-2]).normalize(),y=Yt[Yt.length-1],{start:ae,end:r.length-1}},A=[],D=[],H=Math.max(1,Math.floor(Number(Zs.INITIAL_TRACK_SEGMENT_LENGTH)||0));let V=Number(Zs.INITIAL_TRACK_SEGMENT_SPACING)*1.25;(!isFinite(V)||V<0)&&(V=cx);for(let Ut=0;Ut<H;Ut++)A.push(u.clone().add(d.clone().multiplyScalar(Ut*V))),D.push(y.clone());const Tt=g(A,D);Tt&&a.push(Tt),o.push({index:-1,component:"initial",computedLength:Du(A),sampleCount:A.length,source:{spacing:V,samples:H}}),n.push({intensity:0,lightingEffect:"none",environmentChange:"none",audioSyncPoint:Yu(0)}),s.track.forEach((Ut,Yt)=>{const ae=[],me=[],ce=Math.max(1,Math.floor(Zs.TRACK_SEGMENT_RESOLUTION)),Me=Ut.component??Ut.type,ge=hx(Me),ee={};switch(ge){case"climb":case"drop":{const qt=Ut,he=qt.angle??(ge==="climb"?15:-40),ue=Se.degToRad(Se.clamp(he,-90,90));ee.length=qt.length,ee.angle=he;const ve=qt.length??150,Fe=Math.max(10,ve)*1.25,Oe=d.clone();Oe.y=0,Oe.normalize();const Ge=u.clone().add(Oe.multiplyScalar(Math.cos(ue)*Fe)).add(new L(0,Math.sin(ue)*Fe,0));for(let ke=1;ke<=ce;ke++){const Je=ke/ce;ae.push(new L().lerpVectors(u,Ge,Je)),me.push(y.clone())}break}case"turn":{const qt=Ut,he=qt.radius??80,ue=Math.max(10,he)*1.25,ve=qt.angle??90,Fe=Se.degToRad(Se.clamp(ve,-360,360));ee.radius=qt.radius,ee.angle=ve,ee.direction=qt.direction,ee.length=Ut.length;const Oe=qt.direction==="left"?1:-1,Ge=new L(0,1,0),ke=d.clone().cross(Ge).multiplyScalar(ue*Oe),Je=u.clone().add(ke),Tr=u.clone().sub(Je);for(let cr=1;cr<=ce;cr++){const ir=cr/ce,Qe=Tr.clone().applyAxisAngle(Ge,Fe*ir*-Oe);ae.push(Je.clone().add(Qe)),me.push(y.clone())}break}case"loop":{const qt=Ut,he=qt.radius??50,ue=Math.max(10,he)*1.25,ve=Math.max(ue*1.5,qt.length?Math.max(20,Number(qt.length))*1.25:ue*Math.PI*.75);ee.radius=qt.radius,ee.length=qt.length;const Fe=u.clone().add(d.clone().multiplyScalar(ue));for(let Oe=1;Oe<=ce;Oe++){const Ge=Oe/ce,ke=Ge*Math.PI*2,Je=y.clone().multiplyScalar(Math.sin(ke)*ue),Tr=d.clone().multiplyScalar(-Math.cos(ke)*ue+Ge*ve),cr=Fe.clone().add(Je).add(Tr);ae.push(cr),me.push(y.clone())}break}case"barrelRoll":{const qt=Ut,he=qt.rotations??1,ue=Math.max(1,Math.round(he));ee.length=qt.length,ee.rotations=he;const ve=qt.length??150,Fe=Math.max(10,ve)*1.25,Oe=u.clone().add(d.clone().multiplyScalar(Fe));for(let Ge=1;Ge<=ce;Ge++){const ke=Ge/ce,Je=ke*Math.PI*2*ue;ae.push(new L().lerpVectors(u,Oe,ke)),me.push(y.clone().applyAxisAngle(d,Je))}break}case"unknown":{console.warn("[TrackBuilder] Unsupported segment component, using straight fallback",{index:Yt,component:Me});const qt=Math.max(10,Ut.length??80)*1.25;ee.length=Ut.length;for(let he=1;he<=ce;he++){const ue=he/ce;ae.push(u.clone().add(d.clone().multiplyScalar(ue*qt))),me.push(y.clone())}break}}const Gt=Du(ae),te=g(ae,me);te?a.push(te):a.length>0?a.push(a[a.length-1]):a.push({start:0,end:r.length>0?r.length-1:0}),o.push({index:Yt,component:ge,computedLength:Gt,sampleCount:ae.length,source:ee}),n.push({intensity:Ut.intensity??0,lightingEffect:Ut.lightingEffect,environmentChange:Ut.environmentChange,audioSyncPoint:Ut.audioSyncPoint})}),r.length>2&&px(r,i,t,h);const ft=Math.max(r.length-1,1),ct=a.map(Ut=>{const Yt=Ut.end/ft;return Number.isFinite(Yt)?Se.clamp(Yt,0,1):0});let Mt=0,Dt=Number.POSITIVE_INFINITY,Et=Number.POSITIVE_INFINITY,St=Number.POSITIVE_INFINITY,Xt=Number.NEGATIVE_INFINITY,Ht=Number.NEGATIVE_INFINITY,se=Number.NEGATIVE_INFINITY;for(let Ut=0;Ut<r.length;Ut++){const Yt=r[Ut];Ut>0&&(Mt+=Yt.distanceTo(r[Ut-1])),Yt.x<Dt&&(Dt=Yt.x),Yt.y<Et&&(Et=Yt.y),Yt.z<St&&(St=Yt.z),Yt.x>Xt&&(Xt=Yt.x),Yt.y>Ht&&(Ht=Yt.y),Yt.z>se&&(se=Yt.z)}return console.log("[TrackBuilder] Generated track geometry",{pointCount:r.length,segmentCount:s.track.length,segmentProgress:ct,metrics:{totalApproxLength:Number(Mt.toFixed(1)),bounds:{x:[Number(Dt.toFixed(2)),Number(Xt.toFixed(2))],y:[Number(Et.toFixed(2)),Number(Ht.toFixed(2))],z:[Number(St.toFixed(2)),Number(se.toFixed(2))],span:{x:Number((Xt-Dt).toFixed(2)),y:Number((Ht-Et).toFixed(2)),z:Number((se-St).toFixed(2))}},perSegment:o}}),{path:r,upVectors:i,railColor:s.palette[0]||"#ffffff",glowColor:s.palette[1]||"#00ffff",skyColor1:s.palette[2]||"#0d0a1f",skyColor2:Zs.DEFAULT_SKY_COLOR_2,segmentDetails:n,segmentProgress:ct,rideName:s.rideName,moodDescription:s.moodDescription,frameAnalyses:t&&t.frameAnalyses||[],audioFeatures:t||{duration:0,bpm:120,energy:0,spectralCentroid:0,spectralFlux:0,frameAnalyses:[]},events:Array.isArray(s.events)?s.events:[],synesthetic:c}},px=(s,t,e,r)=>{var Me,ge,ee;if(!e){Uu(s,t,r);return}const i=e.frameAnalyses||[];if(!i.length){Uu(s,t,r);return}const n=s.map(Gt=>Gt.clone()),a=t.map(Gt=>Gt.clone()),o=mr(r==null?void 0:r.wireframeDensity,.55),c=mr(r==null?void 0:r.organicBreathing,.4),h=!!((Me=r==null?void 0:r.impossiblePhysics)!=null&&Me.enabled),u=mr((ge=r==null?void 0:r.impossiblePhysics)==null?void 0:ge.intensity,.5),d=((ee=r==null?void 0:r.impossiblePhysics)==null?void 0:ee.frequency)??1,y=(r==null?void 0:r.breathingDriver)??"energy",A=(Number.isFinite(e.bpm)?Math.max(30,e.bpm||120):120)/60*.5,D=28+o*45,H=24+c*36,V=new L(0,1,0),Tt=new L,ft=new L,ct=new L,Mt=new L,Dt=new L,Et=new L;new L;let St=0,Xt=0,Ht=0;const se=i.length,Ut=i.reduce((Gt,te)=>Math.max(Gt,te.energy),0)||1,Yt=i.reduce((Gt,te)=>Math.max(Gt,te.spectralFlux),0)||1,ae=i.reduce((Gt,te)=>Math.max(Gt,te.spectralCentroid),0)||1,me=(Gt,te)=>{if(se===1)return i[0][te];const qt=Se.clamp(Gt,0,1)*(se-1),he=Math.floor(qt),ue=Math.min(se-1,he+1),ve=qt-he,Fe=i[he][te],Oe=i[ue][te];return Se.lerp(Fe,Oe,ve)},ce=Se.clamp(fx+c*.15,.35,.72);for(let Gt=1;Gt<s.length-1;Gt++){const te=Gt/(s.length-1),qt=Se.smoothstep(te,.05,.95),he=me(te,"energy")/Ut*qt,ue=me(te,"spectralFlux")/Yt*qt,ve=me(te,"spectralCentroid")/ae*qt,Fe=y==="spectralFlux"?ue:y==="spectralCentroid"?ve:he,Oe=n[Gt-1],Ge=n[Gt],ke=n[Gt+1];if(Tt.copy(Oe),ft.copy(ke),ct.copy(ke).sub(Oe),ct.lengthSq()<1e-6)continue;ct.normalize(),Mt.crossVectors(ct,V),Mt.lengthSq()<1e-6?Mt.set(1,0,0):Mt.normalize();const Je=2.6+o*3.2,Tr=Math.sin(te*Math.PI*Je+ue*(5+o*3.2)),cr=Math.cos(te*Math.PI*(2.4+o*.8)+ve*(3.5+o*2.4));let ir=Tr*ue*(8+o*6),Qe=cr*he*(10+c*6.5);const li=Tr*.22*ue+ve*.14,Oi=Math.sin(te*Math.PI*1.1)*D*qt,ci=Math.cos(te*Math.PI*.7+ue*1.8)*H*qt;if(ir+=Oi,Qe+=ci*.75,c>.001){const _t=te*Math.PI*2*A,Pt=Math.sin(_t+Fe*Math.PI*1.5)*c*(7.5+o*4)*qt,_e=Math.cos(_t*.65+ue*2)*c*ve*(5+o*3.2)*qt;Qe+=Pt,ir+=_e}if(h){const _t=Math.sin(te*Math.PI*(3.6*d+o*3)+he*5)*ue,dt=Math.cos(te*Math.PI*2.6*d+ve*3.6)*he;Qe+=_t*2.4*u,ir+=dt*2.1*u}ir=Se.clamp(ir,-Fu,Fu),Qe=Se.clamp(Qe,-Pu,Pu),St=Se.lerp(St,ir,.08),Xt=Se.lerp(Xt,Qe,.09),Ht=Se.lerp(Ht,li,.14),Et.copy(Ge).addScaledVector(Mt,St).addScaledVector(V,Xt),s[Gt].lerpVectors(Ge,Et,ce);const Z=Se.clamp(Ht,-zu,zu);Dt.copy(V).applyAxisAngle(ct,Z).normalize(),t[Gt].copy(a[Gt]).lerp(Dt,ce*.6).normalize()}},Uu=(s,t,e)=>{var Mt,Dt,Et;if(s.length<3)return;const r=s.map(St=>St.clone()),i=t.map(St=>St.clone()),n=new L(0,1,0),a=new L,o=new L,c=new L,h=new L,u=new L;let d=0,y=0;const g=mr(e==null?void 0:e.wireframeDensity,.45),A=mr(e==null?void 0:e.organicBreathing,.35),D=!!((Mt=e==null?void 0:e.impossiblePhysics)!=null&&Mt.enabled),H=mr((Dt=e==null?void 0:e.impossiblePhysics)==null?void 0:Dt.intensity,.5),V=((Et=e==null?void 0:e.impossiblePhysics)==null?void 0:Et.frequency)??1,Tt=22+g*34,ft=18+A*28,ct=Se.clamp(dx+A*.2,.25,.55);for(let St=1;St<s.length-1;St++){const Xt=St/(s.length-1),Ht=Se.smoothstep(Xt,.05,.95),se=Math.sin(Xt*Math.PI*(1.8+g*1.4))*Ht,Ut=Math.cos(Xt*Math.PI*1.4)*A*Ht,Yt=Math.sin(Xt*Math.PI*.85)*Tt*Ht,ae=Math.cos(Xt*Math.PI*.7)*ft*Ht,me=se+Ut*.55,ce=r[St-1],Me=r[St],ge=r[St+1];if(a.copy(ce),o.copy(ge),c.copy(ge).sub(ce),c.lengthSq()<1e-6)continue;c.normalize(),h.crossVectors(c,n),h.lengthSq()<1e-6?h.set(1,0,0):h.normalize();let ee=me*(5.5+g*3.4)+Yt,Gt=me*(7.5+A*3.6)+ae*.7;D&&(ee+=Math.cos(Xt*Math.PI*3.4*V)*2*Ht*H,Gt+=Math.sin(Xt*Math.PI*3.8*V)*2.2*Ht*H),ee=Se.clamp(ee,-Bu,Bu),Gt=Se.clamp(Gt,-ku,ku),d=Se.lerp(d,ee,.12),y=Se.lerp(y,Gt,.12),u.copy(Me).addScaledVector(h,d).addScaledVector(n,y),s[St].lerpVectors(Me,u,ct),t[St].copy(i[St]).lerp(n,ct*.5).normalize()}},yx=async(s,t)=>{var d,y;const{setStatus:e,setTrackData:r,setError:i}=be.getState().actions,n=t==null?void 0:t.signal;console.log("[Workflow] Starting audio processing workflow",{fileName:s.name,fileSize:s.size,fileType:s.type,hasExternalSignal:!!n,externalSignalAborted:n==null?void 0:n.aborted});const a=()=>{if(n!=null&&n.aborted)throw console.log("[Workflow] External signal aborted, throwing AbortError"),new DOMException("Aborted","AbortError")},o=new AbortController,c=setTimeout(()=>{console.log("[Workflow] Timeout fired, aborting controller"),o.abort(),i({title:"Processing Timeout",message:"The audio analysis is taking longer than expected. Please try a different file or check the server status."})},6e4),h=()=>{console.log("[Workflow] External signal aborted, cleaning up"),clearTimeout(c),o.signal.aborted||o.abort()},u=()=>{console.log("[Workflow] Internal controller aborted, cleaning up"),clearTimeout(c)};n==null||n.addEventListener("abort",h),o.signal.addEventListener("abort",u);try{a();const{setWorkflowProgress:g,setGenerationProgress:A}=be.getState().actions;g(10),A(0),e(de.Generating,"Translating sound into structure..."),a(),console.log("[Workflow] Calling generateRideBlueprint with file:",s.name);try{const Et=(globalThis==null?void 0:globalThis.BACKEND_URL)||((d=require("../config/environment").env)==null?void 0:d.VITE_BACKEND_URL)||"unknown";console.debug("[Workflow] Backend URL (effective):",Et)}catch{}const{blueprint:D,features:H}=await Bp(s,o.signal,t==null?void 0:t.generationOptions);console.log("[Workflow] Successfully received blueprint and audio features"),console.log("[Workflow] Blueprint data:",{hasBlueprintProp:!!D,blueprintType:typeof D,hasTrack:!!(D!=null&&D.track),trackLength:(y=D==null?void 0:D.track)==null?void 0:y.length,blueprintKeys:D?Object.keys(D):[]}),clearTimeout(c),console.log("[Workflow] Timeout cleared successfully"),a(),g(60),A(50),e(de.Generating,"Refining for physical plausibility..."),a(),console.log("[Workflow] Refining blueprint...");const V=Up(D);let Tt=null;const ft=2500,ct=8e3;try{const{setSkyboxUrl:Et}=be.getState().actions;try{Et(null)}catch{}const St=V.moodDescription||V.rideName||"A surreal and cinematic sky",Xt={...V,generationOptions:(t==null?void 0:t.generationOptions)??be.getState().generationOptions};try{Tt=kp(St,Xt).then(Ht=>{try{Et(Ht)}catch{}return Ht}).catch(Ht=>(console.info("[Workflow] Early skybox generation failed, continuing without custom skybox:",Ht instanceof Error?Ht.message:String(Ht)),null))}catch(Ht){console.info("[Workflow] Failed to start early skybox generation",Ht),Tt=null}if(Tt)try{await Promise.race([Tt,new Promise(se=>setTimeout(()=>se(null),ft))])&&console.log("[Workflow] Skybox finished during build fast-path")}catch{}}catch(Et){console.info("[Workflow] Skybox pre-generation step encountered an error, continuing",Et),Tt=null}try{console.log("[Workflow] Refined segment components",V.track.map((Et,St)=>({index:St,component:Et.component})))}catch{}a(),g(85),A(75),e(de.Generating,"Constructing ephemeral cathedral..."),a(),console.log("[Workflow] Building track data...");const{setBlueprint:Mt,setAudioFeatures:Dt}=be.getState().actions;Mt(V),Dt(H),a(),g(100),console.log("[Workflow] Building track data object and storing in app state");try{const Et=mx(V,H);a();const{setTrackData:St}=be.getState().actions;St(Et),console.log("[Workflow] Track data set in store (points:",Et.path.length,"segments:",Et.segmentDetails.length,")")}catch(Et){console.warn("[Workflow] Failed to build track data, aborting Ready transition",Et),i({title:"Track Build Failed",message:"Could not construct track geometry from blueprint."});return}try{if(Tt){console.log("[Workflow] Waiting up to",ct,"ms for skybox to finish before Ready");const{setSkyboxUrl:Et}=be.getState().actions;try{const St=await Promise.race([Tt,new Promise(Xt=>setTimeout(()=>Xt(null),ct))]);if(St){console.log("[Workflow] Skybox generation completed before Ready");try{Et(St)}catch{}}else console.log("[Workflow] Skybox did not finish within max wait, continuing without it")}catch(St){console.info("[Workflow] Error while awaiting skybox result, continuing",St)}}}catch(Et){console.info("[Workflow] Skybox wait logic failed, continuing",Et)}console.log("[Workflow] Setting status to Ready"),e(de.Ready)}catch(g){if(g instanceof DOMException&&g.name==="AbortError"){console.log("Audio processing was aborted.");return}const A=g instanceof Error?g.message:typeof g=="string"?g:"An unknown error occurred during processing.";console.error("Error in audio processing workflow:",A),i({title:"Could Not Process Audio",message:`An error occurred while processing '${s.name}'. ${A}`})}},xx=()=>{const s=be(e=>e.audioFile),t=be(e=>e.generationOptions);re.useEffect(()=>{if(!s)return;const e=new AbortController;return yx(s,{generationOptions:t,signal:e.signal}),()=>{console.log("Cancelling previous audio processing workflow."),e.abort()}},[s,t])},Rr={shaders:new Map,lygiaResolver:null,webglContext:null,audioContext:null};let Gu=!1;const Vu=[];async function gx(){const t=["/shaders/velFrag.resolved.glsl","/shaders/posFrag.resolved.glsl","/shaders/baseVelFrag.glsl","/shaders/basePosFrag.glsl"].map(async e=>{try{const r=await fetch(e);if(r.ok){const i=await r.text();Rr.shaders.set(e,i),console.log(`[Preloader] Cached shader: ${e}`)}}catch(r){console.debug(`[Preloader] Could not preload ${e}`,r)}});await Promise.allSettled(t)}async function _x(){try{try{const r=await import(window.location.origin+"/lygia/resolve.esm.js");if(Rr.lygiaResolver=r&&(r.default||r.resolveLygia||r.resolve)?r.default||r.resolveLygia||r.resolve:null,Rr.lygiaResolver){console.log("[Preloader] Cached LYGIA resolver (local)");return}}catch{}const t=await import("https://lygia.xyz/resolve.esm.js");Rr.lygiaResolver=t&&(t.default||t.resolveLygia||t.resolve)?t.default||t.resolveLygia||t.resolve:null,Rr.lygiaResolver&&console.log("[Preloader] Cached LYGIA resolver (CDN)")}catch(s){console.debug("[Preloader] Could not preload LYGIA resolver",s)}}function bx(){try{const s=document.createElement("canvas");s.width=1,s.height=1;const t=s.getContext("webgl2",{alpha:!0,antialias:!0,premultipliedAlpha:!1})||s.getContext("webgl",{alpha:!0,antialias:!0,premultipliedAlpha:!1});t&&(Rr.webglContext=t,t.clearColor(0,0,0,0),t.clear(t.COLOR_BUFFER_BIT),t.getExtension&&(t.getExtension("EXT_color_buffer_float"),t.getExtension("OES_texture_float_linear")),console.log("[Preloader] WebGL context initialized"))}catch(s){console.debug("[Preloader] Could not preload WebGL context",s)}}function vx(){try{const s=window.AudioContext||window.webkitAudioContext;s&&(Rr.audioContext=new s,Rr.audioContext.suspend(),console.log("[Preloader] AudioContext initialized (suspended)"))}catch(s){console.debug("[Preloader] Could not preload AudioContext",s)}}function Ex(){Gu||(Gu=!0,console.log("[Preloader] Starting resource preload..."),Vu.push(gx(),_x()),bx(),vx(),Promise.allSettled(Vu).then(()=>{console.log("[Preloader] All preload operations completed")}))}function z_(s){return Rr.shaders.get(s)||null}function U_(){return Rr.lygiaResolver}const Do=({stage:s,progress:t})=>{const e={analyzing:{title:"Analyzing Audio",description:"Extracting musical features from your track...",icon:"🎵"},generating:{title:"Generating Blueprint",description:"AI is designing your roller coaster...",icon:"🎢"},building:{title:"Building Track",description:"Creating the 3D visualization...",icon:"🏗️"},loading:{title:"Loading Scene",description:"Preparing your ride...",icon:"⚡"}},{title:r,description:i,icon:n}=e[s];return U.jsx("div",{className:"fixed inset-0 flex items-center justify-center bg-black/90 z-50",children:U.jsxs("div",{className:"text-center max-w-md px-8",children:[U.jsx("div",{className:"text-6xl mb-6 animate-bounce",children:n}),U.jsx("h2",{className:"text-3xl font-bold mb-3 text-white",children:r}),U.jsx("p",{className:"text-gray-400 mb-8",children:i}),t!==void 0&&U.jsx("div",{className:"w-full bg-gray-800 rounded-full h-3 overflow-hidden mb-4",children:U.jsx("div",{className:"h-full bg-gradient-to-r from-purple-600 to-pink-600 transition-all duration-300 ease-out",style:{width:`${t}%`}})}),U.jsxs("div",{className:"flex justify-center space-x-2",children:[U.jsx("div",{className:"w-3 h-3 bg-purple-600 rounded-full animate-pulse",style:{animationDelay:"0ms"}}),U.jsx("div",{className:"w-3 h-3 bg-purple-600 rounded-full animate-pulse",style:{animationDelay:"150ms"}}),U.jsx("div",{className:"w-3 h-3 bg-purple-600 rounded-full animate-pulse",style:{animationDelay:"300ms"}})]})]})})};class Ax extends re.Component{constructor(){super(...arguments);$c(this,"state",{hasError:!1})}static getDerivedStateFromError(e){return{hasError:!0}}componentDidCatch(e,r){console.error("ErrorBoundary caught an error:",e,r);const{setError:i}=be.getState().actions;i({title:"Rendering Error",message:e.message||"A critical error occurred in the 3D visualization."})}render(){return this.state.hasError?this.props.fallback??null:this.props.children}}var Ks={exports:{}},Tx=Ks.exports,ju;function Sx(){return ju||(ju=1,(function(s,t){(function(e,r){s.exports=r()})(Tx,(function(){var e=function(l){return l instanceof Uint8Array||l instanceof Uint16Array||l instanceof Uint32Array||l instanceof Int8Array||l instanceof Int16Array||l instanceof Int32Array||l instanceof Float32Array||l instanceof Float64Array||l instanceof Uint8ClampedArray},r=function(l,p){for(var E=Object.keys(p),k=0;k<E.length;++k)l[E[k]]=p[E[k]];return l},i=`
`;function n(l){return typeof atob<"u"?atob(l):"base64:"+l}function a(l){var p=new Error("(regl) "+l);throw console.error(p),p}function o(l,p){l||a(p)}function c(l){return l?": "+l:""}function h(l,p,E){l in p||a("unknown parameter ("+l+")"+c(E)+". possible values: "+Object.keys(p).join())}function u(l,p){e(l)||a("invalid parameter type"+c(p)+". must be a typed array")}function d(l,p){switch(p){case"number":return typeof l=="number";case"object":return typeof l=="object";case"string":return typeof l=="string";case"boolean":return typeof l=="boolean";case"function":return typeof l=="function";case"undefined":return typeof l>"u";case"symbol":return typeof l=="symbol"}}function y(l,p,E){d(l,p)||a("invalid parameter type"+c(E)+". expected "+p+", got "+typeof l)}function g(l,p){l>=0&&(l|0)===l||a("invalid parameter type, ("+l+")"+c(p)+". must be a nonnegative integer")}function A(l,p,E){p.indexOf(l)<0&&a("invalid value"+c(E)+". must be one of: "+p)}var D=["gl","canvas","container","attributes","pixelRatio","extensions","optionalExtensions","profile","onDone"];function H(l){Object.keys(l).forEach(function(p){D.indexOf(p)<0&&a('invalid regl constructor argument "'+p+'". must be one of '+D)})}function V(l,p){for(l=l+"";l.length<p;)l=" "+l;return l}function Tt(){this.name="unknown",this.lines=[],this.index={},this.hasErrors=!1}function ft(l,p){this.number=l,this.line=p,this.errors=[]}function ct(l,p,E){this.file=l,this.line=p,this.message=E}function Mt(){var l=new Error,p=(l.stack||l).toString(),E=/compileProcedure.*\n\s*at.*\((.*)\)/.exec(p);if(E)return E[1];var k=/compileProcedure.*\n\s*at\s+(.*)(\n|$)/.exec(p);return k?k[1]:"unknown"}function Dt(){var l=new Error,p=(l.stack||l).toString(),E=/at REGLCommand.*\n\s+at.*\((.*)\)/.exec(p);if(E)return E[1];var k=/at REGLCommand.*\n\s+at\s+(.*)\n/.exec(p);return k?k[1]:"unknown"}function Et(l,p){var E=l.split(`
`),k=1,Y=0,B={unknown:new Tt,0:new Tt};B.unknown.name=B[0].name=p||Mt(),B.unknown.lines.push(new ft(0,""));for(var j=0;j<E.length;++j){var K=E[j],J=/^\s*#\s*(\w+)\s+(.+)\s*$/.exec(K);if(J)switch(J[1]){case"line":var it=/(\d+)(\s+\d+)?/.exec(J[2]);it&&(k=it[1]|0,it[2]&&(Y=it[2]|0,Y in B||(B[Y]=new Tt)));break;case"define":var st=/SHADER_NAME(_B64)?\s+(.*)$/.exec(J[2]);st&&(B[Y].name=st[1]?n(st[2]):st[2]);break}B[Y].lines.push(new ft(k++,K))}return Object.keys(B).forEach(function(nt){var ht=B[nt];ht.lines.forEach(function(Q){ht.index[Q.number]=Q})}),B}function St(l){var p=[];return l.split(`
`).forEach(function(E){if(!(E.length<5)){var k=/^ERROR:\s+(\d+):(\d+):\s*(.*)$/.exec(E);k?p.push(new ct(k[1]|0,k[2]|0,k[3].trim())):E.length>0&&p.push(new ct("unknown",0,E))}}),p}function Xt(l,p){p.forEach(function(E){var k=l[E.file];if(k){var Y=k.index[E.line];if(Y){Y.errors.push(E),k.hasErrors=!0;return}}l.unknown.hasErrors=!0,l.unknown.lines[0].errors.push(E)})}function Ht(l,p,E,k,Y){if(!l.getShaderParameter(p,l.COMPILE_STATUS)){var B=l.getShaderInfoLog(p),j=k===l.FRAGMENT_SHADER?"fragment":"vertex";Me(E,"string",j+" shader source must be a string",Y);var K=Et(E,Y),J=St(B);Xt(K,J),Object.keys(K).forEach(function(it){var st=K[it];if(!st.hasErrors)return;var nt=[""],ht=[""];function Q(rt,R){nt.push(rt),ht.push(R||"")}Q("file number "+it+": "+st.name+`
`,"color:red;text-decoration:underline;font-weight:bold"),st.lines.forEach(function(rt){if(rt.errors.length>0){Q(V(rt.number,4)+"|  ","background-color:yellow; font-weight:bold"),Q(rt.line+i,"color:red; background-color:yellow; font-weight:bold");var R=0;rt.errors.forEach(function(G){var et=G.message,At=/^\s*'(.*)'\s*:\s*(.*)$/.exec(et);if(At){var q=At[1];switch(et=At[2],q){case"assign":q="=";break}R=Math.max(rt.line.indexOf(q,R),0)}else R=0;Q(V("| ",6)),Q(V("^^^",R+3)+i,"font-weight:bold"),Q(V("| ",6)),Q(et+i,"font-weight:bold")}),Q(V("| ",6)+i)}else Q(V(rt.number,4)+"|  "),Q(rt.line+i,"color:red")}),typeof document<"u"&&!window.chrome?(ht[0]=nt.join("%c"),console.log.apply(console,ht)):console.log(nt.join(""))}),o.raise("Error compiling "+j+" shader, "+K[0].name)}}function se(l,p,E,k,Y){if(!l.getProgramParameter(p,l.LINK_STATUS)){var B=l.getProgramInfoLog(p),j=Et(E,Y),K=Et(k,Y),J='Error linking program with vertex shader, "'+K[0].name+'", and fragment shader "'+j[0].name+'"';typeof document<"u"?console.log("%c"+J+i+"%c"+B,"color:red;text-decoration:underline;font-weight:bold","color:red"):console.log(J+i+B),o.raise(J)}}function Ut(l){l._commandRef=Mt()}function Yt(l,p,E,k){Ut(l);function Y(J){return J?k.id(J):0}l._fragId=Y(l.static.frag),l._vertId=Y(l.static.vert);function B(J,it){Object.keys(it).forEach(function(st){J[k.id(st)]=!0})}var j=l._uniformSet={};B(j,p.static),B(j,p.dynamic);var K=l._attributeSet={};B(K,E.static),B(K,E.dynamic),l._hasCount="count"in l.static||"count"in l.dynamic||"elements"in l.static||"elements"in l.dynamic}function ae(l,p){var E=Dt();a(l+" in command "+(p||Mt())+(E==="unknown"?"":" called from "+E))}function me(l,p,E){l||ae(p,E||Mt())}function ce(l,p,E,k){l in p||ae("unknown parameter ("+l+")"+c(E)+". possible values: "+Object.keys(p).join(),k||Mt())}function Me(l,p,E,k){d(l,p)||ae("invalid parameter type"+c(E)+". expected "+p+", got "+typeof l,k||Mt())}function ge(l){l()}function ee(l,p,E){l.texture?A(l.texture._texture.internalformat,p,"unsupported texture format for attachment"):A(l.renderbuffer._renderbuffer.format,E,"unsupported renderbuffer format for attachment")}var Gt=33071,te=9728,qt=9984,he=9985,ue=9986,ve=9987,Fe=5120,Oe=5121,Ge=5122,ke=5123,Je=5124,Tr=5125,cr=5126,ir=32819,Qe=32820,li=33635,Oi=34042,ci=36193,Z={};Z[Fe]=Z[Oe]=1,Z[Ge]=Z[ke]=Z[ci]=Z[li]=Z[ir]=Z[Qe]=2,Z[Je]=Z[Tr]=Z[cr]=Z[Oi]=4;function _t(l,p){return l===Qe||l===ir||l===li?2:l===Oi?4:Z[l]*p}function dt(l){return!(l&l-1)&&!!l}function Pt(l,p,E){var k,Y=p.width,B=p.height,j=p.channels;o(Y>0&&Y<=E.maxTextureSize&&B>0&&B<=E.maxTextureSize,"invalid texture shape"),(l.wrapS!==Gt||l.wrapT!==Gt)&&o(dt(Y)&&dt(B),"incompatible wrap mode for texture, both width and height must be power of 2"),p.mipmask===1?Y!==1&&B!==1&&o(l.minFilter!==qt&&l.minFilter!==ue&&l.minFilter!==he&&l.minFilter!==ve,"min filter requires mipmap"):(o(dt(Y)&&dt(B),"texture must be a square power of 2 to support mipmapping"),o(p.mipmask===(Y<<1)-1,"missing or incomplete mipmap data")),p.type===cr&&(E.extensions.indexOf("oes_texture_float_linear")<0&&o(l.minFilter===te&&l.magFilter===te,"filter not supported, must enable oes_texture_float_linear"),o(!l.genMipmaps,"mipmap generation not supported with float textures"));var K=p.images;for(k=0;k<16;++k)if(K[k]){var J=Y>>k,it=B>>k;o(p.mipmask&1<<k,"missing mipmap data");var st=K[k];if(o(st.width===J&&st.height===it,"invalid shape for mip images"),o(st.format===p.format&&st.internalformat===p.internalformat&&st.type===p.type,"incompatible type for mip image"),!st.compressed)if(st.data){var nt=Math.ceil(_t(st.type,j)*J/st.unpackAlignment)*st.unpackAlignment;o(st.data.byteLength===nt*it,"invalid data for image, buffer size is inconsistent with image format")}else st.element||st.copy}else l.genMipmaps||o((p.mipmask&1<<k)===0,"extra mipmap data");p.compressed&&o(!l.genMipmaps,"mipmap generation for compressed images not supported")}function _e(l,p,E,k){var Y=l.width,B=l.height,j=l.channels;o(Y>0&&Y<=k.maxTextureSize&&B>0&&B<=k.maxTextureSize,"invalid texture shape"),o(Y===B,"cube map must be square"),o(p.wrapS===Gt&&p.wrapT===Gt,"wrap mode not supported by cube map");for(var K=0;K<E.length;++K){var J=E[K];o(J.width===Y&&J.height===B,"inconsistent cube map face shape"),p.genMipmaps&&(o(!J.compressed,"can not generate mipmap for compressed textures"),o(J.mipmask===1,"can not specify mipmaps and generate mipmaps"));for(var it=J.images,st=0;st<16;++st){var nt=it[st];if(nt){var ht=Y>>st,Q=B>>st;o(J.mipmask&1<<st,"missing mipmap data"),o(nt.width===ht&&nt.height===Q,"invalid shape for mip images"),o(nt.format===l.format&&nt.internalformat===l.internalformat&&nt.type===l.type,"incompatible type for mip image"),nt.compressed||(nt.data?o(nt.data.byteLength===ht*Q*Math.max(_t(nt.type,j),nt.unpackAlignment),"invalid data for image, buffer size is inconsistent with image format"):nt.element||nt.copy)}}}}var m=r(o,{optional:ge,raise:a,commandRaise:ae,command:me,parameter:h,commandParameter:ce,constructor:H,type:y,commandType:Me,isTypedArray:u,nni:g,oneOf:A,shaderError:Ht,linkError:se,callSite:Dt,saveCommandRef:Ut,saveDrawInfo:Yt,framebufferFormat:ee,guessCommand:Mt,texture2D:Pt,textureCube:_e}),yn=0,mf=0,pf=5,yf=6;function hi(l,p){this.id=yn++,this.type=l,this.data=p}function Jo(l){return l.replace(/\\/g,"\\\\").replace(/"/g,'\\"')}function xn(l){if(l.length===0)return[];var p=l.charAt(0),E=l.charAt(l.length-1);if(l.length>1&&p===E&&(p==='"'||p==="'"))return['"'+Jo(l.substr(1,l.length-2))+'"'];var k=/\[(false|true|null|\d+|'[^']*'|"[^"]*")\]/.exec(l);if(k)return xn(l.substr(0,k.index)).concat(xn(k[1])).concat(xn(l.substr(k.index+k[0].length)));var Y=l.split(".");if(Y.length===1)return['"'+Jo(l)+'"'];for(var B=[],j=0;j<Y.length;++j)B=B.concat(xn(Y[j]));return B}function Zo(l){return"["+xn(l).join("][")+"]"}function xf(l,p){return new hi(l,Zo(p+""))}function gf(l){return typeof l=="function"&&!l._reglType||l instanceof hi}function Ko(l,p){if(typeof l=="function")return new hi(mf,l);if(typeof l=="number"||typeof l=="boolean")return new hi(pf,l);if(Array.isArray(l))return new hi(yf,l.map(function(E,k){return Ko(E,p+"["+k+"]")}));if(l instanceof hi)return l;m(!1,"invalid option type in uniform "+p)}var nr={DynamicVariable:hi,define:xf,isDynamic:gf,unbox:Ko,accessor:Zo},oa={next:typeof requestAnimationFrame=="function"?function(l){return requestAnimationFrame(l)}:function(l){return setTimeout(l,16)},cancel:typeof cancelAnimationFrame=="function"?function(l){return cancelAnimationFrame(l)}:clearTimeout},Qo=typeof performance<"u"&&performance.now?function(){return performance.now()}:function(){return+new Date};function _f(){var l={"":0},p=[""];return{id:function(E){var k=l[E];return k||(k=l[E]=p.length,p.push(E),k)},str:function(E){return p[E]}}}function bf(l,p,E){var k=document.createElement("canvas");r(k.style,{border:0,margin:0,padding:0,top:0,left:0,width:"100%",height:"100%"}),l.appendChild(k),l===document.body&&(k.style.position="absolute",r(l.style,{margin:0,padding:0}));function Y(){var K=window.innerWidth,J=window.innerHeight;if(l!==document.body){var it=k.getBoundingClientRect();K=it.right-it.left,J=it.bottom-it.top}k.width=E*K,k.height=E*J}var B;l!==document.body&&typeof ResizeObserver=="function"?(B=new ResizeObserver(function(){setTimeout(Y)}),B.observe(l)):window.addEventListener("resize",Y,!1);function j(){B?B.disconnect():window.removeEventListener("resize",Y),l.removeChild(k)}return Y(),{canvas:k,onDestroy:j}}function vf(l,p){function E(k){try{return l.getContext(k,p)}catch{return null}}return E("webgl")||E("experimental-webgl")||E("webgl-experimental")}function Ef(l){return typeof l.nodeName=="string"&&typeof l.appendChild=="function"&&typeof l.getBoundingClientRect=="function"}function Af(l){return typeof l.drawArrays=="function"||typeof l.drawElements=="function"}function tl(l){return typeof l=="string"?l.split():(m(Array.isArray(l),"invalid extension array"),l)}function el(l){return typeof l=="string"?(m(typeof document<"u","not supported outside of DOM"),document.querySelector(l)):l}function Tf(l){var p=l||{},E,k,Y,B,j={},K=[],J=[],it=typeof window>"u"?1:window.devicePixelRatio,st=!1,nt=function(rt){rt&&m.raise(rt)},ht=function(){};if(typeof p=="string"?(m(typeof document<"u","selector queries only supported in DOM environments"),E=document.querySelector(p),m(E,"invalid query string for element")):typeof p=="object"?Ef(p)?E=p:Af(p)?(B=p,Y=B.canvas):(m.constructor(p),"gl"in p?B=p.gl:"canvas"in p?Y=el(p.canvas):"container"in p&&(k=el(p.container)),"attributes"in p&&(j=p.attributes,m.type(j,"object","invalid context attributes")),"extensions"in p&&(K=tl(p.extensions)),"optionalExtensions"in p&&(J=tl(p.optionalExtensions)),"onDone"in p&&(m.type(p.onDone,"function","invalid or missing onDone callback"),nt=p.onDone),"profile"in p&&(st=!!p.profile),"pixelRatio"in p&&(it=+p.pixelRatio,m(it>0,"invalid pixel ratio"))):m.raise("invalid arguments to regl"),E&&(E.nodeName.toLowerCase()==="canvas"?Y=E:k=E),!B){if(!Y){m(typeof document<"u","must manually specify webgl context outside of DOM environments");var Q=bf(k||document.body,nt,it);if(!Q)return null;Y=Q.canvas,ht=Q.onDestroy}j.premultipliedAlpha===void 0&&(j.premultipliedAlpha=!0),B=vf(Y,j)}return B?{gl:B,canvas:Y,container:k,extensions:K,optionalExtensions:J,pixelRatio:it,profile:st,onDone:nt,onDestroy:ht}:(ht(),nt("webgl not supported, try upgrading your browser or graphics drivers http://get.webgl.org"),null)}function Sf(l,p){var E={};function k(j){m.type(j,"string","extension name must be string");var K=j.toLowerCase(),J;try{J=E[K]=l.getExtension(K)}catch{}return!!J}for(var Y=0;Y<p.extensions.length;++Y){var B=p.extensions[Y];if(!k(B))return p.onDestroy(),p.onDone('"'+B+'" extension is not supported by the current WebGL context, try upgrading your system or a different browser'),null}return p.optionalExtensions.forEach(k),{extensions:E,restore:function(){Object.keys(E).forEach(function(j){if(E[j]&&!k(j))throw new Error("(regl): error restoring extension "+j)})}}}function sr(l,p){for(var E=Array(l),k=0;k<l;++k)E[k]=p(k);return E}var wf=5120,Mf=5121,Cf=5122,If=5123,Rf=5124,Of=5125,Nf=5126;function Lf(l){for(var p=16;p<=1<<28;p*=16)if(l<=p)return p;return 0}function rl(l){var p,E;return p=(l>65535)<<4,l>>>=p,E=(l>255)<<3,l>>>=E,p|=E,E=(l>15)<<2,l>>>=E,p|=E,E=(l>3)<<1,l>>>=E,p|=E,p|l>>1}function il(){var l=sr(8,function(){return[]});function p(B){var j=Lf(B),K=l[rl(j)>>2];return K.length>0?K.pop():new ArrayBuffer(j)}function E(B){l[rl(B.byteLength)>>2].push(B)}function k(B,j){var K=null;switch(B){case wf:K=new Int8Array(p(j),0,j);break;case Mf:K=new Uint8Array(p(j),0,j);break;case Cf:K=new Int16Array(p(2*j),0,j);break;case If:K=new Uint16Array(p(2*j),0,j);break;case Rf:K=new Int32Array(p(4*j),0,j);break;case Of:K=new Uint32Array(p(4*j),0,j);break;case Nf:K=new Float32Array(p(4*j),0,j);break;default:return null}return K.length!==j?K.subarray(0,j):K}function Y(B){E(B.buffer)}return{alloc:p,free:E,allocType:k,freeType:Y}}var Ce=il();Ce.zero=il();var Df=3408,Ff=3410,Pf=3411,Bf=3412,kf=3413,zf=3414,Uf=3415,Gf=33901,Vf=33902,jf=3379,Hf=3386,Wf=34921,Yf=36347,Xf=36348,$f=35661,qf=35660,Jf=34930,Zf=36349,Kf=34076,Qf=34024,td=7936,ed=7937,rd=7938,id=35724,nd=34047,sd=36063,ad=34852,Jn=3553,nl=34067,od=34069,ld=33984,gn=6408,la=5126,sl=5121,ca=36160,cd=36053,hd=36064,ud=16384,fd=function(l,p){var E=1;p.ext_texture_filter_anisotropic&&(E=l.getParameter(nd));var k=1,Y=1;p.webgl_draw_buffers&&(k=l.getParameter(ad),Y=l.getParameter(sd));var B=!!p.oes_texture_float;if(B){var j=l.createTexture();l.bindTexture(Jn,j),l.texImage2D(Jn,0,gn,1,1,0,gn,la,null);var K=l.createFramebuffer();if(l.bindFramebuffer(ca,K),l.framebufferTexture2D(ca,hd,Jn,j,0),l.bindTexture(Jn,null),l.checkFramebufferStatus(ca)!==cd)B=!1;else{l.viewport(0,0,1,1),l.clearColor(1,0,0,1),l.clear(ud);var J=Ce.allocType(la,4);l.readPixels(0,0,1,1,gn,la,J),l.getError()?B=!1:(l.deleteFramebuffer(K),l.deleteTexture(j),B=J[0]===1),Ce.freeType(J)}}var it=typeof navigator<"u"&&(/MSIE/.test(navigator.userAgent)||/Trident\//.test(navigator.appVersion)||/Edge/.test(navigator.userAgent)),st=!0;if(!it){var nt=l.createTexture(),ht=Ce.allocType(sl,36);l.activeTexture(ld),l.bindTexture(nl,nt),l.texImage2D(od,0,gn,3,3,0,gn,sl,ht),Ce.freeType(ht),l.bindTexture(nl,null),l.deleteTexture(nt),st=!l.getError()}return{colorBits:[l.getParameter(Ff),l.getParameter(Pf),l.getParameter(Bf),l.getParameter(kf)],depthBits:l.getParameter(zf),stencilBits:l.getParameter(Uf),subpixelBits:l.getParameter(Df),extensions:Object.keys(p).filter(function(Q){return!!p[Q]}),maxAnisotropic:E,maxDrawbuffers:k,maxColorAttachments:Y,pointSizeDims:l.getParameter(Gf),lineWidthDims:l.getParameter(Vf),maxViewportDims:l.getParameter(Hf),maxCombinedTextureUnits:l.getParameter($f),maxCubeMapSize:l.getParameter(Kf),maxRenderbufferSize:l.getParameter(Qf),maxTextureUnits:l.getParameter(Jf),maxTextureSize:l.getParameter(jf),maxAttributes:l.getParameter(Wf),maxVertexUniforms:l.getParameter(Yf),maxVertexTextureUnits:l.getParameter(qf),maxVaryingVectors:l.getParameter(Xf),maxFragmentUniforms:l.getParameter(Zf),glsl:l.getParameter(id),renderer:l.getParameter(ed),vendor:l.getParameter(td),version:l.getParameter(rd),readFloat:B,npotTextureCube:st}};function pr(l){return!!l&&typeof l=="object"&&Array.isArray(l.shape)&&Array.isArray(l.stride)&&typeof l.offset=="number"&&l.shape.length===l.stride.length&&(Array.isArray(l.data)||e(l.data))}var ar=function(l){return Object.keys(l).map(function(p){return l[p]})},Zn={shape:yd,flatten:pd};function dd(l,p,E){for(var k=0;k<p;++k)E[k]=l[k]}function md(l,p,E,k){for(var Y=0,B=0;B<p;++B)for(var j=l[B],K=0;K<E;++K)k[Y++]=j[K]}function al(l,p,E,k,Y,B){for(var j=B,K=0;K<p;++K)for(var J=l[K],it=0;it<E;++it)for(var st=J[it],nt=0;nt<k;++nt)Y[j++]=st[nt]}function ol(l,p,E,k,Y){for(var B=1,j=E+1;j<p.length;++j)B*=p[j];var K=p[E];if(p.length-E===4){var J=p[E+1],it=p[E+2],st=p[E+3];for(j=0;j<K;++j)al(l[j],J,it,st,k,Y),Y+=B}else for(j=0;j<K;++j)ol(l[j],p,E+1,k,Y),Y+=B}function pd(l,p,E,k){var Y=1;if(p.length)for(var B=0;B<p.length;++B)Y*=p[B];else Y=0;var j=k||Ce.allocType(E,Y);switch(p.length){case 0:break;case 1:dd(l,p[0],j);break;case 2:md(l,p[0],p[1],j);break;case 3:al(l,p[0],p[1],p[2],j,0);break;default:ol(l,p,0,j,0)}return j}function yd(l){for(var p=[],E=l;E.length;E=E[0])p.push(E.length);return p}var ha={"[object Int8Array]":5120,"[object Int16Array]":5122,"[object Int32Array]":5124,"[object Uint8Array]":5121,"[object Uint8ClampedArray]":5121,"[object Uint16Array]":5123,"[object Uint32Array]":5125,"[object Float32Array]":5126,"[object Float64Array]":5121,"[object ArrayBuffer]":5121},xd=5120,gd=5122,_d=5124,bd=5121,vd=5123,Ed=5125,Ad=5126,Td=5126,ui={int8:xd,int16:gd,int32:_d,uint8:bd,uint16:vd,uint32:Ed,float:Ad,float32:Td},Sd=35048,wd=35040,Kn={dynamic:Sd,stream:wd,static:35044},ua=Zn.flatten,ll=Zn.shape,cl=35044,Md=35040,fa=5121,da=5126,Wr=[];Wr[5120]=1,Wr[5122]=2,Wr[5124]=4,Wr[5121]=1,Wr[5123]=2,Wr[5125]=4,Wr[5126]=4;function Qn(l){return ha[Object.prototype.toString.call(l)]|0}function hl(l,p){for(var E=0;E<p.length;++E)l[E]=p[E]}function ul(l,p,E,k,Y,B,j){for(var K=0,J=0;J<E;++J)for(var it=0;it<k;++it)l[K++]=p[Y*J+B*it+j]}function Cd(l,p,E,k){var Y=0,B={};function j(R){this.id=Y++,this.buffer=l.createBuffer(),this.type=R,this.usage=cl,this.byteLength=0,this.dimension=1,this.dtype=fa,this.persistentData=null,E.profile&&(this.stats={size:0})}j.prototype.bind=function(){l.bindBuffer(this.type,this.buffer)},j.prototype.destroy=function(){ht(this)};var K=[];function J(R,G){var et=K.pop();return et||(et=new j(R)),et.bind(),nt(et,G,Md,0,1,!1),et}function it(R){K.push(R)}function st(R,G,et){R.byteLength=G.byteLength,l.bufferData(R.type,G,et)}function nt(R,G,et,At,q,bt){var yt;if(R.usage=et,Array.isArray(G)){if(R.dtype=At||da,G.length>0){var Ft;if(Array.isArray(G[0])){yt=ll(G);for(var X=1,W=1;W<yt.length;++W)X*=yt[W];R.dimension=X,Ft=ua(G,yt,R.dtype),st(R,Ft,et),bt?R.persistentData=Ft:Ce.freeType(Ft)}else if(typeof G[0]=="number"){R.dimension=q;var It=Ce.allocType(R.dtype,G.length);hl(It,G),st(R,It,et),bt?R.persistentData=It:Ce.freeType(It)}else e(G[0])?(R.dimension=G[0].length,R.dtype=At||Qn(G[0])||da,Ft=ua(G,[G.length,G[0].length],R.dtype),st(R,Ft,et),bt?R.persistentData=Ft:Ce.freeType(Ft)):m.raise("invalid buffer data")}}else if(e(G))R.dtype=At||Qn(G),R.dimension=q,st(R,G,et),bt&&(R.persistentData=new Uint8Array(new Uint8Array(G.buffer)));else if(pr(G)){yt=G.shape;var ut=G.stride,tt=G.offset,mt=0,pt=0,Wt=0,Vt=0;yt.length===1?(mt=yt[0],pt=1,Wt=ut[0],Vt=0):yt.length===2?(mt=yt[0],pt=yt[1],Wt=ut[0],Vt=ut[1]):m.raise("invalid shape"),R.dtype=At||Qn(G.data)||da,R.dimension=pt;var xt=Ce.allocType(R.dtype,mt*pt);ul(xt,G.data,mt,pt,Wt,Vt,tt),st(R,xt,et),bt?R.persistentData=xt:Ce.freeType(xt)}else G instanceof ArrayBuffer?(R.dtype=fa,R.dimension=q,st(R,G,et),bt&&(R.persistentData=new Uint8Array(new Uint8Array(G)))):m.raise("invalid buffer data")}function ht(R){p.bufferCount--,k(R);var G=R.buffer;m(G,"buffer must not be deleted already"),l.deleteBuffer(G),R.buffer=null,delete B[R.id]}function Q(R,G,et,At){p.bufferCount++;var q=new j(G);B[q.id]=q;function bt(X){var W=cl,It=null,ut=0,tt=0,mt=1;return Array.isArray(X)||e(X)||pr(X)||X instanceof ArrayBuffer?It=X:typeof X=="number"?ut=X|0:X&&(m.type(X,"object","buffer arguments must be an object, a number or an array"),"data"in X&&(m(It===null||Array.isArray(It)||e(It)||pr(It),"invalid data for buffer"),It=X.data),"usage"in X&&(m.parameter(X.usage,Kn,"invalid buffer usage"),W=Kn[X.usage]),"type"in X&&(m.parameter(X.type,ui,"invalid buffer type"),tt=ui[X.type]),"dimension"in X&&(m.type(X.dimension,"number","invalid dimension"),mt=X.dimension|0),"length"in X&&(m.nni(ut,"buffer length must be a nonnegative integer"),ut=X.length|0)),q.bind(),It?nt(q,It,W,tt,mt,At):(ut&&l.bufferData(q.type,ut,W),q.dtype=tt||fa,q.usage=W,q.dimension=mt,q.byteLength=ut),E.profile&&(q.stats.size=q.byteLength*Wr[q.dtype]),bt}function yt(X,W){m(W+X.byteLength<=q.byteLength,"invalid buffer subdata call, buffer is too small.  Can't write data of size "+X.byteLength+" starting from offset "+W+" to a buffer of size "+q.byteLength),l.bufferSubData(q.type,W,X)}function Ft(X,W){var It=(W||0)|0,ut;if(q.bind(),e(X)||X instanceof ArrayBuffer)yt(X,It);else if(Array.isArray(X)){if(X.length>0)if(typeof X[0]=="number"){var tt=Ce.allocType(q.dtype,X.length);hl(tt,X),yt(tt,It),Ce.freeType(tt)}else if(Array.isArray(X[0])||e(X[0])){ut=ll(X);var mt=ua(X,ut,q.dtype);yt(mt,It),Ce.freeType(mt)}else m.raise("invalid buffer data")}else if(pr(X)){ut=X.shape;var pt=X.stride,Wt=0,Vt=0,xt=0,vt=0;ut.length===1?(Wt=ut[0],Vt=1,xt=pt[0],vt=0):ut.length===2?(Wt=ut[0],Vt=ut[1],xt=pt[0],vt=pt[1]):m.raise("invalid shape");var kt=Array.isArray(X.data)?q.dtype:Qn(X.data),jt=Ce.allocType(kt,Wt*Vt);ul(jt,X.data,Wt,Vt,xt,vt,X.offset),yt(jt,It),Ce.freeType(jt)}else m.raise("invalid data for buffer subdata");return bt}return et||bt(R),bt._reglType="buffer",bt._buffer=q,bt.subdata=Ft,E.profile&&(bt.stats=q.stats),bt.destroy=function(){ht(q)},bt}function rt(){ar(B).forEach(function(R){R.buffer=l.createBuffer(),l.bindBuffer(R.type,R.buffer),l.bufferData(R.type,R.persistentData||R.byteLength,R.usage)})}return E.profile&&(p.getTotalBufferSize=function(){var R=0;return Object.keys(B).forEach(function(G){R+=B[G].stats.size}),R}),{create:Q,createStream:J,destroyStream:it,clear:function(){ar(B).forEach(ht),K.forEach(ht)},getBuffer:function(R){return R&&R._buffer instanceof j?R._buffer:null},restore:rt,_initBuffer:nt}}var Id=0,Rd=0,Od=1,Nd=1,Ld=4,Dd=4,Yr={points:Id,point:Rd,lines:Od,line:Nd,triangles:Ld,triangle:Dd,"line loop":2,"line strip":3,"triangle strip":5,"triangle fan":6},Fd=0,Pd=1,_n=4,Bd=5120,Ni=5121,fl=5122,Li=5123,dl=5124,fi=5125,ma=34963,kd=35040,zd=35044;function Ud(l,p,E,k){var Y={},B=0,j={uint8:Ni,uint16:Li};p.oes_element_index_uint&&(j.uint32=fi);function K(rt){this.id=B++,Y[this.id]=this,this.buffer=rt,this.primType=_n,this.vertCount=0,this.type=0}K.prototype.bind=function(){this.buffer.bind()};var J=[];function it(rt){var R=J.pop();return R||(R=new K(E.create(null,ma,!0,!1)._buffer)),nt(R,rt,kd,-1,-1,0,0),R}function st(rt){J.push(rt)}function nt(rt,R,G,et,At,q,bt){rt.buffer.bind();var yt;if(R){var Ft=bt;!bt&&(!e(R)||pr(R)&&!e(R.data))&&(Ft=p.oes_element_index_uint?fi:Li),E._initBuffer(rt.buffer,R,G,Ft,3)}else l.bufferData(ma,q,G),rt.buffer.dtype=yt||Ni,rt.buffer.usage=G,rt.buffer.dimension=3,rt.buffer.byteLength=q;if(yt=bt,!bt){switch(rt.buffer.dtype){case Ni:case Bd:yt=Ni;break;case Li:case fl:yt=Li;break;case fi:case dl:yt=fi;break;default:m.raise("unsupported type for element array")}rt.buffer.dtype=yt}rt.type=yt,m(yt!==fi||!!p.oes_element_index_uint,"32 bit element buffers not supported, enable oes_element_index_uint first");var X=At;X<0&&(X=rt.buffer.byteLength,yt===Li?X>>=1:yt===fi&&(X>>=2)),rt.vertCount=X;var W=et;if(et<0){W=_n;var It=rt.buffer.dimension;It===1&&(W=Fd),It===2&&(W=Pd),It===3&&(W=_n)}rt.primType=W}function ht(rt){k.elementsCount--,m(rt.buffer!==null,"must not double destroy elements"),delete Y[rt.id],rt.buffer.destroy(),rt.buffer=null}function Q(rt,R){var G=E.create(null,ma,!0),et=new K(G._buffer);k.elementsCount++;function At(q){if(!q)G(),et.primType=_n,et.vertCount=0,et.type=Ni;else if(typeof q=="number")G(q),et.primType=_n,et.vertCount=q|0,et.type=Ni;else{var bt=null,yt=zd,Ft=-1,X=-1,W=0,It=0;Array.isArray(q)||e(q)||pr(q)?bt=q:(m.type(q,"object","invalid arguments for elements"),"data"in q&&(bt=q.data,m(Array.isArray(bt)||e(bt)||pr(bt),"invalid data for element buffer")),"usage"in q&&(m.parameter(q.usage,Kn,"invalid element buffer usage"),yt=Kn[q.usage]),"primitive"in q&&(m.parameter(q.primitive,Yr,"invalid element buffer primitive"),Ft=Yr[q.primitive]),"count"in q&&(m(typeof q.count=="number"&&q.count>=0,"invalid vertex count for elements"),X=q.count|0),"type"in q&&(m.parameter(q.type,j,"invalid buffer type"),It=j[q.type]),"length"in q?W=q.length|0:(W=X,It===Li||It===fl?W*=2:(It===fi||It===dl)&&(W*=4))),nt(et,bt,yt,Ft,X,W,It)}return At}return At(rt),At._reglType="elements",At._elements=et,At.subdata=function(q,bt){return G.subdata(q,bt),At},At.destroy=function(){ht(et)},At}return{create:Q,createStream:it,destroyStream:st,getElements:function(rt){return typeof rt=="function"&&rt._elements instanceof K?rt._elements:null},clear:function(){ar(Y).forEach(ht)}}}var ml=new Float32Array(1),Gd=new Uint32Array(ml.buffer),Vd=5123;function pl(l){for(var p=Ce.allocType(Vd,l.length),E=0;E<l.length;++E)if(isNaN(l[E]))p[E]=65535;else if(l[E]===1/0)p[E]=31744;else if(l[E]===-1/0)p[E]=64512;else{ml[0]=l[E];var k=Gd[0],Y=k>>>31<<15,B=(k<<1>>>24)-127,j=k>>13&1023;if(B<-24)p[E]=Y;else if(B<-14){var K=-14-B;p[E]=Y+(j+1024>>K)}else B>15?p[E]=Y+31744:p[E]=Y+(B+15<<10)+j}return p}function Ee(l){return Array.isArray(l)||e(l)}var yl=function(l){return!(l&l-1)&&!!l},jd=34467,Sr=3553,pa=34067,ts=34069,di=6408,ya=6406,es=6407,bn=6409,rs=6410,xl=32854,xa=32855,gl=36194,Hd=32819,Wd=32820,Yd=33635,Xd=34042,ga=6402,is=34041,_a=35904,ba=35906,Di=36193,va=33776,Ea=33777,Aa=33778,Ta=33779,_l=35986,bl=35987,vl=34798,El=35840,Al=35841,Tl=35842,Sl=35843,wl=36196,Fi=5121,Sa=5123,wa=5125,vn=5126,$d=10242,qd=10243,Jd=10497,Ma=33071,Zd=33648,Kd=10240,Qd=10241,Ca=9728,tm=9729,Ia=9984,Ml=9985,Cl=9986,Ra=9987,em=33170,ns=4352,rm=4353,im=4354,nm=34046,sm=3317,am=37440,om=37441,lm=37443,Il=37444,En=33984,cm=[Ia,Cl,Ml,Ra],ss=[0,bn,rs,es,di],hr={};hr[bn]=hr[ya]=hr[ga]=1,hr[is]=hr[rs]=2,hr[es]=hr[_a]=3,hr[di]=hr[ba]=4;function Pi(l){return"[object "+l+"]"}var Rl=Pi("HTMLCanvasElement"),Ol=Pi("OffscreenCanvas"),Nl=Pi("CanvasRenderingContext2D"),Ll=Pi("ImageBitmap"),Dl=Pi("HTMLImageElement"),Fl=Pi("HTMLVideoElement"),hm=Object.keys(ha).concat([Rl,Ol,Nl,Ll,Dl,Fl]),Bi=[];Bi[Fi]=1,Bi[vn]=4,Bi[Di]=2,Bi[Sa]=2,Bi[wa]=4;var Ve=[];Ve[xl]=2,Ve[xa]=2,Ve[gl]=2,Ve[is]=4,Ve[va]=.5,Ve[Ea]=.5,Ve[Aa]=1,Ve[Ta]=1,Ve[_l]=.5,Ve[bl]=1,Ve[vl]=1,Ve[El]=.5,Ve[Al]=.25,Ve[Tl]=.5,Ve[Sl]=.25,Ve[wl]=.5;function Pl(l){return Array.isArray(l)&&(l.length===0||typeof l[0]=="number")}function Bl(l){if(!Array.isArray(l))return!1;var p=l.length;return!(p===0||!Ee(l[0]))}function mi(l){return Object.prototype.toString.call(l)}function kl(l){return mi(l)===Rl}function zl(l){return mi(l)===Ol}function um(l){return mi(l)===Nl}function fm(l){return mi(l)===Ll}function dm(l){return mi(l)===Dl}function mm(l){return mi(l)===Fl}function Oa(l){if(!l)return!1;var p=mi(l);return hm.indexOf(p)>=0?!0:Pl(l)||Bl(l)||pr(l)}function Ul(l){return ha[Object.prototype.toString.call(l)]|0}function pm(l,p){var E=p.length;switch(l.type){case Fi:case Sa:case wa:case vn:var k=Ce.allocType(l.type,E);k.set(p),l.data=k;break;case Di:l.data=pl(p);break;default:m.raise("unsupported texture type, must specify a typed array")}}function Gl(l,p){return Ce.allocType(l.type===Di?vn:l.type,p)}function Vl(l,p){l.type===Di?(l.data=pl(p),Ce.freeType(p)):l.data=p}function ym(l,p,E,k,Y,B){for(var j=l.width,K=l.height,J=l.channels,it=j*K*J,st=Gl(l,it),nt=0,ht=0;ht<K;++ht)for(var Q=0;Q<j;++Q)for(var rt=0;rt<J;++rt)st[nt++]=p[E*Q+k*ht+Y*rt+B];Vl(l,st)}function as(l,p,E,k,Y,B){var j;if(typeof Ve[l]<"u"?j=Ve[l]:j=hr[l]*Bi[p],B&&(j*=6),Y){for(var K=0,J=E;J>=1;)K+=j*J*J,J/=2;return K}else return j*E*k}function xm(l,p,E,k,Y,B,j){var K={"don't care":ns,"dont care":ns,nice:im,fast:rm},J={repeat:Jd,clamp:Ma,mirror:Zd},it={nearest:Ca,linear:tm},st=r({mipmap:Ra,"nearest mipmap nearest":Ia,"linear mipmap nearest":Ml,"nearest mipmap linear":Cl,"linear mipmap linear":Ra},it),nt={none:0,browser:Il},ht={uint8:Fi,rgba4:Hd,rgb565:Yd,"rgb5 a1":Wd},Q={alpha:ya,luminance:bn,"luminance alpha":rs,rgb:es,rgba:di,rgba4:xl,"rgb5 a1":xa,rgb565:gl},rt={};p.ext_srgb&&(Q.srgb=_a,Q.srgba=ba),p.oes_texture_float&&(ht.float32=ht.float=vn),p.oes_texture_half_float&&(ht.float16=ht["half float"]=Di),p.webgl_depth_texture&&(r(Q,{depth:ga,"depth stencil":is}),r(ht,{uint16:Sa,uint32:wa,"depth stencil":Xd})),p.webgl_compressed_texture_s3tc&&r(rt,{"rgb s3tc dxt1":va,"rgba s3tc dxt1":Ea,"rgba s3tc dxt3":Aa,"rgba s3tc dxt5":Ta}),p.webgl_compressed_texture_atc&&r(rt,{"rgb atc":_l,"rgba atc explicit alpha":bl,"rgba atc interpolated alpha":vl}),p.webgl_compressed_texture_pvrtc&&r(rt,{"rgb pvrtc 4bppv1":El,"rgb pvrtc 2bppv1":Al,"rgba pvrtc 4bppv1":Tl,"rgba pvrtc 2bppv1":Sl}),p.webgl_compressed_texture_etc1&&(rt["rgb etc1"]=wl);var R=Array.prototype.slice.call(l.getParameter(jd));Object.keys(rt).forEach(function(v){var z=rt[v];R.indexOf(z)>=0&&(Q[v]=z)});var G=Object.keys(Q);E.textureFormats=G;var et=[];Object.keys(Q).forEach(function(v){var z=Q[v];et[z]=v});var At=[];Object.keys(ht).forEach(function(v){var z=ht[v];At[z]=v});var q=[];Object.keys(it).forEach(function(v){var z=it[v];q[z]=v});var bt=[];Object.keys(st).forEach(function(v){var z=st[v];bt[z]=v});var yt=[];Object.keys(J).forEach(function(v){var z=J[v];yt[z]=v});var Ft=G.reduce(function(v,z){var P=Q[z];return P===bn||P===ya||P===bn||P===rs||P===ga||P===is||p.ext_srgb&&(P===_a||P===ba)?v[P]=P:P===xa||z.indexOf("rgba")>=0?v[P]=di:v[P]=es,v},{});function X(){this.internalformat=di,this.format=di,this.type=Fi,this.compressed=!1,this.premultiplyAlpha=!1,this.flipY=!1,this.unpackAlignment=1,this.colorSpace=Il,this.width=0,this.height=0,this.channels=0}function W(v,z){v.internalformat=z.internalformat,v.format=z.format,v.type=z.type,v.compressed=z.compressed,v.premultiplyAlpha=z.premultiplyAlpha,v.flipY=z.flipY,v.unpackAlignment=z.unpackAlignment,v.colorSpace=z.colorSpace,v.width=z.width,v.height=z.height,v.channels=z.channels}function It(v,z){if(!(typeof z!="object"||!z)){if("premultiplyAlpha"in z&&(m.type(z.premultiplyAlpha,"boolean","invalid premultiplyAlpha"),v.premultiplyAlpha=z.premultiplyAlpha),"flipY"in z&&(m.type(z.flipY,"boolean","invalid texture flip"),v.flipY=z.flipY),"alignment"in z&&(m.oneOf(z.alignment,[1,2,4,8],"invalid texture unpack alignment"),v.unpackAlignment=z.alignment),"colorSpace"in z&&(m.parameter(z.colorSpace,nt,"invalid colorSpace"),v.colorSpace=nt[z.colorSpace]),"type"in z){var P=z.type;m(p.oes_texture_float||!(P==="float"||P==="float32"),"you must enable the OES_texture_float extension in order to use floating point textures."),m(p.oes_texture_half_float||!(P==="half float"||P==="float16"),"you must enable the OES_texture_half_float extension in order to use 16-bit floating point textures."),m(p.webgl_depth_texture||!(P==="uint16"||P==="uint32"||P==="depth stencil"),"you must enable the WEBGL_depth_texture extension in order to use depth/stencil textures."),m.parameter(P,ht,"invalid texture type"),v.type=ht[P]}var Ct=v.width,Jt=v.height,_=v.channels,f=!1;"shape"in z?(m(Array.isArray(z.shape)&&z.shape.length>=2,"shape must be an array"),Ct=z.shape[0],Jt=z.shape[1],z.shape.length===3&&(_=z.shape[2],m(_>0&&_<=4,"invalid number of channels"),f=!0),m(Ct>=0&&Ct<=E.maxTextureSize,"invalid width"),m(Jt>=0&&Jt<=E.maxTextureSize,"invalid height")):("radius"in z&&(Ct=Jt=z.radius,m(Ct>=0&&Ct<=E.maxTextureSize,"invalid radius")),"width"in z&&(Ct=z.width,m(Ct>=0&&Ct<=E.maxTextureSize,"invalid width")),"height"in z&&(Jt=z.height,m(Jt>=0&&Jt<=E.maxTextureSize,"invalid height")),"channels"in z&&(_=z.channels,m(_>0&&_<=4,"invalid number of channels"),f=!0)),v.width=Ct|0,v.height=Jt|0,v.channels=_|0;var S=!1;if("format"in z){var I=z.format;m(p.webgl_depth_texture||!(I==="depth"||I==="depth stencil"),"you must enable the WEBGL_depth_texture extension in order to use depth/stencil textures."),m.parameter(I,Q,"invalid texture format");var N=v.internalformat=Q[I];v.format=Ft[N],I in ht&&("type"in z||(v.type=ht[I])),I in rt&&(v.compressed=!0),S=!0}!f&&S?v.channels=hr[v.format]:f&&!S?v.channels!==ss[v.format]&&(v.format=v.internalformat=ss[v.channels]):S&&f&&m(v.channels===hr[v.format],"number of channels inconsistent with specified format")}}function ut(v){l.pixelStorei(am,v.flipY),l.pixelStorei(om,v.premultiplyAlpha),l.pixelStorei(lm,v.colorSpace),l.pixelStorei(sm,v.unpackAlignment)}function tt(){X.call(this),this.xOffset=0,this.yOffset=0,this.data=null,this.needsFree=!1,this.element=null,this.needsCopy=!1}function mt(v,z){var P=null;if(Oa(z)?P=z:z&&(m.type(z,"object","invalid pixel data type"),It(v,z),"x"in z&&(v.xOffset=z.x|0),"y"in z&&(v.yOffset=z.y|0),Oa(z.data)&&(P=z.data)),m(!v.compressed||P instanceof Uint8Array,"compressed texture data must be stored in a uint8array"),z.copy){m(!P,"can not specify copy and data field for the same texture");var Ct=Y.viewportWidth,Jt=Y.viewportHeight;v.width=v.width||Ct-v.xOffset,v.height=v.height||Jt-v.yOffset,v.needsCopy=!0,m(v.xOffset>=0&&v.xOffset<Ct&&v.yOffset>=0&&v.yOffset<Jt&&v.width>0&&v.width<=Ct&&v.height>0&&v.height<=Jt,"copy texture read out of bounds")}else if(!P)v.width=v.width||1,v.height=v.height||1,v.channels=v.channels||4;else if(e(P))v.channels=v.channels||4,v.data=P,!("type"in z)&&v.type===Fi&&(v.type=Ul(P));else if(Pl(P))v.channels=v.channels||4,pm(v,P),v.alignment=1,v.needsFree=!0;else if(pr(P)){var _=P.data;!Array.isArray(_)&&v.type===Fi&&(v.type=Ul(_));var f=P.shape,S=P.stride,I,N,M,w,C,x;f.length===3?(M=f[2],x=S[2]):(m(f.length===2,"invalid ndarray pixel data, must be 2 or 3D"),M=1,x=1),I=f[0],N=f[1],w=S[0],C=S[1],v.alignment=1,v.width=I,v.height=N,v.channels=M,v.format=v.internalformat=ss[M],v.needsFree=!0,ym(v,_,w,C,x,P.offset)}else if(kl(P)||zl(P)||um(P))kl(P)||zl(P)?v.element=P:v.element=P.canvas,v.width=v.element.width,v.height=v.element.height,v.channels=4;else if(fm(P))v.element=P,v.width=P.width,v.height=P.height,v.channels=4;else if(dm(P))v.element=P,v.width=P.naturalWidth,v.height=P.naturalHeight,v.channels=4;else if(mm(P))v.element=P,v.width=P.videoWidth,v.height=P.videoHeight,v.channels=4;else if(Bl(P)){var T=v.width||P[0].length,b=v.height||P.length,O=v.channels;Ee(P[0][0])?O=O||P[0][0].length:O=O||1;for(var F=Zn.shape(P),$=1,ot=0;ot<F.length;++ot)$*=F[ot];var lt=Gl(v,$);Zn.flatten(P,F,"",lt),Vl(v,lt),v.alignment=1,v.width=T,v.height=b,v.channels=O,v.format=v.internalformat=ss[O],v.needsFree=!0}v.type===vn?m(E.extensions.indexOf("oes_texture_float")>=0,"oes_texture_float extension not enabled"):v.type===Di&&m(E.extensions.indexOf("oes_texture_half_float")>=0,"oes_texture_half_float extension not enabled")}function pt(v,z,P){var Ct=v.element,Jt=v.data,_=v.internalformat,f=v.format,S=v.type,I=v.width,N=v.height;ut(v),Ct?l.texImage2D(z,P,f,f,S,Ct):v.compressed?l.compressedTexImage2D(z,P,_,I,N,0,Jt):v.needsCopy?(k(),l.copyTexImage2D(z,P,f,v.xOffset,v.yOffset,I,N,0)):l.texImage2D(z,P,f,I,N,0,f,S,Jt||null)}function Wt(v,z,P,Ct,Jt){var _=v.element,f=v.data,S=v.internalformat,I=v.format,N=v.type,M=v.width,w=v.height;ut(v),_?l.texSubImage2D(z,Jt,P,Ct,I,N,_):v.compressed?l.compressedTexSubImage2D(z,Jt,P,Ct,S,M,w,f):v.needsCopy?(k(),l.copyTexSubImage2D(z,Jt,P,Ct,v.xOffset,v.yOffset,M,w)):l.texSubImage2D(z,Jt,P,Ct,M,w,I,N,f)}var Vt=[];function xt(){return Vt.pop()||new tt}function vt(v){v.needsFree&&Ce.freeType(v.data),tt.call(v),Vt.push(v)}function kt(){X.call(this),this.genMipmaps=!1,this.mipmapHint=ns,this.mipmask=0,this.images=Array(16)}function jt(v,z,P){var Ct=v.images[0]=xt();v.mipmask=1,Ct.width=v.width=z,Ct.height=v.height=P,Ct.channels=v.channels=4}function Zt(v,z){var P=null;if(Oa(z))P=v.images[0]=xt(),W(P,v),mt(P,z),v.mipmask=1;else if(It(v,z),Array.isArray(z.mipmap))for(var Ct=z.mipmap,Jt=0;Jt<Ct.length;++Jt)P=v.images[Jt]=xt(),W(P,v),P.width>>=Jt,P.height>>=Jt,mt(P,Ct[Jt]),v.mipmask|=1<<Jt;else P=v.images[0]=xt(),W(P,v),mt(P,z),v.mipmask=1;W(v,v.images[0]),v.compressed&&(v.internalformat===va||v.internalformat===Ea||v.internalformat===Aa||v.internalformat===Ta)&&m(v.width%4===0&&v.height%4===0,"for compressed texture formats, mipmap level 0 must have width and height that are a multiple of 4")}function ye(v,z){for(var P=v.images,Ct=0;Ct<P.length;++Ct){if(!P[Ct])return;pt(P[Ct],z,Ct)}}var xe=[];function Qt(){var v=xe.pop()||new kt;X.call(v),v.mipmask=0;for(var z=0;z<16;++z)v.images[z]=null;return v}function Ne(v){for(var z=v.images,P=0;P<z.length;++P)z[P]&&vt(z[P]),z[P]=null;xe.push(v)}function pe(){this.minFilter=Ca,this.magFilter=Ca,this.wrapS=Ma,this.wrapT=Ma,this.anisotropic=1,this.genMipmaps=!1,this.mipmapHint=ns}function Re(v,z){if("min"in z){var P=z.min;m.parameter(P,st),v.minFilter=st[P],cm.indexOf(v.minFilter)>=0&&!("faces"in z)&&(v.genMipmaps=!0)}if("mag"in z){var Ct=z.mag;m.parameter(Ct,it),v.magFilter=it[Ct]}var Jt=v.wrapS,_=v.wrapT;if("wrap"in z){var f=z.wrap;typeof f=="string"?(m.parameter(f,J),Jt=_=J[f]):Array.isArray(f)&&(m.parameter(f[0],J),m.parameter(f[1],J),Jt=J[f[0]],_=J[f[1]])}else{if("wrapS"in z){var S=z.wrapS;m.parameter(S,J),Jt=J[S]}if("wrapT"in z){var I=z.wrapT;m.parameter(I,J),_=J[I]}}if(v.wrapS=Jt,v.wrapT=_,"anisotropic"in z){var N=z.anisotropic;m(typeof N=="number"&&N>=1&&N<=E.maxAnisotropic,"aniso samples must be between 1 and "),v.anisotropic=z.anisotropic}if("mipmap"in z){var M=!1;switch(typeof z.mipmap){case"string":m.parameter(z.mipmap,K,"invalid mipmap hint"),v.mipmapHint=K[z.mipmap],v.genMipmaps=!0,M=!0;break;case"boolean":M=v.genMipmaps=z.mipmap;break;case"object":m(Array.isArray(z.mipmap),"invalid mipmap type"),v.genMipmaps=!1,M=!0;break;default:m.raise("invalid mipmap type")}M&&!("min"in z)&&(v.minFilter=Ia)}}function Le(v,z){l.texParameteri(z,Qd,v.minFilter),l.texParameteri(z,Kd,v.magFilter),l.texParameteri(z,$d,v.wrapS),l.texParameteri(z,qd,v.wrapT),p.ext_texture_filter_anisotropic&&l.texParameteri(z,nm,v.anisotropic),v.genMipmaps&&(l.hint(em,v.mipmapHint),l.generateMipmap(z))}var De=0,ze={},je=E.maxTextureUnits,Ae=Array(je).map(function(){return null});function $t(v){X.call(this),this.mipmask=0,this.internalformat=di,this.id=De++,this.refCount=1,this.target=v,this.texture=l.createTexture(),this.unit=-1,this.bindCount=0,this.texInfo=new pe,j.profile&&(this.stats={size:0})}function He(v){l.activeTexture(En),l.bindTexture(v.target,v.texture)}function oe(){var v=Ae[0];v?l.bindTexture(v.target,v.texture):l.bindTexture(Sr,null)}function Bt(v){var z=v.texture;m(z,"must not double destroy texture");var P=v.unit,Ct=v.target;P>=0&&(l.activeTexture(En+P),l.bindTexture(Ct,null),Ae[P]=null),l.deleteTexture(z),v.texture=null,v.params=null,v.pixels=null,v.refCount=0,delete ze[v.id],B.textureCount--}r($t.prototype,{bind:function(){var v=this;v.bindCount+=1;var z=v.unit;if(z<0){for(var P=0;P<je;++P){var Ct=Ae[P];if(Ct){if(Ct.bindCount>0)continue;Ct.unit=-1}Ae[P]=v,z=P;break}z>=je&&m.raise("insufficient number of texture units"),j.profile&&B.maxTextureUnits<z+1&&(B.maxTextureUnits=z+1),v.unit=z,l.activeTexture(En+z),l.bindTexture(v.target,v.texture)}return z},unbind:function(){this.bindCount-=1},decRef:function(){--this.refCount<=0&&Bt(this)}});function Kt(v,z){var P=new $t(Sr);ze[P.id]=P,B.textureCount++;function Ct(f,S){var I=P.texInfo;pe.call(I);var N=Qt();return typeof f=="number"?typeof S=="number"?jt(N,f|0,S|0):jt(N,f|0,f|0):f?(m.type(f,"object","invalid arguments to regl.texture"),Re(I,f),Zt(N,f)):jt(N,1,1),I.genMipmaps&&(N.mipmask=(N.width<<1)-1),P.mipmask=N.mipmask,W(P,N),m.texture2D(I,N,E),P.internalformat=N.internalformat,Ct.width=N.width,Ct.height=N.height,He(P),ye(N,Sr),Le(I,Sr),oe(),Ne(N),j.profile&&(P.stats.size=as(P.internalformat,P.type,N.width,N.height,I.genMipmaps,!1)),Ct.format=et[P.internalformat],Ct.type=At[P.type],Ct.mag=q[I.magFilter],Ct.min=bt[I.minFilter],Ct.wrapS=yt[I.wrapS],Ct.wrapT=yt[I.wrapT],Ct}function Jt(f,S,I,N){m(!!f,"must specify image data");var M=S|0,w=I|0,C=N|0,x=xt();return W(x,P),x.width=0,x.height=0,mt(x,f),x.width=x.width||(P.width>>C)-M,x.height=x.height||(P.height>>C)-w,m(P.type===x.type&&P.format===x.format&&P.internalformat===x.internalformat,"incompatible format for texture.subimage"),m(M>=0&&w>=0&&M+x.width<=P.width&&w+x.height<=P.height,"texture.subimage write out of bounds"),m(P.mipmask&1<<C,"missing mipmap data"),m(x.data||x.element||x.needsCopy,"missing image data"),He(P),Wt(x,Sr,M,w,C),oe(),vt(x),Ct}function _(f,S){var I=f|0,N=S|0||I;if(I===P.width&&N===P.height)return Ct;Ct.width=P.width=I,Ct.height=P.height=N,He(P);for(var M=0;P.mipmask>>M;++M){var w=I>>M,C=N>>M;if(!w||!C)break;l.texImage2D(Sr,M,P.format,w,C,0,P.format,P.type,null)}return oe(),j.profile&&(P.stats.size=as(P.internalformat,P.type,I,N,!1,!1)),Ct}return Ct(v,z),Ct.subimage=Jt,Ct.resize=_,Ct._reglType="texture2d",Ct._texture=P,j.profile&&(Ct.stats=P.stats),Ct.destroy=function(){P.decRef()},Ct}function ie(v,z,P,Ct,Jt,_){var f=new $t(pa);ze[f.id]=f,B.cubeCount++;var S=new Array(6);function I(w,C,x,T,b,O){var F,$=f.texInfo;for(pe.call($),F=0;F<6;++F)S[F]=Qt();if(typeof w=="number"||!w){var ot=w|0||1;for(F=0;F<6;++F)jt(S[F],ot,ot)}else if(typeof w=="object")if(C)Zt(S[0],w),Zt(S[1],C),Zt(S[2],x),Zt(S[3],T),Zt(S[4],b),Zt(S[5],O);else if(Re($,w),It(f,w),"faces"in w){var lt=w.faces;for(m(Array.isArray(lt)&&lt.length===6,"cube faces must be a length 6 array"),F=0;F<6;++F)m(typeof lt[F]=="object"&&!!lt[F],"invalid input for cube map face"),W(S[F],f),Zt(S[F],lt[F])}else for(F=0;F<6;++F)Zt(S[F],w);else m.raise("invalid arguments to cube map");for(W(f,S[0]),m.optional(function(){E.npotTextureCube||m(yl(f.width)&&yl(f.height),"your browser does not support non power or two texture dimensions")}),$.genMipmaps?f.mipmask=(S[0].width<<1)-1:f.mipmask=S[0].mipmask,m.textureCube(f,$,S,E),f.internalformat=S[0].internalformat,I.width=S[0].width,I.height=S[0].height,He(f),F=0;F<6;++F)ye(S[F],ts+F);for(Le($,pa),oe(),j.profile&&(f.stats.size=as(f.internalformat,f.type,I.width,I.height,$.genMipmaps,!0)),I.format=et[f.internalformat],I.type=At[f.type],I.mag=q[$.magFilter],I.min=bt[$.minFilter],I.wrapS=yt[$.wrapS],I.wrapT=yt[$.wrapT],F=0;F<6;++F)Ne(S[F]);return I}function N(w,C,x,T,b){m(!!C,"must specify image data"),m(typeof w=="number"&&w===(w|0)&&w>=0&&w<6,"invalid face");var O=x|0,F=T|0,$=b|0,ot=xt();return W(ot,f),ot.width=0,ot.height=0,mt(ot,C),ot.width=ot.width||(f.width>>$)-O,ot.height=ot.height||(f.height>>$)-F,m(f.type===ot.type&&f.format===ot.format&&f.internalformat===ot.internalformat,"incompatible format for texture.subimage"),m(O>=0&&F>=0&&O+ot.width<=f.width&&F+ot.height<=f.height,"texture.subimage write out of bounds"),m(f.mipmask&1<<$,"missing mipmap data"),m(ot.data||ot.element||ot.needsCopy,"missing image data"),He(f),Wt(ot,ts+w,O,F,$),oe(),vt(ot),I}function M(w){var C=w|0;if(C!==f.width){I.width=f.width=C,I.height=f.height=C,He(f);for(var x=0;x<6;++x)for(var T=0;f.mipmask>>T;++T)l.texImage2D(ts+x,T,f.format,C>>T,C>>T,0,f.format,f.type,null);return oe(),j.profile&&(f.stats.size=as(f.internalformat,f.type,I.width,I.height,!1,!0)),I}}return I(v,z,P,Ct,Jt,_),I.subimage=N,I.resize=M,I._reglType="textureCube",I._texture=f,j.profile&&(I.stats=f.stats),I.destroy=function(){f.decRef()},I}function Te(){for(var v=0;v<je;++v)l.activeTexture(En+v),l.bindTexture(Sr,null),Ae[v]=null;ar(ze).forEach(Bt),B.cubeCount=0,B.textureCount=0}j.profile&&(B.getTotalTextureSize=function(){var v=0;return Object.keys(ze).forEach(function(z){v+=ze[z].stats.size}),v});function Mr(){for(var v=0;v<je;++v){var z=Ae[v];z&&(z.bindCount=0,z.unit=-1,Ae[v]=null)}ar(ze).forEach(function(P){P.texture=l.createTexture(),l.bindTexture(P.target,P.texture);for(var Ct=0;Ct<32;++Ct)if((P.mipmask&1<<Ct)!==0)if(P.target===Sr)l.texImage2D(Sr,Ct,P.internalformat,P.width>>Ct,P.height>>Ct,0,P.internalformat,P.type,null);else for(var Jt=0;Jt<6;++Jt)l.texImage2D(ts+Jt,Ct,P.internalformat,P.width>>Ct,P.height>>Ct,0,P.internalformat,P.type,null);Le(P.texInfo,P.target)})}function vi(){for(var v=0;v<je;++v){var z=Ae[v];z&&(z.bindCount=0,z.unit=-1,Ae[v]=null),l.activeTexture(En+v),l.bindTexture(Sr,null),l.bindTexture(pa,null)}}return{create2D:Kt,createCube:ie,clear:Te,getTexture:function(v){return null},restore:Mr,refresh:vi}}var Xr=36161,os=32854,jl=32855,Hl=36194,Wl=33189,Yl=36168,Xl=34041,$l=35907,ql=34836,Jl=34842,Zl=34843,yr=[];yr[os]=2,yr[jl]=2,yr[Hl]=2,yr[Wl]=2,yr[Yl]=1,yr[Xl]=4,yr[$l]=4,yr[ql]=16,yr[Jl]=8,yr[Zl]=6;function Kl(l,p,E){return yr[l]*p*E}var gm=function(l,p,E,k,Y){var B={rgba4:os,rgb565:Hl,"rgb5 a1":jl,depth:Wl,stencil:Yl,"depth stencil":Xl};p.ext_srgb&&(B.srgba=$l),p.ext_color_buffer_half_float&&(B.rgba16f=Jl,B.rgb16f=Zl),p.webgl_color_buffer_float&&(B.rgba32f=ql);var j=[];Object.keys(B).forEach(function(Q){var rt=B[Q];j[rt]=Q});var K=0,J={};function it(Q){this.id=K++,this.refCount=1,this.renderbuffer=Q,this.format=os,this.width=0,this.height=0,Y.profile&&(this.stats={size:0})}it.prototype.decRef=function(){--this.refCount<=0&&st(this)};function st(Q){var rt=Q.renderbuffer;m(rt,"must not double destroy renderbuffer"),l.bindRenderbuffer(Xr,null),l.deleteRenderbuffer(rt),Q.renderbuffer=null,Q.refCount=0,delete J[Q.id],k.renderbufferCount--}function nt(Q,rt){var R=new it(l.createRenderbuffer());J[R.id]=R,k.renderbufferCount++;function G(At,q){var bt=0,yt=0,Ft=os;if(typeof At=="object"&&At){var X=At;if("shape"in X){var W=X.shape;m(Array.isArray(W)&&W.length>=2,"invalid renderbuffer shape"),bt=W[0]|0,yt=W[1]|0}else"radius"in X&&(bt=yt=X.radius|0),"width"in X&&(bt=X.width|0),"height"in X&&(yt=X.height|0);"format"in X&&(m.parameter(X.format,B,"invalid renderbuffer format"),Ft=B[X.format])}else typeof At=="number"?(bt=At|0,typeof q=="number"?yt=q|0:yt=bt):At?m.raise("invalid arguments to renderbuffer constructor"):bt=yt=1;if(m(bt>0&&yt>0&&bt<=E.maxRenderbufferSize&&yt<=E.maxRenderbufferSize,"invalid renderbuffer size"),!(bt===R.width&&yt===R.height&&Ft===R.format))return G.width=R.width=bt,G.height=R.height=yt,R.format=Ft,l.bindRenderbuffer(Xr,R.renderbuffer),l.renderbufferStorage(Xr,Ft,bt,yt),m(l.getError()===0,"invalid render buffer format"),Y.profile&&(R.stats.size=Kl(R.format,R.width,R.height)),G.format=j[R.format],G}function et(At,q){var bt=At|0,yt=q|0||bt;return bt===R.width&&yt===R.height||(m(bt>0&&yt>0&&bt<=E.maxRenderbufferSize&&yt<=E.maxRenderbufferSize,"invalid renderbuffer size"),G.width=R.width=bt,G.height=R.height=yt,l.bindRenderbuffer(Xr,R.renderbuffer),l.renderbufferStorage(Xr,R.format,bt,yt),m(l.getError()===0,"invalid render buffer format"),Y.profile&&(R.stats.size=Kl(R.format,R.width,R.height))),G}return G(Q,rt),G.resize=et,G._reglType="renderbuffer",G._renderbuffer=R,Y.profile&&(G.stats=R.stats),G.destroy=function(){R.decRef()},G}Y.profile&&(k.getTotalRenderbufferSize=function(){var Q=0;return Object.keys(J).forEach(function(rt){Q+=J[rt].stats.size}),Q});function ht(){ar(J).forEach(function(Q){Q.renderbuffer=l.createRenderbuffer(),l.bindRenderbuffer(Xr,Q.renderbuffer),l.renderbufferStorage(Xr,Q.format,Q.width,Q.height)}),l.bindRenderbuffer(Xr,null)}return{create:nt,clear:function(){ar(J).forEach(st)},restore:ht}},Or=36160,Na=36161,pi=3553,ls=34069,Ql=36064,tc=36096,ec=36128,rc=33306,ic=36053,_m=36054,bm=36055,vm=36057,Em=36061,Am=36193,Tm=5121,Sm=5126,nc=6407,sc=6408,wm=6402,Mm=[nc,sc],La=[];La[sc]=4,La[nc]=3;var cs=[];cs[Tm]=1,cs[Sm]=4,cs[Am]=2;var Cm=32854,Im=32855,Rm=36194,Om=33189,Nm=36168,ac=34041,Lm=35907,Dm=34836,Fm=34842,Pm=34843,Bm=[Cm,Im,Rm,Lm,Fm,Pm,Dm],ki={};ki[ic]="complete",ki[_m]="incomplete attachment",ki[vm]="incomplete dimensions",ki[bm]="incomplete, missing attachment",ki[Em]="unsupported";function km(l,p,E,k,Y,B){var j={cur:null,next:null,dirty:!1,setFBO:null},K=["rgba"],J=["rgba4","rgb565","rgb5 a1"];p.ext_srgb&&J.push("srgba"),p.ext_color_buffer_half_float&&J.push("rgba16f","rgb16f"),p.webgl_color_buffer_float&&J.push("rgba32f");var it=["uint8"];p.oes_texture_half_float&&it.push("half float","float16"),p.oes_texture_float&&it.push("float","float32");function st(tt,mt,pt){this.target=tt,this.texture=mt,this.renderbuffer=pt;var Wt=0,Vt=0;mt?(Wt=mt.width,Vt=mt.height):pt&&(Wt=pt.width,Vt=pt.height),this.width=Wt,this.height=Vt}function nt(tt){tt&&(tt.texture&&tt.texture._texture.decRef(),tt.renderbuffer&&tt.renderbuffer._renderbuffer.decRef())}function ht(tt,mt,pt){if(tt)if(tt.texture){var Wt=tt.texture._texture,Vt=Math.max(1,Wt.width),xt=Math.max(1,Wt.height);m(Vt===mt&&xt===pt,"inconsistent width/height for supplied texture"),Wt.refCount+=1}else{var vt=tt.renderbuffer._renderbuffer;m(vt.width===mt&&vt.height===pt,"inconsistent width/height for renderbuffer"),vt.refCount+=1}}function Q(tt,mt){mt&&(mt.texture?l.framebufferTexture2D(Or,tt,mt.target,mt.texture._texture.texture,0):l.framebufferRenderbuffer(Or,tt,Na,mt.renderbuffer._renderbuffer.renderbuffer))}function rt(tt){var mt=pi,pt=null,Wt=null,Vt=tt;typeof tt=="object"&&(Vt=tt.data,"target"in tt&&(mt=tt.target|0)),m.type(Vt,"function","invalid attachment data");var xt=Vt._reglType;return xt==="texture2d"?(pt=Vt,m(mt===pi)):xt==="textureCube"?(pt=Vt,m(mt>=ls&&mt<ls+6,"invalid cube map target")):xt==="renderbuffer"?(Wt=Vt,mt=Na):m.raise("invalid regl object for attachment"),new st(mt,pt,Wt)}function R(tt,mt,pt,Wt,Vt){if(pt){var xt=k.create2D({width:tt,height:mt,format:Wt,type:Vt});return xt._texture.refCount=0,new st(pi,xt,null)}else{var vt=Y.create({width:tt,height:mt,format:Wt});return vt._renderbuffer.refCount=0,new st(Na,null,vt)}}function G(tt){return tt&&(tt.texture||tt.renderbuffer)}function et(tt,mt,pt){tt&&(tt.texture?tt.texture.resize(mt,pt):tt.renderbuffer&&tt.renderbuffer.resize(mt,pt),tt.width=mt,tt.height=pt)}var At=0,q={};function bt(){this.id=At++,q[this.id]=this,this.framebuffer=l.createFramebuffer(),this.width=0,this.height=0,this.colorAttachments=[],this.depthAttachment=null,this.stencilAttachment=null,this.depthStencilAttachment=null}function yt(tt){tt.colorAttachments.forEach(nt),nt(tt.depthAttachment),nt(tt.stencilAttachment),nt(tt.depthStencilAttachment)}function Ft(tt){var mt=tt.framebuffer;m(mt,"must not double destroy framebuffer"),l.deleteFramebuffer(mt),tt.framebuffer=null,B.framebufferCount--,delete q[tt.id]}function X(tt){var mt;l.bindFramebuffer(Or,tt.framebuffer);var pt=tt.colorAttachments;for(mt=0;mt<pt.length;++mt)Q(Ql+mt,pt[mt]);for(mt=pt.length;mt<E.maxColorAttachments;++mt)l.framebufferTexture2D(Or,Ql+mt,pi,null,0);l.framebufferTexture2D(Or,rc,pi,null,0),l.framebufferTexture2D(Or,tc,pi,null,0),l.framebufferTexture2D(Or,ec,pi,null,0),Q(tc,tt.depthAttachment),Q(ec,tt.stencilAttachment),Q(rc,tt.depthStencilAttachment);var Wt=l.checkFramebufferStatus(Or);!l.isContextLost()&&Wt!==ic&&m.raise("framebuffer configuration not supported, status = "+ki[Wt]),l.bindFramebuffer(Or,j.next?j.next.framebuffer:null),j.cur=j.next,l.getError()}function W(tt,mt){var pt=new bt;B.framebufferCount++;function Wt(xt,vt){var kt;m(j.next!==pt,"can not update framebuffer which is currently in use");var jt=0,Zt=0,ye=!0,xe=!0,Qt=null,Ne=!0,pe="rgba",Re="uint8",Le=1,De=null,ze=null,je=null,Ae=!1;if(typeof xt=="number")jt=xt|0,Zt=vt|0||jt;else if(!xt)jt=Zt=1;else{m.type(xt,"object","invalid arguments for framebuffer");var $t=xt;if("shape"in $t){var He=$t.shape;m(Array.isArray(He)&&He.length>=2,"invalid shape for framebuffer"),jt=He[0],Zt=He[1]}else"radius"in $t&&(jt=Zt=$t.radius),"width"in $t&&(jt=$t.width),"height"in $t&&(Zt=$t.height);("color"in $t||"colors"in $t)&&(Qt=$t.color||$t.colors,Array.isArray(Qt)&&m(Qt.length===1||p.webgl_draw_buffers,"multiple render targets not supported")),Qt||("colorCount"in $t&&(Le=$t.colorCount|0,m(Le>0,"invalid color buffer count")),"colorTexture"in $t&&(Ne=!!$t.colorTexture,pe="rgba4"),"colorType"in $t&&(Re=$t.colorType,Ne?(m(p.oes_texture_float||!(Re==="float"||Re==="float32"),"you must enable OES_texture_float in order to use floating point framebuffer objects"),m(p.oes_texture_half_float||!(Re==="half float"||Re==="float16"),"you must enable OES_texture_half_float in order to use 16-bit floating point framebuffer objects")):Re==="half float"||Re==="float16"?(m(p.ext_color_buffer_half_float,"you must enable EXT_color_buffer_half_float to use 16-bit render buffers"),pe="rgba16f"):(Re==="float"||Re==="float32")&&(m(p.webgl_color_buffer_float,"you must enable WEBGL_color_buffer_float in order to use 32-bit floating point renderbuffers"),pe="rgba32f"),m.oneOf(Re,it,"invalid color type")),"colorFormat"in $t&&(pe=$t.colorFormat,K.indexOf(pe)>=0?Ne=!0:J.indexOf(pe)>=0?Ne=!1:m.optional(function(){Ne?m.oneOf($t.colorFormat,K,"invalid color format for texture"):m.oneOf($t.colorFormat,J,"invalid color format for renderbuffer")}))),("depthTexture"in $t||"depthStencilTexture"in $t)&&(Ae=!!($t.depthTexture||$t.depthStencilTexture),m(!Ae||p.webgl_depth_texture,"webgl_depth_texture extension not supported")),"depth"in $t&&(typeof $t.depth=="boolean"?ye=$t.depth:(De=$t.depth,xe=!1)),"stencil"in $t&&(typeof $t.stencil=="boolean"?xe=$t.stencil:(ze=$t.stencil,ye=!1)),"depthStencil"in $t&&(typeof $t.depthStencil=="boolean"?ye=xe=$t.depthStencil:(je=$t.depthStencil,ye=!1,xe=!1))}var oe=null,Bt=null,Kt=null,ie=null;if(Array.isArray(Qt))oe=Qt.map(rt);else if(Qt)oe=[rt(Qt)];else for(oe=new Array(Le),kt=0;kt<Le;++kt)oe[kt]=R(jt,Zt,Ne,pe,Re);m(p.webgl_draw_buffers||oe.length<=1,"you must enable the WEBGL_draw_buffers extension in order to use multiple color buffers."),m(oe.length<=E.maxColorAttachments,"too many color attachments, not supported"),jt=jt||oe[0].width,Zt=Zt||oe[0].height,De?Bt=rt(De):ye&&!xe&&(Bt=R(jt,Zt,Ae,"depth","uint32")),ze?Kt=rt(ze):xe&&!ye&&(Kt=R(jt,Zt,!1,"stencil","uint8")),je?ie=rt(je):!De&&!ze&&xe&&ye&&(ie=R(jt,Zt,Ae,"depth stencil","depth stencil")),m(!!De+!!ze+!!je<=1,"invalid framebuffer configuration, can specify exactly one depth/stencil attachment");var Te=null;for(kt=0;kt<oe.length;++kt)if(ht(oe[kt],jt,Zt),m(!oe[kt]||oe[kt].texture&&Mm.indexOf(oe[kt].texture._texture.format)>=0||oe[kt].renderbuffer&&Bm.indexOf(oe[kt].renderbuffer._renderbuffer.format)>=0,"framebuffer color attachment "+kt+" is invalid"),oe[kt]&&oe[kt].texture){var Mr=La[oe[kt].texture._texture.format]*cs[oe[kt].texture._texture.type];Te===null?Te=Mr:m(Te===Mr,"all color attachments much have the same number of bits per pixel.")}return ht(Bt,jt,Zt),m(!Bt||Bt.texture&&Bt.texture._texture.format===wm||Bt.renderbuffer&&Bt.renderbuffer._renderbuffer.format===Om,"invalid depth attachment for framebuffer object"),ht(Kt,jt,Zt),m(!Kt||Kt.renderbuffer&&Kt.renderbuffer._renderbuffer.format===Nm,"invalid stencil attachment for framebuffer object"),ht(ie,jt,Zt),m(!ie||ie.texture&&ie.texture._texture.format===ac||ie.renderbuffer&&ie.renderbuffer._renderbuffer.format===ac,"invalid depth-stencil attachment for framebuffer object"),yt(pt),pt.width=jt,pt.height=Zt,pt.colorAttachments=oe,pt.depthAttachment=Bt,pt.stencilAttachment=Kt,pt.depthStencilAttachment=ie,Wt.color=oe.map(G),Wt.depth=G(Bt),Wt.stencil=G(Kt),Wt.depthStencil=G(ie),Wt.width=pt.width,Wt.height=pt.height,X(pt),Wt}function Vt(xt,vt){m(j.next!==pt,"can not resize a framebuffer which is currently in use");var kt=Math.max(xt|0,1),jt=Math.max(vt|0||kt,1);if(kt===pt.width&&jt===pt.height)return Wt;for(var Zt=pt.colorAttachments,ye=0;ye<Zt.length;++ye)et(Zt[ye],kt,jt);return et(pt.depthAttachment,kt,jt),et(pt.stencilAttachment,kt,jt),et(pt.depthStencilAttachment,kt,jt),pt.width=Wt.width=kt,pt.height=Wt.height=jt,X(pt),Wt}return Wt(tt,mt),r(Wt,{resize:Vt,_reglType:"framebuffer",_framebuffer:pt,destroy:function(){Ft(pt),yt(pt)},use:function(xt){j.setFBO({framebuffer:Wt},xt)}})}function It(tt){var mt=Array(6);function pt(Vt){var xt;m(mt.indexOf(j.next)<0,"can not update framebuffer which is currently in use");var vt={color:null},kt=0,jt=null,Zt="rgba",ye="uint8",xe=1;if(typeof Vt=="number")kt=Vt|0;else if(!Vt)kt=1;else{m.type(Vt,"object","invalid arguments for framebuffer");var Qt=Vt;if("shape"in Qt){var Ne=Qt.shape;m(Array.isArray(Ne)&&Ne.length>=2,"invalid shape for framebuffer"),m(Ne[0]===Ne[1],"cube framebuffer must be square"),kt=Ne[0]}else"radius"in Qt&&(kt=Qt.radius|0),"width"in Qt?(kt=Qt.width|0,"height"in Qt&&m(Qt.height===kt,"must be square")):"height"in Qt&&(kt=Qt.height|0);("color"in Qt||"colors"in Qt)&&(jt=Qt.color||Qt.colors,Array.isArray(jt)&&m(jt.length===1||p.webgl_draw_buffers,"multiple render targets not supported")),jt||("colorCount"in Qt&&(xe=Qt.colorCount|0,m(xe>0,"invalid color buffer count")),"colorType"in Qt&&(m.oneOf(Qt.colorType,it,"invalid color type"),ye=Qt.colorType),"colorFormat"in Qt&&(Zt=Qt.colorFormat,m.oneOf(Qt.colorFormat,K,"invalid color format for texture"))),"depth"in Qt&&(vt.depth=Qt.depth),"stencil"in Qt&&(vt.stencil=Qt.stencil),"depthStencil"in Qt&&(vt.depthStencil=Qt.depthStencil)}var pe;if(jt)if(Array.isArray(jt))for(pe=[],xt=0;xt<jt.length;++xt)pe[xt]=jt[xt];else pe=[jt];else{pe=Array(xe);var Re={radius:kt,format:Zt,type:ye};for(xt=0;xt<xe;++xt)pe[xt]=k.createCube(Re)}for(vt.color=Array(pe.length),xt=0;xt<pe.length;++xt){var Le=pe[xt];m(typeof Le=="function"&&Le._reglType==="textureCube","invalid cube map"),kt=kt||Le.width,m(Le.width===kt&&Le.height===kt,"invalid cube map shape"),vt.color[xt]={target:ls,data:pe[xt]}}for(xt=0;xt<6;++xt){for(var De=0;De<pe.length;++De)vt.color[De].target=ls+xt;xt>0&&(vt.depth=mt[0].depth,vt.stencil=mt[0].stencil,vt.depthStencil=mt[0].depthStencil),mt[xt]?mt[xt](vt):mt[xt]=W(vt)}return r(pt,{width:kt,height:kt,color:pe})}function Wt(Vt){var xt,vt=Vt|0;if(m(vt>0&&vt<=E.maxCubeMapSize,"invalid radius for cube fbo"),vt===pt.width)return pt;var kt=pt.color;for(xt=0;xt<kt.length;++xt)kt[xt].resize(vt);for(xt=0;xt<6;++xt)mt[xt].resize(vt);return pt.width=pt.height=vt,pt}return pt(tt),r(pt,{faces:mt,resize:Wt,_reglType:"framebufferCube",destroy:function(){mt.forEach(function(Vt){Vt.destroy()})}})}function ut(){j.cur=null,j.next=null,j.dirty=!0,ar(q).forEach(function(tt){tt.framebuffer=l.createFramebuffer(),X(tt)})}return r(j,{getFramebuffer:function(tt){if(typeof tt=="function"&&tt._reglType==="framebuffer"){var mt=tt._framebuffer;if(mt instanceof bt)return mt}return null},create:W,createCube:It,clear:function(){ar(q).forEach(Ft)},restore:ut})}var zm=5126,oc=34962,hs=34963,lc=["attributes","elements","offset","count","primitive","instances"];function Da(){this.state=0,this.x=0,this.y=0,this.z=0,this.w=0,this.buffer=null,this.size=0,this.normalized=!1,this.type=zm,this.offset=0,this.stride=0,this.divisor=0}function Um(l,p,E,k,Y,B,j){for(var K=E.maxAttributes,J=new Array(K),it=0;it<K;++it)J[it]=new Da;var st=0,nt={},ht={Record:Da,scope:{},state:J,currentVAO:null,targetVAO:null,restore:rt()?yt:function(){},createVAO:Ft,getVAO:G,destroyBuffer:Q,setVAO:rt()?et:At,clear:rt()?q:function(){}};function Q(X){for(var W=0;W<J.length;++W){var It=J[W];It.buffer===X&&(l.disableVertexAttribArray(W),It.buffer=null)}}function rt(){return p.oes_vertex_array_object}function R(){return p.angle_instanced_arrays}function G(X){return typeof X=="function"&&X._vao?X._vao:null}function et(X){if(X!==ht.currentVAO){var W=rt();X?W.bindVertexArrayOES(X.vao):W.bindVertexArrayOES(null),ht.currentVAO=X}}function At(X){if(X!==ht.currentVAO){if(X)X.bindAttrs();else{for(var W=R(),It=0;It<J.length;++It){var ut=J[It];ut.buffer?(l.enableVertexAttribArray(It),ut.buffer.bind(),l.vertexAttribPointer(It,ut.size,ut.type,ut.normalized,ut.stride,ut.offfset),W&&ut.divisor&&W.vertexAttribDivisorANGLE(It,ut.divisor)):(l.disableVertexAttribArray(It),l.vertexAttrib4f(It,ut.x,ut.y,ut.z,ut.w))}j.elements?l.bindBuffer(hs,j.elements.buffer.buffer):l.bindBuffer(hs,null)}ht.currentVAO=X}}function q(){ar(nt).forEach(function(X){X.destroy()})}function bt(){this.id=++st,this.attributes=[],this.elements=null,this.ownsElements=!1,this.count=0,this.offset=0,this.instances=-1,this.primitive=4;var X=rt();X?this.vao=X.createVertexArrayOES():this.vao=null,nt[this.id]=this,this.buffers=[]}bt.prototype.bindAttrs=function(){for(var X=R(),W=this.attributes,It=0;It<W.length;++It){var ut=W[It];ut.buffer?(l.enableVertexAttribArray(It),l.bindBuffer(oc,ut.buffer.buffer),l.vertexAttribPointer(It,ut.size,ut.type,ut.normalized,ut.stride,ut.offset),X&&ut.divisor&&X.vertexAttribDivisorANGLE(It,ut.divisor)):(l.disableVertexAttribArray(It),l.vertexAttrib4f(It,ut.x,ut.y,ut.z,ut.w))}for(var tt=W.length;tt<K;++tt)l.disableVertexAttribArray(tt);var mt=B.getElements(this.elements);mt?l.bindBuffer(hs,mt.buffer.buffer):l.bindBuffer(hs,null)},bt.prototype.refresh=function(){var X=rt();X&&(X.bindVertexArrayOES(this.vao),this.bindAttrs(),ht.currentVAO=null,X.bindVertexArrayOES(null))},bt.prototype.destroy=function(){if(this.vao){var X=rt();this===ht.currentVAO&&(ht.currentVAO=null,X.bindVertexArrayOES(null)),X.deleteVertexArrayOES(this.vao),this.vao=null}this.ownsElements&&(this.elements.destroy(),this.elements=null,this.ownsElements=!1),nt[this.id]&&(delete nt[this.id],k.vaoCount-=1)};function yt(){var X=rt();X&&ar(nt).forEach(function(W){W.refresh()})}function Ft(X){var W=new bt;k.vaoCount+=1;function It(ut){var tt;if(Array.isArray(ut))tt=ut,W.elements&&W.ownsElements&&W.elements.destroy(),W.elements=null,W.ownsElements=!1,W.offset=0,W.count=0,W.instances=-1,W.primitive=4;else{if(m(typeof ut=="object","invalid arguments for create vao"),m("attributes"in ut,"must specify attributes for vao"),ut.elements){var mt=ut.elements;W.ownsElements?typeof mt=="function"&&mt._reglType==="elements"?(W.elements.destroy(),W.ownsElements=!1):(W.elements(mt),W.ownsElements=!1):B.getElements(ut.elements)?(W.elements=ut.elements,W.ownsElements=!1):(W.elements=B.create(ut.elements),W.ownsElements=!0)}else W.elements=null,W.ownsElements=!1;tt=ut.attributes,W.offset=0,W.count=-1,W.instances=-1,W.primitive=4,W.elements&&(W.count=W.elements._elements.vertCount,W.primitive=W.elements._elements.primType),"offset"in ut&&(W.offset=ut.offset|0),"count"in ut&&(W.count=ut.count|0),"instances"in ut&&(W.instances=ut.instances|0),"primitive"in ut&&(m(ut.primitive in Yr,"bad primitive type: "+ut.primitive),W.primitive=Yr[ut.primitive]),m.optional(()=>{for(var ye=Object.keys(ut),xe=0;xe<ye.length;++xe)m(lc.indexOf(ye[xe])>=0,'invalid option for vao: "'+ye[xe]+'" valid options are '+lc)}),m(Array.isArray(tt),"attributes must be an array")}m(tt.length<K,"too many attributes"),m(tt.length>0,"must specify at least one attribute");var pt={},Wt=W.attributes;Wt.length=tt.length;for(var Vt=0;Vt<tt.length;++Vt){var xt=tt[Vt],vt=Wt[Vt]=new Da,kt=xt.data||xt;if(Array.isArray(kt)||e(kt)||pr(kt)){var jt;W.buffers[Vt]&&(jt=W.buffers[Vt],e(kt)&&jt._buffer.byteLength>=kt.byteLength?jt.subdata(kt):(jt.destroy(),W.buffers[Vt]=null)),W.buffers[Vt]||(jt=W.buffers[Vt]=Y.create(xt,oc,!1,!0)),vt.buffer=Y.getBuffer(jt),vt.size=vt.buffer.dimension|0,vt.normalized=!1,vt.type=vt.buffer.dtype,vt.offset=0,vt.stride=0,vt.divisor=0,vt.state=1,pt[Vt]=1}else Y.getBuffer(xt)?(vt.buffer=Y.getBuffer(xt),vt.size=vt.buffer.dimension|0,vt.normalized=!1,vt.type=vt.buffer.dtype,vt.offset=0,vt.stride=0,vt.divisor=0,vt.state=1):Y.getBuffer(xt.buffer)?(vt.buffer=Y.getBuffer(xt.buffer),vt.size=(+xt.size||vt.buffer.dimension)|0,vt.normalized=!!xt.normalized||!1,"type"in xt?(m.parameter(xt.type,ui,"invalid buffer type"),vt.type=ui[xt.type]):vt.type=vt.buffer.dtype,vt.offset=(xt.offset||0)|0,vt.stride=(xt.stride||0)|0,vt.divisor=(xt.divisor||0)|0,vt.state=1,m(vt.size>=1&&vt.size<=4,"size must be between 1 and 4"),m(vt.offset>=0,"invalid offset"),m(vt.stride>=0&&vt.stride<=255,"stride must be between 0 and 255"),m(vt.divisor>=0,"divisor must be positive"),m(!vt.divisor||!!p.angle_instanced_arrays,"ANGLE_instanced_arrays must be enabled to use divisor")):"x"in xt?(m(Vt>0,"first attribute must not be a constant"),vt.x=+xt.x||0,vt.y=+xt.y||0,vt.z=+xt.z||0,vt.w=+xt.w||0,vt.state=2):m(!1,"invalid attribute spec for location "+Vt)}for(var Zt=0;Zt<W.buffers.length;++Zt)!pt[Zt]&&W.buffers[Zt]&&(W.buffers[Zt].destroy(),W.buffers[Zt]=null);return W.refresh(),It}return It.destroy=function(){for(var ut=0;ut<W.buffers.length;++ut)W.buffers[ut]&&W.buffers[ut].destroy();W.buffers.length=0,W.ownsElements&&(W.elements.destroy(),W.elements=null,W.ownsElements=!1),W.destroy()},It._vao=W,It._reglType="vao",It(X)}return ht}var cc=35632,Gm=35633,Vm=35718,jm=35721;function Hm(l,p,E,k){var Y={},B={};function j(R,G,et,At){this.name=R,this.id=G,this.location=et,this.info=At}function K(R,G){for(var et=0;et<R.length;++et)if(R[et].id===G.id){R[et].location=G.location;return}R.push(G)}function J(R,G,et){var At=R===cc?Y:B,q=At[G];if(!q){var bt=p.str(G);q=l.createShader(R),l.shaderSource(q,bt),l.compileShader(q),m.shaderError(l,q,bt,R,et),At[G]=q}return q}var it={},st=[],nt=0;function ht(R,G){this.id=nt++,this.fragId=R,this.vertId=G,this.program=null,this.uniforms=[],this.attributes=[],this.refCount=1,k.profile&&(this.stats={uniformsCount:0,attributesCount:0})}function Q(R,G,et){var At,q,bt=J(cc,R.fragId),yt=J(Gm,R.vertId),Ft=R.program=l.createProgram();if(l.attachShader(Ft,bt),l.attachShader(Ft,yt),et)for(At=0;At<et.length;++At){var X=et[At];l.bindAttribLocation(Ft,X[0],X[1])}l.linkProgram(Ft),m.linkError(l,Ft,p.str(R.fragId),p.str(R.vertId),G);var W=l.getProgramParameter(Ft,Vm);k.profile&&(R.stats.uniformsCount=W);var It=R.uniforms;for(At=0;At<W;++At)if(q=l.getActiveUniform(Ft,At),q)if(q.size>1)for(var ut=0;ut<q.size;++ut){var tt=q.name.replace("[0]","["+ut+"]");K(It,new j(tt,p.id(tt),l.getUniformLocation(Ft,tt),q))}else K(It,new j(q.name,p.id(q.name),l.getUniformLocation(Ft,q.name),q));var mt=l.getProgramParameter(Ft,jm);k.profile&&(R.stats.attributesCount=mt);var pt=R.attributes;for(At=0;At<mt;++At)q=l.getActiveAttrib(Ft,At),q&&K(pt,new j(q.name,p.id(q.name),l.getAttribLocation(Ft,q.name),q))}k.profile&&(E.getMaxUniformsCount=function(){var R=0;return st.forEach(function(G){G.stats.uniformsCount>R&&(R=G.stats.uniformsCount)}),R},E.getMaxAttributesCount=function(){var R=0;return st.forEach(function(G){G.stats.attributesCount>R&&(R=G.stats.attributesCount)}),R});function rt(){Y={},B={};for(var R=0;R<st.length;++R)Q(st[R],null,st[R].attributes.map(function(G){return[G.location,G.name]}))}return{clear:function(){var R=l.deleteShader.bind(l);ar(Y).forEach(R),Y={},ar(B).forEach(R),B={},st.forEach(function(G){l.deleteProgram(G.program)}),st.length=0,it={},E.shaderCount=0},program:function(R,G,et,At){m.command(R>=0,"missing vertex shader",et),m.command(G>=0,"missing fragment shader",et);var q=it[G];q||(q=it[G]={});var bt=q[R];if(bt&&(bt.refCount++,!At))return bt;var yt=new ht(G,R);return E.shaderCount++,Q(yt,et,At),bt||(q[R]=yt),st.push(yt),r(yt,{destroy:function(){if(yt.refCount--,yt.refCount<=0){l.deleteProgram(yt.program);var Ft=st.indexOf(yt);st.splice(Ft,1),E.shaderCount--}q[yt.vertId].refCount<=0&&(l.deleteShader(B[yt.vertId]),delete B[yt.vertId],delete it[yt.fragId][yt.vertId]),Object.keys(it[yt.fragId]).length||(l.deleteShader(Y[yt.fragId]),delete Y[yt.fragId],delete it[yt.fragId])}})},restore:rt,shader:J,frag:-1,vert:-1}}var Wm=6408,An=5121,Ym=3333,us=5126;function Xm(l,p,E,k,Y,B,j){function K(st){var nt;p.next===null?(m(Y.preserveDrawingBuffer,'you must create a webgl context with "preserveDrawingBuffer":true in order to read pixels from the drawing buffer'),nt=An):(m(p.next.colorAttachments[0].texture!==null,"You cannot read from a renderbuffer"),nt=p.next.colorAttachments[0].texture._texture.type,m.optional(function(){B.oes_texture_float?(m(nt===An||nt===us,"Reading from a framebuffer is only allowed for the types 'uint8' and 'float'"),nt===us&&m(j.readFloat,"Reading 'float' values is not permitted in your browser. For a fallback, please see: https://www.npmjs.com/package/glsl-read-float")):m(nt===An,"Reading from a framebuffer is only allowed for the type 'uint8'")}));var ht=0,Q=0,rt=k.framebufferWidth,R=k.framebufferHeight,G=null;e(st)?G=st:st&&(m.type(st,"object","invalid arguments to regl.read()"),ht=st.x|0,Q=st.y|0,m(ht>=0&&ht<k.framebufferWidth,"invalid x offset for regl.read"),m(Q>=0&&Q<k.framebufferHeight,"invalid y offset for regl.read"),rt=(st.width||k.framebufferWidth-ht)|0,R=(st.height||k.framebufferHeight-Q)|0,G=st.data||null),G&&(nt===An?m(G instanceof Uint8Array,"buffer must be 'Uint8Array' when reading from a framebuffer of type 'uint8'"):nt===us&&m(G instanceof Float32Array,"buffer must be 'Float32Array' when reading from a framebuffer of type 'float'")),m(rt>0&&rt+ht<=k.framebufferWidth,"invalid width for read pixels"),m(R>0&&R+Q<=k.framebufferHeight,"invalid height for read pixels"),E();var et=rt*R*4;return G||(nt===An?G=new Uint8Array(et):nt===us&&(G=G||new Float32Array(et))),m.isTypedArray(G,"data buffer for regl.read() must be a typedarray"),m(G.byteLength>=et,"data buffer for regl.read() too small"),l.pixelStorei(Ym,4),l.readPixels(ht,Q,rt,R,Wm,nt,G),G}function J(st){var nt;return p.setFBO({framebuffer:st.framebuffer},function(){nt=K(st)}),nt}function it(st){return!st||!("framebuffer"in st)?K(st):J(st)}return it}function zi(l){return Array.prototype.slice.call(l)}function Ui(l){return zi(l).join("")}function $m(){var l=0,p=[],E=[];function k(nt){for(var ht=0;ht<E.length;++ht)if(E[ht]===nt)return p[ht];var Q="g"+l++;return p.push(Q),E.push(nt),Q}function Y(){var nt=[];function ht(){nt.push.apply(nt,zi(arguments))}var Q=[];function rt(){var R="v"+l++;return Q.push(R),arguments.length>0&&(nt.push(R,"="),nt.push.apply(nt,zi(arguments)),nt.push(";")),R}return r(ht,{def:rt,toString:function(){return Ui([Q.length>0?"var "+Q.join(",")+";":"",Ui(nt)])}})}function B(){var nt=Y(),ht=Y(),Q=nt.toString,rt=ht.toString;function R(G,et){ht(G,et,"=",nt.def(G,et),";")}return r(function(){nt.apply(nt,zi(arguments))},{def:nt.def,entry:nt,exit:ht,save:R,set:function(G,et,At){R(G,et),nt(G,et,"=",At,";")},toString:function(){return Q()+rt()}})}function j(){var nt=Ui(arguments),ht=B(),Q=B(),rt=ht.toString,R=Q.toString;return r(ht,{then:function(){return ht.apply(ht,zi(arguments)),this},else:function(){return Q.apply(Q,zi(arguments)),this},toString:function(){var G=R();return G&&(G="else{"+G+"}"),Ui(["if(",nt,"){",rt(),"}",G])}})}var K=Y(),J={};function it(nt,ht){var Q=[];function rt(){var q="a"+Q.length;return Q.push(q),q}ht=ht||0;for(var R=0;R<ht;++R)rt();var G=B(),et=G.toString,At=J[nt]=r(G,{arg:rt,toString:function(){return Ui(["function(",Q.join(),"){",et(),"}"])}});return At}function st(){var nt=['"use strict";',K,"return {"];Object.keys(J).forEach(function(rt){nt.push('"',rt,'":',J[rt].toString(),",")}),nt.push("}");var ht=Ui(nt).replace(/;/g,`;
`).replace(/}/g,`}
`).replace(/{/g,`{
`),Q=Function.apply(null,p.concat(ht));return Q.apply(null,E)}return{global:K,link:k,block:Y,proc:it,scope:B,cond:j,compile:st}}var Gi="xyzw".split(""),hc=5121,Vi=1,Fa=2,Pa=0,Ba=1,ka=2,za=3,fs=4,uc=5,fc=6,dc="dither",mc="blend.enable",pc="blend.color",Ua="blend.equation",Ga="blend.func",yc="depth.enable",xc="depth.func",gc="depth.range",_c="depth.mask",Va="colorMask",bc="cull.enable",vc="cull.face",ja="frontFace",Ha="lineWidth",Ec="polygonOffset.enable",Wa="polygonOffset.offset",Ac="sample.alpha",Tc="sample.enable",Ya="sample.coverage",Sc="stencil.enable",wc="stencil.mask",Xa="stencil.func",$a="stencil.opFront",Tn="stencil.opBack",Mc="scissor.enable",ds="scissor.box",Nr="viewport",Sn="profile",yi="framebuffer",wn="vert",Mn="frag",xi="elements",gi="primitive",_i="count",ms="offset",ps="instances",Cn="vao",qa="Width",Ja="Height",ji=yi+qa,Hi=yi+Ja,qm=Nr+qa,Jm=Nr+Ja,Cc="drawingBuffer",Ic=Cc+qa,Rc=Cc+Ja,Zm=[Ga,Ua,Xa,$a,Tn,Ya,Nr,ds,Wa],Wi=34962,Za=34963,Km=35632,Qm=35633,Oc=3553,tp=34067,ep=2884,rp=3042,ip=3024,np=2960,sp=2929,ap=3089,op=32823,lp=32926,cp=32928,Ka=5126,ys=35664,xs=35665,gs=35666,Qa=5124,_s=35667,bs=35668,vs=35669,to=35670,Es=35671,As=35672,Ts=35673,In=35674,Rn=35675,On=35676,Nn=35678,Ln=35680,eo=4,Dn=1028,bi=1029,Nc=2304,ro=2305,hp=32775,up=32776,fp=519,$r=7680,Lc=0,Dc=1,Fc=32774,dp=513,Pc=36160,mp=36064,wr={0:0,1:1,zero:0,one:1,"src color":768,"one minus src color":769,"src alpha":770,"one minus src alpha":771,"dst color":774,"one minus dst color":775,"dst alpha":772,"one minus dst alpha":773,"constant color":32769,"one minus constant color":32770,"constant alpha":32771,"one minus constant alpha":32772,"src alpha saturate":776},Bc=["constant color, constant alpha","one minus constant color, constant alpha","constant color, one minus constant alpha","one minus constant color, one minus constant alpha","constant alpha, constant color","constant alpha, one minus constant color","one minus constant alpha, constant color","one minus constant alpha, one minus constant color"],Yi={never:512,less:513,"<":513,equal:514,"=":514,"==":514,"===":514,lequal:515,"<=":515,greater:516,">":516,notequal:517,"!=":517,"!==":517,gequal:518,">=":518,always:519},qr={0:0,zero:0,keep:7680,replace:7681,increment:7682,decrement:7683,"increment wrap":34055,"decrement wrap":34056,invert:5386},kc={frag:Km,vert:Qm},io={cw:Nc,ccw:ro};function Ss(l){return Array.isArray(l)||e(l)||pr(l)}function zc(l){return l.sort(function(p,E){return p===Nr?-1:E===Nr?1:p<E?-1:1})}function Pe(l,p,E,k){this.thisDep=l,this.contextDep=p,this.propDep=E,this.append=k}function Jr(l){return l&&!(l.thisDep||l.contextDep||l.propDep)}function Ie(l){return new Pe(!1,!1,!1,l)}function tr(l,p){var E=l.type;if(E===Pa){var k=l.data.length;return new Pe(!0,k>=1,k>=2,p)}else if(E===fs){var Y=l.data;return new Pe(Y.thisDep,Y.contextDep,Y.propDep,p)}else{if(E===uc)return new Pe(!1,!1,!1,p);if(E===fc){for(var B=!1,j=!1,K=!1,J=0;J<l.data.length;++J){var it=l.data[J];if(it.type===Ba)K=!0;else if(it.type===ka)j=!0;else if(it.type===za)B=!0;else if(it.type===Pa){B=!0;var st=it.data;st>=1&&(j=!0),st>=2&&(K=!0)}else it.type===fs&&(B=B||it.data.thisDep,j=j||it.data.contextDep,K=K||it.data.propDep)}return new Pe(B,j,K,p)}else return new Pe(E===za,E===ka,E===Ba,p)}}var Uc=new Pe(!1,!1,!1,function(){});function pp(l,p,E,k,Y,B,j,K,J,it,st,nt,ht,Q,rt){var R=it.Record,G={add:32774,subtract:32778,"reverse subtract":32779};E.ext_blend_minmax&&(G.min=hp,G.max=up);var et=E.angle_instanced_arrays,At=E.webgl_draw_buffers,q=E.oes_vertex_array_object,bt={dirty:!0,profile:rt.profile},yt={},Ft=[],X={},W={};function It(_){return _.replace(".","_")}function ut(_,f,S){var I=It(_);Ft.push(_),yt[I]=bt[I]=!!S,X[I]=f}function tt(_,f,S){var I=It(_);Ft.push(_),Array.isArray(S)?(bt[I]=S.slice(),yt[I]=S.slice()):bt[I]=yt[I]=S,W[I]=f}ut(dc,ip),ut(mc,rp),tt(pc,"blendColor",[0,0,0,0]),tt(Ua,"blendEquationSeparate",[Fc,Fc]),tt(Ga,"blendFuncSeparate",[Dc,Lc,Dc,Lc]),ut(yc,sp,!0),tt(xc,"depthFunc",dp),tt(gc,"depthRange",[0,1]),tt(_c,"depthMask",!0),tt(Va,Va,[!0,!0,!0,!0]),ut(bc,ep),tt(vc,"cullFace",bi),tt(ja,ja,ro),tt(Ha,Ha,1),ut(Ec,op),tt(Wa,"polygonOffset",[0,0]),ut(Ac,lp),ut(Tc,cp),tt(Ya,"sampleCoverage",[1,!1]),ut(Sc,np),tt(wc,"stencilMask",-1),tt(Xa,"stencilFunc",[fp,0,-1]),tt($a,"stencilOpSeparate",[Dn,$r,$r,$r]),tt(Tn,"stencilOpSeparate",[bi,$r,$r,$r]),ut(Mc,ap),tt(ds,"scissor",[0,0,l.drawingBufferWidth,l.drawingBufferHeight]),tt(Nr,Nr,[0,0,l.drawingBufferWidth,l.drawingBufferHeight]);var mt={gl:l,context:ht,strings:p,next:yt,current:bt,draw:nt,elements:B,buffer:Y,shader:st,attributes:it.state,vao:it,uniforms:J,framebuffer:K,extensions:E,timer:Q,isBufferArgs:Ss},pt={primTypes:Yr,compareFuncs:Yi,blendFuncs:wr,blendEquations:G,stencilOps:qr,glTypes:ui,orientationType:io};m.optional(function(){mt.isArrayLike=Ee}),At&&(pt.backBuffer=[bi],pt.drawBuffer=sr(k.maxDrawbuffers,function(_){return _===0?[0]:sr(_,function(f){return mp+f})}));var Wt=0;function Vt(){var _=$m(),f=_.link,S=_.global;_.id=Wt++,_.batchId="0";var I=f(mt),N=_.shared={props:"a0"};Object.keys(mt).forEach(function(T){N[T]=S.def(I,".",T)}),m.optional(function(){_.CHECK=f(m),_.commandStr=m.guessCommand(),_.command=f(_.commandStr),_.assert=function(T,b,O){T("if(!(",b,"))",this.CHECK,".commandRaise(",f(O),",",this.command,");")},pt.invalidBlendCombinations=Bc});var M=_.next={},w=_.current={};Object.keys(W).forEach(function(T){Array.isArray(bt[T])&&(M[T]=S.def(N.next,".",T),w[T]=S.def(N.current,".",T))});var C=_.constants={};Object.keys(pt).forEach(function(T){C[T]=S.def(JSON.stringify(pt[T]))}),_.invoke=function(T,b){switch(b.type){case Pa:var O=["this",N.context,N.props,_.batchId];return T.def(f(b.data),".call(",O.slice(0,Math.max(b.data.length+1,4)),")");case Ba:return T.def(N.props,b.data);case ka:return T.def(N.context,b.data);case za:return T.def("this",b.data);case fs:return b.data.append(_,T),b.data.ref;case uc:return b.data.toString();case fc:return b.data.map(function(F){return _.invoke(T,F)})}},_.attribCache={};var x={};return _.scopeAttrib=function(T){var b=p.id(T);if(b in x)return x[b];var O=it.scope[b];O||(O=it.scope[b]=new R);var F=x[b]=f(O);return F},_}function xt(_){var f=_.static,S=_.dynamic,I;if(Sn in f){var N=!!f[Sn];I=Ie(function(w,C){return N}),I.enable=N}else if(Sn in S){var M=S[Sn];I=tr(M,function(w,C){return w.invoke(C,M)})}return I}function vt(_,f){var S=_.static,I=_.dynamic;if(yi in S){var N=S[yi];return N?(N=K.getFramebuffer(N),m.command(N,"invalid framebuffer object"),Ie(function(w,C){var x=w.link(N),T=w.shared;C.set(T.framebuffer,".next",x);var b=T.context;return C.set(b,"."+ji,x+".width"),C.set(b,"."+Hi,x+".height"),x})):Ie(function(w,C){var x=w.shared;C.set(x.framebuffer,".next","null");var T=x.context;return C.set(T,"."+ji,T+"."+Ic),C.set(T,"."+Hi,T+"."+Rc),"null"})}else if(yi in I){var M=I[yi];return tr(M,function(w,C){var x=w.invoke(C,M),T=w.shared,b=T.framebuffer,O=C.def(b,".getFramebuffer(",x,")");m.optional(function(){w.assert(C,"!"+x+"||"+O,"invalid framebuffer object")}),C.set(b,".next",O);var F=T.context;return C.set(F,"."+ji,O+"?"+O+".width:"+F+"."+Ic),C.set(F,"."+Hi,O+"?"+O+".height:"+F+"."+Rc),O})}else return null}function kt(_,f,S){var I=_.static,N=_.dynamic;function M(x){if(x in I){var T=I[x];m.commandType(T,"object","invalid "+x,S.commandStr);var b=!0,O=T.x|0,F=T.y|0,$,ot;return"width"in T?($=T.width|0,m.command($>=0,"invalid "+x,S.commandStr)):b=!1,"height"in T?(ot=T.height|0,m.command(ot>=0,"invalid "+x,S.commandStr)):b=!1,new Pe(!b&&f&&f.thisDep,!b&&f&&f.contextDep,!b&&f&&f.propDep,function(at,Nt){var wt=at.shared.context,Rt=$;"width"in T||(Rt=Nt.def(wt,".",ji,"-",O));var Ot=ot;return"height"in T||(Ot=Nt.def(wt,".",Hi,"-",F)),[O,F,Rt,Ot]})}else if(x in N){var lt=N[x],gt=tr(lt,function(at,Nt){var wt=at.invoke(Nt,lt);m.optional(function(){at.assert(Nt,wt+"&&typeof "+wt+'==="object"',"invalid "+x)});var Rt=at.shared.context,Ot=Nt.def(wt,".x|0"),Lt=Nt.def(wt,".y|0"),zt=Nt.def('"width" in ',wt,"?",wt,".width|0:","(",Rt,".",ji,"-",Ot,")"),fe=Nt.def('"height" in ',wt,"?",wt,".height|0:","(",Rt,".",Hi,"-",Lt,")");return m.optional(function(){at.assert(Nt,zt+">=0&&"+fe+">=0","invalid "+x)}),[Ot,Lt,zt,fe]});return f&&(gt.thisDep=gt.thisDep||f.thisDep,gt.contextDep=gt.contextDep||f.contextDep,gt.propDep=gt.propDep||f.propDep),gt}else return f?new Pe(f.thisDep,f.contextDep,f.propDep,function(at,Nt){var wt=at.shared.context;return[0,0,Nt.def(wt,".",ji),Nt.def(wt,".",Hi)]}):null}var w=M(Nr);if(w){var C=w;w=new Pe(w.thisDep,w.contextDep,w.propDep,function(x,T){var b=C.append(x,T),O=x.shared.context;return T.set(O,"."+qm,b[2]),T.set(O,"."+Jm,b[3]),b})}return{viewport:w,scissor_box:M(ds)}}function jt(_,f){var S=_.static,I=typeof S[Mn]=="string"&&typeof S[wn]=="string";if(I){if(Object.keys(f.dynamic).length>0)return null;var N=f.static,M=Object.keys(N);if(M.length>0&&typeof N[M[0]]=="number"){for(var w=[],C=0;C<M.length;++C)m(typeof N[M[C]]=="number","must specify all vertex attribute locations when using vaos"),w.push([N[M[C]]|0,M[C]]);return w}}return null}function Zt(_,f,S){var I=_.static,N=_.dynamic;function M(b){if(b in I){var O=p.id(I[b]);m.optional(function(){st.shader(kc[b],O,m.guessCommand())});var F=Ie(function(){return O});return F.id=O,F}else if(b in N){var $=N[b];return tr($,function(ot,lt){var gt=ot.invoke(lt,$),at=lt.def(ot.shared.strings,".id(",gt,")");return m.optional(function(){lt(ot.shared.shader,".shader(",kc[b],",",at,",",ot.command,");")}),at})}return null}var w=M(Mn),C=M(wn),x=null,T;return Jr(w)&&Jr(C)?(x=st.program(C.id,w.id,null,S),T=Ie(function(b,O){return b.link(x)})):T=new Pe(w&&w.thisDep||C&&C.thisDep,w&&w.contextDep||C&&C.contextDep,w&&w.propDep||C&&C.propDep,function(b,O){var F=b.shared.shader,$;w?$=w.append(b,O):$=O.def(F,".",Mn);var ot;C?ot=C.append(b,O):ot=O.def(F,".",wn);var lt=F+".program("+ot+","+$;return m.optional(function(){lt+=","+b.command}),O.def(lt+")")}),{frag:w,vert:C,progVar:T,program:x}}function ye(_,f){var S=_.static,I=_.dynamic,N={},M=!1;function w(){if(Cn in S){var Nt=S[Cn];return Nt!==null&&it.getVAO(Nt)===null&&(Nt=it.createVAO(Nt)),M=!0,N.vao=Nt,Ie(function(Rt){var Ot=it.getVAO(Nt);return Ot?Rt.link(Ot):"null"})}else if(Cn in I){M=!0;var wt=I[Cn];return tr(wt,function(Rt,Ot){var Lt=Rt.invoke(Ot,wt);return Ot.def(Rt.shared.vao+".getVAO("+Lt+")")})}return null}var C=w(),x=!1;function T(){if(xi in S){var Nt=S[xi];if(N.elements=Nt,Ss(Nt)){var wt=N.elements=B.create(Nt,!0);Nt=B.getElements(wt),x=!0}else Nt&&(Nt=B.getElements(Nt),x=!0,m.command(Nt,"invalid elements",f.commandStr));var Rt=Ie(function(Lt,zt){if(Nt){var fe=Lt.link(Nt);return Lt.ELEMENTS=fe,fe}return Lt.ELEMENTS=null,null});return Rt.value=Nt,Rt}else if(xi in I){x=!0;var Ot=I[xi];return tr(Ot,function(Lt,zt){var fe=Lt.shared,Ue=fe.isBufferArgs,Lr=fe.elements,Dr=Lt.invoke(zt,Ot),Fr=zt.def("null"),Xe=zt.def(Ue,"(",Dr,")"),Cr=Lt.cond(Xe).then(Fr,"=",Lr,".createStream(",Dr,");").else(Fr,"=",Lr,".getElements(",Dr,");");return m.optional(function(){Lt.assert(Cr.else,"!"+Dr+"||"+Fr,"invalid elements")}),zt.entry(Cr),zt.exit(Lt.cond(Xe).then(Lr,".destroyStream(",Fr,");")),Lt.ELEMENTS=Fr,Fr})}else if(M)return new Pe(C.thisDep,C.contextDep,C.propDep,function(Lt,zt){return zt.def(Lt.shared.vao+".currentVAO?"+Lt.shared.elements+".getElements("+Lt.shared.vao+".currentVAO.elements):null")});return null}var b=T();function O(){if(gi in S){var Nt=S[gi];return N.primitive=Nt,m.commandParameter(Nt,Yr,"invalid primitve",f.commandStr),Ie(function(Rt,Ot){return Yr[Nt]})}else if(gi in I){var wt=I[gi];return tr(wt,function(Rt,Ot){var Lt=Rt.constants.primTypes,zt=Rt.invoke(Ot,wt);return m.optional(function(){Rt.assert(Ot,zt+" in "+Lt,"invalid primitive, must be one of "+Object.keys(Yr))}),Ot.def(Lt,"[",zt,"]")})}else{if(x)return Jr(b)?b.value?Ie(function(Rt,Ot){return Ot.def(Rt.ELEMENTS,".primType")}):Ie(function(){return eo}):new Pe(b.thisDep,b.contextDep,b.propDep,function(Rt,Ot){var Lt=Rt.ELEMENTS;return Ot.def(Lt,"?",Lt,".primType:",eo)});if(M)return new Pe(C.thisDep,C.contextDep,C.propDep,function(Rt,Ot){return Ot.def(Rt.shared.vao+".currentVAO?"+Rt.shared.vao+".currentVAO.primitive:"+eo)})}return null}function F(Nt,wt){if(Nt in S){var Rt=S[Nt]|0;return wt?N.offset=Rt:N.instances=Rt,m.command(!wt||Rt>=0,"invalid "+Nt,f.commandStr),Ie(function(Lt,zt){return wt&&(Lt.OFFSET=Rt),Rt})}else if(Nt in I){var Ot=I[Nt];return tr(Ot,function(Lt,zt){var fe=Lt.invoke(zt,Ot);return wt&&(Lt.OFFSET=fe,m.optional(function(){Lt.assert(zt,fe+">=0","invalid "+Nt)})),fe})}else if(wt){if(x)return Ie(function(Lt,zt){return Lt.OFFSET=0,0});if(M)return new Pe(C.thisDep,C.contextDep,C.propDep,function(Lt,zt){return zt.def(Lt.shared.vao+".currentVAO?"+Lt.shared.vao+".currentVAO.offset:0")})}else if(M)return new Pe(C.thisDep,C.contextDep,C.propDep,function(Lt,zt){return zt.def(Lt.shared.vao+".currentVAO?"+Lt.shared.vao+".currentVAO.instances:-1")});return null}var $=F(ms,!0);function ot(){if(_i in S){var Nt=S[_i]|0;return N.count=Nt,m.command(typeof Nt=="number"&&Nt>=0,"invalid vertex count",f.commandStr),Ie(function(){return Nt})}else if(_i in I){var wt=I[_i];return tr(wt,function(zt,fe){var Ue=zt.invoke(fe,wt);return m.optional(function(){zt.assert(fe,"typeof "+Ue+'==="number"&&'+Ue+">=0&&"+Ue+"===("+Ue+"|0)","invalid vertex count")}),Ue})}else if(x)if(Jr(b)){if(b)return $?new Pe($.thisDep,$.contextDep,$.propDep,function(zt,fe){var Ue=fe.def(zt.ELEMENTS,".vertCount-",zt.OFFSET);return m.optional(function(){zt.assert(fe,Ue+">=0","invalid vertex offset/element buffer too small")}),Ue}):Ie(function(zt,fe){return fe.def(zt.ELEMENTS,".vertCount")});var Rt=Ie(function(){return-1});return m.optional(function(){Rt.MISSING=!0}),Rt}else{var Ot=new Pe(b.thisDep||$.thisDep,b.contextDep||$.contextDep,b.propDep||$.propDep,function(zt,fe){var Ue=zt.ELEMENTS;return zt.OFFSET?fe.def(Ue,"?",Ue,".vertCount-",zt.OFFSET,":-1"):fe.def(Ue,"?",Ue,".vertCount:-1")});return m.optional(function(){Ot.DYNAMIC=!0}),Ot}else if(M){var Lt=new Pe(C.thisDep,C.contextDep,C.propDep,function(zt,fe){return fe.def(zt.shared.vao,".currentVAO?",zt.shared.vao,".currentVAO.count:-1")});return Lt}return null}var lt=O(),gt=ot(),at=F(ps,!1);return{elements:b,primitive:lt,count:gt,instances:at,offset:$,vao:C,vaoActive:M,elementsActive:x,static:N}}function xe(_,f){var S=_.static,I=_.dynamic,N={};return Ft.forEach(function(M){var w=It(M);function C(x,T){if(M in S){var b=x(S[M]);N[w]=Ie(function(){return b})}else if(M in I){var O=I[M];N[w]=tr(O,function(F,$){return T(F,$,F.invoke($,O))})}}switch(M){case bc:case mc:case dc:case Sc:case yc:case Mc:case Ec:case Ac:case Tc:case _c:return C(function(x){return m.commandType(x,"boolean",M,f.commandStr),x},function(x,T,b){return m.optional(function(){x.assert(T,"typeof "+b+'==="boolean"',"invalid flag "+M,x.commandStr)}),b});case xc:return C(function(x){return m.commandParameter(x,Yi,"invalid "+M,f.commandStr),Yi[x]},function(x,T,b){var O=x.constants.compareFuncs;return m.optional(function(){x.assert(T,b+" in "+O,"invalid "+M+", must be one of "+Object.keys(Yi))}),T.def(O,"[",b,"]")});case gc:return C(function(x){return m.command(Ee(x)&&x.length===2&&typeof x[0]=="number"&&typeof x[1]=="number"&&x[0]<=x[1],"depth range is 2d array",f.commandStr),x},function(x,T,b){m.optional(function(){x.assert(T,x.shared.isArrayLike+"("+b+")&&"+b+".length===2&&typeof "+b+'[0]==="number"&&typeof '+b+'[1]==="number"&&'+b+"[0]<="+b+"[1]","depth range must be a 2d array")});var O=T.def("+",b,"[0]"),F=T.def("+",b,"[1]");return[O,F]});case Ga:return C(function(x){m.commandType(x,"object","blend.func",f.commandStr);var T="srcRGB"in x?x.srcRGB:x.src,b="srcAlpha"in x?x.srcAlpha:x.src,O="dstRGB"in x?x.dstRGB:x.dst,F="dstAlpha"in x?x.dstAlpha:x.dst;return m.commandParameter(T,wr,w+".srcRGB",f.commandStr),m.commandParameter(b,wr,w+".srcAlpha",f.commandStr),m.commandParameter(O,wr,w+".dstRGB",f.commandStr),m.commandParameter(F,wr,w+".dstAlpha",f.commandStr),m.command(Bc.indexOf(T+", "+O)===-1,"unallowed blending combination (srcRGB, dstRGB) = ("+T+", "+O+")",f.commandStr),[wr[T],wr[O],wr[b],wr[F]]},function(x,T,b){var O=x.constants.blendFuncs;m.optional(function(){x.assert(T,b+"&&typeof "+b+'==="object"',"invalid blend func, must be an object")});function F(wt,Rt){var Ot=T.def('"',wt,Rt,'" in ',b,"?",b,".",wt,Rt,":",b,".",wt);return m.optional(function(){x.assert(T,Ot+" in "+O,"invalid "+M+"."+wt+Rt+", must be one of "+Object.keys(wr))}),Ot}var $=F("src","RGB"),ot=F("dst","RGB");m.optional(function(){var wt=x.constants.invalidBlendCombinations;x.assert(T,wt+".indexOf("+$+'+", "+'+ot+") === -1 ","unallowed blending combination for (srcRGB, dstRGB)")});var lt=T.def(O,"[",$,"]"),gt=T.def(O,"[",F("src","Alpha"),"]"),at=T.def(O,"[",ot,"]"),Nt=T.def(O,"[",F("dst","Alpha"),"]");return[lt,at,gt,Nt]});case Ua:return C(function(x){if(typeof x=="string")return m.commandParameter(x,G,"invalid "+M,f.commandStr),[G[x],G[x]];if(typeof x=="object")return m.commandParameter(x.rgb,G,M+".rgb",f.commandStr),m.commandParameter(x.alpha,G,M+".alpha",f.commandStr),[G[x.rgb],G[x.alpha]];m.commandRaise("invalid blend.equation",f.commandStr)},function(x,T,b){var O=x.constants.blendEquations,F=T.def(),$=T.def(),ot=x.cond("typeof ",b,'==="string"');return m.optional(function(){function lt(gt,at,Nt){x.assert(gt,Nt+" in "+O,"invalid "+at+", must be one of "+Object.keys(G))}lt(ot.then,M,b),x.assert(ot.else,b+"&&typeof "+b+'==="object"',"invalid "+M),lt(ot.else,M+".rgb",b+".rgb"),lt(ot.else,M+".alpha",b+".alpha")}),ot.then(F,"=",$,"=",O,"[",b,"];"),ot.else(F,"=",O,"[",b,".rgb];",$,"=",O,"[",b,".alpha];"),T(ot),[F,$]});case pc:return C(function(x){return m.command(Ee(x)&&x.length===4,"blend.color must be a 4d array",f.commandStr),sr(4,function(T){return+x[T]})},function(x,T,b){return m.optional(function(){x.assert(T,x.shared.isArrayLike+"("+b+")&&"+b+".length===4","blend.color must be a 4d array")}),sr(4,function(O){return T.def("+",b,"[",O,"]")})});case wc:return C(function(x){return m.commandType(x,"number",w,f.commandStr),x|0},function(x,T,b){return m.optional(function(){x.assert(T,"typeof "+b+'==="number"',"invalid stencil.mask")}),T.def(b,"|0")});case Xa:return C(function(x){m.commandType(x,"object",w,f.commandStr);var T=x.cmp||"keep",b=x.ref||0,O="mask"in x?x.mask:-1;return m.commandParameter(T,Yi,M+".cmp",f.commandStr),m.commandType(b,"number",M+".ref",f.commandStr),m.commandType(O,"number",M+".mask",f.commandStr),[Yi[T],b,O]},function(x,T,b){var O=x.constants.compareFuncs;m.optional(function(){function lt(){x.assert(T,Array.prototype.join.call(arguments,""),"invalid stencil.func")}lt(b+"&&typeof ",b,'==="object"'),lt('!("cmp" in ',b,")||(",b,".cmp in ",O,")")});var F=T.def('"cmp" in ',b,"?",O,"[",b,".cmp]",":",$r),$=T.def(b,".ref|0"),ot=T.def('"mask" in ',b,"?",b,".mask|0:-1");return[F,$,ot]});case $a:case Tn:return C(function(x){m.commandType(x,"object",w,f.commandStr);var T=x.fail||"keep",b=x.zfail||"keep",O=x.zpass||"keep";return m.commandParameter(T,qr,M+".fail",f.commandStr),m.commandParameter(b,qr,M+".zfail",f.commandStr),m.commandParameter(O,qr,M+".zpass",f.commandStr),[M===Tn?bi:Dn,qr[T],qr[b],qr[O]]},function(x,T,b){var O=x.constants.stencilOps;m.optional(function(){x.assert(T,b+"&&typeof "+b+'==="object"',"invalid "+M)});function F($){return m.optional(function(){x.assert(T,'!("'+$+'" in '+b+")||("+b+"."+$+" in "+O+")","invalid "+M+"."+$+", must be one of "+Object.keys(qr))}),T.def('"',$,'" in ',b,"?",O,"[",b,".",$,"]:",$r)}return[M===Tn?bi:Dn,F("fail"),F("zfail"),F("zpass")]});case Wa:return C(function(x){m.commandType(x,"object",w,f.commandStr);var T=x.factor|0,b=x.units|0;return m.commandType(T,"number",w+".factor",f.commandStr),m.commandType(b,"number",w+".units",f.commandStr),[T,b]},function(x,T,b){m.optional(function(){x.assert(T,b+"&&typeof "+b+'==="object"',"invalid "+M)});var O=T.def(b,".factor|0"),F=T.def(b,".units|0");return[O,F]});case vc:return C(function(x){var T=0;return x==="front"?T=Dn:x==="back"&&(T=bi),m.command(!!T,w,f.commandStr),T},function(x,T,b){return m.optional(function(){x.assert(T,b+'==="front"||'+b+'==="back"',"invalid cull.face")}),T.def(b,'==="front"?',Dn,":",bi)});case Ha:return C(function(x){return m.command(typeof x=="number"&&x>=k.lineWidthDims[0]&&x<=k.lineWidthDims[1],"invalid line width, must be a positive number between "+k.lineWidthDims[0]+" and "+k.lineWidthDims[1],f.commandStr),x},function(x,T,b){return m.optional(function(){x.assert(T,"typeof "+b+'==="number"&&'+b+">="+k.lineWidthDims[0]+"&&"+b+"<="+k.lineWidthDims[1],"invalid line width")}),b});case ja:return C(function(x){return m.commandParameter(x,io,w,f.commandStr),io[x]},function(x,T,b){return m.optional(function(){x.assert(T,b+'==="cw"||'+b+'==="ccw"',"invalid frontFace, must be one of cw,ccw")}),T.def(b+'==="cw"?'+Nc+":"+ro)});case Va:return C(function(x){return m.command(Ee(x)&&x.length===4,"color.mask must be length 4 array",f.commandStr),x.map(function(T){return!!T})},function(x,T,b){return m.optional(function(){x.assert(T,x.shared.isArrayLike+"("+b+")&&"+b+".length===4","invalid color.mask")}),sr(4,function(O){return"!!"+b+"["+O+"]"})});case Ya:return C(function(x){m.command(typeof x=="object"&&x,w,f.commandStr);var T="value"in x?x.value:1,b=!!x.invert;return m.command(typeof T=="number"&&T>=0&&T<=1,"sample.coverage.value must be a number between 0 and 1",f.commandStr),[T,b]},function(x,T,b){m.optional(function(){x.assert(T,b+"&&typeof "+b+'==="object"',"invalid sample.coverage")});var O=T.def('"value" in ',b,"?+",b,".value:1"),F=T.def("!!",b,".invert");return[O,F]})}}),N}function Qt(_,f){var S=_.static,I=_.dynamic,N={};return Object.keys(S).forEach(function(M){var w=S[M],C;if(typeof w=="number"||typeof w=="boolean")C=Ie(function(){return w});else if(typeof w=="function"){var x=w._reglType;x==="texture2d"||x==="textureCube"?C=Ie(function(T){return T.link(w)}):x==="framebuffer"||x==="framebufferCube"?(m.command(w.color.length>0,'missing color attachment for framebuffer sent to uniform "'+M+'"',f.commandStr),C=Ie(function(T){return T.link(w.color[0])})):m.commandRaise('invalid data for uniform "'+M+'"',f.commandStr)}else Ee(w)?C=Ie(function(T){var b=T.global.def("[",sr(w.length,function(O){return m.command(typeof w[O]=="number"||typeof w[O]=="boolean","invalid uniform "+M,T.commandStr),w[O]}),"]");return b}):m.commandRaise('invalid or missing data for uniform "'+M+'"',f.commandStr);C.value=w,N[M]=C}),Object.keys(I).forEach(function(M){var w=I[M];N[M]=tr(w,function(C,x){return C.invoke(x,w)})}),N}function Ne(_,f){var S=_.static,I=_.dynamic,N={};return Object.keys(S).forEach(function(M){var w=S[M],C=p.id(M),x=new R;if(Ss(w))x.state=Vi,x.buffer=Y.getBuffer(Y.create(w,Wi,!1,!0)),x.type=0;else{var T=Y.getBuffer(w);if(T)x.state=Vi,x.buffer=T,x.type=0;else if(m.command(typeof w=="object"&&w,"invalid data for attribute "+M,f.commandStr),"constant"in w){var b=w.constant;x.buffer="null",x.state=Fa,typeof b=="number"?x.x=b:(m.command(Ee(b)&&b.length>0&&b.length<=4,"invalid constant for attribute "+M,f.commandStr),Gi.forEach(function(at,Nt){Nt<b.length&&(x[at]=b[Nt])}))}else{Ss(w.buffer)?T=Y.getBuffer(Y.create(w.buffer,Wi,!1,!0)):T=Y.getBuffer(w.buffer),m.command(!!T,'missing buffer for attribute "'+M+'"',f.commandStr);var O=w.offset|0;m.command(O>=0,'invalid offset for attribute "'+M+'"',f.commandStr);var F=w.stride|0;m.command(F>=0&&F<256,'invalid stride for attribute "'+M+'", must be integer betweeen [0, 255]',f.commandStr);var $=w.size|0;m.command(!("size"in w)||$>0&&$<=4,'invalid size for attribute "'+M+'", must be 1,2,3,4',f.commandStr);var ot=!!w.normalized,lt=0;"type"in w&&(m.commandParameter(w.type,ui,"invalid type for attribute "+M,f.commandStr),lt=ui[w.type]);var gt=w.divisor|0;m.optional(function(){"divisor"in w&&(m.command(gt===0||et,'cannot specify divisor for attribute "'+M+'", instancing not supported',f.commandStr),m.command(gt>=0,'invalid divisor for attribute "'+M+'"',f.commandStr));var at=f.commandStr,Nt=["buffer","offset","divisor","normalized","type","size","stride"];Object.keys(w).forEach(function(wt){m.command(Nt.indexOf(wt)>=0,'unknown parameter "'+wt+'" for attribute pointer "'+M+'" (valid parameters are '+Nt+")",at)})}),x.buffer=T,x.state=Vi,x.size=$,x.normalized=ot,x.type=lt||T.dtype,x.offset=O,x.stride=F,x.divisor=gt}}N[M]=Ie(function(at,Nt){var wt=at.attribCache;if(C in wt)return wt[C];var Rt={isStream:!1};return Object.keys(x).forEach(function(Ot){Rt[Ot]=x[Ot]}),x.buffer&&(Rt.buffer=at.link(x.buffer),Rt.type=Rt.type||Rt.buffer+".dtype"),wt[C]=Rt,Rt})}),Object.keys(I).forEach(function(M){var w=I[M];function C(x,T){var b=x.invoke(T,w),O=x.shared,F=x.constants,$=O.isBufferArgs,ot=O.buffer;m.optional(function(){x.assert(T,b+"&&(typeof "+b+'==="object"||typeof '+b+'==="function")&&('+$+"("+b+")||"+ot+".getBuffer("+b+")||"+ot+".getBuffer("+b+".buffer)||"+$+"("+b+'.buffer)||("constant" in '+b+"&&(typeof "+b+'.constant==="number"||'+O.isArrayLike+"("+b+".constant))))",'invalid dynamic attribute "'+M+'"')});var lt={isStream:T.def(!1)},gt=new R;gt.state=Vi,Object.keys(gt).forEach(function(Rt){lt[Rt]=T.def(""+gt[Rt])});var at=lt.buffer,Nt=lt.type;T("if(",$,"(",b,")){",lt.isStream,"=true;",at,"=",ot,".createStream(",Wi,",",b,");",Nt,"=",at,".dtype;","}else{",at,"=",ot,".getBuffer(",b,");","if(",at,"){",Nt,"=",at,".dtype;",'}else if("constant" in ',b,"){",lt.state,"=",Fa,";","if(typeof "+b+'.constant === "number"){',lt[Gi[0]],"=",b,".constant;",Gi.slice(1).map(function(Rt){return lt[Rt]}).join("="),"=0;","}else{",Gi.map(function(Rt,Ot){return lt[Rt]+"="+b+".constant.length>"+Ot+"?"+b+".constant["+Ot+"]:0;"}).join(""),"}}else{","if(",$,"(",b,".buffer)){",at,"=",ot,".createStream(",Wi,",",b,".buffer);","}else{",at,"=",ot,".getBuffer(",b,".buffer);","}",Nt,'="type" in ',b,"?",F.glTypes,"[",b,".type]:",at,".dtype;",lt.normalized,"=!!",b,".normalized;");function wt(Rt){T(lt[Rt],"=",b,".",Rt,"|0;")}return wt("size"),wt("offset"),wt("stride"),wt("divisor"),T("}}"),T.exit("if(",lt.isStream,"){",ot,".destroyStream(",at,");","}"),lt}N[M]=tr(w,C)}),N}function pe(_){var f=_.static,S=_.dynamic,I={};return Object.keys(f).forEach(function(N){var M=f[N];I[N]=Ie(function(w,C){return typeof M=="number"||typeof M=="boolean"?""+M:w.link(M)})}),Object.keys(S).forEach(function(N){var M=S[N];I[N]=tr(M,function(w,C){return w.invoke(C,M)})}),I}function Re(_,f,S,I,N){var M=_.static,w=_.dynamic;m.optional(function(){var wt=[yi,wn,Mn,xi,gi,ms,_i,ps,Sn,Cn].concat(Ft);function Rt(Ot){Object.keys(Ot).forEach(function(Lt){m.command(wt.indexOf(Lt)>=0,'unknown parameter "'+Lt+'"',N.commandStr)})}Rt(M),Rt(w)});var C=jt(_,f),x=vt(_),T=kt(_,x,N),b=ye(_,N),O=xe(_,N),F=Zt(_,N,C);function $(wt){var Rt=T[wt];Rt&&(O[wt]=Rt)}$(Nr),$(It(ds));var ot=Object.keys(O).length>0,lt={framebuffer:x,draw:b,shader:F,state:O,dirty:ot,scopeVAO:null,drawVAO:null,useVAO:!1,attributes:{}};if(lt.profile=xt(_),lt.uniforms=Qt(S,N),lt.drawVAO=lt.scopeVAO=b.vao,!lt.drawVAO&&F.program&&!C&&E.angle_instanced_arrays&&b.static.elements){var gt=!0,at=F.program.attributes.map(function(wt){var Rt=f.static[wt];return gt=gt&&!!Rt,Rt});if(gt&&at.length>0){var Nt=it.getVAO(it.createVAO({attributes:at,elements:b.static.elements}));lt.drawVAO=new Pe(null,null,null,function(wt,Rt){return wt.link(Nt)}),lt.useVAO=!0}}return C?lt.useVAO=!0:lt.attributes=Ne(f,N),lt.context=pe(I),lt}function Le(_,f,S){var I=_.shared,N=I.context,M=_.scope();Object.keys(S).forEach(function(w){f.save(N,"."+w);var C=S[w],x=C.append(_,f);Array.isArray(x)?M(N,".",w,"=[",x.join(),"];"):M(N,".",w,"=",x,";")}),f(M)}function De(_,f,S,I){var N=_.shared,M=N.gl,w=N.framebuffer,C;At&&(C=f.def(N.extensions,".webgl_draw_buffers"));var x=_.constants,T=x.drawBuffer,b=x.backBuffer,O;S?O=S.append(_,f):O=f.def(w,".next"),I||f("if(",O,"!==",w,".cur){"),f("if(",O,"){",M,".bindFramebuffer(",Pc,",",O,".framebuffer);"),At&&f(C,".drawBuffersWEBGL(",T,"[",O,".colorAttachments.length]);"),f("}else{",M,".bindFramebuffer(",Pc,",null);"),At&&f(C,".drawBuffersWEBGL(",b,");"),f("}",w,".cur=",O,";"),I||f("}")}function ze(_,f,S){var I=_.shared,N=I.gl,M=_.current,w=_.next,C=I.current,x=I.next,T=_.cond(C,".dirty");Ft.forEach(function(b){var O=It(b);if(!(O in S.state)){var F,$;if(O in w){F=w[O],$=M[O];var ot=sr(bt[O].length,function(gt){return T.def(F,"[",gt,"]")});T(_.cond(ot.map(function(gt,at){return gt+"!=="+$+"["+at+"]"}).join("||")).then(N,".",W[O],"(",ot,");",ot.map(function(gt,at){return $+"["+at+"]="+gt}).join(";"),";"))}else{F=T.def(x,".",O);var lt=_.cond(F,"!==",C,".",O);T(lt),O in X?lt(_.cond(F).then(N,".enable(",X[O],");").else(N,".disable(",X[O],");"),C,".",O,"=",F,";"):lt(N,".",W[O],"(",F,");",C,".",O,"=",F,";")}}}),Object.keys(S.state).length===0&&T(C,".dirty=false;"),f(T)}function je(_,f,S,I){var N=_.shared,M=_.current,w=N.current,C=N.gl;zc(Object.keys(S)).forEach(function(x){var T=S[x];if(!(I&&!I(T))){var b=T.append(_,f);if(X[x]){var O=X[x];Jr(T)?b?f(C,".enable(",O,");"):f(C,".disable(",O,");"):f(_.cond(b).then(C,".enable(",O,");").else(C,".disable(",O,");")),f(w,".",x,"=",b,";")}else if(Ee(b)){var F=M[x];f(C,".",W[x],"(",b,");",b.map(function($,ot){return F+"["+ot+"]="+$}).join(";"),";")}else f(C,".",W[x],"(",b,");",w,".",x,"=",b,";")}})}function Ae(_,f){et&&(_.instancing=f.def(_.shared.extensions,".angle_instanced_arrays"))}function $t(_,f,S,I,N){var M=_.shared,w=_.stats,C=M.current,x=M.timer,T=S.profile;function b(){return typeof performance>"u"?"Date.now()":"performance.now()"}var O,F;function $(wt){O=f.def(),wt(O,"=",b(),";"),typeof N=="string"?wt(w,".count+=",N,";"):wt(w,".count++;"),Q&&(I?(F=f.def(),wt(F,"=",x,".getNumPendingQueries();")):wt(x,".beginQuery(",w,");"))}function ot(wt){wt(w,".cpuTime+=",b(),"-",O,";"),Q&&(I?wt(x,".pushScopeStats(",F,",",x,".getNumPendingQueries(),",w,");"):wt(x,".endQuery();"))}function lt(wt){var Rt=f.def(C,".profile");f(C,".profile=",wt,";"),f.exit(C,".profile=",Rt,";")}var gt;if(T){if(Jr(T)){T.enable?($(f),ot(f.exit),lt("true")):lt("false");return}gt=T.append(_,f),lt(gt)}else gt=f.def(C,".profile");var at=_.block();$(at),f("if(",gt,"){",at,"}");var Nt=_.block();ot(Nt),f.exit("if(",gt,"){",Nt,"}")}function He(_,f,S,I,N){var M=_.shared;function w(x){switch(x){case ys:case _s:case Es:return 2;case xs:case bs:case As:return 3;case gs:case vs:case Ts:return 4;default:return 1}}function C(x,T,b){var O=M.gl,F=f.def(x,".location"),$=f.def(M.attributes,"[",F,"]"),ot=b.state,lt=b.buffer,gt=[b.x,b.y,b.z,b.w],at=["buffer","normalized","offset","stride"];function Nt(){f("if(!",$,".buffer){",O,".enableVertexAttribArray(",F,");}");var Rt=b.type,Ot;if(b.size?Ot=f.def(b.size,"||",T):Ot=T,f("if(",$,".type!==",Rt,"||",$,".size!==",Ot,"||",at.map(function(zt){return $+"."+zt+"!=="+b[zt]}).join("||"),"){",O,".bindBuffer(",Wi,",",lt,".buffer);",O,".vertexAttribPointer(",[F,Ot,Rt,b.normalized,b.stride,b.offset],");",$,".type=",Rt,";",$,".size=",Ot,";",at.map(function(zt){return $+"."+zt+"="+b[zt]+";"}).join(""),"}"),et){var Lt=b.divisor;f("if(",$,".divisor!==",Lt,"){",_.instancing,".vertexAttribDivisorANGLE(",[F,Lt],");",$,".divisor=",Lt,";}")}}function wt(){f("if(",$,".buffer){",O,".disableVertexAttribArray(",F,");",$,".buffer=null;","}if(",Gi.map(function(Rt,Ot){return $+"."+Rt+"!=="+gt[Ot]}).join("||"),"){",O,".vertexAttrib4f(",F,",",gt,");",Gi.map(function(Rt,Ot){return $+"."+Rt+"="+gt[Ot]+";"}).join(""),"}")}ot===Vi?Nt():ot===Fa?wt():(f("if(",ot,"===",Vi,"){"),Nt(),f("}else{"),wt(),f("}"))}I.forEach(function(x){var T=x.name,b=S.attributes[T],O;if(b){if(!N(b))return;O=b.append(_,f)}else{if(!N(Uc))return;var F=_.scopeAttrib(T);m.optional(function(){_.assert(f,F+".state","missing attribute "+T)}),O={},Object.keys(new R).forEach(function($){O[$]=f.def(F,".",$)})}C(_.link(x),w(x.info.type),O)})}function oe(_,f,S,I,N,M){for(var w=_.shared,C=w.gl,x,T=0;T<I.length;++T){var b=I[T],O=b.name,F=b.info.type,$=S.uniforms[O],ot=_.link(b),lt=ot+".location",gt;if($){if(!N($))continue;if(Jr($)){var at=$.value;if(m.command(at!==null&&typeof at<"u",'missing uniform "'+O+'"',_.commandStr),F===Nn||F===Ln){m.command(typeof at=="function"&&(F===Nn&&(at._reglType==="texture2d"||at._reglType==="framebuffer")||F===Ln&&(at._reglType==="textureCube"||at._reglType==="framebufferCube")),"invalid texture for uniform "+O,_.commandStr);var Nt=_.link(at._texture||at.color[0]._texture);f(C,".uniform1i(",lt,",",Nt+".bind());"),f.exit(Nt,".unbind();")}else if(F===In||F===Rn||F===On){m.optional(function(){m.command(Ee(at),"invalid matrix for uniform "+O,_.commandStr),m.command(F===In&&at.length===4||F===Rn&&at.length===9||F===On&&at.length===16,"invalid length for matrix uniform "+O,_.commandStr)});var wt=_.global.def("new Float32Array(["+Array.prototype.slice.call(at)+"])"),Rt=2;F===Rn?Rt=3:F===On&&(Rt=4),f(C,".uniformMatrix",Rt,"fv(",lt,",false,",wt,");")}else{switch(F){case Ka:m.commandType(at,"number","uniform "+O,_.commandStr),x="1f";break;case ys:m.command(Ee(at)&&at.length===2,"uniform "+O,_.commandStr),x="2f";break;case xs:m.command(Ee(at)&&at.length===3,"uniform "+O,_.commandStr),x="3f";break;case gs:m.command(Ee(at)&&at.length===4,"uniform "+O,_.commandStr),x="4f";break;case to:m.commandType(at,"boolean","uniform "+O,_.commandStr),x="1i";break;case Qa:m.commandType(at,"number","uniform "+O,_.commandStr),x="1i";break;case Es:m.command(Ee(at)&&at.length===2,"uniform "+O,_.commandStr),x="2i";break;case _s:m.command(Ee(at)&&at.length===2,"uniform "+O,_.commandStr),x="2i";break;case As:m.command(Ee(at)&&at.length===3,"uniform "+O,_.commandStr),x="3i";break;case bs:m.command(Ee(at)&&at.length===3,"uniform "+O,_.commandStr),x="3i";break;case Ts:m.command(Ee(at)&&at.length===4,"uniform "+O,_.commandStr),x="4i";break;case vs:m.command(Ee(at)&&at.length===4,"uniform "+O,_.commandStr),x="4i";break}f(C,".uniform",x,"(",lt,",",Ee(at)?Array.prototype.slice.call(at):at,");")}continue}else gt=$.append(_,f)}else{if(!N(Uc))continue;gt=f.def(w.uniforms,"[",p.id(O),"]")}F===Nn?(m(!Array.isArray(gt),"must specify a scalar prop for textures"),f("if(",gt,"&&",gt,'._reglType==="framebuffer"){',gt,"=",gt,".color[0];","}")):F===Ln&&(m(!Array.isArray(gt),"must specify a scalar prop for cube maps"),f("if(",gt,"&&",gt,'._reglType==="framebufferCube"){',gt,"=",gt,".color[0];","}")),m.optional(function(){function Xe(xr,Xc){_.assert(f,xr,'bad data or missing for uniform "'+O+'".  '+Xc)}function Cr(xr){m(!Array.isArray(gt),"must not specify an array type for uniform"),Xe("typeof "+gt+'==="'+xr+'"',"invalid type, expected "+xr)}function ur(xr,Xc){Array.isArray(gt)?m(gt.length===xr,"must have length "+xr):Xe(w.isArrayLike+"("+gt+")&&"+gt+".length==="+xr,"invalid vector, should have length "+xr,_.commandStr)}function Yc(xr){m(!Array.isArray(gt),"must not specify a value type"),Xe("typeof "+gt+'==="function"&&'+gt+'._reglType==="texture'+(xr===Oc?"2d":"Cube")+'"',"invalid texture type",_.commandStr)}switch(F){case Qa:Cr("number");break;case _s:ur(2);break;case bs:ur(3);break;case vs:ur(4);break;case Ka:Cr("number");break;case ys:ur(2);break;case xs:ur(3);break;case gs:ur(4);break;case to:Cr("boolean");break;case Es:ur(2);break;case As:ur(3);break;case Ts:ur(4);break;case In:ur(4);break;case Rn:ur(9);break;case On:ur(16);break;case Nn:Yc(Oc);break;case Ln:Yc(tp);break}});var Ot=1;switch(F){case Nn:case Ln:var Lt=f.def(gt,"._texture");f(C,".uniform1i(",lt,",",Lt,".bind());"),f.exit(Lt,".unbind();");continue;case Qa:case to:x="1i";break;case _s:case Es:x="2i",Ot=2;break;case bs:case As:x="3i",Ot=3;break;case vs:case Ts:x="4i",Ot=4;break;case Ka:x="1f";break;case ys:x="2f",Ot=2;break;case xs:x="3f",Ot=3;break;case gs:x="4f",Ot=4;break;case In:x="Matrix2fv";break;case Rn:x="Matrix3fv";break;case On:x="Matrix4fv";break}if(x.charAt(0)==="M"){f(C,".uniform",x,"(",lt,",");var zt=Math.pow(F-In+2,2),fe=_.global.def("new Float32Array(",zt,")");Array.isArray(gt)?f("false,(",sr(zt,function(Xe){return fe+"["+Xe+"]="+gt[Xe]}),",",fe,")"):f("false,(Array.isArray(",gt,")||",gt," instanceof Float32Array)?",gt,":(",sr(zt,function(Xe){return fe+"["+Xe+"]="+gt+"["+Xe+"]"}),",",fe,")"),f(");")}else if(Ot>1){for(var Ue=[],Lr=[],Dr=0;Dr<Ot;++Dr)Array.isArray(gt)?Lr.push(gt[Dr]):Lr.push(f.def(gt+"["+Dr+"]")),M&&Ue.push(f.def());M&&f("if(!",_.batchId,"||",Ue.map(function(Xe,Cr){return Xe+"!=="+Lr[Cr]}).join("||"),"){",Ue.map(function(Xe,Cr){return Xe+"="+Lr[Cr]+";"}).join("")),f(C,".uniform",x,"(",lt,",",Lr.join(","),");"),M&&f("}")}else{if(m(!Array.isArray(gt),"uniform value must not be an array"),M){var Fr=f.def();f("if(!",_.batchId,"||",Fr,"!==",gt,"){",Fr,"=",gt,";")}f(C,".uniform",x,"(",lt,",",gt,");"),M&&f("}")}}}function Bt(_,f,S,I){var N=_.shared,M=N.gl,w=N.draw,C=I.draw;function x(){var Ot=C.elements,Lt,zt=f;return Ot?((Ot.contextDep&&I.contextDynamic||Ot.propDep)&&(zt=S),Lt=Ot.append(_,zt),C.elementsActive&&zt("if("+Lt+")"+M+".bindBuffer("+Za+","+Lt+".buffer.buffer);")):(Lt=zt.def(),zt(Lt,"=",w,".",xi,";","if(",Lt,"){",M,".bindBuffer(",Za,",",Lt,".buffer.buffer);}","else if(",N.vao,".currentVAO){",Lt,"=",_.shared.elements+".getElements("+N.vao,".currentVAO.elements);",q?"":"if("+Lt+")"+M+".bindBuffer("+Za+","+Lt+".buffer.buffer);","}")),Lt}function T(){var Ot=C.count,Lt,zt=f;return Ot?((Ot.contextDep&&I.contextDynamic||Ot.propDep)&&(zt=S),Lt=Ot.append(_,zt),m.optional(function(){Ot.MISSING&&_.assert(f,"false","missing vertex count"),Ot.DYNAMIC&&_.assert(zt,Lt+">=0","missing vertex count")})):(Lt=zt.def(w,".",_i),m.optional(function(){_.assert(zt,Lt+">=0","missing vertex count")})),Lt}var b=x();function O(Ot){var Lt=C[Ot];return Lt?Lt.contextDep&&I.contextDynamic||Lt.propDep?Lt.append(_,S):Lt.append(_,f):f.def(w,".",Ot)}var F=O(gi),$=O(ms),ot=T();if(typeof ot=="number"){if(ot===0)return}else S("if(",ot,"){"),S.exit("}");var lt,gt;et&&(lt=O(ps),gt=_.instancing);var at=b+".type",Nt=C.elements&&Jr(C.elements)&&!C.vaoActive;function wt(){function Ot(){S(gt,".drawElementsInstancedANGLE(",[F,ot,at,$+"<<(("+at+"-"+hc+")>>1)",lt],");")}function Lt(){S(gt,".drawArraysInstancedANGLE(",[F,$,ot,lt],");")}b&&b!=="null"?Nt?Ot():(S("if(",b,"){"),Ot(),S("}else{"),Lt(),S("}")):Lt()}function Rt(){function Ot(){S(M+".drawElements("+[F,ot,at,$+"<<(("+at+"-"+hc+")>>1)"]+");")}function Lt(){S(M+".drawArrays("+[F,$,ot]+");")}b&&b!=="null"?Nt?Ot():(S("if(",b,"){"),Ot(),S("}else{"),Lt(),S("}")):Lt()}et&&(typeof lt!="number"||lt>=0)?typeof lt=="string"?(S("if(",lt,">0){"),wt(),S("}else if(",lt,"<0){"),Rt(),S("}")):wt():Rt()}function Kt(_,f,S,I,N){var M=Vt(),w=M.proc("body",N);return m.optional(function(){M.commandStr=f.commandStr,M.command=M.link(f.commandStr)}),et&&(M.instancing=w.def(M.shared.extensions,".angle_instanced_arrays")),_(M,w,S,I),M.compile().body}function ie(_,f,S,I){Ae(_,f),S.useVAO?S.drawVAO?f(_.shared.vao,".setVAO(",S.drawVAO.append(_,f),");"):f(_.shared.vao,".setVAO(",_.shared.vao,".targetVAO);"):(f(_.shared.vao,".setVAO(null);"),He(_,f,S,I.attributes,function(){return!0})),oe(_,f,S,I.uniforms,function(){return!0},!1),Bt(_,f,f,S)}function Te(_,f){var S=_.proc("draw",1);Ae(_,S),Le(_,S,f.context),De(_,S,f.framebuffer),ze(_,S,f),je(_,S,f.state),$t(_,S,f,!1,!0);var I=f.shader.progVar.append(_,S);if(S(_.shared.gl,".useProgram(",I,".program);"),f.shader.program)ie(_,S,f,f.shader.program);else{S(_.shared.vao,".setVAO(null);");var N=_.global.def("{}"),M=S.def(I,".id"),w=S.def(N,"[",M,"]");S(_.cond(w).then(w,".call(this,a0);").else(w,"=",N,"[",M,"]=",_.link(function(C){return Kt(ie,_,f,C,1)}),"(",I,");",w,".call(this,a0);"))}Object.keys(f.state).length>0&&S(_.shared.current,".dirty=true;"),_.shared.vao&&S(_.shared.vao,".setVAO(null);")}function Mr(_,f,S,I){_.batchId="a1",Ae(_,f);function N(){return!0}He(_,f,S,I.attributes,N),oe(_,f,S,I.uniforms,N,!1),Bt(_,f,f,S)}function vi(_,f,S,I){Ae(_,f);var N=S.contextDep,M=f.def(),w="a0",C="a1",x=f.def();_.shared.props=x,_.batchId=M;var T=_.scope(),b=_.scope();f(T.entry,"for(",M,"=0;",M,"<",C,";++",M,"){",x,"=",w,"[",M,"];",b,"}",T.exit);function O(at){return at.contextDep&&N||at.propDep}function F(at){return!O(at)}if(S.needsContext&&Le(_,b,S.context),S.needsFramebuffer&&De(_,b,S.framebuffer),je(_,b,S.state,O),S.profile&&O(S.profile)&&$t(_,b,S,!1,!0),I)S.useVAO?S.drawVAO?O(S.drawVAO)?b(_.shared.vao,".setVAO(",S.drawVAO.append(_,b),");"):T(_.shared.vao,".setVAO(",S.drawVAO.append(_,T),");"):T(_.shared.vao,".setVAO(",_.shared.vao,".targetVAO);"):(T(_.shared.vao,".setVAO(null);"),He(_,T,S,I.attributes,F),He(_,b,S,I.attributes,O)),oe(_,T,S,I.uniforms,F,!1),oe(_,b,S,I.uniforms,O,!0),Bt(_,T,b,S);else{var $=_.global.def("{}"),ot=S.shader.progVar.append(_,b),lt=b.def(ot,".id"),gt=b.def($,"[",lt,"]");b(_.shared.gl,".useProgram(",ot,".program);","if(!",gt,"){",gt,"=",$,"[",lt,"]=",_.link(function(at){return Kt(Mr,_,S,at,2)}),"(",ot,");}",gt,".call(this,a0[",M,"],",M,");")}}function v(_,f){var S=_.proc("batch",2);_.batchId="0",Ae(_,S);var I=!1,N=!0;Object.keys(f.context).forEach(function($){I=I||f.context[$].propDep}),I||(Le(_,S,f.context),N=!1);var M=f.framebuffer,w=!1;M?(M.propDep?I=w=!0:M.contextDep&&I&&(w=!0),w||De(_,S,M)):De(_,S,null),f.state.viewport&&f.state.viewport.propDep&&(I=!0);function C($){return $.contextDep&&I||$.propDep}ze(_,S,f),je(_,S,f.state,function($){return!C($)}),(!f.profile||!C(f.profile))&&$t(_,S,f,!1,"a1"),f.contextDep=I,f.needsContext=N,f.needsFramebuffer=w;var x=f.shader.progVar;if(x.contextDep&&I||x.propDep)vi(_,S,f,null);else{var T=x.append(_,S);if(S(_.shared.gl,".useProgram(",T,".program);"),f.shader.program)vi(_,S,f,f.shader.program);else{S(_.shared.vao,".setVAO(null);");var b=_.global.def("{}"),O=S.def(T,".id"),F=S.def(b,"[",O,"]");S(_.cond(F).then(F,".call(this,a0,a1);").else(F,"=",b,"[",O,"]=",_.link(function($){return Kt(vi,_,f,$,2)}),"(",T,");",F,".call(this,a0,a1);"))}}Object.keys(f.state).length>0&&S(_.shared.current,".dirty=true;"),_.shared.vao&&S(_.shared.vao,".setVAO(null);")}function z(_,f){var S=_.proc("scope",3);_.batchId="a2";var I=_.shared,N=I.current;Le(_,S,f.context),f.framebuffer&&f.framebuffer.append(_,S),zc(Object.keys(f.state)).forEach(function(w){var C=f.state[w],x=C.append(_,S);Ee(x)?x.forEach(function(T,b){S.set(_.next[w],"["+b+"]",T)}):S.set(I.next,"."+w,x)}),$t(_,S,f,!0,!0),[xi,ms,_i,ps,gi].forEach(function(w){var C=f.draw[w];C&&S.set(I.draw,"."+w,""+C.append(_,S))}),Object.keys(f.uniforms).forEach(function(w){var C=f.uniforms[w].append(_,S);Array.isArray(C)&&(C="["+C.join()+"]"),S.set(I.uniforms,"["+p.id(w)+"]",C)}),Object.keys(f.attributes).forEach(function(w){var C=f.attributes[w].append(_,S),x=_.scopeAttrib(w);Object.keys(new R).forEach(function(T){S.set(x,"."+T,C[T])})}),f.scopeVAO&&S.set(I.vao,".targetVAO",f.scopeVAO.append(_,S));function M(w){var C=f.shader[w];C&&S.set(I.shader,"."+w,C.append(_,S))}M(wn),M(Mn),Object.keys(f.state).length>0&&(S(N,".dirty=true;"),S.exit(N,".dirty=true;")),S("a1(",_.shared.context,",a0,",_.batchId,");")}function P(_){if(!(typeof _!="object"||Ee(_))){for(var f=Object.keys(_),S=0;S<f.length;++S)if(nr.isDynamic(_[f[S]]))return!0;return!1}}function Ct(_,f,S){var I=f.static[S];if(!I||!P(I))return;var N=_.global,M=Object.keys(I),w=!1,C=!1,x=!1,T=_.global.def("{}");M.forEach(function(O){var F=I[O];if(nr.isDynamic(F)){typeof F=="function"&&(F=I[O]=nr.unbox(F));var $=tr(F,null);w=w||$.thisDep,x=x||$.propDep,C=C||$.contextDep}else{switch(N(T,".",O,"="),typeof F){case"number":N(F);break;case"string":N('"',F,'"');break;case"object":Array.isArray(F)&&N("[",F.join(),"]");break;default:N(_.link(F));break}N(";")}});function b(O,F){M.forEach(function($){var ot=I[$];if(nr.isDynamic(ot)){var lt=O.invoke(F,ot);F(T,".",$,"=",lt,";")}})}f.dynamic[S]=new nr.DynamicVariable(fs,{thisDep:w,contextDep:C,propDep:x,ref:T,append:b}),delete f.static[S]}function Jt(_,f,S,I,N){var M=Vt();M.stats=M.link(N),Object.keys(f.static).forEach(function(C){Ct(M,f,C)}),Zm.forEach(function(C){Ct(M,_,C)});var w=Re(_,f,S,I,M);return Te(M,w),z(M,w),v(M,w),r(M.compile(),{destroy:function(){w.shader.program.destroy()}})}return{next:yt,current:bt,procs:(function(){var _=Vt(),f=_.proc("poll"),S=_.proc("refresh"),I=_.block();f(I),S(I);var N=_.shared,M=N.gl,w=N.next,C=N.current;I(C,".dirty=false;"),De(_,f),De(_,S,null,!0);var x;et&&(x=_.link(et)),E.oes_vertex_array_object&&S(_.link(E.oes_vertex_array_object),".bindVertexArrayOES(null);");for(var T=0;T<k.maxAttributes;++T){var b=S.def(N.attributes,"[",T,"]"),O=_.cond(b,".buffer");O.then(M,".enableVertexAttribArray(",T,");",M,".bindBuffer(",Wi,",",b,".buffer.buffer);",M,".vertexAttribPointer(",T,",",b,".size,",b,".type,",b,".normalized,",b,".stride,",b,".offset);").else(M,".disableVertexAttribArray(",T,");",M,".vertexAttrib4f(",T,",",b,".x,",b,".y,",b,".z,",b,".w);",b,".buffer=null;"),S(O),et&&S(x,".vertexAttribDivisorANGLE(",T,",",b,".divisor);")}return S(_.shared.vao,".currentVAO=null;",_.shared.vao,".setVAO(",_.shared.vao,".targetVAO);"),Object.keys(X).forEach(function(F){var $=X[F],ot=I.def(w,".",F),lt=_.block();lt("if(",ot,"){",M,".enable(",$,")}else{",M,".disable(",$,")}",C,".",F,"=",ot,";"),S(lt),f("if(",ot,"!==",C,".",F,"){",lt,"}")}),Object.keys(W).forEach(function(F){var $=W[F],ot=bt[F],lt,gt,at=_.block();if(at(M,".",$,"("),Ee(ot)){var Nt=ot.length;lt=_.global.def(w,".",F),gt=_.global.def(C,".",F),at(sr(Nt,function(wt){return lt+"["+wt+"]"}),");",sr(Nt,function(wt){return gt+"["+wt+"]="+lt+"["+wt+"];"}).join("")),f("if(",sr(Nt,function(wt){return lt+"["+wt+"]!=="+gt+"["+wt+"]"}).join("||"),"){",at,"}")}else lt=I.def(w,".",F),gt=I.def(C,".",F),at(lt,");",C,".",F,"=",lt,";"),f("if(",lt,"!==",gt,"){",at,"}");S(at)}),_.compile()})(),compile:Jt}}function yp(){return{vaoCount:0,bufferCount:0,elementsCount:0,framebufferCount:0,shaderCount:0,textureCount:0,cubeCount:0,renderbufferCount:0,maxTextureUnits:0}}var xp=34918,gp=34919,Gc=35007,_p=function(l,p){if(!p.ext_disjoint_timer_query)return null;var E=[];function k(){return E.pop()||p.ext_disjoint_timer_query.createQueryEXT()}function Y(et){E.push(et)}var B=[];function j(et){var At=k();p.ext_disjoint_timer_query.beginQueryEXT(Gc,At),B.push(At),Q(B.length-1,B.length,et)}function K(){p.ext_disjoint_timer_query.endQueryEXT(Gc)}function J(){this.startQueryIndex=-1,this.endQueryIndex=-1,this.sum=0,this.stats=null}var it=[];function st(){return it.pop()||new J}function nt(et){it.push(et)}var ht=[];function Q(et,At,q){var bt=st();bt.startQueryIndex=et,bt.endQueryIndex=At,bt.sum=0,bt.stats=q,ht.push(bt)}var rt=[],R=[];function G(){var et,At,q=B.length;if(q!==0){R.length=Math.max(R.length,q+1),rt.length=Math.max(rt.length,q+1),rt[0]=0,R[0]=0;var bt=0;for(et=0,At=0;At<B.length;++At){var yt=B[At];p.ext_disjoint_timer_query.getQueryObjectEXT(yt,gp)?(bt+=p.ext_disjoint_timer_query.getQueryObjectEXT(yt,xp),Y(yt)):B[et++]=yt,rt[At+1]=bt,R[At+1]=et}for(B.length=et,et=0,At=0;At<ht.length;++At){var Ft=ht[At],X=Ft.startQueryIndex,W=Ft.endQueryIndex;Ft.sum+=rt[W]-rt[X];var It=R[X],ut=R[W];ut===It?(Ft.stats.gpuTime+=Ft.sum/1e6,nt(Ft)):(Ft.startQueryIndex=It,Ft.endQueryIndex=ut,ht[et++]=Ft)}ht.length=et}}return{beginQuery:j,endQuery:K,pushScopeStats:Q,update:G,getNumPendingQueries:function(){return B.length},clear:function(){E.push.apply(E,B);for(var et=0;et<E.length;et++)p.ext_disjoint_timer_query.deleteQueryEXT(E[et]);B.length=0,E.length=0},restore:function(){B.length=0,E.length=0}}},bp=16384,vp=256,Ep=1024,Ap=34962,Vc="webglcontextlost",jc="webglcontextrestored",Hc=1,Tp=2,Sp=3;function Wc(l,p){for(var E=0;E<l.length;++E)if(l[E]===p)return E;return-1}function wp(l){var p=Tf(l);if(!p)return null;var E=p.gl,k=E.getContextAttributes(),Y=E.isContextLost(),B=Sf(E,p);if(!B)return null;var j=_f(),K=yp(),J=B.extensions,it=_p(E,J),st=Qo(),nt=E.drawingBufferWidth,ht=E.drawingBufferHeight,Q={tick:0,time:0,viewportWidth:nt,viewportHeight:ht,framebufferWidth:nt,framebufferHeight:ht,drawingBufferWidth:nt,drawingBufferHeight:ht,pixelRatio:p.pixelRatio},rt={},R={elements:null,primitive:4,count:-1,offset:0,instances:-1},G=fd(E,J),et=Cd(E,K,p,bt),At=Ud(E,J,et,K),q=Um(E,J,G,K,et,At,R);function bt(Bt){return q.destroyBuffer(Bt)}var yt=Hm(E,j,K,p),Ft=xm(E,J,G,function(){It.procs.poll()},Q,K,p),X=gm(E,J,G,K,p),W=km(E,J,G,Ft,X,K),It=pp(E,j,J,G,et,At,Ft,W,rt,q,yt,R,Q,it,p),ut=Xm(E,W,It.procs.poll,Q,k,J,G),tt=It.next,mt=E.canvas,pt=[],Wt=[],Vt=[],xt=[p.onDestroy],vt=null;function kt(){if(pt.length===0){it&&it.update(),vt=null;return}vt=oa.next(kt),je();for(var Bt=pt.length-1;Bt>=0;--Bt){var Kt=pt[Bt];Kt&&Kt(Q,null,0)}E.flush(),it&&it.update()}function jt(){!vt&&pt.length>0&&(vt=oa.next(kt))}function Zt(){vt&&(oa.cancel(kt),vt=null)}function ye(Bt){Bt.preventDefault(),Y=!0,Zt(),Wt.forEach(function(Kt){Kt()})}function xe(Bt){E.getError(),Y=!1,B.restore(),yt.restore(),et.restore(),Ft.restore(),X.restore(),W.restore(),q.restore(),it&&it.restore(),It.procs.refresh(),jt(),Vt.forEach(function(Kt){Kt()})}mt&&(mt.addEventListener(Vc,ye,!1),mt.addEventListener(jc,xe,!1));function Qt(){pt.length=0,Zt(),mt&&(mt.removeEventListener(Vc,ye),mt.removeEventListener(jc,xe)),yt.clear(),W.clear(),X.clear(),q.clear(),Ft.clear(),At.clear(),et.clear(),it&&it.clear(),xt.forEach(function(Bt){Bt()})}function Ne(Bt){m(!!Bt,"invalid args to regl({...})"),m.type(Bt,"object","invalid args to regl({...})");function Kt(N){var M=r({},N);delete M.uniforms,delete M.attributes,delete M.context,delete M.vao,"stencil"in M&&M.stencil.op&&(M.stencil.opBack=M.stencil.opFront=M.stencil.op,delete M.stencil.op);function w(C){if(C in M){var x=M[C];delete M[C],Object.keys(x).forEach(function(T){M[C+"."+T]=x[T]})}}return w("blend"),w("depth"),w("cull"),w("stencil"),w("polygonOffset"),w("scissor"),w("sample"),"vao"in N&&(M.vao=N.vao),M}function ie(N,M){var w={},C={};return Object.keys(N).forEach(function(x){var T=N[x];if(nr.isDynamic(T)){C[x]=nr.unbox(T,x);return}else if(M&&Array.isArray(T)){for(var b=0;b<T.length;++b)if(nr.isDynamic(T[b])){C[x]=nr.unbox(T,x);return}}w[x]=T}),{dynamic:C,static:w}}var Te=ie(Bt.context||{},!0),Mr=ie(Bt.uniforms||{},!0),vi=ie(Bt.attributes||{},!1),v=ie(Kt(Bt),!1),z={gpuTime:0,cpuTime:0,count:0},P=It.compile(v,vi,Mr,Te,z),Ct=P.draw,Jt=P.batch,_=P.scope,f=[];function S(N){for(;f.length<N;)f.push(null);return f}function I(N,M){var w;if(Y&&m.raise("context lost"),typeof N=="function")return _.call(this,null,N,0);if(typeof M=="function")if(typeof N=="number")for(w=0;w<N;++w)_.call(this,null,M,w);else if(Array.isArray(N))for(w=0;w<N.length;++w)_.call(this,N[w],M,w);else return _.call(this,N,M,0);else if(typeof N=="number"){if(N>0)return Jt.call(this,S(N|0),N|0)}else if(Array.isArray(N)){if(N.length)return Jt.call(this,N,N.length)}else return Ct.call(this,N)}return r(I,{stats:z,destroy:function(){P.destroy()}})}var pe=W.setFBO=Ne({framebuffer:nr.define.call(null,Hc,"framebuffer")});function Re(Bt,Kt){var ie=0;It.procs.poll();var Te=Kt.color;Te&&(E.clearColor(+Te[0]||0,+Te[1]||0,+Te[2]||0,+Te[3]||0),ie|=bp),"depth"in Kt&&(E.clearDepth(+Kt.depth),ie|=vp),"stencil"in Kt&&(E.clearStencil(Kt.stencil|0),ie|=Ep),m(!!ie,"called regl.clear with no buffer specified"),E.clear(ie)}function Le(Bt){if(m(typeof Bt=="object"&&Bt,"regl.clear() takes an object as input"),"framebuffer"in Bt)if(Bt.framebuffer&&Bt.framebuffer_reglType==="framebufferCube")for(var Kt=0;Kt<6;++Kt)pe(r({framebuffer:Bt.framebuffer.faces[Kt]},Bt),Re);else pe(Bt,Re);else Re(null,Bt)}function De(Bt){m.type(Bt,"function","regl.frame() callback must be a function"),pt.push(Bt);function Kt(){var ie=Wc(pt,Bt);m(ie>=0,"cannot cancel a frame twice");function Te(){var Mr=Wc(pt,Te);pt[Mr]=pt[pt.length-1],pt.length-=1,pt.length<=0&&Zt()}pt[ie]=Te}return jt(),{cancel:Kt}}function ze(){var Bt=tt.viewport,Kt=tt.scissor_box;Bt[0]=Bt[1]=Kt[0]=Kt[1]=0,Q.viewportWidth=Q.framebufferWidth=Q.drawingBufferWidth=Bt[2]=Kt[2]=E.drawingBufferWidth,Q.viewportHeight=Q.framebufferHeight=Q.drawingBufferHeight=Bt[3]=Kt[3]=E.drawingBufferHeight}function je(){Q.tick+=1,Q.time=$t(),ze(),It.procs.poll()}function Ae(){Ft.refresh(),ze(),It.procs.refresh(),it&&it.update()}function $t(){return(Qo()-st)/1e3}Ae();function He(Bt,Kt){m.type(Kt,"function","listener callback must be a function");var ie;switch(Bt){case"frame":return De(Kt);case"lost":ie=Wt;break;case"restore":ie=Vt;break;case"destroy":ie=xt;break;default:m.raise("invalid event, must be one of frame,lost,restore,destroy")}return ie.push(Kt),{cancel:function(){for(var Te=0;Te<ie.length;++Te)if(ie[Te]===Kt){ie[Te]=ie[ie.length-1],ie.pop();return}}}}var oe=r(Ne,{clear:Le,prop:nr.define.bind(null,Hc),context:nr.define.bind(null,Tp),this:nr.define.bind(null,Sp),draw:Ne({}),buffer:function(Bt){return et.create(Bt,Ap,!1,!1)},elements:function(Bt){return At.create(Bt,!1)},texture:Ft.create2D,cube:Ft.createCube,renderbuffer:X.create,framebuffer:W.create,framebufferCube:W.createCube,vao:q.createVAO,attributes:k,frame:De,on:He,limits:G,hasExtension:function(Bt){return G.extensions.indexOf(Bt.toLowerCase())>=0},read:ut,destroy:Qt,_gl:E,_refresh:Ae,poll:function(){je(),it&&it.update()},now:$t,stats:K});return p.onDone(null,oe),oe}return wp}))})(Ks)),Ks.exports}var wx=Sx();const Mx=Ip(wx),Cx=({audioFeatures:s})=>{const t=re.useRef(null),e=re.useRef(null),r=re.useRef(null),i=re.useRef(null),[n,a]=re.useState(0),o=re.useRef(n);re.useEffect(()=>{if(t.current){const h=Mx(t.current);e.current=h;const u=h.buffer({usage:"dynamic"});i.current=u,r.current=h({vert:`
          precision mediump float;
          attribute vec2 position;
          void main() {
            // Position is already in clip space coordinates
            gl_Position = vec4(position, 0, 1);
          }`,frag:`
          precision mediump float;
          uniform vec4 color;
          void main() {
            gl_FragColor = color;
          }`,attributes:{position:u},uniforms:{color:[0,.8,.8,.7]},count:h.prop("count"),primitive:"line strip"});const d=h.frame(()=>{var g;h.clear({color:[0,0,0,0],depth:1});const y=o.current;y>0&&((g=r.current)==null||g.call(r,{count:y}))});return()=>{d.cancel(),h.destroy()}}},[]),re.useEffect(()=>{if(s!=null&&s.frameAnalyses&&s.frameAnalyses.length>0){const h=s.frameAnalyses,u=s.duration,d=h.flatMap(y=>{const g=y.timestamp/u*2-1,A=(y.energy*2-1)*.5;return[g,A]});if(i.current){i.current(d);const y=d.length/2;o.current=y,a(y)}}else a(0)},[s]);const c={position:"absolute",top:0,left:0,width:"100%",height:"100%",pointerEvents:"none",zIndex:30};return re.useEffect(()=>{const h=()=>{t.current&&(t.current.width=t.current.clientWidth,t.current.height=t.current.clientHeight)};return h(),window.addEventListener("resize",h),()=>window.removeEventListener("resize",h)},[]),U.jsx("canvas",{ref:t,style:c})};var Hu={};function Ix(s,t){if(!t)throw new Error(`Missing required environment variable: ${s}. Please check your .env file.`);return t}function Rx(s,t,e=!1){return t?t.toLowerCase()==="true":e}function si(s){try{if(typeof process<"u"&&Hu){const t=Hu[s];if(typeof t<"u"&&t!==null&&t!=="")return String(t)}}catch{}try{const t=globalThis.__import_meta_env__;if(t&&typeof t[s]<"u"&&t[s]!==null&&t[s]!=="")return String(t[s])}catch{}}const Ox={development:{NODE_ENV:"development",VITE_BACKEND_URL:"http://localhost:8000",VITE_DEV_PORT:"5173",VITE_PROD_URL:"http://localhost:5173",VITE_DEBUG:"true"},production:{NODE_ENV:"production",VITE_BACKEND_URL:si("VITE_BACKEND_URL")||"https://your-production-backend.com",VITE_DEV_PORT:"5173",VITE_PROD_URL:si("VITE_PROD_URL")||"https://your-production-frontend.com",VITE_DEBUG:"false"},test:{NODE_ENV:"test",VITE_BACKEND_URL:"http://localhost:8000",VITE_DEV_PORT:"5173",VITE_PROD_URL:"http://localhost:5173",VITE_DEBUG:"false"}};function Nx(){const t=si("NODE_ENV")||si("MODE")||"development";return["development","production","test"].includes(t)?t:(console.warn(`Unknown environment "${t}", defaulting to development`),"development")}function Lx(){const s=Nx(),t=Ox[s];return{NODE_ENV:s,VITE_BACKEND_URL:Ix("VITE_BACKEND_URL",si("VITE_BACKEND_URL")||t.VITE_BACKEND_URL),VITE_DEV_PORT:si("VITE_DEV_PORT")||t.VITE_DEV_PORT,VITE_PROD_URL:si("VITE_PROD_URL")||t.VITE_PROD_URL,VITE_DEBUG:si("VITE_DEBUG")||t.VITE_DEBUG}}const wi=Lx(),ff=()=>wi.NODE_ENV==="development",df=()=>Rx("VITE_DEBUG",wi.VITE_DEBUG,!1);ff()&&df()&&console.log("[Environment Config]",{environment:wi.NODE_ENV,backendUrl:wi.VITE_BACKEND_URL,devPort:wi.VITE_DEV_PORT,prodUrl:wi.VITE_PROD_URL,debug:wi.VITE_DEBUG});const Ir={curlStrength:.12,noiseScale:2,noiseSpeed:.12},Fo="audiorailrider:dev:curlParams",Po="audiorailrider:dev:visible",Dx=()=>{if(!ff()||!df())return null;const t=(()=>{try{const Z=localStorage.getItem(Fo);if(Z)return JSON.parse(Z)}catch{}return Ir})(),[e,r]=re.useState(t.curlStrength??Ir.curlStrength),[i,n]=re.useState(t.noiseScale??Ir.noiseScale),[a,o]=re.useState(t.noiseSpeed??Ir.noiseSpeed),[c,h]=re.useState(()=>{try{return localStorage.getItem(Po)==="1"}catch{return!0}}),[u,d]=re.useState(null),[y,g]=re.useState({}),[A,D]=re.useState({}),{addToast:H}=(()=>{try{return Op()}catch{return{addToast:_t=>{}}}})(),V="audiorailrider:dev:presets",Tt="audiorailrider:dev:trackSettings",ft={placeUnderCamera:!0,verticalOffset:.55,defaultOpacity:.92,insideOpacity:.28,opacityLerpSpeed:6,trackRadius:.35},Mt=(()=>{try{const Z=localStorage.getItem(Tt);if(Z)return JSON.parse(Z)}catch{}return ft})(),[Dt,Et]=re.useState(Mt.placeUnderCamera??ft.placeUnderCamera),[St,Xt]=re.useState(Mt.verticalOffset??ft.verticalOffset),[Ht,se]=re.useState(Mt.defaultOpacity??ft.defaultOpacity),[Ut,Yt]=re.useState(Mt.insideOpacity??ft.insideOpacity),[ae,me]=re.useState(Mt.opacityLerpSpeed??ft.opacityLerpSpeed),[ce,Me]=re.useState(Mt.trackRadius??ft.trackRadius),[ge,ee]=re.useState(!1),[Gt,te]=re.useState(()=>{try{return JSON.parse(localStorage.getItem(V)||"[]")}catch{return[]}});re.useEffect(()=>{(()=>{window.dispatchEvent(new CustomEvent("audiorailrider:dev:setCurlParams",{detail:{curlStrength:e,noiseScale:i,noiseSpeed:a}}))})();const _t=dt=>{if(dt.ctrlKey&&dt.shiftKey&&dt.key.toLowerCase()==="d"&&h(Pt=>{const _e=!Pt;try{localStorage.setItem(Po,_e?"1":"0")}catch{}return _e}),dt.key==="Escape"){h(!1);try{localStorage.setItem(Po,"0")}catch{}}};return window.addEventListener("keydown",_t),()=>window.removeEventListener("keydown",_t)},[]),re.useEffect(()=>{const Z={placeUnderCamera:Dt,verticalOffset:St,defaultOpacity:Ht,insideOpacity:Ut,opacityLerpSpeed:ae,trackRadius:ce};try{localStorage.setItem(Tt,JSON.stringify(Z))}catch{}window.dispatchEvent(new CustomEvent("audiorailrider:dev:setTrackSettings",{detail:Z}))},[Dt,St,Ht,Ut,ae,ce]),re.useEffect(()=>{window.dispatchEvent(new CustomEvent("audiorailrider:dev:forceTrackInside",{detail:{force:ge}}))},[ge]),re.useEffect(()=>{const Z={curlStrength:e,noiseScale:i,noiseSpeed:a};try{localStorage.setItem(Fo,JSON.stringify(Z))}catch{}window.dispatchEvent(new CustomEvent("audiorailrider:dev:setCurlParams",{detail:Z}))},[e,i,a]);let qt=window.__audiorailrider_uniforms_manifest_promise||null;qt||(qt=(async()=>{try{const Z=await fetch("/shaders/shader-uniforms.json");return Z.ok?await Z.json():null}catch{return null}})(),window.__audiorailrider_uniforms_manifest_promise=qt),re.useEffect(()=>{let Z=!0;return(async()=>{const _t=await qt;if(!Z||!_t)return;d(_t);const dt={};for(const _e of Object.keys(_t))for(const m of _t[_e])dt[m.name]=m;D(dt);const Pt={};for(const _e of Object.keys(_t))for(const m of _t[_e])m.default!==void 0?Pt[m.name]=m.default:m.control==="checkbox"?Pt[m.name]=!!m.default:m.min!==void 0?Pt[m.name]=m.min:Pt[m.name]=typeof m.default<"u"?m.default:0;g(Pt)})(),()=>{Z=!1}},[]);const he=()=>{r(Ir.curlStrength),n(Ir.noiseScale),o(Ir.noiseSpeed);try{localStorage.removeItem(Fo)}catch{}},ue=async()=>{try{const Z=await fetch("/shaders/shader-uniforms.json");if(!Z.ok)return;const _t=await Z.json();console.log("Loaded shader manifest",_t),d(_t),window.dispatchEvent(new CustomEvent("audiorailrider:dev:loadUniformsManifest",{detail:{manifest:_t}}))}catch(Z){console.error(Z)}},ve=()=>{window.dispatchEvent(new CustomEvent("audiorailrider:dev:applyUniform",{detail:{name:"curlStrength",value:Ir.curlStrength}})),window.dispatchEvent(new CustomEvent("audiorailrider:dev:applyUniform",{detail:{name:"noiseScale",value:Ir.noiseScale}})),window.dispatchEvent(new CustomEvent("audiorailrider:dev:applyUniform",{detail:{name:"noiseSpeed",value:Ir.noiseSpeed}}))},Fe=(Z,_t)=>{g(dt=>({...dt,[Z]:_t})),window.dispatchEvent(new CustomEvent("audiorailrider:dev:applyUniform",{detail:{name:Z,value:_t}}))},Oe=Z=>{try{return btoa(unescape(encodeURIComponent(JSON.stringify(Z)))).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}catch{return""}},Ge=Z=>{try{for(Z=Z.replace(/-/g,"+").replace(/_/g,"/");Z.length%4;)Z+="=";return JSON.parse(decodeURIComponent(escape(atob(Z))))}catch{return null}},ke=(Z,_t)=>{const dt=A[Z];return dt&&typeof _t=="number"&&typeof dt.min=="number"&&typeof dt.max=="number"?Math.min(dt.max,Math.max(dt.min,_t)):_t},Je=(Z,_t)=>{const dt=A[Z];if(!dt)return _t;if(dt.control==="checkbox")return!!_t;if(dt.control==="select"&&Array.isArray(dt.options))return dt.options.includes(_t)?_t:dt.options[0];if(dt.control==="color")return typeof _t=="string"&&/^#([0-9A-Fa-f]{6}|[0-9A-Fa-f]{3})$/.test(_t)?_t:dt.default??"#000000";if((dt.control==="range"||dt.control==="number")&&(typeof _t=="number"||typeof _t=="string"&&!isNaN(Number(_t)))){const Pt=typeof _t=="number"?_t:Number(_t);return typeof dt.min=="number"&&typeof dt.max=="number"?Math.min(dt.max,Math.max(dt.min,Pt)):Pt}return _t},Tr=(Z,_t="preset.json")=>{const dt=new Blob([JSON.stringify(Z,null,2)],{type:"application/json"}),Pt=URL.createObjectURL(dt),_e=document.createElement("a");_e.href=Pt,_e.download=_t,document.body.appendChild(_e),_e.click(),_e.remove(),URL.revokeObjectURL(Pt)},cr=async Z=>{if(navigator.clipboard&&navigator.clipboard.writeText)try{return await navigator.clipboard.writeText(Z),!0}catch{}try{return document.execCommand("copy"),!0}catch{return!1}},ir=Z=>{const _t={};for(const Pt of Object.keys(y))_t[Pt]=y[Pt];_t.curlStrength=e,_t.noiseScale=i,_t.noiseSpeed=a,_t.placeUnderCamera=Dt,_t.verticalOffset=St,_t.trackDefaultOpacity=Ht,_t.trackInsideOpacity=Ut,_t.trackOpacityLerpSpeed=ae,_t.trackRadius=ce;const dt=[...Gt,{name:Z,data:_t}];te(dt);try{localStorage.setItem(V,JSON.stringify(dt))}catch{}},Qe=Z=>{Tr(Z,`audiorailrider-preset-${Date.now()}.json`)},li=Z=>{const _t=Oe(Z),dt=`${location.origin}${location.pathname}?preset=${_t}`;cr(dt).then(Pt=>{Pt?H("Preset URL copied to clipboard","success"):H("Copy failed; showing URL","info")})},Oi=async Z=>{if(Z)try{const _t=await Z.text(),dt=JSON.parse(_t);let Pt=dt;dt&&dt.data&&typeof dt.data=="object"&&(Pt=dt.data);const _e={};for(const m of Object.keys(Pt)){const yn=Je(m,Pt[m]);_e[m]=ke(m,yn)}ci(_e),H("Preset imported and applied","success")}catch(_t){console.error("Failed to import preset",_t)}};re.useEffect(()=>{try{const _t=new URLSearchParams(location.search).get("preset");if(_t){const dt=Ge(_t);if(dt){const Pt=dt.data&&typeof dt.data=="object"?dt.data:dt,_e={};for(const m of Object.keys(Pt)){const yn=Je(m,Pt[m]);_e[m]=ke(m,yn)}ci(_e)}}}catch{}},[]);const ci=Z=>{for(const _t of Object.keys(Z)){const dt=Z[_t],Pt=typeof dt=="string"&&!isNaN(Number(dt))?Number(dt):dt;_t==="curlStrength"&&typeof Pt=="number"&&r(Pt),_t==="noiseScale"&&typeof Pt=="number"&&n(Pt),_t==="noiseSpeed"&&typeof Pt=="number"&&o(Pt),_t==="placeUnderCamera"&&typeof Pt=="boolean"&&Et(Pt),_t==="verticalOffset"&&typeof Pt=="number"&&Xt(Pt),_t==="trackDefaultOpacity"&&typeof Pt=="number"&&se(Pt),_t==="trackInsideOpacity"&&typeof Pt=="number"&&Yt(Pt),_t==="trackOpacityLerpSpeed"&&typeof Pt=="number"&&me(Pt),_t==="trackRadius"&&typeof Pt=="number"&&Me(Pt),g(_e=>({..._e,[_t]:Pt})),window.dispatchEvent(new CustomEvent("audiorailrider:dev:applyUniform",{detail:{name:_t,value:Pt}}))}};return c?U.jsxs("div",{className:"fixed right-4 top-4 z-50 w-72 p-3 bg-gray-900/80 border border-gray-700 rounded-lg text-sm text-gray-200 backdrop-blur-md",children:[U.jsx("h3",{className:"font-semibold text-gray-100 mb-2",children:"Dev Panel"}),U.jsxs("div",{className:"mb-2",children:[U.jsxs("label",{className:"block text-xs text-gray-300",children:["Curl Strength: ",e.toFixed(2)]}),U.jsx("input",{type:"range",min:"0",max:"1",step:"0.01",value:e,onChange:Z=>r(Number(Z.target.value)),className:"w-full"})]}),U.jsxs("div",{className:"mb-2",children:[U.jsxs("label",{className:"block text-xs text-gray-300",children:["Noise Scale: ",i.toFixed(2)]}),U.jsx("input",{type:"range",min:"0.1",max:"8",step:"0.1",value:i,onChange:Z=>n(Number(Z.target.value)),className:"w-full"})]}),U.jsxs("div",{className:"mb-3",children:[U.jsxs("label",{className:"block text-xs text-gray-300",children:["Noise Speed: ",a.toFixed(2)]}),U.jsx("input",{type:"range",min:"0",max:"1",step:"0.01",value:a,onChange:Z=>o(Number(Z.target.value)),className:"w-full"})]}),U.jsxs("div",{className:"flex gap-2",children:[U.jsx("button",{onClick:he,className:"flex-1 px-3 py-1 bg-gray-800 border border-gray-600 rounded",children:"Reset"}),U.jsx("button",{onClick:()=>window.dispatchEvent(new CustomEvent("audiorailrider:dev:dump",{detail:{curlStrength:e,noiseScale:i,noiseSpeed:a}})),className:"px-3 py-1 bg-cyan-600 rounded",children:"Log"})]}),U.jsxs("div",{className:"mt-3 flex gap-2",children:[U.jsx("button",{onClick:ue,className:"flex-1 px-3 py-1 bg-gray-800 border border-gray-600 rounded",children:"Load Uniforms"}),U.jsx("button",{onClick:ve,className:"px-3 py-1 bg-emerald-600 rounded",children:"Apply Curl Defaults"})]}),U.jsxs("div",{className:"mt-4",children:[U.jsx("h4",{className:"font-medium text-gray-100 mb-1",children:"Track Settings"}),U.jsx("div",{className:"mb-2 text-xs text-gray-300",children:U.jsxs("label",{className:"inline-flex items-center gap-2",children:[U.jsx("input",{type:"checkbox",checked:Dt,onChange:Z=>Et(Z.target.checked)}),"Place track under camera"]})}),U.jsxs("div",{className:"mb-2",children:[U.jsxs("label",{className:"block text-xs text-gray-300",children:["Vertical Offset: ",St.toFixed(2)]}),U.jsx("input",{type:"range",min:"0",max:"3",step:"0.01",value:St,onChange:Z=>Xt(Number(Z.target.value)),className:"w-full"})]}),U.jsxs("div",{className:"mb-2",children:[U.jsxs("label",{className:"block text-xs text-gray-300",children:["Track Radius: ",ce.toFixed(2)]}),U.jsx("input",{type:"range",min:"0.05",max:"2",step:"0.01",value:ce,onChange:Z=>Me(Number(Z.target.value)),className:"w-full"})]}),U.jsxs("div",{className:"mb-2",children:[U.jsxs("label",{className:"block text-xs text-gray-300",children:["Default Opacity: ",Ht.toFixed(2)]}),U.jsx("input",{type:"range",min:"0",max:"1",step:"0.01",value:Ht,onChange:Z=>se(Number(Z.target.value)),className:"w-full"})]}),U.jsxs("div",{className:"mb-2",children:[U.jsxs("label",{className:"block text-xs text-gray-300",children:["Inside Opacity: ",Ut.toFixed(2)]}),U.jsx("input",{type:"range",min:"0",max:"1",step:"0.01",value:Ut,onChange:Z=>Yt(Number(Z.target.value)),className:"w-full"})]}),U.jsxs("div",{className:"mb-3",children:[U.jsxs("label",{className:"block text-xs text-gray-300",children:["Opacity Lerp Speed: ",ae.toFixed(2)]}),U.jsx("input",{type:"range",min:"0.1",max:"12",step:"0.1",value:ae,onChange:Z=>me(Number(Z.target.value)),className:"w-full"})]}),U.jsxs("div",{className:"flex gap-2 mb-3",children:[U.jsx("button",{onClick:()=>ee(Z=>!Z),className:"px-3 py-1 bg-orange-600 rounded",children:ge?"Release Inside":"Force Inside"}),U.jsx("button",{onClick:()=>window.dispatchEvent(new CustomEvent("audiorailrider:dev:rebuildTrack")),className:"px-3 py-1 bg-blue-600 rounded",children:"Rebuild Track"})]})]}),u?U.jsxs("div",{className:"mt-3",children:[U.jsx("h4",{className:"font-medium text-gray-100 mb-1",children:"Shader Uniforms"}),U.jsx("div",{className:"space-y-2 max-h-48 overflow-auto pr-2",children:Object.entries(u).map(([Z,_t])=>U.jsxs("div",{className:"mb-2",children:[U.jsx("div",{className:"text-xs text-gray-400",children:Z}),_t.map(dt=>U.jsxs("div",{className:"mt-1",children:[U.jsx("label",{className:"block text-xs text-gray-300",children:dt.name}),dt.control==="range"&&U.jsx("input",{"data-uniform":`$${dt.name}`,type:"range",min:dt.min??0,max:dt.max??1,step:dt.step??.01,value:y[dt.name]??dt.min??0,onChange:Pt=>Fe(dt.name,Number(Pt.target.value)),className:"w-full"}),dt.control==="number"&&U.jsx("input",{"data-uniform":`$${dt.name}`,type:"number",min:dt.min??0,max:dt.max??16,step:dt.step??1,value:y[dt.name]??dt.min??0,onChange:Pt=>Fe(dt.name,Number(Pt.target.value)),className:"w-full"}),dt.control==="checkbox"&&U.jsx("input",{"data-uniform":`$${dt.name}`,type:"checkbox",checked:!!y[dt.name],onChange:Pt=>Fe(dt.name,Pt.target.checked)}),dt.control==="color"&&U.jsx("input",{"data-uniform":`$${dt.name}`,type:"color",value:y[dt.name]??"#000000",onChange:Pt=>Fe(dt.name,Pt.target.value)}),dt.control==="select"&&dt.options&&U.jsx("select",{"data-uniform":`$${dt.name}`,value:y[dt.name]??dt.options[0],onChange:Pt=>Fe(dt.name,Pt.target.value),className:"w-full",children:dt.options.map(Pt=>U.jsx("option",{value:Pt,children:Pt},Pt))})]},dt.name))]},Z))}),U.jsxs("div",{className:"mt-2 flex gap-2",children:[U.jsx("input",{id:"presetName",placeholder:"Preset name",className:"flex-1 px-2 py-1 bg-gray-800 border border-gray-700 rounded text-sm"}),U.jsx("button",{onClick:()=>{const Z=document.getElementById("presetName");Z&&Z.value&&ir(Z.value)},className:"px-3 py-1 bg-blue-600 rounded",children:"Save"})]}),U.jsxs("div",{className:"mt-2 flex gap-2",children:[U.jsx("button",{onClick:()=>{const Z=Gt[Gt.length-1];Z&&Qe(Z.data)},className:"px-2 py-1 bg-gray-800 rounded",children:"Export Last"}),U.jsx("button",{onClick:()=>{if(Gt.length===0){H("No presets to share","info");return}const Z=Gt[Gt.length-1];li(Z.data)},className:"px-2 py-1 bg-cyan-600 rounded",children:"Share URL"}),U.jsxs("label",{className:"px-2 py-1 bg-emerald-600 rounded cursor-pointer",children:["Import",U.jsx("input",{id:"presetFile",type:"file",accept:"application/json",className:"hidden",onChange:Z=>Oi(Z.target.files?Z.target.files[0]:null)})]})]}),Gt.length>0&&U.jsxs("div",{className:"mt-2",children:[U.jsx("div",{className:"text-xs text-gray-400 mb-1",children:"Presets"}),U.jsx("div",{className:"space-y-1",children:Gt.map((Z,_t)=>U.jsxs("div",{className:"flex gap-2 items-center",children:[U.jsx("div",{className:"text-sm flex-1",children:Z.name}),U.jsx("button",{onClick:()=>ci(Z.data),className:"px-2 py-1 bg-gray-800 rounded",children:"Load"}),U.jsx("button",{onClick:()=>Qe(Z.data),className:"px-2 py-1 bg-blue-600 rounded",children:"Export"}),U.jsx("button",{onClick:()=>li(Z.data),className:"px-2 py-1 bg-cyan-600 rounded",children:"Share"})]},_t))})]})]}):null]}):null},Fx=(s,t)=>{if(!s&&!t)return!1;const e=(s||"").toLowerCase(),r=(t||"").toLowerCase();return!!(e.includes("swiftshader")||r==="google inc. (google)")},Px=()=>{const[s,t]=re.useState(!1),[e,r]=re.useState(null),[i,n]=re.useState(null);return re.useEffect(()=>{try{const a=document.createElement("canvas"),o=a.getContext("webgl")||a.getContext("experimental-webgl");if(!o)return;const c=o.getExtension("WEBGL_debug_renderer_info");if(c){const h=o.getParameter(c.UNMASKED_RENDERER_WEBGL),u=o.getParameter(c.UNMASKED_VENDOR_WEBGL);r(h),n(u),Fx(h,u)&&t(!0)}}catch{}},[]),s?U.jsx("div",{role:"status",className:"fixed top-4 left-1/2 transform -translate-x-1/2 z-50 bg-yellow-900/90 border border-yellow-700 text-yellow-100 px-4 py-3 rounded-md shadow-lg",children:U.jsxs("div",{className:"flex items-center gap-3",children:[U.jsxs("div",{className:"flex-1 text-sm",children:["VisualEffects is running on a software renderer (",e||"unknown","). Performance may be reduced. For best visuals enable hardware acceleration or run with a GPU-enabled browser."]}),U.jsx("button",{"aria-label":"dismiss",onClick:()=>t(!1),className:"ml-3 px-3 py-1 bg-yellow-800/60 rounded",children:"Dismiss"})]})}):null},Bx=s=>U.jsx("svg",{...s,xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor",children:U.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5m-13.5-9L12 3m0 0 4.5 4.5M12 3v13.5"})}),kx=s=>U.jsx("svg",{...s,xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor",children:U.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M5.25 5.653c0-.856.917-1.398 1.667-.986l11.54 6.347a1.125 1.125 0 0 1 0 1.972l-11.54 6.347a1.125 1.125 0 0 1-1.667-.986V5.653Z"})}),zx=s=>U.jsx("svg",{...s,xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor",children:U.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M9.813 15.904 9 18.75l-.813-2.846a4.5 4.5 0 0 0-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 0 0 3.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 0 0 3.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 0 0-3.09 3.09ZM18.259 8.715 18 9.75l-.259-1.035a3.375 3.375 0 0 0-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 0 0 2.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 0 0 2.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 0 0-2.456 2.456Z"})}),Ux=s=>U.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor",...s,children:U.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z"})}),Gx=["classic","extreme","flowing","technical","experimental"],Vx=["fantasy","cyberpunk","aurora","desert","space","underwater","noir"],jx=["photorealistic","stylized","painterly","lowpoly","retro"],Hx=["low","medium","high"],Wx=["fog","fireworks","starshow","lightBurst","sparkRing","confetti"],Yx=()=>{const s=be(i=>i.generationOptions),t=be(i=>i.actions.setGenerationOptions),e=(i,n)=>{t({...s,[i]:n})},r=(i,n)=>{const a=(s==null?void 0:s.preferredEventPresets)||[],o=i.target.checked?Array.from(new Set([...a,n])):a.filter(c=>c!==n);t({...s,preferredEventPresets:o})};return U.jsxs("div",{className:"mt-6 grid grid-cols-1 md:grid-cols-2 gap-3 max-w-xl mx-auto text-left",children:[U.jsxs("div",{children:[U.jsx("label",{className:"block text-xs text-gray-400",children:"Track Style"}),U.jsxs("select",{value:(s==null?void 0:s.trackStyle)||"",onChange:i=>e("trackStyle",i.target.value||void 0),className:"mt-1 w-full bg-gray-800/60 border border-gray-700 rounded-md p-2 text-sm text-gray-200",children:[U.jsx("option",{value:"",children:"(auto)"}),Gx.map(i=>U.jsx("option",{value:i,children:i},i))]})]}),U.jsxs("div",{children:[U.jsx("label",{className:"block text-xs text-gray-400",children:"World Theme"}),U.jsxs("select",{value:(s==null?void 0:s.worldTheme)||"",onChange:i=>e("worldTheme",i.target.value||void 0),className:"mt-1 w-full bg-gray-800/60 border border-gray-700 rounded-md p-2 text-sm text-gray-200",children:[U.jsx("option",{value:"",children:"(auto)"}),Vx.map(i=>U.jsx("option",{value:i,children:i},i))]})]}),U.jsxs("div",{children:[U.jsx("label",{className:"block text-xs text-gray-400",children:"Visual Style"}),U.jsxs("select",{value:(s==null?void 0:s.visualStyle)||"",onChange:i=>e("visualStyle",i.target.value||void 0),className:"mt-1 w-full bg-gray-800/60 border border-gray-700 rounded-md p-2 text-sm text-gray-200",children:[U.jsx("option",{value:"",children:"(auto)"}),jx.map(i=>U.jsx("option",{value:i,children:i},i))]})]}),U.jsxs("div",{children:[U.jsx("label",{className:"block text-xs text-gray-400",children:"Detail Level"}),U.jsxs("select",{value:(s==null?void 0:s.detailLevel)||"",onChange:i=>e("detailLevel",i.target.value||void 0),className:"mt-1 w-full bg-gray-800/60 border border-gray-700 rounded-md p-2 text-sm text-gray-200",children:[U.jsx("option",{value:"",children:"(auto)"}),Hx.map(i=>U.jsx("option",{value:i,children:i},i))]})]}),U.jsxs("div",{className:"md:col-span-2",children:[U.jsx("label",{className:"block text-xs text-gray-400",children:"Event Presets"}),U.jsx("div",{className:"mt-2 flex flex-wrap gap-2",children:Wx.map(i=>{const n=((s==null?void 0:s.preferredEventPresets)||[]).includes(i);return U.jsxs("label",{className:"inline-flex items-center gap-2 text-sm text-gray-300 bg-gray-800/40 px-3 py-1 rounded-md cursor-pointer",children:[U.jsx("input",{type:"checkbox",checked:n,onChange:a=>r(a,i)}),U.jsx("span",{className:"capitalize",children:i})]},i)})})]})]})},Xx=()=>{const{setAudioFile:s,setError:t}=be(i=>i.actions),e=re.useRef(null);re.useEffect(()=>{e.current&&(e.current.value="")},[]);const r=re.useCallback(i=>{var c;const n=(c=i.target.files)==null?void 0:c[0];if(!n)return;const a=new Set(["audio/mpeg","audio/wav","audio/x-wav"]),o=20*1024*1024;if(!a.has(n.type)){t({title:"Unsupported File Type",message:`Please select a valid audio file (MP3, WAV). You selected a file of type: ${n.type}`});return}if(n.size>o){t({title:"File Too Large",message:`The selected file is too large (${(n.size/(1024*1024)).toFixed(1)}MB). Please select a file smaller than 20MB.`});return}s(n)},[s,t]);return U.jsxs("div",{className:"text-center animate-fade-in",children:[U.jsx("h1",{className:"text-5xl md:text-7xl font-thin tracking-widest uppercase bg-clip-text text-transparent bg-gradient-to-r from-fuchsia-400 to-cyan-400",children:"AudioRail Rider"}),U.jsx("p",{className:"mt-4 max-w-2xl mx-auto text-gray-400",children:"Translate music into a navigable space. Inhabit the soul of a song."}),U.jsxs("label",{htmlFor:"audio-upload",className:"mt-8 inline-flex items-center gap-3 px-8 py-4 bg-gray-800/50 border border-gray-600 rounded-lg cursor-pointer hover:bg-gray-700/70 hover:border-cyan-400 transition-all duration-300 transform hover:scale-105",children:[U.jsx(Bx,{className:"w-6 h-6"}),U.jsx("span",{children:"Offer a ghost... (MP3, WAV)"})]}),U.jsx("input",{ref:e,id:"audio-upload",type:"file",accept:"audio/mp3, audio/wav, audio/mpeg",className:"hidden",onChange:r}),U.jsx("p",{className:"text-xs text-gray-600 mt-4",children:"For the best experience, use a track with dynamic range."}),U.jsx(Yx,{}),U.jsxs("div",{className:"mt-8 text-sm text-gray-500",children:["Powered by ",U.jsx("span",{className:"font-semibold text-gray-400",children:"Gemini"})," & ",U.jsx("span",{className:"font-semibold text-gray-400",children:"Three.js"})]})]})},$x=()=>{const{audioFile:s}=be(e=>e),{startRide:t}=be(e=>e.actions);return U.jsxs("div",{className:"text-center flex flex-col items-center animate-fade-in",children:[U.jsx(zx,{className:"w-16 h-16 text-cyan-300"}),U.jsx("h2",{className:"text-4xl font-bold mt-4 bg-clip-text text-transparent bg-gradient-to-r from-fuchsia-400 to-cyan-400",children:"The Dreamscape is Ready"}),U.jsxs("p",{className:"mt-2 text-gray-300",children:['Your ride through "',s==null?void 0:s.name,'" has been constructed.']}),U.jsxs("button",{onClick:()=>{console.log("[App] Begin the Ride button clicked"),t()},className:"mt-8 inline-flex items-center gap-3 px-12 py-5 bg-cyan-500/80 text-white font-bold rounded-full shadow-lg shadow-cyan-500/20 hover:bg-cyan-400 transition-all duration-300 transform hover:scale-110",children:[U.jsx(kx,{className:"w-8 h-8"}),U.jsx("span",{children:"Begin the Ride"})]})]})},qx=()=>{const s=be(r=>r.audioFile),{startRideAgain:t,resetApp:e}=be(r=>r.actions);return U.jsxs("div",{className:"text-center animate-fade-in",children:[U.jsx("h2",{className:"text-4xl font-bold",children:"Ride Complete"}),U.jsxs("p",{className:"mt-2 text-gray-300",children:['You have journeyed through "',(s==null?void 0:s.name)||"your audio",'".']}),U.jsxs("div",{className:"mt-8 flex justify-center gap-4",children:[U.jsx("button",{onClick:t,className:"px-6 py-2 bg-cyan-500 hover:bg-cyan-600 rounded-md transition-colors",children:"Ride Again"}),U.jsx("button",{onClick:e,className:"px-6 py-2 bg-gray-600 hover:bg-gray-700 rounded-md transition-colors",children:"Upload New Song"})]})]})},Wu=()=>{const s=be(e=>e.error),t=be(e=>e.actions.resetApp);return s?U.jsxs("div",{className:"text-center animate-fade-in bg-red-900/20 border border-red-500/50 rounded-lg p-8 max-w-lg shadow-xl",children:[U.jsx(Ux,{className:"w-16 h-16 text-red-400 mx-auto"}),U.jsx("h2",{className:"mt-4 text-3xl font-bold text-red-300",children:s.title}),U.jsx("p",{className:"mt-2 text-red-200",children:s.message}),U.jsx("button",{onClick:t,className:"mt-6 px-8 py-3 bg-red-600 hover:bg-red-700 text-white font-bold rounded-md transition-colors transform hover:scale-105",children:"Try Again"})]}):null},Jx=jn.lazy(()=>Rp(()=>import("./ThreeCanvas-CcinmEnU.js"),__vite__mapDeps([0,1,2,3]))),Zx=()=>{const s=be(n=>n.status);be(n=>n.statusMessage);const t=be(n=>n.trackData),e=be(n=>{var a;return(a=n.trackData)==null?void 0:a.audioFeatures});re.useEffect(()=>{Ex()},[]),xx();const i={[de.Idle]:Xx,[de.Ready]:$x,[de.Finished]:qx,[de.Error]:Wu,[de.Analyzing]:null,[de.Generating]:null,[de.Riding]:null}[s]||Wu;return U.jsxs("main",{className:"relative w-full h-screen bg-black overflow-hidden flex items-center justify-center",children:[U.jsx("div",{className:"absolute inset-0 z-0 bg-[url('https://www.transparenttextures.com/patterns/stardust.png')] opacity-20"}),s===de.Analyzing&&U.jsx(Do,{stage:"analyzing"}),s===de.Generating&&U.jsx(Do,{stage:"generating",progress:be.getState().generationProgress}),i&&U.jsxs("div",{className:"relative z-20 p-4",children:[U.jsx(Px,{}),U.jsx(i,{})]}),(s===de.Riding||s===de.Ready)&&t&&U.jsxs(Ax,{children:[U.jsx(re.Suspense,{fallback:U.jsx(Do,{stage:"loading"}),children:U.jsx(Jx,{})}),s===de.Ready&&U.jsx(Cx,{audioFeatures:e||null})]}),U.jsx(Dx,{})]})},G_=Object.freeze(Object.defineProperty({__proto__:null,default:Zx},Symbol.toStringTag,{value:"Module"}));export{gg as $,F_ as A,$u as B,Ar as C,lg as D,$n as E,Py as F,wg as G,$p as H,Eg as I,Tg as J,Yh as K,Ju as L,we as M,zg as N,Ig as O,ii as P,bg as Q,Xu as R,vr as S,vg as T,Uo as U,L as V,oy as W,Ag as X,Sg as Y,Wh as Z,_g as _,er as a,v0 as a$,xg as a0,qh as a1,dn as a2,$h as a3,Qg as a4,ta as a5,Kg as a6,Zg as a7,ai as a8,l_ as a9,Wp as aA,Xp as aB,Go as aC,Kp as aD,Qp as aE,Qu as aF,e0 as aG,r0 as aH,i0 as aI,n0 as aJ,s0 as aK,a0 as aL,o0 as aM,l0 as aN,no as aO,c0 as aP,h0 as aQ,u0 as aR,f0 as aS,d0 as aT,m0 as aU,p0 as aV,y0 as aW,x0 as aX,g0 as aY,_0 as aZ,b0 as a_,o_ as aa,c_ as ab,s_ as ac,a_ as ad,n_ as ae,h_ as af,i_ as ag,ln as ah,Vr as ai,I_ as aj,e_ as ak,R_ as al,My as am,jr as an,Mi as ao,Wo as ap,sg as aq,Gp as ar,og as as,Yp as at,qp as au,Jp as av,rr as aw,lf as ax,Zp as ay,Hp as az,dr as b,g_ as b$,E0 as b0,A0 as b1,T0 as b2,S0 as b3,w0 as b4,M0 as b5,C0 as b6,I0 as b7,R0 as b8,O0 as b9,Jg as bA,k0 as bB,r_ as bC,__ as bD,Yo as bE,aa as bF,oi as bG,k_ as bH,Kh as bI,jp as bJ,Xg as bK,ax as bL,xy as bM,by as bN,_y as bO,ey as bP,f_ as bQ,uy as bR,ag as bS,Hg as bT,Yg as bU,Wg as bV,jg as bW,Vg as bX,Gg as bY,Ug as bZ,Iy as b_,N0 as ba,L0 as bb,D0 as bc,F0 as bd,P0 as be,Pg as bf,Fg as bg,Dg as bh,Lg as bi,Ng as bj,Og as bk,Rg as bl,rg as bm,ig as bn,ng as bo,jh as bp,fg as bq,ug as br,hg as bs,cg as bt,$g as bu,qg as bv,v_ as bw,x_ as bx,b_ as by,Ay as bz,d_ as c,ia as c0,kg as c1,Bg as c2,Vp as c3,pg as c4,yg as c5,A_ as c6,Zs as c7,sf as c8,D_ as c9,de as cA,P_ as cB,Yu as cC,G_ as cD,L_ as ca,O_ as cb,Se as cc,be as cd,Gy as ce,B_ as cf,Er as cg,Ii as ch,Ci as ci,Ye as cj,By as ck,S_ as cl,z_ as cm,U_ as cn,Oy as co,cf as cp,T_ as cq,u_ as cr,bu as cs,w_ as ct,zy as cu,nf as cv,hf as cw,C_ as cx,N_ as cy,eg as cz,ko as d,y_ as e,Zh as f,ni as g,le as h,E_ as i,Ku as j,t0 as k,Jh as l,t_ as m,Zu as n,M_ as o,m_ as p,ra as q,tf as r,Xh as s,p_ as t,mg as u,dg as v,nu as w,Hh as x,Cg as y,Mg as z};
